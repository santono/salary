/******************************************************************************/
/***         Generated by IBExpert 2018.12.21.1 11.03.2021 16:30:12         ***/
/******************************************************************************/

SET SQL DIALECT 3;

SET NAMES WIN1251;

SET CLIENTLIB 'E:\Program Files\Firebird\Firebird-2.5.9.27139-0_Win32\bin\fbclient.dll';

CREATE DATABASE 'E:\Projects\ZARPLATA\VUGU\SVDN\ib\SAL_SVDN_21_01_2021.FDB'
USER 'SYSDBA' PASSWORD 'masterkey'
PAGE_SIZE 16384
DEFAULT CHARACTER SET WIN1251 COLLATION WIN1251;



/******************************************************************************/
/***                      User defined functions (UDF)                      ***/
/******************************************************************************/

DECLARE EXTERNAL FUNCTION "ABS"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_abs' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ACOS"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_acos' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION ADDDAY
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addDay' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDHOUR
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addHour' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDMILLISECOND
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addMilliSecond' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDMINUTE
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addMinute' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDMONTH
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addMonth' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDSECOND
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addSecond' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDWEEK
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addWeek' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION ADDYEAR
    TIMESTAMP,
    INTEGER
    RETURNS TIMESTAMP
    ENTRY_POINT 'addYear' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "ASCII_CHAR"
    INTEGER
    RETURNS CSTRING(1) FREE_IT
    ENTRY_POINT 'IB_UDF_ascii_char' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ASCII_VAL"
    CHAR(1)
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_ascii_val' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ASIN"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_asin' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ATAN"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_atan' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ATAN2"
    DOUBLE PRECISION,
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_atan2' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "BIN_AND"
    INTEGER,
    INTEGER
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_bin_and' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "BIN_OR"
    INTEGER,
    INTEGER
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_bin_or' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "BIN_XOR"
    INTEGER,
    INTEGER
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_bin_xor' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "CEILING"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_ceiling' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "COS"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_cos' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "COSH"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_cosh' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "COT"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_cot' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION DIV
    INTEGER,
    INTEGER
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_div' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION DNULLIF
    DOUBLE PRECISION BY DESCRIPTOR,
    DOUBLE PRECISION BY DESCRIPTOR
    RETURNS DOUBLE PRECISION BY DESCRIPTOR
    ENTRY_POINT 'dNullIf' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION DNVL
    DOUBLE PRECISION BY DESCRIPTOR,
    DOUBLE PRECISION BY DESCRIPTOR
    RETURNS DOUBLE PRECISION BY DESCRIPTOR
    ENTRY_POINT 'idNvl' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION DOW
    TIMESTAMP,
    VARCHAR(15)
    RETURNS PARAMETER 2
    ENTRY_POINT 'DOW' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION DPOWER
    DOUBLE PRECISION BY DESCRIPTOR,
    DOUBLE PRECISION BY DESCRIPTOR,
    DOUBLE PRECISION BY DESCRIPTOR
    RETURNS PARAMETER 3
    ENTRY_POINT 'power' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "FLOOR"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_floor' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION GETEXACTTIMESTAMP
    TIMESTAMP
    RETURNS PARAMETER 1
    ENTRY_POINT 'getExactTimestamp' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION I64NULLIF
    NUMERIC(18,4) BY DESCRIPTOR,
    NUMERIC(18,4) BY DESCRIPTOR
    RETURNS NUMERIC(18,4) BY DESCRIPTOR
    ENTRY_POINT 'iNullIf' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION I64NVL
    NUMERIC(18,0) BY DESCRIPTOR,
    NUMERIC(18,0) BY DESCRIPTOR
    RETURNS NUMERIC(18,0) BY DESCRIPTOR
    ENTRY_POINT 'idNvl' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION I64ROUND
    NUMERIC(18,4) BY DESCRIPTOR,
    NUMERIC(18,4) BY DESCRIPTOR
    RETURNS PARAMETER 2
    ENTRY_POINT 'fbround' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION I64TRUNCATE
    NUMERIC(18,0) BY DESCRIPTOR,
    NUMERIC(18,0) BY DESCRIPTOR
    RETURNS PARAMETER 2
    ENTRY_POINT 'fbtruncate' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION INULLIF
    INTEGER BY DESCRIPTOR,
    INTEGER BY DESCRIPTOR
    RETURNS INTEGER BY DESCRIPTOR
    ENTRY_POINT 'iNullIf' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION INVL
    INTEGER BY DESCRIPTOR,
    INTEGER BY DESCRIPTOR
    RETURNS INTEGER BY DESCRIPTOR
    ENTRY_POINT 'idNvl' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "LN"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_ln' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "LOG"
    DOUBLE PRECISION,
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_log' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "LOG10"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_log10' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "LOWER"
    CSTRING(80)
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_lower' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "LPAD"
    CSTRING(80),
    INTEGER,
    CSTRING(1)
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_lpad' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION LTRIM
    CSTRING(80)
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_ltrim' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "MOD"
    INTEGER,
    INTEGER
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_mod' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "PI"

    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_pi' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "RAND"

    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_rand' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "ROUND"
    INTEGER BY DESCRIPTOR,
    INTEGER BY DESCRIPTOR
    RETURNS PARAMETER 2
    ENTRY_POINT 'fbround' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "RPAD"
    CSTRING(80),
    INTEGER,
    CSTRING(1)
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_rpad' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION RTRIM
    CSTRING(80)
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_rtrim' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION SDOW
    TIMESTAMP,
    VARCHAR(5)
    RETURNS PARAMETER 2
    ENTRY_POINT 'SDOW' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "SIGN"
    DOUBLE PRECISION
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_sign' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "SIN"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_sin' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "SINH"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_sinh' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION SNULLIF
    VARCHAR(100) BY DESCRIPTOR,
    VARCHAR(100) BY DESCRIPTOR,
    VARCHAR(100) BY DESCRIPTOR
    RETURNS PARAMETER 3
    ENTRY_POINT 'sNullIf' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION SNVL
    VARCHAR(100) BY DESCRIPTOR,
    VARCHAR(100) BY DESCRIPTOR,
    VARCHAR(100) BY DESCRIPTOR
    RETURNS PARAMETER 3
    ENTRY_POINT 'sNvl' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION "SQRT"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_sqrt' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION SRIGHT
    VARCHAR(100) BY DESCRIPTOR,
    SMALLINT,
    VARCHAR(100) BY DESCRIPTOR
    RETURNS PARAMETER 3
    ENTRY_POINT 'right' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION STRING2BLOB
    VARCHAR(300) BY DESCRIPTOR,
    BLOB
    RETURNS PARAMETER 2
    ENTRY_POINT 'string2blob' MODULE_NAME 'fbudf';


DECLARE EXTERNAL FUNCTION STRLEN
    CSTRING(32767)
    RETURNS INTEGER BY VALUE
    ENTRY_POINT 'IB_UDF_strlen' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION SUBSTR
    CSTRING(80),
    SMALLINT,
    SMALLINT
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_substr' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION SUBSTRLEN
    CSTRING(80),
    SMALLINT,
    SMALLINT
    RETURNS CSTRING(80) FREE_IT
    ENTRY_POINT 'IB_UDF_substrlen' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "TAN"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_tan' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION "TANH"
    DOUBLE PRECISION
    RETURNS DOUBLE PRECISION BY VALUE
    ENTRY_POINT 'IB_UDF_tanh' MODULE_NAME 'ib_udf';


DECLARE EXTERNAL FUNCTION TRUNCATE
    INTEGER BY DESCRIPTOR,
    INTEGER BY DESCRIPTOR
    RETURNS PARAMETER 2
    ENTRY_POINT 'fbtruncate' MODULE_NAME 'fbudf';




/******************************************************************************/
/***                                Domains                                 ***/
/******************************************************************************/

CREATE DOMAIN TBIGCODE AS
INTEGER;

CREATE DOMAIN TDATE AS
DATE;

CREATE DOMAIN TDATEWRK AS
TIMESTAMP
DEFAULT 'NOW'
NOT NULL;

CREATE DOMAIN TINTARR_10 AS
INTEGER;

CREATE DOMAIN TMEANDAYSUMMA AS
DECIMAL(10,4);

CREATE DOMAIN TMONTH AS
SMALLINT
NOT NULL
CHECK (VALUE BETWEEN 1 AND 12);

CREATE DOMAIN TSMALLCODE AS
SMALLINT
DEFAULT 0;

CREATE DOMAIN TSUMMAPERSON AS
DECIMAL(10,2);

CREATE DOMAIN TVARCHAR15 AS
VARCHAR(15);

CREATE DOMAIN TVARCHAR30 AS
VARCHAR(30);

CREATE DOMAIN TVARCHAR50 AS
VARCHAR(50);

CREATE DOMAIN TYEAR AS
SMALLINT
NOT NULL
CHECK (VALUE BETWEEN 0 AND 2100);



/******************************************************************************/
/***                               Generators                               ***/
/******************************************************************************/

CREATE GENERATOR CATEGORIES_ID_GEN;
SET GENERATOR CATEGORIES_ID_GEN TO 0;

CREATE GENERATOR GADD;
SET GENERATOR GADD TO 4471317;

CREATE GENERATOR GBOLN;
SET GENERATOR GBOLN TO 21662;

CREATE GENERATOR GBOLNA;
SET GENERATOR GBOLNA TO 1933602;

CREATE GENERATOR GBOLNATMP;
SET GENERATOR GBOLNATMP TO 9996;

CREATE GENERATOR GBOLNTMPRES;
SET GENERATOR GBOLNTMPRES TO 212;

CREATE GENERATOR GBOLNTMPSUMMY;
SET GENERATOR GBOLNTMPSUMMY TO 1345;

CREATE GENERATOR GBOLN_RES;
SET GENERATOR GBOLN_RES TO 51492;

CREATE GENERATOR GBOLN_SUMMY;
SET GENERATOR GBOLN_SUMMY TO 345727;

CREATE GENERATOR GCN;
SET GENERATOR GCN TO 15586783;

CREATE GENERATOR GOODS_ID_GEN;
SET GENERATOR GOODS_ID_GEN TO 0;

CREATE GENERATOR GOTPUSKA;
SET GENERATOR GOTPUSKA TO 59901;

CREATE GENERATOR GOTPUSKATMP;
SET GENERATOR GOTPUSKATMP TO 0;

CREATE GENERATOR GOTP_ADD;
SET GENERATOR GOTP_ADD TO 4562398;

CREATE GENERATOR GOTP_ADD_TMP;
SET GENERATOR GOTP_ADD_TMP TO 4932915;

CREATE GENERATOR GOTP_RES;
SET GENERATOR GOTP_RES TO 154870;

CREATE GENERATOR GOTP_RES_TMP;
SET GENERATOR GOTP_RES_TMP TO 141126;

CREATE GENERATOR GOTP_SUMMY;
SET GENERATOR GOTP_SUMMY TO 1042061;

CREATE GENERATOR GOTP_SUMMY_TMP;
SET GENERATOR GOTP_SUMMY_TMP TO 277;

CREATE GENERATOR GPERSON;
SET GENERATOR GPERSON TO 0;

CREATE GENERATOR GPLATHEA;
SET GENERATOR GPLATHEA TO 0;

CREATE GENERATOR GPLATPR;
SET GENERATOR GPLATPR TO 2869780;

CREATE GENERATOR GPODR;
SET GENERATOR GPODR TO 0;

CREATE GENERATOR GSOWM;
SET GENERATOR GSOWM TO 0;

CREATE GENERATOR GTEMY;
SET GENERATOR GTEMY TO 0;

CREATE GENERATOR GUD;
SET GENERATOR GUD TO 10129695;

CREATE GENERATOR GVYPLPLT;
SET GENERATOR GVYPLPLT TO 23884;

CREATE GENERATOR G_1DF;
SET GENERATOR G_1DF TO 113037;

CREATE GENERATOR G_1DF_A;
SET GENERATOR G_1DF_A TO 1648095;

CREATE GENERATOR G_1DF_U;
SET GENERATOR G_1DF_U TO 627999;

CREATE GENERATOR G_APM;
SET GENERATOR G_APM TO 1635119;

CREATE GENERATOR G_CHAIN;
SET GENERATOR G_CHAIN TO 2093827;

CREATE GENERATOR G_C_ADD;
SET GENERATOR G_C_ADD TO 0;

CREATE GENERATOR G_C_CN;
SET GENERATOR G_C_CN TO 0;

CREATE GENERATOR G_C_FADD;
SET GENERATOR G_C_FADD TO 50014;

CREATE GENERATOR G_C_FCN;
SET GENERATOR G_C_FCN TO 182203;

CREATE GENERATOR G_C_FUD;
SET GENERATOR G_C_FUD TO 75869;

CREATE GENERATOR G_C_P;
SET GENERATOR G_C_P TO 0;

CREATE GENERATOR G_C_SSTABEL;
SET GENERATOR G_C_SSTABEL TO 0;

CREATE GENERATOR G_C_TABEL;
SET GENERATOR G_C_TABEL TO 948437;

CREATE GENERATOR G_C_UD;
SET GENERATOR G_C_UD TO 0;

CREATE GENERATOR G_DVV_REP_REC;
SET GENERATOR G_DVV_REP_REC TO 0;

CREATE GENERATOR G_E04T05C;
SET GENERATOR G_E04T05C TO 9810;

CREATE GENERATOR G_E04T06C;
SET GENERATOR G_E04T06C TO 523489;

CREATE GENERATOR G_E04T07C;
SET GENERATOR G_E04T07C TO 186319;

CREATE GENERATOR G_E4_NF;
SET GENERATOR G_E4_NF TO 0;

CREATE GENERATOR G_GRID;
SET GENERATOR G_GRID TO 117;

CREATE GENERATOR G_IO_STATISTIC;
SET GENERATOR G_IO_STATISTIC TO 5586230;

CREATE GENERATOR G_I_2012;
SET GENERATOR G_I_2012 TO 43355;

CREATE GENERATOR G_I_PODR;
SET GENERATOR G_I_PODR TO 261;

CREATE GENERATOR G_KADRY_87;
SET GENERATOR G_KADRY_87 TO 0;

CREATE GENERATOR G_KOE_BOLN_OTP;
SET GENERATOR G_KOE_BOLN_OTP TO 79;

CREATE GENERATOR G_KOMAND;
SET GENERATOR G_KOMAND TO 0;

CREATE GENERATOR G_KOMAND_ADD;
SET GENERATOR G_KOMAND_ADD TO 0;

CREATE GENERATOR G_KOMAND_RES;
SET GENERATOR G_KOMAND_RES TO 0;

CREATE GENERATOR G_KOMAND_SUMMY;
SET GENERATOR G_KOMAND_SUMMY TO 0;

CREATE GENERATOR G_KREDIT_SPR;
SET GENERATOR G_KREDIT_SPR TO 7163;

CREATE GENERATOR G_K_CONTRACT;
SET GENERATOR G_K_CONTRACT TO 0;

CREATE GENERATOR G_K_DECANY;
SET GENERATOR G_K_DECANY TO 80;

CREATE GENERATOR G_K_EXL_SAL;
SET GENERATOR G_K_EXL_SAL TO 13;

CREATE GENERATOR G_K_KADRY;
SET GENERATOR G_K_KADRY TO 9909;

CREATE GENERATOR G_K_KADRYPR;
SET GENERATOR G_K_KADRYPR TO 16346;

CREATE GENERATOR G_K_K_F;
SET GENERATOR G_K_K_F TO 0;

CREATE GENERATOR G_K_ORDER;
SET GENERATOR G_K_ORDER TO 42;

CREATE GENERATOR G_K_ORDERRECPR;
SET GENERATOR G_K_ORDERRECPR TO 0;

CREATE GENERATOR G_K_ORDERRECTEXT;
SET GENERATOR G_K_ORDERRECTEXT TO 269637;

CREATE GENERATOR G_K_ORDREC;
SET GENERATOR G_K_ORDREC TO 0;

CREATE GENERATOR G_K_PODR;
SET GENERATOR G_K_PODR TO 0;

CREATE GENERATOR G_K_SHTRASPPED;
SET GENERATOR G_K_SHTRASPPED TO 4523;

CREATE GENERATOR G_K_SHTRASPREC;
SET GENERATOR G_K_SHTRASPREC TO 265463;

CREATE GENERATOR G_K_USZ;
SET GENERATOR G_K_USZ TO 5;

CREATE GENERATOR G_K_WIDNADB;
SET GENERATOR G_K_WIDNADB TO 15;

CREATE GENERATOR G_K_WIDNADBSTW;
SET GENERATOR G_K_WIDNADBSTW TO 21;

CREATE GENERATOR G_K_WIDORDERS;
SET GENERATOR G_K_WIDORDERS TO 4;

CREATE GENERATOR G_K_WIDYZASL;
SET GENERATOR G_K_WIDYZASL TO 6;

CREATE GENERATOR G_K_ZAJASOWMPED;
SET GENERATOR G_K_ZAJASOWMPED TO 0;

CREATE GENERATOR G_NADB_87;
SET GENERATOR G_NADB_87 TO 2;

CREATE GENERATOR G_NADB_87_PR;
SET GENERATOR G_NADB_87_PR TO 108747;

CREATE GENERATOR G_NEED_87;
SET GENERATOR G_NEED_87 TO 37510;

CREATE GENERATOR G_OTP_UHOD;
SET GENERATOR G_OTP_UHOD TO 71;

CREATE GENERATOR G_P04T05B;
SET GENERATOR G_P04T05B TO 586;

CREATE GENERATOR G_P04T06B;
SET GENERATOR G_P04T06B TO 66926;

CREATE GENERATOR G_P04T06B_DET;
SET GENERATOR G_P04T06B_DET TO 342785;

CREATE GENERATOR G_P04T06B_DET_UD;
SET GENERATOR G_P04T06B_DET_UD TO 0;

CREATE GENERATOR G_P04T07B;
SET GENERATOR G_P04T07B TO 122744;

CREATE GENERATOR G_P04T07B_DET;
SET GENERATOR G_P04T07B_DET TO 262897;

CREATE GENERATOR G_P04T07B_DET_UD;
SET GENERATOR G_P04T07B_DET_UD TO 0;

CREATE GENERATOR G_P04T08B;
SET GENERATOR G_P04T08B TO 32856;

CREATE GENERATOR G_P4_NF;
SET GENERATOR G_P4_NF TO 214;

CREATE GENERATOR G_PRAZDN;
SET GENERATOR G_PRAZDN TO 403;

CREATE GENERATOR G_PRIKAZY;
SET GENERATOR G_PRIKAZY TO 18760;

CREATE GENERATOR G_PRIKAZY_TYP;
SET GENERATOR G_PRIKAZY_TYP TO 21;

CREATE GENERATOR G_PR_UWP;
SET GENERATOR G_PR_UWP TO 2024;

CREATE GENERATOR G_RCLCPOCHAS1301;
SET GENERATOR G_RCLCPOCHAS1301 TO 2996;

CREATE GENERATOR G_RCLCPOCHAS1301PR;
SET GENERATOR G_RCLCPOCHAS1301PR TO 4634;

CREATE GENERATOR G_RCLCPR;
SET GENERATOR G_RCLCPR TO 1;

CREATE GENERATOR G_RCLC_08;
SET GENERATOR G_RCLC_08 TO 11459;

CREATE GENERATOR G_REE_BOLN;
SET GENERATOR G_REE_BOLN TO 80;

CREATE GENERATOR G_REE_BOLN_DET;
SET GENERATOR G_REE_BOLN_DET TO 3136;

CREATE GENERATOR G_SBS_SAD;
SET GENERATOR G_SBS_SAD TO 7362;

CREATE GENERATOR G_SBS_SPR;
SET GENERATOR G_SBS_SPR TO 349;

CREATE GENERATOR G_SBS_SPRPR;
SET GENERATOR G_SBS_SPRPR TO 2460;

CREATE GENERATOR G_SBS_SUD;
SET GENERATOR G_SBS_SUD TO 110;

CREATE GENERATOR G_SWODY_DET;
SET GENERATOR G_SWODY_DET TO 7624341;

CREATE GENERATOR G_SWODY_HAT;
SET GENERATOR G_SWODY_HAT TO 19768;

CREATE GENERATOR G_SWOD_DET_PERSON_ADD;
SET GENERATOR G_SWOD_DET_PERSON_ADD TO 431;

CREATE GENERATOR G_S_P_P;
SET GENERATOR G_S_P_P TO 2;

CREATE GENERATOR G_TB_REC;
SET GENERATOR G_TB_REC TO 8818;

CREATE GENERATOR G_TB_REC_DET;
SET GENERATOR G_TB_REC_DET TO 0;

CREATE GENERATOR G_TEST;
SET GENERATOR G_TEST TO 68250;

CREATE GENERATOR G_TMP_PERSON;
SET GENERATOR G_TMP_PERSON TO 4697257;

CREATE GENERATOR G_TR_RAZR;
SET GENERATOR G_TR_RAZR TO 1223;

CREATE GENERATOR G_VYPLR_87;
SET GENERATOR G_VYPLR_87 TO 0;

CREATE GENERATOR G_VYPL_87;
SET GENERATOR G_VYPL_87 TO 19728;

CREATE GENERATOR G_Y_SPR;
SET GENERATOR G_Y_SPR TO 35999;

CREATE GENERATOR IBE$LOG_TABLES_GEN;
SET GENERATOR IBE$LOG_TABLES_GEN TO 1;



/******************************************************************************/
/***                               Exceptions                               ***/
/******************************************************************************/

CREATE EXCEPTION ABSENTPARIND 'Отсутствую параметрі индексации за указанный месяц';

CREATE EXCEPTION E_INVALIDIND 'Две анкеты без льготы';

CREATE EXCEPTION E_P07 'Пустой ключ Т07';

CREATE EXCEPTION T '';

CREATE EXCEPTION TESTPUTBOLN 'ПРОЦЕДУРА СТАРТОВАЛА';

CREATE EXCEPTION WDAYZERO 'Количество рабочих дней > 30';



/******************************************************************************/
/***                           Stored procedures                            ***/
/******************************************************************************/



SET TERM ^ ;

CREATE PROCEDURE ALIM_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAALIM DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ARCYEARVY (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2),
    SUMMASS DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ARCYEARVY11 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ARCYEARVY1104 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ARCYEARZA (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_ZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2),
    SUMMASS DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ARCYEARZA11 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_ZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE CALCBOLN (
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    PROC DECIMAL(15,2),
    MODE_V_Z INTEGER,
    CONTMODE INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    MODERECALCCLOCK INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    B_DAY INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE CALCOTP (
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    DAYCOMP INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    O_DAY INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE COPYTMPTOBOLN (
    SHIFRID INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE CRTMPBOLN (
    SHIFRID INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE CRTMPOTP (
    SHIFRID INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE CURRSHIFRPRA
RETURNS (
    SHIFRPRA SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE CURRSHIFRRIGHT
RETURNS (
    SHIFRPRA SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE CURRSHIFRRIGHTST
RETURNS (
    SHIFRSP SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE CURRSHIFRWRK
RETURNS (
    SHIFRWRK SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE DEL_ALL_PODR (
    YEARVYFR INTEGER,
    MONTNVYFR INTEGER,
    YEARVYTO INTEGER,
    MONTHVYTO INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE DELETE_VY (
    MVY INTEGER,
    YVY INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE DR8E
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    NAL_CODE CHAR(10),
    S NUMERIC(15,2),
    S1 NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ECB_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER,
    WANTEDSHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ECBDP_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ECBILL_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECBILL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ECBN_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE FZ (
    SUMMA DECIMAL(15,2),
    YEARZA INTEGER,
    MONTHZA INTEGER,
    TABNO INTEGER)
RETURNS (
    SUMMAFZ DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETALIMNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAALIM DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETALIMNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAALIM DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETECBDPNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETECBILLNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETECBNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETECBNNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETFZNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETFZNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETKATGRU (
    TABNO INTEGER)
RETURNS (
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    NAMEKAT VARCHAR(20),
    NAMEGRU VARCHAR(20),
    W_PLACE INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETKWODAYBETWEENTWODATE (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    KOW INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETNEWIDBOLN
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETNEWIDOTP
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETPENSNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETPENSNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETPERSONID
RETURNS (
    NUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETPODNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETPODNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETSSNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETSSNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GETSUMMYRASPERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMAADDPOD DECIMAL(15,2),
    SUMMAUDPOD DECIMAL(15,2),
    SUMMAADDALIM DECIMAL(15,2),
    SUMMAUDALIM DECIMAL(15,2),
    SUMMAADDPENS DECIMAL(15,2),
    SUMMAUDPENS DECIMAL(15,2),
    SUMMAADDSS DECIMAL(15,2),
    SUMMAUDSS DECIMAL(15,2),
    SUMMAADDFZ DECIMAL(15,2),
    SUMMAUDFZ DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GT2660
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    NALCODE VARCHAR(10),
    TOT NUMERIC(15,2),
    BUD NUMERIC(15,2),
    GN NUMERIC(15,2),
    OTHER NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE GT2660ZA (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    NALCODE VARCHAR(10),
    TOT NUMERIC(15,2),
    BUD NUMERIC(15,2),
    GN NUMERIC(15,2),
    OTHER NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ILL_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE INSERT_DOLG (
    SHIFRDOL INTEGER,
    NAMEDOL CHAR(50),
    RAZR INTEGER,
    OKLAD DECIMAL(15,2))
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE INSERT_KADRY (
    TABNO INTEGER,
    FIO VARCHAR(51),
    NAL_CODE VARCHAR(10),
    SHIFR_POD INTEGER,
    DP INTEGER,
    MP INTEGER,
    YP INTEGER,
    DU INTEGER,
    MU INTEGER,
    YU INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE INSERT_PODR (
    SHIFRPOD INTEGER,
    NAMEPOD CHAR(128))
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE ISBOLNDT (
    DT DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    B INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE ISKOMANDDT (
    DT DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE LENMONTH (
    D DATE)
RETURNS (
    L INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201112 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201201 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201207 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201209 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201210 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201210_1 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201211 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201404 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201404_09_10 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MAKEIND201706 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE MKTMPBOLNSUMMY (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4))
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE MKTMPBOLNSUMMY_10_05_2018 (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4),
    MODEWR INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE MKTMPOTPSUMMY (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    RAZRIJAD INTEGER,
    MODE INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE NUMBER_STRING_UKR (
    P_NUMBER NUMERIC(12,2))
RETURNS (
    NUMBER_STR VARCHAR(400))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE OTP_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE P_REP
RETURNS (
    FIO VARCHAR(60),
    TABNO INTEGER,
    TIN VARCHAR(10),
    E01 NUMERIC(15,2),
    E02 NUMERIC(15,2),
    E03 NUMERIC(15,2),
    E04 NUMERIC(15,2),
    E05 NUMERIC(15,2),
    E06 NUMERIC(15,2),
    E07 NUMERIC(15,2),
    E08 NUMERIC(15,2),
    E09 NUMERIC(15,2),
    E10 NUMERIC(15,2),
    E11 NUMERIC(15,2),
    E12 NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PENS (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAPENS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PENS_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPENS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PODOH (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PODOH_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2))
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PODOH_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PODOH_COMMON_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_1DF_ITOGI (
    Y INTEGER,
    M INTEGER)
RETURNS (
    NAMEB VARCHAR(20),
    NMBOFLINE INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_1DF_MK_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_1DF_MK_DOGPOD (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_1DF_SWOD_UD (
    Y INTEGER,
    CURRKW INTEGER)
RETURNS (
    SHIFRGRU INTEGER,
    NAMEGRU VARCHAR(20),
    SUMMA1 DECIMAL(15,2),
    SUMMA2 DECIMAL(15,2),
    SUMMA3 DECIMAL(15,2),
    SUMMAT DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_1DFCMPT6 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    MNTH INTEGER,
    SUMMAADD1DF DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_1DFCMPT6PERSON (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    SUMMAADDSWOD DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ADD_BOLN_TO_REE (
    SHIFRIDREE INTEGER,
    SHIFRIDBOLN INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ADD_FOR_SWOD (
    DATEFR DATE,
    DATETO DATE,
    SHIFRGRU INTEGER,
    NEEDPERIOD INTEGER)
RETURNS (
    LINENO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(52),
    SUMMA DECIMAL(15,2),
    PERIOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ADD_TO_CHAIN (
    TABNO INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    W_PLACE INTEGER,
    W_R INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_BASEDL_FOR_INDEX (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(40),
    W_PLACE INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_BLD_OTP_TABEL (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    S VARCHAR(31))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_BOLN_SWOD_LINES (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRKATB INTEGER,
    NAMEKATB VARCHAR(100),
    SHIFRBAY INTEGER,
    NAMEBAY VARCHAR(25),
    DAY_5 INTEGER,
    SUMMA_5 DECIMAL(15,2),
    DAY_O INTEGER,
    SUMMA_O DECIMAL(15,2),
    DAY_UH INTEGER,
    SUMMA_UH DECIMAL(15,2),
    DAY_DEK INTEGER,
    SUMMA_DEK DECIMAL(15,2),
    DAY_5_TOT INTEGER,
    SUMMA_5_TOT DECIMAL(15,2),
    DAY_TOT INTEGER,
    SUMMA_TOT DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_CALCKOEFOTP (
    WANTEDDATA DATE)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_CANMOVEOTP (
    SHIFRIDOTP INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_CMPINTANDCHAR (
    VAL1 INTEGER,
    VAL2 VARCHAR(32))
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_CR_SWOD (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    MODE1 INTEGER)
RETURNS (
    ISADD INTEGER,
    SHIFRSTA INTEGER,
    NAME VARCHAR(20),
    PERIOD INTEGER,
    SUMMA DECIMAL(15,2),
    FOND INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_CR_TB_PREP_UWP (
    Y INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_CR_TB_PREP_UWP_PERS (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_CR_TMP_TBLS_PERSON (
    TABNO INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    YEAR_VY INTEGER,
    MONTH_VY INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_DATE_INC (
    ADATE DATE,
    Y SMALLINT,
    M SMALLINT,
    D SMALLINT)
RETURNS (
    OUT_DATE DATE)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_DELETE_ALL_FROM_TMP_BOLN
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_DELETE_ALL_FROM_TMP_OTP
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_DELETE_TMP_PERSON_TABLES (
    TABNO INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_DELETE_TMP_PERSON_TABLES_ALL
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_DVV_AGE_REP_PEOPLES (
    MODE INTEGER)
RETURNS (
    CODE INTEGER,
    COMMENT VARCHAR(30),
    YOUNG DECIMAL(10,2),
    YOUNGST DECIMAL(10,2),
    MIDDLE DECIMAL(10,2),
    MIDDLEST DECIMAL(10,2),
    PENSIONER DECIMAL(10,2),
    PENSIONERST DECIMAL(10,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_DVV_AGE_REPORT_RECORDS (
    Y INTEGER,
    M INTEGER)
RETURNS (
    AMNT INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E04T05_6C_DEKR (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_E04T05_DEKR_2019 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_E4_1_3_2013_PERSON (
    TABNO INTEGER,
    RNUM INTEGER,
    IS_N INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4_13_CORR (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_E4_CORRECT_AFTER_TEST (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA_MODY DECIMAL(15,2),
    SUMMA_NEED DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4_CORRECT_NRC (
    YSRC INTEGER,
    MSRC INTEGER,
    YFR INTEGER,
    MFR INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_E4_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4_SETLIMIT (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_E4_SOWM_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4_TEST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_ECB_SV DECIMAL(15,2),
    SUM_TOTAL_SV DECIMAL(15,2),
    SUM_TOTALZP_SV DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4DP_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4ILL_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4N_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E4OTP_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER,
    SHIFRECB INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_E7_ALL_PERSON (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FIILL_ALL_PERS
RETURNS (
    T INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_FIILL_PERS_PERSON (
    TABNO INTEGER,
    Y INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FIILL_PERS_PERSON_ANK (
    TABNO INTEGER,
    Y INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FILL_B_REE_LINE (
    SHIFRIDREB INTEGER)
RETURNS (
    FIO VARCHAR(51),
    SWIDSS VARCHAR(15),
    NOMER_B VARCHAR(10),
    CODEILL INTEGER,
    PERIODILL VARCHAR(25),
    DAYTOT INTEGER,
    DAYSS INTEGER,
    SUMMATOT DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_FILL_B_REE_LINE_06_2012 (
    SHIFRIDREB INTEGER)
RETURNS (
    FIO VARCHAR(51),
    SWIDSS VARCHAR(15),
    NOMER_B VARCHAR(10),
    CODEILL INTEGER,
    DATAFR VARCHAR(10),
    DATATO VARCHAR(10),
    DAYTOT INTEGER,
    DAYSS INTEGER,
    SUMMATOT DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_FILL_DET_PERSON (
    Y INTEGER,
    M INTEGER,
    YCURR INTEGER,
    MCURR INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FILL_E04T05C (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FILL_KOMAND_OLD
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_FILL_P04T05B (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FILL_PERS_PERSON_IND (
    TABNO INTEGER,
    Y INTEGER,
    SHIFRIDANK INTEGER,
    TIN VARCHAR(10),
    KRPOU VARCHAR(12),
    DATEPRI DATE,
    DATEUW DATE,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_FILL_REEB_SUM (
    SHIFRID INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_FONDY (
    Y INTEGER,
    MFR INTEGER,
    MTO INTEGER,
    SHIFRGRU INTEGER)
RETURNS (
    RAZR INTEGER,
    NMBOFSTW DECIMAL(15,2),
    NMBOFPERS DECIMAL(15,2),
    SUMMAFOP DECIMAL(15,2),
    SUMMAOKL DECIMAL(15,2),
    SUMMADOPLO DECIMAL(15,2),
    SUMMADOPLN DECIMAL(15,2),
    SUMMAPREM DECIMAL(15,2),
    SUMMADOMIN DECIMAL(15,2),
    SUMMAOTH DECIMAL(15,2),
    SUMMAPREM102 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GEN_AGE_REPORT (
    Y INTEGER,
    M INTEGER)
RETURNS (
    YOUNGMAN DECIMAL(10,2),
    YOUNGWOMAN DECIMAL(10,2),
    MANS DECIMAL(10,2),
    WOMANS DECIMAL(10,2),
    PENSMAN DECIMAL(10,2),
    PENSWOMAN DECIMAL(10,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GEN_KREDIT_SPR (
    TABNO INTEGER,
    DOLG VARCHAR(100))
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GEN_NEW_SBS_SPR (
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    MODE_ZA_VY INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GEN_RENEW_SBS_SPR (
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    MODE_ZA_VY INTEGER,
    SHIFRIDSBS INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GEN_SBS_FOR_PERIOD (
    TABNO INTEGER,
    DATAZA DATE,
    MODE_ZA_VY INTEGER,
    SHIFRIDSBS INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_GEN_SBS_SPR (
    SHIFRIDSBS INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_GEN_Y_SPR (
    TABNO INTEGER,
    Y INTEGER,
    MODE_ZA INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_BASE_DATA_FOR_IND (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    DATAB DATE)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_BOLN_DAY (
    SHIFRKATBOLN INTEGER,
    SHIFRID INTEGER)
RETURNS (
    N_DAY INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_BUH_ACC_PODR
RETURNS (
    SHIFRPOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_BUH_BAY_PODR_LIST
RETURNS (
    SHIFRPOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_BUH_DOP_PODR_LIST
RETURNS (
    SHIFRPOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_DOLG_ID_PERSON_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRDOL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_DOLG_PERSON (
    TABNO INTEGER)
RETURNS (
    DOLG VARCHAR(100))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_DOLG_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    SHIFRIDDOLG INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_DOLG_PERSON_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    DOLG VARCHAR(100))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_FNO_PERSON (
    FIO VARCHAR(120))
RETURNS (
    F VARCHAR(50),
    N VARCHAR(50),
    O VARCHAR(50))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_GT_2660 (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    MODE INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO CHAR(51),
    NAL_CODE CHAR(10),
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_PREV DECIMAL(15,2),
    PENSLIMIT DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_GT_2660_CMP (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    MODE INTEGER)
RETURNS (
    PERIOD INTEGER,
    TABNO INTEGER,
    FIO CHAR(51),
    NAL_CODE CHAR(10),
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_PREV DECIMAL(15,2),
    PENSLIMIT DECIMAL(15,2),
    SUMMA_OP DECIMAL(15,2),
    SUMMA_PREV_OP DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_KAT_DOLG_PERSON_FOR_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRKAT INTEGER,
    SHIFRDOL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_KOEF_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_KOEF_PERSON_IND (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    KOEF DECIMAL(15,2),
    KOEFBUD DECIMAL(10,2),
    KOEFVNE DECIMAL(10,2),
    KOEFOSN DECIMAL(10,2),
    KOEFOSNBUD DECIMAL(10,2),
    KOEFOSNVNE DECIMAL(10,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_KOEF_PERSON_TMP (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_KOEF_RAZR (
    DATAFR DATE,
    CURRDATA DATE,
    MODE INTEGER,
    RAZR INTEGER)
RETURNS (
    KOEF DECIMAL(15,5))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_LIMIT_FOR_PENS (
    WANTEDDATA DATE)
RETURNS (
    SUMMALIMITA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_LIST_PERSON_FOR_RECALC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    NMES INTEGER)
RETURNS (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    W_PLACE INTEGER,
    SHIFRID INTEGER,
    FIO VARCHAR(50),
    DOLG VARCHAR(50),
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    W_R INTEGER,
    M_O_R INTEGER,
    MAIN INTEGER,
    FROMPODR INTEGER,
    OKLAD DECIMAL(15,2),
    AUTOMATIC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_M_NOT_PR (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_POD_ECB_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAALIMADD DECIMAL(15,2),
    SUMMAALIMUD DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_POD_PENS_SS_FZ_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAFZADD DECIMAL(15,2),
    SUMMAFZUD DECIMAL(15,2),
    SUMMASSADD DECIMAL(15,2),
    SUMMASSUD DECIMAL(15,2),
    SUMMAPENSADD DECIMAL(15,2),
    SUMMAPENSUD DECIMAL(15,2),
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAALIMADD DECIMAL(15,2),
    SUMMAALIMUD DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_PODR_NAME_HIST (
    SHIFRPOD INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL VARCHAR(200))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(20),
    DOLG CHAR(25),
    W_R INTEGER,
    W_PLACE INTEGER,
    SHIFR_KAT INTEGER,
    SHIFR_GRU INTEGER,
    RAZRJAD INTEGER,
    UCH_ZW INTEGER,
    UCH_ST INTEGER,
    KOEF DECIMAL(15,2),
    SHIFRDOL INTEGER,
    NAMEDOL CHAR(50),
    RAZRDOL INTEGER,
    OKLAD DECIMAL(15,2),
    POVOKLAD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_P_BY_DOLG_FOR_SWOD (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_P_BY_ID_FOR_SWOD (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_P_FOR_SWOD (
    SHIFRID INTEGER,
    MODE VARCHAR(10))
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_PERSON (
    TABNO INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_PERSON_BY_DOLG (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_PERSON_FOR_SWOD (
    SHIFRID INTEGER,
    MODE VARCHAR(10))
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_RAZR_PERSON_VY (
    TABNO INTEGER,
    MONTH_VY INTEGER,
    YEAR_VY INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_REP_CLOCKS (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    KWARTAL INTEGER,
    SHIFRPOD INTEGER,
    CURRYEAR INTEGER,
    CURRMONTH INTEGER)
RETURNS (
    CLOCKSPPSINNER DECIMAL(15,2),
    CLOCKSPPSOUTER DECIMAL(15,2),
    CLOCKSOTHERINNER DECIMAL(15,2),
    CLOCKSOTHEROUTER DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_SECRETWORKER_LIST
RETURNS (
    TABNO INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_SWM_MODE_PERSON_TMP (
    SHIFRIDPERSON INTEGER)
RETURNS (
    SWM_MODE INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GET_TOT_KOEF_PERSON (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2),
    OKLAD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETESTSUMMAFORINDPERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETESTSUMMAFORINDPERSONBP (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETFIOOPE (
    SHIFRWRK INTEGER)
RETURNS (
    FIO VARCHAR(50))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETGUID (
    SHIFRIDPERSON INTEGER,
    MODE INTEGER)
RETURNS (
    GUID VARCHAR(30))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETKOEFIND (
    BASEDATA DATE,
    WANTEDDATE DATE)
RETURNS (
    PROCIND DECIMAL(15,1),
    KKK DECIMAL(15,6),
    K4 DECIMAL(15,6))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETLGCNPN2011 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    LGOTYPN DECIMAL(15,2),
    ISLGOTY INTEGER,
    KWOD INTEGER,
    FINDED INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETMONTHNAMEUKR (
    M INTEGER)
RETURNS (
    RETVAL VARCHAR(15))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETPICK (
    SHIFRWRK INTEGER)
RETURNS (
    SHIFRPOD INTEGER,
    TABNO INTEGER,
    W_R INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GETPODRNAMER (
    SHIFRPOD INTEGER)
RETURNS (
    NAME VARCHAR(256))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GT_LIMIT_2014 (
    Y INTEGER,
    M INTEGER,
    DATEFR DATE)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_GT_LIMIT_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    DATEFR DATE)
RETURNS (
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_I_MOVTOKADRY
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_INDFICSPERSON201208 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_INITFILLTBOTPUSK201201
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_INITFILLTBOTPUSK201204
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_IO_ISFREE (
    NSRV INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IO_LOCK (
    NSRV INTEGER,
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IO_UNLOCK (
    NSRV INTEGER,
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IO_UNLOCK_ALL_MY (
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IS_COLEDGPODR (
    SHIFRPOD INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IS_DOGPOD (
    SHIFRPOD INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IS_OTP_BEZ_O (
    TABNO INTEGER,
    DATEC DATE)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IS_SCIPED (
    SHIFRIDPERSON INTEGER,
    MODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_IS_ZAWLAB (
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISBOLNSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISNEEDIND (
    TABNO INTEGER,
    M INTEGER,
    Y INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISOSNWRBYID (
    SHIFRID INTEGER)
RETURNS (
    SHIFRWR INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISOTHERPERIODECBSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISOTHERPERIODECBSHIFR_PERS (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISOTHERPERIODECBSHIFR_Y (
    SHIFRVAL INTEGER,
    Y INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ISOTPSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_ADDPERSONTOSHTATRASP (
    SHIFRIDRASP INTEGER,
    SHIFRIDPERSON INTEGER,
    MODEFAC INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_K_CMPSHTRASP (
    DATEFR DATE,
    DATETO DATE,
    SHIFRWR INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    MES VARCHAR(1024))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CMPSTAGSHTRASPWITHSAL (
    DATEFR DATE,
    SHIFRWR INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    MES VARCHAR(1024))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CREATEFULLTEXTORDER (
    WANTEDDATE DATE,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CREATEONERECORDFORORDER (
    SHIFRIDSHTRASPREC INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CREATEORDER (
    SHIFRIDORD INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_K_CREATESHRASPALL (
    WANTEDDATE DATE,
    MODE INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CREATESHTRASP (
    WANTEDDATE DATE,
    NSRV INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_CREATESHTRASPDEC (
    WANTEDDATE DATE,
    NSRV INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_DOCONOTHERSTAWKA (
    WANTEDDATE DATE)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_GET_ZAMDEK (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    PROC DECIMAL(15,2),
    SUMMA DECIMAL(15,2),
    FIO VARCHAR(50),
    DOLG VARCHAR(20),
    SHIFRPOD INTEGER,
    NAMEKAF VARCHAR(120),
    ISTFIN VARCHAR(10),
    OSN_DOLG VARCHAR(20),
    OSN_OKLAD DECIMAL(15,2),
    SHIFRFAC INTEGER,
    NAMEFAC VARCHAR(128),
    SHIFRIDK INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_GETORDERID (
    WANTEDDATE DATE,
    SHIFRWR INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_GETORDERIDFORMODE (
    SHIFRIDOLD INTEGER,
    MODEFAC INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MAKEORDERTEXT (
    SHIFRIDORD INTEGER,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MAKETEXTORDERREC (
    SHIFRIDSHTREC INTEGER,
    WANTEDDATE DATE)
RETURNS (
    S VARCHAR(4096))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MAKETEXTORDERREC201201 (
    SHIFRIDSHTREC INTEGER,
    WANTEDDATE DATE,
    MODEFAC INTEGER)
RETURNS (
    S VARCHAR(4096))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MAKETEXTORDKAF (
    SHIFRKAF INTEGER,
    WANTEDDATE DATE,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    S VARCHAR(4096),
    TABNO INTEGER,
    FIO VARCHAR(50),
    SHIFRIDREC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MARKPEDRABOTNIKI
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MARKPEDST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MARKUSZ
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MARKZAWKAF
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_MOVEFIXTOSHT (
    DATENEW DATE,
    DATEOLD DATE)
RETURNS (
    FINDED INTEGER,
    MAKED INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_PEDSTAG (
    TABNO INTEGER,
    WANTEDDATE DATE)
RETURNS (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_PROFONOTHERSTAWKA (
    WANTEDDATE DATE)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_SELRECFORWORD (
    SHIFRIDORD INTEGER,
    SHIFRPOD INTEGER,
    MODEFAC INTEGER)
RETURNS (
    FIO VARCHAR(50),
    TEXT VARCHAR(4096))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_SHTRMOVEPODRREC (
    SHIFRIDREC INTEGER,
    SHIFRPOD INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_K_TESTUSZ (
    WANTEDDATE DATE)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    COMMENT VARCHAR(150))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_KOMAND_CALC (
    SHIFRID INTEGER,
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    MODE_V_Z INTEGER,
    MODEDC INTEGER,
    MODERECALCCLOCK INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    K_DAY INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_KOMAND_INIT (
    SHIFRID INTEGER,
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4))
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_LIST_PENS_INV (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    SHIFRPOD INTEGER,
    NAMEPOD VARCHAR(256),
    SUMMA DECIMAL(15,2),
    NAMEKIND VARCHAR(32))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_LIST_SOWM_IN_OUT (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    NEEDSUMMA INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    SHIFRPOD INTEGER,
    NAMEPOD VARCHAR(256),
    SUMMA DECIMAL(15,2),
    NAMEKIND VARCHAR(32))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_LT_MIN_SAL
RETURNS (
    TABNO INTEGER,
    TIN VARCHAR(10),
    FULLN_U VARCHAR(30),
    NAME_U VARCHAR(15),
    FATH_U VARCHAR(20),
    SUMMA_1 DECIMAL(15,2),
    SUMMA_2 DECIMAL(15,2),
    SUMMA_3 DECIMAL(15,2),
    SUMMA_4 DECIMAL(15,2),
    SUMMA_5 DECIMAL(15,2),
    SUMMA_6 DECIMAL(15,2),
    SUMMA_7 DECIMAL(15,2),
    SUMMA_8 DECIMAL(15,2),
    SUMMA_9 DECIMAL(15,2),
    SUMMA_10 DECIMAL(15,2),
    SUMMA_11 DECIMAL(15,2),
    SUMMA_12 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MAGISRATURA
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(20),
    DOLG VARCHAR(11),
    OKLAD DECIMAL(15,2),
    SUMMA_ST DECIMAL(15,2),
    SUMMA_ZW DECIMAL(15,2),
    SUMMA_ZASL DECIMAL(15,2),
    SUMMA_VYSL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MAKE_CHAIN (
    YEARVY INTEGER,
    MONTHVY INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MAKEIND201208
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MARK_ADD_FOR_OTP (
    SHIFRWR INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MARKMOALL
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_E4_ALL (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MK_IND_0712_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_IND_0912_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_IND_201404_8_9_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_IND_201404_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_IND_201706_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_OTPSWOD (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_OTPSWOD_ALL (
    DATEFR DATE,
    DATETO DATE,
    MODE_RUN INTEGER)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_OTPSWOD_ARC (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_P4_ALL (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MK_P4_ALL_2010 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_MK_SWOD_MATHELP (
    Y INTEGER,
    M INTEGER,
    CURR_MODE INTEGER,
    PODR_MODE INTEGER)
RETURNS (
    SUMMA_MP_BUD DECIMAL(15,2),
    SUMMA_MP_VNE DECIMAL(15,2),
    SUMMA_OZD_BUD DECIMAL(15,2),
    SUMMA_OZD_VNE DECIMAL(15,2),
    SUMMA_POCH_BUD DECIMAL(15,2),
    SUMMA_POCH_VNE DECIMAL(15,2),
    SHIFRDOL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MK_SWOD_MATHELP_DET (
    Y INTEGER,
    M INTEGER,
    CURR_MODE INTEGER,
    PODR_MODE INTEGER,
    SHIFRDOL INTEGER)
RETURNS (
    SUMMA_MP_BUD DECIMAL(15,2),
    SUMMA_MP_VNE DECIMAL(15,2),
    SUMMA_OZD_BUD DECIMAL(15,2),
    SUMMA_OZD_VNE DECIMAL(15,2),
    SUMMA_POCH_BUD DECIMAL(15,2),
    SUMMA_POCH_VNE DECIMAL(15,2),
    W_PLACE INTEGER,
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    TABNO INTEGER,
    FIO VARCHAR(100),
    SHIFRDOLW INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_MOV_PFU
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_OTPHELPLIST2011
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P4_CVT_4_5_TO_9 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P4_CVT_5_TO_9 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P4_LINK_4_5 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P4_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_P4_PERSON_2010 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_P4_TEST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_PENS_SV DECIMAL(15,2),
    SUM_TOTAL_SV DECIMAL(15,2),
    SUM_TOTALZP_SV DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P4_TEST_T7_1 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_PENS_SV DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_P6_REMAKE (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2),
    NMB INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERS_PREP
RETURNS (
    TABNO INTEGER,
    NAL_CODE VARCHAR(10),
    FIO VARCHAR(50),
    M_O_R INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERS_PREP_SOWM
RETURNS (
    TABNO INTEGER,
    NAL_CODE VARCHAR(10),
    FIO VARCHAR(50),
    M_O_R INTEGER,
    S1 DECIMAL(15,2),
    S2 DECIMAL(15,2),
    S3 DECIMAL(15,2),
    S4 DECIMAL(15,2),
    S5 DECIMAL(15,2),
    S6 DECIMAL(15,2),
    S7 DECIMAL(15,2),
    S8 DECIMAL(15,2),
    S9 DECIMAL(15,2),
    S10 DECIMAL(15,2),
    S11 DECIMAL(15,2),
    S12 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERSON_ANALYZE_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRIDPERSON INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    DOLG VARCHAR(50),
    SHIFRKAT INTEGER,
    KATNAME VARCHAR(40),
    SHIFRGRU INTEGER,
    GRUNAME VARCHAR(40),
    KOEF DECIMAL(15,2),
    W_R INTEGER,
    W_R_NAME VARCHAR(10),
    W_PLACE INTEGER,
    W_P_NAME VARCHAR(100),
    SUMMAADD DECIMAL(15,2),
    SUMMAADDMAX DECIMAL(15,2),
    SUMMAUD DECIMAL(15,2),
    SUMMAUDR DECIMAL(15,2),
    SUMMAUDN DECIMAL(15,2),
    MODEPRSN INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERSON_CHAIN_ADD_REC (
    SHIFRIDPERSON INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(20),
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERSON_CHAIN_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRIDPERSON INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    DOLG VARCHAR(10),
    SHIFRKAT INTEGER,
    KATNAME VARCHAR(40),
    SHIFRGRU INTEGER,
    GRUNAME VARCHAR(40),
    KOEF DECIMAL(15,2),
    W_R INTEGER,
    W_R_NAME VARCHAR(10),
    W_PLACE INTEGER,
    W_P_NAME VARCHAR(100),
    SUMMAADD DECIMAL(15,2),
    SUMMAUD DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PERSON_CHAIN_UD_REC (
    SHIFRIDPERSON INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(20),
    SUMMA DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PLAN_FOND_MK (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    MODE_PERIOD INTEGER)
RETURNS (
    NMBOSNTOT INTEGER,
    SUMMAOSNTOT DECIMAL(15,2),
    NMBOSNWMN INTEGER,
    SUMMAOSNWMN DECIMAL(15,2),
    NMBSWMTOT INTEGER,
    SUMMASWMTOT DECIMAL(15,2),
    NMBSWMWMN INTEGER,
    SUMMASWMWMN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PLAN_GRID_MK (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SUMMAFR DECIMAL(15,2),
    SUMMATO DECIMAL(15,2),
    NMBOFPRSN INTEGER,
    NMBOFWMN INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PLAN_RAZR_SWOD (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    RAZROUT INTEGER,
    OKLADOUT DECIMAL(15,2),
    FOPOUT DECIMAL(15,2),
    FOPOKLADOUT DECIMAL(15,2),
    FOPDOPLOUT DECIMAL(15,2),
    INDOUT DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PR_AND_NOT_PR (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(120),
    DOLG VARCHAR(10),
    SUMMASCI DECIMAL(15,2),
    SUMMAOTH NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PR_AND_NOT_PR_MONTH (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    DOLG VARCHAR(10),
    SUMMASCI DECIMAL(15,2),
    SUMMAOTH NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_PRINT_BOLN (
    SHIFRIDBOLN INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_08
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_10
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_10_2 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_10N (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_13_1_2 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_15_9_SVDN (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_ALL_PEOPLE (
    Y INTEGER,
    M INTEGER,
    YCURR INTEGER,
    MCURR INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_RECALC_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SHIFRID INTEGER,
    DEBUGMODE INTEGER,
    GUID VARCHAR(30))
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_POCHAS_13_1_3 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALC_PODOH_2012
RETURNS (
    FIO VARCHAR(51),
    TABNO INTEGER,
    SUMMAADD1 DECIMAL(10,2),
    SUMMAUD1 DECIMAL(10,2),
    SUMMARAS1 DECIMAL(10,2),
    SUMMAREZ1 DECIMAL(10,2),
    SUMMAADD2 DECIMAL(10,2),
    SUMMAUD2 DECIMAL(10,2),
    SUMMARAS2 DECIMAL(10,2),
    SUMMAREZ2 DECIMAL(10,2),
    SUMMAADD3 DECIMAL(10,2),
    SUMMAUD3 DECIMAL(10,2),
    SUMMARAS3 DECIMAL(10,2),
    SUMMAREZ3 DECIMAL(10,2),
    SUMMAADD4 DECIMAL(10,2),
    SUMMAUD4 DECIMAL(10,2),
    SUMMARAS4 DECIMAL(10,2),
    SUMMAREZ4 DECIMAL(10,2),
    SUMMAADD5 DECIMAL(10,2),
    SUMMAUD5 DECIMAL(10,2),
    SUMMARAS5 DECIMAL(10,2),
    SUMMAREZ5 DECIMAL(10,2),
    SUMMAADD6 DECIMAL(10,2),
    SUMMAUD6 DECIMAL(10,2),
    SUMMARAS6 DECIMAL(10,2),
    SUMMAREZ6 DECIMAL(10,2),
    SUMMAADD7 DECIMAL(10,2),
    SUMMAUD7 DECIMAL(10,2),
    SUMMARAS7 DECIMAL(10,2),
    SUMMAREZ7 DECIMAL(10,2),
    SUMMAADD8 DECIMAL(10,2),
    SUMMAUD8 DECIMAL(10,2),
    SUMMARAS8 DECIMAL(10,2),
    SUMMAREZ8 DECIMAL(10,2),
    SUMMAADD9 DECIMAL(10,2),
    SUMMAUD9 DECIMAL(10,2),
    SUMMARAS9 DECIMAL(10,2),
    SUMMAREZ9 DECIMAL(10,2),
    SUMMAADD10 DECIMAL(10,2),
    SUMMAUD10 DECIMAL(10,2),
    SUMMARAS10 DECIMAL(10,2),
    SUMMAREZ10 DECIMAL(10,2),
    SUMMAADD11 DECIMAL(10,2),
    SUMMAUD11 DECIMAL(10,2),
    SUMMARAS11 DECIMAL(10,2),
    SUMMAREZ11 DECIMAL(10,2),
    SUMMAADD12 DECIMAL(10,2),
    SUMMAUD12 DECIMAL(10,2),
    SUMMARAS12 DECIMAL(10,2),
    SUMMAREZ12 DECIMAL(10,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_RECALCIND_10 (
    Y INTEGER,
    M INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_RECALCPODOHMONTH_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_REFILL_OTP_2012_01
RETURNS (
    NMBOFREC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_REFILL_OTP_2012_04
RETURNS (
    NMBOFREC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_RENEW_OTP_2012_01
RETURNS (
    NMBOFREC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_RENEW_OTP_2012_04
RETURNS (
    NMBOFREC INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_REP_GANNA_SVDN (
    DATEFR DATE,
    DATETO DATE,
    SHIFRKAT INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(128),
    DOLG VARCHAR(32),
    OKLAD DECIMAL(15,2),
    COMMENT VARCHAR(128),
    SUMMAOPL DECIMAL(15,2),
    SUMMAOKL DECIMAL(15,2),
    SUMMAST DECIMAL(15,2),
    SUMMAZW DECIMAL(15,2),
    SUMMAVYSL DECIMAL(15,2),
    PROCST DECIMAL(15,2),
    PROCZW DECIMAL(15,2),
    PROCVYSL DECIMAL(15,2),
    SHIFRKAF INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_REP_SINGL_RAS_FOR_DOUBLES (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    W_PLACE INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_RESETDOTPMOV (
    CODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_ROOT_CHAIN_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAUDF DECIMAL(15,2),
    SUMMAUDR DECIMAL(15,2),
    SUMMAUDN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_SBS_CALC_FOR_PERIOD (
    DATAZA DATE,
    SHIFRIDSBS INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_SET_KADRY_PODR
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_SETDOTPMOV (
    SHIFRIDOTP INTEGER,
    GRUPPA INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_SETPICK (
    SHIFRWRK INTEGER,
    SHIFRPOD INTEGER,
    TABNO INTEGER,
    W_R INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_SWOD_LI (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMAST DECIMAL(15,2),
    SUMMATOT DECIMAL(15,2),
    K DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_SWODY_CMP (
    SHIFRIDFR INTEGER,
    SHIFRIDTO INTEGER)
RETURNS (
    SHIFRSTAFR INTEGER,
    SHIFRPODFR INTEGER,
    PERIODFR INTEGER,
    SUMMAFR DECIMAL(10,2),
    NMBOFRECFR INTEGER,
    SHIFRSTATO INTEGER,
    SHIFRPODTO INTEGER,
    PERIODTO INTEGER,
    SUMMATO DECIMAL(10,2),
    NMBOFRECTO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(50),
    PERIOD INTEGER,
    SHIFRPOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_T6CMPSWODPERSON (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    SUMMAADDSWOD DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TEST_CHG_DOL
RETURNS (
    FIO VARCHAR(50),
    NSRV INTEGER,
    DOLG VARCHAR(40),
    DOLG1 VARCHAR(40),
    OKLAD DECIMAL(15,2),
    OKLAD1 INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TEST_MEM_LERA (
    Y INTEGER,
    M INTEGER,
    SHIFRGRU INTEGER)
RETURNS (
    NSRV INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAT DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TESTSECRETWORKER (
    TABNO INTEGER)
RETURNS (
    RETVAL SMALLINT)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TOR_PREM_ADD (
    Y INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_TOR_PREM_KWA (
    Y INTEGER,
    KW INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    SHIFRROW INTEGER,
    NMBOFWORKER INTEGER,
    SUMMANADBBUD DECIMAL(15,2),
    SUMMAPREMBUD DECIMAL(15,2),
    SUMMANADBVNE DECIMAL(15,2),
    SUMMAPREMVNE DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TOR_PREM_MON (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    SHIFRROW INTEGER,
    NMBOFWORKER INTEGER,
    SUMMANADBBUD DECIMAL(15,2),
    SUMMAPREMBUD DECIMAL(15,2),
    SUMMANADBVNE DECIMAL(15,2),
    SUMMAPREMVNE DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_TOR_PREM_SWOD (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PR_UD_FOR_SWOD (
    DATEFR DATE,
    DATETO DATE,
    SHIFRGRU INTEGER,
    NEEDPERIOD INTEGER)
RETURNS (
    LINENO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(52),
    SUMMA DECIMAL(15,2),
    PERIOD INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PR_WORK_CLOCK_LERA (
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE PUTBOLN (
    SHIFRID INTEGER,
    TABNO INTEGER,
    NOMER_B CHAR(10),
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    PROCENT DECIMAL(15,2),
    SHIFRSTA INTEGER,
    B_DAY INTEGER,
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    MODE_V_Z INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    SWIDSS VARCHAR(15),
    CODEILL INTEGER,
    SHIFRBUH INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PUTBOLN_10_05_2018 (
    SHIFRID INTEGER,
    TABNO INTEGER,
    NOMER_B CHAR(10),
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    PROCENT DECIMAL(15,2),
    SHIFRSTA INTEGER,
    B_DAY INTEGER,
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    MODE_V_Z INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    SWIDSS VARCHAR(15),
    CODEILL INTEGER,
    SHIFRBUH INTEGER,
    MODEWR INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE PUTOTP (
    SHIFRID INTEGER,
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    SHIFRSTA INTEGER,
    O_DAY INTEGER,
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    RAZRIJAD INTEGER,
    MODE INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER,
    NOMER_PRI VARCHAR(10),
    DATA_PRI DATE,
    PERIOD_PRI VARCHAR(30),
    MODE_25_07_2016 INTEGER)
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE R_01_ALL_LIST
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(25),
    DOLG VARCHAR(10),
    SHIFRGRU INTEGER,
    SHIFRKAT INTEGER,
    SUMMA DECIMAL(15,2),
    NAMEGRU VARCHAR(15),
    NAMEKAT VARCHAR(30),
    W_PLACE INTEGER,
    KOEF DECIMAL(15,2),
    W_DAY INTEGER,
    I_DAY INTEGER,
    O_DAY INTEGER,
    NAMEPOD CHAR(80))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE R_01_LIST (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    FIO VARCHAR(25),
    DOLG VARCHAR(10),
    SHIFRGRU INTEGER,
    SHIFRKAT INTEGER,
    SUMMA DECIMAL(15,2),
    NAMEGRU VARCHAR(15),
    NAMEKAT VARCHAR(30),
    W_PLACE INTEGER,
    KOEF DECIMAL(15,2),
    W_DAY INTEGER,
    I_DAY INTEGER,
    O_DAY INTEGER,
    NAMEPOD CHAR(80))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE R_LIST (
    TABNO INTEGER,
    DT DATE,
    DOPPODRMODE INTEGER)
RETURNS (
    RETVAL VARCHAR(250))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCECBYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMANADD DECIMAL(15,2),
    SUMMAADD DECIMAL(15,2),
    SUMMADPADD DECIMAL(15,2),
    SUMMAILLADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCFZYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAFZUD DECIMAL(15,2),
    SUMMAFZRAS DECIMAL(15,2),
    SUMMAFZRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCPENSYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAPENSUD DECIMAL(15,2),
    SUMMAPENSRAS DECIMAL(15,2),
    SUMMAPENSRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCPODOHYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCPODOHYEAR_2010 (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE RECALCSSYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMASSUD DECIMAL(15,2),
    SUMMASSRAS DECIMAL(15,2),
    SUMMASSRAZN DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE SETIDBOLNA
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE SETIDBOLNASUMMY
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE SETIDOTPADD
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE SS (
    SUMMA DECIMAL(15,2),
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMASS DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TEST_MEM
RETURNS (
    TABNO INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMA1 DECIMAL(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TESTF_Z (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA NUMERIC(15,2),
    FOND NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TESTS_S (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA NUMERIC(15,2),
    F_S_S NUMERIC(15,2))
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TESTSUBBOTA (
    D DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUBBOTA INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TESTVOSKR (
    D DATE)
RETURNS (
    VOSKR INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE TMP_CR_RAZR
AS
BEGIN
  EXIT;
END^





CREATE PROCEDURE WORK_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE WORK_DAY_COMMON (
    TABNO INTEGER,
    DT DATE,
    MODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^





CREATE PROCEDURE WORK_DAY_FOR_SOWM (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
BEGIN
  SUSPEND;
END^






SET TERM ; ^



/******************************************************************************/
/***                                 Tables                                 ***/
/******************************************************************************/



CREATE TABLE ALIMENTY (
    SHIFR       INTEGER NOT NULL,
    FIO_WOMEN   VARCHAR(50),
    ADRES       VARCHAR(79),
    DATATO      DATE,
    DATAFR      DATE,
    TABNO       INTEGER,
    SHIFRWRK    INTEGER,
    DATEWRK     TDATEWRK,
    PROCENT     DECIMAL(15,2),
    PROCENTPST  DECIMAL(15,2),
    FIO_WORKER  VARCHAR(50),
    MODE        INTEGER,
    CODE        INTEGER,
    KOD         TSMALLCODE
);

CREATE TABLE BAY (
    SHIFRPOD  INTEGER NOT NULL,
    SHIFRBUH  INTEGER NOT NULL
);

CREATE TABLE BOL_KOE (
    DATEB     DATE NOT NULL,
    DATEZA    DATE NOT NULL,
    KOEF      DECIMAL(10,4),
    SHIFRKAT  INTEGER,
    SHIFRWRK  INTEGER,
    DATEWRK   TDATEWRK,
    SHIFRID   TBIGCODE NOT NULL,
    MODE      SMALLINT NOT NULL
);

CREATE TABLE BOLN (
    SHIFRID          INTEGER NOT NULL,
    TABNO            TBIGCODE NOT NULL,
    NAL_CODE         CHAR(10),
    ID_OWNER         TBIGCODE NOT NULL,
    NOMER_B          CHAR(10),
    FIO              CHAR(51) NOT NULL,
    W_PLACE          TSMALLCODE,
    SHIFRKAT         TSMALLCODE,
    SHIFRGRU         TSMALLCODE,
    F_DATA           TDATE,
    F_MONTH          TMONTH,
    F_YEAR           TYEAR,
    L_DATA           TDATE,
    L_MONTH          TMONTH,
    L_YEAR           TYEAR,
    WID_RAB          TSMALLCODE,
    DATA_VY          TDATE,
    MONTH_VY         TMONTH NOT NULL,
    YEAR_VY          TYEAR NOT NULL,
    OKLAD            TSUMMAPERSON,
    K_WO_DAY         TSMALLCODE,
    PROCENT          TSUMMAPERSON,
    KAT_KOE          TSMALLCODE,
    SHIFR_STA        TSMALLCODE,
    MEAN_DAY         TMEANDAYSUMMA,
    MEAN_DAY_BUD     TMEANDAYSUMMA,
    MEAN_DAY_VNE     TMEANDAYSUMMA,
    MEAN_DAY_GN      TMEANDAYSUMMA,
    MEAN_DAY_NIS     TMEANDAYSUMMA,
    DOUBLE_DAY       TMEANDAYSUMMA,
    SUMMA_BOL        TSUMMAPERSON,
    SUMMA_BOL_B      TSUMMAPERSON,
    SUMMA_BOL_V      TSUMMAPERSON,
    SUMMA_BOL_G      TSUMMAPERSON,
    SUMMA_BOL_N      TSUMMAPERSON,
    DATA_P_BUD       TDATE,
    DATA_P_VNE       TDATE,
    DATA_P_GN        TDATE,
    DATA_P_NIS       TDATE,
    MODE_V_Z         TSMALLCODE,
    MODE_ILL         TSMALLCODE,
    SHIFRWRK         TSMALLCODE,
    DATEWRK          TDATEWRK,
    ID_CLAR          INTEGER,
    MARKED           TSMALLCODE,
    MODE_DAY_CLOCK   TSMALLCODE,
    SWIDSS           VARCHAR(15),
    CODE_REASON_ILL  TBIGCODE,
    SHIFRIDREB       TBIGCODE,
    SHIFRBUH         TBIGCODE,
    MODEWR           TSMALLCODE
);

CREATE TABLE BOLN_RES (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDBOLN   TBIGCODE NOT NULL,
    SHIFRSTA      TSMALLCODE NOT NULL,
    B_DAY         TSMALLCODE NOT NULL,
    MONTH_ZA      TMONTH,
    YEAR_ZA       TYEAR,
    SUMMA_B_BUD   TSUMMAPERSON,
    SUMMA_B_VNE   TSUMMAPERSON,
    SUMMA_B_GN    TSUMMAPERSON,
    SUMMA_B_NIS   TSUMMAPERSON,
    SHIFRWRK      TSMALLCODE,
    DATEWRK       TDATEWRK,
    SUMMA_P_BUD   TSUMMAPERSON,
    SUMMA_P_VNE   TSUMMAPERSON,
    SUMMA_P_GN    TSUMMAPERSON,
    SUMMA_P_NIS   TSUMMAPERSON,
    SUMMA_E_BUD   TSUMMAPERSON,
    SUMMA_E_VNE   TSUMMAPERSON,
    SUMMA_E_GN    TSUMMAPERSON,
    SUMMA_E_NIS   TSUMMAPERSON,
    SUMMA_BA_BUD  TSUMMAPERSON,
    SUMMA_BA_VNE  TSUMMAPERSON,
    SUMMA_BA_GN   TSUMMAPERSON,
    SUMMA_BA_NIS  TSUMMAPERSON
);

CREATE TABLE BOLN_SUMMY (
    SHIFRID      INTEGER NOT NULL,
    SHIFRIDBOLN  INTEGER NOT NULL,
    SEL          TSMALLCODE,
    MONTH_ZA     TMONTH,
    YEAR_ZA      TYEAR,
    SUMMA_BUD    TSUMMAPERSON,
    SUMMA_VNE    TSUMMAPERSON,
    SUMMA_GN     TSUMMAPERSON,
    SUMMA_NIS    TSUMMAPERSON,
    OKLAD_M      TSUMMAPERSON,
    DAYS         TSMALLCODE,
    GRAPHIC_DAY  TSMALLCODE,
    KOEF         TMEANDAYSUMMA,
    SHIFRWRK     TSMALLCODE,
    DATEWRK      TDATEWRK,
    MANUAL_CALC  TSMALLCODE DEFAULT 0
);

CREATE TABLE BOLNA (
    SHIFRID           TBIGCODE NOT NULL,
    SHIFRIDBOLN       TBIGCODE NOT NULL,
    SHIFRIDBOLNSUMMY  TBIGCODE,
    W_PLACE           TSMALLCODE,
    W_R               TSMALLCODE,
    SHIFRGRU          TSMALLCODE,
    SHIFRKAT          TSMALLCODE,
    SHIFRSTA          TSMALLCODE,
    MONTH_ZA          TMONTH,
    YEAR_ZA           TYEAR,
    MONTH_VY          TMONTH,
    YEAR_VY           TYEAR,
    SUMMA             TSUMMAPERSON,
    VYPL              TSMALLCODE,
    MARKED            TSMALLCODE,
    SHIFRWRK          TSMALLCODE,
    DATEWRK           TDATEWRK,
    ID_CLAR           INTEGER,
    TABNO             INTEGER
);

CREATE TABLE "Categories" (
    "Id"          INTEGER NOT NULL,
    "Name"        VARCHAR(50) COLLATE PXW_CYRL,
    "GoodsCount"  INTEGER
);

CREATE TABLE FADD (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          TSMALLCODE,
    W_PLACE        TSMALLCODE,
    W_R            SMALLINT,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    WDAY           DECIMAL(12,2),
    WCLOCK         DECIMAL(12,2),
    FOND           TSMALLCODE,
    VYPL           TSMALLCODE,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK
);

CREATE TABLE FCN (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    MONTH_VY       SMALLINT NOT NULL,
    YEAR_VY        SMALLINT NOT NULL,
    SHIFRSTA       SMALLINT,
    KOD            SMALLINT,
    SUMMA          DECIMAL(12,2),
    PRIM           INTEGER,
    PRIM_1         VARCHAR(60),
    DEJA_COUNTED   SMALLINT,
    FLOW_SUMMA     DECIMAL(15,2),
    LIMIT_SUMMA    DECIMAL(15,2),
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK,
    AUTOMATIC      TSMALLCODE,
    ID             TBIGCODE
);

CREATE TABLE FUD (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    SHIFRSTA       SMALLINT,
    MONTH_ZA       SMALLINT NOT NULL,
    YEAR_ZA        SMALLINT NOT NULL,
    MONTH_VY       SMALLINT,
    YEAR_VY        SMALLINT,
    SUMMA          DECIMAL(12,2),
    VYPL           SMALLINT,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK
);

CREATE TABLE "Goods" (
    "Id"          INTEGER NOT NULL,
    "Name"        VARCHAR(150) COLLATE PXW_CYRL,
    "Price"       DOUBLE PRECISION,
    "IdCategory"  INTEGER NOT NULL
);

CREATE TABLE GRUPPY (
    SHIFR       INTEGER NOT NULL,
    NAME        VARCHAR(20),
    NAME_PLAT   VARCHAR(8),
    MO_BUD      SMALLINT,
    MO_VNE      SMALLINT,
    MO_KOL_BUD  SMALLINT,
    MO_KOL_VNE  SMALLINT,
    MO_GN       SMALLINT,
    MO_NIS      SMALLINT,
    MO_MAG_BUD  SMALLINT,
    MO_MAG_VNE  SMALLINT,
    MO_MP       SMALLINT,
    SHIFRGRUM   TSMALLCODE,
    MO_ISKRA    TSMALLCODE,
    "ACTIVE"    TSMALLCODE
);

CREATE TABLE GRUPPY_GRU (
    SHIFR_GRUM  INTEGER NOT NULL,
    NAME        VARCHAR(20),
    IDOWNER     INTEGER,
    SHIFRWRK    INTEGER,
    DATEWRK     TDATEWRK
);

CREATE TABLE I_GRUPPY (
    SHIFR_GRU  TSMALLCODE NOT NULL,
    SHIFRWRK   TSMALLCODE,
    DATEWRK    TDATEWRK,
    MODE       TSMALLCODE,
    SHIFRID    TBIGCODE NOT NULL
);

CREATE TABLE I_KAT (
    SHIFR_KAT  TSMALLCODE NOT NULL,
    SHIFRWRK   TSMALLCODE,
    DATEWRK    TDATEWRK,
    MODE       TSMALLCODE,
    SHIFRID    TBIGCODE NOT NULL
);

CREATE TABLE I_PODR (
    SHIFR_POD  TSMALLCODE NOT NULL,
    SHIFRWRK   TSMALLCODE,
    DATEWRK    TDATEWRK,
    SHIFRID    TBIGCODE NOT NULL,
    MODE       TSMALLCODE
);

CREATE TABLE IBE$LOG_BLOB_FIELDS (
    LOG_TABLES_ID   NUMERIC(18,0) NOT NULL,
    FIELD_NAME      VARCHAR(67) CHARACTER SET UNICODE_FSS NOT NULL,
    OLD_CHAR_VALUE  VARCHAR(10000) CHARACTER SET UNICODE_FSS,
    NEW_CHAR_VALUE  VARCHAR(10000) CHARACTER SET UNICODE_FSS,
    OLD_BLOB_VALUE  BLOB SUB_TYPE 0 SEGMENT SIZE 80,
    NEW_BLOB_VALUE  BLOB SUB_TYPE 0 SEGMENT SIZE 80
);

CREATE TABLE IBE$LOG_FIELDS (
    LOG_TABLES_ID  NUMERIC(18,0) NOT NULL,
    FIELD_NAME     VARCHAR(67) CHARACTER SET UNICODE_FSS NOT NULL,
    OLD_VALUE      VARCHAR(255) CHARACTER SET UNICODE_FSS,
    NEW_VALUE      VARCHAR(255) CHARACTER SET UNICODE_FSS
);

CREATE TABLE IBE$LOG_KEYS (
    LOG_TABLES_ID  NUMERIC(18,0) NOT NULL,
    KEY_FIELD      VARCHAR(67) CHARACTER SET UNICODE_FSS NOT NULL,
    KEY_VALUE      VARCHAR(255) CHARACTER SET UNICODE_FSS
);

CREATE TABLE IBE$LOG_TABLES (
    ID          NUMERIC(18,0) NOT NULL,
    TABLE_NAME  VARCHAR(67) CHARACTER SET UNICODE_FSS NOT NULL,
    OPERATION   VARCHAR(1) NOT NULL,
    DATE_TIME   TIMESTAMP NOT NULL,
    USER_NAME   VARCHAR(67) NOT NULL
);

CREATE TABLE IBE$SCRIPTS (
    IBE$SCRIPT_NAME           VARCHAR(64) CHARACTER SET UNICODE_FSS NOT NULL,
    IBE$SCRIPT_TYPE           VARCHAR(15) CHARACTER SET UNICODE_FSS NOT NULL,
    IBE$SCRIPT_SOURCE         BLOB SUB_TYPE 1 SEGMENT SIZE 1024,
    IBE$SCRIPT_BLR            BLOB SUB_TYPE 0 SEGMENT SIZE 1024,
    IBE$SCRIPT_DESCRIPTION    BLOB SUB_TYPE 1 SEGMENT SIZE 1024,
    IBE$SCRIPT_STATE          VARCHAR(15) CHARACTER SET UNICODE_FSS DEFAULT 'INVALID' NOT NULL,
    IBE$SCRIPT_ACTION_ID      INTEGER,
    IBE$SCRIPT_FORM           BLOB SUB_TYPE 0 SEGMENT SIZE 1024,
    IBE$SCRIPT_PARAM_HISTORY  BLOB SUB_TYPE 0 SEGMENT SIZE 1024,
    IBE$SCRIPT_ADD_DATA       BLOB SUB_TYPE 1 SEGMENT SIZE 1024
);

CREATE TABLE KADRY (
    TABNO        INTEGER NOT NULL,
    FIO          VARCHAR(51),
    NAL_CODE     CHAR(10),
    SHIFR_POD    INTEGER,
    PIB          VARCHAR(60),
    DATA_PRI     DATE,
    DATA_UW      DATE,
    DATA_BIRTH   DATE,
    STAG_DO_Y    SMALLINT,
    STAG_DO_M    SMALLINT,
    K_WO_MIN     SMALLINT,
    OKLAD        DECIMAL(12,2),
    STAWKA       DECIMAL(12,2),
    PASP_SER     VARCHAR(8),
    PASP_N       VARCHAR(10),
    PASP_DATA    DATE,
    PASP_VYD     VARCHAR(80),
    K_WO_ST      DECIMAL(12,4),
    SHIFR_DOL    SMALLINT,
    SHIFR_RAJ    SMALLINT,
    SHIFR_U_S    SMALLINT,
    SHIFR_U_Z    SMALLINT,
    WID_RAB      SMALLINT,
    SHIFR_KAT    SMALLINT,
    SHIFR_GRU    SMALLINT,
    SHIFR_POL    SMALLINT,
    PROF         SMALLINT,
    DOLGNOST     VARCHAR(20),
    ADRES        VARCHAR(80),
    MESTO_R      VARCHAR(80),
    COMMENT      VARCHAR(50),
    SHIFRWRK     SMALLINT,
    DATEWRK      TDATEWRK,
    SWID_SS_SER  VARCHAR(6),
    SWID_SS_NOM  VARCHAR(10),
    ISPENSIONER  TSMALLCODE,
    BANK_COUNT   TVARCHAR30,
    CODE_UWOL    TSMALLCODE,
    DESCR_UWOL   VARCHAR(256)
);

CREATE TABLE KATEG (
    SHIFR      INTEGER NOT NULL,
    NAME       VARCHAR(40),
    SHORTNAME  TVARCHAR15
);

CREATE TABLE OPERATORY (
    SHIFRWRK     INTEGER NOT NULL,
    LOGIN        VARCHAR(20),
    PSSWD        VARCHAR(20),
    SHIFRPRA     INTEGER,
    FIOOP        VARCHAR(50),
    NAMEOP       VARCHAR(31),
    SECRETRIGHT  TSMALLCODE,
    NOMEROP      TSMALLCODE
);

CREATE TABLE OTP_ADD (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDOTP     TBIGCODE,
    SHIFRIDOTPSUM  TBIGCODE,
    W_PLACE        TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    DAYS           TSMALLCODE,
    FOND           TSMALLCODE,
    VYPL           TSMALLCODE,
    SEL            TSMALLCODE,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK,
    ID_CLAR        INTEGER,
    TABNO          INTEGER,
    W_R            SMALLINT
);

CREATE TABLE OTP_KOE (
    DATEB     DATE NOT NULL,
    DATEZA    DATE NOT NULL,
    KOEF      DECIMAL(10,4),
    SHIFRKAT  INTEGER,
    SHIFRWRK  INTEGER,
    DATEWRK   TDATEWRK
);

CREATE TABLE OTP_RES (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDOTP     TBIGCODE NOT NULL,
    SHIFRSTA       TSMALLCODE NOT NULL,
    O_DAY          TSMALLCODE,
    MONTH_ZA       TMONTH NOT NULL,
    YEAR_ZA        TYEAR NOT NULL,
    SUMMA_O_BUD    TSUMMAPERSON,
    SUMMA_O_VNE    TSUMMAPERSON,
    SUMMA_O_GN     TSUMMAPERSON,
    SUMMA_O_NIS    TSUMMAPERSON,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK,
    NEED_PERE_BUD  TSMALLCODE,
    NEED_PERE_VNE  TSMALLCODE,
    NEED_PERE_GN   TSMALLCODE,
    NEED_PERE_NIS  TSMALLCODE,
    DATA_PERE_BUD  TDATE,
    DATA_PERE_VNE  TDATE,
    DATA_PERE_GN   TDATE,
    DATA_PERE_NIS  TDATE
);

CREATE TABLE OTP_SUMMY (
    SHIFRID          TBIGCODE NOT NULL,
    SHIFRIDOTP       TBIGCODE NOT NULL,
    SEL              TSMALLCODE NOT NULL,
    MONTH_ZA         TMONTH NOT NULL,
    YEAR_ZA          TYEAR NOT NULL,
    SUMMA_BUD        TSUMMAPERSON,
    SUMMA_VNE        TSUMMAPERSON,
    SUMMA_GN         TSUMMAPERSON,
    SUMMA_NIS        TSUMMAPERSON,
    OKLAD_M          TSUMMAPERSON,
    DAY_WORK         TSMALLCODE,
    KOEF             TMEANDAYSUMMA,
    DAY_KALEND       TSMALLCODE,
    SHIFRWRK         TSMALLCODE,
    DATEWRK          TDATEWRK,
    MANUAL_CALC      TSMALLCODE,
    DAY_KALEND_WORK  TSMALLCODE
);

CREATE TABLE OTPUSKA (
    SHIFRID          TBIGCODE NOT NULL,
    TABNO            TSMALLCODE NOT NULL,
    FIO              VARCHAR(50),
    W_PLACE          TSMALLCODE NOT NULL,
    SHIFRKAT         TSMALLCODE NOT NULL,
    SHIFRGRU         TSMALLCODE NOT NULL,
    F_DATA           TDATE,
    F_DAY            TSMALLCODE,
    F_MONTH          TMONTH,
    F_YEAR           TYEAR,
    L_DATA           TDATE,
    L_DAY            TSMALLCODE,
    L_MONTH          TMONTH,
    L_YEAR           TYEAR,
    DATA_VY          TDATE NOT NULL,
    MONTH_VY         TMONTH NOT NULL,
    YEAR_VY          TYEAR NOT NULL,
    OKLAD            TSUMMAPERSON,
    ITOGO_O_DAY      TSMALLCODE,
    SHIFRSTA         TSMALLCODE NOT NULL,
    DOLG             VARCHAR(30),
    MEAN_DAY_BUD     TMEANDAYSUMMA,
    MEAN_DAY_VNE     TMEANDAYSUMMA,
    MEAN_DAY_GN      TMEANDAYSUMMA,
    MEAN_DAY_NIS     TMEANDAYSUMMA,
    ITOGO_BUD        TSUMMAPERSON,
    ITOGO_VNE        TSUMMAPERSON,
    ITOGO_GN         TSUMMAPERSON,
    ITOGO_NIS        TSUMMAPERSON,
    ITOGO            TSUMMAPERSON,
    ITOGO_DAY        TSMALLCODE,
    ITOGO_O_BUD      TSUMMAPERSON,
    ITOGO_O_VNE      TSUMMAPERSON,
    ITOGO_O_GN       TSUMMAPERSON,
    ITOGO_O_NIS      TSUMMAPERSON,
    ITOGO_O          TSUMMAPERSON,
    MARK             TSMALLCODE,
    DATA_PERE        TIMESTAMP,
    SHIFRWRK         TSMALLCODE,
    DATEWRK          TDATEWRK,
    ID_CLAR          INTEGER,
    RAZRIJAD         SMALLINT,
    MODE             TSMALLCODE,
    MARKED           TSMALLCODE,
    MODE_DAY_CLOCK   TSMALLCODE DEFAULT 0,
    DATA_PERE_BUD    TDATE,
    DATA_PERE_VNE    TDATE,
    DATA_PERE_GN     TDATE,
    DATA_PERE_NIS    TDATE,
    KIND_OTP         TSMALLCODE DEFAULT 0,
    NOMER_PRI        TVARCHAR15,
    DATA_PRI         TDATE,
    PERIOD_PRI       TVARCHAR30,
    MODE_25_07_2016  TSMALLCODE DEFAULT 0
);

CREATE TABLE P04T05B (
    ROWNUM    DOUBLE PRECISION,
    NUMIDENT  VARCHAR(11),
    START_DT  DOUBLE PRECISION,
    END_DT    DOUBLE PRECISION,
    "LN"      VARCHAR(101),
    NM        VARCHAR(101),
    FTN       VARCHAR(101)
);

CREATE TABLE P04T06B (
    ROWNUM     DOUBLE PRECISION,
    NUMIDENT   VARCHAR(11),
    ZO         DOUBLE PRECISION,
    ZIC        DOUBLE PRECISION,
    SUM_TOTAL  DOUBLE PRECISION,
    SUM_INS    DOUBLE PRECISION,
    OTK        DOUBLE PRECISION,
    EXP        DOUBLE PRECISION,
    SUM_MAX    DOUBLE PRECISION,
    "LN"       VARCHAR(251),
    NM         VARCHAR(251),
    FTN        VARCHAR(251)
);

CREATE TABLE P04T07B (
    ROWNUM     DOUBLE PRECISION,
    NUMIDENT   VARCHAR(11),
    ZO         DOUBLE PRECISION,
    ZIC        DOUBLE PRECISION,
    SUM_TOTAL  DOUBLE PRECISION,
    SUM_INS    DOUBLE PRECISION,
    OTK        DOUBLE PRECISION,
    EXP        DOUBLE PRECISION,
    SUM_MAX    DOUBLE PRECISION,
    "LN"       VARCHAR(251),
    PAY_TP     DOUBLE PRECISION,
    PAY_MNTH   DOUBLE PRECISION,
    PAY_YEAR   DOUBLE PRECISION,
    NM         VARCHAR(251),
    FTN        VARCHAR(251)
);

CREATE TABLE P04T08B (
    ROWNUM    DOUBLE PRECISION,
    NUMIDENT  VARCHAR(11),
    C_PID     VARCHAR(9),
    START_DT  DOUBLE PRECISION,
    STOP_DT   DOUBLE PRECISION,
    SEASON    VARCHAR(6),
    "LN"      VARCHAR(251),
    NORMA     VARCHAR(7),
    DAYS      DOUBLE PRECISION,
    NORMZ     DOUBLE PRECISION,
    HH        DOUBLE PRECISION,
    MM        DOUBLE PRECISION,
    NM        VARCHAR(251),
    FTN       VARCHAR(251)
);

CREATE TABLE PE (
    T    INTEGER,
    FIO  VARCHAR(51),
    TIN  CHAR(10),
    S    NUMERIC(15,2)
);

CREATE TABLE PENSHEA (
    DATEFR     DATE,
    LIMITPENS  DECIMAL(15,2),
    ID         SMALLINT NOT NULL
);

CREATE TABLE PENSPR (
    IDPENS    INTEGER NOT NULL,
    SUMMAADD  DECIMAL(15,2),
    SUMMAFR   DECIMAL(15,2),
    SUMMATO   DECIMAL(15,2),
    PROCPENS  DECIMAL(15,3)
);

CREATE TABLE PERSON (
    SHIFRID     INTEGER NOT NULL,
    TABNO       INTEGER,
    FIO         VARCHAR(50),
    DOLG        VARCHAR(50),
    MONTHVY     SMALLINT,
    YEARVY      SMALLINT,
    W_R         SMALLINT,
    SHIFRGRU    SMALLINT,
    SHIFRKAT    SMALLINT,
    M_O_R       INTEGER,
    N_TEMY      CHAR(10),
    WID_OPLATY  SMALLINT,
    MODE        SMALLINT,
    FROMPODR    SMALLINT,
    PODOH       INTEGER,
    MALO        INTEGER,
    PROF        SMALLINT,
    MAIN        SMALLINT,
    STATE       SMALLINT,
    AUTOMATIC   INTEGER,
    START_DAY   INTEGER,
    PENS        INTEGER,
    BANK        INTEGER,
    NAL_CODE    CHAR(10),
    OKLAD       NUMERIC(15,2),
    W_PLACE     SMALLINT,
    SHIFRWRK    SMALLINT,
    DATEWRK     TDATEWRK,
    RAZRJAD     SMALLINT
);

CREATE TABLE PERSON_97 (
    TABNO  INTEGER,
    FIO    VARCHAR(120),
    MODE   SMALLINT
);

CREATE TABLE PODOHTBL (
    DATEFR       DATE NOT NULL,
    SUMMALGOTY   DECIMAL(15,2) NOT NULL,
    LIMITLGOTY   DECIMAL(15,2) NOT NULL,
    PROC         DECIMAL(15,2) NOT NULL,
    LIMITFORSEC  TSUMMAPERSON,
    ADDPODOH     TSUMMAPERSON,
    PROCADD      TSUMMAPERSON
);

CREATE TABLE PODR (
    SHIFRPOD    INTEGER NOT NULL,
    NAME        VARCHAR(100),
    SHIFRWRK    TSMALLCODE,
    DATEWRK     TDATEWRK,
    MO_BUD      INTEGER,
    MO_VNE      INTEGER,
    MO_KOL_BUD  INTEGER,
    MO_KOL_VNE  INTEGER,
    MO_GN       INTEGER,
    MO_NIS      INTEGER,
    MO_MAG_BUD  INTEGER,
    MO_MAG_VNE  INTEGER,
    MO_MP       INTEGER,
    MO_ISKRA    TSMALLCODE,
    NAME_S      VARCHAR(100),
    NAME_K      VARCHAR(150),
    CANBEEMPTY  SMALLINT
);

CREATE TABLE PODR_SV (
    SHIFRPOD    INTEGER,
    NAME        VARCHAR(100),
    SHIFRWRK    SMALLINT,
    DATEWRK     TIMESTAMP,
    MO_BUD      INTEGER,
    MO_VNE      INTEGER,
    MO_KOL_BUD  INTEGER,
    MO_KOL_VNE  INTEGER,
    MO_GN       INTEGER,
    MO_NIS      INTEGER,
    MO_MAG_BUD  INTEGER,
    MO_MAG_VNE  INTEGER,
    MO_MP       INTEGER,
    MO_ISKRA    SMALLINT,
    NAME_S      VARCHAR(100),
    NAME_K      VARCHAR(150),
    CANBEEMPTY  SMALLINT,
    DATEFR      DATE
);

CREATE TABLE PPS_2006_O (
    TABNO       INTEGER,
    FIO         VARCHAR(255),
    ZVAN        VARCHAR(20),
    STEP        VARCHAR(20),
    POCHET      VARCHAR(80),
    DOLG        VARCHAR(255),
    SHIFRPOD    INTEGER,
    KAFEDRA     VARCHAR(255),
    STAWKABUD   DECIMAL(15,2),
    STAWKAK     DECIMAL(15,2),
    OKLAD       DECIMAL(15,2),
    POVYSH      DECIMAL(15,2),
    DOPLPOCH    DECIMAL(15,2),
    PZ          DECIMAL(15,2),
    DZ          DECIMAL(15,2),
    PS          DECIMAL(15,2),
    DS          DECIMAL(15,2),
    STAG1       DECIMAL(15,2),
    PS_ST       DECIMAL(15,2),
    NAD_ST      DECIMAL(15,2),
    NAD_ST_B    DECIMAL(15,2),
    NAD_ST_K    DECIMAL(15,2),
    STD         VARCHAR(255),
    STD_DOLG    VARCHAR(255),
    PC_ZASL     DECIMAL(15,2),
    D_ZASL      DECIMAL(15,2),
    D_ZAW_KAF   DECIMAL(15,2),
    ITOGO       DECIMAL(15,2),
    DATA_KONTR  DATE
);

CREATE TABLE PRAZDNIKI (
    MODE      INTEGER NOT NULL,
    DATEPRZ   TDATE,
    SHIFRWRK  INTEGER,
    DATEWRK   TDATEWRK,
    SHIFRID   TBIGCODE NOT NULL
);

CREATE TABLE RAZR (
    SHIFR   INTEGER NOT NULL,
    STAWKA  NUMERIC(9,2) NOT NULL,
    DATEFR  DATE NOT NULL
);

CREATE TABLE RCLC01 (
    TABNO       INTEGER,
    FIO         CHAR(30),
    W_PLACE     INTEGER,
    SHIFRGRU    INTEGER,
    SHIFRKAT    INTEGER,
    DOLG        CHAR(25),
    OKLAD       DECIMAL(15,2),
    KOEF        NUMERIC(15,2),
    RAZR        INTEGER,
    NADB        DECIMAL(15,2),
    SUMMA_NADB  DECIMAL(15,2),
    SUMMA_OKL   DECIMAL(15,2),
    WORK_DAY    INTEGER,
    KALEND_DAY  INTEGER,
    ILL_DAY     INTEGER,
    OTP_DAY     INTEGER,
    OKLAD_NEW   DECIMAL(15,2),
    DOPL_OKD    DECIMAL(15,2),
    DOPL_21     DECIMAL(15,2),
    DOPL_21_N   DECIMAL(15,2)
);

CREATE TABLE RCLC0108 (
    TABNO           INTEGER,
    FIO             CHAR(30),
    W_PLACE         INTEGER,
    SHIFRGRU        INTEGER,
    SHIFRKAT        INTEGER,
    DOLG            CHAR(25),
    WORK_DAY        INTEGER,
    KALEND_DAY      INTEGER,
    ILL_DAY         INTEGER,
    OTP_DAY         INTEGER,
    KOEF            NUMERIC(15,2),
    RAZR            INTEGER,
    W_R             INTEGER,
    CN_OSN          INTEGER,
    OLD_OKLAD       DECIMAL(15,2),
    NEW_OKLAD       DECIMAL(15,2),
    OLD_VYPL_OKLAD  DECIMAL(15,2),
    NEW_VYPL_OKLAD  DECIMAL(15,2),
    DOPL_OKLAD      DECIMAL(15,2),
    NADB_ZW_PR      DECIMAL(15,2),
    DOPL_ZW         DECIMAL(15,2),
    NADB_ST_PR      DECIMAL(15,2),
    DOPL_ST         DECIMAL(15,2),
    NADB_VYSL       DECIMAL(15,2),
    DOPL_VYSL       DECIMAL(15,2),
    POVYSH          DECIMAL(15,2),
    DOPL_P_VYSL     DECIMAL(15,2),
    DOPL_P_ST       DECIMAL(15,2),
    DOPL_P_ZW       DECIMAL(15,2),
    ISKOMP_N_O      TSMALLCODE,
    NADB_ZS_PR      TSUMMAPERSON,
    DOPL_ZS         TSUMMAPERSON,
    DOPL_P_ZS       TSUMMAPERSON,
    MOVED           TSMALLCODE,
    SHIFRID         TBIGCODE,
    Y               SMALLINT,
    M               SMALLINT
);

CREATE TABLE RCLC0110 (
    TABNO           INTEGER,
    FIO             CHAR(30),
    W_PLACE         INTEGER,
    SHIFRGRU        INTEGER,
    SHIFRKAT        INTEGER,
    DOLG            CHAR(25),
    WORK_DAY        INTEGER,
    KALEND_DAY      INTEGER,
    ILL_DAY         INTEGER,
    OTP_DAY         INTEGER,
    KOEF            NUMERIC(15,2),
    RAZR            INTEGER,
    W_R             INTEGER,
    CN_OSN          INTEGER,
    OLD_OKLAD       DECIMAL(15,2),
    NEW_OKLAD       DECIMAL(15,2),
    OLD_VYPL_OKLAD  DECIMAL(15,2),
    NEW_VYPL_OKLAD  DECIMAL(15,2),
    DOPL_OKLAD      DECIMAL(15,2),
    NADB_ZW_PR      DECIMAL(15,2),
    DOPL_ZW         DECIMAL(15,2),
    NADB_ST_PR      DECIMAL(15,2),
    DOPL_ST         DECIMAL(15,2),
    NADB_VYSL       DECIMAL(15,2),
    DOPL_VYSL       DECIMAL(15,2),
    POVYSH          DECIMAL(15,2),
    DOPL_P_VYSL     DECIMAL(15,2),
    DOPL_P_ST       DECIMAL(15,2),
    DOPL_P_ZW       DECIMAL(15,2),
    ISKOMP_N_O      TSMALLCODE,
    NADB_ZS_PR      TSUMMAPERSON,
    DOPL_ZS         TSUMMAPERSON,
    DOPL_P_ZS       TSUMMAPERSON,
    MOVED           TSMALLCODE,
    SHIFRID         TBIGCODE NOT NULL,
    Y               SMALLINT,
    M               SMALLINT,
    SHIFRDOL        TSMALLCODE
);

CREATE TABLE RCLC02 (
    TABNO       INTEGER,
    FIO         CHAR(30),
    W_PLACE     INTEGER,
    SHIFRGRU    INTEGER,
    SHIFRKAT    INTEGER,
    DOLG        CHAR(25),
    OKLAD       DECIMAL(15,2),
    KOEF        NUMERIC(15,2),
    RAZR        INTEGER,
    NADB        DECIMAL(15,2),
    SUMMA_NADB  DECIMAL(15,2),
    SUMMA_OKL   DECIMAL(15,2),
    WORK_DAY    INTEGER,
    KALEND_DAY  INTEGER,
    ILL_DAY     INTEGER,
    OTP_DAY     INTEGER,
    OKLAD_NEW   DECIMAL(15,2),
    DOPL_OKD    DECIMAL(15,2),
    DOPL_21     DECIMAL(15,2),
    DOPL_21_N   DECIMAL(15,2)
);

CREATE TABLE RCLC0208 (
    TABNO           INTEGER,
    FIO             CHAR(30),
    W_PLACE         INTEGER,
    SHIFRGRU        INTEGER,
    SHIFRKAT        INTEGER,
    DOLG            CHAR(25),
    WORK_DAY        INTEGER,
    KALEND_DAY      INTEGER,
    ILL_DAY         INTEGER,
    OTP_DAY         INTEGER,
    KOEF            NUMERIC(15,2),
    RAZR            INTEGER,
    W_R             INTEGER,
    CN_OSN          INTEGER,
    OLD_OKLAD       DECIMAL(15,2),
    NEW_OKLAD       DECIMAL(15,2),
    OLD_VYPL_OKLAD  DECIMAL(15,2),
    NEW_VYPL_OKLAD  DECIMAL(15,2),
    DOPL_OKLAD      DECIMAL(15,2),
    NADB_ZW_PR      DECIMAL(15,2),
    DOPL_ZW         DECIMAL(15,2),
    NADB_ST_PR      DECIMAL(15,2),
    DOPL_ST         DECIMAL(15,2),
    NADB_VYSL       DECIMAL(15,2),
    DOPL_VYSL       DECIMAL(15,2),
    POVYSH          DECIMAL(15,2),
    DOPL_P_VYSL     DECIMAL(15,2),
    DOPL_P_ST       DECIMAL(15,2),
    DOPL_P_ZW       DECIMAL(15,2),
    ISKOMP_N_O      TSMALLCODE,
    NADB_ZS_PR      TSUMMAPERSON,
    DOPL_ZS         TSUMMAPERSON,
    DOPL_P_ZS       TSUMMAPERSON,
    MOVED           TSMALLCODE,
    SHIFRID         TBIGCODE
);

CREATE TABLE RCLC0308 (
    TABNO           INTEGER,
    FIO             CHAR(30),
    W_PLACE         INTEGER,
    SHIFRGRU        INTEGER,
    SHIFRKAT        INTEGER,
    DOLG            CHAR(25),
    WORK_DAY        INTEGER,
    KALEND_DAY      INTEGER,
    ILL_DAY         INTEGER,
    OTP_DAY         INTEGER,
    KOEF            NUMERIC(15,2),
    RAZR            INTEGER,
    W_R             INTEGER,
    CN_OSN          INTEGER,
    OLD_OKLAD       DECIMAL(15,2),
    NEW_OKLAD       DECIMAL(15,2),
    OLD_VYPL_OKLAD  DECIMAL(15,2),
    NEW_VYPL_OKLAD  DECIMAL(15,2),
    DOPL_OKLAD      DECIMAL(15,2),
    NADB_ZW_PR      DECIMAL(15,2),
    DOPL_ZW         DECIMAL(15,2),
    NADB_ST_PR      DECIMAL(15,2),
    DOPL_ST         DECIMAL(15,2),
    NADB_VYSL       DECIMAL(15,2),
    DOPL_VYSL       DECIMAL(15,2),
    POVYSH          DECIMAL(15,2),
    DOPL_P_VYSL     DECIMAL(15,2),
    DOPL_P_ST       DECIMAL(15,2),
    DOPL_P_ZW       DECIMAL(15,2),
    ISKOMP_N_O      TSMALLCODE,
    NADB_ZS_PR      TSUMMAPERSON,
    DOPL_ZS         TSUMMAPERSON,
    DOPL_P_ZS       TSUMMAPERSON,
    MOVED           TSMALLCODE,
    SHIFRID         TBIGCODE
);

CREATE TABLE RCLC12 (
    TABNO       INTEGER,
    FIO         CHAR(30),
    W_PLACE     INTEGER,
    SHIFRGRU    INTEGER,
    SHIFRKAT    INTEGER,
    DOLG        CHAR(25),
    OKLAD       DECIMAL(15,2),
    KOEF        NUMERIC(15,2),
    RAZR        INTEGER,
    NADB        DECIMAL(15,2),
    SUMMA_NADB  DECIMAL(15,2),
    SUMMA_OKL   DECIMAL(15,2)
);

CREATE TABLE RCLCIND0110 (
    TABNO          INTEGER,
    FIO            CHAR(30),
    W_PLACE        INTEGER,
    SHIFRGRU       INTEGER,
    SHIFRKAT       INTEGER,
    DOLG           CHAR(25),
    WORK_DAY       INTEGER,
    KALEND_DAY     INTEGER,
    ILL_DAY        INTEGER,
    OTP_DAY        INTEGER,
    KOEF           NUMERIC(15,2),
    RAZR           INTEGER,
    W_R            INTEGER,
    CN_OSN         INTEGER,
    SHIFRDOL       INTEGER,
    OLD_OKLAD      DECIMAL(15,2),
    SUMMAFORINDEX  DECIMAL(15,2),
    SUMINDVYPL     DECIMAL(15,2),
    SUMINDNEED     DECIMAL(15,2),
    DOPLIND        DECIMAL(15,2),
    MOVED          TSMALLCODE,
    SHIFRID        TBIGCODE NOT NULL,
    Y              SMALLINT,
    M              SMALLINT,
    ISDOPL         TSMALLCODE
);

CREATE TABLE RCLCP01 (
    TABNO       INTEGER,
    FIO         CHAR(30),
    W_PLACE     INTEGER,
    SHIFRGRU    INTEGER,
    SHIFRKAT    INTEGER,
    W_R         INTEGER,
    DOLG        CHAR(25),
    OKLAD       DECIMAL(15,2),
    KOEF        NUMERIC(15,2),
    RAZR        INTEGER,
    NADB        DECIMAL(15,2),
    SUMMA_NADB  DECIMAL(15,2),
    SUMMA_OKL   DECIMAL(15,2),
    WORK_DAY    INTEGER,
    KALEND_DAY  INTEGER,
    ILL_DAY     INTEGER,
    OTP_DAY     INTEGER,
    OKLAD_NEW   DECIMAL(15,2),
    DOPL_OKD    DECIMAL(15,2),
    STEP_PROC   DECIMAL(15,2),
    ZWAN_PROC   DECIMAL(15,2),
    STEP_SUMMA  DECIMAL(15,2),
    ZWAN_SUMMA  DECIMAL(15,2),
    STEP_VYPL   DECIMAL(15,2),
    ZWAN_VYPL   DECIMAL(15,2),
    STEP_DOPL   DECIMAL(15,2),
    ZWAN_DOPL   DECIMAL(15,2),
    STAG_PROC   DECIMAL(15,2),
    STAG_SUMMA  DECIMAL(15,2),
    STAG_VYPL   DECIMAL(15,2),
    STAG_DOPL   DECIMAL(15,2),
    ZASL_PROC   DECIMAL(15,2),
    ZASL_SUMMA  DECIMAL(15,2),
    ZASL_VYPL   DECIMAL(15,2),
    ZASL_DOPL   DECIMAL(15,2)
);

CREATE TABLE SHIFR (
    SHIFR           INTEGER NOT NULL,
    NAME            VARCHAR(52),
    SHORTNAME       VARCHAR(20),
    PODOH           SMALLINT,
    PENS            SMALLINT,
    SS              SMALLINT,
    FONDZ           SMALLINT,
    BOLN            SMALLINT,
    OTP             SMALLINT,
    PROF            SMALLINT,
    ALIM            SMALLINT,
    MODE            SMALLINT,
    SHIFRWRK        INTEGER,
    DATEWRK         TDATEWRK,
    IND             TSMALLCODE,
    DEKR            TSMALLCODE,
    KOMAND          TSMALLCODE,
    ECB             TSMALLCODE,
    ECB_INV         TSMALLCODE,
    ECB_ILL         TSMALLCODE,
    NAMEFORSWOD     TVARCHAR15,
    WS              TSMALLCODE,
    OTP_25_07_2016  TSMALLCODE
);

CREATE TABLE SHIFRY_IND (
    SHIFRSTA  INTEGER NOT NULL,
    NAMESTA   VARCHAR(50)
);

CREATE TABLE SSLIMITY (
    DATEFR          DATE NOT NULL,
    LIMPROC         DECIMAL(15,2),
    LIMITMAX        DECIMAL(15,2),
    PROCSSDOLIM     DECIMAL(15,3),
    PROCSSAFTERLIM  DECIMAL(10,3),
    MINSAL          TSUMMAPERSON,
    PROGMIN         TSUMMAPERSON
);

CREATE TABLE TABEL (
    SHIFRID  INTEGER,
    DAYNO    SMALLINT,
    CODE     SMALLINT
);

CREATE TABLE TB_1DF (
    SHIFRID    TBIGCODE NOT NULL,
    TABNO      TBIGCODE,
    NAL_CODE   VARCHAR(10),
    FIO        VARCHAR(100),
    W_R        TSMALLCODE,
    SUMMAADD   TSUMMAPERSON,
    SUMMAPOD   TSUMMAPERSON,
    SUMMAADD1  TSUMMAPERSON,
    SUMMAADD2  TSUMMAPERSON,
    SUMMAADD3  TSUMMAPERSON,
    SUMMAPOD1  TSUMMAPERSON,
    SUMMAPOD2  TSUMMAPERSON,
    SUMMAPOD3  TSUMMAPERSON,
    DATAPRI    TDATE,
    DATAUW     TDATE,
    CODE_PRIZ  TSMALLCODE,
    PRIZNAK    VARCHAR(6),
    OZN_PILG   TSMALLCODE,
    INVALID    TSMALLCODE,
    Y          TSMALLCODE,
    M          TSMALLCODE,
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK,
    SUMMAWS1   TSUMMAPERSON,
    SUMMAWS2   TSUMMAPERSON,
    SUMMAWS3   TSUMMAPERSON,
    SUMMAWS    TSUMMAPERSON
);

CREATE TABLE TB_1DF_ADD (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRID1DF  TBIGCODE NOT NULL,
    TABNO       TSMALLCODE,
    W_PLACE     TSMALLCODE,
    W_R         SMALLINT,
    SHIFRGRU    TSMALLCODE,
    SHIFRKAT    TSMALLCODE,
    SHIFRSTA    TSMALLCODE,
    MONTH_ZA    TMONTH,
    YEAR_ZA     TYEAR,
    MONTH_VY    TMONTH,
    YEAR_VY     TYEAR,
    SUMMA       TSUMMAPERSON,
    FOND        TSMALLCODE,
    VYPL        TSMALLCODE
);

CREATE TABLE TB_1DF_UD (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRID1DF  TBIGCODE NOT NULL,
    TABNO       SMALLINT NOT NULL,
    W_PLACE     SMALLINT,
    W_R         SMALLINT,
    SHIFRGRU    SMALLINT,
    SHIFRKAT    SMALLINT,
    SHIFRSTA    SMALLINT,
    MONTH_ZA    SMALLINT NOT NULL,
    YEAR_ZA     SMALLINT NOT NULL,
    MONTH_VY    SMALLINT,
    YEAR_VY     SMALLINT,
    SUMMA       DECIMAL(12,2),
    VYPL        SMALLINT
);

CREATE TABLE TB_APM_ANK (
    TIN      VARCHAR(10),
    FULLN_U  VARCHAR(30),
    NAME_U   VARCHAR(15),
    FATH_U   VARCHAR(20),
    D_ROG    DATE,
    POL      VARCHAR(1),
    D_TIN    DATE,
    KRPOU    VARCHAR(12),
    RNPD     DECIMAL(5,0),
    DFPV     DATE,
    KOP      VARCHAR(10),
    TOZ      VARCHAR(6),
    SHIFRID  TBIGCODE NOT NULL,
    TABNO    TBIGCODE NOT NULL
);

CREATE TABLE TB_APM_IND (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDANK   TBIGCODE NOT NULL,
    KTF          VARCHAR(1),
    TIN          VARCHAR(10),
    ZVIT_R       DECIMAL(4,0),
    ZVIT_P       VARCHAR(1),
    SPLAT_R      DECIMAL(4,0),
    KRPOU        VARCHAR(12),
    OTK          VARCHAR(1),
    KTSZ         VARCHAR(1),
    SVR          DECIMAL(10,2),
    SVZ          DECIMAL(10,2),
    SZ           DECIMAL(10,2),
    SZP          DECIMAL(10,2),
    SL           DECIMAL(10,2),
    SP           DECIMAL(10,2),
    KD           DECIMAL(3,0),
    DPR          DATE,
    DZR          DATE,
    KPM          DECIMAL(2,0),
    KPD          DECIMAL(2,0),
    RNPD         DECIMAL(5,0),
    DFPV         DATE,
    NPD          DECIMAL(5,0),
    DFD          DATE,
    KPFU         VARCHAR(8),
    NZV          VARCHAR(1),
    KOP          VARCHAR(10),
    TOZ          VARCHAR(6),
    ISPENSIONER  TSMALLCODE,
    ISINVALID    TSMALLCODE
);

CREATE TABLE TB_APM_IND_BODY (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDIND   TBIGCODE NOT NULL,
    SZ           DECIMAL(9,2),
    SZP          DECIMAL(9,2),
    SL           DECIMAL(9,2),
    SPD          DECIMAL(9,2),
    KD           DECIMAL(3,0),
    PERIOD       TSMALLCODE,
    ISPENSIONER  TSMALLCODE,
    ISINVALID    TSMALLCODE
);

CREATE TABLE TB_APM_IND_SS (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRIDIND  TBIGCODE NOT NULL,
    KPLG        VARCHAR(8),
    KMZ         DECIMAL(2,0),
    KSL         VARCHAR(1),
    SSM         DECIMAL(2,0),
    SSD         DECIMAL(2,0),
    SST         DECIMAL(3,0),
    SSG         DECIMAL(4,0),
    SSH         DECIMAL(2,0),
    SSZ         DECIMAL(3,0),
    NSL         DECIMAL(6,2),
    KSZ         VARCHAR(1)
);

CREATE TABLE TB_BANK_STA (
    SHIFRSTA     INTEGER,
    NAME         VARCHAR(100),
    SHIFRBAN     INTEGER,
    SHIFRSTABBB  INTEGER,
    NAMEBBB      VARCHAR(100),
    SHIFRBBB     INTEGER
);

CREATE TABLE TB_BANKI (
    ID        TBIGCODE NOT NULL,
    NAME      TVARCHAR50,
    BANKDIR   TVARCHAR15,
    SHIFRSTA  TSMALLCODE
);

CREATE TABLE TB_BK (
    TABNO   INTEGER NOT NULL,
    FIO     VARCHAR(100),
    IDCODE  VARCHAR(10)
);

CREATE TABLE TB_BUH_ACCESS (
    SHIFRPOD  TBIGCODE NOT NULL,
    SHIFRBUH  TBIGCODE NOT NULL
);

CREATE TABLE TB_BUH_DOP_PODR (
    SHIFRPOD  TBIGCODE NOT NULL,
    SHIFRBUH  TBIGCODE NOT NULL
);

CREATE TABLE TB_C_FADD (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          TSMALLCODE,
    W_PLACE        TSMALLCODE,
    W_R            SMALLINT,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    WDAY           DECIMAL(12,2),
    WCLOCK         DECIMAL(12,2),
    FOND           TSMALLCODE,
    VYPL           TSMALLCODE,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_C_FCN (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    MONTH_VY       SMALLINT NOT NULL,
    YEAR_VY        SMALLINT NOT NULL,
    SHIFRSTA       SMALLINT,
    KOD            SMALLINT,
    SUMMA          DECIMAL(12,2),
    PRIM           INTEGER,
    PRIM_1         VARCHAR(60),
    DEJA_COUNTED   SMALLINT,
    FLOW_SUMMA     DECIMAL(15,2),
    LIMIT_SUMMA    DECIMAL(15,2),
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK,
    AUTOMATIC      TSMALLCODE,
    ID             TBIGCODE
);

CREATE TABLE TB_C_FUD (
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    SHIFRSTA       SMALLINT,
    MONTH_ZA       SMALLINT NOT NULL,
    YEAR_ZA        SMALLINT NOT NULL,
    MONTH_VY       SMALLINT,
    YEAR_VY        SMALLINT,
    SUMMA          DECIMAL(12,2),
    VYPL           SMALLINT,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_C_PERSON (
    SHIFRID     INTEGER NOT NULL,
    TABNO       INTEGER,
    FIO         CHAR(30),
    DOLG        VARCHAR(50),
    MONTHVY     SMALLINT,
    YEARVY      SMALLINT,
    W_R         SMALLINT,
    SHIFRGRU    SMALLINT,
    SHIFRKAT    SMALLINT,
    M_O_R       INTEGER,
    N_TEMY      CHAR(10),
    WID_OPLATY  SMALLINT,
    MODE        SMALLINT,
    FROMPODR    SMALLINT,
    PODOH       INTEGER,
    MALO        INTEGER,
    PROF        SMALLINT,
    MAIN        SMALLINT,
    STATE       SMALLINT,
    AUTOMATIC   INTEGER,
    START_DAY   INTEGER,
    PENS        INTEGER,
    BANK        INTEGER,
    NAL_CODE    CHAR(10),
    OKLAD       NUMERIC(15,2),
    W_PLACE     SMALLINT,
    SHIFRWRK    SMALLINT,
    DATEWRK     TDATEWRK,
    RAZRJAD     SMALLINT
);

CREATE TABLE TB_C_TABEL (
    SHIFRID        TBIGCODE NOT NULL,
    DAYNO          SMALLINT,
    CODE           SMALLINT,
    SHIFRIDPERSON  TBIGCODE NOT NULL
);

CREATE TABLE TB_CHAIN (
    SHIFRID  TBIGCODE NOT NULL,
    TABNO    TBIGCODE,
    YEARVY   TBIGCODE,
    MONTHVY  TBIGCODE,
    W_PLACE  TBIGCODE,
    W_R      TBIGCODE
);

CREATE TABLE TB_CHANGE_RAZR_GRID (
    DATEFR  TDATE NOT NULL
);

CREATE TABLE TB_CLASSIFICATOR (
    KODKP      VARCHAR(10),
    KODZKPPTR  VARCHAR(10),
    ETKD       VARCHAR(10),
    DKHP       VARCHAR(10),
    NAME       VARCHAR(512),
    ID         INTEGER NOT NULL
);

CREATE TABLE TB_DAYS (
    YEARZA         TSMALLCODE NOT NULL,
    MONTHZA        TSMALLCODE,
    WDAYS          TSMALLCODE,
    SHIFRIDYM      TBIGCODE,
    CLOCKS         TSUMMAPERSON,
    WDAYSCOLEDG    TSMALLCODE,
    WCLOCKSCOLEDG  DECIMAL(10,2)
);

CREATE TABLE TB_DBL_FOR_INDEX (
    TABNO      TBIGCODE NOT NULL,
    FIO        VARCHAR(20),
    WPLACE     TSMALLCODE,
    SHIFRGRU   TSMALLCODE,
    KOEF       TMEANDAYSUMMA,
    DOLG       VARCHAR(10),
    WPLACE1    TSMALLCODE,
    SHIFRGRU1  TSMALLCODE,
    KOEF1      TMEANDAYSUMMA,
    DOLG1      VARCHAR(10)
);

CREATE TABLE TB_DEKR_ECB (
    ID          INTEGER NOT NULL,
    TABNO       INTEGER NOT NULL,
    INN         VARCHAR(10),
    FIO         VARCHAR(51),
    NOMER_PRIK  VARCHAR(10),
    DATA_PRIK   DATE,
    DATE_FR     DATE,
    DATE_TO     DATE,
    KIND        SMALLINT DEFAULT 4
);

CREATE TABLE TB_DISMIS (
    ID         SMALLINT,
    CODE_EIAC  VARCHAR(24),
    NAME       VARCHAR(256),
    REASON     VARCHAR(128)
);

CREATE TABLE TB_DOGOVORA_GN (
    ID        INTEGER NOT NULL,
    DATEFR    DATE,
    DATETO    DATE,
    NAME      VARCHAR(512),
    NOMER     VARCHAR(64),
    REASONOK  VARCHAR(512)
);

CREATE TABLE TB_DOGOVORA_GN_DET (
    ID        INTEGER NOT NULL,
    IDDOG     INTEGER NOT NULL,
    TABNO     INTEGER NOT NULL,
    FIO       VARCHAR(50),
    DATEFR    DATE,
    DATETO    DATE,
    NOMER     VARCHAR(10),
    GUID      VARCHAR(64),
    REASONOK  VARCHAR(512)
);

CREATE TABLE TB_DOGPOD (
    SHIFRPOD  INTEGER,
    NAMEPOD   CHAR(60)
);

CREATE TABLE TB_DOLG (
    SHIFRDOL   TBIGCODE NOT NULL,
    NAME       CHAR(50),
    RAZR       INTEGER,
    OKLAD      NUMERIC(15,2),
    NEED_STAG  SMALLINT
);

CREATE TABLE TB_DRFO (
    TIN      VARCHAR(10) NOT NULL,
    FULLN_U  VARCHAR(30),
    NAME_U   VARCHAR(30),
    FATH_U   VARCHAR(20),
    D_ROG    DATE,
    POL      CHAR(1),
    TABNO    INTEGER
);

CREATE TABLE TB_DRFO_1 (
    TIN      VARCHAR(10),
    FULLN_U  VARCHAR(30),
    NAME_U   VARCHAR(30),
    FATH_U   VARCHAR(20),
    D_ROG    DATE,
    POL      VARCHAR(1),
    D_TIN    DATE,
    KRPOU    VARCHAR(12),
    RNPD     DOUBLE PRECISION,
    DFPV     DATE,
    KOP      VARCHAR(10),
    TOZ      VARCHAR(6),
    NZV      VARCHAR(1),
    TAB      VARCHAR(7)
);

CREATE TABLE TB_DVV_REP_RECORDS (
    SHIFRID      TBIGCODE NOT NULL,
    TABNO        TSMALLCODE,
    NAL_CODE     VARCHAR(10),
    FIO          TVARCHAR30,
    DOLG         TVARCHAR15,
    ISWOMAN      TSMALLCODE,
    ISPENSIONER  TSMALLCODE,
    ISYOUNG      TSMALLCODE,
    ISSTEPEN     TSMALLCODE,
    SHIFRWR      TSMALLCODE,
    SHIFRGRU     TSMALLCODE,
    SHIFRPOD     TSMALLCODE,
    SHIFRKAT     TSMALLCODE,
    DATABIRTH    TDATE,
    AGE          TSMALLCODE,
    KOEF         TSUMMAPERSON,
    Y            TSMALLCODE,
    M            TSMALLCODE
);

CREATE TABLE TB_E04T05C (
    SHIFRID     INTEGER NOT NULL,
    YEARVY      INTEGER,
    MONTHVY     INTEGER,
    TABNO       INTEGER,
    PERIOD_M    INTEGER,
    PERIOD_Y    INTEGER,
    ROWNUM      INTEGER,
    UKR_GROMAD  INTEGER,
    NUMIDENT    VARCHAR(10),
    FIO         VARCHAR(100),
    NM          VARCHAR(100),
    FTN         VARCHAR(100),
    START_DT    SMALLINT,
    END_DT      SMALLINT,
    SHIFRWRK    TBIGCODE,
    DATEWRK     TDATEWRK,
    ZO          INTEGER,
    PID_ZV      VARCHAR(150),
    NRM_DT      TDATE,
    DOG_CPH     TSMALLCODE,
    PNR         VARCHAR(250) COLLATE WIN1251_UA,
    ZKPP        VARCHAR(5) COLLATE WIN1251_UA,
    PROF        VARCHAR(6) COLLATE WIN1251_UA,
    POS         VARCHAR(250) COLLATE WIN1251_UA,
    PID         VARCHAR(250) COLLATE WIN1251_UA,
    VZV         VARCHAR(250) COLLATE WIN1251_UA
);

CREATE TABLE TB_E04T06C (
    SHIFRID     INTEGER NOT NULL,
    YEARVY      INTEGER,
    MONTHVY     INTEGER,
    TABNO       INTEGER,
    PERIOD_M    INTEGER,
    PERIOD_Y    INTEGER,
    ROWNUM      INTEGER,
    UKR_GROMAD  INTEGER,
    ST          INTEGER,
    NUMIDENT    VARCHAR(10),
    FIO         VARCHAR(100),
    NM          VARCHAR(100),
    FTN         VARCHAR(100),
    ZO          SMALLINT,
    PAY_TP      SMALLINT,
    PAY_MNTH    SMALLINT,
    PAY_YEAR    SMALLINT,
    SUM_TOTAL   DECIMAL(15,2),
    SUM_MAX     DECIMAL(15,2),
    SUM_INS     DECIMAL(15,2),
    OTK         SMALLINT,
    EXP         SMALLINT,
    SHIFRWRK    TBIGCODE,
    DATEWRK     TDATEWRK,
    LINENO      INTEGER,
    KD_NP       INTEGER,
    KD_NZP      INTEGER,
    KD_PTV      TBIGCODE,
    NRM         TBIGCODE,
    KD_VP       TSMALLCODE,
    SUM_DIFF    TSUMMAPERSON,
    SUM_NARAH   TSUMMAPERSON,
    NRC         TSMALLCODE
);

CREATE TABLE TB_E04T07C (
    SHIFRID     INTEGER NOT NULL,
    YEARVY      INTEGER,
    MONTHVY     INTEGER,
    TABNO       INTEGER,
    PERIOD_M    INTEGER,
    PERIOD_Y    INTEGER,
    ROWNUM      INTEGER,
    UKR_GROMAD  INTEGER,
    NUMIDENT    VARCHAR(10),
    FIO         VARCHAR(100),
    NM          VARCHAR(100),
    FTN         VARCHAR(100),
    C_PID       VARCHAR(9),
    START_DT    SMALLINT,
    END_DT      SMALLINT,
    DAYS        SMALLINT,
    NORMZ       SMALLINT,
    HH          SMALLINT,
    MM          SMALLINT,
    NORMA       SMALLINT,
    SEAZON      SMALLINT,
    NUM_NAK     VARCHAR(10),
    DT_NAK      DATE,
    SHIFRWRK    TBIGCODE,
    DATEWRK     TDATEWRK
);

CREATE TABLE TB_ECB (
    DATEFR      TDATE NOT NULL,
    ECBPROC     TSUMMAPERSON,
    ECBNPROC    TSUMMAPERSON,
    ECBILLPROC  TSUMMAPERSON,
    ECBDPPROC   TSUMMAPERSON,
    ECBINVPROC  TSUMMAPERSON
);

CREATE TABLE TB_GRUPPY_GRU (
    SHIFRGRUM  INTEGER NOT NULL,
    NAME       VARCHAR(20)
);

CREATE TABLE TB_I_03_2014 (
    TN        SMALLINT,
    FIO       CHAR(30),
    BUD       DECIMAL(18,2),
    VNE       DECIMAL(18,2),
    RD        INTEGER,
    KD        SMALLINT,
    SUMMABUD  NUMERIC(15,2),
    SUMMAVNE  NUMERIC(15,2)
);

CREATE TABLE TB_I_KAT (
    PRZ  INTEGER,
    NZ   VARCHAR(15)
);

CREATE TABLE TB_I_PERSON (
    NT         INTEGER,
    FIO        VARCHAR(35),
    POL        INTEGER,
    CECH       VARCHAR(3),
    UCH        VARCHAR(2),
    INV        INTEGER,
    SOVM       INTEGER,
    KAT        INTEGER,
    RAZR       INTEGER,
    GRAFIK     INTEGER,
    KPROF      INTEGER,
    OKL        DECIMAL(15,2),
    OKLP       DECIMAL(15,2),
    PROF       DECIMAL(15,2),
    DPOST      VARCHAR(255),
    PRUV       VARCHAR(2),
    DUV        VARCHAR(255),
    DKOR       VARCHAR(255),
    SUMAV      DECIMAL(15,2),
    PRIZ       DECIMAL(15,2),
    SC         VARCHAR(2),
    SB         VARCHAR(2),
    KANY       VARCHAR(5),
    ADR        VARCHAR(30),
    ADR1       VARCHAR(30),
    ROB1       VARCHAR(30),
    ROB2       VARCHAR(30),
    ROB3       VARCHAR(30),
    PASP       VARCHAR(30),
    L          DECIMAL(15,2),
    M          DECIMAL(15,2),
    PASP1      VARCHAR(30),
    PASP2      VARCHAR(30),
    SUMN       DECIMAL(15,2),
    UV         DOUBLE PRECISION,
    PENS_P     DECIMAL(15,2),
    BOL        VARCHAR(5),
    BEZ        DECIMAL(15,2),
    SUMU       DECIMAL(15,2),
    SUMW       DECIMAL(15,2),
    CHASP      DOUBLE PRECISION,
    CHASR      DOUBLE PRECISION,
    VREM       DOUBLE PRECISION,
    PREM       DOUBLE PRECISION,
    M_POM      DOUBLE PRECISION,
    DOKLP      VARCHAR(255),
    PP         VARCHAR(5),
    ID_NAL     VARCHAR(10),
    "NO"       DOUBLE PRECISION,
    DROGD      VARCHAR(255),
    DUVOL      VARCHAR(255),
    TAR        DOUBLE PRECISION,
    DATAW      VARCHAR(255),
    SUMW1      DOUBLE PRECISION,
    DATAW1     VARCHAR(255),
    CHAS       DOUBLE PRECISION,
    I_N        DOUBLE PRECISION,
    D_ROG      VARCHAR(20),
    CHASBU     DOUBLE PRECISION,
    CHASXO     DOUBLE PRECISION,
    NOMPOD     DOUBLE PRECISION,
    NOMCHLEN   DOUBLE PRECISION,
    SUMAV73    DOUBLE PRECISION,
    LKOD       VARCHAR(5),
    NPAN       DOUBLE PRECISION,
    SUMIND     DOUBLE PRECISION,
    DENS       DOUBLE PRECISION,
    TABNO_VNU  TSMALLCODE
);

CREATE TABLE TB_I_PROF (
    KPROF           INTEGER,
    NPROF           VARCHAR(30),
    PNPROF          VARCHAR(55),
    KSTMECH         INTEGER,
    KAT             VARCHAR(2),
    SHIFR_PROF_VNU  TSMALLCODE
);

CREATE TABLE TB_IND_CALC_12_7 (
    SHIFRID       TBIGCODE NOT NULL,
    DATAZA        TDATE,
    TABNO         TBIGCODE,
    FIO           TVARCHAR50,
    SHIFRPOD      TSMALLCODE,
    DOLG          TVARCHAR50,
    YEARZA        TSMALLCODE,
    MONTHZA       TSMALLCODE,
    DATABASEIND   TDATE,
    RAZRB         TSMALLCODE,
    KOEFB         TSUMMAPERSON,
    RAZRA         TSMALLCODE,
    KOEFA         TSUMMAPERSON,
    KOEFBUD       TSUMMAPERSON DEFAULT 0,
    KOEFVNE       TSUMMAPERSON DEFAULT 0,
    PROCIND       TMEANDAYSUMMA,
    SUMMAB        TSUMMAPERSON,
    SUMMABF       TSUMMAPERSON,
    WORKDAYB      TSMALLCODE,
    KALENDDAYB    TSMALLCODE,
    SUMMAA        TSUMMAPERSON,
    SUMMAAF       TSUMMAPERSON,
    WORKDAYA      TSMALLCODE,
    KALENDDAYA    TSMALLCODE,
    SUMMAINDBF    TSUMMAPERSON,
    SUMMAUW       TSUMMAPERSON,
    SUMMAINDCALC  TSUMMAPERSON,
    SUMMAPOSTIND  TSUMMAPERSON,
    SUMMAINDBUD   TSUMMAPERSON,
    SUMMAINDVNE   TSUMMAPERSON,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK,
    NEEDIND       TSMALLCODE DEFAULT 0,
    COMMENT       TVARCHAR50,
    ISPOVRAZR     TSMALLCODE DEFAULT 0,
    MOVEDBUD      TSMALLCODE,
    MOVEDVNE      TSMALLCODE,
    SUMMAINDWDAY  TSUMMAPERSON,
    KOEFOSN       TSUMMAPERSON DEFAULT 0,
    KOEFOSNBUD    TSUMMAPERSON DEFAULT 0,
    KOEFOSNVNE    TSUMMAPERSON,
    SUMMAFIXPREV  TSUMMAPERSON DEFAULT 0,
    OKLADBYRAZRB  TSUMMAPERSON,
    OKLADBYRAZRA  TSUMMAPERSON
);

CREATE TABLE TB_INFPROC (
    DATA      TDATE NOT NULL,
    PROCINF   TSUMMAPERSON,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_IO_PODR_MONITOR (
    SHIFRPOD  TSMALLCODE NOT NULL,
    IP        TVARCHAR30 NOT NULL,
    MAC       TVARCHAR30 NOT NULL,
    DATEWRK   TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    STATE     TSMALLCODE
);

CREATE TABLE TB_IO_STATISTIC (
    SHIFRID      TBIGCODE NOT NULL,
    NSRV         TSMALLCODE,
    NMES_THIS    TSMALLCODE,
    NMES_CURR    TSMALLCODE,
    YEAR_ZA      TSMALLCODE,
    YEAR_CURR    TSMALLCODE,
    NMBOFPERSON  TSMALLCODE,
    NMBOFADD     TSMALLCODE,
    NMBOFUD      TSMALLCODE,
    NMBOFCN      TSMALLCODE,
    NMBOFSOWM    TSMALLCODE,
    OPERATION    VARCHAR(3),
    MD5          TVARCHAR50,
    SHIFRWRK     TBIGCODE,
    DATEWRK      TDATEWRK,
    "USER"       TVARCHAR50,
    FNINF        VARCHAR(256)
);

CREATE TABLE TB_K_CONTRACTPED (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDK     TBIGCODE NOT NULL,
    SHIFRUSOSN   TBIGCODE,
    SHIFRUZOSN   TBIGCODE,
    SHIFRDOLOSN  TBIGCODE,
    SHIFRPODOSN  TBIGCODE,
    DATEFR       TDATE,
    DATETO       TDATE,
    DATAPOD      TDATE,
    SHIFRWRK     TBIGCODE,
    DATEWRK      TDATEWRK
);

CREATE TABLE TB_K_DECANY (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDKADRY  TBIGCODE NOT NULL,
    SHIFRFAC      TBIGCODE,
    DATEFR        TDATE NOT NULL,
    DATETO        TDATE,
    CODEDOLG      TSMALLCODE,
    PROCZAMDEC    TSUMMAPERSON
);

CREATE TABLE TB_K_EXL_SAL (
    SHIFRID   TBIGCODE NOT NULL,
    TABNO     TBIGCODE,
    SHIFRUNI  TBIGCODE,
    COMMENT   TVARCHAR30,
    DATEFR    TDATE,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_K_FACULTETY (
    SHIFRID    INTEGER NOT NULL,
    NAME       VARCHAR(128),
    DATEWRK    DATE,
    DATECLOSE  DATE,
    NAME_S     VARCHAR(512),
    NAME_K     VARCHAR(512)
);

CREATE TABLE TB_K_K_F (
    SHIFRID   INTEGER NOT NULL,
    SHIFRKAF  INTEGER NOT NULL,
    SHIFRFAC  INTEGER NOT NULL,
    DATEFR    DATE NOT NULL,
    DATEWRK   TIMESTAMP NOT NULL
);

CREATE TABLE TB_K_KADRY (
    SHIFRID             TBIGCODE NOT NULL,
    TABNO               TBIGCODE NOT NULL,
    FIO                 TVARCHAR50,
    NAL_CODE            TVARCHAR15,
    SHIFR_POD           TSMALLCODE,
    PIB                 TVARCHAR50,
    PIB_ROD_PAD         TVARCHAR50,
    PIB_DAT_PAD         TVARCHAR50,
    DATA_PRI            TDATE,
    DATA_UW             TDATE,
    DATA_BIRTH          TDATE,
    STAG_DO_Y           TSMALLCODE,
    STAG_DO_M           TSMALLCODE,
    STAG_P_DO_Y         TSMALLCODE,
    STAG_P_DO_M         TSMALLCODE,
    DATE_STAG_P         TDATE,
    PASP_SER            VARCHAR(8),
    PASP_N              VARCHAR(10),
    PASP_DATA           DATE,
    PASP_VYD            VARCHAR(80),
    SHIFR_POL           SMALLINT,
    PROF                SMALLINT,
    ADRES               VARCHAR(80),
    MESTO_R             VARCHAR(80),
    COMMENT             VARCHAR(50),
    SHIFRWRK            SMALLINT,
    DATEWRK             TDATEWRK,
    SWID_SS_SER         VARCHAR(6),
    SWID_SS_NOM         VARCHAR(10),
    IS_PED              TSMALLCODE,
    PEDSTAGISPRIBLISIT  TSMALLCODE,
    PEDSTAGY            TSUMMAPERSON,
    VERIFIED            TSMALLCODE,
    DATEVER             TIMESTAMP
);

CREATE TABLE TB_K_KADRY_FAC (
    SHIFRID    INTEGER NOT NULL,
    TABNO      INTEGER,
    SHIFRDOL   INTEGER,
    SHIFRFAC   INTEGER,
    PROCNADB   DECIMAL(15,2),
    SUMMANADB  DECIMAL(15,2),
    DATEFR     DATE,
    DATETO     DATE,
    SHIFRWRK   INTEGER,
    DATEWRK    TIMESTAMP
);

CREATE TABLE TB_K_KADRYPR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    CODETYPE      TSMALLCODE DEFAULT 1 NOT NULL,
    SHIFRUSZ      TSMALLCODE,
    DATEFR        TDATE,
    DATETO        TDATE,
    DATEPODTV     TDATE,
    NAME          TVARCHAR50,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK
);

CREATE TABLE TB_K_KAF (
    SHIFRID      INTEGER NOT NULL,
    NAME         VARCHAR(128),
    SHIFRFAC     INTEGER,
    SHIFRKAFBUH  INTEGER
);

CREATE TABLE TB_K_ORDERREC (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDORDER  TBIGCODE NOT NULL,
    LINENO        TBIGCODE,
    SHIFRIDKADRY  TBIGCODE,
    TABNO         TBIGCODE,
    FIO           TVARCHAR50,
    BODY          VARCHAR(1024),
    SHIFRIDDOLG   TBIGCODE,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK,
    SHIFRPOD      TSMALLCODE,
    SHIFRWR       TSMALLCODE DEFAULT 1,
    KOEF          TSUMMAPERSON DEFAULT 1,
    SHIFRKAT      SMALLINT DEFAULT 1,
    PSTAG         TSUMMAPERSON DEFAULT 0,
    PROC_PSTAG    TSUMMAPERSON DEFAULT 0,
    SUMMA_P_STAG  TSUMMAPERSON DEFAULT 0
);

CREATE TABLE TB_K_ORDERRECPR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    LINENO        TSMALLCODE NOT NULL,
    SHIFRNADB     TBIGCODE NOT NULL,
    SUMMA         TSUMMAPERSON,
    SUMMA_BUD     TSUMMAPERSON,
    SUMMA_VNE     TSUMMAPERSON,
    PROCENT       TSUMMAPERSON,
    NAME          TVARCHAR50,
    PEDSTAG       TSUMMAPERSON,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK
);

CREATE TABLE TB_K_ORDERRECTEXT (
    SHIFRID            TBIGCODE NOT NULL,
    SHIFRIDOWNER       TBIGCODE NOT NULL,
    SHIFRPOD           TBIGCODE,
    LINENO             TBIGCODE,
    TABNO              TBIGCODE,
    FIO                TVARCHAR50,
    TEXT               VARCHAR(4096),
    SHIFRWRK           TBIGCODE,
    DATEWRK            TDATEWRK,
    FIXED              TSMALLCODE DEFAULT 0,
    SHIFRIDSHTRASPREC  TBIGCODE NOT NULL,
    SHIFRFAC           TSMALLCODE
);

CREATE TABLE TB_K_ORDERS (
    SHIFRID        TBIGCODE NOT NULL,
    NOMERORD       TBIGCODE NOT NULL,
    NOMERORDALPHA  TVARCHAR15 NOT NULL,
    DATEORD        TDATE,
    SHIFRIDWIDORD  TBIGCODE NOT NULL,
    NAMEORD        TVARCHAR30,
    SHIFRISP       TBIGCODE,
    NAMEISP        TVARCHAR30,
    SHIFRWRK       TBIGCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_K_PODR (
    SHIFRPOD    INTEGER NOT NULL,
    NAME        VARCHAR(100),
    SHIFRWRK    TSMALLCODE,
    DATEWRK     TDATEWRK,
    MO_BUD      INTEGER,
    MO_VNE      INTEGER,
    MO_KOL_BUD  INTEGER,
    MO_KOL_VNE  INTEGER,
    MO_GN       INTEGER,
    MO_NIS      INTEGER,
    MO_MAG_BUD  INTEGER,
    MO_MAG_VNE  INTEGER,
    MO_MP       INTEGER,
    NAME_S      VARCHAR(100),
    NAME_K      VARCHAR(150)
);

CREATE TABLE TB_K_SHTRASPPED (
    SHIFRID   TBIGCODE NOT NULL,
    SHIFRPOD  TBIGCODE,
    DATEFR    TDATE,
    DATETO    TDATE,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK,
    SHIFRFAC  TBIGCODE
);

CREATE TABLE TB_K_SHTRASPPEDREC (
    SHIFRID             TBIGCODE NOT NULL,
    SHIFRIDOWN          TBIGCODE NOT NULL,
    LINENO              TBIGCODE,
    SHIFRIDK            TBIGCODE NOT NULL,
    TABNO               TBIGCODE,
    FIO                 TVARCHAR50,
    SHIFRUS             TBIGCODE,
    PROCNUS             TSUMMAPERSON DEFAULT 0,
    SUMMANUSB           TSUMMAPERSON DEFAULT 0,
    SUMMANUSV           TSUMMAPERSON DEFAULT 0,
    SHIFRUZ             TBIGCODE,
    PROCNUZ             TSUMMAPERSON DEFAULT 0,
    SUMMANUZB           TSUMMAPERSON DEFAULT 0,
    SUMMANUZV           TSUMMAPERSON DEFAULT 0,
    SHIFRDOL            TBIGCODE,
    KOEFBUD             TMEANDAYSUMMA,
    OKLADB              TSUMMAPERSON DEFAULT 0,
    KOEFVNE             TMEANDAYSUMMA,
    OKLADV              TSUMMAPERSON,
    SHIFRPODOSN         TBIGCODE,
    SHIFRDOLOSN         TSMALLCODE,
    SHIFRWR             TSMALLCODE,
    SHIFRWRK            TBIGCODE,
    DATEWRK             TDATEWRK,
    DATEFR              TDATE,
    DATETO              TDATE,
    STAGPY              TSMALLCODE DEFAULT 0,
    STAGPM              TSMALLCODE DEFAULT 0,
    STAGP               TSUMMAPERSON DEFAULT 0,
    PROCNPSTAG          TSUMMAPERSON DEFAULT 0,
    SUMMANPSTAGB        TSUMMAPERSON DEFAULT 0,
    SUMMANPSTAGV        TSUMMAPERSON DEFAULT 0,
    SHIFRZASL           TSMALLCODE DEFAULT 0,
    PROCNZASL           TSUMMAPERSON DEFAULT 0,
    SUMMANZASLB         TSUMMAPERSON DEFAULT 0,
    SUMMANZASLV         TSUMMAPERSON DEFAULT 0,
    RAZR                TSMALLCODE,
    OKLADRAZR           TSUMMAPERSON DEFAULT 0,
    PRIORITY            TSMALLCODE,
    SUMMAPOV            TSUMMAPERSON DEFAULT 0,
    SUMMAPOVBUD         TSUMMAPERSON DEFAULT 0,
    SUMMAPOVVNE         TSUMMAPERSON,
    SUMMAPOVFULL        TSUMMAPERSON DEFAULT 0,
    ISZAWKAF            TSMALLCODE DEFAULT 0,
    ISDEKAN             TSMALLCODE DEFAULT 0,
    ISZAMDEKANA         TSMALLCODE DEFAULT 0,
    ISDOCONOTHERSTAWKA  TSMALLCODE,
    PROCNADBZAWKAF      TSUMMAPERSON DEFAULT 0,
    SUMMANADBZAWKAF     TSUMMAPERSON DEFAULT 0,
    SUMMANADBZAWKAFBUD  TSUMMAPERSON DEFAULT 0,
    SUMMANADBZAWKAFVNE  TSUMMAPERSON DEFAULT 0,
    FIXED               TSMALLCODE,
    NOTPRINT            TSMALLCODE DEFAULT 0,
    PROCZAMDEC          TSUMMAPERSON,
    SUMMAZAMDECBUD      TSUMMAPERSON,
    SUMMAZAMDECVNE      TSUMMAPERSON,
    SUMMAZAMDECTOT      TSUMMAPERSON
);

CREATE TABLE TB_K_UCH_ST_SPR (
    SHIFRID        TSMALLCODE NOT NULL,
    NAME           TVARCHAR50,
    SHORTNAME      TVARCHAR30,
    SHIFRWIDUCHST  TSMALLCODE,
    SHIFRWRK       TBIGCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_K_USZ (
    SHIFRID   TBIGCODE NOT NULL,
    NAMEFULL  TVARCHAR30,
    NAMESOKR  TVARCHAR15,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_K_WIDNADB (
    SHIFRID   TBIGCODE NOT NULL,
    NAME      TVARCHAR50,
    SOKRNAME  TVARCHAR30,
    DATEFR    TDATE,
    DATETO    TDATE,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK,
    PRIORITY  TSMALLCODE DEFAULT 0
);

CREATE TABLE TB_K_WIDNADBSTW (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE,
    DATEFR        TDATE NOT NULL,
    SUMMA         TSUMMAPERSON,
    KIND          TSMALLCODE DEFAULT 0,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK
);

CREATE TABLE TB_K_WIDORDERS (
    SHIFRID   TBIGCODE NOT NULL,
    NAME      TVARCHAR30,
    SHIFRWRK  TBIGCODE NOT NULL,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_K_WIDUCHST (
    SHIFRID  TSMALLCODE NOT NULL,
    NAME     TVARCHAR30
);

CREATE TABLE TB_K_WIDYZASL (
    SHIFRID    TBIGCODE NOT NULL,
    NAME       TVARCHAR50,
    SHORTNAME  TVARCHAR30,
    SHIFRNADB  TBIGCODE,
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_K_ZAJAWLPEDSOWM (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDK      TBIGCODE NOT NULL,
    SHIFRUSOSN    TBIGCODE,
    SHIFRUZOSN    TBIGCODE,
    SHIFRDOLOSN   TBIGCODE,
    SHIFRPODOSN   TBIGCODE,
    SHIFRUSSOWM   TBIGCODE,
    SHIFRUZSOWM   TBIGCODE,
    SHIFRDOLSOWM  TBIGCODE,
    SHIFRPODSOWM  TBIGCODE,
    KOEF          TSUMMAPERSON,
    DATEFR        TDATE,
    DATETO        TDATE,
    DATAPOD       TDATE,
    SHIFRWRK      TBIGCODE,
    DATEWRK       TDATEWRK
);

CREATE TABLE TB_KADRY_87 (
    SHIFRID        TBIGCODE NOT NULL,
    TABNO          TBIGCODE,
    NALCODE        DECIMAL(10,0),
    FIO            VARCHAR(50),
    SHIFRPOD       TBIGCODE,
    M_O_R          TBIGCODE,
    MODE           TBIGCODE,
    DATA_PRI       TDATE,
    DATA_UW        TDATE,
    B97            TSMALLCODE,
    B98            TSMALLCODE,
    B99            TSMALLCODE,
    B00            TSMALLCODE,
    B01            TSMALLCODE,
    B02            TSMALLCODE,
    B03            TSMALLCODE,
    B04            TSMALLCODE,
    NOTCOUNT       TSMALLCODE,
    KASSABANKMODE  TSMALLCODE,
    UWOLEN         TSMALLCODE,
    ISPENS         TSMALLCODE,
    ZAJAWVYD       TSMALLCODE,
    INVALID        TSMALLCODE,
    NACH97         TSUMMAPERSON,
    NACH98         TSUMMAPERSON,
    NACH99         TSUMMAPERSON,
    NACH00         TSUMMAPERSON,
    NACH01         TSUMMAPERSON,
    NACH02         TSUMMAPERSON,
    NACH03         TSUMMAPERSON,
    NACH04         TSUMMAPERSON,
    VYPL97         TSUMMAPERSON,
    VYPL98         TSUMMAPERSON,
    VYPL99         TSUMMAPERSON,
    VYPL00         TSUMMAPERSON,
    VYPL01         TSUMMAPERSON,
    VYPL02         TSUMMAPERSON,
    VYPL03         TSUMMAPERSON,
    VYPL04         TSUMMAPERSON,
    VYSL97         TSUMMAPERSON,
    VYSL98         TSUMMAPERSON,
    VYSL99         TSUMMAPERSON,
    VYSL00         TSUMMAPERSON,
    VYSL01         TSUMMAPERSON,
    VYSL02         TSUMMAPERSON,
    VYSL03         TSUMMAPERSON,
    VYSL04         TSUMMAPERSON,
    OZD97          TSUMMAPERSON,
    OZD98          TSUMMAPERSON,
    OZD99          TSUMMAPERSON,
    OZD00          TSUMMAPERSON,
    OZD01          TSUMMAPERSON,
    OZD02          TSUMMAPERSON,
    OZD03          TSUMMAPERSON,
    OZD04          TSUMMAPERSON,
    SUMMAPODR      TSUMMAPERSON,
    SUMMAPODF      TSUMMAPERSON,
    SUMMAPENSR     TSUMMAPERSON,
    SUMMAPENSF     TSUMMAPERSON
);

CREATE TABLE TB_KINDSOTP (
    SHIFRKIND  SMALLINT NOT NULL,
    NAME       VARCHAR(50)
);

CREATE TABLE TB_KOEF_IND_DATA (
    Y     TSMALLCODE,
    M     TSMALLCODE,
    KOEF  TMEANDAYSUMMA
);

CREATE TABLE TB_KOMAND (
    SHIFRID          INTEGER NOT NULL,
    TABNO            TBIGCODE NOT NULL,
    NAL_CODE         CHAR(10),
    NOMER_B          CHAR(10),
    FIO              CHAR(51) NOT NULL,
    W_PLACE          TSMALLCODE,
    SHIFRKAT         TSMALLCODE,
    SHIFRGRU         TSMALLCODE,
    F_DATA           TDATE,
    F_MONTH          TMONTH,
    F_YEAR           TYEAR,
    L_DATA           TDATE,
    L_MONTH          TMONTH,
    L_YEAR           TYEAR,
    WID_RAB          TSMALLCODE,
    DATA_VY          TDATE,
    MONTH_VY         TMONTH NOT NULL,
    YEAR_VY          TYEAR NOT NULL,
    OKLAD            TSUMMAPERSON,
    K_WO_DAY         TSMALLCODE,
    PROCENT          TSUMMAPERSON,
    KAT_KOE          TSMALLCODE,
    SHIFR_STA        TSMALLCODE,
    MEAN_DAY         TMEANDAYSUMMA,
    MEAN_DAY_BUD     TMEANDAYSUMMA,
    MEAN_DAY_VNE     TMEANDAYSUMMA,
    MEAN_DAY_GN      TMEANDAYSUMMA,
    MEAN_DAY_NIS     TMEANDAYSUMMA,
    DOUBLE_DAY       TMEANDAYSUMMA,
    SUMMA_KMD        TSUMMAPERSON,
    SUMMA_KMD_B      TSUMMAPERSON,
    SUMMA_KMD_V      TSUMMAPERSON,
    SUMMA_KMD_G      TSUMMAPERSON,
    SUMMA_KMD_N      TSUMMAPERSON,
    DATA_P_BUD       TDATE,
    DATA_P_VNE       TDATE,
    DATA_P_GN        TDATE,
    DATA_P_NIS       TDATE,
    MODE_V_Z         TSMALLCODE,
    MODE_KMD         TSMALLCODE,
    SHIFRWRK         TSMALLCODE,
    DATEWRK          TDATEWRK,
    MARKED           TSMALLCODE,
    MODE_DAY_CLOCK   TSMALLCODE,
    SWIDSS           VARCHAR(15),
    CODE_REASON_ILL  TBIGCODE,
    SHIFRIDREKMD     TBIGCODE,
    SHIFRBUH         TBIGCODE
);

CREATE TABLE TB_KOMAND_ADD (
    SHIFRID           TBIGCODE NOT NULL,
    SHIFRIDKMND       TBIGCODE NOT NULL,
    SHIFRIDKMNDSUMMY  TBIGCODE,
    W_PLACE           TSMALLCODE,
    W_R               TSMALLCODE,
    SHIFRGRU          TSMALLCODE,
    SHIFRKAT          TSMALLCODE,
    SHIFRSTA          TSMALLCODE,
    MONTH_ZA          TMONTH,
    YEAR_ZA           TYEAR,
    MONTH_VY          TMONTH,
    YEAR_VY           TYEAR,
    SUMMA             TSUMMAPERSON,
    VYPL              TSMALLCODE,
    MARKED            TSMALLCODE,
    SHIFRWRK          TSMALLCODE,
    DATEWRK           TDATEWRK,
    TABNO             INTEGER
);

CREATE TABLE TB_KOMAND_RES (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDKMND  TBIGCODE NOT NULL,
    SHIFRSTA     TSMALLCODE NOT NULL,
    K_DAY        TSMALLCODE NOT NULL,
    MONTH_ZA     TMONTH,
    YEAR_ZA      TYEAR,
    SUMMA_K_BUD  TSUMMAPERSON,
    SUMMA_K_VNE  TSUMMAPERSON,
    SUMMA_K_GN   TSUMMAPERSON,
    SUMMA_K_NIS  TSUMMAPERSON,
    SHIFRWRK     TSMALLCODE,
    DATEWRK      TDATEWRK,
    SUMMAZARL    TSUMMAPERSON,
    NEEDMOV      TSMALLCODE
);

CREATE TABLE TB_KOMAND_SUMMY (
    SHIFRID      INTEGER NOT NULL,
    SHIFRIDKMND  INTEGER NOT NULL,
    SEL          TSMALLCODE,
    MONTH_ZA     TMONTH,
    YEAR_ZA      TYEAR,
    SUMMA_BUD    TSUMMAPERSON,
    SUMMA_VNE    TSUMMAPERSON,
    SUMMA_GN     TSUMMAPERSON,
    SUMMA_NIS    TSUMMAPERSON,
    OKLAD_M      TSUMMAPERSON,
    DAYS         TSMALLCODE,
    GRAPHIC_DAY  TSMALLCODE,
    KOEF         TMEANDAYSUMMA,
    SHIFRWRK     TSMALLCODE,
    DATEWRK      TDATEWRK,
    MANUAL_CALC  TSMALLCODE DEFAULT 0
);

CREATE TABLE TB_KREDIT_SPR (
    SHIFRID    TBIGCODE NOT NULL,
    NOMER      TBIGCODE,
    DATEFR     TDATE,
    TABNO      TBIGCODE,
    FIO        VARCHAR(100),
    DOLG       VARCHAR(100),
    SUMMATOT   TSUMMAPERSON,
    Y          TYEAR,
    RUKOWODIT  VARCHAR(60),
    GLBUH      VARCHAR(60),
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_KREDIT_SPR_PR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    Y             TYEAR,
    M             TSMALLCODE NOT NULL,
    SUMMA         TSUMMAPERSON
);

CREATE TABLE TB_MEDOK_PERSON (
    CODE        DOUBLE PRECISION,
    NUM         VARCHAR(10),
    NAME        VARCHAR(60),
    SEX         DOUBLE PRECISION,
    DOCCODE     DOUBLE PRECISION,
    SERDOC      VARCHAR(10),
    NUMDOC      VARCHAR(10),
    VYDDOC      VARCHAR(200),
    DATEDOC     VARCHAR(255),
    NUMTEL      VARCHAR(30),
    ADDR        VARCHAR(100),
    BIRTHDATE   VARCHAR(255),
    "SHARED"    DOUBLE PRECISION,
    WOFEE       DOUBLE PRECISION,
    TAXINSPNUM  VARCHAR(10),
    WORKBOOK    DOUBLE PRECISION,
    "DATEADD"   VARCHAR(255),
    DATEEND     VARCHAR(255),
    NOTUSED     DOUBLE PRECISION,
    SPFU        DOUBLE PRECISION,
    SPD         DOUBLE PRECISION,
    DRFO        VARCHAR(12),
    EMAIL       VARCHAR(100),
    MOBTEL      VARCHAR(20),
    USEMOB      DOUBLE PRECISION,
    CERTNAME    VARCHAR(200),
    DEPID       DOUBLE PRECISION,
    DEPNAME     VARCHAR(200),
    LASTNAME    VARCHAR(100),
    FIRSTNAME   VARCHAR(100),
    MIDDLENAME  VARCHAR(100),
    UKR_GROMAD  DOUBLE PRECISION,
    USEEMAIL    DOUBLE PRECISION,
    USEMEDOC    DOUBLE PRECISION,
    NRC         DOUBLE PRECISION
);

CREATE TABLE TB_MONTH (
    YEARZA   TSMALLCODE NOT NULL,
    MONTHZA  TSMALLCODE NOT NULL,
    DAYNO    TSMALLCODE NOT NULL,
    CODE     TSMALLCODE NOT NULL
);

CREATE TABLE TB_MONTHS_HEA (
    DATEFR        TDATE NOT NULL,
    WORK_DAY_5    TSMALLCODE,
    WORK_DAY_6    TSMALLCODE,
    WORK_CLOCK_5  TSMALLCODE,
    WORK_CLOCK_6  TSMALLCODE
);

CREATE TABLE TB_MONTHS_PR (
    DATEFR  TDATE NOT NULL,
    NB_DAY  TSMALLCODE NOT NULL,
    CODE    TSMALLCODE NOT NULL
);

CREATE TABLE TB_NADB_87 (
    SHIFRID           TBIGCODE NOT NULL,
    SHIFRIDKAD        TBIGCODE NOT NULL,
    TABNO             TBIGCODE,
    FIO               VARCHAR(20),
    YEARZ             TSMALLCODE,
    SHIFRGRU          TSMALLCODE,
    M_O_R_M           TSMALLCODE,
    NOTCOUNT_M        TSMALLCODE,
    OKLADOZD          TSUMMAPERSON,
    SUMMAOZDVYPL      TSUMMAPERSON,
    SUMMAOZDDOLG      TSUMMAPERSON,
    SUMMAPODTOT       TSUMMAPERSON,
    SUMMAPENSTOT      TSUMMAPERSON,
    SUMMAUDTOT        TSUMMAPERSON,
    SUMMAVYSLNEEDTOT  TSUMMAPERSON,
    SUMMAVYSLVYPLTOT  TSUMMAPERSON,
    SUMMAVYSLDOLGTOT  TSUMMAPERSON,
    SUMMAONHANDTOT    TSUMMAPERSON,
    DATA_PRI          TDATE,
    DATA_UW           TDATE
);

CREATE TABLE TB_NADB_87_PR (
    SHIFRID          TBIGCODE NOT NULL,
    SHIFRIDNADB      TBIGCODE NOT NULL,
    DOLG             VARCHAR(20),
    KOEF             TSUMMAPERSON,
    OKLAD            TSUMMAPERSON,
    STAWKA           TSUMMAPERSON,
    PEDSTAG          TSUMMAPERSON,
    PROCVYSL         TSUMMAPERSON,
    SUMMAVYSLNEED    TSUMMAPERSON,
    SUMMAVYSLVYPL    TSUMMAPERSON,
    SUMMAVYSLDOLG    TSUMMAPERSON,
    SUMMAOZDNEED     TSUMMAPERSON,
    SUMMAOZDFAKT     TSUMMAPERSON,
    SUMMAKOMPNEED    TSUMMAPERSON,
    SUMMAKOMPVYPL    TSUMMAPERSON,
    SUMMANARAH       TSUMMAPERSON,
    SUMMAKOMPZNARAH  TSUMMAPERSON,
    M_O_R            TSMALLCODE,
    OSNPPS           TBIGCODE,
    NOTCOUNT         TBIGCODE,
    W_R              TSMALLCODE,
    SUMMAPOD         TSUMMAPERSON,
    SUMMAPENS        TSUMMAPERSON,
    SUMMAUD          TSUMMAPERSON,
    SUMMAONHAND      TSUMMAPERSON,
    PERIOD           TSMALLCODE
);

CREATE TABLE TB_NAME_PODR_SELECTION_DET (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    NAME          CHAR(128)
);

CREATE TABLE TB_NEED_87 (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRIDNDB  TBIGCODE,
    SHIFRIDKAD  TBIGCODE NOT NULL,
    TABNO       TBIGCODE NOT NULL,
    YEARZA      TSMALLCODE,
    MONTHZA     TSMALLCODE,
    SHIFRSTA    TSMALLCODE,
    SUMMA       TSUMMAPERSON,
    ISUWOLEN    TSMALLCODE
);

CREATE TABLE TB_NOTUKRGROMAD (
    TABNO  INTEGER NOT NULL,
    FIO    VARCHAR(50)
);

CREATE TABLE TB_OTP_UHOD (
    SHIFRID   TBIGCODE NOT NULL,
    TABNO     TBIGCODE,
    FIO       TVARCHAR50,
    DATEFR    TDATE,
    DATETO    TDATE,
    DATEWRK   TDATEWRK,
    SHIFRWRK  TBIGCODE
);

CREATE TABLE TB_OTPHELPLIST2011 (
    TABNO       TBIGCODE NOT NULL,
    FIO         TVARCHAR50,
    SHIFRDOL    TSMALLCODE,
    DOLGNAME    TVARCHAR15,
    SUMMAH1     TSUMMAPERSON,
    SHIFRGRUH1  TSMALLCODE,
    DATAH1      TDATE,
    SHIFRPODH1  TSMALLCODE,
    SUMMAH2     TSUMMAPERSON,
    SHIFRGRUH2  TSMALLCODE,
    DATAH2      TDATE,
    SHIFRPODH2  TSMALLCODE,
    SUMMAOTP1   TSUMMAPERSON,
    SHIFRGRUO1  TSMALLCODE,
    DATAO1      TDATE,
    SHIFRPODO1  TSMALLCODE,
    SUMMAOTP2   TSUMMAPERSON,
    SHIFRGRUO2  TSMALLCODE,
    DATAO2      TDATE,
    SHIFRPODO2  TSMALLCODE,
    MONTHO2     TSMALLCODE,
    SUMMAPRE1   TSUMMAPERSON,
    SUMMAPRE2   TSUMMAPERSON,
    DATAOTPFR   TDATE,
    DATAOTPTO   TDATE,
    DAYOTP      TSMALLCODE,
    MONTHO1     TSMALLCODE
);

CREATE TABLE TB_OTPUSK_2012_01 (
    TABNO     INTEGER NOT NULL,
    SELECTED  INTEGER,
    CURRWRK   TBIGCODE,
    DATEWRK   TDATEWRK,
    W_PLACE   TBIGCODE NOT NULL
);

CREATE TABLE TB_OTPUSK_2012_04 (
    TABNO    TBIGCODE NOT NULL,
    APR30    TSMALLCODE DEFAULT 0,
    MAY03    TSMALLCODE DEFAULT 0,
    MAY04    TSMALLCODE DEFAULT 0,
    MAY07    TSMALLCODE DEFAULT 0,
    MAY08    TSMALLCODE DEFAULT 0,
    MAY10    TSMALLCODE DEFAULT 0,
    MAY11    TSMALLCODE DEFAULT 0,
    CURRWRK  TBIGCODE,
    DATEWRK  TDATEWRK,
    W_PLACE  TBIGCODE NOT NULL
);

CREATE TABLE TB_P04T05B (
    SHIFRID   INTEGER NOT NULL,
    YEARVY    INTEGER,
    MONTHVY   INTEGER,
    TABNO     INTEGER,
    ROWNUM    INTEGER,
    NUMIDENT  VARCHAR(10),
    FIO       VARCHAR(100),
    NM        VARCHAR(100),
    FTN       VARCHAR(100),
    START_DT  SMALLINT,
    END_DT    SMALLINT,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_P04T05B_DET (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRIDMST  TBIGCODE NOT NULL,
    TABNO       INTEGER,
    W_PLACE     TSMALLCODE,
    W_R         TSMALLCODE,
    SHIFRGRU    TSMALLCODE,
    SHIFRKAT    TSMALLCODE,
    SHIFRSTA    TSMALLCODE,
    MONTH_ZA    TMONTH,
    YEAR_ZA     TYEAR,
    MONTH_VY    TMONTH,
    YEAR_VY     TYEAR,
    SUMMA       TSUMMAPERSON,
    VYPL        TSMALLCODE,
    MARKED      TSMALLCODE,
    SHIFRWRK    TSMALLCODE,
    DATEWRK     TDATEWRK
);

CREATE TABLE TB_P04T06B (
    SHIFRID    INTEGER NOT NULL,
    YEARVY     INTEGER,
    MONTHVY    INTEGER,
    TABNO      INTEGER,
    ROWNUM     INTEGER,
    NUMIDENT   VARCHAR(10),
    FIO        VARCHAR(100),
    NM         VARCHAR(100),
    FTN        VARCHAR(100),
    ZO         SMALLINT,
    ZIC        SMALLINT,
    SUM_TOTAL  DECIMAL(15,2),
    SUM_MAX    DECIMAL(15,2),
    SUM_INS    DECIMAL(15,2),
    OTK        SMALLINT,
    EXP        SMALLINT,
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_P04T06B_DET (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDMST     TBIGCODE NOT NULL,
    SHIFRIDPERSON  TBIGCODE,
    SHIFRIDADD     TBIGCODE,
    TABNO          INTEGER,
    W_PLACE        TSMALLCODE,
    W_R            TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    VYPL           TSMALLCODE,
    MARKED         TSMALLCODE,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_P04T06B_DET_PENS (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDMST     TBIGCODE NOT NULL,
    SHIFRIDPERSON  TBIGCODE,
    SHIFRIDUD      TBIGCODE,
    TABNO          INTEGER,
    W_PLACE        TSMALLCODE,
    W_R            TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    VYPL           TSMALLCODE,
    MARKED         TSMALLCODE,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_P04T07B (
    SHIFRID    INTEGER NOT NULL,
    YEARVY     INTEGER,
    MONTHVY    INTEGER,
    TABNO      INTEGER,
    ROWNUM     INTEGER,
    NUMIDENT   VARCHAR(10),
    FIO        VARCHAR(100),
    NM         VARCHAR(100),
    FTN        VARCHAR(100),
    ZO         SMALLINT,
    ZIC        SMALLINT,
    PAY_MNTH   SMALLINT,
    PAY_YEAR   SMALLINT,
    PAY_TP     SMALLINT,
    SUM_TOTAL  DECIMAL(15,2),
    SUM_MAX    DECIMAL(15,2),
    SUM_INS    DECIMAL(15,2),
    OTK        SMALLINT,
    EXP        SMALLINT,
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_P04T07B_DET (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDMST     TBIGCODE NOT NULL,
    SHIFRIDPERSON  TBIGCODE,
    SHIFRIDADD     TBIGCODE,
    TABNO          INTEGER,
    W_PLACE        TSMALLCODE,
    W_R            TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    VYPL           TSMALLCODE,
    MARKED         TSMALLCODE,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_P04T07B_DET_PENS (
    SHIFRID        TBIGCODE NOT NULL,
    SHIFRIDMST     TBIGCODE NOT NULL,
    SHIFRIDPERSON  TBIGCODE,
    SHIFRIDUD      TBIGCODE,
    TABNO          INTEGER,
    W_PLACE        TSMALLCODE,
    W_R            TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    VYPL           TSMALLCODE,
    MARKED         TSMALLCODE,
    SHIFRWRK       TSMALLCODE,
    DATEWRK        TDATEWRK
);

CREATE TABLE TB_P04T08B (
    SHIFRID   INTEGER NOT NULL,
    YEARVY    INTEGER,
    MONTHVY   INTEGER,
    TABNO     INTEGER,
    ROWNUM    INTEGER,
    NUMIDENT  VARCHAR(10),
    FIO       VARCHAR(100),
    NM        VARCHAR(100),
    FTN       VARCHAR(100),
    C_PID     VARCHAR(9),
    DAYS      SMALLINT,
    START_DT  SMALLINT,
    END_DT    SMALLINT,
    NORMZ     SMALLINT,
    HH        SMALLINT,
    MM        SMALLINT,
    SEASON    SMALLINT,
    NORMA     SMALLINT,
    SHIFRWRK  TBIGCODE,
    DATEWRK   TDATEWRK
);

CREATE TABLE TB_PAR_INDEX (
    YEARZA       INTEGER NOT NULL,
    MONTHZA      INTEGER NOT NULL,
    PROCIND      DECIMAL(15,4) NOT NULL,
    LIMITSUMMA   DECIMAL(15,4) NOT NULL,
    RAZRFR       TSMALLCODE,
    RAZRTO       TSMALLCODE,
    NEEDBLOCKED  TSMALLCODE
);

CREATE TABLE TB_PARAM (
    SHIFRID  TBIGCODE NOT NULL,
    NAME     VARCHAR(250),
    COMMENT  VARCHAR(50),
    DATEFR   TDATE,
    CODEMES  TSMALLCODE
);

CREATE TABLE TB_PERS_PREP (
    TABNO     INTEGER NOT NULL,
    NAL_CODE  VARCHAR(10),
    FIO       VARCHAR(50),
    M_O_R     INTEGER
);

CREATE TABLE TB_PERS_PREP_SOWM (
    TABNO     INTEGER NOT NULL,
    NAL_CODE  VARCHAR(10),
    FIO       VARCHAR(50),
    M_O_R     INTEGER,
    S1        DECIMAL(15,2),
    S2        DECIMAL(15,2),
    S3        DECIMAL(15,2),
    S4        DECIMAL(15,2),
    S5        DECIMAL(15,2),
    S6        DECIMAL(15,2),
    S7        DECIMAL(15,2),
    S8        DECIMAL(15,2),
    S9        DECIMAL(15,2),
    S10       DECIMAL(15,2),
    S11       DECIMAL(15,2),
    S12       DECIMAL(15,2),
    DF        DATE,
    DT        DATE,
    KM        INTEGER,
    KD        INTEGER
);

CREATE TABLE TB_PICK (
    SHIFRWRK  INTEGER,
    SHIFRPOD  INTEGER,
    W_R       INTEGER,
    TABNO     INTEGER
);

CREATE TABLE TB_PLAN_GRID (
    SHIFRID   INTEGER NOT NULL,
    DATAFR    TDATE,
    SUMMAFR   TSUMMAPERSON,
    SUMMATO   TSUMMAPERSON,
    SHIFRWRK  TBIGCODE NOT NULL,
    DATEWRK   TDATEWRK,
    NMBOFALL  TBIGCODE,
    NMBOFWMN  TBIGCODE
);

CREATE TABLE TB_PLAN_PREM_PERSON (
    TABNO         TBIGCODE NOT NULL,
    FIO           VARCHAR(100),
    SHIFRROW      TSMALLCODE,
    SHIFRKAT      TSMALLCODE,
    Y             TSMALLCODE NOT NULL,
    M             TSMALLCODE NOT NULL,
    SUMMAPREMBUD  TSUMMAPERSON,
    SUMMANADBBUD  TSUMMAPERSON,
    SUMMAPREMVNE  TSUMMAPERSON,
    SUMMANADBVNE  TSUMMAPERSON,
    ISKOLEDG      TSMALLCODE NOT NULL
);

CREATE TABLE TB_PLAT_FAKT_87 (
    SHIFRID    TBIGCODE NOT NULL,
    NOMERVYPL  TSMALLCODE,
    ISKASSA    TSMALLCODE,
    TABNO      TBIGCODE,
    FIO        VARCHAR(80),
    SUMMA      TSUMMAPERSON,
    NALCODE    DECIMAL(15,0),
    DATEFR     TDATE
);

CREATE TABLE TB_PLAT_HAT (
    SHIFRID   TBIGCODE NOT NULL,
    NOMER     TBIGCODE NOT NULL,
    MONTHVY   TMONTH,
    YEARVY    TSMALLCODE NOT NULL,
    SHIFRPOD  TSMALLCODE,
    SHIFRGRU  TSMALLCODE,
    SHIFRBAN  TSMALLCODE NOT NULL,
    SHIFRSTA  TSMALLCODE DEFAULT 0,
    DATAVY    TDATE,
    NMBOFREC  TSMALLCODE DEFAULT 0,
    SUMMATOT  DECIMAL(15,2) DEFAULT 0,
    SHIFRWRK  TSMALLCODE,
    DATEWRK   TDATEWRK,
    MODE_U_K  TSMALLCODE DEFAULT 0
);

CREATE TABLE TB_PLAT_PR (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDPLAT  TBIGCODE NOT NULL,
    LINENO       TSMALLCODE NOT NULL,
    TABNO        INTEGER NOT NULL,
    FIO          VARCHAR(50),
    SUMMA        TSUMMAPERSON
);

CREATE TABLE TB_PODR_HISTORY (
    SHIFRPOD    INTEGER NOT NULL,
    DATETO      DATE NOT NULL,
    NAME        VARCHAR(100),
    SHIFRWRK    TSMALLCODE,
    DATEWRK     TDATEWRK,
    MO_BUD      INTEGER,
    MO_VNE      INTEGER,
    MO_KOL_BUD  INTEGER,
    MO_KOL_VNE  INTEGER,
    MO_GN       INTEGER,
    MO_NIS      INTEGER,
    MO_MAG_BUD  INTEGER,
    MO_MAG_VNE  INTEGER,
    MO_MP       INTEGER
);

CREATE TABLE TB_PODR_SELECTION_LIST (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    SHIFRPOD      TBIGCODE NOT NULL,
    MODE          TSMALLCODE DEFAULT 1
);

CREATE TABLE TB_PREP_UWP_2009 (
    TABNO      INTEGER,
    FIO        VARCHAR(50),
    DOLG       VARCHAR(10),
    SUMMAPREP  DECIMAL(15,2),
    SUMMAOTH   DECIMAL(15,2),
    MODE       INTEGER
);

CREATE TABLE TB_PREP_UWP_PERS_MONTH (
    SHIFRID    INTEGER NOT NULL,
    YEARVY     TYEAR,
    MONTHVY    TMONTH,
    TABNO      TBIGCODE,
    FIO        VARCHAR(50),
    DOLG       VARCHAR(10),
    SUMMAPREP  TSUMMAPERSON,
    SUMMAOTH   TSUMMAPERSON,
    MODE       TSMALLCODE,
    SHIFRWRK   TBIGCODE,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_PRIKAZY (
    ID                   TBIGCODE NOT NULL,
    TABNO                TBIGCODE NOT NULL,
    DATAPRIK             TDATE,
    NOMERPRIK            TVARCHAR15,
    DATABEG              TDATE,
    DATAEND              TDATE,
    CONTENT              VARCHAR(1024),
    SHIFRWRK             TBIGCODE,
    DATACRE              TDATEWRK,
    DATACHG              TDATEWRK,
    FIOWRK               TVARCHAR50,
    FIO                  TVARCHAR50,
    SHIFRIDTYP           TBIGCODE,
    IDCLASSIFICATOR      INTEGER,
    Y                    INTEGER,
    M                    INTEGER,
    KODKP                VARCHAR(10),
    KODZKPPTR            VARCHAR(10),
    NAMEDOL              VARCHAR(512),
    NAMEPROF             VARCHAR(512),
    KODKP_OLD            VARCHAR(10),
    KODZKPPTR_OLD        VARCHAR(10),
    NAMEDOL_OLD          VARCHAR(512),
    NAMEPROF_OLD         VARCHAR(512),
    IDCLASSIFICATOR_OLD  INTEGER
);

CREATE TABLE TB_PRIKAZY_TYP (
    ID       TBIGCODE NOT NULL,
    NAME     TVARCHAR50,
    CONTENT  VARCHAR(1024)
);

CREATE TABLE TB_PROC_IND_KOE (
    DATAB  DATE NOT NULL,
    KOEF   DECIMAL(15,4)
);

CREATE TABLE TB_R_2012 (
    FIO         VARCHAR(51),
    TABNO       INTEGER,
    SUMMAADD1   DECIMAL(10,2),
    SUMMAUD1    DECIMAL(10,2),
    SUMMARAS1   DECIMAL(10,2),
    SUMMAREZ1   DECIMAL(10,2),
    SUMMAADD2   DECIMAL(10,2),
    SUMMAUD2    DECIMAL(10,2),
    SUMMARAS2   DECIMAL(10,2),
    SUMMAREZ2   DECIMAL(10,2),
    SUMMAADD3   DECIMAL(10,2),
    SUMMAUD3    DECIMAL(10,2),
    SUMMARAS3   DECIMAL(10,2),
    SUMMAREZ3   DECIMAL(10,2),
    SUMMAADD4   DECIMAL(10,2),
    SUMMAUD4    DECIMAL(10,2),
    SUMMARAS4   DECIMAL(10,2),
    SUMMAREZ4   DECIMAL(10,2),
    SUMMAADD5   DECIMAL(10,2),
    SUMMAUD5    DECIMAL(10,2),
    SUMMARAS5   DECIMAL(10,2),
    SUMMAREZ5   DECIMAL(10,2),
    SUMMAADD6   DECIMAL(10,2),
    SUMMAUD6    DECIMAL(10,2),
    SUMMARAS6   DECIMAL(10,2),
    SUMMAREZ6   DECIMAL(10,2),
    SUMMAADD7   DECIMAL(10,2),
    SUMMAUD7    DECIMAL(10,2),
    SUMMARAS7   DECIMAL(10,2),
    SUMMAREZ7   DECIMAL(10,2),
    SUMMAADD8   DECIMAL(10,2),
    SUMMAUD8    DECIMAL(10,2),
    SUMMARAS8   DECIMAL(10,2),
    SUMMAREZ8   DECIMAL(10,2),
    SUMMAADD9   DECIMAL(10,2),
    SUMMAUD9    DECIMAL(10,2),
    SUMMARAS9   DECIMAL(10,2),
    SUMMAREZ9   DECIMAL(10,2),
    SUMMAADD10  DECIMAL(10,2),
    SUMMAUD10   DECIMAL(10,2),
    SUMMARAS10  DECIMAL(10,2),
    SUMMAREZ10  DECIMAL(10,2),
    SUMMAADD11  DECIMAL(10,2),
    SUMMAUD11   DECIMAL(10,2),
    SUMMARAS11  DECIMAL(10,2),
    SUMMAREZ11  DECIMAL(10,2),
    SUMMAADD12  DECIMAL(10,2),
    SUMMAUD12   DECIMAL(10,2),
    SUMMARAS12  DECIMAL(10,2),
    SUMMAREZ12  DECIMAL(10,2)
);

CREATE TABLE TB_RAZR_PROC (
    RAZR       INTEGER NOT NULL,
    PROC       DECIMAL(15,4),
    OKLAD      DECIMAL(15,2),
    DATEFR     TDATE,
    KOEF_BOLN  TMEANDAYSUMMA,
    KOEF_OTP   TMEANDAYSUMMA,
    SHIFRID    TBIGCODE NOT NULL
);

CREATE TABLE TB_RAZR_SWOD (
    RAZR      TBIGCODE NOT NULL,
    OKLAD     TSUMMAPERSON,
    FOP       TSUMMAPERSON,
    FOPOKLAD  TSUMMAPERSON,
    FOPDOPL   TSUMMAPERSON,
    SUMMAIND  TSUMMAPERSON
);

CREATE TABLE TB_RCLC1301 (
    TABNO            INTEGER,
    FIO              CHAR(30),
    W_PLACE          TSMALLCODE,
    SHIFRGRU         TSMALLCODE,
    SHIFRKAT         TSMALLCODE,
    DOLG             CHAR(25),
    WORK_DAY         TSMALLCODE,
    KALEND_DAY       TSMALLCODE,
    ILL_DAY          TSMALLCODE,
    OTP_DAY          TSMALLCODE,
    KOEF             TSUMMAPERSON,
    RAZR             TSMALLCODE,
    W_R              TSMALLCODE,
    CN_OSN           TSMALLCODE,
    OLD_OKLAD        TSUMMAPERSON,
    NEW_OKLAD        TSUMMAPERSON,
    OLD_VYPL_OKLAD   TSUMMAPERSON,
    NEW_VYPL_OKLAD   TSUMMAPERSON,
    DOPL_OKLAD       TSUMMAPERSON,
    NADB_ZW_PR       TSUMMAPERSON,
    DOPL_ZW          TSUMMAPERSON,
    NADB_ST_PR       TSUMMAPERSON,
    DOPL_ST          TSUMMAPERSON,
    NADB_VYSL        TSUMMAPERSON,
    DOPL_VYSL        TSUMMAPERSON,
    NADB_ZAM_DEK_PR  TSUMMAPERSON,
    DOPL_ZAM_DEK     TSUMMAPERSON,
    NADB_ZAW_KAF_PR  TSUMMAPERSON,
    DOPL_ZAW_KAF     TSUMMAPERSON,
    NADB_ZS_PR       TSUMMAPERSON,
    DOPL_ZS          TSUMMAPERSON,
    MOVED            TSMALLCODE,
    SHIFRID          TBIGCODE NOT NULL,
    GUID             TVARCHAR30,
    Y                TSMALLCODE,
    M                TSMALLCODE,
    SHIFRDOL         TSMALLCODE
);

CREATE TABLE TB_RCLC1301_PR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE,
    SHIFRSTA      TBIGCODE,
    PROCENT       TSUMMAPERSON,
    DOPL_SUMMA    TSUMMAPERSON,
    NAMESTA       TVARCHAR30
);

CREATE TABLE TB_RCLCPOCHAS1301 (
    SHIFRID   TBIGCODE NOT NULL,
    TABNO     TSMALLCODE,
    FIO       TVARCHAR30,
    DOLG      TVARCHAR30,
    SHIFRDOL  TBIGCODE,
    SHIFRTST  TSMALLCODE,
    SHIFRZW   TSMALLCODE,
    ISDEK     TSMALLCODE,
    ISMG      TSMALLCODE,
    SHIFRPOD  TSMALLCODE,
    Y         TSMALLCODE,
    M         TSMALLCODE,
    GUID      TVARCHAR30,
    MOVED     TSMALLCODE
);

CREATE TABLE TB_RCLCPOCHAS1301_PR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    SUMMAOLD      TSUMMAPERSON,
    NMBOFCLOCK    TSUMMAPERSON,
    STAWKAOLD     TSUMMAPERSON,
    STAWKANEW     TSUMMAPERSON,
    SUMMANEW      TSUMMAPERSON,
    DOPL          TSUMMAPERSON
);

CREATE TABLE TB_RECALC_PODOH (
    SHIFRID         TBIGCODE NOT NULL,
    TABNO           INTEGER,
    YEARZA          TYEAR,
    MONTHZA         TMONTH,
    SUMMAADDTOT     TSUMMAPERSON,
    SUMMAADDECBN    TSUMMAPERSON,
    SUMMAECBNUD     TSUMMAPERSON,
    SUMMAECBNRAS    TSUMMAPERSON,
    SUMMAADDECB     TSUMMAPERSON,
    SUMMAECBUD      TSUMMAPERSON,
    SUMMAECBRAS     TSUMMAPERSON,
    SUMMAADDECBDP   TSUMMAPERSON,
    SUMMAECBDPUD    TSUMMAPERSON,
    SUMMAECBDPRAS   TSUMMAPERSON,
    SUMMAADDECBILL  TSUMMAPERSON,
    SUMMAECBILLUD   TSUMMAPERSON,
    SUMMAECBILLRAS  TSUMMAPERSON,
    SUMMAADDPOD     TSUMMAPERSON,
    SUMMAPODUD      TSUMMAPERSON,
    SUMMAPODRAS     TSUMMAPERSON,
    MOVEDPOD        TSMALLCODE,
    MOVEDECBN       TSMALLCODE,
    MOVEDECB        TSMALLCODE,
    MOVEDECBDP      TSMALLCODE,
    MOVEDECBILL     TSMALLCODE
);

CREATE TABLE TB_RECALC_PODOH_DET (
    SHIFRID          TBIGCODE NOT NULL,
    SHIFRIDOWN       TBIGCODE NOT NULL,
    TABNO            TBIGCODE,
    GUID             VARCHAR(30),
    ISBLOCKED        TBIGCODE DEFAULT 0,
    ISSCIPED         TBIGCODE DEFAULT 0,
    ISDP             TBIGCODE DEFAULT 0,
    ISOSN            TSMALLCODE DEFAULT 0,
    SUMMAADDPOD      TSUMMAPERSON DEFAULT 0,
    SUMMAUDPOD       TSUMMAPERSON DEFAULT 0,
    SUMMAPODNEED     TSUMMAPERSON DEFAULT 0,
    SUMMAADDECBN     TSUMMAPERSON DEFAULT 0,
    SUMMAECBNUD      TSUMMAPERSON DEFAULT 0,
    SUMMAECBNNEED    TSUMMAPERSON DEFAULT 0,
    SUMMAADDECB      TSUMMAPERSON DEFAULT 0,
    SUMMAECBUD       TSUMMAPERSON DEFAULT 0,
    SUMMAECBNEED     TSUMMAPERSON DEFAULT 0,
    SUMMAADDECBDP    TSUMMAPERSON DEFAULT 0,
    SUMMAECBDPUD     TSUMMAPERSON DEFAULT 0,
    SUMMAECBDPNEED   TSUMMAPERSON DEFAULT 0,
    SUMMAADDECBILL   TSUMMAPERSON DEFAULT 0,
    SUMMAECBILLUD    TSUMMAPERSON DEFAULT 0,
    SUMMAECBILLNEED  TSUMMAPERSON DEFAULT 0
);

CREATE TABLE TB_REE_BOLN (
    SHIFRID      TBIGCODE NOT NULL,
    NOMER        TVARCHAR15,
    DATEFORM     TDATE,
    DATEREE      TDATE,
    DATERCV      TDATE,
    NMBOFBLN     TSMALLCODE,
    NMBOFDAY     TSMALLCODE,
    NMBOFDAYSS   TSMALLCODE,
    SUMMA        TSUMMAPERSON,
    SUMMASS      TSUMMAPERSON,
    SUMMAPODSS   TSUMMAPERSON,
    SUMMAECBSS   TSUMMAPERSON,
    SUMMABANKSS  TSUMMAPERSON,
    SHIFRWRK     TBIGCODE,
    DATEWRK      TDATEWRK
);

CREATE TABLE TB_REE_BOLN_DET (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDREE   TBIGCODE NOT NULL,
    SHIFRIDBOLN  TBIGCODE,
    TABNO        TSMALLCODE,
    FIO          VARCHAR(51),
    DATEFR       TDATE,
    DATETO       TDATE,
    NMBOFDAY     TSMALLCODE,
    NMBOFDAYSS   TSMALLCODE,
    SUMMA        TSUMMAPERSON,
    SUMMASS      TSUMMAPERSON,
    SUMMAPODSS   TSUMMAPERSON,
    SUMMAECBSS   TSUMMAPERSON,
    SUMMABANKSS  TSUMMAPERSON,
    SHIFRWRK     TBIGCODE,
    DATEWRK      TDATEWRK,
    NOMER_B      TVARCHAR15,
    SWIDSS       TVARCHAR15,
    CODEILL      TSMALLCODE,
    INN          VARCHAR(10),
    SHIFRBUH     TSMALLCODE
);

CREATE TABLE TB_RIGHTS (
    SHIFRID  TBIGCODE NOT NULL,
    NAME     VARCHAR(10) NOT NULL
);

CREATE TABLE TB_RUK_FOR_SWOD_PREM (
    TABNO     TSMALLCODE NOT NULL,
    FIO       VARCHAR(100),
    COMMENT   VARCHAR(100),
    SHIFRDOL  TSMALLCODE,
    SHIFRROW  TSMALLCODE
);

CREATE TABLE TB_SAVED_AWANS_DET (
    SHIFRID       INTEGER NOT NULL,
    SHIFRIDOWNER  INTEGER NOT NULL,
    TABNO         SMALLINT NOT NULL,
    W_PLACE       SMALLINT,
    W_R           SMALLINT,
    SHIFRGRU      SMALLINT,
    SHIFRKAT      SMALLINT,
    SHIFRSTA      SMALLINT,
    MONTH_ZA      SMALLINT NOT NULL,
    YEAR_ZA       SMALLINT NOT NULL,
    MONTH_VY      SMALLINT,
    YEAR_VY       SMALLINT,
    SUMMA         DECIMAL(12,2),
    VYPL          SMALLINT,
    SCH           VARCHAR(8)
);

CREATE TABLE TB_SAVED_AWANS_HAT (
    SHIFRID   INTEGER NOT NULL,
    NAME      VARCHAR(256),
    YEARVY    INTEGER,
    MONTHVY   INTEGER,
    DATESA    DATE,
    SHIFRWRK  INTEGER,
    DATEWRK   DATE
);

CREATE TABLE TB_SBS_PARAM (
    SHIFRID  INTEGER NOT NULL,
    FIO      VARCHAR(50)
);

CREATE TABLE TB_SBS_SAD_TABLE (
    SHIFRID       INTEGER NOT NULL,
    SHIFRIDOWNER  TBIGCODE,
    TABNO         TSMALLCODE,
    W_PLACE       TSMALLCODE,
    W_R           TSMALLCODE,
    SHIFRGRU      TSMALLCODE,
    SHIFRKAT      TSMALLCODE,
    SHIFRSTA      TSMALLCODE,
    MONTH_ZA      TMONTH,
    YEAR_ZA       TYEAR,
    MONTH_VY      TMONTH,
    YEAR_VY       TYEAR,
    SUMMA         TSUMMAPERSON,
    WDAY          TSUMMAPERSON,
    WCLOCK        TSUMMAPERSON,
    FOND          TSMALLCODE,
    VYPL          TSMALLCODE,
    SCH           VARCHAR(8),
    MARK          TSMALLCODE
);

CREATE TABLE TB_SBS_SUD_TABLE (
    SHIFRID       INTEGER NOT NULL,
    SHIFRIDOWNER  INTEGER NOT NULL,
    TABNO         TSMALLCODE NOT NULL,
    W_PLACE       TSMALLCODE,
    W_R           TSMALLCODE,
    SHIFRGRU      TSMALLCODE,
    SHIFRKAT      TSMALLCODE,
    SHIFRSTA      TSMALLCODE,
    MONTH_ZA      TSMALLCODE NOT NULL,
    YEAR_ZA       TSMALLCODE NOT NULL,
    MONTH_VY      TSMALLCODE,
    YEAR_VY       TSMALLCODE,
    SUMMA         DECIMAL(12,2),
    VYPL          TSMALLCODE,
    MARK          TSMALLCODE
);

CREATE TABLE TB_SECRET_TABNO (
    TABNO  TBIGCODE NOT NULL
);

CREATE TABLE TB_SEL_PAR_PLAT (
    SHIFRID       TSMALLCODE NOT NULL,
    SHIFRPODLIST  TBIGCODE,
    SHIFRGRULIST  TBIGCODE,
    SHIFRSTA      TBIGCODE,
    MODE_U_K      TSMALLCODE,
    NAME          VARCHAR(80)
);

CREATE TABLE TB_SHIFR_HISTORY (
    SHIFR      INTEGER NOT NULL,
    DATETO     DATE NOT NULL,
    NAME       VARCHAR(52),
    SHORTNAME  VARCHAR(20),
    PODOH      SMALLINT,
    PENS       SMALLINT,
    SS         SMALLINT,
    FONDZ      SMALLINT,
    BOLN       SMALLINT,
    OTP        SMALLINT,
    PROF       SMALLINT,
    ALIM       SMALLINT,
    MODE       SMALLINT,
    SHIFRWRK   INTEGER,
    DATEWRK    TDATEWRK
);

CREATE TABLE TB_SPR_ZARPL (
    SHIFRID        TBIGCODE NOT NULL,
    TABNO          TBIGCODE NOT NULL,
    Y              TYEAR NOT NULL,
    FIO            VARCHAR(100),
    SUMMATOT       TSUMMAPERSON,
    SUMMAPODOHTOT  TSUMMAPERSON,
    DIREKTOR       VARCHAR(50),
    GLBUH          VARCHAR(70),
    DATAPRINT      TDATE,
    DATAFR         TDATE,
    SHIFRWRK       TBIGCODE,
    DATEWRK        TDATEWRK,
    MODE_ZA        TSMALLCODE,
    SUMMAECBTOT    TSUMMAPERSON
);

CREATE TABLE TB_SPR_ZARPL_PR (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    PERIOD        TYEAR,
    SUMMAADD      TSUMMAPERSON,
    SUMMAPOD      TSUMMAPERSON,
    SUMMAECB      TSUMMAPERSON
);

CREATE TABLE TB_SPRSBSPRTABLE (
    SHIFRID       TBIGCODE NOT NULL,
    SHIFRIDOWNER  TBIGCODE NOT NULL,
    YEAR_ZA       TSMALLCODE,
    MONTH_ZA      TSMALLCODE,
    SUMMA         TSUMMAPERSON,
    SUMMA_ZARPL   TSUMMAPERSON,
    SUMMA_VNE     TSUMMAPERSON,
    SUMMA_ALIM    TSUMMAPERSON
);

CREATE TABLE TB_SPRSBSTABLE (
    TABNO       TSMALLCODE,
    SHIFRID     TBIGCODE NOT NULL,
    NAL_CODE    VARCHAR(10),
    FIO         VARCHAR(150),
    W_PLACE     TSMALLCODE,
    SHIFR_KAT   TSMALLCODE,
    SHIFR_GRU   TSMALLCODE,
    DATA_VY     DATE,
    MONTH_VY    TSMALLCODE,
    YEAR_VY     TSMALLCODE,
    MODE_VY_ZA  TSMALLCODE,
    BUH_NAME    VARCHAR(30),
    DOLG        VARCHAR(40),
    KOD_W_R     TSMALLCODE,
    W_R_NAME    VARCHAR(15),
    SUMMA_PROP  VARCHAR(180),
    SUMMA_TOT   TSUMMAPERSON,
    PERIOD      VARCHAR(80),
    F_DATA      DATE,
    L_DATA      DATE,
    PROREKTOR   VARCHAR(20),
    GL_BUH      VARCHAR(20),
    F_MONTH     TSMALLCODE,
    F_YEAR      TSMALLCODE,
    L_MONTH     TSMALLCODE,
    L_YEAR      TSMALLCODE,
    DATEWRK     TIMESTAMP,
    SHIFRWRK    TSMALLCODE
);

CREATE TABLE TB_SV_LESS_MIN_ZP (
    ID          INTEGER NOT NULL,
    Y           INTEGER NOT NULL,
    M           INTEGER NOT NULL,
    TABNO       INTEGER,
    YEAR_ZA     INTEGER,
    MONTH_ZA    INTEGER,
    SUMMA       DECIMAL(15,2),
    SUMMA_DB    DECIMAL(15,2),
    SUMMA_RAZN  DECIMAL(15,2),
    WORKDAY     INTEGER,
    KOEF        DECIMAL(15,2),
    FIO         VARCHAR(50),
    NEED_NOT    SMALLINT DEFAULT 0
);

CREATE TABLE TB_SWODY_DET (
    SHIFRID      TBIGCODE NOT NULL,
    SHIFRIDSWOD  TBIGCODE NOT NULL,
    SHIFRSTA     TBIGCODE NOT NULL,
    SHIFRPOD     TBIGCODE NOT NULL,
    PERIOD       TBIGCODE NOT NULL,
    NMBOFREC     TBIGCODE NOT NULL,
    SUMMA        TSUMMAPERSON NOT NULL,
    SUMMAFZP     TSUMMAPERSON NOT NULL,
    SUMMAFMP     TSUMMAPERSON NOT NULL,
    SUMMAOTH     TSUMMAPERSON NOT NULL
);

CREATE TABLE TB_SWODY_DET_PERSON_ADD (
    SHIFRID      INTEGER NOT NULL,
    SHIFRIDSWOD  INTEGER NOT NULL,
    TABNO        INTEGER NOT NULL,
    SUMMA        DECIMAL(15,2) NOT NULL
);

CREATE TABLE TB_SWODY_HAT (
    SHIFRID          TBIGCODE NOT NULL,
    NAME             TVARCHAR50,
    YEARVY           TBIGCODE,
    MONTHVY          TBIGCODE,
    SHIFRWRK         TBIGCODE,
    DATEWRK          TDATEWRK,
    NAMEDET          VARCHAR(4096),
    SEL              TSMALLCODE,
    SOWM_SWOD        TSMALLCODE,
    SWOD_MODE        TSMALLCODE,
    NEEDDOGPOD       TSMALLCODE,
    TOTALMODE        TSMALLCODE,
    MODEILLSS        TSMALLCODE,
    MODECHERNOB      TSMALLCODE,
    SELECT_KEY       TSMALLCODE,
    SELECT_BAY_MODE  TSMALLCODE,
    SELECTEDBAY      TSMALLCODE,
    SWODSOWMMODE     TSMALLCODE
);

CREATE TABLE TB_TABNO_KRIM (
    TABNO  SMALLINT
);

CREATE TABLE TB_TEMY (
    SHIFRID   TBIGCODE NOT NULL,
    NAME      VARCHAR(100),
    DATEWRK   TDATEWRK,
    SHIFRWRK  TBIGCODE
);

CREATE TABLE TB_TEMY_KAF (
    SHIFRIDTEMY  TBIGCODE NOT NULL,
    SHIFRKAF     TBIGCODE NOT NULL,
    NAMETEMY     CHAR(10),
    NAMEKAF      CHAR(50),
    DATEWRK      TDATEWRK,
    SHIFRWRK     TBIGCODE
);

CREATE TABLE TB_TEST_E04 (
    TABNO          INTEGER NOT NULL,
    FIO            VARCHAR(100),
    NAL_CODE       VARCHAR(10),
    SUM_TOTAL      DECIMAL(15,2) DEFAULT 0,
    SUM_TOTAL_C    DECIMAL(15,2) DEFAULT 0,
    SUM_TOTAL_N    DECIMAL(15,2) DEFAULT 0,
    SUM_TOTAL_DP   DECIMAL(15,2) DEFAULT 0,
    SUM_TOTAL_ILL  DECIMAL(15,2) DEFAULT 0,
    SUM_MAX        DECIMAL(15,2) DEFAULT 0,
    SUM_INS        DECIMAL(15,2) DEFAULT 0,
    SUM_INS_ILL    DECIMAL(15,2) DEFAULT 0,
    SUM_INS_C      DECIMAL(15,2) DEFAULT 0,
    SUM_INS_N      DECIMAL(15,2) DEFAULT 0,
    SUM_INS_DP     DECIMAL(15,2) DEFAULT 0,
    SUM_ILL        DECIMAL(15,2) DEFAULT 0,
    SUM_ILL_5      DECIMAL(15,2) DEFAULT 0,
    SUM_ILL_SS     DECIMAL(15,2) DEFAULT 0,
    SUM_ECB        DECIMAL(15,2) DEFAULT 0,
    SUM_ECB_C      DECIMAL(15,2) DEFAULT 0,
    SUM_ECB_N      DECIMAL(15,2) DEFAULT 0,
    SUM_ECB_ILL    DECIMAL(15,2) DEFAULT 0,
    SUM_ECB_DP     DECIMAL(15,2) DEFAULT 0,
    SUM_SAL        DECIMAL(15,2) DEFAULT 0,
    SUM_SAL_C      DECIMAL(15,2) DEFAULT 0,
    SUM_SAL_N      DECIMAL(15,2),
    SUM_SAL_DP     DECIMAL(15,2)
);

CREATE TABLE TB_TEST_P04 (
    TABNO        INTEGER NOT NULL,
    FIO          VARCHAR(100),
    NAL_CODE     VARCHAR(10),
    SUM_TOTAL_6  DECIMAL(15,2),
    SUM_MAX_6    DECIMAL(15,2),
    SUM_INS_6    DECIMAL(15,2),
    SUM_TOTAL_7  DECIMAL(15,2),
    SUM_MAX_7    DECIMAL(15,2),
    SUM_INS_7    DECIMAL(15,2),
    SUM_SAL      DECIMAL(15,2),
    SUM_PENS     DECIMAL(15,2)
);

CREATE TABLE TB_TMP_BOL_PRINT (
    CONN_ID       INTEGER NOT NULL,
    LINENO        INTEGER,
    "MONTH"       VARCHAR(10),
    DAYS          INTEGER,
    SUMMA_BUD     DECIMAL(15,2),
    SUMMA_VNE     DECIMAL(15,2),
    SUMMA_GN      DECIMAL(15,2),
    SUMMA_NIS     DECIMAL(15,2),
    MONTH_BOL     CHAR(10),
    SHIFR_STA     INTEGER,
    DAY_BOL       INTEGER,
    SUMMABOL_BUD  DECIMAL(15,2),
    SUMMABOL_VNE  DECIMAL(15,2),
    SUMMABOL_GN   DECIMAL(15,2),
    SUMMABOL_NIS  DECIMAL(15,2),
    FOND          VARCHAR(10)
);

CREATE TABLE TB_TMP_FADD (
    CONN_ID        TBIGCODE NOT NULL,
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          TSMALLCODE,
    W_PLACE        TSMALLCODE,
    W_R            SMALLINT,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    WDAY           DECIMAL(12,2),
    WCLOCK         DECIMAL(12,2),
    FOND           TSMALLCODE,
    VYPL           TSMALLCODE,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK,
    NEED           SMALLINT
);

CREATE TABLE TB_TMP_FCN (
    CONN_ID        TBIGCODE NOT NULL,
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    MONTH_VY       SMALLINT NOT NULL,
    YEAR_VY        SMALLINT NOT NULL,
    SHIFRSTA       SMALLINT,
    KOD            SMALLINT,
    SUMMA          DECIMAL(12,2),
    PRIM           INTEGER,
    PRIM_1         VARCHAR(30),
    DEJA_COUNTED   SMALLINT,
    FLOW_SUMMA     DECIMAL(15,2),
    LIMIT_SUMMA    DECIMAL(15,2),
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK,
    AUTOMATIC      TSMALLCODE,
    ID             TBIGCODE
);

CREATE TABLE TB_TMP_FUD (
    CONN_ID        TBIGCODE NOT NULL,
    SHIFRID        INTEGER NOT NULL,
    SHIFRIDPERSON  INTEGER NOT NULL,
    TABNO          SMALLINT NOT NULL,
    W_PLACE        SMALLINT,
    W_R            SMALLINT,
    SHIFRGRU       SMALLINT,
    SHIFRKAT       SMALLINT,
    SHIFRSTA       SMALLINT,
    MONTH_ZA       SMALLINT NOT NULL,
    YEAR_ZA        SMALLINT NOT NULL,
    MONTH_VY       SMALLINT,
    YEAR_VY        SMALLINT,
    SUMMA          DECIMAL(12,2),
    VYPL           SMALLINT,
    SCH            VARCHAR(8),
    SHIFRWRK       SMALLINT,
    DATEWRK        TDATEWRK,
    NEED           TSMALLCODE
);

CREATE TABLE TB_TMP_P4T7 (
    TABNO      INTEGER,
    SUM_TOTAL  DECIMAL(15,2),
    SUM_MAX    DECIMAL(15,2),
    SUM_INS    DECIMAL(15,2),
    PAY_YEAR   INTEGER,
    PAY_MNTH   INTEGER,
    PAY_CODE   INTEGER
);

CREATE TABLE TB_TMP_PAR_SWOD (
    CONN_ID  TBIGCODE NOT NULL,
    "TYPE"   TSMALLCODE,
    SHIFR    TSMALLCODE
);

CREATE TABLE TB_TMP_PERSON (
    CONN_ID     TBIGCODE NOT NULL,
    SHIFRID     INTEGER NOT NULL,
    TABNO       INTEGER,
    FIO         CHAR(30),
    DOLG        VARCHAR(50),
    MONTHVY     SMALLINT,
    YEARVY      SMALLINT,
    W_R         SMALLINT,
    SHIFRGRU    SMALLINT,
    SHIFRKAT    SMALLINT,
    M_O_R       INTEGER,
    N_TEMY      CHAR(10),
    WID_OPLATY  SMALLINT,
    MODE        SMALLINT,
    FROMPODR    SMALLINT,
    PODOH       INTEGER,
    MALO        INTEGER,
    PROF        SMALLINT,
    MAIN        SMALLINT,
    STATE       SMALLINT,
    AUTOMATIC   INTEGER,
    START_DAY   INTEGER,
    PENS        INTEGER,
    BANK        INTEGER,
    NAL_CODE    CHAR(10),
    OKLAD       NUMERIC(15,2),
    W_PLACE     SMALLINT,
    SHIFRWRK    SMALLINT,
    DATEWRK     TDATEWRK,
    RAZRJAD     SMALLINT
);

CREATE TABLE TB_TMP_T07 (
    MODE        INTEGER,
    SHIFRIDMST  INTEGER,
    YEARZA      INTEGER,
    MONTHZA     INTEGER
);

CREATE TABLE TB_TMP_TABEL (
    CONN_ID  INTEGER,
    SHIFRID  INTEGER,
    DAYNO    SMALLINT,
    CODE     SMALLINT
);

CREATE TABLE TB_TOROP_PR (
    SHIFRDOL      INTEGER NOT NULL,
    NAMEDOL       VARCHAR(100),
    SUMMAPRE      DECIMAL(15,2),
    SUMMANADB     DECIMAL(15,2),
    SUMMAPREVNE   TSUMMAPERSON,
    SUMMANADBVNE  TSUMMAPERSON
);

CREATE TABLE TB_VYPL_87 (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRIDNDB  TBIGCODE,
    SHIFRIDKAD  TBIGCODE NOT NULL,
    TABNO       TBIGCODE NOT NULL,
    YEARZA      TSMALLCODE,
    MONTHZA     TSMALLCODE,
    YEARVY      TSMALLCODE,
    MONTHVY     TSMALLCODE,
    SHIFRSTA    TSMALLCODE,
    SUMMA       TSUMMAPERSON,
    VYPLACHENO  TSMALLCODE,
    ISUWOLEN    TSMALLCODE,
    VYPLKASSA   TSMALLCODE
);

CREATE TABLE TB_VYPL_PLT_87 (
    SHIFRID      TBIGCODE NOT NULL,
    FIO          VARCHAR(80),
    NOMERVYPL    TBIGCODE,
    SHIFRIDVYPL  TBIGCODE,
    SHIFRIDNDB   TBIGCODE,
    SHIFRIDKAD   TBIGCODE NOT NULL,
    TABNO        TBIGCODE NOT NULL,
    YEARZA       TSMALLCODE,
    MONTHZA      TSMALLCODE,
    YEARVY       TSMALLCODE,
    MONTHVY      TSMALLCODE,
    SHIFRSTA     TSMALLCODE,
    SUMMA        TSUMMAPERSON,
    VYPLACHENO   TSMALLCODE,
    ISUWOLEN     TSMALLCODE,
    VYPLKASSA    TSMALLCODE,
    ISPENSIONER  TSMALLCODE
);

CREATE TABLE TB_VYPLR_87 (
    SHIFRID     TBIGCODE NOT NULL,
    SHIFRIDNDB  TBIGCODE,
    SHIFRIDKAD  TBIGCODE NOT NULL,
    TABNO       TBIGCODE NOT NULL,
    YEARZA      TSMALLCODE,
    MONTHZA     TSMALLCODE,
    YEARVY      TSMALLCODE,
    MONTHVY     TSMALLCODE,
    SHIFRSTA    TSMALLCODE,
    SUMMA       TSUMMAPERSON,
    VYPLACHENO  TSMALLCODE,
    ISUWOLEN    TSMALLCODE,
    VYPLKASSA   TSMALLCODE
);

CREATE TABLE TB_WIDY_PODR_SELECTION (
    SHIFRID  TBIGCODE NOT NULL,
    NAME     VARCHAR(128)
);

CREATE TABLE TEST_ADD (
    SHIFR     INTEGER,
    SUMMA     DECIMAL(15,2),
    TABNO     INTEGER,
    NSRV      INTEGER,
    SHIFRGRU  INTEGER,
    SHIFRKAT  INTEGER,
    SHIFRROW  INTEGER,
    SHIFRCOL  INTEGER
);

CREATE TABLE TEST_ADDM (
    SHIFR     INTEGER,
    SUMMA     DECIMAL(15,2),
    TABNO     INTEGER,
    NSRV      INTEGER,
    SHIFRGRU  INTEGER,
    SHIFRKAT  INTEGER,
    SHIFRROW  INTEGER,
    SHIFRCOL  INTEGER
);

CREATE TABLE TMP_BOLN_RES (
    CONNID       INTEGER NOT NULL,
    SHIFRID      TBIGCODE,
    SHIFRIDBOLN  TBIGCODE,
    SHIFRSTA     TSMALLCODE,
    B_DAY        TSMALLCODE,
    MONTH_ZA     TMONTH,
    YEAR_ZA      TYEAR,
    SUMMA_B_BUD  TSUMMAPERSON,
    SUMMA_B_VNE  TSUMMAPERSON,
    SUMMA_B_GN   TSUMMAPERSON,
    SUMMA_B_NIS  TSUMMAPERSON,
    SHIFRIDTMP   SMALLINT NOT NULL
);

CREATE TABLE TMP_BOLN_SUMMY (
    CONNID       INTEGER NOT NULL,
    SHIFRID      INTEGER,
    SHIFRIDBOLN  INTEGER,
    SEL          TSMALLCODE,
    MONTH_ZA     TMONTH,
    YEAR_ZA      TYEAR,
    SUMMA_BUD    TSUMMAPERSON,
    SUMMA_VNE    TSUMMAPERSON,
    SUMMA_GN     TSUMMAPERSON,
    SUMMA_NIS    TSUMMAPERSON,
    OKLAD_M      TSUMMAPERSON,
    DAYS         TSMALLCODE,
    GRAPHIC_DAY  TSMALLCODE,
    KOEF         TMEANDAYSUMMA,
    SHIFRIDTMP   SMALLINT NOT NULL,
    MANUAL_CALC  TSMALLCODE
);

CREATE TABLE TMP_BOLNA (
    CONNID            INTEGER NOT NULL,
    SHIFRID           TBIGCODE,
    SHIFRIDBOLN       TBIGCODE,
    SHIFRIDBOLNSUMMY  TBIGCODE,
    W_PLACE           TSMALLCODE,
    W_R               TSMALLCODE,
    SHIFRGRU          TSMALLCODE,
    SHIFRKAT          TSMALLCODE,
    SHIFRSTA          TSMALLCODE,
    MONTH_ZA          TMONTH,
    YEAR_ZA           TYEAR,
    MONTH_VY          TMONTH,
    YEAR_VY           TYEAR,
    SUMMA             TSUMMAPERSON,
    VYPL              TSMALLCODE,
    MARKED            TSMALLCODE,
    ID_CLAR           INTEGER,
    SHIFRIDTMP        INTEGER NOT NULL
);

CREATE TABLE TMP_OTP_ADD (
    CONNID         INTEGER,
    SHIFRID        TBIGCODE,
    SHIFRIDOTP     TBIGCODE,
    SHIFRIDOTPSUM  TBIGCODE,
    W_PLACE        TSMALLCODE,
    SHIFRGRU       TSMALLCODE,
    SHIFRKAT       TSMALLCODE,
    SHIFRSTA       TSMALLCODE,
    MONTH_ZA       TMONTH,
    YEAR_ZA        TYEAR,
    MONTH_VY       TMONTH,
    YEAR_VY        TYEAR,
    SUMMA          TSUMMAPERSON,
    DAYS           TSMALLCODE,
    FOND           TSMALLCODE,
    VYPL           TSMALLCODE,
    SEL            TSMALLCODE,
    ID_CLAR        INTEGER,
    TABNO          INTEGER,
    W_R            SMALLINT,
    SHIFRIDTMP     INTEGER NOT NULL
);

CREATE TABLE TMP_OTP_RES (
    CONNID         INTEGER,
    SHIFRID        TBIGCODE,
    SHIFRIDOTP     TBIGCODE,
    SHIFRSTA       TSMALLCODE NOT NULL,
    O_DAY          TSMALLCODE,
    MONTH_ZA       TMONTH NOT NULL,
    YEAR_ZA        TYEAR NOT NULL,
    SUMMA_O_BUD    TSUMMAPERSON,
    SUMMA_O_VNE    TSUMMAPERSON,
    SUMMA_O_GN     TSUMMAPERSON,
    SUMMA_O_NIS    TSUMMAPERSON,
    SHIFRIDTMP     INTEGER NOT NULL,
    NEED_PERE_BUD  TSMALLCODE,
    NEED_PERE_VNE  TSMALLCODE,
    NEED_PERE_GN   TSMALLCODE,
    NEED_PERE_NIS  TSMALLCODE,
    DATA_PERE_BUD  TDATE,
    DATA_PERE_VNE  TDATE,
    DATA_PERE_GN   TDATE,
    DATA_PERE_NIS  TDATE
);

CREATE TABLE TMP_OTP_SUMMY (
    CONNID           INTEGER,
    SHIFRID          TBIGCODE,
    SHIFRIDOTP       TBIGCODE,
    SEL              TSMALLCODE NOT NULL,
    MONTH_ZA         TMONTH NOT NULL,
    YEAR_ZA          TYEAR NOT NULL,
    SUMMA_BUD        TSUMMAPERSON,
    SUMMA_VNE        TSUMMAPERSON,
    SUMMA_GN         TSUMMAPERSON,
    SUMMA_NIS        TSUMMAPERSON,
    OKLAD_M          TSUMMAPERSON,
    DAY_WORK         TSMALLCODE,
    KOEF             TMEANDAYSUMMA,
    DAY_KALEND       TSMALLCODE,
    SHIFRIDTMP       INTEGER NOT NULL,
    MANUAL_CALC      TSMALLCODE,
    DAY_KALEND_WORK  TSMALLCODE
);

CREATE TABLE TMP_PODR (
    SHIFRPOD  TBIGCODE NOT NULL
);

CREATE TABLE VYPL (
    SHIFRIDNDB  INTEGER NOT NULL,
    SHIFRIDKAD  INTEGER NOT NULL,
    TABNO       INTEGER NOT NULL,
    YEARZA      INTEGER NOT NULL,
    MONTHZA     INTEGER NOT NULL,
    YEARVY      INTEGER NOT NULL,
    MONTHVY     INTEGER NOT NULL,
    SHIFRSTA    INTEGER NOT NULL,
    SUMMA       NUMERIC(13,2) NOT NULL,
    VYPLACHENO  INTEGER NOT NULL,
    ISUWOLEN    INTEGER NOT NULL,
    VYPLKASSA   INTEGER NOT NULL
);

CREATE TABLE VYPLT (
    SHIFRIDNDB  INTEGER NOT NULL,
    SHIFRIDKAD  INTEGER NOT NULL,
    TABNO       INTEGER NOT NULL,
    YEARZA      INTEGER NOT NULL,
    MONTHZA     INTEGER NOT NULL,
    YEARVY      INTEGER NOT NULL,
    MONTHVY     INTEGER NOT NULL,
    SHIFRSTA    INTEGER NOT NULL,
    SUMMA       DOUBLE PRECISION NOT NULL,
    VYPLACHENO  INTEGER NOT NULL,
    ISUWOLEN    INTEGER NOT NULL,
    VYPLKASSA   INTEGER NOT NULL
);



/******************************************************************************/
/***                                 Views                                  ***/
/******************************************************************************/


/* View: LERA */
CREATE VIEW LERA(
    TABNO,
    S)
AS
SELECT tabno,sum(summa) FROM test_add WHERE SHIFRgru=11
group by tabno
;



/* View: MEMLERAUWP */
CREATE VIEW MEMLERAUWP(
    TABNO,
    SUMMA)
AS
SELECT tabno,sum(summa) as s FROM test_addm WHERE SHIFRgru=11  and shifrkat=2 and shifrcol=1105
group by tabno
;



/* View: NACH_FOR_P */
CREATE VIEW NACH_FOR_P(
    TABNO,
    S)
AS
select tabno,sum(summa) from fadd join shifr on
fadd.shifrsta=shifr.shifr
where podoh>0 and month_vy=9 and year_vy=2005
group by tabno
;




/******************************************************************************/
/***                           Check constraints                            ***/
/******************************************************************************/

ALTER TABLE TB_PAR_INDEX ADD CONSTRAINT CHK1_TB_PAR_INDEX check (PROCIND BETWEEN 0 and 1);
ALTER TABLE TB_PAR_INDEX ADD CONSTRAINT FK_TB_SBS_SAD_TABLE_1 CHECK(PROCIND BETWEEN 0 and 1);


/******************************************************************************/
/***                           Unique constraints                           ***/
/******************************************************************************/

ALTER TABLE TMP_BOLNA ADD CONSTRAINT UNQ1_TMP_BOLNA UNIQUE (SHIFRIDTMP);
ALTER TABLE TMP_BOLN_SUMMY ADD CONSTRAINT UNQ1_TMP_BOLN_SUMMY UNIQUE (SHIFRIDTMP);


/******************************************************************************/
/***                              Primary keys                              ***/
/******************************************************************************/

ALTER TABLE ALIMENTY ADD CONSTRAINT PK_ALIMENTY PRIMARY KEY (SHIFR);
ALTER TABLE BOLN ADD PRIMARY KEY (SHIFRID);
ALTER TABLE BOLNA ADD CONSTRAINT PK_BOLNA PRIMARY KEY (SHIFRID);
ALTER TABLE BOLN_RES ADD CONSTRAINT PK_BOLN_RES PRIMARY KEY (SHIFRID);
ALTER TABLE BOLN_SUMMY ADD PRIMARY KEY (SHIFRID);
ALTER TABLE BOL_KOE ADD CONSTRAINT PK_BOL_KOE PRIMARY KEY (SHIFRID);
ALTER TABLE "Categories" ADD CONSTRAINT "PK_Categories" PRIMARY KEY ("Id");
ALTER TABLE FADD ADD CONSTRAINT PK_FADD PRIMARY KEY (SHIFRID);
ALTER TABLE FCN ADD CONSTRAINT PK_FCN PRIMARY KEY (SHIFRID);
ALTER TABLE FUD ADD CONSTRAINT PK_FUD PRIMARY KEY (SHIFRID);
ALTER TABLE GRUPPY ADD CONSTRAINT PK_GRUPPY PRIMARY KEY (SHIFR);
ALTER TABLE GRUPPY_GRU ADD CONSTRAINT PK_GRUPPY_GRU PRIMARY KEY (SHIFR_GRUM);
ALTER TABLE "Goods" ADD CONSTRAINT "PK_Goods" PRIMARY KEY ("Id");
ALTER TABLE IBE$LOG_TABLES ADD PRIMARY KEY (ID);
ALTER TABLE I_GRUPPY ADD CONSTRAINT PK_I_GRUPPY PRIMARY KEY (SHIFRID);
ALTER TABLE I_KAT ADD CONSTRAINT PK_I_KAT PRIMARY KEY (SHIFRID);
ALTER TABLE I_PODR ADD CONSTRAINT PK_I_PODR PRIMARY KEY (SHIFRID);
ALTER TABLE KADRY ADD CONSTRAINT PK_KADRY PRIMARY KEY (TABNO);
ALTER TABLE KATEG ADD CONSTRAINT PK_KATEG PRIMARY KEY (SHIFR);
ALTER TABLE OPERATORY ADD PRIMARY KEY (SHIFRWRK);
ALTER TABLE OTPUSKA ADD CONSTRAINT PK_OTPUSKA PRIMARY KEY (SHIFRID);
ALTER TABLE OTP_ADD ADD CONSTRAINT PK_OTP_ADD PRIMARY KEY (SHIFRID);
ALTER TABLE OTP_RES ADD CONSTRAINT PK_OTP_RES PRIMARY KEY (SHIFRID);
ALTER TABLE OTP_SUMMY ADD CONSTRAINT PK_OTP_SUMMY PRIMARY KEY (SHIFRID);
ALTER TABLE PENSHEA ADD PRIMARY KEY (ID);
ALTER TABLE PERSON ADD CONSTRAINT PK_PERSON PRIMARY KEY (SHIFRID);
ALTER TABLE PODOHTBL ADD CONSTRAINT PK_PODOHTBL PRIMARY KEY (DATEFR);
ALTER TABLE PODR ADD CONSTRAINT PK_PODR PRIMARY KEY (SHIFRPOD);
ALTER TABLE PRAZDNIKI ADD CONSTRAINT PK_PRAZDNIKI PRIMARY KEY (SHIFRID);
ALTER TABLE RAZR ADD CONSTRAINT PK_RAZR PRIMARY KEY (SHIFR, DATEFR);
ALTER TABLE RCLC0110 ADD CONSTRAINT PK_RCLC0110 PRIMARY KEY (SHIFRID);
ALTER TABLE RCLCIND0110 ADD CONSTRAINT PK_RCLCIND0110 PRIMARY KEY (SHIFRID);
ALTER TABLE SHIFR ADD PRIMARY KEY (SHIFR);
ALTER TABLE SHIFRY_IND ADD CONSTRAINT PK_SHIFRY_IND PRIMARY KEY (SHIFRSTA);
ALTER TABLE SSLIMITY ADD CONSTRAINT PK_SSLIMITY PRIMARY KEY (DATEFR);
ALTER TABLE TB_1DF ADD CONSTRAINT PK_TB_1DF PRIMARY KEY (SHIFRID);
ALTER TABLE TB_1DF_ADD ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_1DF_UD ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_APM_ANK ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_APM_IND ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_APM_IND_BODY ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_APM_IND_SS ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_BANKI ADD PRIMARY KEY (ID);
ALTER TABLE TB_BK ADD CONSTRAINT PK_TB_BK PRIMARY KEY (TABNO);
ALTER TABLE TB_BUH_ACCESS ADD CONSTRAINT PK_TB_BUH_ACCESS PRIMARY KEY (SHIFRBUH, SHIFRPOD);
ALTER TABLE TB_BUH_DOP_PODR ADD CONSTRAINT PK_TB_BUH_DOP_PODR PRIMARY KEY (SHIFRBUH, SHIFRPOD);
ALTER TABLE TB_CHAIN ADD CONSTRAINT PK_TB_CHAIN PRIMARY KEY (SHIFRID);
ALTER TABLE TB_CHANGE_RAZR_GRID ADD CONSTRAINT PK_TB_CHANGE_RAZR_GRID PRIMARY KEY (DATEFR);
ALTER TABLE TB_CLASSIFICATOR ADD CONSTRAINT PK_TB_CLASSIFICATOR PRIMARY KEY (ID);
ALTER TABLE TB_C_FADD ADD CONSTRAINT PK_TB_C_FADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_C_FCN ADD CONSTRAINT PK_TB_C_FCN PRIMARY KEY (SHIFRID);
ALTER TABLE TB_C_FUD ADD CONSTRAINT PK_TB_C_FUD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_C_PERSON ADD CONSTRAINT PK_TB_C_PERSON PRIMARY KEY (SHIFRID);
ALTER TABLE TB_C_TABEL ADD CONSTRAINT PK_TB_C_TABEL PRIMARY KEY (SHIFRID);
ALTER TABLE TB_DBL_FOR_INDEX ADD CONSTRAINT PK_TB_DBL_FOR_INDEX PRIMARY KEY (TABNO);
ALTER TABLE TB_DEKR_ECB ADD CONSTRAINT PK_TB_DEKR_ECB PRIMARY KEY (ID);
ALTER TABLE TB_DOGOVORA_GN ADD CONSTRAINT PK_TB_DOGOVORA_GN PRIMARY KEY (ID);
ALTER TABLE TB_DOGOVORA_GN_DET ADD CONSTRAINT PK_TB_DOGOVORA_GN_DET PRIMARY KEY (ID);
ALTER TABLE TB_DOLG ADD CONSTRAINT PK_TB_DOLG PRIMARY KEY (SHIFRDOL);
ALTER TABLE TB_DRFO ADD CONSTRAINT PK_TB_DRFO PRIMARY KEY (TIN);
ALTER TABLE TB_DVV_REP_RECORDS ADD CONSTRAINT PK_TB_DVV_REP_RECORDS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_E04T05C ADD CONSTRAINT PK_TB_E04T05C PRIMARY KEY (SHIFRID);
ALTER TABLE TB_E04T06C ADD CONSTRAINT PK_TB_E04T06C PRIMARY KEY (SHIFRID);
ALTER TABLE TB_ECB ADD CONSTRAINT PK_TB_ECB PRIMARY KEY (DATEFR);
ALTER TABLE TB_GRUPPY_GRU ADD CONSTRAINT PK_TB_GRUPPY_GRU PRIMARY KEY (SHIFRGRUM);
ALTER TABLE TB_IND_CALC_12_7 ADD CONSTRAINT PK_TB_IND_CALC_12_7 PRIMARY KEY (SHIFRID);
ALTER TABLE TB_INFPROC ADD CONSTRAINT PK_TB_INFPROC PRIMARY KEY (DATA);
ALTER TABLE TB_IO_PODR_MONITOR ADD CONSTRAINT PK_TB_IO_PODR_MONITOR PRIMARY KEY (SHIFRPOD);
ALTER TABLE TB_IO_STATISTIC ADD CONSTRAINT PK_TB_IO_STATISTIC PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KADRY_87 ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KINDSOTP ADD PRIMARY KEY (SHIFRKIND);
ALTER TABLE TB_KOMAND ADD CONSTRAINT PK_TB_KOMAND PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KOMAND_ADD ADD CONSTRAINT PK_TB_KOMAND_ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KOMAND_RES ADD CONSTRAINT PK_TB_KOMAND_RES PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KOMAND_SUMMY ADD CONSTRAINT PK_TB_KOMAND_SUMMY PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KREDIT_SPR ADD CONSTRAINT PK_TB_KREDIT_SPR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_KREDIT_SPR_PR ADD CONSTRAINT PK_TB_KREDIT_SPR_PR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_CONTRACTPED ADD CONSTRAINT PK_TB_K_CONTRACTPED PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_DECANY ADD CONSTRAINT PK_TB_K_DECANY PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_EXL_SAL ADD CONSTRAINT PK_TB_K_EXL_SAL PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_FACULTETY ADD CONSTRAINT PK_TB_K_FACULTETY PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_KADRY ADD CONSTRAINT PK_TB_K_KADRY PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_KADRYPR ADD CONSTRAINT PK_TB_K_KADRYPR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_KADRY_FAC ADD CONSTRAINT PK_TB_K_KADRY_FAC PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_KAF ADD CONSTRAINT PK_TB_K_KAF PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_K_F ADD CONSTRAINT PK_TB_K_K_F PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_ORDERREC ADD CONSTRAINT PK_TB_K_ORDERREC PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_ORDERRECPR ADD CONSTRAINT PK_TB_K_ORDERRECPR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_ORDERRECTEXT ADD CONSTRAINT PK_TB_K_ORDERRECTEXT PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_ORDERS ADD CONSTRAINT PK_TB_K_ORDERS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_PODR ADD CONSTRAINT PK_TB_K_PODR PRIMARY KEY (SHIFRPOD);
ALTER TABLE TB_K_SHTRASPPED ADD CONSTRAINT PK_TB_K_SHTRASPPED PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_SHTRASPPEDREC ADD CONSTRAINT PK_TB_K_SHTRASPPEDREC PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_UCH_ST_SPR ADD CONSTRAINT PK_TB_K_UCH_ST_SPR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_USZ ADD CONSTRAINT PK_TB_K_USZ PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_WIDNADB ADD CONSTRAINT PK_TB_K_WIDNADB PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_WIDNADBSTW ADD CONSTRAINT PK_TB_K_WIDNADBSTW PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_WIDORDERS ADD CONSTRAINT PK_TB_K_WIDORDERS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_WIDUCHST ADD CONSTRAINT PK_TB_K_WIDUCHST PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_WIDYZASL ADD CONSTRAINT PK_TB_K_WIDYZASL PRIMARY KEY (SHIFRID);
ALTER TABLE TB_K_ZAJAWLPEDSOWM ADD CONSTRAINT PK_TB_K_ZAJAWLPEDSOWM PRIMARY KEY (SHIFRID);
ALTER TABLE TB_MONTH ADD CONSTRAINT PK_TB_MONTH PRIMARY KEY (YEARZA, MONTHZA, DAYNO);
ALTER TABLE TB_MONTHS_HEA ADD CONSTRAINT PK_TB_MONTHS_HEA PRIMARY KEY (DATEFR);
ALTER TABLE TB_MONTHS_PR ADD CONSTRAINT PK_TB_MONTHS_PR PRIMARY KEY (DATEFR, NB_DAY);
ALTER TABLE TB_NADB_87 ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_NADB_87_PR ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_NAME_PODR_SELECTION_DET ADD CONSTRAINT PK_TB_NAME_PODR_SELECTION_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_NEED_87 ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_NOTUKRGROMAD ADD CONSTRAINT PK_TB_NOTUKRGROMAD PRIMARY KEY (TABNO);
ALTER TABLE TB_OTPHELPLIST2011 ADD CONSTRAINT PK_TB_OTPHELPLIST2011 PRIMARY KEY (TABNO);
ALTER TABLE TB_OTPUSK_2012_01 ADD CONSTRAINT PK_TB_OTPUSK_2012_01 PRIMARY KEY (TABNO, W_PLACE);
ALTER TABLE TB_OTPUSK_2012_04 ADD CONSTRAINT PK_TB_OTPUSK_2012_04 PRIMARY KEY (TABNO, W_PLACE);
ALTER TABLE TB_OTP_UHOD ADD CONSTRAINT PK_TB_OTP_UHOD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T05B ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T05B_DET ADD CONSTRAINT PK_TB_P04T05B_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T06B ADD CONSTRAINT PK_TB_P04T06B PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T06B_DET ADD CONSTRAINT PK_TB_P04T06B_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T06B_DET_PENS ADD CONSTRAINT PK_TB_P04T06B_DET_PENS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T07B ADD CONSTRAINT PK_TB_P04T07B PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T07B_DET ADD CONSTRAINT PK_TB_P04T07B_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T07B_DET_PENS ADD CONSTRAINT PK_TB_P04T07B_DET_PENS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_P04T08B ADD CONSTRAINT PK_TB_P04T08B PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PAR_INDEX ADD CONSTRAINT PK_TB_PAR_INDEX PRIMARY KEY (YEARZA, MONTHZA);
ALTER TABLE TB_PERS_PREP ADD CONSTRAINT PK_TB_PERS_PREP PRIMARY KEY (TABNO);
ALTER TABLE TB_PLAN_GRID ADD CONSTRAINT PK_TB_PLAN_GRID PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PLAN_PREM_PERSON ADD CONSTRAINT PK_TB_PLAN_PREM_PERSON PRIMARY KEY (TABNO, Y, M);
ALTER TABLE TB_PLAT_HAT ADD CONSTRAINT PK_TB_PLAT_HAT PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PLAT_PR ADD CONSTRAINT PK_TB_PLAT_PR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PODR_HISTORY ADD CONSTRAINT PK_TB_PODR_HISTORY PRIMARY KEY (SHIFRPOD, DATETO);
ALTER TABLE TB_PODR_SELECTION_LIST ADD CONSTRAINT PK_TB_PODR_SELECTION_LIST PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PREP_UWP_PERS_MONTH ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_PRIKAZY ADD CONSTRAINT PK_TB_PRIKAZY PRIMARY KEY (ID);
ALTER TABLE TB_PRIKAZY_TYP ADD CONSTRAINT PK_TB_PRIKAZY_TYP PRIMARY KEY (ID);
ALTER TABLE TB_PROC_IND_KOE ADD CONSTRAINT PK_TB_PROC_IND_KOE PRIMARY KEY (DATAB);
ALTER TABLE TB_RAZR_PROC ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RAZR_SWOD ADD CONSTRAINT PK_TB_RAZR_SWOD PRIMARY KEY (RAZR);
ALTER TABLE TB_RCLC1301 ADD CONSTRAINT PK_TB_RCLC1301 PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RCLC1301_PR ADD CONSTRAINT PK_TB_RCLC1301_PR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RCLCPOCHAS1301 ADD CONSTRAINT PK_TB_RCLCPOCHAS1301 PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RCLCPOCHAS1301_PR ADD CONSTRAINT PK_TB_RCLCPOCHAS1301_PR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RECALC_PODOH ADD CONSTRAINT PK_TB_RECALC_PODOH PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RECALC_PODOH_DET ADD CONSTRAINT PK_TB_RECALC_PODOH_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_REE_BOLN ADD CONSTRAINT PK_TB_REE_BOLN PRIMARY KEY (SHIFRID);
ALTER TABLE TB_REE_BOLN_DET ADD CONSTRAINT PK_TB_REE_BOLN_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RIGHTS ADD CONSTRAINT PK_TB_RIGHTS PRIMARY KEY (SHIFRID);
ALTER TABLE TB_RUK_FOR_SWOD_PREM ADD CONSTRAINT PK_TB_RUK_FOR_SWOD_PREM PRIMARY KEY (TABNO);
ALTER TABLE TB_SAVED_AWANS_DET ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SAVED_AWANS_HAT ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SBS_PARAM ADD CONSTRAINT PK_TB_SBS_PARAM PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SBS_SAD_TABLE ADD CONSTRAINT PK_TB_SBS_SAD_TABLE PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SBS_SUD_TABLE ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SECRET_TABNO ADD PRIMARY KEY (TABNO);
ALTER TABLE TB_SEL_PAR_PLAT ADD CONSTRAINT PK_TB_SEL_PAR_PLAT PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SHIFR_HISTORY ADD CONSTRAINT PK_TB_SHIFR_HISTORY PRIMARY KEY (SHIFR, DATETO);
ALTER TABLE TB_SPRSBSPRTABLE ADD CONSTRAINT PK_TB_SPRSBSPRTABLE PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SPRSBSTABLE ADD CONSTRAINT PK_TB_SPRSBSTABLE PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SPR_ZARPL ADD CONSTRAINT PK_TB_SPR_ZARPL PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SPR_ZARPL_PR ADD CONSTRAINT PK_TB_SPR_ZARPL_PR PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SV_LESS_MIN_ZP ADD CONSTRAINT PK_TB_SV_LESS_MIN_ZP PRIMARY KEY (ID);
ALTER TABLE TB_SWODY_DET ADD CONSTRAINT PK_TB_SWODY_DET PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SWODY_DET_PERSON_ADD ADD CONSTRAINT PK_TB_SWODY_DET_PERSON_ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_SWODY_HAT ADD CONSTRAINT PK_TB_SWODY_HAT PRIMARY KEY (SHIFRID);
ALTER TABLE TB_TEMY ADD CONSTRAINT PK_TB_TEMY PRIMARY KEY (SHIFRID);
ALTER TABLE TB_TEST_E04 ADD CONSTRAINT PK_TB_TEST_E04 PRIMARY KEY (TABNO);
ALTER TABLE TB_TEST_P04 ADD CONSTRAINT PK_TB_TEST_P04 PRIMARY KEY (TABNO);
ALTER TABLE TB_TOROP_PR ADD CONSTRAINT PK_TB_TOROP_PR PRIMARY KEY (SHIFRDOL);
ALTER TABLE TB_VYPLR_87 ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_VYPL_87 ADD PRIMARY KEY (SHIFRID);
ALTER TABLE TB_WIDY_PODR_SELECTION ADD CONSTRAINT PK_TB_WIDY_PODR_SELECTION PRIMARY KEY (SHIFRID);
ALTER TABLE TMP_PODR ADD CONSTRAINT PK_TMP_PODR PRIMARY KEY (SHIFRPOD);


/******************************************************************************/
/***                              Foreign keys                              ***/
/******************************************************************************/

ALTER TABLE BOLN_RES ADD CONSTRAINT FK_BOLN_RES_1 FOREIGN KEY (SHIFRIDBOLN) REFERENCES BOLN (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE BOLN_SUMMY ADD CONSTRAINT FK_BOLN_SUMMY_1 FOREIGN KEY (SHIFRIDBOLN) REFERENCES BOLN (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_2 FOREIGN KEY (SHIFRKAT) REFERENCES KATEG (SHIFR);
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_3 FOREIGN KEY (SHIFRGRU) REFERENCES GRUPPY (SHIFR);
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_4 FOREIGN KEY (W_PLACE) REFERENCES PODR (SHIFRPOD);
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_5 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE FADD ADD CONSTRAINT FK_FADD_6 FOREIGN KEY (SHIFRSTA) REFERENCES SHIFR (SHIFR);
ALTER TABLE FCN ADD CONSTRAINT FK_FCN_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE FCN ADD CONSTRAINT FK_FCN_2 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE FCN ADD CONSTRAINT FK_FCN_3 FOREIGN KEY (SHIFRGRU) REFERENCES GRUPPY (SHIFR);
ALTER TABLE FUD ADD CONSTRAINT FK_FUD_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE FUD ADD CONSTRAINT FK_FUD_2 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE FUD ADD CONSTRAINT FK_FUD_3 FOREIGN KEY (W_PLACE) REFERENCES PODR (SHIFRPOD);
ALTER TABLE FUD ADD CONSTRAINT FK_FUD_4 FOREIGN KEY (SHIFRKAT) REFERENCES KATEG (SHIFR);
ALTER TABLE FUD ADD CONSTRAINT FK_FUD_5 FOREIGN KEY (SHIFRGRU) REFERENCES GRUPPY (SHIFR);
ALTER TABLE "Goods" ADD CONSTRAINT FK_GOODS FOREIGN KEY ("IdCategory") REFERENCES "Categories" ("Id") ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE I_PODR ADD CONSTRAINT FK_I_PODR_1 FOREIGN KEY (SHIFR_POD) REFERENCES PODR (SHIFRPOD);
ALTER TABLE OTP_RES ADD CONSTRAINT FK_OTP_RES_1 FOREIGN KEY (SHIFRIDOTP) REFERENCES OTPUSKA (SHIFRID);
ALTER TABLE OTP_SUMMY ADD CONSTRAINT FK_OTP_SUMMY_1 FOREIGN KEY (SHIFRIDOTP) REFERENCES OTPUSKA (SHIFRID);
ALTER TABLE PENSPR ADD CONSTRAINT FK_PENSPR_1 FOREIGN KEY (IDPENS) REFERENCES PENSHEA (ID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE PERSON ADD CONSTRAINT FK_PERSON_1 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE PERSON ADD CONSTRAINT FK_PERSON_2 FOREIGN KEY (SHIFRGRU) REFERENCES GRUPPY (SHIFR);
ALTER TABLE PERSON ADD CONSTRAINT FK_PERSON_3 FOREIGN KEY (SHIFRKAT) REFERENCES KATEG (SHIFR);
ALTER TABLE PERSON ADD CONSTRAINT FK_PERSON_4 FOREIGN KEY (M_O_R) REFERENCES PODR (SHIFRPOD);
ALTER TABLE PERSON ADD CONSTRAINT FK_PERSON_6 FOREIGN KEY (W_PLACE) REFERENCES PODR (SHIFRPOD);
ALTER TABLE TABEL ADD CONSTRAINT FK_TABEL FOREIGN KEY (SHIFRID) REFERENCES PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_1DF_ADD ADD CONSTRAINT FK_TB_1DF_ADD_1 FOREIGN KEY (SHIFRID1DF) REFERENCES TB_1DF (SHIFRID);
ALTER TABLE TB_1DF_UD ADD CONSTRAINT FK_TB_1DF_UD_1 FOREIGN KEY (SHIFRID1DF) REFERENCES TB_1DF (SHIFRID);
ALTER TABLE TB_APM_IND ADD CONSTRAINT FK_TB_APM_IND_1 FOREIGN KEY (SHIFRIDANK) REFERENCES TB_APM_ANK (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_BUH_ACCESS ADD CONSTRAINT FK_TB_BUH_ACCESS_1 FOREIGN KEY (SHIFRPOD) REFERENCES PODR (SHIFRPOD);
ALTER TABLE TB_BUH_ACCESS ADD CONSTRAINT FK_TB_BUH_ACCESS_2 FOREIGN KEY (SHIFRBUH) REFERENCES OPERATORY (SHIFRWRK);
ALTER TABLE TB_BUH_DOP_PODR ADD CONSTRAINT FK_TB_BUH_DOP_PODR_1 FOREIGN KEY (SHIFRPOD) REFERENCES PODR (SHIFRPOD);
ALTER TABLE TB_BUH_DOP_PODR ADD CONSTRAINT FK_TB_BUH_DOP_PODR_2 FOREIGN KEY (SHIFRBUH) REFERENCES OPERATORY (SHIFRWRK);
ALTER TABLE TB_C_FADD ADD CONSTRAINT FK_TB_C_FADD_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES TB_C_PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_C_FCN ADD CONSTRAINT FK_TB_C_FCN_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES TB_C_PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_C_FUD ADD CONSTRAINT FK_TB_C_FUD_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES TB_C_PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_C_TABEL ADD CONSTRAINT FK_TB_C_TABEL_1 FOREIGN KEY (SHIFRIDPERSON) REFERENCES TB_C_PERSON (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_DOGOVORA_GN_DET ADD CONSTRAINT FK_TB_DOGOVORA_GN_DET_1 FOREIGN KEY (IDDOG) REFERENCES TB_DOGOVORA_GN (ID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_DOGOVORA_GN_DET ADD CONSTRAINT FK_TB_DOGOVORA_GN_DET_2 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_KOMAND_ADD ADD CONSTRAINT FK_TB_KOMAND_ADD_1 FOREIGN KEY (SHIFRIDKMND) REFERENCES TB_KOMAND (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_KOMAND_ADD ADD CONSTRAINT FK_TB_KOMAND_ADD_2 FOREIGN KEY (SHIFRIDKMNDSUMMY) REFERENCES TB_KOMAND_SUMMY (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_KOMAND_RES ADD CONSTRAINT FK_TB_KOMAND_RES_1 FOREIGN KEY (SHIFRIDKMND) REFERENCES TB_KOMAND (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_KOMAND_SUMMY ADD CONSTRAINT FK_TB_KOMAND_SUMMY_1 FOREIGN KEY (SHIFRIDKMND) REFERENCES TB_KOMAND (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_KREDIT_SPR_PR ADD CONSTRAINT FK_TB_KREDIT_SPR_PR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_KREDIT_SPR (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_CONTRACTPED ADD CONSTRAINT FK_TB_K_CONTRACTPED_1 FOREIGN KEY (SHIFRIDK) REFERENCES TB_K_KADRY (SHIFRID);
ALTER TABLE TB_K_DECANY ADD CONSTRAINT FK_TB_K_DECANY_1 FOREIGN KEY (SHIFRIDKADRY) REFERENCES TB_K_KADRY (SHIFRID);
ALTER TABLE TB_K_DECANY ADD CONSTRAINT FK_TB_K_DECANY_2 FOREIGN KEY (SHIFRFAC) REFERENCES TB_K_FACULTETY (SHIFRID);
ALTER TABLE TB_K_KADRYPR ADD CONSTRAINT FK_TB_K_KADRYPR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_K_KADRY (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_K_F ADD CONSTRAINT FK_TB_K_K_F_1 FOREIGN KEY (SHIFRKAF) REFERENCES TB_K_KAF (SHIFRID);
ALTER TABLE TB_K_K_F ADD CONSTRAINT FK_TB_K_K_F_2 FOREIGN KEY (SHIFRFAC) REFERENCES TB_K_FACULTETY (SHIFRID);
ALTER TABLE TB_K_ORDERREC ADD CONSTRAINT FK_TB_K_ORDERREC_1 FOREIGN KEY (SHIFRIDORDER) REFERENCES TB_K_ORDERS (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_ORDERRECPR ADD CONSTRAINT FK_TB_K_ORDERRECPR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_K_ORDERREC (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_ORDERRECTEXT ADD CONSTRAINT FK_TB_K_ORDERRECTEXT_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_K_ORDERS (SHIFRID);
ALTER TABLE TB_K_ORDERRECTEXT ADD CONSTRAINT FK_TB_K_ORDERRECTEXT_2 FOREIGN KEY (SHIFRPOD) REFERENCES TB_K_PODR (SHIFRPOD);
ALTER TABLE TB_K_ORDERS ADD CONSTRAINT FK_TB_K_ORDERS_1 FOREIGN KEY (SHIFRIDWIDORD) REFERENCES TB_K_WIDORDERS (SHIFRID);
ALTER TABLE TB_K_SHTRASPPED ADD CONSTRAINT FK_TB_K_SHTRASPPED_1 FOREIGN KEY (SHIFRPOD) REFERENCES TB_K_PODR (SHIFRPOD);
ALTER TABLE TB_K_SHTRASPPED ADD CONSTRAINT FK_TB_K_SHTRASPPED_2 FOREIGN KEY (SHIFRFAC) REFERENCES TB_K_FACULTETY (SHIFRID);
ALTER TABLE TB_K_SHTRASPPEDREC ADD CONSTRAINT FK_TB_K_SHTRASPPEDREC_1 FOREIGN KEY (SHIFRIDOWN) REFERENCES TB_K_SHTRASPPED (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_UCH_ST_SPR ADD CONSTRAINT FK_TB_K_UCH_ST_SPR_1 FOREIGN KEY (SHIFRWIDUCHST) REFERENCES TB_K_WIDUCHST (SHIFRID);
ALTER TABLE TB_K_WIDNADBSTW ADD CONSTRAINT FK_TB_K_WIDNADBSTW_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_K_WIDNADB (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_K_ZAJAWLPEDSOWM ADD CONSTRAINT FK_TB_K_ZAJAWLPEDSOWM_1 FOREIGN KEY (SHIFRIDK) REFERENCES TB_K_KADRY (SHIFRID);
ALTER TABLE TB_NADB_87_PR ADD FOREIGN KEY (SHIFRIDNADB) REFERENCES TB_NADB_87 (SHIFRID) ON DELETE CASCADE;
ALTER TABLE TB_NAME_PODR_SELECTION_DET ADD CONSTRAINT FK_TB_NAME_PODR_SELECTION_DET_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_NAME_PODR_SELECTION_DET (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_OTP_UHOD ADD CONSTRAINT FK_TB_OTP_UHOD_1 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE TB_P04T05B_DET ADD CONSTRAINT FK_TB_P04T05B_DET_1 FOREIGN KEY (SHIFRIDMST) REFERENCES TB_P04T05B (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_P04T06B_DET ADD CONSTRAINT FK_TB_P04T06B_DET_1 FOREIGN KEY (SHIFRIDMST) REFERENCES TB_P04T06B (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_P04T06B_DET_PENS ADD CONSTRAINT FK_TB_P04T06B_DET_PENS_1 FOREIGN KEY (SHIFRIDMST) REFERENCES TB_P04T06B (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_P04T07B_DET ADD CONSTRAINT FK_TB_P04T07B_DET_1 FOREIGN KEY (SHIFRIDMST) REFERENCES TB_P04T07B (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_P04T07B_DET_PENS ADD CONSTRAINT FK_TB_P04T07B_DET_PENS_1 FOREIGN KEY (SHIFRIDMST) REFERENCES TB_P04T07B (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_PLAT_PR ADD CONSTRAINT FK_TB_PLAT_PR_1 FOREIGN KEY (SHIFRIDPLAT) REFERENCES TB_PLAT_HAT (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_PODR_SELECTION_LIST ADD CONSTRAINT FK_TB_PODR_SELECTION_LIST_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_NAME_PODR_SELECTION_DET (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_PODR_SELECTION_LIST ADD CONSTRAINT FK_TB_PODR_SELECTION_LIST_2 FOREIGN KEY (SHIFRPOD) REFERENCES PODR (SHIFRPOD) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_PRIKAZY ADD CONSTRAINT FK_TB_PRIKAZY_1 FOREIGN KEY (TABNO) REFERENCES KADRY (TABNO);
ALTER TABLE TB_PRIKAZY ADD CONSTRAINT FK_TB_PRIKAZY_2 FOREIGN KEY (SHIFRIDTYP) REFERENCES TB_PRIKAZY_TYP (ID) ON UPDATE CASCADE;
ALTER TABLE TB_RCLC1301_PR ADD CONSTRAINT FK_TB_RCLC1301_PR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_RCLC1301 (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_RCLCPOCHAS1301_PR ADD CONSTRAINT FK_TB_RCLCPOCHAS1301_PR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_RCLCPOCHAS1301 (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_RECALC_PODOH_DET ADD CONSTRAINT FK_TB_RECALC_PODOH_DET_1 FOREIGN KEY (SHIFRIDOWN) REFERENCES TB_RECALC_PODOH (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_REE_BOLN_DET ADD CONSTRAINT FK_TB_REE_BOLN_DET_1 FOREIGN KEY (SHIFRIDREE) REFERENCES TB_REE_BOLN (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SAVED_AWANS_DET ADD CONSTRAINT FK_TB_SAVED_AWANS_DET_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_SAVED_AWANS_HAT (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SBS_SUD_TABLE ADD CONSTRAINT FK_TB_SBS_SUD_TABLE_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_SPRSBSPRTABLE (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SPRSBSPRTABLE ADD CONSTRAINT FK_TB_SPRSBSPRTABLE_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_SPRSBSTABLE (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SPR_ZARPL_PR ADD CONSTRAINT FK_TB_SPR_ZARPL_PR_1 FOREIGN KEY (SHIFRIDOWNER) REFERENCES TB_SPR_ZARPL (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SWODY_DET ADD CONSTRAINT FK_TB_SWODY_DET_1 FOREIGN KEY (SHIFRIDSWOD) REFERENCES TB_SWODY_HAT (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_SWODY_DET_PERSON_ADD ADD CONSTRAINT FK_TB_SWODY_DET_PERSON_ADD_1 FOREIGN KEY (SHIFRIDSWOD) REFERENCES TB_SWODY_HAT (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_TEMY_KAF ADD CONSTRAINT FK_TB_TEMY_KAF_1 FOREIGN KEY (SHIFRIDTEMY) REFERENCES TB_TEMY (SHIFRID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE TB_VYPLR_87 ADD FOREIGN KEY (SHIFRIDKAD) REFERENCES TB_KADRY_87 (SHIFRID) ON DELETE CASCADE;


/******************************************************************************/
/***                                Indices                                 ***/
/******************************************************************************/

CREATE INDEX ALIMENTY_IDX1 ON ALIMENTY (TABNO);
CREATE INDEX BAY_IDX1 ON BAY (SHIFRBUH, SHIFRPOD);
CREATE INDEX BOLN_IDX1 ON BOLN (ID_CLAR);
CREATE INDEX BOLN_IDX2 ON BOLN (TABNO);
CREATE INDEX BOLN_IDX3 ON BOLN (SHIFRIDREB);
CREATE INDEX BOLNA_IDX1 ON BOLNA (ID_CLAR);
CREATE INDEX BOLNA_IDX2 ON BOLNA (SHIFRIDBOLN, SHIFRIDBOLNSUMMY);
CREATE UNIQUE INDEX BOL_KOE_IDX1 ON BOL_KOE (MODE, DATEB, DATEZA);
CREATE INDEX FADD_IDX1 ON FADD (TABNO, YEAR_VY, MONTH_VY);
CREATE INDEX FADD_IDX2 ON FADD (TABNO, YEAR_ZA, MONTH_ZA);
CREATE INDEX FADD_WYM ON FADD (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX FCN_IDX1 ON FCN (TABNO, YEAR_VY, MONTH_VY);
CREATE INDEX FCN_WYM ON FCN (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX FUD_IDX1 ON FUD (TABNO, YEAR_ZA, MONTH_ZA, YEAR_VY, MONTH_VY, SHIFRSTA);
CREATE INDEX FUD_WYM ON FUD (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX GRUPPY_GRU_IDX1 ON GRUPPY_GRU (SHIFR_GRUM, IDOWNER);
CREATE INDEX IBE$LOG_BLOB_FIELDS_IDX1 ON IBE$LOG_BLOB_FIELDS (LOG_TABLES_ID);
CREATE INDEX IBE$LOG_FIELDS_IDX1 ON IBE$LOG_FIELDS (LOG_TABLES_ID);
CREATE INDEX IBE$LOG_KEYS_IDX1 ON IBE$LOG_KEYS (LOG_TABLES_ID);
CREATE INDEX IBE$SCRIPTS_BY_ACTION_ID ON IBE$SCRIPTS (IBE$SCRIPT_ACTION_ID);
CREATE UNIQUE INDEX IBE$SCRIPTS_BY_NAME ON IBE$SCRIPTS (IBE$SCRIPT_NAME);
CREATE INDEX OTPUSKA_IDX1 ON OTPUSKA (ID_CLAR);
CREATE INDEX OTPUSKA_IDX2 ON OTPUSKA (TABNO);
CREATE INDEX OTP_ADD_IDX1 ON OTP_ADD (ID_CLAR, TABNO);
CREATE INDEX OTP_ADD_IDX2 ON OTP_ADD (SHIFRIDOTP);
CREATE INDEX PERSON_IDX2 ON PERSON (TABNO, YEARVY, MONTHVY);
CREATE INDEX RCLC0110_IDX1 ON RCLC0110 (Y, M, TABNO);
CREATE INDEX RCLC0110_IDX2 ON RCLC0110 (TABNO, Y, M);
CREATE INDEX RCLCIND0110_IDX1 ON RCLCIND0110 (TABNO, Y, M);
CREATE INDEX RCLCIND0110_IDX2 ON RCLCIND0110 (Y, M, TABNO);
CREATE INDEX SSLIMITY_IDX1 ON SSLIMITY (DATEFR);
CREATE INDEX TB_1DF_IDX1 ON TB_1DF (TABNO, Y, M);
CREATE INDEX TB_1DF_IDX2 ON TB_1DF (Y, M, TABNO);
CREATE INDEX TB_APM_ANK_IDX1 ON TB_APM_ANK (TABNO);
CREATE INDEX TB_APM_IND_BODY_IDX1 ON TB_APM_IND_BODY (SHIFRIDIND);
CREATE INDEX TB_APM_IND_BODY_IDX2 ON TB_APM_IND_BODY (SHIFRIDIND, ISPENSIONER);
CREATE INDEX TB_APM_IND_BODY_IDX3 ON TB_APM_IND_BODY (SHIFRIDIND, ISINVALID);
CREATE INDEX TB_CHAIN_IDX1 ON TB_CHAIN (TABNO, YEARVY, MONTHVY);
CREATE INDEX TB_CHAIN_IDX2 ON TB_CHAIN (TABNO, YEARVY, MONTHVY, W_PLACE, W_R);
CREATE INDEX TB_C_FADD_WYM ON TB_C_FADD (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX TB_C_FCN_WYM ON TB_C_FCN (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX TB_C_FUD_WYM ON TB_C_FUD (W_PLACE, YEAR_VY, MONTH_VY);
CREATE INDEX TB_C_PERSON_WYM ON TB_C_PERSON (W_PLACE, YEARVY, MONTHVY);
CREATE INDEX TB_E04T05C_IDX1 ON TB_E04T05C (TABNO, YEARVY, MONTHVY);
CREATE INDEX TB_E04T05C_IDX2 ON TB_E04T05C (YEARVY, MONTHVY);
CREATE INDEX TB_E04T06C_IDX1 ON TB_E04T06C (YEARVY, MONTHVY, TABNO);
CREATE INDEX TB_E04T06C_IDX2 ON TB_E04T06C (TABNO, YEARVY, MONTHVY, KD_PTV);
CREATE INDEX TB_E04T06C_IDX3 ON TB_E04T06C (TABNO, YEARVY, MONTHVY, ZO, EXP, PAY_TP, PAY_YEAR, PAY_MNTH);
CREATE UNIQUE INDEX TB_IND_CALC_12_7_IDX1 ON TB_IND_CALC_12_7 (TABNO, YEARZA, MONTHZA);
CREATE INDEX TB_IO_STATISTIC_IDX1 ON TB_IO_STATISTIC (NSRV, NMES_THIS, DATEWRK);
CREATE INDEX TB_KADRY_87_IDX1 ON TB_KADRY_87 (TABNO);
CREATE INDEX TB_KOMAND_IDX2 ON TB_KOMAND (TABNO);
CREATE INDEX TB_KOMAND_IDX3 ON TB_KOMAND (SHIFRIDREKMD);
CREATE UNIQUE INDEX TB_K_KADRY_IDX1 ON TB_K_KADRY (TABNO);
CREATE INDEX TB_K_ORDERRECTEXT_IDX1 ON TB_K_ORDERRECTEXT (SHIFRIDSHTRASPREC);
CREATE INDEX TB_P04T05B_IDX1 ON TB_P04T05B (YEARVY, MONTHVY);
CREATE INDEX TB_P04T06B_IDX1 ON TB_P04T06B (YEARVY, MONTHVY);
CREATE INDEX TB_P04T06B_IDX2 ON TB_P04T06B (TABNO, YEARVY, MONTHVY);
CREATE INDEX TB_P04T07B_IDX1 ON TB_P04T07B (YEARVY, MONTHVY);
CREATE INDEX TB_P04T07B_IDX2 ON TB_P04T07B (TABNO, YEARVY, MONTHVY);
CREATE INDEX TB_P04T08B_IDX1 ON TB_P04T08B (YEARVY, MONTHVY);
CREATE INDEX TB_P04T08B_IDX2 ON TB_P04T08B (TABNO, YEARVY, MONTHVY);
CREATE INDEX TB_PREP_UWP_PERS_MONTH_IDX1 ON TB_PREP_UWP_PERS_MONTH (YEARVY, MONTHVY, TABNO);
CREATE INDEX TB_RCLC1301_IDX1 ON TB_RCLC1301 (Y, M, TABNO);
CREATE INDEX TB_RCLC1301_IDX2 ON TB_RCLC1301 (TABNO, Y, M);
CREATE INDEX TB_REE_BOLN_DET_IDX1 ON TB_REE_BOLN_DET (SHIFRIDBOLN);
CREATE INDEX TB_SPRSBSTABLE_IDX1 ON TB_SPRSBSTABLE (TABNO, YEAR_VY, MONTH_VY);
CREATE INDEX TB_SPR_ZARPL_PR_IDX1 ON TB_SPR_ZARPL_PR (SHIFRIDOWNER, PERIOD);
CREATE INDEX TB_SV_LESS_MIN_ZP_IDX1 ON TB_SV_LESS_MIN_ZP (Y, M, TABNO);
CREATE INDEX TB_SWODY_DET_IDX1 ON TB_SWODY_DET (SHIFRIDSWOD, SHIFRSTA, SHIFRPOD, PERIOD);
CREATE INDEX TB_TMP_BOL_PRINT_IDX1 ON TB_TMP_BOL_PRINT (CONN_ID);
CREATE INDEX TB_TMP_PAR_SWOD_IDX1 ON TB_TMP_PAR_SWOD (CONN_ID, "TYPE");
CREATE INDEX TMP_BOLN_SUMMY_IDX1 ON TMP_BOLN_SUMMY (CONNID, YEAR_ZA, MONTH_ZA);
CREATE INDEX TMP_OTP_ADD_IDX1 ON TMP_OTP_ADD (CONNID);
CREATE INDEX TMP_OTP_RES_IDX1 ON TMP_OTP_RES (CONNID);
CREATE INDEX TMP_OTP_SUMMY_IDX1 ON TMP_OTP_SUMMY (CONNID);


/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/



SET TERM ^ ;



/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/



/* Trigger: AI_CATEGORIES_ID */
CREATE TRIGGER AI_CATEGORIES_ID FOR "Categories"
ACTIVE BEFORE INSERT POSITION 0
AS
begin
IF (NEW."Id" IS NULL) THEN
NEW."Id" = GEN_ID(Categories_Id_GEN, 1);
  /* Trigger text */
end
^

/* Trigger: AI_GOODS_ID */
CREATE TRIGGER AI_GOODS_ID FOR "Goods"
ACTIVE BEFORE INSERT POSITION 0
AS
begin
IF (NEW."Id" IS NULL) THEN
NEW."Id" = GEN_ID(Goods_Id_GEN, 1);
end
^

/* Trigger: ALIMENTY_BI99 */
CREATE TRIGGER ALIMENTY_BI99 FOR ALIMENTY
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
     SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
     New.ShifrWrk = ShifrWrk;
     New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: BOLNA_BI99 */
CREATE TRIGGER BOLNA_BI99 FOR BOLNA
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null or New.ShifrId=0) then
    New.ShifrId=gen_id(gbolna, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: BOLN_BD0 */
CREATE TRIGGER BOLN_BD0 FOR BOLN
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from boln_res where boln_res.shifridboln=old.shifrid;
     delete from boln_summy where boln_summy.shifridboln=old.shifrid;
     delete from bolna where bolna.shifridboln=old.shifrid;

  /* Trigger text */
end
^

/* Trigger: BOLN_BI99 */
CREATE TRIGGER BOLN_BI99 FOR BOLN
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (inserting) then
 if (NEW.ShifrId is Null or NEW.ShifrId=0) then
     New.ShifrId=gen_id(gboln, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: BOLN_RES_BI99 */
CREATE TRIGGER BOLN_RES_BI99 FOR BOLN_RES
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null or New.ShifrId=0) then
    New.ShifrId=gen_id(gboln_RES, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: BOLN_SUMMY_BI99 */
CREATE TRIGGER BOLN_SUMMY_BI99 FOR BOLN_SUMMY
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null or New.ShifrId=0) then
     New.ShifrId=gen_id(gboln_summy, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: BOL_KOE_BI99 */
CREATE TRIGGER BOL_KOE_BI99 FOR BOL_KOE
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if ((new.shifrid is null) or (new.shifrid<1) ) then new.shifrid=gen_id(g_koe_boln_otp,1);
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: BOL_KOE_BU99 */
CREATE TRIGGER BOL_KOE_BU99 FOR BOL_KOE
ACTIVE BEFORE UPDATE POSITION 99
AS
declare variable shifrwrk integer;
begin
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
  /* Trigger text */
end
^

/* Trigger: FADD_BI99 */
CREATE TRIGGER FADD_BI99 FOR FADD
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(gadd, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: FCN_BI99 */
CREATE TRIGGER FCN_BI99 FOR FCN
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(gcn, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: FUD_BI99 */
CREATE TRIGGER FUD_BI99 FOR FUD
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(gud, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: GRUPPY_GRU_BIU99 */
CREATE TRIGGER GRUPPY_GRU_BIU99 FOR GRUPPY_GRU
ACTIVE BEFORE INSERT OR UPDATE POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: IBE$LOG_TABLES_BD */
CREATE TRIGGER IBE$LOG_TABLES_BD FOR IBE$LOG_TABLES
ACTIVE BEFORE DELETE POSITION 0
AS
BEGIN
  DELETE FROM IBE$LOG_FIELDS WHERE LOG_TABLES_ID = OLD.ID;
  DELETE FROM IBE$LOG_BLOB_FIELDS WHERE LOG_TABLES_ID = OLD.ID;
  DELETE FROM IBE$LOG_KEYS WHERE LOG_TABLES_ID = OLD.ID;
END
^

/* Trigger: I_GRUPPY_BI0 */
CREATE TRIGGER I_GRUPPY_BI0 FOR I_GRUPPY
ACTIVE BEFORE INSERT POSITION 0
AS
DECLARE VARIABLE ShifrWrk integer;
begin
 if ((new.shifrid is null) or (new.shifrid<1)) then new.shifrid=gen_id(g_i_podr,1);
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
  /* Trigger text */
end
^

/* Trigger: I_GRUPPY_BIU99 */
CREATE TRIGGER I_GRUPPY_BIU99 FOR I_GRUPPY
ACTIVE BEFORE UPDATE POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: I_KAT_BI0 */
CREATE TRIGGER I_KAT_BI0 FOR I_KAT
ACTIVE BEFORE INSERT OR UPDATE POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if ((new.shifrid is null) or (new.shifrid<1)) then new.shifrid=gen_id(g_i_podr,1);
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: I_PODR_BI99 */
CREATE TRIGGER I_PODR_BI99 FOR I_PODR
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if ((new.shifrid is null) or (new.shifrid<1)) then new.shifrid=gen_id(g_i_podr,1);
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: I_PODR_BU99 */
CREATE TRIGGER I_PODR_BU99 FOR I_PODR
ACTIVE BEFORE UPDATE POSITION 99
AS
 declare variable shifrwrk integer;
BEGIN
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: KADRY_BI99 */
CREATE TRIGGER KADRY_BI99 FOR KADRY
ACTIVE BEFORE INSERT OR UPDATE POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: OTPUSKA_BD0 */
CREATE TRIGGER OTPUSKA_BD0 FOR OTPUSKA
ACTIVE BEFORE DELETE POSITION 0
AS
begin
      delete from otp_add   where otp_add.shifridotp   = OLD.shifrid;
      delete from otp_res   where otp_res.shifridotp   = OLD.shifrid;
      delete from otp_summy where otp_summy.shifridotp = OLD.shifrid;

  /* Trigger text */
end
^

/* Trigger: OTPUSKA_BI99 */
CREATE TRIGGER OTPUSKA_BI99 FOR OTPUSKA
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null or New.ShifrId=0) then
     New.ShifrId=gen_id(gotpuska, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: OTP_ADD_BI99 */
CREATE TRIGGER OTP_ADD_BI99 FOR OTP_ADD
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId  = gen_id(gotp_add, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK  = CURRENT_TIMESTAMP;
END
^

/* Trigger: OTP_RES_BI99 */
CREATE TRIGGER OTP_RES_BI99 FOR OTP_RES
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(gotp_res, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: OTP_SUMMY_BI99 */
CREATE TRIGGER OTP_SUMMY_BI99 FOR OTP_SUMMY
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(gotp_summy, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: PENSHEA_AI0 */
CREATE TRIGGER PENSHEA_AI0 FOR PENSHEA
ACTIVE AFTER INSERT POSITION 0
AS
 declare variable ShifrId    integer;
 declare variable ShifrIdNew integer;
 declare variable SummaAdd   decimal(15,2);
 declare variable Summafr    decimal(15,2);
 declare variable Summato    decimal(15,2);
 declare variable procpens   decimal(15,2);
begin
     ShifrIdNew = new.id;
     ShifrId = ShifrIdNew-1;
     for
        select b.summaadd,b.summafr,b.summato,b.procpens
               from penspr b
               where b.idpens=:ShifrId
               into  :SummaAdd,:SummaFr,:SummaTo,:procpens
     do
        insert into penspr  (idpens,summaadd,summafr,summato,procpens)
                values(:ShifrIdNew,:summaAdd,:SummaFr,:SummaTo,:procpens);
  /* Trigger text */
end
^

/* Trigger: PENSHEA_BD0 */
CREATE TRIGGER PENSHEA_BD0 FOR PENSHEA
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from penspr where penspr.idpens=old.id;
  /* Trigger text */
end
^

/* Trigger: PENSHEA_BI0 */
CREATE TRIGGER PENSHEA_BI0 FOR PENSHEA
ACTIVE BEFORE INSERT POSITION 0
AS
  declare variable ShifrId integer;
begin
     select max(Id) from penshea into :shifrid;
     if (shifrid is null or shifrid<0 ) then
         ShifrId=0;
     ShifrId=ShifrId+1;
     New.Id=ShifrId;
  /* Trigger text */
end
^

/* Trigger: PERSON_BI99 */
CREATE TRIGGER PERSON_BI99 FOR PERSON
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
 declare variable Tabno integer;
BEGIN
 if (New.Tabno>0 and New.Tabno<20000 and New.Fio Is not Null) then
    begin
         tabno=null;
         select first 1 tabno from kadry where tabno=new.tabno into :Tabno;
         if (Tabno Is Null) then
            insert into kadry (Tabno,Fio) values (New.Tabno,NEW.FIO);
    end
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null) then
    New.ShifrId=Gen_Id(gperson, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: PODR_BI99 */
CREATE TRIGGER PODR_BI99 FOR PODR
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrPod is Null or  New.ShifrPod=0) then
     New.ShifrPod=gen_id(gpodr, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: PRAZDNIKI_BIU99 */
CREATE TRIGGER PRAZDNIKI_BIU99 FOR PRAZDNIKI
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if ((new.shifrid is null) or (new.shifrid<1) ) then new.shifrid=gen_id(g_prazdn,1);
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
end
^

/* Trigger: PRAZDNIKI_BU0 */
CREATE TRIGGER PRAZDNIKI_BU0 FOR PRAZDNIKI
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
 SELECT first 1 ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
  /* Trigger text */
end
^

/* Trigger: RCLC0108_BI0 */
CREATE TRIGGER RCLC0108_BI0 FOR RCLC0108
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
end
^

/* Trigger: RCLC0110_BI0 */
CREATE TRIGGER RCLC0110_BI0 FOR RCLC0110
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
end
^

/* Trigger: RCLC0208_BI0 */
CREATE TRIGGER RCLC0208_BI0 FOR RCLC0208
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
  /* Trigger text */
end
^

/* Trigger: RCLC0308_BI0 */
CREATE TRIGGER RCLC0308_BI0 FOR RCLC0308
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
  /* Trigger text */
end
^

/* Trigger: RCLCIND0110_BI0 */
CREATE TRIGGER RCLCIND0110_BI0 FOR RCLCIND0110
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
end
^

/* Trigger: SHIFR_BI0 */
CREATE TRIGGER SHIFR_BI0 FOR SHIFR
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: SHIFR_BU0 */
CREATE TRIGGER SHIFR_BU0 FOR SHIFR
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable dt date;
begin
 dt=extract(year from current_date)||'-'||extract(month from current_date)||'-01';
 if ((ltrim(rtrim(new.name))<>ltrim(rtrim(old.name))) or
    (ltrim(rtrim(new.shortname))<>ltrim(rtrim(old.shortname)))) then
    begin
         delete from tb_shifr_history where tb_shifr_history.shifr=new.shifr;
         insert into tb_shifr_history (shifr, DateTo, name , shortname, podoh, pens,
                                       ss   , fondz, boln    , otp,   prof,
                                       alim , mode , shifrwrk , datewrk)
                              values  (old.shifr,:dt,old.name,old.shortname,old.podoh,old.pens,
                                       old.ss,old.fondz,old.boln,old.otp,old.prof,
                                       old.alim,old.mode,old.shifrwrk,old.datewrk);
    end
end
^

/* Trigger: TB_1DF_ADD_BI0 */
CREATE TRIGGER TB_1DF_ADD_BI0 FOR TB_1DF_ADD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_1DF_A,1);
  /* Trigger text */
end
^

/* Trigger: TB_1DF_BD0 */
CREATE TRIGGER TB_1DF_BD0 FOR TB_1DF
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     DELETE FROM tb_1df_add WHERE tb_1df_add.shifrid1df=OLD.SHIFRID;
     DELETE FROM tb_1df_Ud WHERE tb_1df_Ud.shifrid1df=OLD.SHIFRID;
  /* Trigger text */
end
^

/* Trigger: TB_1DF_BI0 */
CREATE TRIGGER TB_1DF_BI0 FOR TB_1DF
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_1DF,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_1DF_UD_BI0 */
CREATE TRIGGER TB_1DF_UD_BI0 FOR TB_1DF_UD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_1DF_U,1);
  /* Trigger text */
end
^

/* Trigger: TB_APM_ANK_BD0 */
CREATE TRIGGER TB_APM_ANK_BD0 FOR TB_APM_ANK
ACTIVE BEFORE DELETE POSITION 0
AS
begin
  DELETE FROM tb_apm_ind WHERE tb_apm_ind.shifridank=OLD.SHIFRID;
  /* Trigger text */
end
^

/* Trigger: TB_APM_ANK_BI0 */
CREATE TRIGGER TB_APM_ANK_BI0 FOR TB_APM_ANK
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (NEW.SHIFRID is null or  NEW.SHIFRID<1) then
        NEW.SHIFRID=GEN_ID(G_APM,1);
  /* Trigger text */
end
^

/* Trigger: TB_APM_IND_BD0 */
CREATE TRIGGER TB_APM_IND_BD0 FOR TB_APM_IND
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     DELETE FROM TB_APM_IND_BODY WHERE TB_APM_IND_BODY.shifridind=OLD.shifrid;
     DELETE FROM tb_apm_ind_ss WHERE TB_APM_IND_SS.shifridind=OLD.SHIFRID;
  /* Trigger text */
end
^

/* Trigger: TB_APM_IND_BI0 */
CREATE TRIGGER TB_APM_IND_BI0 FOR TB_APM_IND
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (NEW.SHIFRID is null or New.ShifrID<1 ) then
        NEW.SHIFRID=GEN_ID(G_APM,1);
  /* Trigger text */
end
^

/* Trigger: TB_APM_IND_BODY_BI0 */
CREATE TRIGGER TB_APM_IND_BODY_BI0 FOR TB_APM_IND_BODY
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (NEW.SHIFRID is null or NEW.SHIFRID <1 ) then
     NEW.SHIFRID=GEN_ID(g_apm,1);
  /* Trigger text */
end
^

/* Trigger: TB_APM_IND_SS_BI0 */
CREATE TRIGGER TB_APM_IND_SS_BI0 FOR TB_APM_IND_SS
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     NEW.SHIFRID=GEN_ID(g_apm,1);
end
^

/* Trigger: TB_CHAIN_BI0 */
CREATE TRIGGER TB_CHAIN_BI0 FOR TB_CHAIN
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or (new.Shifrid<1) ) then
        new.shifrid=gen_id(g_chain,1);
  /* Trigger text */
end
^

/* Trigger: TB_C_FADD_BI0 */
CREATE TRIGGER TB_C_FADD_BI0 FOR TB_C_FADD
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(g_c_fadd, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_C_FCN_BI0 */
CREATE TRIGGER TB_C_FCN_BI0 FOR TB_C_FCN
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(g_c_FCN, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_C_FUD_BI0 */
CREATE TRIGGER TB_C_FUD_BI0 FOR TB_C_FUD
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrId=gen_id(g_c_fud, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_C_PERSON_BI0 */
CREATE TRIGGER TB_C_PERSON_BI0 FOR TB_C_PERSON
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
 declare variable Tabno integer;
BEGIN
 if (New.Tabno>0 and New.Tabno<20000 and New.Fio Is not Null) then
    begin
         tabno=null;
         select first 1 tabno from kadry where tabno=new.tabno into :Tabno;
         if (Tabno Is Null) then
            insert into kadry (Tabno,Fio) values (New.Tabno,NEW.FIO);
    end
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null) then
    New.ShifrId=Gen_Id(g_c_p, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_C_TABEL_BI0 */
CREATE TRIGGER TB_C_TABEL_BI0 FOR TB_C_TABEL
ACTIVE BEFORE INSERT POSITION 0
AS
begin
  /* Trigger text */
  new.shifrid=gen_id(g_c_tabel,1);
end
^

/* Trigger: TB_DAYS_BI99 */
CREATE TRIGGER TB_DAYS_BI99 FOR TB_DAYS
ACTIVE BEFORE INSERT OR UPDATE POSITION 99
AS
begin
     if (new.yearza is null) then
         new.yearza=1991;
     if (new.monthza is null) then
         new.monthza=1;
     new.shifridym = new.yearza * 12 + new.monthza;
  /* Trigger text */
end
^

/* Trigger: TB_DEKR_ECB_BI0 */
CREATE TRIGGER TB_DEKR_ECB_BI0 FOR TB_DEKR_ECB
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable id integer;
begin
     select max(id) from tb_dekr_ecb into :id;
     id=coalesce(id,0);
     new.id=id+1;
  /* Trigger text */
end
^

/* Trigger: TB_DVV_REP_RECORDS_BI0 */
CREATE TRIGGER TB_DVV_REP_RECORDS_BI0 FOR TB_DVV_REP_RECORDS
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     new.shifrid=gen_id(g_dvv_rep_rec,1);
  /* Trigger text */
end
^

/* Trigger: TB_E04T05C_BI0 */
CREATE TRIGGER TB_E04T05C_BI0 FOR TB_E04T05C
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_e04t05c,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_E04T05C_BU0 */
CREATE TRIGGER TB_E04T05C_BU0 FOR TB_E04T05C
ACTIVE BEFORE UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
end
^

/* Trigger: TB_E04T06C_BI0 */
CREATE TRIGGER TB_E04T06C_BI0 FOR TB_E04T06C
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_e04t06c,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_E04T06C_BU0 */
CREATE TRIGGER TB_E04T06C_BU0 FOR TB_E04T06C
ACTIVE BEFORE UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_E04T07C_BI0 */
CREATE TRIGGER TB_E04T07C_BI0 FOR TB_E04T07C
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_e04t07c,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_E04T07C_BU0 */
CREATE TRIGGER TB_E04T07C_BU0 FOR TB_E04T07C
ACTIVE BEFORE UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_IND_CALC_12_7_BIU0 */
CREATE TRIGGER TB_IND_CALC_12_7_BIU0 FOR TB_IND_CALC_12_7
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
        if (coalesce(new.shifrid,0)=0) then
         new.shifrid=gen_id(g_i_2012,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
  /* Trigger text */
     new.shifrwrk=:shifrwrk;
end
^

/* Trigger: TB_INFPROC_BIU0 */
CREATE TRIGGER TB_INFPROC_BIU0 FOR TB_INFPROC
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    begin
         new.data=cast(extract(year from new.data)||'-'||extract(month from new.data)||'-10' as date);
    end
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_IO_STATISTIC_BI0 */
CREATE TRIGGER TB_IO_STATISTIC_BI0 FOR TB_IO_STATISTIC
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN

 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null) then
    New.ShifrId=Gen_Id(g_io_statistic, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
 new."USER"=current_user;
END
^

/* Trigger: TB_KADRY_87_BI0 */
CREATE TRIGGER TB_KADRY_87_BI0 FOR TB_KADRY_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
    if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_kadry_87,1);
  /* Trigger text */
end
^

/* Trigger: TB_KOMAND_ADD_BI99 */
CREATE TRIGGER TB_KOMAND_ADD_BI99 FOR TB_KOMAND_ADD
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (Inserting) then
 if (New.ShifrId is Null or New.ShifrId=0) then
    New.ShifrId=gen_id(g_KOMAND_ADD, 1);
 New.ShifrWrk = ShifrWrk;
 if ((inserting) and
     (extract(year from cast(coalesce(new.datewrk,'1900-01-01') as timestamp))<2000)) then
     New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_KOMAND_BD0 */
CREATE TRIGGER TB_KOMAND_BD0 FOR TB_KOMAND
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_komand_res   where tb_komand_res.shifridkmnd   = old.shifrid;
     delete from tb_komand_summy where tb_komand_summy.shifridkmnd = old.shifrid;
     delete from tb_komand_add   where tb_komand_add.shifridkmnd = old.shifrid;

  /* Trigger text */
end
^

/* Trigger: TB_KOMAND_BI99 */
CREATE TRIGGER TB_KOMAND_BI99 FOR TB_KOMAND
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (inserting) then
 if (NEW.ShifrId is Null or NEW.ShifrId=0) then
     New.ShifrId=gen_id(g_komand, 1);
 New.ShifrWrk = ShifrWrk;
 if ((inserting) and
     (extract(year from cast(coalesce(new.datewrk,'1900-01-01') as timestamp))<2000)) then
    New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_KOMAND_RES_BI99 */
CREATE TRIGGER TB_KOMAND_RES_BI99 FOR TB_KOMAND_RES
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (inserting) then
 if (New.ShifrId is Null or New.ShifrId=0) then
    New.ShifrId=gen_id(g_KOMAND_RES, 1);
 New.ShifrWrk = ShifrWrk;
 if ((inserting) and (extract(year from cast(coalesce(new.datewrk,'1900-01-01') as timestamp))<2000)) then
     New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_KOMAND_SUMMY_BI99 */
CREATE TRIGGER TB_KOMAND_SUMMY_BI99 FOR TB_KOMAND_SUMMY
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrId is Null or New.ShifrId=0) then
     New.ShifrId=gen_id(G_KOMAND_SUMMY, 1);
 New.ShifrWrk = ShifrWrk;
 if ((inserting) and (extract(year from cast(coalesce(new.datewrk,'1900-01-01') as timestamp))<2000)) then
     New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_KREDIT_SPR_BD0 */
CREATE TRIGGER TB_KREDIT_SPR_BD0 FOR TB_KREDIT_SPR
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_kredit_spr_pr where tb_kredit_spr_pr.shifridowner=old.shifrid;
end
^

/* Trigger: TB_KREDIT_SPR_BI0 */
CREATE TRIGGER TB_KREDIT_SPR_BI0 FOR TB_KREDIT_SPR
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_kredit_spr, 1);
     if (new.shifrwrk<0 or (new.shifrwrk is null)) then
        begin
             select first 1 shifrwrk from currshifrwrk into :shifrwrk;
             new.shifrwrk=:shifrwrk;
        end
     if (new.datewrk is null) then
          new.datewrk=current_timestamp;
     else
        if (extract(year from new.datewrk)<2000) then
          new.datewrk=current_timestamp;

  /* Trigger text */
end
^

/* Trigger: TB_KREDIT_SPR_BU0 */
CREATE TRIGGER TB_KREDIT_SPR_BU0 FOR TB_KREDIT_SPR
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_KREDIT_SPR_PR_BI0 */
CREATE TRIGGER TB_KREDIT_SPR_PR_BI0 FOR TB_KREDIT_SPR_PR
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<1 ) then
       new.shifrid=gen_id(g_kredit_spr,1);
end
^

/* Trigger: TB_K_CONTRACTPED_BI0 */
CREATE TRIGGER TB_K_CONTRACTPED_BI0 FOR TB_K_CONTRACTPED
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    new.shifrid=GEN_ID(g_k_contract,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_K_DECANY_BI0 */
CREATE TRIGGER TB_K_DECANY_BI0 FOR TB_K_DECANY
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.shifrid, 0)=0) then
        new.shifrid=gen_id(g_k_decany,1);
  /* Trigger text */
end
^

/* Trigger: TB_K_EXL_SAL_BIU0 */
CREATE TRIGGER TB_K_EXL_SAL_BIU0 FOR TB_K_EXL_SAL
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_k_EXL_sal,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_KADRYPR_BI0 */
CREATE TRIGGER TB_K_KADRYPR_BI0 FOR TB_K_KADRYPR
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    if ((new.shifrid is null) or (new.shifrid<1))  then
       new.shifrid=GEN_ID(g_k_kadrypr,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_K_KADRY_BI99 */
CREATE TRIGGER TB_K_KADRY_BI99 FOR TB_K_KADRY
ACTIVE BEFORE INSERT OR UPDATE POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    begin
         if ((new.shifrid is null) or (new.shifrid<1)) then
            new.shifrid=GEN_ID(g_k_kadry,1);
         if (new.verified<>1) then
            new.verified=0;
    end
 else if (updating) then
    begin
          if ((new.verified=1) and (coalesce(old.verified,0)<>1))  then
             new.datever=current_timestamp;
          else if ((coalesce(old.verified,0)=1) and (new.verified=0)) then
             new.datever=null;
    end
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 if (inserting) then
 if (New.ShifrWrk is null) then
     New.ShifrWrk = ShifrWrk;
 if (inserting) then
 if (New.DateWrk is null) then
    New.DateWRK = CURRENT_TIMESTAMP;
 if (updating) then
    begin
         New.ShifrWrk = ShifrWrk;
         New.DateWRK  = CURRENT_TIMESTAMP;
    end
END
^

/* Trigger: TB_K_K_F_BI0 */
CREATE TRIGGER TB_K_K_F_BI0 FOR TB_K_K_F
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.shifrid,0)=0) then
        new.shifrid=gen_id(g_k_k_f,1);
     new.dateWrk=Current_timestamp;
end
^

/* Trigger: TB_K_ORDERRECPR_BI0 */
CREATE TRIGGER TB_K_ORDERRECPR_BI0 FOR TB_K_ORDERRECPR
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
        if ((new.shifrid is null) or (new.shifrid<1)) then
           new.shifrid=gen_id(g_k_ORDerrecpr,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;

  /* Trigger text */
end
^

/* Trigger: TB_K_ORDERRECTEXT_BIU0 */
CREATE TRIGGER TB_K_ORDERRECTEXT_BIU0 FOR TB_K_ORDERRECTEXT
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_k_orderrectext,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_ORDERREC_BIU0 */
CREATE TRIGGER TB_K_ORDERREC_BIU0 FOR TB_K_ORDERREC
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
        if ((new.shifrid is null) or (new.shifrid<1)) then
           new.shifrid=gen_id(g_k_ORDrec,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;

  /* Trigger text */
end
^

/* Trigger: TB_K_ORDERS_BI0 */
CREATE TRIGGER TB_K_ORDERS_BI0 FOR TB_K_ORDERS
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
       if ((new.shifrid is null) or (new.shifrid<1))  then
        new.shifrid=gen_id(g_k_ORDER,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
     if ((new.nomerordalpha is null) and (new.nomerord is not null)) then
        new.nomerordalpha=cast(new.nomerord as varchar(15));

  /* Trigger text */
end
^

/* Trigger: TB_K_ORDERS_BU0 */
CREATE TRIGGER TB_K_ORDERS_BU0 FOR TB_K_ORDERS
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_PODR_BI99 */
CREATE TRIGGER TB_K_PODR_BI99 FOR TB_K_PODR
ACTIVE BEFORE INSERT POSITION 99
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrPod is Null or  New.ShifrPod=0) then
     New.ShifrPod=gen_id(g_K_PODR, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_K_SHTRASPPEDREC_BI0 */
CREATE TRIGGER TB_K_SHTRASPPEDREC_BI0 FOR TB_K_SHTRASPPEDREC
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    if ((new.shifrid is null) or (new.shifrid<1)) then
       new.shifrid=GEN_ID(g_k_shtrasprec,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK  = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_K_SHTRASPPED_BIU0 */
CREATE TRIGGER TB_K_SHTRASPPED_BIU0 FOR TB_K_SHTRASPPED
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    if ((new.shifrid is null) or (new.shifrid<1)) then
       new.shifrid=GEN_ID(g_k_shtraspped,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_K_USZ_BIU0 */
CREATE TRIGGER TB_K_USZ_BIU0 FOR TB_K_USZ
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if ((inserting) and ((new.Shifrid is null) or (new.shifrid<1)))  then
         new.shifrid=gen_id(g_k_usz,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_WIDNADBSTW_BIU0 */
CREATE TRIGGER TB_K_WIDNADBSTW_BIU0 FOR TB_K_WIDNADBSTW
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_k_widnadbstw,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_WIDNADB_BI0 */
CREATE TRIGGER TB_K_WIDNADB_BI0 FOR TB_K_WIDNADB
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
    if (inserting) then
       if ((new.shifrid is null) or (new.shifrid<1))  then
          new.shifrid=gen_id(g_k_widnadb,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_WIDORDERS_BI0 */
CREATE TRIGGER TB_K_WIDORDERS_BI0 FOR TB_K_WIDORDERS
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
       if ((new.shifrid is null) or (new.shifrid<1))  then
         new.shifrid=gen_id(g_k_widorders,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_WIDYZASL_BIU0 */
CREATE TRIGGER TB_K_WIDYZASL_BIU0 FOR TB_K_WIDYZASL
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_k_widyzasl,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_K_ZAJAWLPEDSOWM_BIU0 */
CREATE TRIGGER TB_K_ZAJAWLPEDSOWM_BIU0 FOR TB_K_ZAJAWLPEDSOWM
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    if ((new.shifrid is null) or (new.shifrid<1)) then
       new.shifrid=GEN_ID(g_k_zajasowmped,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
/*
 if (New.ShifrPod is Null) then
     New.ShifrPod=gen_id(gpodr, 1);
*/
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_NADB_87_BI0 */
CREATE TRIGGER TB_NADB_87_BI0 FOR TB_NADB_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
    if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_nadb_87,1);
  /* Trigger text */
end
^

/* Trigger: TB_NADB_87_PR_BI0 */
CREATE TRIGGER TB_NADB_87_PR_BI0 FOR TB_NADB_87_PR
ACTIVE BEFORE INSERT POSITION 0
AS
begin
    if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_nadb_87_pr,1);
end
^

/* Trigger: TB_NEED_87_BI0 */
CREATE TRIGGER TB_NEED_87_BI0 FOR TB_NEED_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_need_87,1);

  /* Trigger text */
end
^

/* Trigger: TB_OTPUSK_2012_01_BU0 */
CREATE TRIGGER TB_OTPUSK_2012_01_BU0 FOR TB_OTPUSK_2012_01
ACTIVE BEFORE UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     select first 1 a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.currwrk=shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_OTPUSK_2012_04_BU0 */
CREATE TRIGGER TB_OTPUSK_2012_04_BU0 FOR TB_OTPUSK_2012_04
ACTIVE BEFORE UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     select first 1 a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.currwrk=shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_OTP_UHOD_BI0 */
CREATE TRIGGER TB_OTP_UHOD_BI0 FOR TB_OTP_UHOD
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 if (inserting) then
    if ((new.shifrid is null) or (new.shifrid<1))  then
       new.shifrid=GEN_ID(g_otp_uhod,1);
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_P04T05B_BD0 */
CREATE TRIGGER TB_P04T05B_BD0 FOR TB_P04T05B
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_p04t05b_det a where a.shifridmst=old.shifrid;
  /* Trigger text */
end
^

/* Trigger: TB_P04T05B_BI0 */
CREATE TRIGGER TB_P04T05B_BI0 FOR TB_P04T05B
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t05b,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T06B_BD0 */
CREATE TRIGGER TB_P04T06B_BD0 FOR TB_P04T06B
ACTIVE BEFORE DELETE POSITION 0
AS
begin
    delete from tb_p04t06b_det a where a.shifridmst=old.shifrid;
    delete from tb_p04t06b_det_pens a where a.shifridmst=old.shifrid;
  /* Trigger text */
end
^

/* Trigger: TB_P04T06B_BIU0 */
CREATE TRIGGER TB_P04T06B_BIU0 FOR TB_P04T06B
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t06b,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T06B_DET_BIU0 */
CREATE TRIGGER TB_P04T06B_DET_BIU0 FOR TB_P04T06B_DET
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t06b_det,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T06B_DET_PENS_BIU0 */
CREATE TRIGGER TB_P04T06B_DET_PENS_BIU0 FOR TB_P04T06B_DET_PENS
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t06b_det_UD,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T07B_BD0 */
CREATE TRIGGER TB_P04T07B_BD0 FOR TB_P04T07B
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_p04t07b_det a where a.shifridmst=old.shifrid;
     delete from tb_p04t07b_det_pens a where a.shifridmst=old.shifrid;
  /* Trigger text */
end
^

/* Trigger: TB_P04T07B_BI0 */
CREATE TRIGGER TB_P04T07B_BI0 FOR TB_P04T07B
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t07b,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T07B_DET_BIU0 */
CREATE TRIGGER TB_P04T07B_DET_BIU0 FOR TB_P04T07B_DET
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t07b_det,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T07B_DET_PENS_BI0 */
CREATE TRIGGER TB_P04T07B_DET_PENS_BI0 FOR TB_P04T07B_DET_PENS
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t07b_det,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_P04T08B_BI0 */
CREATE TRIGGER TB_P04T08B_BI0 FOR TB_P04T08B
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_p04t08b,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_PLAN_GRID_BI0 */
CREATE TRIGGER TB_PLAN_GRID_BI0 FOR TB_PLAN_GRID
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_grid,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_PLAT_FAKT_87_BI0 */
CREATE TRIGGER TB_PLAT_FAKT_87_BI0 FOR TB_PLAT_FAKT_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<=0) then
         new.shifrid=gen_id(gvyplplt,1);
  /* Trigger text */
end
^

/* Trigger: TB_PLAT_HAT_BD0 */
CREATE TRIGGER TB_PLAT_HAT_BD0 FOR TB_PLAT_HAT
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_plat_pr WHERE TB_PLAT_PR.shifridplat=old.SHIFRID;
  /* Trigger text */
end
^

/* Trigger: TB_PLAT_HAT_BI0 */
CREATE TRIGGER TB_PLAT_HAT_BI0 FOR TB_PLAT_HAT
ACTIVE BEFORE INSERT POSITION 99
AS
declare VARIABLE shifrwrk integer;
begin
     if (NEW.ShifrId is NULL or NEW.ShifrId=0) then
        NEW.ShifrId=gen_id(GPLATHEA,1);
     if (new.shifrwrk is null or new.shifrwrk=0 ) then
        begin
            SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
            New.ShifrWrk = ShifrWrk;
            New.DateWRK = CURRENT_TIMESTAMP;
        end
  /* Trigger text */
end
^

/* Trigger: TB_PLAT_PR_BI99 */
CREATE TRIGGER TB_PLAT_PR_BI99 FOR TB_PLAT_PR
ACTIVE BEFORE INSERT POSITION 99
AS
begin
     if (NEW.ShifrId is NULL or NEW.ShifrId=0) then
        NEW.ShifrId=gen_id(GPLATPR,1);
  /* Trigger text */
end
^

/* Trigger: TB_PODR_HISTORY_BI0 */
CREATE TRIGGER TB_PODR_HISTORY_BI0 FOR TB_PODR_HISTORY
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (New.ShifrPod is Null or  New.ShifrPod=0) then
     New.ShifrPod=gen_id(gpodr, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_PREP_UWP_PERS_MONTH_BIU0 */
CREATE TRIGGER TB_PREP_UWP_PERS_MONTH_BIU0 FOR TB_PREP_UWP_PERS_MONTH
ACTIVE BEFORE INSERT OR UPDATE POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_pr_uwp,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_PRIKAZY_BI0 */
CREATE TRIGGER TB_PRIKAZY_BI0 FOR TB_PRIKAZY
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
declare variable fio varchar(50);
begin
    if (coalesce(new.id,0)=0) then
       new.id=gen_id(g_prikazy,1);
    shifrwrk = null;
    select first 1 shifrwrk from currshifrwrk
           into shifrwrk;
    new.shifrwrk  = :shifrwrk         ;
    new.datacre   = current_timestamp ;
    new.datachg   = current_timestamp ;
    new.fiowrk    = current_user;
    fio           = null;
    if (coalesce(new.tabno,0)>0) then
       begin
            select a.fio from kadry a
                   where a.tabno=new.tabno
                   into :fio;
            fio=coalesce(fio,'Не найден');
            new.fio = :fio;
       end

  /* Trigger text */
end
^

/* Trigger: TB_PRIKAZY_BU0 */
CREATE TRIGGER TB_PRIKAZY_BU0 FOR TB_PRIKAZY
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable fio varchar(50);
begin
     new.datachg=current_timestamp;
    fio           = null;
    if (coalesce(new.tabno,0)>0) then
       begin
            select a.fio from kadry a
                   where a.tabno=new.tabno
                   into :fio;
            fio=coalesce(fio,'Не найден');
            new.fio = :fio;
       end

  /* Trigger text */
end
^

/* Trigger: TB_PRIKAZY_TYP_BI0 */
CREATE TRIGGER TB_PRIKAZY_TYP_BI0 FOR TB_PRIKAZY_TYP
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.id,0)=0) then
        new.id=gen_id(g_prikazy_typ,1);

end
^

/* Trigger: TB_RAZR_PROC_BI0 */
CREATE TRIGGER TB_RAZR_PROC_BI0 FOR TB_RAZR_PROC
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (NEW.SHIFRID IS NULL OR NEW.SHIFRID<1) then
        NEW.SHIFRID=GEN_ID(g_tr_razr,1);
  /* Trigger text */
end
^

/* Trigger: TB_RCLC1301_BI0 */
CREATE TRIGGER TB_RCLC1301_BI0 FOR TB_RCLC1301
ACTIVE BEFORE INSERT POSITION 0
AS
begin
   if (new.shifrid is null or new.shifrid=0) then
       new.shifrid=gen_id(G_RCLC_08,1);
end
^

/* Trigger: TB_RCLC1301_PR_BI0 */
CREATE TRIGGER TB_RCLC1301_PR_BI0 FOR TB_RCLC1301_PR
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.shifrid,0)<1) then
       new.shifrid=gen_id(g_rclcpr,1);
  /* Trigger text */
end
^

/* Trigger: TB_RCLCPOCHAS1301_BI0 */
CREATE TRIGGER TB_RCLCPOCHAS1301_BI0 FOR TB_RCLCPOCHAS1301
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.shifrid,0)<1) then
        new.shifrid=gen_id(g_rclcpochas1301,1);
  /* Trigger text */
end
^

/* Trigger: TB_RCLCPOCHAS1301_PR_BI0 */
CREATE TRIGGER TB_RCLCPOCHAS1301_PR_BI0 FOR TB_RCLCPOCHAS1301_PR
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (coalesce(new.shifrid,0)<1) then
        new.shifrid=gen_id(g_rclcpochas1301pr,1);
  /* Trigger text */
end
^

/* Trigger: TB_RECALC_PODOH_BI0 */
CREATE TRIGGER TB_RECALC_PODOH_BI0 FOR TB_RECALC_PODOH
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     new.shifrid = gen_id(g_tb_rec,1);
  /* Trigger text */
end
^

/* Trigger: TB_RECALC_PODOH_DET_BI0 */
CREATE TRIGGER TB_RECALC_PODOH_DET_BI0 FOR TB_RECALC_PODOH_DET
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      new.shifrid=gen_id(g_tb_rec_det,1);
  /* Trigger text */
end
^

/* Trigger: TB_REE_BOLN_BI0 */
CREATE TRIGGER TB_REE_BOLN_BI0 FOR TB_REE_BOLN
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_ree_boln,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_REE_BOLN_BU0 */
CREATE TRIGGER TB_REE_BOLN_BU0 FOR TB_REE_BOLN
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_REE_BOLN_DET_BD0 */
CREATE TRIGGER TB_REE_BOLN_DET_BD0 FOR TB_REE_BOLN_DET
ACTIVE BEFORE DELETE POSITION 0
AS
begin
      if (old.shifridboln is not null) then
         if (old.shifridboln>0) then
             update boln
                    set boln.shifridreb=0
                    where boln.shifrid=old.shifridboln;
  /* Trigger text */
end
^

/* Trigger: TB_REE_BOLN_DET_BI0 */
CREATE TRIGGER TB_REE_BOLN_DET_BI0 FOR TB_REE_BOLN_DET
ACTIVE BEFORE INSERT POSITION 0
AS
 declare variable shifrwrk integer;
begin
     if ((new.shifrid is null) or (new.shifrid <1))  then
         new.shifrid=gen_id(g_ree_boln_det,1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_SBS_SAD_TABLE_BI0 */
CREATE TRIGGER TB_SBS_SAD_TABLE_BI0 FOR TB_SBS_SAD_TABLE
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_sbs_sad, 1);

  /* Trigger text */
end
^

/* Trigger: TB_SBS_SUD_TABLE_BI0 */
CREATE TRIGGER TB_SBS_SUD_TABLE_BI0 FOR TB_SBS_SUD_TABLE
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_sbs_sud, 1);
end
^

/* Trigger: TB_SEL_PAR_PLAT_BI0 */
CREATE TRIGGER TB_SEL_PAR_PLAT_BI0 FOR TB_SEL_PAR_PLAT
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     NEW.SHIFRID=GEN_ID(G_S_P_P,1);
  /* Trigger text */
end
^

/* Trigger: TB_SPRSBSPRTABLE_BI0 */
CREATE TRIGGER TB_SPRSBSPRTABLE_BI0 FOR TB_SPRSBSPRTABLE
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_sbs_sprpr, 1);

  /* Trigger text */
end
^

/* Trigger: TB_SPRSBSTABLE_BI0 */
CREATE TRIGGER TB_SPRSBSTABLE_BI0 FOR TB_SPRSBSTABLE
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_sbs_spr, 1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;

  /* Trigger text */
end
^

/* Trigger: TB_SPR_ZARPL_BD0 */
CREATE TRIGGER TB_SPR_ZARPL_BD0 FOR TB_SPR_ZARPL
ACTIVE BEFORE DELETE POSITION 0
AS
begin
     delete from tb_spr_zarpl_pr where shifridowner=old.shifrid;
  /* Trigger text */
end
^

/* Trigger: TB_SPR_ZARPL_BI0 */
CREATE TRIGGER TB_SPR_ZARPL_BI0 FOR TB_SPR_ZARPL
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (new.shifrid is null or (new.shifrid<0) ) then
        new.shifrid=gen_id(g_y_spr, 1);
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;

  /* Trigger text */
end
^

/* Trigger: TB_SPR_ZARPL_BU0 */
CREATE TRIGGER TB_SPR_ZARPL_BU0 FOR TB_SPR_ZARPL
ACTIVE BEFORE UPDATE POSITION 0
AS
declare variable shifrwrk integer;
begin
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     new.shifrwrk=:shifrwrk;
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_SPR_ZARPL_PR_BI0 */
CREATE TRIGGER TB_SPR_ZARPL_PR_BI0 FOR TB_SPR_ZARPL_PR
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<1 ) then
     new.shifrid=gen_id(g_y_spr, 1);
  /* Trigger text */
end
^

/* Trigger: TB_SWODY_DET_BI0 */
CREATE TRIGGER TB_SWODY_DET_BI0 FOR TB_SWODY_DET
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_swody_det,1);
  /* Trigger text */
end
^

/* Trigger: TB_SWODY_DET_PERSON_ADD_BI0 */
CREATE TRIGGER TB_SWODY_DET_PERSON_ADD_BI0 FOR TB_SWODY_DET_PERSON_ADD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_swod_det_person_add,1);
  /* Trigger text */
end
^

/* Trigger: TB_SWODY_HAT_BI0 */
CREATE TRIGGER TB_SWODY_HAT_BI0 FOR TB_SWODY_HAT
ACTIVE BEFORE INSERT POSITION 0
AS
declare variable shifrwrk integer;
begin
     if (inserting) then
     if ((new.shifrid is null) or (new.shifrid<1)) then
         new.shifrid=gen_id(g_swody_hat,1);
     select a.shifrwrk from currshifrwrk a into :shifrwrk;
     new.shifrwrk=coalesce(shifrwrk,0);
     new.datewrk=current_timestamp;
  /* Trigger text */
end
^

/* Trigger: TB_TEMY_BI0 */
CREATE TRIGGER TB_TEMY_BI0 FOR TB_TEMY
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 if (NEW.ShifrId is Null or NEW.ShifrId=0) then
     New.ShifrId=gen_id(gtemy, 1);
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_TEMY_KAF_BI0 */
CREATE TRIGGER TB_TEMY_KAF_BI0 FOR TB_TEMY_KAF
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 SELECT ShifrWrk FROM currshifrwrk INTO :ShifrWrk;
 New.ShifrWrk = ShifrWrk;
 New.DateWRK = CURRENT_TIMESTAMP;
END
^

/* Trigger: TB_TMP_BOL_PRINT_BI0 */
CREATE TRIGGER TB_TMP_BOL_PRINT_BI0 FOR TB_TMP_BOL_PRINT
ACTIVE BEFORE INSERT POSITION 0
AS
begin
    new.conn_id=CURRENT_CONNECTION;
  /* Trigger text */
end
^

/* Trigger: TB_TMP_FADD_BI0 */
CREATE TRIGGER TB_TMP_FADD_BI0 FOR TB_TMP_FADD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      new.shifrid=gen_id(g_tmp_person,1);
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;
      if (New.NEED is null) then New.NEED=0;
  /* Trigger text */
end
^

/* Trigger: TB_TMP_FCN_BI0 */
CREATE TRIGGER TB_TMP_FCN_BI0 FOR TB_TMP_FCN
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      new.shifrid=gen_id(g_tmp_person,1);
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;

  /* Trigger text */
end
^

/* Trigger: TB_TMP_FUD_BI0 */
CREATE TRIGGER TB_TMP_FUD_BI0 FOR TB_TMP_FUD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      new.shifrid=gen_id(g_tmp_person,1);
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;
      if (New.NEED is null) then New.NEED=0;

  /* Trigger text */
end
^

/* Trigger: TB_TMP_PAR_SWOD_BI0 */
CREATE TRIGGER TB_TMP_PAR_SWOD_BI0 FOR TB_TMP_PAR_SWOD
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;
end
^

/* Trigger: TB_TMP_PERSON_BI0 */
CREATE TRIGGER TB_TMP_PERSON_BI0 FOR TB_TMP_PERSON
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;
  /* Trigger text */
end
^

/* Trigger: TB_TMP_TABEL_BI0 */
CREATE TRIGGER TB_TMP_TABEL_BI0 FOR TB_TMP_TABEL
ACTIVE BEFORE INSERT POSITION 0
AS
begin
      if (NEW.conn_id is null or NEW.conn_id<1) then NEW.conn_id=current_connection;
  /* Trigger text */
end
^

/* Trigger: TB_VYPLR_87_BI0 */
CREATE TRIGGER TB_VYPLR_87_BI0 FOR TB_VYPLR_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_vyplr_87,1);
  /* Trigger text */
end
^

/* Trigger: TB_VYPL_87_BI0 */
CREATE TRIGGER TB_VYPL_87_BI0 FOR TB_VYPL_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<1) then
       new.shifrid=gen_id(g_vypl_87,1);
end
^

/* Trigger: TB_VYPL_PLT_87_BI0 */
CREATE TRIGGER TB_VYPL_PLT_87_BI0 FOR TB_VYPL_PLT_87
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     if (new.shifrid is null or new.shifrid<=0) then
        new.shifrid=gen_id(gvyplplt,1);
  /* Trigger text */
end
^

/* Trigger: TMP_BOLNA_BI0 */
CREATE TRIGGER TMP_BOLNA_BI0 FOR TMP_BOLNA
ACTIVE BEFORE INSERT POSITION 0
AS
begin
  /* Trigger text */
  new.shifridtmp=GEN_ID(gbolnatmp,1);
end
^

/* Trigger: TMP_BOLN_RES_BI0 */
CREATE TRIGGER TMP_BOLN_RES_BI0 FOR TMP_BOLN_RES
ACTIVE BEFORE INSERT POSITION 0
AS
 DECLARE VARIABLE ShifrWrk integer;
BEGIN
 New.ShifrIdtmp=gen_id(gbolntmpres, 1);
END
^

/* Trigger: TMP_BOLN_SUMMY_BI0 */
CREATE TRIGGER TMP_BOLN_SUMMY_BI0 FOR TMP_BOLN_SUMMY
ACTIVE BEFORE INSERT POSITION 0
AS
begin
     New.ShifrIdTmp=GEN_ID(gbolntmpsummy,1);
end
^

/* Trigger: TMP_OTP_ADD_BI99 */
CREATE TRIGGER TMP_OTP_ADD_BI99 FOR TMP_OTP_ADD
ACTIVE BEFORE INSERT POSITION 99
AS
BEGIN
    New.ShifrIdTmp  = gen_id(gotp_add_TMP, 1);
END
^

/* Trigger: TMP_OTP_RES_BI99 */
CREATE TRIGGER TMP_OTP_RES_BI99 FOR TMP_OTP_RES
ACTIVE BEFORE INSERT POSITION 99
AS
begin
      NEW.shifridtmp=GEN_ID(GOTP_RES_TMP,1);
end
^

/* Trigger: TMP_OTP_SUMMY_BI99 */
CREATE TRIGGER TMP_OTP_SUMMY_BI99 FOR TMP_OTP_SUMMY
ACTIVE BEFORE INSERT POSITION 99
AS
begin
     New.ShifrIdTmp=gen_id(gotp_summy_tmp,1);
end
^
SET TERM ; ^



/******************************************************************************/
/***                           Stored procedures                            ***/
/******************************************************************************/



SET TERM ^ ;

ALTER PROCEDURE ALIM_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAALIM DECIMAL(15,2))
AS
declare variable isalim integer;
declare variable summaneedalim decimal(15,2);
declare variable procalim decimal(15,5);
begin
     IsAlim=0;
/* Проверить процент алиментов */
     SummaAlim=0;
     ProcAlim=0;
     SummaNeedAlim=0;
     if (mode=1) then
        begin
              SELECT FIRST 1 a.summa FROM tb_tmp_FCN a
                     WHERE (A.SHIFRSTA=56 or ShifrSta=56+500) AND     -- код алиментов
                            A.TABNO=:TABNO AND
                            A.month_vy=:MONTHZA AND
                            A.Year_vy=:YearZa  and
                            conn_id=current_connection
                     into :ProcALim;
              if (:procalim is Null) then ProcAlim=0;
        end
     else
        begin
              SELECT FIRST 1 a.summa FROM FCN a
                     WHERE (A.SHIFRSTA=56 or ShifrSta=56+500) AND     -- код алиментов
                            A.TABNO=:TABNO AND
                            A.month_vy=:MONTHZA AND
                            A.Year_vy=:YearZa
                     into :ProcALim;
              if (:procalim is Null) then ProcAlim=0;
        end
     if ((ProcAlim Is Null) or (ProcAlim=0)) then
        begin
        /* Проверить сумму алиментов алиментов */
         if (mode=1) then
            begin
                  SELECT FIRST 1 a.summa FROM tb_tmp_FCN a
                         WHERE (A.SHIFRSTA=55 or ShifrSta=55+500) AND     -- код алиментов
                                A.TABNO=:TABNO AND
                                A.month_vy=:MONTHZA AND
                                A.Year_vy=:YearZa  and
                                conn_id=current_connection
                         into :SummaNeedAlim;
                  if (:SummaNeedAlim is Null) then SummaNeedAlim=0;
            end
         else
            begin
                  SELECT FIRST 1 a.summa FROM FCN a
                         WHERE (A.SHIFRSTA=55 or ShifrSta=55+500) AND     -- код алиментов
                                A.TABNO=:TABNO AND
                                A.month_vy=:MONTHZA AND
                                A.Year_vy=:YearZa
                          into :SummaNeedALim;
                  if (:SummaNeedAlim is Null) then SummaNeedAlim=0;
            end
         end
/* Проверить если он не алиментщик то выйти */

     if (not (((procalim is null) or (procalim=0)) and
             ((SummaNeedAlim is null) or (SummaNeedAlim=0))))  then
        begin
             if (ProcAlim>0) then
                begin
                     if (ProcAlim>1) then ProcAlim=ProcAlim/100;
                     SummaAlim=Summa*ProcAlim;
                end
             else
                begin
                       SummaAlim=SummaNeedAlim;
                end
        end

  suspend;
end^


ALTER PROCEDURE ARCYEARVY (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2),
    SUMMASS DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
declare variable WANTEDMONTH integer;
declare variable SUMMAUD decimal(15,2);
begin
      SummaAdd=0;
      SummaMp=0;
      SummaKassa=0;
      SummaPod=0;
      SummaPens=0;
      SummaSS=0;
      SummaFz=0;
      SummaProf=0;
      SummaKVyd=0;
      WantedMonth=0;
      SummaWS=0;
      while (WantedMonth<12) do
        begin
             WantedMonth=WantedMonth+1;
             select sum(Summa),
                   sum(case when shifrsta in (31,141)  then summa else 0 end),
                   sum(case when shifrsta=44 then summa else 0 end)
                   from fadd
                   where tabno=:tabno and Year_Vy=:WantedYear and Month_Vy=:WantedMonth
                   into :SummaAdd,:SummaMp,SummaKassa;
             select
                   sum(case when shifrsta=50 then summa else 0 end),
                   sum(case when shifrsta=75 then summa else 0 end),
                   sum(case when shifrsta=106 then summa else 0 end),
                   sum(case when shifrsta=88 then summa else 0 end),
                   sum(case when shifrsta=62 then summa else 0 end),
                   sum(case when shifrsta=161 then summa else 0 end),
                   sum(case when shifrsta not in (51,52,53,67,69,70,76,77,78,80,86,87,91,102,103,104,123,124,125,131,132,133,134,135,136) then summa else 0 end)

                   from fud
                   where tabno=:tabno and Year_Vy=:WantedYear and Month_Vy=:WantedMonth
                   into :SummaPod,:SummaPens,:SummaSS,:SummaFZ,:SummaProf,:SummaWS,:SummaUd;
                   SummaKVyd=SummaAdd-SummaUd;
             Month_VY=WantedMonth;
             if (SummaAdd is not null or SummaPod is not Null or
                SummaPens is not null or SummaSS is not Null  or
                SummaFZ is not null or SummaProf is not Null or
                SummaUd is not null or SummaMP is not Null or
                SummaWS is not null or SummaKassa is not null) then
             suspend;
        end
end^


ALTER PROCEDURE ARCYEARVY11 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
declare variable WANTEDMONTH integer;
declare variable SUMMAUD decimal(15,2);
begin
      SummaAdd    = 0;
      SummaMp     = 0;
      SummaKassa  = 0;
      SummaPod    = 0;
      SummaECB    = 0;
      SummaECBN   = 0;
      SummaECBIll = 0;
      SummaECBDP  = 0;
      SummaProf   = 0;
      SummaKVyd   = 0;
      WantedMonth = 0;
      summaws     = 0;
      while (WantedMonth<12) do
        begin
             WantedMonth=WantedMonth+1;
             select sum(Summa),
                   sum(case when shifrsta in (31,141) then summa else 0 end),
                   sum(case when shifrsta=44 then summa else 0 end)
                   from fadd
                   where tabno=:tabno and Year_Vy=:WantedYear and Month_Vy=:WantedMonth
                   into :SummaAdd,:SummaMp,SummaKassa;
             select
                   sum(case when shifrsta=50  then summa else 0 end),
                   sum(case when shifrsta=142 then summa else 0 end),
                   sum(case when shifrsta=143 then summa else 0 end),
                   sum(case when shifrsta=145 then summa else 0 end),
                   sum(case when shifrsta=146 then summa else 0 end),
                   sum(case when shifrsta=62 then summa else 0 end),
                   sum(case when shifrsta=161 then summa else 0 end),
--                   sum(case when shifrsta not in (65,77,86,91,102,103,104,123,124,125,142,143,144,145,146) then summa else 0 end)
                   sum(case when shifrsta in (51,52,53,67,69,70,76,77,78,80,86,87,91,102,103,104,123,124,125,131,132,133,134,135,136) then summa else 0 end)
                   from fud
                   where tabno=:tabno and Year_Vy=:WantedYear and Month_Vy=:WantedMonth
                   into :SummaPod,:SummaECB,:SummaECBN,:SummaECBIll,:summaecbdp,:summaprof,:SummaWS,:SummaUd;
--                   SummaKVyd=SummaAdd-SummaUd;
                   SummaKVyd=SummaUd;
             Month_VY=WantedMonth;
             if (SummaAdd is not null or SummaPod is not Null or
                SummaECB is not null or SummaECBN is not Null  or
                SummaECBIll is not null or SummaECBDp is not null or
                SummaProf is not Null or
                SummaUd is not null or SummaMP is not Null or
                SUmmaWS is not null or SummaKassa is not null) then
             suspend;
        end
end^


ALTER PROCEDURE ARCYEARVY1104 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_VY INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2))
AS
declare variable WANTEDMONTH integer;
declare variable SUMMAUD decimal(15,2);
begin
      SummaAdd    = 0;
      SummaMp     = 0;
      SummaKassa  = 0;
      SummaPod    = 0;
      SummaECB    = 0;
      SummaECBN   = 0;
      SummaECBIll = 0;
      SummaECBDP  = 0;
      SummaProf   = 0;
      SummaKVyd   = 0;
      SummaWS     = 0;
      WantedMonth=0;
      while (WantedMonth<12) do
        begin
             WantedMonth=WantedMonth+1;
             select sum(Summa),
                   sum(case when shifrsta in (31,141) then summa else 0 end),
                   sum(case when shifrsta=44 then summa else 0 end)
                   from fadd
                   where tabno=:tabno and
                         (
              --             (shifrsta in (5,6,12,14,15,32) and (year_za=:wantedyear and month_za=:wantedmonth)) or
                           (((select retval from pr_isotherperiodecbshifr(shifrsta))=1) and (year_za=:wantedyear and month_za=:wantedmonth)) or
                           (
               --             (shifrsta not in (5,6,12,14,15,32)) and

                            (select retval from pr_isotherperiodecbshifr(shifrsta))=0 and
                            (((:wantedyear<2011)  and (year_za=:wantedyear and month_za=:wantedmonth)) or
                             ((:wantedyear>=2011) and (year_vy=:wantedyear and month_vy=:wantedmonth)))
                           )
                         )

                   into :SummaAdd,:SummaMp,SummaKassa;
             select
                   sum(case when shifrsta=50  then summa else 0 end),
                   sum(case when shifrsta=142 then summa else 0 end),
                   sum(case when shifrsta=143 then summa else 0 end),
                   sum(case when shifrsta=145 then summa else 0 end),
                   sum(case when shifrsta=146 then summa else 0 end),
                   sum(case when shifrsta=62  then summa else 0 end),
                   sum(case when shifrsta=161 then summa else 0 end),
--                   sum(case when shifrsta not in (65,77,86,91,102,103,104,123,124,125,142,143,144,145,146) then summa else 0 end)
                   sum(case when shifrsta in (51,52,53,67,69,70,76,77,78,80,86,87,91,102,103,104,123,124,125,131,132,133,134,135,136) then summa else 0 end)
                   from fud
                   where tabno=:tabno and Year_Za=:WantedYear and Month_Za=:WantedMonth
                   into :SummaPod,:SummaECB,:SummaECBN,:SummaECBIll,:summaecbdp,:summaprof,:SummaWS,:SummaUd;
--                   SummaKVyd=SummaAdd-SummaUd;
                   SummaKVyd=SummaUd;
             Month_VY=WantedMonth;
             if (SummaAdd is not null or SummaPod is not Null or
                SummaECB is not null or SummaECBN is not Null  or
                SummaECBIll is not null or SummaECBDp is not null or
                SummaProf is not Null or
                SummaUd is not null or SummaMP is not Null or
                SummaWS is not null or  SummaKassa is not null) then
             suspend;
        end
end^


ALTER PROCEDURE ARCYEARZA (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_ZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2),
    SUMMASS DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
declare variable WANTEDMONTH integer;
declare variable SUMMAUD decimal(15,2);
begin
      SummaAdd=0;
      SummaMp=0;
      SummaKassa=0;
      SummaPod=0;
      SummaPens=0;
      SummaSS=0;
      SummaFz=0;
      SummaProf=0;
      SummaKVyd=0;
      WantedMonth=0;
      SummaWS=0;
      while (WantedMonth<12) do
        begin
             WantedMonth=WantedMonth+1;
             select sum(Summa),
                   sum(case when shifrsta in (31,141) then summa else 0 end),
                   sum(case when shifrsta=44 then summa else 0 end)
                   from fadd
                   where tabno=:tabno and Year_Za=:WantedYear and Month_Za=:WantedMonth
                   into :SummaAdd,:SummaMp,SummaKassa;
             select
                   sum(case when shifrsta=50 then summa else 0 end),
                   sum(case when shifrsta=75 then summa else 0 end),
                   sum(case when shifrsta=106 then summa else 0 end),
                   sum(case when shifrsta=88 then summa else 0 end),
                   sum(case when shifrsta=62 then summa else 0 end),
                   sum(case when shifrsta=161 then summa else 0 end),
                   sum(case when shifrsta not in (65,77,86,91,102,103,104,123,124,125) then summa else 0 end)
                   from fud
                   where tabno=:tabno and Year_Za=:WantedYear and Month_Za=:WantedMonth
                   into :SummaPod,:SummaPens,:SummaSS,:SummaFZ,:SummaProf,:summaws, :SummaUd;
                   SummaKVyd=SummaAdd-SummaUd;
             Month_Za=WantedMonth;
             if (SummaAdd is not null or SummaPod is not Null or
                SummaPens is not null or SummaSS is not Null  or
                SummaFZ is not null or SummaProf is not Null or
                SummaUd is not null or SummaMP is not Null or
                summaws is not null or SummaKVyd is not null) then
             suspend;
        end
end^


ALTER PROCEDURE ARCYEARZA11 (
    TABNO INTEGER,
    WANTEDYEAR INTEGER)
RETURNS (
    MONTH_ZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAMP DECIMAL(15,2),
    SUMMAKASSA DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBN DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    SUMMAECBDP DECIMAL(15,2),
    SUMMAPROF DECIMAL(15,2),
    SUMMAWS DECIMAL(15,2),
    SUMMAKVYD DECIMAL(15,2))
AS
declare variable WANTEDMONTH integer;
declare variable SUMMAUD decimal(15,2);
begin
      SummaAdd    = 0;
      SummaMp     = 0;
      SummaKassa  = 0;
      SummaPod    = 0;
      SummaECB    = 0;
      SummaECBN   = 0;
      SummaECBIll = 0;
      SummaECBDP  = 0;
      SummaProf   = 0;
      SummaWS     = 0;
      SummaKVyd   = 0;
      WantedMonth = 0;
      while (WantedMonth<12) do
        begin
             WantedMonth=WantedMonth+1;
             select sum(Summa),
                   sum(case when shifrsta in (31,141) then summa else 0 end),
                   sum(case when shifrsta=44 then summa else 0 end)
                   from fadd
                   where tabno=:tabno and Year_Za=:WantedYear and Month_Za=:WantedMonth
                   into :SummaAdd,:SummaMp,SummaKassa;
             select
                   sum(case when shifrsta=50  then summa else 0 end),
                   sum(case when shifrsta=142 then summa else 0 end),
                   sum(case when shifrsta=143 then summa else 0 end),
                   sum(case when shifrsta=145 then summa else 0 end),
                   sum(case when shifrsta=146 then summa else 0 end),
                   sum(case when shifrsta=62 then summa else 0 end),
                   sum(case when shifrsta=161 then summa else 0 end),
--                   sum(case when shifrsta not in (65,77,86,91,102,103,104,123,124,125,142,143,144,145,146) then summa else 0 end)
                   sum(case when shifrsta in (51,52,53,67,69,70,76,77,78,80,86,87,91,102,103,104,123,124,125,131,132,133,134,135,136) then summa else 0 end)
                   from fud
                   where tabno=:tabno and Year_Za=:WantedYear and Month_Za=:WantedMonth
                   into :SummaPod,:SummaECB,:SummaECBN,:SummaECBIll,:summaecbdp,summaprof,:SummaWS, :SummaUd;
                  -- SummaKVyd=SummaAdd-SummaUd;
             SummaKVyd=SummaUd;
             Month_ZA=WantedMonth;
             if (SummaAdd is not null or SummaPod is not Null or
                SummaECB is not null or SummaECBN is not Null  or
                SummaECBIll is not null or SummaECBDp is not null or
                SummaProf is not Null or
                SummaUd is not null or SummaMP is not Null or
                SummaWS is not null or SummaKassa is not null) then
             suspend;
        end
end^


ALTER PROCEDURE CALCBOLN (
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    PROC DECIMAL(15,2),
    MODE_V_Z INTEGER,
    CONTMODE INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    MODERECALCCLOCK INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    B_DAY INTEGER)
AS
declare variable SUMMA decimal(15,2);
declare variable DAYS decimal(15,2);
declare variable SUMMABUD decimal(15,2);
declare variable SUMMAVNE decimal(15,2);
declare variable SUMMAGN decimal(15,2);
declare variable SUMMANIS decimal(15,2);
declare variable MUSOR integer;
declare variable CURRDATE date;
declare variable M integer;
declare variable Y integer;
declare variable B_DAY_CURR integer;
declare variable MODE_5 integer;
declare variable B_DAY_5 integer;
declare variable SHIFRSTA integer;
declare variable TMPVAR integer;
declare variable CLOCKPERDAY decimal(15,4);
declare variable SHIFRIDTMP integer;
declare variable SUMMA_LIM decimal(15,2);
declare variable DT date;
declare variable CHANGED integer;
declare variable SHIFRIDBOLN integer;
declare variable SHIFRIDPERSON integer;
begin
     clockPerDay=8.00;
   -- mode_ill - 0 обычный больничный
   --            1 декретный больничный
   --            2 больничный по уходу
   --           10 командирока
   -- meandaypermonth =30,44 среднее число календ дней в месяце

--     exception e_p07 'mode_ill='||:mode_ill;
--     select first 1 b_day from tmp_boln_res where connid=CURRENT_CONNECTION into :b_day;
--     exception wdayzero 'b_day='||b_day;

     if (moderecalcclock<1) then -- если перерасчет после ручной корректировки то не удалять
        begin
             delete from tmp_boln_res where connid=CURRENT_CONNECTION;
             select count(*) from tmp_boln_res where connid=CURRENT_CONNECTION into :Musor;
        end
     if (PROC<50 or (PROC>100) ) then PROC=100;
     update tmp_boln_summy a
           set a.summa_vne=coalesce((select sum(summa) from tmp_bolna b
--                                          where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
--                                                 (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za))
                                         where
                                               (
                                               (((select retval from pr_isotherperiodecbshifr(b.shifrsta))=1) and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                               (
                                                 (select retval from pr_isotherperiodecbshifr(b.shifrsta))=0 and
                                                 (((a.year_za<2011)  and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                                  ((a.year_za>=2011) and (b.year_vy=a.year_za and b.month_vy=a.month_za)))
                                                 )
                                                )
                                            and connid=current_connection
                                            and exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=2)
                                            and b.marked>0),0),
               a.summa_bud=coalesce((select sum(summa) from tmp_bolna b
--                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
--                                                 (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za))
                                         where
                                               (
                                               (((select retval from pr_isotherperiodecbshifr(b.shifrsta))=1) and (b.year_za=a.year_za and b.month_za=a.month_za))
                                                or
                                               (
                                                 (select retval from pr_isotherperiodecbshifr(b.shifrsta))=0 and
                                                 (((a.year_za<2011)  and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                                  ((a.year_za>=2011) and (b.year_vy=a.year_za and b.month_vy=a.month_za)))
                                                 )
                                                )

                                            and connid=current_connection
                                            and exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=1)
                                            and b.marked>0),0),
               a.summa_gn=coalesce((select sum(summa) from tmp_bolna b
--                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
--                                                 (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za))
                                         where
                                               (
                                               (((select retval from pr_isotherperiodecbshifr(b.shifrsta))=1) and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                               (
                                                 (select retval from pr_isotherperiodecbshifr(b.shifrsta))=0 and
                                                 (((a.year_za<2011)  and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                                  ((a.year_za>=2011) and (b.year_vy=a.year_za and b.month_vy=a.month_za)))
                                                 )
                                                )
                                           and connid=current_connection
                                           and exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=3)
                                           and b.marked>0),0),
               a.summa_nis=coalesce((select sum(summa) from tmp_bolna b
--                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
--                                                 (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za))
                                         where
                                               (
                                               (((select retval from pr_isotherperiodecbshifr(b.shifrsta))=1) and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                               (
                                                 (select retval from pr_isotherperiodecbshifr(b.shifrsta))=0 and
                                                 (((a.year_za<2011)  and (b.year_za=a.year_za and b.month_za=a.month_za)) or
                                                  ((a.year_za>=2011) and (b.year_vy=a.year_za and b.month_vy=a.month_za)))
                                                 )
                                                )
                                           and connid=current_connection
                                           and exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=4)
                                           and b.marked>0),0)
       where connid=CURRENT_CONNECTION and Manual_Calc<>1;
     --- Вставка от 02 12 2012 ---
     --- Кореекция суммы: сумма для больничных не более лимита
     if (Mode_ill<10) then  -- командировочных - не касается
     for
        select a.shifridtmp,coalesce(a.summa_bud,0),
                            coalesce(a.summa_vne,0),
                            coalesce(a.summa_gn,0),
                            coalesce(a.summa_nis,0),
                a.year_za,a.month_za      from tmp_boln_summy a
                where connid=CURRENT_CONNECTION and Manual_Calc<>1
                into :shifridtmp,:summabud,:summavne, :summagn, :summanis,
                     :y,:m
     do
       begin
            changed  = 0;
            summabud = coalesce(summabud,0);
            summavne = coalesce(summavne,0);
            summagn  = coalesce(summagn,0);
            summanis = coalesce(summanis,0);
--            exception wdayzero 'summabud='||summabud;

            dt=y||'-'||m||'-01';
            summa_lim=null;
            select first 1 a.summalimita from PR_GET_LIMIT_FOR_PENS(:dt) a into summa_lim;
            summa_lim=coalesce(Summa_Lim,0);
            if (summa_lim>100) then
               begin
                    if (summabud>summa_lim) then
                       begin
                            changed  = 1;
                            summabud = summa_lim;
                            summavne = 0;
                            summagn  = 0;
                            summanis = 0;
                       end
                    else
                    if ((summabud+summavne)>summa_lim) then
                       begin
                            changed  = 1;
                            summavne = summa_lim-summabud;
                            summagn  = 0;
                            summanis = 0;
                       end
                    else
                    if ((summabud+summavne+summagn)>summa_lim) then
                       begin
                            changed  = 1;
                            summagn  = summa_lim-(summabud+summavne);
                            summanis = 0;
                       end
                    else
                    if ((summabud+summavne+summagn+summanis)>summa_lim) then
                       begin
                            changed  = 1;
                            summanis = summa_lim-(summabud+summavne+summagn);
                       end
                    if (changed=1) then
                       update tmp_boln_summy a
                          set a.summa_bud  = :summabud,
                              a.summa_vne  = :summavne,
                              a.summa_gn   = :summagn,
                              a.summa_nis  = :summanis
                        where a.shifridtmp =:shifridtmp;
                end

       end

     --- конец изменений ---

/*
       select first 1 a.summa_nis from tmp_boln_summy a
              where a.month_za=10 into :summavne;
       exception 
*/
/*
     update tmp_boln_summy a
       set a.summa_bud=0
       where connid=CURRENT_CONNECTION and a.summa_bud is null;
     update tmp_boln_summy a
       set a.summa_vne=0
       where connid=CURRENT_CONNECTION and a.summa_vne is null;
     update tmp_boln_summy a
       set a.summa_gn=0
       where connid=CURRENT_CONNECTION and a.summa_gn is null;
     update tmp_boln_summy a
       set a.summa_nis=0
       where connid=CURRENT_CONNECTION and a.summa_nis is null;
*/
     meanday     = 0;
     meanday_bud = 0;
     meanday_vne = 0;
     meanday_gn  = 0;
     meanday_nis = 0;
/*                 Убрать коэффициоенты потому что В старой программе они не учитываются 07 02 09
     select coalesce(sum(summa_bud*coalesce(koef,1)) +
                     sum(summa_vne*coalesce(koef,1)) +
                     sum(summa_gn *coalesce(koef,1)) +
                     sum(summa_nis*coalesce(koef,1)),0),
            coalesce(sum(Summa_Bud*coalesce(koef,1)),0),
            coalesce(sum(Summa_Vne*coalesce(koef,1)),0),
            coalesce(sum(Summa_GN*coalesce(koef,1)),0),
            coalesce(sum(Summa_NIS*coalesce(koef,1)),0)
              from tmp_boln_summy a
            where CONNID=current_connection AND
                  a.sel>0
            into :summa,:summabud,:summavne,:summagn,:summanis;
*/
     select coalesce(sum(coalesce(summa_bud,0)) +
                     sum(coalesce(summa_vne,0)) +
                     sum(coalesce(summa_gn,0)) +
                     sum(coalesce(summa_nis,0)),0),
            coalesce(sum(Summa_Bud),0),
            coalesce(sum(Summa_Vne),0),
            coalesce(sum(Summa_GN),0),
            coalesce(sum(Summa_NIS),0)
              from tmp_boln_summy a
            where a.CONNID=current_connection
              AND a.sel>0
            into :summa,:summabud,:summavne,:summagn,:summanis;

/*
     if (summa is null )    then summa=0;
     if (summabud is null ) then summabud=0;
     if (summavne is null ) then summavne=0;
     if (summagn is null )  then summagn=0;
     if (summanis is null ) then summanis=0;
*/
  --   if (mode_ill=1) then   /* Для декретных больничных - календарные дни */
  --   if (1=1) then   /* Для всех с 13 09 2015 - календарные дни */
     if (mode_ill<>10) then   /* Для всех с 13 09 2015 - календарные дни
                                 c 11 04 2016 для командировок - рабочие дни */
       begin
        select sum(coalesce(graphic_day,0)) from tmp_boln_summy a
               where CONNID=current_connection
                 AND a.sel>0 /* and summa_bud+summa_vne+summa_gn+summa_nis>0.005*/
               into :days;
--   exception e_p07 'days='||:days;
       end
     else
        select sum(days) from tmp_boln_summy a
               where CONNID=current_connection AND
                     (a.sel>0/* and summa_bud+summa_vne+summa_gn+summa_nis>0.005*/)
               into :days;
    --    exception e_p07 'days='||:days;

      if (Days is null) then Days=0;
      if (Days>0) then
         begin
              MeanDay     = cast(Summa    / Days as decimal(15,2)) ;
              MeanDay_bud = cast(Summabud / Days as decimal(15,2)) ;
              MeanDay_vne = cast(Summavne / Days as decimal(15,2)) ;
              MeanDay_gn  = cast(Summagn  / Days as decimal(15,2)) ;
              MeanDay_nis = cast(Summanis / Days as decimal(15,2)) ;
         end
--   exception e_p07 'days='||:days;
   CurrDate   = DateFr;
   b_day      = 0;
   b_day_curr = 0;
   m = extract(month from currdate);
   y = extract(year from currdate);
   Mode_5   =  0; /* 0-режим 5 дней ? 1-режим обычный */
   ShifrSta = 12;
   B_day_5  =  0;
   if ((wantedshifrsta<>14) or (ContMode=1) or (Mode_Ill=2) or (Mode_Ill=1))  then  -- Для декретних нет 5 дней
      begin
           Mode_5   =  1;
           ShifrSta = 14;
      end
   if (moderecalcclock<>1) then
      begin
          -- exception wdayzero '0 '||moderecalcclock;

 -- Командировки
          if (Mode_Ill=10) then
             begin
                  Mode_5 = 1;
                  ShifrSta = WantedShifrSta;
             end

          -- Для проверки переноса суббот определить колледж тли университет
          shifridboln   = null;
          shifridperson = null;
          select first 1 a.w_place from tmp_bolna a
                         where a.w_r=1
                         into :shifridperson;
          shifridperson = coalesce(shifridperson,0);
          if (shifridperson>0) then
             begin
                  select first 1 retval from pr_is_coledgpodr(:shifridperson)
                         into :shifridboln;
                  shifridboln=coalesce(shifridboln, 0);
                  if (shifridboln=1) then
                     shifridperson = -2;  -- коледж
                  else
                     shifridperson = -1; -- университет

             end


          while (CurrDate<=DateTo) do
                  begin
                       if ((b_day_5<5) and (Mode_5=0)) then
                           b_day_5=b_day_5+1;

                       if (Mode_Ill=1) then TmpVar=1;   /* Для декретн_х больничных - календарные дни */
                       else
                           select first 1 IsBolnDt.b from IsBolnDt(:CurrDate,:shifridperson) into TmpVar;
                       if (mode_ill=10) then  -- для командировок - рабочие дни
                           select first 1 IsKomandDt.retval from IsKomandDt(:CurrDate,:shifridperson) into TmpVar;
                       else
                          TmpVar=1; -- каледарные для всех
                       if ((TmpVar=0) or (TmpVar is Null) ) then
                          begin
                               if (B_day_5>=5 and Mode_5=0) then          -- Закончен режим расчета 5 дней
                                   begin
             --             exception testputboln '2--'||ShifrSta||' '||b_day_curr;
                                        if (b_day_curr>0) then
                                            begin
                                                if (ModeDC=1) then
                                                   b_day_curr=b_day_curr*clockPerDay;
                                                insert into tmp_boln_res (connid,ShifrSta,b_day,month_za,year_za,
                                                            summa_b_bud,summa_b_vne,summa_b_gn,summa_b_nis)
                                                       values(current_connection,12,:b_day_curr, :m,:y,
                                                              :b_day_curr*:meanday_bud*:PROC/100,:b_day_curr*:meanday_vne*:PROC/100,
                                                              :b_day_curr*:meanday_gn*:PROC/100,:b_day_curr*:meanday_nis*:PROC/100);
                                            end
                                        b_day_curr=0;
                                        Mode_5=1;         -- Теперь обычный режин расчета
                                   end
                          end

                       else
                          begin
                               if (extract(month from CurrDate)<>m or extract(year from CurrDate)<>y) then
                                  begin
                                       ShifrSta=WantedShifrSta;
                                       if (Mode_5=0) then ShifrSta=12;   -- Шифр больничных за 5 дней
--                           exception testputboln ShifrSta||' '||b_day_curr||' '||extract(month from CurrDate)||' '||m||' '||extract(year from CurrDate)||' '||y;
                                       if (b_day_curr>0) then
                                           begin
                                                if (ModeDC=1) then
                                                   b_day_curr=b_day_curr*clockPerDay;
                                                insert into tmp_boln_res (connid,shifrsta,b_day,month_za,year_za,
                                                                          summa_b_bud,summa_b_vne,summa_b_gn,summa_b_nis)
                                                       values(current_connection,:ShifrSta,:b_day_curr, :m,:y,
                                                              :b_day_curr*:meanday_bud*:PROC/100,:b_day_curr*:meanday_vne*:PROC/100,
                                                              :b_day_curr*:meanday_gn*:PROC/100,:b_day_curr*:meanday_nis*:PROC/100);
                                           end
                                       b_day_curr = 0;
                                       m =extract(month from currdate);
                                       y =extract(year from currdate);
                                  end
                               b_day      = b_day+1;
                               b_day_curr = b_day_curr+1;
               --   b_day_5  = b_day_5+1;
                               if (B_day_5>=5 and Mode_5=0) then          -- Закончен режим расчета 5 дней
                                  begin
  --                       exception testputboln '1--'||ShifrSta||' '||b_day_curr;
                                       if (b_day_curr>0) then
                                          begin
                                               if (ModeDC=1) then
                                                   b_day_curr=b_day_curr*clockPerDay;
                                                   insert into tmp_boln_res (connid,ShifrSta,b_day,month_za,year_za,
                                                                             summa_b_bud,summa_b_vne,summa_b_gn,summa_b_nis)
                                                          values(current_connection,12,:b_day_curr, :m,:y,
                                                                 :b_day_curr*:meanday_bud*:PROC/100,:b_day_curr*:meanday_vne*:PROC/100,
                                                                 :b_day_curr*:meanday_gn*:PROC/100,:b_day_curr*:meanday_nis*:PROC/100);
                                          end
                                       b_day_curr=0;
                                       Mode_5=1;         -- Теперь обычный режин расчета
                                  end
                          end
                       CurrDate = CurrDate+1;
                  end         -- end loop
          ShifrSta=WantedShifrSta;
          if (Mode_5=0) then ShifrSta=12;
          if (b_day_curr>0) then
             begin
                  if (ModeDC=1) then
                     b_day_curr=b_day_curr*clockPerDay;
                  insert into tmp_boln_res (connid,shifrsta,b_day,month_za,year_za,
                                 summa_b_bud,summa_b_vne,summa_b_gn,summa_b_nis)
                         values(current_connection,:ShifrSta,:b_day_curr, :m,:y,
                               :b_day_curr*:meanday_bud*:PROC/100,:b_day_curr*:meanday_vne*:PROC/100,
                               :b_day_curr*:meanday_gn*:PROC/100,:b_day_curr*:meanday_nis*:PROC/100);
             end
      end
   else   -- блок расчета больничных в случае почасового с ручной установки часов
      begin
--           select first 1 b_day from tmp_boln_res where connid=CURRENT_CONNECTION into :b_day;
--           exception wdayzero 'b_day='||b_day;
           update tmp_boln_res set
                  summa_b_bud = b_day * :MeanDay_bud,
                  summa_b_vne = b_day * :MeanDay_vne,
                  summa_b_gn  = b_day * :MeanDay_gn,
                  summa_b_nis = b_day * :MeanDay_Nis
              where connid=CURRENT_CONNECTION;
      end
   select sum(b_day) from tmp_boln_res
                     where connid=CURRENT_CONNECTION
                     into :b_day;
--   exception wdayzero ':MeanDay_bud='||:MeanDay_bud;

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE CALCOTP (
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    DAYCOMP INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    O_DAY INTEGER)
AS
declare variable SUMMA decimal(15,2);
declare variable DAYS decimal(15,2);
declare variable SUMMABUD decimal(15,2);
declare variable SUMMAVNE decimal(15,2);
declare variable SUMMAGN decimal(15,2);
declare variable SUMMANIS decimal(15,2);
declare variable MUSOR integer;
declare variable CURRDATE date;
declare variable M integer;
declare variable Y integer;
declare variable O_DAY_CURR integer;
declare variable SHIFRSTA integer;
begin
     delete from tmp_otp_res          where connid=CURRENT_CONNECTION;
     select count(*) from tmp_otp_res where connid=CURRENT_CONNECTION into :Musor;
     update tmp_otp_summy a
           set a.summa_vne=coalesce((select sum(summa) from tmp_otp_add b
                                          where b.month_za=a.month_za     and
                                                b.year_za=a.year_za       and
                                                connid=current_connection and
                                                exists (select c.shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=2) and
                                                b.sel>0),0),
               a.summa_bud=coalesce((select sum(summa) from tmp_otp_add b
                                          where b.month_za=a.month_za     and
                                                b.year_za=a.year_za       and
                                                connid=current_connection and
                                                exists (select c.shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=1) and
                                                b.sel>0),0),
               a.summa_gn=coalesce((select sum(summa) from tmp_otp_add b
                                          where b.month_za=a.month_za     and
                                                b.year_za=a.year_za       and
                                                connid=current_connection and
                                                exists (select c.shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=3) and
                                                b.sel>0),0),
               a.summa_nis=coalesce((select sum(summa) from tmp_otp_add b
                                          where b.month_za=a.month_za     and
                                                b.year_za=a.year_za       and
                                                connid=current_connection and
                                                exists (select c.shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=4) and
                                                b.sel>0),0)
       where connid=CURRENT_CONNECTION and Manual_Calc<>1;
/*
     update tmp_otp_summy a
       set a.summa_bud=0
       where connid=CURRENT_CONNECTION and a.summa_bud is null;
     update tmp_otp_summy a
       set a.summa_vne=0
       where connid=CURRENT_CONNECTION and a.summa_vne is null;
     update tmp_otp_summy a
       set a.summa_gn=0
       where connid=CURRENT_CONNECTION and a.summa_gn is null;
     update tmp_otp_summy a
       set a.summa_nis=0
       where connid=CURRENT_CONNECTION and a.summa_nis is null;
*/
     meanday     = 0;
     meanday_bud = 0;
     meanday_vne = 0;
     meanday_gn  = 0;
     meanday_nis = 0;
     select coalesce(sum(summa_bud*coalesce(koef,1))+sum(summa_vne*coalesce(koef,1))+sum(summa_gn*coalesce(koef,1))+sum(summa_nis*coalesce(koef,1)),0),
            coalesce(sum(Summa_Bud*coalesce(koef,1)),0),
            coalesce(sum(Summa_Vne*coalesce(koef,1)),0),
            coalesce(sum(Summa_GN*coalesce(koef,1)),0),
            coalesce(sum(Summa_NIS*coalesce(koef,1)),0)
              from tmp_otp_summy a
            where CONNID=current_connection AND
                  a.sel>0
            into :summa,:summabud,:summavne,:summagn,:summanis;
/*
     if (summa is null )    then summa=0;
     if (summabud is null ) then summabud=0;
     if (summavne is null ) then summavne=0;
     if (summagn is null )  then summagn=0;
     if (summanis is null ) then summanis=0;
*/
     select sum(day_kalend) from tmp_otp_summy a
            where CONNID=current_connection AND
                  a.sel>0
            into :days;
      if (Days is null) then Days=0;
      if (Days>0) then
         begin
              MeanDay     = Summa    / Days;
              MeanDay_bud = Summabud / Days;
              MeanDay_vne = Summavne / Days;
              MeanDay_gn  = Summagn  / Days;
              MeanDay_nis = Summanis / Days;
         end
    currdate   = datefr;
    m = extract(month from currdate);
    y = extract(year  from currdate);

   if (WantedShifrSta=13) then     -- Компенсация
      begin
            O_day = DayComp;
            if (O_Day>0) then
               insert into tmp_otp_res (connid,shifrsta,o_day,month_za,year_za,
                               summa_o_bud,summa_o_vne,summa_o_gn,summa_o_nis)
                      values(current_connection,:WantedShifrSta,:o_day, :m,:y,
                              :o_day*:meanday_bud,:o_day*:meanday_vne,
                              :o_day*:meanday_gn,:o_day*:meanday_nis);

      end
   else                            -- Обычный отпускной
      begin
           o_day      = 0;
           o_day_curr = 0;
           shifrsta = wantedshifrsta;        -- Отпускные текущего месяца
           if (kind_otp=1) then            -- Отпуск учебный
               shifrsta=5;
           if (kind_otp=2) then            -- Отпуск чернобыльский
               shifrsta=154;
           if (kind_otp=3) then            -- Отпуск дополнительный
               shifrsta=155;
-- Цикл по дням отпускного
           while (currdate<=dateto) do
                  begin
                       if (( not exists (select first 1 prazdniki.shifrid  from prazdniki where prazdniki.mode=2 and prazdniki.dateprz=:currdate))
                            or (kind_otp in (2,3)))  then  -- для черноб и доп отпуска празничные не считаются
                           begin
                                if (extract(month from currdate)<>m or extract(year from currdate)<>y) then
                                   begin
                                        if (ModeDc=1) then
                                           o_day_curr=o_day_curr*8;
                                        insert into tmp_otp_res (connid,shifrsta,o_day,month_za,year_za,
                                                    summa_o_bud,summa_o_vne,summa_o_gn,summa_o_nis,
                                                    need_pere_bud,need_pere_vne,need_pere_gn,need_pere_nis)
                                               values(current_connection,:ShifrSta,:o_day_curr, :m,:y,
                                                      :o_day_curr*:meanday_bud,:o_day_curr*:meanday_vne,
                                                      :o_day_curr*:meanday_gn,:o_day_curr*:meanday_nis,
                                                      1,1,1,1);
                                        o_day_curr=0;
                                        m =extract(month from currdate);
                                        y =extract(year from currdate);
                                   end
                                o_day      = o_day+1;
                                o_day_curr = o_day_curr+1;
                           end
                       CurrDate=CurrDate+1;
                  end
           if (o_day_curr>0) then
              begin
                   if (ModeDc=1) then
                      o_day_curr=o_day_curr*8;
                    insert into tmp_otp_res (connid,shifrsta,o_day,month_za,year_za,
                               summa_o_bud,summa_o_vne,summa_o_gn,summa_o_nis,
                               need_pere_bud,need_pere_vne,need_pere_gn,need_pere_nis)
                           values(current_connection,:ShifrSta,:o_day_curr, :m,:y,
                              :o_day_curr*:meanday_bud,:o_day_curr*:meanday_vne,
                              :o_day_curr*:meanday_gn,:o_day_curr*:meanday_nis,
                              1,1,1,1);
              end
      end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE COPYTMPTOBOLN (
    SHIFRID INTEGER)
AS
declare variable shifridboln integer;
begin
     if (ShifrId=0) then
        select shifrid from getnewidboln into :ShifrIdBoln;
     else
        ShifrIdBoln=ShifrId;
     if (ShifrId>0) then
        begin
             delete from boln_res   where boln_res.shifridboln   = ShifrId;
             delete from boln_summy where boln_summy.shifridboln = ShifrId;
             delete from bolna      where bolna.shifridboln      = ShifrId;
             INSERT INTO boln_res (ShifrId,SHIFRIDBOLN,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                                  SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS)
                    SELECT shifrid,shifridboln,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                           SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS
                    FROM tmp_BOLN_RES where connid=current_connection;

             INSERT INTO bolna (SHIFRID,SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
                    SELECT SHIFRID,SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR
                                 FROM tmp_BOLNA where connid=current_connection;

             INSERT INTO boln_summy (SHIFRID,SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                     SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                     DAYS,GRAPHIC_DAY,KOEF)
                    SELECT SHIFRID,SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                           SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                           DAYS,GRAPHIC_DAY,KOEF
                           FROM tmp_BOLN_SUMMY where connid=current_connection;

        end
     else
        begin
             INSERT INTO boln_res (SHIFRIDBOLN,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                                  SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS)
                    SELECT :shifridboln,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                           SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS
                    FROM tmp_BOLN_RES where connid=current_connection;

             INSERT INTO bolna (SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
                    SELECT :SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR
                                 FROM tmp_BOLNA where connid=current_connection;

             INSERT INTO boln_summy (SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                     SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                     DAYS,GRAPHIC_DAY,KOEF)
                    SELECT :SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                           SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                           DAYS,GRAPHIC_DAY,KOEF
                           FROM tmp_BOLN_SUMMY where connid=current_connection;

        end
  /* Procedure Text */

end^


ALTER PROCEDURE CRTMPBOLN (
    SHIFRID INTEGER)
AS
declare variable musor integer;
begin
     DELETE FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION;
     SELECT COUNT(*) FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     INSERT INTO tmp_boln_res (CONNID,sHIFRid,SHIFRIDBOLN,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                               SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS)
            SELECT CURRENT_CONNECTION,shifrid,shifridboln,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                   SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS
                   FROM BOLN_RES where SHIFRIDBOLN=:SHIFRID;

     INSERT INTO tmp_boln_summy (CONNID,SHIFRID,SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC)
            SELECT CURRENT_CONNECTION,SHIFRID,SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC
                                 FROM BOLN_SUMMY where SHIFRIDBOLN=:SHIFRID;

     INSERT INTO tmp_bolna (CONNID,SHIFRID,SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
            SELECT CURRENT_CONNECTION,SHIFRID,SHIFRIDBOLN,SHIFRIDBOLNSUMMY,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR
                                 FROM BOLNA where SHIFRIDBOLN=:SHIFRID;

  /* Procedure Text */

end^


ALTER PROCEDURE CRTMPOTP (
    SHIFRID INTEGER)
AS
begin
     EXECUTE PROCEDURE PR_DELETE_ALL_FROM_TMP_OTP;
/*
     DELETE FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION;
     SELECT COUNT(*) FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
*/
     INSERT INTO tmp_otp_res (CONNID,sHIFRid,SHIFRIDOTP,SHIFRSTA,O_DAY,MONTH_ZA,YEAR_ZA,
                               SUMMA_O_BUD,SUMMA_O_VNE,SUMMA_O_GN,SUMMA_O_NIS,
                               NEED_PERE_BUD,NEED_PERE_VNE,NEED_PERE_GN,NEED_PERE_NIS,
                               DATA_PERE_BUD,DATA_PERE_VNE,DATA_PERE_GN,DATA_PERE_NIS)
            SELECT CURRENT_CONNECTION,shifrid,shifridotp,SHIFRSTA,o_DAY,MONTH_ZA,YEAR_ZA,
                   SUMMA_O_BUD,SUMMA_O_VNE,SUMMA_O_GN,SUMMA_O_NIS,
                   NEED_PERE_BUD,NEED_PERE_VNE,NEED_PERE_GN,NEED_PERE_NIS,
                   DATA_PERE_BUD,DATA_PERE_VNE,DATA_PERE_GN,DATA_PERE_NIS
                   FROM OTP_RES where SHIFRIDOTP=:SHIFRID;

     INSERT INTO tmp_otp_summy (CONNID,SHIFRID,SHIFRIDOTP,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAY_WORK,DAY_KALEND,KOEF,MANUAL_CALC)
            SELECT CURRENT_CONNECTION,SHIFRID,SHIFRIDOTP,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAY_WORK,DAY_KALEND,KOEF,MANUAL_CALC
                          from otp_summy where SHIFRIDOTP=:SHIFRID;

     INSERT INTO tmp_otp_add (CONNID,SHIFRID,SHIFRIDOTP,SHIFRIDOTPSUM,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,SEL,ID_CLAR,TABNO,FOND,DAYS)
            SELECT CURRENT_CONNECTION,SHIFRID,SHIFRIDOTP,SHIFRIDOTPSUM,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,SEL,ID_CLAR,TABNO,FOND,DAYS
                                 FROM OTP_ADD where SHIFRIDOTP=:SHIFRID;

  /* Procedure Text */

end^


ALTER PROCEDURE CURRSHIFRPRA
RETURNS (
    SHIFRPRA SMALLINT)
AS
declare variable shifrwrk integer;
BEGIN
     select FIRST 1 shifrwrk from currshifrwrk into :ShifrWrk;
     select first 1 shifrpra from operatory where ShifrWrk=:Shifrwrk into Shifrpra;
     suspend;
END^


ALTER PROCEDURE CURRSHIFRRIGHT
RETURNS (
    SHIFRPRA SMALLINT)
AS
declare variable shifrwrk integer;
BEGIN
     SELECT SHIFRPRA FROM Operatory WHERE Login=CURRENT_USER INTO :ShifrPra;
     IF (ShifrPra is null) THEN ShifrPra=0;
     if (not exists (SELECT * FROM OPERATORY WHERE lOGIN=CURRENT_USER)) then
        BEGIN
             SELECT Max(ShifrWrk) FROM Operatory INTO :ShifrWrk;
             IF (ShifrWrk is null) THEN ShifrWrk = 0;
             ShifrWrk = ShifrWrk +1;
             INSERT INTO Operatory (ShifrWrk,Login,NameOp,ShifrPra,SecretRight)
                    VALUES (:ShifrWrk,CURRENT_USER,CURRENT_USER,2,0);
             ShifrPra=2;
        END
     SUSPEND;
END^


ALTER PROCEDURE CURRSHIFRRIGHTST
RETURNS (
    SHIFRSP SMALLINT)
AS
declare variable shifrwrk integer;
BEGIN
     SELECT operatory.secretright FROM Operatory WHERE Login=CURRENT_USER INTO :ShifrSP;
     IF (ShifrSP is null) THEN ShifrSP=0;
     if (not exists (SELECT * FROM OPERATORY WHERE lOGIN=CURRENT_USER)) then
        BEGIN
             SELECT Max(ShifrWrk) FROM Operatory INTO :ShifrWrk;
             IF (ShifrWrk is null) THEN ShifrWrk = 0;
             ShifrWrk = ShifrWrk +1;
             INSERT INTO Operatory (ShifrWrk,Login,NameOp,ShifrPra,SecretRight)
                    VALUES (:ShifrWrk,CURRENT_USER,CURRENT_USER,2,0);
             ShifrSp=0;
        END
     SUSPEND;
END^


ALTER PROCEDURE CURRSHIFRWRK
RETURNS (
    SHIFRWRK SMALLINT)
AS
BEGIN
     SELECT SHIFRWRK FROM OperatORY WHERE Login=CURRENT_USER INTO :ShifrWrk;
     IF (ShifrWrk is null) THEN
        BEGIN
             SELECT Max(ShifrWrk) FROM Operatory INTO :ShifrWrk;
             IF (ShifrWrk is null) THEN ShifrWrk = 0;
             ShifrWrk = ShifrWrk +1;
             INSERT INTO Operatory (ShifrWrk,Login,NameOp,ShifrPra,SecretRight)
                    VALUES (:ShifrWrk,CURRENT_USER,CURRENT_USER,2,0);
        END
     SUSPEND;
END^


ALTER PROCEDURE DEL_ALL_PODR (
    YEARVYFR INTEGER,
    MONTNVYFR INTEGER,
    YEARVYTO INTEGER,
    MONTHVYTO INTEGER)
AS
begin
     delete from person a where (a.yearvy>:yearvyfr and a.yearvy<:yearvyto) or
     (a.yearvy=:yearvyfr and a.yearvy=:yearvyto and a.monthvy between :montnvyfr and :monthvyto) or
     (a.yearvy=:yearvyfr and a.yearvy<:yearvyto and a.monthvy between :montnvyfr and 12) or
     (a.yearvy>:yearvyfr and a.yearvy=:yearvyto and a.monthvy between 1 and :monthvyto);
  /* Procedure Text */
end^


ALTER PROCEDURE DELETE_VY (
    MVY INTEGER,
    YVY INTEGER)
AS
BEGIN
     Delete from person a where a.yearvy=:yvy and a.monthvy=:mvy;
     delete from fadd a where a.year_vy=:yvy and a.month_vy=:mvy;
     delete from fcn a where a.year_vy=:yvy and a.month_vy=:mvy;
     delete from fud a where a.year_vy=:yvy and a.month_vy=:mvy;
END^


ALTER PROCEDURE DR8E
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    NAL_CODE CHAR(10),
    S NUMERIC(15,2),
    S1 NUMERIC(15,2))
AS
BEGIN EXIT; END^


ALTER PROCEDURE ECB_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER,
    WANTEDSHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
declare variable P decimal(15,3);
declare variable NEEDTABLE integer;
declare variable SHIFRKAT integer;
declare variable W_PLACE integer;
declare variable SUMMAADD decimal(15,2);
declare variable SUMMAFR decimal(15,2);
declare variable D date;
declare variable PROG_MIN decimal(15,2);
declare variable SHIFRIDPERSON integer;
declare variable ECBPROC decimal(15,5);
declare variable ECBNPROC decimal(15,5);
declare variable ECBILLPROC decimal(15,5);
declare variable ECBDPPROC decimal(15,5);
declare variable ECBINVPROC decimal(15,5);
begin
      p             = 0.036;
      needtable     = 0;
      w_place       = 1;
      shifrkat      = null;
      shifridperson = 0;
      D=yearza||'-'||:monthza||'-1';
      select first 1 a.ecbproc,a.ecbnproc,a.ecbillproc,a.ecbdpproc,a.ecbinvproc
             from tb_ecb a
             where a.datefr<=:d
             order by a.datefr desc
             into :ecbproc,:ecbnproc,:ecbillproc,:ecbdpproc,:ecbinvproc;
      ecbproc=coalesce(ecbproc,3.6);
      if (ecbproc>1) then
          ecbproc=ecbproc / 100;
      ecbnproc=coalesce(ecbnproc,6.1);
      if (ecbnproc>1) then
          ecbnproc=ecbnproc / 100;
      ecbillproc=coalesce(ecbillproc,2.0);
      if (ecbillproc>1) then
          ecbillproc=ecbillproc / 100;
      ecbdpproc=coalesce(ecbdpproc,2.6);
      if (ecbdpproc>1) then
          ecbdpproc=ecbdpproc / 100;
      ecbinvproc=coalesce(ecbinvproc,1.4);
      if (ecbinvproc>1) then
          ecbinvproc=ecbinvproc / 100;
      D=yearza||'-'||:monthza||'-10';
      select first 1 a.limitpens from penshea a
                              where a.datefr<:D
                              order by a.datefr desc
                              into :p;
      if (P is Not Null and Summa>p) then Summa=p;
      if (MODE=1) then
         begin
               select first 1 a.shifrkat,a.w_place,a.shifrid from tb_tmp_person a
                      where (a.w_r=1 or a.m_o_r=82) and
                            a.monthvy=:monthza      and
                            a.yearvy=:yearza        and
                            a.Tabno=:Tabno          and
                            a.main>0                and -- т е не старое место работы  изменение от 22 12 2010
                            a.w_place not between 151 and 168 --and
--                            CONN_ID=CURRENT_CONNECTION
                                                    and
                            (
                             (:wantedshifridperson=0) or ((:wantedshifridperson>0) and
                                                          (:wantedshifridperson=a.shifrid))
                            )
                      into :shifrkat, :W_Place, :shifridperson;
--               exception testputboln 'Shifrkat_0='||coalesce(shifrkat, 'null');

               if (shifrkat is null) then
                  select first 1 a.shifrkat,a.w_place,a.shifrid from tb_tmp_person a
                         where (a.w_r=1 or a.m_o_r=82) and
                                a.Tabno=:Tabno          and
                                a.w_place not between 151 and 168 --and
--                                CONN_ID=CURRENT_CONNECTION
                         order by a.yearvy desc, a.monthvy desc
                         into :shifrkat, :W_Place,:shifridperson;
--               exception testputboln 'Shifrkat_1='||Shifrkat;
         end
      else
         select first 1 a.shifrkat,a.w_place from person a
                where (a.w_r=1 or a.m_o_r=82) and
                      a.monthvy=:monthza      and
                      a.yearvy=:yearza        and
                      a.Tabno=:Tabno          and
                      a.main>0                and -- т е не старое место работы  изменение от 22 12 2010
                      a.w_place not between 151 and 168 --not (a.w_place>150 and a.W_Place<169)
                into :shifrkat, :W_Place;
      if (ShifrKat is Null) then ShifrKat=2;
      select first 1 retval from pr_is_sciped(:shifridperson, :mode) into :needTable;
      if (NeedTable=1) then
         if (mode=1) then
            begin
                 if (exists (select * from tb_tmp_fcn a
                            where (a.shifrsta =116 or a.shifrsta=616) and
                                   a.shifridperson=:shifridperson
--                                   a.Tabno=:Tabno    and
--                                   a.year_vy=:YearZa and
--                                   a.month_vy=:MonthZa --and
--                                   CONN_ID=CURRENT_CONNECTION
                                   )) then
                    needtable=0;
            end
         else
            begin
                  if (exists (select * from fcn a
                            where (a.shifrsta =116 or a.shifrsta=616) and
                                   a.Tabno=:Tabno    and
                                   a.year_vy=:YearZa and
                                   a.month_vy=:MonthZa)) then
                  needtable=0;
            end
      else
          if (mode=1) then
             begin
                  if (exists (select * from tb_tmp_fcn a
                          where (a.shifrsta=115 or a.shifrsta=615) and
                                 a.shifridperson=:shifridperson
--                                a.Tabno=:Tabno    and
--                                a.year_vy=:YearZa and
--                                a.month_vy=:MonthZa and
--                                CONN_ID=CURRENT_CONNECTION
                                )) then
                  NeedTable=1;
             end
          else
             begin
                  if (exists (select * from fcn a
                          where (a.shifrsta=115 or a.shifrsta=615) and
                                a.Tabno=:Tabno    and
                                a.year_vy=:YearZa and
                                a.month_vy=:MonthZa)) then
                  NeedTable=1;
             end
      if (NeedTable=0) then
         p=ecbproc;
      else
         p=ecbnproc;
      summaecb=summa*p;
  suspend;
end^


ALTER PROCEDURE ECBDP_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
declare variable P decimal(15,3);
declare variable D date;
declare variable ECBPROC decimal(15,5);
declare variable ECBNPROC decimal(15,5);
declare variable ECBILLPROC decimal(15,5);
declare variable ECBDPPROC decimal(15,5);
declare variable ECBINVPROC decimal(15,5);
declare variable LIMITFORECB integer;
begin
      d=yearza||'-'||monthza||'-01';
      select first 1 a.ecbproc,a.ecbnproc,a.ecbillproc,a.ecbdpproc,a.ecbinvproc
             from tb_ecb a
             where a.datefr<=:d
             order by a.datefr desc
             into :ecbproc,:ecbnproc,:ecbillproc,:ecbdpproc,:ecbinvproc;
      ecbproc=coalesce(ecbproc,3.6);
      if (ecbproc>1) then
          ecbproc=ecbproc / 100;
      ecbnproc=coalesce(ecbnproc,6.1);
      if (ecbnproc>1) then
          ecbnproc=ecbnproc / 100;
      ecbillproc=coalesce(ecbillproc,2.0);
      if (ecbillproc>1) then
          ecbillproc=ecbillproc / 100;
      ecbdpproc=coalesce(ecbdpproc,2.6);
      if (ecbdpproc>1) then
          ecbdpproc=ecbdpproc / 100;
      ecbinvproc=coalesce(ecbinvproc,1.4);
      if (ecbinvproc>1) then
          ecbinvproc=ecbinvproc / 100;
      select first 1 a.limitmax from sslimity a
                                where a.datefr<=:d
                                order by a.datefr desc
             into :limitforecb;
      limitforecb=coalesce(limitforecb,1000000);
      if (summa>limitforecb) then summa=summa-limitforecb;
      p  = ecbdpproc;
      summaecb=summa*p;
  suspend;
end^


ALTER PROCEDURE ECBILL_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECBILL DECIMAL(15,2))
AS
declare variable P decimal(15,3);
declare variable D date;
declare variable ECBPROC decimal(15,5);
declare variable ECBNPROC decimal(15,5);
declare variable ECBILLPROC decimal(15,5);
declare variable ECBDPPROC decimal(15,5);
declare variable ECBINVPROC decimal(15,5);
declare variable LIMITFORECB decimal(15,2);
begin
      p=0.02;
      D=yearza||'-'||:monthza||'-1';
      select first 1 a.ecbproc,a.ecbnproc,a.ecbillproc,a.ecbdpproc,a.ecbinvproc
             from tb_ecb a
             where a.datefr<=:d
             order by a.datefr desc
             into :ecbproc,:ecbnproc,:ecbillproc,:ecbdpproc,:ecbinvproc;
      ecbproc=coalesce(ecbproc,3.6);
      if (ecbproc>1) then
          ecbproc=ecbproc / 100;
      ecbnproc=coalesce(ecbnproc,6.1);
      if (ecbnproc>1) then
          ecbnproc=ecbnproc / 100;
      ecbillproc=coalesce(ecbillproc,2.0);
      if (ecbillproc>1) then
          ecbillproc=ecbillproc / 100;
      ecbdpproc=coalesce(ecbdpproc,2.6);
      if (ecbdpproc>1) then
          ecbdpproc=ecbdpproc / 100;
      ecbinvproc=coalesce(ecbinvproc,1.4);
      if (ecbinvproc>1) then
          ecbinvproc=ecbinvproc / 100;
      select first 1 a.limitmax from sslimity a
                                where a.datefr<=:d
                                order by a.datefr desc
             into :limitforecb;
      limitforecb=coalesce(limitforecb,1000000);
      if (summa>limitforecb) then summa=summa-limitforecb;

      p=ecbillproc;
      summaecbill=summa*p;
  suspend;
end^


ALTER PROCEDURE ECBN_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAECB DECIMAL(15,2))
AS
declare variable P decimal(15,3);
declare variable D date;
declare variable ECBPROC decimal(15,5);
declare variable ECBNPROC decimal(15,5);
declare variable ECBILLPROC decimal(15,5);
declare variable ECBDPPROC decimal(15,5);
declare variable ECBINVPROC decimal(15,5);
declare variable LIMITFORECB integer;
begin
      d=yearza||'-'||monthza||'-01';
      select first 1 a.ecbproc,a.ecbnproc,a.ecbillproc,a.ecbdpproc,a.ecbinvproc
             from tb_ecb a
             where a.datefr<=:d
             order by a.datefr desc
             into :ecbproc,:ecbnproc,:ecbillproc,:ecbdpproc,:ecbinvproc;
      ecbproc=coalesce(ecbproc,3.6);
      if (ecbproc>1) then
          ecbproc=ecbproc / 100;
      ecbnproc=coalesce(ecbnproc,6.1);
      if (ecbnproc>1) then
          ecbnproc=ecbnproc / 100;
      ecbillproc=coalesce(ecbillproc,2.0);
      if (ecbillproc>1) then
          ecbillproc=ecbillproc / 100;
      ecbdpproc=coalesce(ecbdpproc,2.6);
      if (ecbdpproc>1) then
          ecbdpproc=ecbdpproc / 100;
      ecbinvproc=coalesce(ecbinvproc,1.4);
      if (ecbinvproc>1) then
          ecbinvproc=ecbinvproc / 100;
      select first 1 a.limitmax from sslimity a
                                where a.datefr<=:d
                                order by a.datefr desc
             into :limitforecb;
      limitforecb=coalesce(limitforecb,1000000);
      if (summa>limitforecb) then summa=limitforecb;
      p  = ecbnproc;
      summaecb=summa*p;
  suspend;
end^


ALTER PROCEDURE FZ (
    SUMMA DECIMAL(15,2),
    YEARZA INTEGER,
    MONTHZA INTEGER,
    TABNO INTEGER)
RETURNS (
    SUMMAFZ DECIMAL(15,2))
AS
declare variable pensioner integer;
declare variable d date;
declare variable limitmax decimal(15,2);
begin
/* с 13 январь 6% и берется с пенсионеров*/
     if (yearza<2009) then
         SUMMAFZ=SUMMA*0.005;
     else
         begin
              d=YearZa||'-'||MonthZa||'-10';
              select first 1 a.limitmax from sslimity a
                      WHERE :D>A.datefr
                      ORDER by A.DATEFR desc
                      into :limitmax;
              if (summa>coalesce(:limitmax, 10035.00)) then
                 summa=coalesce(:limitmax, 10035.00);
        if (yearza=2009 and monthza=1) then
           begin
              pensioner=0;
              -- Проверить пенсионера
              if (exists (select first 1 ShifrSta from fcn
                        where tabno    = :tabno   and
                              Month_Vy = :MonthZa and
                              Year_Vy  = :YearZa  and
                              ((ShifrSta = 107)  or (ShifrSta=107+500)))
                              ) then pensioner=1;
               if (pensioner=1) then
                  SUMMAFZ=(SUMMA/20*14*0.006);
               else
                  SUMMAFZ=(SUMMA/20*6*0.005) + (SUMMA/20*14*0.006);
           end
        else
           SUMMAFZ=SUMMA*0.006;
         end
     suspend;
end^


ALTER PROCEDURE GETALIMNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAALIM DECIMAL(15,2))
AS
begin
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where alim>0           and
                   month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   Tabno=:Tabno
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (55,56,57,58)      and
                   Tabno=:Tabno
             INTO SummaAlim;
      if (SummaAlim is Null) then SummaAlim=0;


  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETALIMNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAALIM DECIMAL(15,2))
AS
begin
      if (mode=1) then
         select sum(summa) from tb_tmp_fadd join shifr on
                tb_tmp_fadd.shifrsta=shifr.shifr
                where podoh>0           and
                       (((tb_tmp_fadd.shifrsta in (5,6,10,11))
                         and month_za=:MonthZa
                         and year_za=:YearZa) or
                       (tb_tmp_fadd.shifrsta not in (5,6,10,11) and
                       month_Vy=:MonthZa and
                       Year_Vy=:YearZa))   and
                      Tabno=:Tabno      and
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson)))
--                      and CONN_ID=CURRENT_CONNECTION
                INTO :SummaAdd;
      else
         select sum(summa) from fadd join shifr on
                fadd.shifrsta=shifr.shifr
                where podoh>0           and
                       (((fadd.shifrsta in (5,6,10,11))
                         and month_za=:MonthZa
                         and year_za=:YearZa) or
                       (fadd.shifrsta not in (5,6,10,11) and
                       month_Vy=:MonthZa and
                       Year_Vy=:YearZa))   and
                      Tabno=:Tabno      and
                     ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson)))
                INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (mode=1) then
         select sum(summa) from tb_tmp_fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta in (55,56,57,58)       and
                      Tabno=:Tabno      and
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                      conn_id=current_connection
                INTO SummaAlim;
      else
         select sum(summa) from fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta in (55,56,57,58)       and
                      Tabno=:Tabno      and
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson)))
                INTO SummaAlim;
      if (SummaAlim is Null) then SummaAlim=0;
  suspend;
end^


ALTER PROCEDURE GETECBDPNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
begin
   --   if (mode_person=1) then
    --      exception e_p07 'mode='||:mode;
      if (mode=1) then
         begin
     --         if (mode_person=1) then
     --            exception e_p07 'idp='||:shifridperson;
          select sum(summa) from tb_tmp_fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb,0)=1       and
/*
                       (((tb_tmp_fadd.shifrsta in (5,6,10,11,154,155,158))
                         and month_za=:MonthZa
                         and year_za=:YearZa) or
                       (tb_tmp_fadd.shifrsta not in (5,6,10,11,154,155) and
                       month_Vy=:MonthZa and
                       Year_Vy=:YearZa))   and
*/
                       am.shifrsta in (1,158)   and
                       am.month_Za = :MonthZa   and
                       am.Year_Za  = :YearZa    and
                       Tabno=:Tabno      and
                       ((year_vy>=2011) or (need=1))     and
--                       tb_tmp_fadd.w_place not in (106) and          -- мат помощь не считать
--                       w_place in (81,140,57) and

                       (
                        (coalesce((select first 1 retval from pr_is_dogpod(am.w_place)),0)=1)
                        or
                        not exists (select * from tb_tmp_fadd dd
                                             where dd.shifridperson=am.shifridperson
                                               and dd.shifrsta<>158)
                       )
                       and
                 --      coalesce((select first 1 retval from pr_is_dogpod(w_place)),0)=1  and

                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                       ) and
                       am.CONN_ID=CURRENT_CONNECTION
                 INTO :SummaAdd;
       --       if (mode_person=1) then
       --          exception e_p07 'SummaAdd='||SummaAdd;

         end
      else
          select sum(summa) from fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb,0)=1
/*
                       (((fadd.shifrsta in (5,6,10,11,154,155,158))
                         and month_za=:MonthZa
                         and year_za=:YearZa) or
                       (fadd.shifrsta not in (5,6,10,11,154,155) and
                       month_Vy=:MonthZa and
                       Year_Vy=:YearZa))   and
*/
                       and am.shifrsta in (1,158)
                       and am.month_za=:MonthZa
                       and am.year_za=:YearZa
                       and am.Tabno=:Tabno
                       and am.year_vy>=2011

        --               w_place in (81,140) and
                       and
                       (
                        (coalesce((select first 1 retval from pr_is_dogpod(am.w_place)),0)=1)
                        or
                        not exists (select * from fadd dd
                                             where dd.shifridperson=am.shifridperson
                                               and dd.shifrsta<>158)
                       )
                       and

--                       coalesce((select first 1 retval from pr_is_dogpod(am.w_place)),0)=1  and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,0))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,0))))
                       )

                    INTO :SummaAdd;
      SummaAdd=coalesce(SummaAdd,0);
      if (mode=1) then
         select sum(summa) from tb_tmp_fud
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (146) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
                   (
                    (coalesce((select first 1 retval from pr_is_dogpod(w_place)),0)=1)
                    or
                    not exists (select * from tb_tmp_fadd dd
                                        where dd.shifridperson=tb_tmp_fud.shifridperson
                                           and dd.shifrsta<>158)
                   )
                   and

--                   w_place in (81,140) and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fud.shifridperson,1))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,1))))
                   ) and
                   CONN_ID=CURRENT_CONNECTION
             INTO :SummaECB;
      else
         select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (146) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
                   (
                    (coalesce((select first 1 retval from pr_is_dogpod(w_place)),0)=1)
                    or
                    not exists (select * from fadd dd
                                        where dd.shifridperson=fud.shifridperson
                                           and dd.shifrsta<>158)
                   )
                   and
--                   w_place in (81,140) and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fud.shifridperson,0))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,0))))
                   )
             INTO :SummaECB;
      SummaECB=coalesce(SummaECB,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETECBILLNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2))
AS
begin
      if (mode=1) then
          select sum(summa) from tb_tmp_fadd join shifr on
                 tb_tmp_fadd.shifrsta=shifr.shifr
                 where coalesce(shifr.ecb_ill,0)>0   and
                       tb_tmp_fadd.month_Za=:MonthZa and
                       tb_tmp_fadd.Year_Za=:YearZa   and
-- c Декретного больничного берется ЕСВ - больничный с 1 июля 2013
                       (
                        (tb_tmp_fadd.shifrsta<>32) or
                        (
                         (tb_tmp_fadd.shifrsta=32) and
                         (cast(:YearZa||'-'||:MonthZa||'-01' as date)>=cast('2013-07-01' as date))
                        )
                       )  and
                       Tabno=:Tabno      and
                       year_vy>=2011     and
                       tb_tmp_fadd.w_place not in (106) and          -- мат помощь не считать
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fadd.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                       ) and
                       CONN_ID=CURRENT_CONNECTION

                 INTO :SummaAdd;
      else
          select sum(summa) from fadd join shifr on
                 fadd.shifrsta=shifr.shifr
                 where coalesce(shifr.ecb_ill,0)=1   and
                       fadd.month_Za=:MonthZa and
                       fadd.Year_Za=:YearZa   and
                       Tabno=:Tabno      and
                       year_vy>=2011     and
                       fadd.w_place not in (106) and          -- мат помощь не считать
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fadd.shifridperson,0))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,0))))
                       )
                       INTO :SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (mode=1) then
         select sum(summa) from tb_tmp_fud
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (145) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fud.shifridperson,1))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,1))))
                   ) and
                   CONN_ID=CURRENT_CONNECTION
             INTO :SummaECBIll;
      else
         select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (145) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fud.shifridperson,0))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,0))))
                   )
             INTO :SummaECBIll;
      if (SummaECBIll is Null) then SummaECBIll=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETECBNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
begin
   --   if (mode_person=1) then
    --      exception e_p07 'mode='||:mode;
      if (mode=1) then
         begin
     --         if (mode_person=1) then
     --            exception e_p07 'idp='||:shifridperson;
          select sum(summa) from tb_tmp_fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb,0)=1       and

                       ((((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))=1)       -- Отпускные
                         and am.month_za=:MonthZa
                         and am.year_za=:YearZa) or
                       (((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))<>1) and       -- Отпускные
--                       tb_tmp_fadd.shifrsta not in (5,6,10,11,154,155) and  -- Отпускные
                       am.month_Vy=:MonthZa and
                       am.Year_Vy=:YearZa))   and
                       am.Tabno=:Tabno      and
                       ((am.year_vy>=2011) or (am.need=1))     and
                       am.w_place not in (106) and          -- мат помощь не считать
                       (
                         ((select retval from pr_is_dogpod(am.w_place))<>1)
                         and
                         (exists (select * from tb_tmp_fadd dd
                             where dd.shifridperson=am.shifridperson
                               and dd.shifrsta<>158)
                         )
                       )
                        and
--                       tb_tmp_fadd.w_place not in (81,140,157) and -- договора подряда
                       ((select first 1 retval from pr_is_sciped(am.shifridperson,1))<>1) and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                       ) and
                       CONN_ID=CURRENT_CONNECTION
                 INTO :SummaAdd;
       --       if (mode_person=1) then
       --          exception e_p07 'SummaAdd='||SummaAdd;

         end
      else
          select sum(summa) from fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb, 0)=1       and
                       ((((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))=1)       -- Отпускные
                         and am.month_za=:MonthZa
                         and am.year_za=:YearZa) or
                       (((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))<>1) and       -- Отпускные
--                       fadd.shifrsta not in (5,6,10,11,154,155) and
                       am.month_Vy=:MonthZa and
                       am.Year_Vy=:YearZa))   and
                       am.Tabno=:Tabno      and
                       am.year_vy>=2011     and
                       (
                         ((select retval from pr_is_dogpod(am.w_place))<>1)
                         and
                         (exists (select * from fadd dd
                             where dd.shifridperson=am.shifridperson
                               and dd.shifrsta<>158)
                         )
                       )
                        and
--                       fadd.w_place not in (81,140) and -- договора подряда
                       am.w_place not in (106) and          -- мат помощь не считать
                       ((select first 1 retval from pr_is_sciped(am.shifridperson,0))<>1) and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,0))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,0))))
                       )                 INTO :SummaAdd;
      SummaAdd=coalesce(SummaAdd,0);
      if (mode=1) then
         select sum(summa) from tb_tmp_fud
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (142) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
--                   ((select first 1 retval from pr_is_sciped(fadd.shifridperson,1))<>1) and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fud.shifridperson,1))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,1))))
                   ) and
                   CONN_ID=CURRENT_CONNECTION
             INTO :SummaECB;
      else
         select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (142) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fud.shifridperson,0))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,0))))
                   )
             INTO :SummaECB;
      SummaECB=coalesce(SummaECB,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETECBNNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
AS
begin
   --   if (mode_person=1) then
      if (mode=1) then
         begin
     --         if (mode_person=1) then
     --            exception e_p07 'idp='||:shifridperson;
          select sum(summa) from tb_tmp_fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb,0)=1       and
--                       (((tb_tmp_fadd.shifrsta in (5,6,10,11,154,155))
                       ((((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))=1)       -- Отпускные
                         and am.month_za=:MonthZa
                         and am.year_za=:YearZa) or
                       (((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))<>1) and       -- Отпускные
--                       (tb_tmp_fadd.shifrsta not in (5,6,10,11,154,155) and
                       am.month_Vy=:MonthZa and
                       am.Year_Vy=:YearZa))   and
                       am.Tabno=:Tabno      and
                       ((am.year_vy>=2011) or (am.need=1))     and
                       am.w_place not in (106) and          -- мат помощь не считать
                       (
                         ((select retval from pr_is_dogpod(am.w_place))<>1)
                         and
                         (exists (select * from tb_tmp_fadd dd
                             where dd.shifridperson=am.shifridperson
                               and dd.shifrsta<>158)
                         )
                       )
                        and
                       ((select first 1 retval from pr_is_sciped(am.shifridperson,1))=1) and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                       )
          --             and CONN_ID=CURRENT_CONNECTION
                 INTO :SummaAdd;
        --        exception e_p07 'Summa='||coalesce(summaadd, 0);
       --       if (mode_person=1) then
       --          exception e_p07 'SummaAdd='||SummaAdd;

         end
      else
          select sum(summa) from fadd am join shifr s on
                 am.shifrsta=s.shifr
                 where coalesce(s.ecb,0)=1       and
                       ((((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))=1)       -- Отпускные
--                       (((fadd.shifrsta in (5,6,10,11,154,155))
                         and am.month_za=:MonthZa
                         and am.year_za=:YearZa) or
--                       (fadd.shifrsta not in (5,6,10,11,154,155) and
                       (((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(am.shifrSTA))<>1) and       -- Отпускные
                       am.month_Vy=:MonthZa and
                       am.Year_Vy=:YearZa))   and
                       am.Tabno=:Tabno      and
                       am.year_vy>=2011     and
                       (
                         ((select retval from pr_is_dogpod(am.w_place))<>1)
                         and
                         (exists (select * from fadd dd
                             where dd.shifridperson=am.shifridperson
                               and dd.shifrsta<>158)
                         )
                       )
                        and
                       am.w_place not in (106) and          -- мат помощь не считать
                       ((select first 1 retval from pr_is_sciped(am.shifridperson,0))=1) and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=am.shifridperson))) and
                       ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(am.shifridperson,0))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,0))))
                       )                 INTO :SummaAdd;
      SummaAdd=coalesce(SummaAdd,0);
      if (mode=1) then
         select sum(summa) from tb_tmp_fud
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (143) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
           --        ((select first 1 retval from pr_is_sciped(tb_tmp_fud.shifridperson,1))=1) and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fud.shifridperson,1))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,1))))
                   ) and
                   CONN_ID=CURRENT_CONNECTION
             INTO :SummaECB;
      else
         select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta in (143) and
                   Tabno=:Tabno      and
                   year_vy>=2011     and
       --            ((select first 1 retval from pr_is_sciped(fud.shifridperson,0))=1) and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson))) and
                   ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fud.shifridperson,0))=
                                                              (select first 1 guid from pr_getguid(:shifridperson,0))))
                   )
             INTO :SummaECB;
      SummaECB=coalesce(SummaECB,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETFZNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2))
AS
begin
      select first 1 SUMMAADD, SUMMAFZ  FROM getfznachud_common(:TABNO,:YEARZA,:MONTHZA,0,0,0)
             into :SUMMAADD, :SUMMAFZ;
      suspend;
/* С пенсионеров фонд занятости не берется
      pensioner = 0;
      if (exists (select first 1 ShifrSta from fcn
                        where tabno    = :tabno   and
                              Month_Vy = :MonthZa and
                              Year_Vy  = :YearZa  and
                              ((ShifrSta = 107)  or (ShifrSta=107+500)))
                              ) then pensioner=1;
      if (Pensioner=0) then
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where FondZ>0              and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=fadd.W_PLACE) and
                   month_ZA = :MonthZa  and
                   Year_Za  = :YearZa   and
                   Tabno    = :Tabno
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      select sum(summa) from fUD
             where month_ZA = :MonthZa and
                   Year_Za  = :YearZa   and
                   ShifrSta =  88       and
                   Tabno    = :Tabno
             INTO SummaFZ;
      if (SummaFz is Null) then SummaFz=0;
  suspend;
  */

end^


ALTER PROCEDURE GETFZNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAFZ DECIMAL(15,2))
AS
declare variable pensioner integer;
begin
/* С пенсионеров фонд занятости не берется */
/* c 13 01 2009 и с пенсионеров берется    */
      pensioner = 0;
      if (mode=1) then
         begin
             if (exists (select first 1 ShifrSta from tb_tmp_fcn
                        where tabno    = :tabno   and
                              Month_Vy = :MonthZa and
                              Year_Vy  = :YearZa  and
                              Conn_id  = current_connection and
                              ((ShifrSta = 107)  or (ShifrSta=107+500)))
                              ) then pensioner=1;
         end
      else
         begin
              if (exists (select first 1 ShifrSta from fcn
                        where tabno    = :tabno   and
                              Month_Vy = :MonthZa and
                              Year_Vy  = :YearZa  and
                              ((ShifrSta = 107)  or (ShifrSta=107+500)))
                              ) then pensioner=1;
         end
      if ((Pensioner=0) or ((Pensioner=1) and (YearZa>2008)))  then
         if (mode=1) then
           select sum(summa) from tb_tmp_fadd join shifr on
             tb_tmp_fadd.shifrsta=shifr.shifr
             where FondZ>0              and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=tb_tmp_fadd.W_PLACE) and
                   month_ZA = :MonthZa  and
                   Year_Za  = :YearZa   and
                   Tabno    = :Tabno    and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson))) and
                   Conn_id  = CURRENT_CONNECTION
             INTO SummaAdd;
         else
           select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where FondZ>0              and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=fadd.W_PLACE) and
                   month_ZA = :MonthZa  and
                   Year_Za  = :YearZa   and
                   Tabno    = :Tabno    and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson)))
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (mode=1) then
         select sum(summa) from tb_tmp_fUD
             where month_ZA = :MonthZa and
                   Year_Za  = :YearZa   and
                   ShifrSta =  88       and
                   Tabno    = :Tabno    and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   CONN_ID  = CURRENT_CONNECTION
             INTO SummaFZ;
      else
         select sum(summa) from fUD
             where month_ZA = :MonthZa  and
                   Year_Za  = :YearZa   and
                   ShifrSta =  88       and
                   Tabno    = :Tabno    and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson)))
             INTO SummaFZ;
      if (SummaFz is Null) then SummaFz=0;
  /* Procedure Text */
  suspend;

end^


ALTER PROCEDURE GETKATGRU (
    TABNO INTEGER)
RETURNS (
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    NAMEKAT VARCHAR(20),
    NAMEGRU VARCHAR(20),
    W_PLACE INTEGER)
AS
begin
  /* Procedure Text */
  select first 1 g.shifr, g.name, k.shifr, k.name,p.w_place from person p join gruppy g on p.shifrgru=g.shifr
                       join kateg k on p.shifrkat=k.shifr
         where Tabno=:Tabno  and p.w_r=1
         order by p.yearvy desc, p.monthvy desc
         into :shifrgru, :namegru,:shifrkat,  :namekat , :w_place;
  if (ShifrGru is Null) then ShifrGru=0;
  if (ShifrKat is Null) then ShifrKat=0;
  if (NameGru is Null) then NameGru='';
  if (NameKat is Null) then NameKat='';
  suspend;
end^


ALTER PROCEDURE GETKWODAYBETWEENTWODATE (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    KOW INTEGER)
AS
declare variable currdate date;
declare variable kwoday integer;
declare variable c integer;
declare variable p date;
begin
     kwoday=0;
     if (datefr<=dateto) then
        begin
              CurrDate=DateFr;
              while (CurrDate<=DateTo) do
               begin
                     if (kwoday>300) then break;
                     select first 1 prazdniki.DatePrz from prazdniki
                            where prazdniki.mode=1 and
                                  prazdniki.dateprz=:CurrDate
                            into :p;
                     C=CurrDate-cast('100-01-01'as date)+4;
                     Kow=C-(C / 7)*7;
                     if (Kow<>6 and p is null) then
                     KwoDay=KwoDay+1;
                     CurrDate=CurrDate+1;
               end
        end
  kow=KwoDay;
  suspend;
end^


ALTER PROCEDURE GETNEWIDBOLN
RETURNS (
    SHIFRID INTEGER)
AS
begin
  shifrid=gen_id(GBOLN,1);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETNEWIDOTP
RETURNS (
    SHIFRID INTEGER)
AS
begin
  shifrid=gen_id(Gotpuska,1);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETPENSNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2))
AS
begin
      select FIRST 1 SUMMAADD,SUMMAPENS  FROM GETPENSNACHUD_COMMON(:tabno, :YEARZA,:MONTHZA,0,0,0)
             into :SUMMAADD,:SUMMAPENS;
      SUSPEND;
/*
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where pens>0           and
                   month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   Tabno=:Tabno
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta=75       and
                   Tabno=:Tabno
             INTO SummaPENS;
      if (SummaPens is Null) then SummaPens=0;
   Procedure Text */
end^


ALTER PROCEDURE GETPENSNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPENS DECIMAL(15,2))
AS
begin
      if (mode=1) then
          select sum(summa) from tb_tmp_fadd join shifr on
                 tb_tmp_fadd.shifrsta=shifr.shifr
                 where pens>0            and
                       month_ZA=:MonthZa and
                       Year_Za=:YearZa   and
                       Tabno=:Tabno      and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson))) and
                       CONN_ID=CURRENT_CONNECTION
                 INTO SummaAdd;
      else
          select sum(summa) from fadd join shifr on
                 fadd.shifrsta=shifr.shifr
                 where pens>0           and
                       month_ZA=:MonthZa and
                       Year_Za=:YearZa   and
                       Tabno=:Tabno      and
                       ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson)))
                 INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (mode=1) then
         select sum(summa) from tb_tmp_fud
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta=75       and
                   Tabno=:Tabno      and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                   CONN_ID=CURRENT_CONNECTION
             INTO SummaPENS;
      else
         select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta=75       and
                   Tabno=:Tabno      and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson)))
             INTO SummaPENS;
      if (SummaPens is Null) then SummaPens=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETPERSONID
RETURNS (
    NUM INTEGER)
AS
BEGIN EXIT; END^


ALTER PROCEDURE GETPODNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
begin
      select first 1 summaadd, SUMMAPOD
             from GETPODNACHUD_COMMON(:TABNO,:yearza, :MONTHZA,0,0,0,0)
             into :summaadd, :SUMMAPOD;
      suspend;
/*
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where podoh>0           and
                   month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   Tabno=:Tabno
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta=50       and
                   Tabno=:Tabno
             INTO SummaPod;
      if (SummaPod is Null) then SummaPod=0;
  suspend;*/
end^


ALTER PROCEDURE GETPODNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER,
    MODE_PERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
begin
      if (mode=1) then
         select sum(summa) from tb_tmp_fadd join shifr on
                tb_tmp_fadd.shifrsta=shifr.shifr
                where podoh>0           and

                  ((tb_tmp_fadd.year_vy  = :yearza and tb_tmp_fadd.month_vy = :monthza and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR_Y(tb_tmp_fadd.shifrSTA,tb_tmp_fadd.year_za))<>1)) or
                        (tb_tmp_fadd.year_ZA  = :yearza and tb_tmp_fadd.month_ZA = :monthza and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR_Y(tb_tmp_fadd.shifrSTA,tb_tmp_fadd.year_za))=1))
                       )  and
                      Tabno=:Tabno      and
                      w_place not in (105,106) and   -- изменение от 11 10 10 для обл мат пом
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson))) and
--                      and CONN_ID=CURRENT_CONNECTION
                      ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fadd.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                       )
                INTO :SummaAdd;
      else
         select sum(summa) from fadd join shifr on
                fadd.shifrsta=shifr.shifr
                where podoh>0           and
                  ((fadd.year_vy  = :yearza and fadd.month_vy = :monthza and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR_y(fadd.shifrSTA,fadd.year_za))<>1)) or
                        (fadd.year_ZA  = :yearza and fadd.month_ZA = :monthza and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR_Y(fadd.shifrSTA,fadd.year_za))=1))
                       )  and
                      Tabno=:Tabno      and
                      w_place not in (105,106) and  -- изменение от 11 10 10 для обл мат пом
                     ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson))) and
                     ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fadd.shifridperson,0))=
                                                                 (select first 1 guid from pr_getguid(:shifridperson,0))))
                       )

                INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (mode=1) then
         select sum(summa) from tb_tmp_fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta=50       and
                      Tabno=:Tabno
--                      and (
--                            (:YearZa<2016)
--                            or
--                            ((:yearZa>=2016)
--                             and
--                             (year_vy=:yearza)
--                             and
--                             (month_vy=:monthza)
--                             )
--                          )
                      and
                      w_place not in (105,106) and  -- изменение от 11 10 10 для обл мат пом
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                      ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(tb_tmp_fud.shifridperson,1))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,1))))
                      )
      ---             and  conn_id=current_connection
                INTO SummaPod;
      else
         select sum(summa) from fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta=50       and
                      Tabno=:Tabno
                      and (
                            (:YearZa<2016)
                            or
                            ((:yearZa>=2016)
                             and
                             (year_vy=:yearza)
                             and
                             (month_vy=:monthza)
                             )
                          )
                      and

                      w_place not in (105,106) and  -- изменение от 11 10 10 для обл мат пом
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson))) and
                      ((:mode_person=0) or ((:mode_person=1) and ((select first 1 guid from pr_getguid(fud.shifridperson,0))=
                                                                  (select first 1 guid from pr_getguid(:shifridperson,0))))
                      )
                INTO SummaPod;
      if (SummaPod is Null) then SummaPod=0;
  suspend;
end^


ALTER PROCEDURE GETSSNACHUD (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
begin
      select first 1 SUMMAADD,SUMMASS
             from GETSSNACHUD_COMMON(:tabno, :yearza, :monthza, 0,0,0)
             into :SUMMAADD,:SUMMASS;
      suspend;
/*
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where ss>0                 and
                   month_ZA =: MonthZa  and
                   Year_Za  =: YearZa   and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=fadd.W_PLACE) and
                   Tabno    =:Tabno
             INTO SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      select sum(summa) from fUD
             where month_ZA=:MonthZa and
                   Year_Za=:YearZa   and
                   ShifrSta=106      and
                   Tabno=:Tabno
             INTO SummaSS;
      if (SummaSS is Null) then SummaSS=0;
  suspend;*/
end^


ALTER PROCEDURE GETSSNACHUD_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER,
    MODE_DETAIL INTEGER,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
begin
      if (mode=1) then
         select sum(summa) from tb_tmp_fadd join shifr on
             tb_tmp_fadd.shifrsta=shifr.shifr
             where ss>0                 and
                   month_ZA =:MonthZa   and
                   Year_Za  =:YearZa    and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=tb_tmp_fadd.W_PLACE) and
                   Tabno    =:Tabno     and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fadd.shifridperson))) and
                   CONN_ID  = CURRENT_CONNECTION
             INTO :SummaAdd;
      else
      select sum(summa) from fadd join shifr on
             fadd.shifrsta=shifr.shifr
             where ss>0                 and
                   month_ZA =: MonthZa  and
                   Year_Za  =: YearZa   and
                   not exists (select shifrpod from tb_dogpod where tb_dogpod.shifrpod=fadd.W_PLACE) and
                   Tabno    =:Tabno     and
                   ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fadd.shifridperson)))
             INTO :SummaAdd;
      if (SummaAdd is Null) then SummaAdd=0;
      if (Mode=1) then
         select sum(summa) from tb_tmp_fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta=106      and
                      Tabno=:Tabno      and
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=tb_tmp_fud.shifridperson))) and
                      CONN_ID=CURRENT_CONNECTION
                INTO :SummaSS;
      else
         select sum(summa) from fUD
                where month_ZA=:MonthZa and
                      Year_Za=:YearZa   and
                      ShifrSta=106      and
                      Tabno=:Tabno      and
                      ((:mode_detail=0) or ((:mode_detail=1) and (:shifridperson=fud.shifridperson)))
                INTO :SummaSS;
      if (SummaSS is Null) then SummaSS=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GETSUMMYRASPERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMAADDPOD DECIMAL(15,2),
    SUMMAUDPOD DECIMAL(15,2),
    SUMMAADDALIM DECIMAL(15,2),
    SUMMAUDALIM DECIMAL(15,2),
    SUMMAADDPENS DECIMAL(15,2),
    SUMMAUDPENS DECIMAL(15,2),
    SUMMAADDSS DECIMAL(15,2),
    SUMMAUDSS DECIMAL(15,2),
    SUMMAADDFZ DECIMAL(15,2),
    SUMMAUDFZ DECIMAL(15,2))
AS
begin
   select summaadd,summapod from  getpodnachud(:tabno,:y,:m) into :summaaddpod,:summaudpod;
   select summaadd,summaalim from  getalimnachud(:tabno,:y,:m) into :summaaddalim,:summaudalim;
   select summaadd,summapens from  getpensnachud(:tabno,:y,:m) into :summaaddpens,:summaudpens;
   select summaadd,summass from  getssnachud(:tabno,:y,:m) into :summaaddss,:summaudss;
   select summaadd,summafz from  getfznachud(:tabno,:y,:m) into :summaaddfz,:summaudfz;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE GT2660
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    NALCODE VARCHAR(10),
    TOT NUMERIC(15,2),
    BUD NUMERIC(15,2),
    GN NUMERIC(15,2),
    OTHER NUMERIC(15,2))
AS
declare variable shifrid integer;
declare variable gruppa integer;
declare variable t decimal(10,2);
declare variable tt decimal(10,2);
begin
  /* Procedure Text */
  for select tabno,fio,nal_code from kadry
     into :tabno,
          :fio,
          :nalcode
   do
     begin
          tot=0;
          bud=0;
          gn=0;
          other=0;

          for select shifrid,shifrgru from person
              where  person.TABNO=:tabno and person.MONTHVY=2 and
                     person.YEARVY=2004
              into :shifrid,
                   :Gruppa
           do
             begin
                  T=0;

                  for select SUMMA from FADD where FADD.ShifrIdPerson=:SHIFRID
                  into :TT do T=T+TT;
                  tot=tot+t;
                  if (gruppa=1) then bud=bud+t;
                                else
                  if (gruppa=3) then gn=gn+t;
                                else other=other+t;

             end
/*          if (tot>2660) then suspend;*/
          suspend;
     end
end^


ALTER PROCEDURE GT2660ZA (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    NALCODE VARCHAR(10),
    TOT NUMERIC(15,2),
    BUD NUMERIC(15,2),
    GN NUMERIC(15,2),
    OTHER NUMERIC(15,2))
AS
declare variable gruppa integer;
declare variable t decimal(10,2);
begin
  /* Procedure Text */
  for select tabno,fio,nal_code from kadry
     into :tabno,
          :fio,
          :nalcode
   do
     begin
          tot=0;
          bud=0;
          gn=0;
          other=0;

          for select fadd.SUMMA,fadd.shifrgru from FADD,PERSON where FADD.YEAR_ZA=:WYEAR  AND
                                                         FADD.MONTH_ZA=:WMONTH  AND
                                                         FADD.TABNO=:TABNO AND
                                                         FADD.YEAR_VY=2003 AND
                                                         FADD.MONTH_VY>0 AND
                                                         FADD.SHIFRIDPerson=PERSON.SHIFRID
              into :T,:gruppa
           do
             begin
                  tot=tot+t;
                  if (gruppa=1) then bud=bud+t;
                                else
                  if (gruppa=3) then gn=gn+t;
                                else other=other+t;

             end
/*          if (tot>2660) then suspend;*/
          suspend;
     end
end^


ALTER PROCEDURE ILL_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
declare variable DAYNO integer;
declare variable CODE integer;
declare variable WD date;
declare variable L integer;
begin
   RetVal=0;
   select first 1 l from lenmonth(:Dt) into :l;
   if (l is null) then l=31;
   select first 1 shifrid from person a
          where tabno=:tabno and
                a.monthvy=extract(month from :dt) and
                a.yearvy=extract(year from :dt) and
                a.w_r=1
          into :id;
   if (id is not null) then
      begin

           for
              select b.dayno,b.code from tabel b
                     where b.shifrid=:id and b.dayno<=:L
                     order by b.dayno
                     into :dayno,:code
           do
              begin
                   if (:Code=1) then
                      begin
                            wd=extract(year from dt)||'-'||extract(month from dt)||'-'||dayno;
                            if (exists (select c.shifrid from boln c
                                           where :wd between c.f_data and c.l_data and
                                                 c.mode_ill<>10   and          -- исключить командировки
                                                 c.tabno=:tabno))  then
                               RetVal=RetVal + 1;
                      end
                    else
                     if (:Code=13) then
                         RetVal=RetVal+1;
              end
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE INSERT_DOLG (
    SHIFRDOL INTEGER,
    NAMEDOL CHAR(50),
    RAZR INTEGER,
    OKLAD DECIMAL(15,2))
AS
begin
      update tb_dolg a
        set a.name=:namedol
        where a.ShifrDol=:ShifrDol;
      if (ROW_COUNT=0) then
         insert into tb_dolg (shifrdol,name,razr, oklad)
                values (:ShifrDol,:NameDol,:razr, :oklad);
  /* Procedure Text */
end^


ALTER PROCEDURE INSERT_KADRY (
    TABNO INTEGER,
    FIO VARCHAR(51),
    NAL_CODE VARCHAR(10),
    SHIFR_POD INTEGER,
    DP INTEGER,
    MP INTEGER,
    YP INTEGER,
    DU INTEGER,
    MU INTEGER,
    YU INTEGER)
AS
declare variable DATAPRI date;
declare variable DATAUW date;
begin
     datapri=null;
     datauw =null;
     if ((yp between 1960 and 2020) and
         (mp between 1 and 12)      and
         (dp between 1 and 31))     then
        datapri=yp||'-'||mp||'-'||dp;
     if ((yu between 1960 and 2020) and
         (mu between 1 and 12)      and
         (du between 1 and 31))     then
        datauw=yu||'-'||mu||'-'||du;
     update kadry
      set fio       = :fio       ,
          nal_code  = :nal_code  ,
          shifr_pod = :shifr_pod ,
          data_pri  = :datapri   ,
          data_uw   = :datauw
      where tabno=:tabno;
     if (row_count=0) then
        INSERT INTO KADRY (TABNO,FIO,NAL_CODE,SHIFR_POD,DATA_PRI,DATA_UW) VALUES
                         (:TABNO,:FIO,:NAL_CODE,:SHIFR_POD,:datapri,:DataUw);
end^


ALTER PROCEDURE INSERT_PODR (
    SHIFRPOD INTEGER,
    NAMEPOD CHAR(128))
AS
declare variable shifrp integer;
declare variable name varchar(128);
declare variable datewrk date;
begin
      select count(*) from podr where podr.shifrpod=:shifrpod into :shifrp;
      if (ShifrP=0) then
         insert into podr (shifrpod,name)
               values (:ShifrPod,:NamePod);
      else
       begin
            select first 1 podr.name from podr
                   where podr.shifrpod=:shifrpod
                   into :name;
            if (ltrim(rtrim(:name))<>ltrim(rtrim(:namePod))) then
                begin
                     datewrk=extract(year from current_date)||'-'||extract(month from current_date)||'-01';
                     delete from tb_podr_history where shifrpod=:Shifrpod and DateTo=datewrk;
                     insert into tb_podr_history (shifrpod,name, dateto)
                            values(:shifrpod, :name,:datewrk);
                end
            update podr a
                   set a.name=:namepod
                   where a.ShifrPod=:ShifrPod;
            if (ROW_COUNT=0) then
               insert into podr (shifrpod,name)
                      values (:ShifrPod,:NamePod);
       end
  /* Procedure Text */
end^


ALTER PROCEDURE ISBOLNDT (
    DT DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    B INTEGER)
AS
declare variable M integer;
begin
  b=1;
  select first 1 testsubbota.subbota from testsubbota(:dt,:SHIFRIDPERSON) into :m;
  if (m=1) then b=0;
  if (b=1) then
     begin
          select first 1 testvoskr.voskr from testvoskr(:dt) into :m;
          if (m=1) then b=0;
          if (b=1) then
             begin
                  select first 1 count(prazdniki.dateprz) from prazdniki
                         where prazdniki.dateprz=:dt and prazdniki.mode=1
                         into :m;
                  if (m>0) then b=0;
             end
     end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE ISKOMANDDT (
    DT DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable M integer;
begin
  retval=1;
  select first 1 testsubbota.subbota from testsubbota(:dt,:SHIFRIDPERSON) into :m;
  if (m=1) then retval=0;
  if (retval=1) then
     begin
          select first 1 testvoskr.voskr from testvoskr(:dt) into :m;
          if (m=1) then retval=0;
          if (retval=1) then
             begin
                  select first 1 count(prazdniki.dateprz) from prazdniki
                         where prazdniki.dateprz=:dt and prazdniki.mode=1
                         into :m;
                  if (m>0) then retval=0;
             end
     end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE LENMONTH (
    D DATE)
RETURNS (
    L INTEGER)
AS
declare variable y integer;
declare variable m integer;
declare variable t integer;
begin
     L=31;
     m=extract(month from d);
     y=extract(year from d);
     t=y-(y/4)*4;
     if (m in (4,6,9,11)) then L=30;
     else if (M=2) then
          begin
               if (t=0) then L=29;
               else
                   L=28;
          end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable summa decimal(15,2);
declare variable procind decimal(15,4);
declare variable limit_summa decimal(15,4);
declare variable i integer;
declare variable koefdata decimal(15,4);
declare variable basedata date;
declare variable basey integer;
declare variable basem integer;
declare variable koef decimal(15,2);
declare variable koef1 decimal(15,2);
declare variable koef2 decimal(15,2);
declare variable shifrgru1 integer;
declare variable shifrgru2 integer;
declare variable wplace1 integer;
declare variable wplace2 integer;
declare variable mindata date;
declare variable datamax date;
begin
     RetVal=0;
     summa=0;
     Limit_Summa=0;
     procind=0;

     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;

     select sum(a.summa) from fadd a
       where a.month_za=:monthza and a.year_za=:yearza and a.tabno=:Tabno and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
             exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
             not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
             into :summa;
     summa=coalesce(summa,0);
     koef=1;
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
     if (Summa>0) then
        begin
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                             (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                   end                    -- большей максимальной из таблицы




             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
                     if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;

                        RetVal=Summa*Procind*koef;
                end
        end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201112 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
begin
     RetVal=0;
     summa=0;
     Limit_Summa=0;
     procind=0;
     yp=yearza;
     mp=monthza;
     mp=mp-1;
     if (mp=0) then
        begin
             mp=12;
             yp=yp-1;
        end

     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
 -- 1 Взять з п за прошлый месяц (summap) без почасовки
     select sum(a.summa) from fadd a
       where a.tabno=:Tabno and  a.shifrsta<>37 and -- почасовку не считать
             (
               (a.shifrsta in (5,6,14,15) and (a.year_za=:yp and a.month_za=:mp)) or
                (
                  (a.shifrsta not in (5,6,14,15)) and
                   (((:yp<2011)  and (a.year_za=:yp and a.month_za=:mp)) or
                    ((:yp>=2011) and (a.year_vy=:yp and a.month_vy=:mp)))
                )
              ) and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
             exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
             not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
             into :summap;
     summap=coalesce(summap,0);
 -- 1 Взять з п за прошлый месяц (summap)  без почасовки
     select sum(a.summa) from fadd a
       where a.tabno=:Tabno and  a.shifrsta<>37 and -- почасовку не считать
             (
               (a.shifrsta in (5,6,14,15) and (a.year_za=:yearza and a.month_za=:monthza)) or
                (
                  (a.shifrsta not in (5,6,14,15)) and
                   (((:yearza<2011)  and (a.year_za=:yearza and a.month_za=:monthza)) or
                    ((:yearza>=2011) and (a.year_vy=:yearza and a.month_vy=:monthza)))
                )
              ) and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
             exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
             not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
             into :summacurr;
     summacurr=coalesce(summacurr,0);
 -- 3  - теперь считать текущий месяц с учетом почасовки если была
     select sum(a.summa) from fadd a
       where a.tabno=:Tabno and
             (
               (a.shifrsta in (5,6,14,15) and (a.year_za=:yearza and a.month_za=:monthza)) or
                (
                  (a.shifrsta not in (5,6,14,15)) and
                   (((:yearza<2011)  and (a.year_za=:yearza and a.month_za=:monthza)) or
                    ((:yearza>=2011) and (a.year_vy=:yearza and a.month_vy=:monthza)))
                )
              ) and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
             exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
             not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
             into :summa;
     summa=coalesce(summa,0);
     koef=1;
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
     if (Summa>0) then
        begin
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                             (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                   end                    -- большей максимальной из таблицы




             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
                     if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;

                        RetVal=Summa*Procind*koef;
                end
        end

     --- 14 12 2011 если сумма повышения > суммы индексации то
     --     индексацию не девать
     --     установить в F4 дату индекцации текущую
   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201201 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
begin
     RetVal=0;
     summa=0;
     Limit_Summa=0;
     procind=0;
     yp=yearza;
     mp=monthza;
     mp=mp-1;
     if (mp=0) then
        begin
             mp=12;
             yp=yp-1;
        end

     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
 -- 1 Взять з п за прошлый месяц (summap) без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yp, :mp)
            into :summap;
     summap=coalesce(summap,0);
 -- 2 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
 -- 3  - теперь считать текущий месяц с учетом почасовки если была
     select sum(a.summa) from fadd a
       where a.tabno=:Tabno and
             (
               (a.shifrsta in (5,6,14,15) and (a.year_za=:yearza and a.month_za=:monthza)) or
                (
                  (a.shifrsta not in (5,6,14,15)) and
                   (((:yearza<2011)  and (a.year_za=:yearza and a.month_za=:monthza)) or
                    ((:yearza>=2011) and (a.year_vy=:yearza and a.month_vy=:monthza)))
                )
              ) and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
             exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
             not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
             into :summa;
     summa=coalesce(summa,0);
     koef=1;
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
     if (Summa>0) then
        begin
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                             (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                   end                    -- большей максимальной из таблицы




             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
                     if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;

                        RetVal=Summa*Procind*koef;
                end
        end

     --- 14 12 2011 если сумма повышения > суммы индексации то
     --     индексацию не девать
     --     установить в F4 дату индекцации текущую
   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201207 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
     select retval from PR_ISNEEDIND(:tabno, :monthza, :yearza) into :need;
     need=coalesce(need,0);
     if (need<>1) then
        Exit;
 -- 0 Проверить, есть ли фикс сумма с прошл месяца?
     need=null;
     select retval from PR_INDFICSPERSON201208(:tabno, :yearza, :monthza) into :need;
     need=coalesce(need,0);
     if (need=1) then
        Exit;         -- была и все уже сделано в процедере  *** PR_INDFICSPERSON201208 ***

 -- 1 Взять з п за прошлый месяц (summap) без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yp, :mp)
            into :summap;
     summap=coalesce(summap,0);
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno,:mp, :yp) into :razrb;
     razrb=coalesce(razrb,0);
     select first 1 koef from  PR_GET_KOEF_PERSON_IND(:tabno, :yp,:mp) into :koefb;
     koefb=coalesce(koefb, 0);
     DTTMP=CAST((:yp||'-'||:mp||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :DTTMP) into workdayb;
     workdayb=coalesce(workdayb,0);
     select first 1 wdays from tb_days where yearza=:yp and monthza=:mp into :kalenddayb;
     kalenddayb=coalesce(kalenddayb,0);
 -- 2 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (SummaCurr=0) then
        begin
             comment='м б уволен';
             needind=0;
        end
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razra;
     razra=coalesce(razra,0);
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
   --  select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yp, :mp)
     select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yearza, :monthza)
            into :summabefpov;
     summabefpov = coalesce(summabefpov,0);
 --    if (summabefpov<(summacurr-0.01)) then
     if (summap<(summabefpov+0.01)) then
     if (summabefpov<(summacurr-0.01)) then
        begin
             comment='Повышение тарифной сетки';
             ispovrazr=1;
        end
     else
          comment='Индексация';

     koef=1;
     /*
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
*/
     summa=summacurr;
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    and a.main<>0
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
             else
                begin
/*
                     basedata=null;
                     select first 1 a.data_pri from kadry a where a.tabno=:tabno into :basedata;
                     basedata=coalesce(basedata,'2008-10-01');
                     if (BaseData<'2008-10-01') then
                        BaseData='2008-10-01';
*/
                     basedata=current_date; -- у кого дата не указана - не индексировать
                end
     if (Summa>0) then
        begin

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                              (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                         needind=0;      -- большей максимальной из таблицы
                         comment='Базовая дата '||basedata;
                   end







             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100.00;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
/*
               --      if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;
*/
                     procind=coalesce(koefdata,0);
                     if (procind>1) then procind=procind / 100;
                     RetVal=Summa*Procind*koef;
                end
        end
   summaindcalc  = retval;
   summaindfinal = retval;
   summauw       = 0;
   if (RetVal>0) then needind=1;
   if (needind=1) then
   if (ispovrazr=1) then
      begin
           SUMMAP=summabefpov;
           SummaUw=SummaCurr-summabefpov;
           if (SummaUw>SummaindCalc) then
              begin
                   comment='Повышение '||SummaUw||'> суммы индексации '||SummaindCalc;
                   SummaIndFinal=0;
                   needind=0;
              end
           else
              begin
                --   SummaIndFinal=SummaBefPov+SummaIndCalc-Summacurr;
                   SummaIndFinal=SummaIndCalc-SummaUw;
                   comment='Повышение. Постоянная = '||SummaIndFinal;
                   needind=1;
              end
      end
     else    -- Обічная индексация
      begin
          SummaIndFinal=SummaIndCalc;
          comment='Индексация = '||SummaIndFinal;
      end

   if (ShifrPod=82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   if (razrb between 1 and 5) then
      begin
           comment='Разряд 1-5' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
 --          if ((koefbud+Koefvne)>0.005) then
 --             begin
 --                  summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
 --                  summaindvne = summaindwday-summaindbud;
 --             end
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end
      end
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne)

     values(:yearza||'-'||:monthza||'-01' , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , :dolg,
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne);

   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201209 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
   -- Проверить базовую дату сотрудника
     select retval from PR_ISNEEDIND(:tabno, :monthza, :yearza) into :need;
     need=coalesce(need,0);
     if (need<>1) then
        Exit;            -- если базовая дата не индесируется - выйти


 -- 0 Проверить, есть ли фикс сумма с прошл месяца?
 --
 --    need=null;
 --    select retval from PR_INDFICSPERSON201208(:tabno, :yearza, :monthza) into :need;
 --    need=coalesce(need,0);
 --    if (need=1) then
 --       Exit;         -- была и все уже сделано
                      -- т е добавлена запись в TB_IND_CALC_12_7
                      -- (правда не учитывается возможность повышения зарплаты)

 -- 1 Взять з п за прошлый месяц (summap) без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yp, :mp)
            into :summap;
     summap=coalesce(summap,0);
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno,:mp, :yp) into :razrb;
     razrb=coalesce(razrb,0);
     select first 1 koef from  PR_GET_KOEF_PERSON_IND(:tabno, :yp,:mp) into :koefb;
     koefb=coalesce(koefb, 0);
     DTTMP=CAST((:yp||'-'||:mp||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :DTTMP) into workdayb;
     workdayb=coalesce(workdayb,0);
     select first 1 wdays from tb_days where yearza=:yp and monthza=:mp into :kalenddayb;
     kalenddayb=coalesce(kalenddayb,0);
 -- 2 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (SummaCurr=0) then
        begin
             comment='м б уволен';
             needind=0;
        end
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razra;
     razra=coalesce(razra,0);
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
   --  select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yp, :mp)
     select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yearza, :monthza)
            into :summabefpov;
     summabefpov = coalesce(summabefpov,0);
 --    if (summabefpov<(summacurr-0.01)) then
     if (summap<(summabefpov+0.01)) then
     if (summabefpov<(summacurr-0.01)) then
        begin
             comment='Повышение тарифной сетки или совмещение появилось';
             ispovrazr=1;
        end
     else
          comment='Индексация';

     -- Проверить была ли фик сумма с прошл месяца
     Summafixprev=null;
     select first 1 a.summapostind from tb_ind_calc_12_7 a
                      where a.yearza=:yp   and
                            a.monthza=:mp  and
                            a.needind=1    and
                            a.ispovrazr=1  and
                            a.summapostind>0.01 and
                            a.tabno   =  :tabno
                      into :summafixprev;
     summafixprev=coalesce(summafixprev,0);
     if (((summacurr-Summap)>SummaFixPrev) and (SummaFixPrev>0.01)) then
        begin
             Exit;                             -- Нет индексации т к сумма повышения
                                               -- Больше возможной индексации
        end

     koef=1;
     /*
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
*/
     summa=summacurr;
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    and a.main<>0
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
             else
                begin
/*
                     basedata=null;
                     select first 1 a.data_pri from kadry a where a.tabno=:tabno into :basedata;
                     basedata=coalesce(basedata,'2008-10-01');
                     if (BaseData<'2008-10-01') then
                        BaseData='2008-10-01';
*/
                     basedata=current_date; -- у кого дата не указана - не индексировать
                end
     if ((Summa>0) and (SummaFixPrev<0.01)) then   -- Если есть фик сумма то исп ее а не расчетную
        begin

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                              (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                         needind=0;      -- большей максимальной из таблицы
                         comment='Базовая дата '||basedata;
                   end







             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100.00;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
/*
               --      if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;
*/
                     procind=coalesce(koefdata,0);
                     if (procind>1) then procind=procind / 100;
                     RetVal=Summa*Procind*koef;
                end
        end
   summaindcalc  = retval;
   summaindfinal = retval;
   if (SummaFixPrev>0.01) then
      begin
           summaindcalc  = SummaFixPrev;
           summaindfinal = SummaFixPrev;
           comment='Фикс сумма '||SummaFixPrev||' с прошл.месяца';
      end
   summauw       = 0;
   if (RetVal>0) then needind=1;
   if (needind=1) then
   if (ispovrazr=1) then
      begin
           SUMMAP=summabefpov;
           SummaUw=SummaCurr-summabefpov;
           if (SummaUw>SummaindCalc) then
              begin
                   comment='Повышение '||SummaUw||'> суммы индексации '||SummaindCalc;
                   SummaIndFinal=0;
                   needind=0;
              end
           else
              begin
                --   SummaIndFinal=SummaBefPov+SummaIndCalc-Summacurr;
                   SummaIndFinal=SummaIndCalc-SummaUw;
                   comment='Повышение. Постоянная = '||SummaIndFinal;
                   needind=1;
              end
      end
     else    -- Обічная индексация
      begin
          SummaIndFinal=SummaIndCalc;
          comment='Индексация = '||SummaIndFinal;
      end

   if (ShifrPod=82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   if (razrb between 1 and 5) then
      begin
           comment='Разряд 1-5' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
 --          if ((koefbud+Koefvne)>0.005) then
 --             begin
 --                  summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
 --                  summaindvne = summaindwday-summaindbud;
 --             end
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end
      end
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:yearza||'-'||:monthza||'-01' , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , :dolg,
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);

   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201210 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
   -- Проверить базовую дату сотрудника
     select retval from PR_ISNEEDIND(:tabno, :monthza, :yearza) into :need;
     need=coalesce(need,0);
     if (need<>1) then
        Exit;            -- если базовая дата не индесируется - выйти


 -- 0 Проверить, есть ли фикс сумма с прошл месяца?
 --
 --    need=null;
 --    select retval from PR_INDFICSPERSON201208(:tabno, :yearza, :monthza) into :need;
 --    need=coalesce(need,0);
 --    if (need=1) then
 --       Exit;         -- была и все уже сделано
                      -- т е добавлена запись в TB_IND_CALC_12_7
                      -- (правда не учитывается возможность повышения зарплаты)

 -- 1 Взять з п за прошлый месяц (summap) без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yp, :mp)
            into :summap;
     summap=coalesce(summap,0);
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno,:mp, :yp) into :razrb;
     razrb=coalesce(razrb,0);
     select first 1 koef from  PR_GET_KOEF_PERSON_IND(:tabno, :yp,:mp) into :koefb;
     koefb=coalesce(koefb, 0);
     DTTMP=CAST((:yp||'-'||:mp||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :DTTMP) into workdayb;
     workdayb=coalesce(workdayb,0);
     select first 1 wdays from tb_days where yearza=:yp and monthza=:mp into :kalenddayb;
     kalenddayb=coalesce(kalenddayb,0);
 -- 2 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (SummaCurr=0) then
        begin
             comment='м б уволен';
             needind=0;
        end
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razra;
     razra=coalesce(razra,0);
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
   --  select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yp, :mp)
     select summa from PR_GETESTSUMMAFORINDPERSONBP(:tabno, :yearza, :monthza)
            into :summabefpov;
     summabefpov = coalesce(summabefpov,0);
 --    if (summabefpov<(summacurr-0.01)) then
     if (summap<(summabefpov+0.01)) then
     if (summabefpov<(summacurr-0.01)) then
        begin
             comment='Повышение тарифной сетки или совмещение появилось';
             ispovrazr=1;
        end
     else
          comment='Индексация';

     -- Проверить была ли фик сумма с прошл месяца
     Summafixprev=null;
     select first 1 a.summapostind from tb_ind_calc_12_7 a
                      where a.yearza=:yp   and
                            a.monthza=:mp  and
                            a.needind=1    and
                            a.ispovrazr=1  and
                            a.summapostind>0.01 and
                            a.tabno   =  :tabno
                      into :summafixprev;
     summafixprev=coalesce(summafixprev,0);
     if (((summacurr-Summap)>SummaFixPrev) and (SummaFixPrev>0.01)) then
        begin
             Exit;                             -- Нет индексации т к сумма повышения
                                               -- Больше возможной индексации
        end

     koef=1;
     /*
     if (exists (select * from tb_dbl_for_index where tabno=:tabno) ) then
        begin
             select first 1 a.wplace,  a.shifrgru,a.koef,a.wplace1,a.shifrgru1,a.koef1  from tb_dbl_for_index a
                    where a.tabno=:tabno
                    into :wplace1,:shifrgru1,:koef1,:wplace2,:shifrgru2,:koef2;
             if (wplace=wplace1 and shifrgru=shifrgru1) then koef=koef1;
             else
                 if (wplace=wplace2 and shifrgru=shifrgru2) then koef=koef2;
             if (((koef1+koef2)>0)  and ((koef1+koef2)<1)) then
                koef=koef / (koef1+koef2);
        end
*/
     summa=summacurr;
             select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    and a.main<>0
                    into :basem, :basey;
             basem=coalesce(basem,0);
             if (basem not between 1 and 12) then basem=0;
             basey=coalesce(basey,0);
             if (basey not between 2008 and 2020) then basey=0;
             basedata='1900-01-01';
             if (basem>0 and basey>0) then
                basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
             else
                begin
/*
                     basedata=null;
                     select first 1 a.data_pri from kadry a where a.tabno=:tabno into :basedata;
                     basedata=coalesce(basedata,'2008-10-01');
                     if (BaseData<'2008-10-01') then
                        BaseData='2008-10-01';
*/
                     basedata=current_date; -- у кого дата не указана - не индексировать
                end
     if ((Summa>0) and (SummaFixPrev<0.01)) then   -- Если есть фик сумма то исп ее а не расчетную
        begin

             if (basem>0 and basey>0) then
                begin
/*
                     select first 1 koef from tb_koef_ind_data c
                            where c.y=:basey and c.m=:basem
                            into :koefdata;
*/
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                              (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;


             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                         needind=0;      -- большей максимальной из таблицы
                         comment='Базовая дата '||basedata;
                   end







             if ((koefdata is not null) and (koefdata>1)) then koefdata=koefdata / 100.00;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
/*
               --      if (koefdata is not null and koefdata>0.001) then
                         procind=koefdata;
                     else
                     if (procind>1) then procind=procind / 100;
*/
                     procind=coalesce(koefdata,0);
                     if (procind>1) then procind=procind / 100;
                     RetVal=Summa*Procind*koef;
                end
        end
   summaindcalc  = retval;
   summaindfinal = retval;
   if (SummaFixPrev>0.01) then
      begin
           summaindcalc  = SummaFixPrev;
           summaindfinal = SummaFixPrev;
           comment='Фикс сумма '||SummaFixPrev||' с прошл.месяца';
      end
   summauw       = 0;
   if (RetVal>0) then needind=1;
   if (needind=1) then
   if (ispovrazr=1) then
      begin
           SUMMAP=summabefpov;
           SummaUw=SummaCurr-summabefpov;
           if (SummaUw>SummaindCalc) then
              begin
                   comment='Повышение '||SummaUw||'> суммы индексации '||SummaindCalc;
                   SummaIndFinal=0;
                   needind=0;
              end
           else
              begin
                --   SummaIndFinal=SummaBefPov+SummaIndCalc-Summacurr;
                   SummaIndFinal=SummaIndCalc-SummaUw;
                   comment='Повышение. Постоянная = '||SummaIndFinal;
                   needind=1;
              end
      end
     else    -- Обічная индексация
      begin
          SummaIndFinal=SummaIndCalc;
          comment='Индексация = '||SummaIndFinal;
      end

   if (ShifrPod=82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   if (razrb between 1 and 5) then
      begin
           comment='Разряд 1-5' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
 --          if ((koefbud+Koefvne)>0.005) then
 --             begin
 --                  summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
 --                  summaindvne = summaindwday-summaindbud;
 --             end
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end
      end
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:yearza||'-'||:monthza||'-01' , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , :dolg,
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);

   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201210_1 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     summaindcalc=null;
     select first 1  a.summapostind  from tb_ind_calc_12_7 a
                              where a.tabno=:tabno and
                                    a.yearza=:yp   and
                                    a.monthza=:mp
                              order by 1 desc
                              into :summaindcalc;
     summaindcalc=coalesce(summaindcalc,0);
     if (SummaIndCalc<0.01) then
        Exit;


     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
     summaindfinal = summaindcalc;

   if (ShifrPod=82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
           Exit;
      end
   if (razrb between 1 and 5) then
      begin
           comment='Разряд 1-5' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
           Exit;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
 --          if ((koefbud+Koefvne)>0.005) then
 --             begin
 --                  summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
 --                  summaindvne = summaindwday-summaindbud;
 --             end
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end
      end
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:yearza||'-'||:monthza||'-01' , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , :dolg,
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);
   /*
   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
   */
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201211 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
declare variable SUMMAINDFAKTP decimal(10,2);
declare variable KOEFBEF decimal(15,2);
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     summaindcalc=null;
     select first 1  a.summapostind,coalesce(a.koefbud,0)+coalesce(a.koefvne,0) from tb_ind_calc_12_7 a
                              where a.tabno   = :tabno and
                                    a.yearza  = :yp    and
                                    a.monthza = :mp
                              order by 1 desc
                              into :summaindcalc,:koefbef;
     summaindcalc=coalesce(summaindcalc,0);
    /* Проверить базовую дату */
      select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                      and c.month_vy=:monthza
                      and c.year_vy=:yearza
                      and c.shifrsta in (137,137+500)
                      and a.main <>0
                    into :basem, :basey;
      basem=coalesce(basem,0);
      if (basem not between 1 and 12) then basem=0;
      basey=coalesce(basey,0);
      if (basey not between 2008 and 2020) then basey=0;
      basedata='1900-01-01';
      if (basem>0 and basey>0) then
          basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
      else
          basedata=current_date; -- у кого дата не указана - не индексировать
      if (Extract(year from basedata)>2009) then
         exit;




     koefbef=coalesce(koefbef,1);

     if (koefbef>0 and koefbef<1) then
        begin
             select first 1  a.summapostind from tb_ind_calc_12_7 a
                              where a.tabno   = :tabno and
                                    cast(a.yearza||'-'||a.monthza||'-01' as date) < cast('2012-09-01' as date) and
                                    (coalesce(a.koefbud,0)+coalesce(a.koefvne,0))=:koefbef
                              order by a.yearza desc,a.monthza desc
                              into :summaindcalc;
             summaindcalc=coalesce(summaindcalc,0);
        end

     summaindfaktp=null;
     select sum(a.summa) from fadd a
                    where a.year_vy  = : yp
                      and a.month_vy = : mp
                      and a.year_za  = : yp
                      and a.month_za = : mp
                      and a.tabno    = : tabno
                      and a.shifrsta = 28
            into :summaindfaktp;
     summaindfaktp=coalesce(summaindfaktp,0);  -- фактически выпл в октябре
     if ((SummaIndCalc<0.01) and (summaindfaktp<0.01)) then
        Exit;
     DTTMP=CAST((:yp||'-'||:mp||'-01')  AS DATE);
     workdaya   = null;
     kalenddaya = null;
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yp and monthza=:mp into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     if (workdaya>kalenddaya) then workdaya=kalenddaya;
     if ((workdaya>0) and (kalenddaya>0)) then
     if (workdaya<kalenddaya) then
        if ((summaindcalc>1) and ((summaindfaktp<1)  or
            ((workdaya=kalenddaya)and (workdaya>0)))) then
           summaindfaktp=summaindcalc;
        else
          begin
               summaindfaktp=summaindfaktp/((cast(workdaya as decimal(12,2)))/(cast(kalenddaya as decimal(12,2))));
               if (abs(abs(summaindfaktp)-abs(summaindcalc))<3.0) then
                 summaindfaktp=summaindcalc;
          end

     if (summaindfaktp>0.01) then
        summaindcalc=summaindfaktp;

     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
     summaindfinal = summaindcalc;

   if (ShifrPod=82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
           Exit;
      end
   if (razrb between 1 and 5) then
      begin
           comment='Разряд 1-5' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
           Exit;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
 --          if ((koefbud+Koefvne)>0.005) then
 --             begin
 --                  summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
 --                  summaindvne = summaindwday-summaindbud;
 --             end
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end
      end
   koef=coalesce(koef, 0);
   if (exists (select * from tb_ind_calc_12_7 where
                      tabno=:tabno and
                      yearza=:yearza and
                      monthza=:monthza)) then
       begin
            exception e_p07 :tabno;
       end

   else
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:yearza||'-'||:monthza||'-01' , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , :dolg,
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);

   /*
   if ((summap>10) and (summacurr>summap) and (RetVal>10)) then
      if ((SummaCurr-SummaP)>RetVal) then
         RetVal=-99;
   */
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201404 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
declare variable DATAZA date;
begin
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
   -- Проверить базовую дату сотрудника
     select retval from PR_ISNEEDIND(:tabno, :monthza, :yearza) into :need;
     need=coalesce(need,0);
     select sum(a.summa) from fcn a where a.month_vy = :monthza
                               and a.year_vy  = :yearza
                               and a.tabno    = :tabno
                               and a.shifrsta = 160+500
                         into :summafixprev;
     summafixprev=coalesce(summafixprev, 0);
     if ((need<>1) and (abs(summafixprev)<0.01)) then
        Exit;            -- если базовая дата не индесируется - выйти


 -- 1 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (SummaCurr=0) then
        begin
             comment='м б уволен';
             needind=0;
        end
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razra;
     razra=coalesce(razra,0);
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
     comment='Индексация';

     koef=1;
     summa=summacurr;
     select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                    and c.month_vy=:monthza
                    and c.year_vy=:yearza
                    and c.shifrsta in (137,137+500)
                    and a.main<>0
                    into :basem, :basey;
     basem=coalesce(basem,0);
     if (basem not between 1 and 12) then basem=0;
     basey=coalesce(basey,0);
     if (basey not between 2008 and 2020) then basey=0;
     basedata='1900-01-01';
     if (basem>0 and basey>0) then
        basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
     else
        basedata=current_date; -- у кого дата не указана - не индексировать


     if (Summa>0) then   -- Если есть фик сумма то исп ее а не расчетную
        begin

             if (basem>0 and basey>0) then
                begin
                     select first 1 koef from tb_proc_ind_koe c
                            where extract(year from c.datab)=:basey
                            and extract(month from c.datab)=:basem
                            into :koefdata;
                     koefdata=coalesce(koefdata,0);
                     if (koefdata<0.01) then
                        begin
                             select first 1  a.datab  from tb_proc_ind_koe a
                                    order by 1
                                    into :mindata;
                             if (mindata is not null) then
                                begin
                                     if (basey<extract(year from mindata)) then
                                        koefdata=100.00;
                                     else if ((basey<extract(year from mindata)) and
                                              (basem<extract(month from mindata))) then
                                          koefdata=100.00;
                                end
                        end
                end
             else
                  koefdata=null;

             if (BaseData is not null) then
                if (basedata > DataMax) then
                   begin
                         KoefData=null;
                         koef=0;         -- Не считать тем, у которых базовая дата
                         needind=0;      -- большей максимальной из таблицы
                         comment='Базовая дата '||basedata;
                   end
             if ((koefdata is not null) and (koefdata>1)) then
                koefdata=koefdata / 100.00;
--             koefdata=koefdata / 100;

             select count(*) from  tb_par_index b
                    where b.monthza=:monthza
                    and b.yearza=:yearza
                    into :I;
             if (i=0) then
                exception ABSENTPARIND;
             else
                begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
                     Limit_Summa=coalesce(Limit_Summa,0);
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
                     --- Изм от 27 04 2014 ---
                     -- Всегда брать мин з-п и корректерировать на долю ставки
                     Summa=Limit_Summa;
                     koef=coalesce(koefosnbud,0)+coalesce(koefosnvne,0);
                     if (Koef>1) then Koef=1;
                     --- Конец изм от 27 04 2014 ---

                     procind=coalesce(koefdata,0);
                     if (procind>1) then procind=procind / 100;
                     RetVal=Summa*procind*koef;
                end
        end

   summaindcalc  = retval+summafixprev;
   summaindfinal = summaindcalc;
   if ((SummaFixPrev)>0.01) then
      comment='Фикс сумма '||(SummaFixPrev)||' на 01.04.2014';
   summauw       = 0;
   if (summaindfinal>0) then needind=1;
   if (needind=1) then
      comment='Индексация = '||summaindfinal;
   if (ShifrPod =82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end

      end
   dataza=:yearza||'-'||:monthza||'-01';
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:dataza , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , trim(:dolg),
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201404_09_10 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(50);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
declare variable DATAZA date;
begin
  -- эта процедура только досчитывает индексацию за фвр и мрт 2014 тем у кого базовая дата авг сент 2013
     RetVal      = 0 ;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end

     select first 1 cast(c.summa as integer),c.prim from fcn c
                    join person a on a.shifrid=c.shifridperson
                    where c.tabno=:tabno
                    and c.month_vy=4
                    and c.year_vy=2014
                    and c.shifrsta in (137,137+500)
                    and a.main<>0
                    into :basem, :basey;
     basem=coalesce(basem,0);
     if (basem not between 1 and 12) then basem=0;
     basey=coalesce(basey,0);
     if (basey not between 2008 and 2020) then basey=0;
     basedata='1900-01-01';
     if (basem>0 and basey>0) then
        basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
     else
        basedata=current_date; -- у кого дата не указана - не индексировать

     if  (basedata not between '2013-08-01' and '2013-09-01') then
        Exit;




   --  delete from  tb_ind_calc_12_7 where monthza=:monthza and yearza=:yearza and tabno=:tabno;
     select first 1  a.datab  from tb_proc_ind_koe a
            order by 1 desc
            into datamax;
   -- Проверить базовую дату сотрудника
     select retval from PR_ISNEEDIND(:tabno, :monthza, :yearza) into :need;
     need=coalesce(need,0);
     if (need<>1) then
        Exit;            -- если базовая дата не индесируется - выйти


 -- 1 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (SummaCurr=0) then
        begin
             comment='м б уволен';
             needind=0;
        end
     select first 1 RAZRIJAD  from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razra;
     razra=coalesce(razra,0);
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza) into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     koefosnbud = coalesce(koefosnbud, 0);
     koefosnvne = coalesce(koefosnvne, 0);
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     select first 1 retval from work_day(:tabno, :dttmp) into workdaya;
     workdaya=coalesce(workdaya,0);
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a where a.tabno=:tabno into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza) into :dolg;
     comment='Индексация';

     koef=1;
     summa=summacurr;



     if (Summa>0) then
        begin
             koefdata=0.011; -- у всех
             Limit_Summa=1218;
             if (Summa>Limit_Summa) then Summa=Limit_Summa;
         --- Изм от 27 04 2014 ---
          -- Всегда брать мин з-п и корректерировать на долю ставки
             Summa=Limit_Summa;
             koef=coalesce(koefosnbud,0)+coalesce(koefosnvne,0);
             if (Koef>1) then Koef=1;
         --- Конец изм от 27 04 2014 ---

             procind=coalesce(koefdata,0);
             if (procind>1) then procind=procind / 100;
             RetVal=Summa*procind*koef;
        end

   summaindcalc  = retval;
   summaindfinal = summaindcalc;
   summauw       = 0;
   if (summaindfinal>0) then needind=1;
   if (needind=1) then
      comment='Индексация = '||summaindfinal;
   if (ShifrPod =82) then
      begin
           comment='Совместитель' ;
           needInd=0;
           SummaIndCalc=0;
           SummaIndFinal=0;
      end
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end

      end
   dataza=:yearza||'-'||:monthza||'-01';
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev)

     values(:dataza , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfinal , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , trim(:dolg),
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev);

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE MAKEIND201706 (
    TABNO INTEGER,
    MONTHZA INTEGER,
    YEARZA INTEGER,
    SHIFRGRU INTEGER,
    WPLACE INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable SUMMA decimal(15,2);
declare variable PROCIND decimal(15,4);
declare variable LIMIT_SUMMA decimal(15,4);
declare variable I integer;
declare variable KOEFDATA decimal(15,4);
declare variable BASEDATA date;
declare variable BASEY integer;
declare variable BASEM integer;
declare variable KOEF decimal(15,2);
declare variable KOEF1 decimal(15,2);
declare variable KOEF2 decimal(15,2);
declare variable SHIFRGRU1 integer;
declare variable SHIFRGRU2 integer;
declare variable WPLACE1 integer;
declare variable WPLACE2 integer;
declare variable MINDATA date;
declare variable DATAMAX date;
declare variable YP integer;
declare variable MP integer;
declare variable SUMMAP decimal(15,2);
declare variable SUMMACURR decimal(15,2);
declare variable RAZRB integer;
declare variable KOEFB decimal(10,2);
declare variable RAZRA integer;
declare variable KOEFA decimal(10,2);
declare variable WORKDAYB integer;
declare variable KALENDDAYB integer;
declare variable KALENDDAYA integer;
declare variable WORKDAYA integer;
declare variable NEEDIND smallint;
declare variable comment varchar(200);
declare variable ISPOVRAZR integer; /* БЫЛО ПОВЫШЕНИЕ ТАРИФНОЙ СЕТКИ */
declare variable SUMMABEFPOV decimal(10,2);
declare variable SUMMAINDFINAL decimal(10,2);
declare variable SUMMAINDCALC decimal(10,2);
declare variable SUMMAUW decimal(10,2);
declare variable DTTMP date;
declare variable FIO varchar(50);
declare variable SHIFRPOD smallint = 0;
declare variable DOLG varchar(50);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable KOEFOSN decimal(10,2);
declare variable KOEFOSNBUD decimal(10,2);
declare variable KOEFOSNVNE decimal(10,2);
declare variable NEED integer;
declare variable SUMMAFIXPREV decimal(10,2);
declare variable DATAZA date;
declare variable CURRY integer;
declare variable CURRM integer;
declare variable OKLADRAZRB decimal(15,2);
declare variable OKLADRAZRA decimal(15,2);
declare variable KOEFUW decimal(15,5);
declare variable SUMMAINDFIX decimal(15,2);
declare variable SUMMAFUTURE decimal(15,2);
begin
     RetVal      = 0 ;
     curry       = 2017;
     currm       = 09;
     summa       = 0 ;
     Limit_Summa = 0 ;
     procind     = 0;
     comment     = '';
     needind     = 0;
     yp          = yearza;
     mp          = monthza;
     mp          = mp-1;
     ISPOVRAZR   = 0;
     DOLG        = '';
     shifrpod    = 0;
     FIO         = '';
     KOEFBUD     = 0;
     KOEFVNE     = 0;
     koefosnbud  = 0;
     koefosnvne  = 0;
     SUMMAINDBUD = 0;
     SUMMAINDVNE = 0;
     summafixprev = 0;
     if (mp=0) then
        begin
             mp = 12;
             yp = yp-1;
        end
     basedata='2017-01-01';
     -- вновь принятых не индексировать
     if (basedata>cast((yearza||'-'||monthza||'-01')as date)) then
        exit;
--     koefdata=0.037;
--     koefdata=0.069;
     summa=0;

 -- 1 Взять з п за текущий месяц (summap)  без почасовки
     select summa from PR_GETESTSUMMAFORINDPERSON(:tabno, :yearza, :monthza)
            into :summacurr;
     summacurr=coalesce(summacurr,0);
     if (abs(SummaCurr)<0.05) then
        begin
             comment='м б уволен';
             needind=0;
             exit;
        end
     select first 1 RAZRIJAD from pr_get_razr_person_vy(:tabno, :monthza,:yearza) into :razrb;
     razrb=coalesce(razrb, 0);
     okladrazrb=0;
     DTTMP=CAST((:yearza||'-'||:monthza||'-01')  AS DATE);
     if (razrb>0) then
        begin
             select first 1 trp.oklad from tb_razr_proc trp
                    where trp.datefr<:dttmp
                      and trp.razr=:razrb
                    order by trp.datefr desc
                    into :okladrazrb;
             okladrazrb=coalesce(:okladrazrb,0);
             koefuw=0;
        end
     if (exists (
         select * from person a
                  where a.tabno=:tabno
                    and a.yearvy=:yearza
                    and a.monthvy=:monthza
                    and a.w_place in (76,82,156)  -- Совместитель со стороны
     )) then
     if ( not exists (
        select * from person bb
                  where bb.tabno=:tabno
                    and bb.yearvy=:yearza
                    and bb.monthvy=:monthza
                    and bb.w_place not in (76,82,156)
                    and (select first 1 shifrwr from pr_isosnwrbyid(bb.shifrid))=1
     )) then
        exit;
     select first 1 koef,koefbud, koefvne,koefosn, koefosnbud,koefosnvne from  PR_GET_KOEF_PERSON_IND(:tabno, :yearza,:monthza)
            into :koefa,koefbud, koefvne,koefosn,:koefosnbud,:koefosnvne;
     koefa      = coalesce(koefa, 0);
     koefbud    = coalesce(koefbud, 0);
     koefvne    = coalesce(koefvne, 0);
     koefosn    = coalesce(koefosn, 0);
     if (koefosn>1) then
        koefosn=1;
     koefosnbud = coalesce(koefosnbud, 0);
     if (koefosnbud>1) then
        koefosnbud=1;
     koefosnvne = coalesce(koefosnvne, 0);
     if (koefosnvne>1) then
        koefosnvne=1;
     select first 1 retval from work_day(:tabno, :dttmp) into :workdaya;
     workdaya=coalesce(workdaya,0);
     if (workdaya<=1) then
        exit;
     select first 1 wdays from tb_days where yearza=:yearza and monthza=:monthza into :kalenddaya;
     kalenddaya=coalesce(kalenddaya,0);
     select first 1 a.fio,a.shifr_pod from kadry a
            where a.tabno=:tabno
            into :fio,:shifrpod;
     select first 1 dolg from pr_get_dolg_person_y_m(:tabno, :yearza,:monthza)
            into :dolg;
     comment='Индексация';

     summa=summacurr;

     retval=0;
     if (Summa>0) then   -- Если есть фик сумма то исп ее а не расчетную
        begin
                     select first 1 b.procind,b.limitsumma from  tb_par_index b
                            where b.monthza=:monthza
                            and b.yearza=:yearza
                            into :procind,:limit_summa;
--                     procind=0.037;
--                     procind=0.069;      -- за 09
--                     limit_summa=1684.00;
                     Limit_Summa=coalesce(Limit_Summa,0);
                     if (Summa>Limit_Summa) then Summa=Limit_Summa;
                     --- Изм от 27 04 2014 ---
                     -- Всегда брать мин з-п и корректерировать на долю ставки
                     Summa=Limit_Summa;
                     koef=coalesce(koefosnbud,0)+coalesce(koefosnvne,0);
                     if (Koef>1) then Koef=1;
          --             koef=1;  -- не учитывать долю ставки, а только сумму 22 04 2015
                     --- Конец изм от 27 04 2014 ---
                     --- 19 11 2015 Нет вернуть назад давать толшько за долю ставки


--                     procind=coalesce(koefdata,0);
                     if (procind>1) then procind=procind / 100.00;
                     RetVal = Summa * procind * koef;
        end

   summaindcalc  = retval;
   summaindfinal = summaindcalc;
   summaindfix   = 0;
   summaindwday=summaindfinal;
   if (abs(summaindfinal)>0.01) then
      begin
           kalenddaya = coalesce(kalenddaya,0);
           workdaya   = coalesce(workdaya,0);
           if (Workdaya>KalendDaya) then
              workdaya   = kalenddaya;
           if (kalenddaya>0) then
              summaindwday=summaindfinal*cast(workdaya as decimal(12,2)) /cast(kalenddaya as decimal(12,2));
           if (Workdaya=0) then
              summaindwday=0;
           if ((koefosnbud+Koefosnvne)>0.005) then
              begin
                   summaindbud = summaindwday*koefosnbud / (koefosnbud+Koefosnvne);
                   summaindvne = summaindwday-summaindbud;
              end

      end
   dataza=:yearza||'-'||:monthza||'-01';
   insert into tb_ind_calc_12_7 (DATAZA       , TABNO    , YEARZA     , MONTHZA    , DATABASEIND ,
                                 RAZRB        , KOEFB    , RAZRA      , KOEFA      , PROCIND     ,
                                 SUMMAB       , SUMMABF  , WORKDAYB   , KALENDDAYB , SUMMAA      ,
                                 SUMMAAF      , WORKDAYA , KALENDDAYA , SUMMAINDBF , SUMMAUW     ,
                                 SUMMAINDCALC , SUMMAPOSTIND ,  needind, comment    , ispovrazr   ,
                                 fio          , shifrpod     , dolg ,
                                 koefbud      , koefvne      , summaindbud, summaindvne,summaindwday,
                                 koefosn      , koefosnbud   , koefosnvne, summafixprev,
                                 okladbyrazrb , okladbyrazra)

     values(:dataza , :tabno,  :yearza,:monthza,:basedata,
            :razrb ,       :koefb         , :razra,  :koefa, :Procind*:koef,
            0,             :summap        , :workdayb   , :kalenddayb , 0,
            :summacurr,    :workdaya      , :kalenddaya , :retval     , :SUMMAUW,
            :SUMMAINDCALC ,:summaindfix   , :needind    , :comment    , :isPovRazr,
            :fio , :shifrpod , trim(:dolg),
            :koefbud , :koefvne    , :summaindbud, :summaindvne,:summaindwday,
            :koefosn , :koefosnbud , :koefosnvne, :summafixprev,
            :okladrazrb, :okladrazra);

  suspend;
end^


ALTER PROCEDURE MKTMPBOLNSUMMY (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4))
AS
declare variable MUSOR integer;
declare variable Y integer;
declare variable NEW_VAR integer;
declare variable M integer;
declare variable CURRDATE date;
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable SUMMA_BUD decimal(15,2);
declare variable SUMMA_GN decimal(15,2);
declare variable SUMMA_NIS decimal(15,2);
declare variable SUMMA_VNE decimal(15,2);
declare variable DAYS integer;
declare variable DAYNO integer;
declare variable D date;
declare variable SBOLN integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable ID_CLAR integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable DATEB date;
declare variable DATEE date;
declare variable DATEC date;
declare variable L integer;
declare variable MUSOR1 integer;
declare variable KAL_DAY integer;
declare variable KOEF decimal(15,4);
declare variable OKLAD decimal(15,2);
declare variable RAZRIJAD integer;
declare variable KOEFRAZR decimal(15,4);
declare variable DATEPRI date;
declare variable DATEUW date;
declare variable SDEKR integer;
declare variable SKOMANDIROWKI integer;
declare variable CLOCKPERDAY integer;
declare variable WDAYS integer;
declare variable CLOCKS decimal(15,2);
declare variable SUMMA_LIM decimal(15,2);
declare variable SHIFRPOD integer;
declare variable ISCOLLEDG integer;
declare variable DAYPERMONTH decimal(15,2);
declare variable NMBOFMONTH24 integer;
declare variable NMBOFMONTH12 integer;
declare variable SUMMA_TOT decimal(15,2);
begin
     clockPerDay = 8.00;    -- 8 рабочих часов в день
     execute Procedure pr_delete_all_from_tmp_boln;
     daypermonth=30.44;
     nmbofmonth24=24;
     nmbofmonth12=12;
    -- EXCEPTION  e_p07;
/*
     delete from tmp_boln_summy          where connid=CURRENT_CONNECTION;
     delete from tmp_bolna               where connid=CURRENT_CONNECTION;
     delete from tmp_boln_res            where connid=CURRENT_CONNECTION;
     select count(*) from tmp_boln_summy where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_bolna      where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_boln_res   where connid=CURRENT_CONNECTION into :musor;
*/
     select first 1 razrijad from pr_get_razr_person_vy(:tabno,extract(month from :datefr),extract(year from :datefr))
            into :razrijad;
     y=extract(year from datefr);
     m=extract(month from datefr);
     select first 1 kadry.data_pri,kadry.data_uw   from kadry  where tabno=:tabno into :datepri,:dateuw;
     datepri=coalesce(datepri,'1950-01-01');
     if (extract(year from datepri)<1950) then
        datepri='1950-01-01';
     dateuw=coalesce(dateuw,'2100-01-01');
     if (extract(year from dateuw)<1950) then
        dateuw='2100-01-01';
     if (dateuw<datepri) then
        dateuw='2100-01-01';
     I_count=0;
     while (i_count<nmbofmonth24) do
      begin
            i_count=i_count+1;
            m=m-1;
            if (m<1) then
               begin
                     m=12;
                     y=y-1;
               end
            CurrDate  = Y||'-'||M||'-'||'01';
            summa_bud = 0;
            summa_vne = 0;
            summa_gn  = 0;
            summa_nis = 0;
            for
                select fadd.summa,  fadd.shifrkat,fadd.shifrgru,shifr.boln,shifr.dekr,shifr.komand,
                       fadd.W_PLACE,fadd.W_R,     fadd.shifrsta,fadd.Month_Za,
                       fadd.year_za,fadd.month_vy,fadd.year_vy ,fadd.vypl from fadd
                              join shifr on fadd.shifrsta=shifr.shifr
/*
                              where ((:mode_za_vy=0     and     -- за
                                      fadd.month_za=:m  and
                                      fadd.year_za=:y) or
                                    (:mode_za_vy=1     and      -- в
                                      fadd.month_vy=:m and
                                      fadd.year_vy=:y))  and
                                    fadd.tabno=:tabno and
                                    not exists (select i_podr.shifr_pod from i_podr where i_podr.shifr_pod=fadd.w_place and i_podr.mode=1) and
                                    not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru=fadd.shifrgru) and
                                    not exists (select i_kat.shifr_kat from i_kat where i_kat.shifr_kat=fadd.shifrkat)
*/
---------------------------------------  Лера 16 03 2018
                   where fadd.tabno=:tabno and
                         (
              --             (shifrsta in (5,6,12,14,15,32) and (year_za=:wantedyear and month_za=:wantedmonth)) or
                           (((select retval from pr_isotherperiodecbshifr(fadd.shifrsta))=1) and (fadd.year_za=:y and fadd.month_za=:m)) or
                           (
               --             (shifrsta not in (5,6,12,14,15,32)) and

                            (select retval from pr_isotherperiodecbshifr(fadd.shifrsta))=0 and
                            (((:y<2011)  and (fadd.year_za=:y and fadd.month_za=:m)) or
                             ((:y>=2011) and (fadd.year_vy=:y and fadd.month_vy=:m)))
                           )
                         )
                          and       not exists (select i_podr.shifr_pod from i_podr where i_podr.shifr_pod=fadd.w_place and i_podr.mode=1)
                          and       not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru=fadd.shifrgru)
                          and       not exists (select i_kat.shifr_kat from i_kat where i_kat.shifr_kat=fadd.shifrkat)


---------------------------------------
                   into :summa,:shifrkat,:shifrgru,:SBoln,:SDekr,:skomandirowki,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl
            do
              begin
                    Marked  = 1;
                    Id_Clar = 0;
                    if (mode_ill=1) then
                      if (SDekr=0) then Marked=0; else Marked=1;          -- Декретные больничные
                    else
                        if (mode_ill<10) then
                           if (SBoln=0) then Marked=0; else Marked=1;           -- Все кроме командировок и декратных больничных
                        else
                             if ((mode_ill=10) and (skomandirowki=0)) then Marked=0;   -- Командировки
            --        if (ShifrSta=5) then
            --           exception e_p07 'Marked='||Marked;
            --        if (shifrsta=5) then
            --          exception e_p07 'marked='||marked||' mode_ill='||mode_ill;
                    if (((mode_ill<>1) and (SBoln>0)) or ((mode_ill=1) and (SDekr>0)))  then
                       begin
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=1)) then
                                summa_bud=summa_bud+summa;   -- бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=2)) then
                                summa_vne=summa_vne+summa;   -- вне бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=3)) then
                                summa_gn=summa_gn+summa;    -- ГН
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=4)) then
                                summa_nis=summa_nis+summa;  -- НИС
                       end
                     insert into tmp_bolna (CONNID,W_PLACE,W_R,SHIFRGRU,
                                              SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                                              MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
                            values (CURRENT_CONNECTION,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked,:ID_Clar);
              end   -- Конец цикла по статьям
/*
-- Для Леры 13 03 2018
    select sum(e.sum_total) from tb_e04t06c e
           where e.tabno=:tabno
             and e.yearvy=:y
             and e.monthvy=:m
           into :summa;
    summa=coalesce(summa, 0);
    summa_tot = coalesce(summa_bud,0.00)+coalesce(summa_vne,0.00)+coalesce(summa_gn,0.00)+coalesce(summa_nis,0.00);
    summa_tot=coalesce(summa_tot,0);
    if ((summa_tot>0.01) and (summa>0.00)) then
       begin
            summa_bud = summa * coalesce(summa_bud,0.00)/summa_tot;
            summa_vne = summa * coalesce(summa_vne,0.00)/summa_tot;
            summa_gn  = summa * coalesce(summa_gn,0.00)/summa_tot;
            summa_nis = summa * coalesce(summa_nis,0.00)/summa_tot;
       end

-- Конец изменений для Леры
*/
--- определить коледж или университет
            shifrpod=null;
            iscolledg=null;
            select first 1  a.w_place from fadd a
                              where a.tabno=:tabno and
                                    :datefr>cast(a.year_vy||'-'||a.month_vy||'-01' as date)
                                and a.w_r=1
                              order by a.year_vy desc, a.month_vy desc
                              into :shifrpod;
            shifrpod=coalesce(:shifrpod,0);
            select first 1 retval from pr_is_coledgpodr(:shifrpod)
                          into :iscolledg;
            iscolledg=coalesce(iscolledg,0);
            if (iscolledg=1) then
               shifrpod=-2;     -- колледж
            else
               shifrpod=-1;     -- университет

--- конец определения коледж или университет

--- Подсчет рабочих дней
            Days=0;
            for
                select distinct DayNo from tabel join person on tabel.shifrid=person.shifrid
                            where person.w_r=1        and
                                  person.main>0       and
                                  person.tabno=:tabno and
                                  person.monthvy=:m   and
                                  person.yearvy=:y    and

/*                                  tabel.code in (1,2,3,5,6,8,10,11,12,13,16)    */
/*                                  tabel.code in (1,2,3,5,8,10,11,12,13,16)      */
                           tabel.code in (1,2,3,5,8,10,11,12,16)
                            into  :DayNo
            do
              begin
                    d=:Y||'-'||:M||'-01';
                    select first 1 l from lenmonth(:d) into :l;
                    l=coalesce(l,0);
                    if (dayno<=l) then
                       begin
                             d=:Y||'-'||:M||'-'||:dayno;
                             select first 1 subbota from TestSubbota(:D,:shifrpod) into Musor;
                             if (Musor=0) then    -- Изменения от 13 04 2010 учесть
                                                  -- начисленные командировочные
                             if (exists (select * from boln aa
                                  where :d between aa.f_data and aa.l_data
                                  and aa.tabno=:tabno
                                 and coalesce(extract(year from aa.data_p_bud),1990)>2010
                                  /*and aa.mode_ill<10*/)) then Musor=1;
                             if (mode_ill=10) then
                             if (musor=0) then
                             if (exists (select * from otpuska a1
                                  where :d between a1.f_data and a1.l_data
                                  and a1.tabno=:tabno
                                  and coalesce(a1.mode, 0)=0
                         --        and coalesce(extract(year from a1.data_pere_bud),1990)>2010
                                  /*and aa.mode_ill<10*/)) then Musor=1;
                             if (Musor=0) then
                                Days=Days+1;
                       end
              end
/*
---Подсчет количества календарных дней
            dateb=y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||m||'-'||l;
            DateC=DateB;
            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
                    select first 1 subbota from TestSubbota(:DateC) into Musor1;
                    if (Musor1=0) then
                       select first 1 voskr from TestVoskr(:DateC) into Musor1;
                    if (not exists (select dateprz from prazdniki where mode=1 and dateprz=:Datec)) then
                       if (Musor1=0) then
                          Kal_Day=Kal_Day+1;
              end
*/
/* Подсчет количества каледарн_х дней изменился с 15 12 2009 */
---Подсчет количества календарных дней
            dateb=y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||m||'-'||l;
            DateC=DateB;

            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
                   Musor1=0;
        --          if (exists (select * from boln where boln.tabno=:tabno and :DateC between boln.f_data and boln.l_data)) then musor1=1;
                  -- 18.11.2015 c июля 2015 в календ дни не входят болн по беременности и по уходу
                  if (exists (select * from boln where boln.tabno=:tabno and :DateC between boln.f_data and boln.l_data and boln.mode_ill in (1,2))) then musor1=1;
                   else if (datec not between datepri and dateuw) then musor1=1;
                  -- 18.11.2015 а также не входят отпуск за свой счет  код 7 в табеле
                   if ((select first 1 retval from pr_is_otp_bez_o(:tabno,:DateC))=1) then musor1=1;
                   if (Musor1=0) then
                      Kal_Day=Kal_Day+1;
              end
      --      exception e_p07 'm='||m||' kal_day='||kal_day;

---Получение оклад
            select first 1 oklad from person
                   where :tabno=person.tabno and
                          1=person.w_r and
                          person.monthvy=extract(month from :currdate) and
                          person.yearvy=extract(year from :currdate) and
                          person.main>0
                   into :oklad;
            if (oklad is null) then Oklad=0;
---Извлечение коеэффициента
            select first 1 koef from bol_koe
                   where /*(DateB<:CurrDate and */bol_koe.mode=1 and
                         extract(Month from DateZa)=extract(Month from :CurrDate) and
                         extract(Year from DateZa)=extract(Year from :CurrDate) /*and
                         dateb<cast(:curryear||'-'||:currmonth||'-01' as date) */
                   order by DateB desc
                   into :Koef;
            if (Koef is null) then Koef=1;

            select first 1 koef from pr_get_koef_razr(:datefr, :currdate, 2,:razrijad)
                   into :KoefRazr;
            if (KoefRazr is null or KoefRazr<1) then
               KoefRazr=1;
/*
            if ((Extract(Year from CurrDate)=2007) and (Extract(Month from CurrDate)<6)) then
               begin
                    select first 1 tb_razr_proc.koef_boln from tb_razr_proc
                           where tb_razr_proc.razr=:razrijad and
                                 tb_razr_proc.datefr<:datefr
                          order by tb_razr_proc.datefr desc
                          into uwkr;
                    if ((uwkr is null) or (uwkr<0) or (uwkr>10))  then uwkr=1;
                    koef=koef*uwkr;
               end
*/

            Koef = Koef * KoefRazr;
            Sel=0;
            if (Mode_Ill=10) then
                begin
  --                    if (I_Count<nmbofmonth12/2+1) then Sel=1;
                      -- Для отпускных отмечается два месяца
                      if (I_Count<3) then Sel=1;
                end
            else
                if (I_Count<nmbofmonth12+1) then Sel=1;
            if (ModeDC=1) then
               begin
                    select first 1 a.wdays,a.clocks from tb_days a
                           where a.yearza=:y and a.monthza=:m
                           into :wdays,:clocks;
                    wdays  = coalesce(wdays,0);
                    clocks = coalesce(clocks,clockPerDay);
                    if (wdays>10) then
                       days    = clocks;
                    else
                       days    = days * clockPerDay;
                    Kal_Day = Kal_Day * clockPerDay;
               end
            --- Вставка от 02 12 2012 ---
            --- Коррекция суммы: сумма для больничных не более лимита
            if (Mode_ill<10) then  -- командировочных - не касается
               begin
                    summa_bud = coalesce(summa_bud,0);
                    summa_vne = coalesce(summa_vne,0);
                    summa_gn  = coalesce(summa_gn,0);
                    summa_nis = coalesce(summa_nis,0);
                    summa_lim=null;
                    select first 1 coalesce(a.summalimita,0) from PR_GET_LIMIT_FOR_PENS(:currdate) a into summa_lim;
                    summa_lim=coalesce(Summa_Lim,0);
                    if (Summa_Lim>100) then
                       begin
                            if (summa_bud>summa_lim) then
                               begin
                                    summa_bud = summa_lim;
                                    summa_vne = 0;
                                    summa_gn  = 0;
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne)>summa_lim) then
                               begin
                                    summa_vne = summa_lim-summa_bud;
                                    summa_gn  = 0;
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne+summa_gn)>summa_lim) then
                               begin
                                    summa_gn  = summa_lim-(summa_bud+summa_vne);
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne+summa_gn+summa_nis)>summa_lim) then
                                summa_nis = summa_lim-(summa_bud+summa_vne+summa_gn);
                      end
               end

            insert into tmp_boln_summy (CONNID,MONTH_ZA,YEAR_ZA,SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,Days,sel,Graphic_Day,Koef,Oklad_m,MANUAL_CALC)
                 values (current_connection, :M,:Y,:summa_bud, :summa_vne,:summa_gn,:summa_nis,:days, :Sel,:KAL_DAY,:Koef,:Oklad,0);
      end


  /* Procedure Text */
/*     suspend;*/
end^


ALTER PROCEDURE MKTMPBOLNSUMMY_10_05_2018 (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4),
    MODEWR INTEGER)
AS
declare variable MUSOR integer;
declare variable Y integer;
declare variable SHIFRWR integer;
declare variable M integer;
declare variable CURRDATE date;
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable SUMMA_BUD decimal(15,2);
declare variable SUMMA_GN decimal(15,2);
declare variable SUMMA_NIS decimal(15,2);
declare variable SUMMA_VNE decimal(15,2);
declare variable DAYS integer;
declare variable DAYNO integer;
declare variable D date;
declare variable SBOLN integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable ID_CLAR integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable DATEB date;
declare variable DATEE date;
declare variable DATEC date;
declare variable L integer;
declare variable MUSOR1 integer;
declare variable KAL_DAY integer;
declare variable KOEF decimal(15,4);
declare variable OKLAD decimal(15,2);
declare variable RAZRIJAD integer;
declare variable KOEFRAZR decimal(15,4);
declare variable DATEPRI date;
declare variable DATEUW date;
declare variable SDEKR integer;
declare variable SKOMANDIROWKI integer;
declare variable CLOCKPERDAY integer;
declare variable WDAYS integer;
declare variable CLOCKS decimal(15,2);
declare variable SUMMA_LIM decimal(15,2);
declare variable SHIFRPOD integer;
declare variable ISCOLLEDG integer;
declare variable DAYPERMONTH decimal(15,2);
declare variable NMBOFMONTH24 integer;
declare variable NMBOFMONTH12 integer;
declare variable SUMMA_TOT decimal(15,2);
declare variable SHIFRIDPERSON integer;
begin
--  MODEWR- 1 Основная 2 - совмещение; прочее - все вместе

     clockPerDay = 8.00;    -- 8 рабочих часов в день
     execute Procedure pr_delete_all_from_tmp_boln;
     daypermonth=30.44;
     nmbofmonth24=24;
     nmbofmonth12=12;
    -- EXCEPTION  e_p07;
/*
     delete from tmp_boln_summy          where connid=CURRENT_CONNECTION;
     delete from tmp_bolna               where connid=CURRENT_CONNECTION;
     delete from tmp_boln_res            where connid=CURRENT_CONNECTION;
     select count(*) from tmp_boln_summy where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_bolna      where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_boln_res   where connid=CURRENT_CONNECTION into :musor;
*/
     select first 1 razrijad from pr_get_razr_person_vy(:tabno,extract(month from :datefr),extract(year from :datefr))
            into :razrijad;
     y=extract(year from datefr);
     m=extract(month from datefr);
     select first 1 kadry.data_pri,kadry.data_uw   from kadry  where tabno=:tabno into :datepri,:dateuw;
     datepri=coalesce(datepri,'1950-01-01');
     if (extract(year from datepri)<1950) then
        datepri='1950-01-01';
     dateuw=coalesce(dateuw,'2100-01-01');
     if (extract(year from dateuw)<1950) then
        dateuw='2100-01-01';
     if (dateuw<datepri) then
        dateuw='2100-01-01';
     I_count=0;
     while (i_count<nmbofmonth24) do
      begin
            i_count=i_count+1;
            m=m-1;
            if (m<1) then
               begin
                     m=12;
                     y=y-1;
               end
            CurrDate  = Y||'-'||M||'-'||'01';
            summa_bud = 0;
            summa_vne = 0;
            summa_gn  = 0;
            summa_nis = 0;
            for
                select fadd.summa,  fadd.shifrkat,fadd.shifrgru,shifr.boln,shifr.dekr,shifr.komand,
                       fadd.W_PLACE,fadd.W_R,     fadd.shifrsta,fadd.Month_Za,
                       fadd.year_za,fadd.month_vy,fadd.year_vy ,fadd.vypl,
                       fadd.shifridperson from fadd
                              join shifr on fadd.shifrsta=shifr.shifr
/*
                              where ((:mode_za_vy=0     and     -- за
                                      fadd.month_za=:m  and
                                      fadd.year_za=:y) or
                                    (:mode_za_vy=1     and      -- в
                                      fadd.month_vy=:m and
                                      fadd.year_vy=:y))  and
                                    fadd.tabno=:tabno and
                                    not exists (select i_podr.shifr_pod from i_podr where i_podr.shifr_pod=fadd.w_place and i_podr.mode=1) and
                                    not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru=fadd.shifrgru) and
                                    not exists (select i_kat.shifr_kat from i_kat where i_kat.shifr_kat=fadd.shifrkat)
*/
---------------------------------------  Лера 16 03 2018
                   where fadd.tabno=:tabno and
                         (
              --             (shifrsta in (5,6,12,14,15,32) and (year_za=:wantedyear and month_za=:wantedmonth)) or
                           (((select retval from pr_isotherperiodecbshifr(fadd.shifrsta))=1) and (fadd.year_za=:y and fadd.month_za=:m)) or
                           (
               --             (shifrsta not in (5,6,12,14,15,32)) and

                            (select retval from pr_isotherperiodecbshifr(fadd.shifrsta))=0 and
                            (((:y<2011)  and (fadd.year_za=:y and fadd.month_za=:m)) or
                             ((:y>=2011) and (fadd.year_vy=:y and fadd.month_vy=:m)))
                           )
                         )
                          and       not exists (select i_podr.shifr_pod from i_podr where i_podr.shifr_pod=fadd.w_place and i_podr.mode=1)
                          and       not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru=fadd.shifrgru)
                          and       not exists (select i_kat.shifr_kat from i_kat where i_kat.shifr_kat=fadd.shifrkat)


---------------------------------------
                   into :summa,:shifrkat,:shifrgru,:SBoln,:SDekr,:skomandirowki,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl,:shifridperson
            do
              begin
                    Marked  = 1;
                    Id_Clar = 0;
                    if (mode_ill=1) then
                      if (SDekr=0) then Marked=0; else Marked=1;          -- Декретные больничные
                    else
                        if (mode_ill<10) then
                           if (SBoln=0) then Marked=0; else Marked=1;           -- Все кроме командировок и декратных больничных
                        else
                             if ((mode_ill=10) and (skomandirowki=0)) then Marked=0;   -- Командировки
            --        if (ShifrSta=5) then
            --           exception e_p07 'Marked='||Marked;
            --        if (shifrsta=5) then
            --          exception e_p07 'marked='||marked||' mode_ill='||mode_ill;
                    if (coalesce(modewr,0) in (1,2)) then
                       begin
                             select shifrWR from pr_isosnwrbyid(:shifridperson) into :shifrWr;
                             shifrwr=coalesce(ShifrWr,1);
                             if (shifrwr=1 and modewr=2) then
                                 marked=0;
                             else
                             if (shifrwr=2 and modewr=1) then
                                 marked=0;
                       end

                    if (((mode_ill<>1) and (SBoln>0)) or ((mode_ill=1) and (SDekr>0)))  then
                       begin
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=1)) then
                                summa_bud=summa_bud+summa;   -- бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=2)) then
                                summa_vne=summa_vne+summa;   -- вне бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=3)) then
                                summa_gn=summa_gn+summa;    -- ГН
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=4)) then
                                summa_nis=summa_nis+summa;  -- НИС
                       end
                     insert into tmp_bolna (CONNID,W_PLACE,W_R,SHIFRGRU,
                                              SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                                              MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
                            values (CURRENT_CONNECTION,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked,:ID_Clar);
              end   -- Конец цикла по статьям
/*
-- Для Леры 13 03 2018
    select sum(e.sum_total) from tb_e04t06c e
           where e.tabno=:tabno
             and e.yearvy=:y
             and e.monthvy=:m
           into :summa;
    summa=coalesce(summa, 0);
    summa_tot = coalesce(summa_bud,0.00)+coalesce(summa_vne,0.00)+coalesce(summa_gn,0.00)+coalesce(summa_nis,0.00);
    summa_tot=coalesce(summa_tot,0);
    if ((summa_tot>0.01) and (summa>0.00)) then
       begin
            summa_bud = summa * coalesce(summa_bud,0.00)/summa_tot;
            summa_vne = summa * coalesce(summa_vne,0.00)/summa_tot;
            summa_gn  = summa * coalesce(summa_gn,0.00)/summa_tot;
            summa_nis = summa * coalesce(summa_nis,0.00)/summa_tot;
       end

-- Конец изменений для Леры
*/
--- определить коледж или университет
            shifrpod=null;
            iscolledg=null;
            select first 1  a.w_place from fadd a
                              where a.tabno=:tabno and
                                    :datefr>cast(a.year_vy||'-'||a.month_vy||'-01' as date)
                                and a.w_r=1
                              order by a.year_vy desc, a.month_vy desc
                              into :shifrpod;
            shifrpod=coalesce(:shifrpod,0);
            select first 1 retval from pr_is_coledgpodr(:shifrpod)
                          into :iscolledg;
            iscolledg=coalesce(iscolledg,0);
            if (iscolledg=1) then
               shifrpod=-2;     -- колледж
            else
               shifrpod=-1;     -- университет

--- конец определения коледж или университет

--- Подсчет рабочих дней
            Days=0;
            if (ModeWR<>2) then   -- Для всего вместе и основного
               -- 1. Получить основное место работы
               select first 1 shifrid from person
                      where tabno=:tabno
                        and person.w_r=1
                        and person.main>0
           --             and w_place not in (81,82,76)
                        and monthvy = :m
                        and yearvy  = :y
                      into :shifridperson;
            else
               -- или. Получить совместителя
               select first 1 shifrid from person
                      where tabno=:tabno
                        and main>0
                        and coalesce((select coalesce(shifrid,0) from PR_GET_DOLG_PERSON_BY_ID(person.shifrid)),0) not in (4,5,6,7,8,9,1500,1510,1520,1530)
                        and w_r=2
                        and w_place not in (76,81,82,76,121,128,140,156,158)
                        and monthvy = :m
                        and yearvy  = :y
                      into :shifridperson;
            shifridperson=coalesce(shifridperson,0);
            if (shifridperson>0) then
            for
--                select distinct DayNo from tabel join person on tabel.shifrid=person.shifrid
--                            where person.w_r=1        and
--                                  person.main>0       and
--                                  person.tabno=:tabno and
--                                  person.monthvy=:m   and
--                                  person.yearvy=:y    and
                select distinct DayNo from tabel join person on tabel.shifrid=person.shifrid
                            where person.shifrid=:shifridperson

/*                                  tabel.code in (1,2,3,5,6,8,10,11,12,13,16)    */
/*                                  tabel.code in (1,2,3,5,8,10,11,12,13,16)      */
                     and tabel.code in (1,2,3,5,8,10,11,12,16,19)    -- добавлен 19 26 04 2020
                            into  :DayNo
            do
              begin
                    d=:Y||'-'||:M||'-01';
                    select first 1 l from lenmonth(:d) into :l;
                    l=coalesce(l,0);
                    if (dayno<=l) then
                       begin
                             d=:Y||'-'||:M||'-'||:dayno;
                             select first 1 subbota from TestSubbota(:D,:shifrpod) into Musor;
                             if (Musor=0) then    -- Изменения от 13 04 2010 учесть
                                                  -- начисленные командировочные
                             if (exists (select * from boln aa
                                  where :d between aa.f_data and aa.l_data
                                  and aa.tabno=:tabno
                                 and coalesce(extract(year from aa.data_p_bud),1990)>2010
                                  /*and aa.mode_ill<10*/)) then Musor=1;
                             if (mode_ill=10) then
                             if (musor=0) then
                             if (exists (select * from otpuska a1
                                  where :d between a1.f_data and a1.l_data
                                  and a1.tabno=:tabno
                                  and coalesce(a1.mode, 0)=0
                         --        and coalesce(extract(year from a1.data_pere_bud),1990)>2010
                                  /*and aa.mode_ill<10*/)) then Musor=1;
                             if (Musor=0) then
                                Days=Days+1;
                       end
              end
/*
---Подсчет количества календарных дней
            dateb=y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||m||'-'||l;
            DateC=DateB;
            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
                    select first 1 subbota from TestSubbota(:DateC) into Musor1;
                    if (Musor1=0) then
                       select first 1 voskr from TestVoskr(:DateC) into Musor1;
                    if (not exists (select dateprz from prazdniki where mode=1 and dateprz=:Datec)) then
                       if (Musor1=0) then
                          Kal_Day=Kal_Day+1;
              end
*/
/* Подсчет количества каледарн_х дней изменился с 15 12 2009 */
---Подсчет количества календарных дней
            dateb=y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||m||'-'||l;
            DateC=DateB;

            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
                   Musor1=0;
        --          if (exists (select * from boln where boln.tabno=:tabno and :DateC between boln.f_data and boln.l_data)) then musor1=1;
                  -- 18.11.2015 c июля 2015 в календ дни не входят болн по беременности и по уходу
                  if (exists (select * from boln where boln.tabno=:tabno and :DateC between boln.f_data and boln.l_data and boln.mode_ill in (0,1,2))) then musor1=1;
                   else if (datec not between datepri and dateuw) then musor1=1;
                  -- 18.11.2015 а также не входят отпуск за свой счет  код 7 в табеле
                   if ((select first 1 retval from pr_is_otp_bez_o(:tabno,:DateC))=1) then musor1=1;
                   if (Musor1=0) then
                      Kal_Day=Kal_Day+1;
              end
--            exception e_p07 'm='||m||' kal_day='||kal_day;

---Получение оклад
            select first 1 oklad from person
                   where :tabno=person.tabno and
                          1=person.w_r and
                          person.monthvy=extract(month from :currdate) and
                          person.yearvy=extract(year from :currdate) and
                          person.main>0
                   into :oklad;
            if (oklad is null) then Oklad=0;
---Извлечение коеэффициента
            select first 1 koef from bol_koe
                   where /*(DateB<:CurrDate and */bol_koe.mode=1 and
                         extract(Month from DateZa)=extract(Month from :CurrDate) and
                         extract(Year from DateZa)=extract(Year from :CurrDate) /*and
                         dateb<cast(:curryear||'-'||:currmonth||'-01' as date) */
                   order by DateB desc
                   into :Koef;
            if (Koef is null) then Koef=1;

            select first 1 koef from pr_get_koef_razr(:datefr, :currdate, 2,:razrijad)
                   into :KoefRazr;
            if (KoefRazr is null or KoefRazr<1) then
               KoefRazr=1;
/*
            if ((Extract(Year from CurrDate)=2007) and (Extract(Month from CurrDate)<6)) then
               begin
                    select first 1 tb_razr_proc.koef_boln from tb_razr_proc
                           where tb_razr_proc.razr=:razrijad and
                                 tb_razr_proc.datefr<:datefr
                          order by tb_razr_proc.datefr desc
                          into uwkr;
                    if ((uwkr is null) or (uwkr<0) or (uwkr>10))  then uwkr=1;
                    koef=koef*uwkr;
               end
*/

            Koef = Koef * KoefRazr;
            Sel=0;
            if (Mode_Ill=10) then
                begin
  --                    if (I_Count<nmbofmonth12/2+1) then Sel=1;
                      -- Для отпускных отмечается два месяца
                      if (I_Count<3) then Sel=1;
                end
            else
                if (I_Count<nmbofmonth12+1) then Sel=1;
            if (ModeDC=1) then
               begin
                    select first 1 a.wdays,a.clocks from tb_days a
                           where a.yearza=:y and a.monthza=:m
                           into :wdays,:clocks;
                    wdays  = coalesce(wdays,0);
                    clocks = coalesce(clocks,clockPerDay);
                    if (wdays>10) then
                       days    = clocks;
                    else
                       days    = days * clockPerDay;
                    Kal_Day = Kal_Day * clockPerDay;
               end
            --- Вставка от 02 12 2012 ---
            --- Коррекция суммы: сумма для больничных не более лимита
            if (Mode_ill<10) then  -- командировочных - не касается
               begin
                    summa_bud = coalesce(summa_bud,0);
                    summa_vne = coalesce(summa_vne,0);
                    summa_gn  = coalesce(summa_gn,0);
                    summa_nis = coalesce(summa_nis,0);
                    summa_lim=null;
                    select first 1 coalesce(a.summalimita,0) from PR_GET_LIMIT_FOR_PENS(:currdate) a into summa_lim;
                    summa_lim=coalesce(Summa_Lim,0);
                    if (Summa_Lim>100) then
                       begin
                            if (summa_bud>summa_lim) then
                               begin
                                    summa_bud = summa_lim;
                                    summa_vne = 0;
                                    summa_gn  = 0;
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne)>summa_lim) then
                               begin
                                    summa_vne = summa_lim-summa_bud;
                                    summa_gn  = 0;
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne+summa_gn)>summa_lim) then
                               begin
                                    summa_gn  = summa_lim-(summa_bud+summa_vne);
                                    summa_nis = 0;
                               end
                            else
                            if ((summa_bud+summa_vne+summa_gn+summa_nis)>summa_lim) then
                                summa_nis = summa_lim-(summa_bud+summa_vne+summa_gn);
                      end
               end

            insert into tmp_boln_summy (CONNID,MONTH_ZA,YEAR_ZA,SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,Days,sel,Graphic_Day,Koef,Oklad_m,MANUAL_CALC)
                 values (current_connection, :M,:Y,:summa_bud, :summa_vne,:summa_gn,:summa_nis,:days, :Sel,:KAL_DAY,:Koef,:Oklad,0);
      end


  /* Procedure Text */
/*     suspend;*/
end^


ALTER PROCEDURE MKTMPOTPSUMMY (
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    RAZRIJAD INTEGER,
    MODE INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER)
AS
declare variable MUSOR integer;
declare variable Y integer;
declare variable M integer;
declare variable CURRDATE date;
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable SUMMA_BUD decimal(15,2);
declare variable SUMMA_GN decimal(15,2);
declare variable SUMMA_NIS decimal(15,2);
declare variable SUMMA_VNE decimal(15,2);
declare variable DAYS integer;
declare variable DAYNO integer;
declare variable D date;
declare variable SOTP integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable ID_CLAR integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable DATEB date;
declare variable DATEE date;
declare variable DATEC date;
declare variable L integer;
declare variable KAL_DAY integer;
declare variable KOEF decimal(15,7);
declare variable OKLAD decimal(15,2);
declare variable KOEFRAZR decimal(15,7);
declare variable ISOTPBEZOPLDAY integer;
declare variable TMPI integer;
declare variable SHIFRPOD integer;
declare variable ISCOLLEDG integer;
begin
     EXECUTE PROCEDURE PR_DELETE_ALL_FROM_TMP_OTP;
/*
     delete from tmp_otp_summy where connid=CURRENT_CONNECTION;
     delete from tmp_otp_add   where connid=CURRENT_CONNECTION;
     select count(*) from tmp_otp_summy where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_otp_add   where connid=CURRENT_CONNECTION into :musor;
*/
     y=extract(year from datefr);
     m=extract(month from datefr);
     I_count=0;
     while (i_count<12) do
      begin
            i_count=i_count+1;
            m=m-1;
            if (m<1) then
               begin
                     m=12;
                     y=y-1;
               end
            CurrDate=Y||'-'||M||'-'||'01';
            summa_bud = 0;
            summa_vne = 0;
            summa_gn  = 0;
            summa_nis = 0;
            for
                select summa,shifrkat,shifrgru,shifr.otp,W_PLACE,W_R,ShifrSta,
                       Month_Za,Year_Za,Month_Vy,Year_Vy,fadd.vypl from fadd
                              join shifr on fadd.shifrsta=shifr.shifr
                              where fadd.month_za=:m  and
                                    fadd.year_za=:y   and
                                    fadd.tabno=:tabno and
                                    not exists (select i_podr.shifr_pod from i_podr where i_podr.shifr_pod=fadd.w_place and ((:mode=0 and i_podr.mode=2) or
                                                                                                                             (:mode=1 and i_podr.mode=3) or
                                                                                                                             (:mode=2 and i_podr.mode=4))) and
                                    not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru=fadd.shifrgru and ((:mode=0 and i_gruppy.mode=2) or
                                                                                                                                     (:mode=1 and i_gruppy.mode=3) or
                                                                                                                                     (:mode=2 and i_gruppy.mode=4))) and
                                    not exists (select i_kat.shifr_kat from i_kat where i_kat.shifr_kat=fadd.shifrkat and ((:mode=0 and i_kat.mode=2) or
                                                                                                                           (:mode=1 and i_kat.mode=3) or
                                                                                                                           (:mode=2 and i_kat.mode=4)))
                   into :summa,:shifrkat,:shifrgru,:SOtp,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl
            do
              begin
                    Marked  = 1;
                    Id_Clar = 0;
                    if (SOtp=0) then Marked=0;
                    if (SOtp>0) then
                       begin
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=1)) then
                                summa_bud=summa_bud+summa;   -- бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=2)) then
                                summa_vne=summa_vne+summa;   -- вне бюджет
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=3)) then
                                summa_gn=summa_gn+summa;    -- ГН
                             else
                             if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=4)) then
                                summa_nis=summa_nis+summa;  -- НИС
                       end
                     insert into tmp_otp_add (CONNID,W_PLACE,W_R,SHIFRGRU,
                                              SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                                              MONTH_VY,YEAR_VY,SUMMA,VYPL,SEL,ID_CLAR)
                            values (CURRENT_CONNECTION,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked,:ID_Clar);
              end   -- Конец цикла по статьям


--- определить коледж или университет
            shifrpod=null;
            iscolledg=null;
            select first 1  a.w_place from fadd a
                              where a.tabno=:tabno and
                                    :datefr>cast(a.year_vy||'-'||a.month_vy||'-01' as date)
                                and a.w_r=1
                              order by a.year_vy desc, a.month_vy desc
                              into :shifrpod;
            shifrpod=coalesce(:shifrpod,0);
            select first 1 retval from pr_is_coledgpodr(:shifrpod)
                          into :iscolledg;
            iscolledg=coalesce(iscolledg,0);
            if (iscolledg=1) then
               shifrpod=-2;     -- колледж
            else
               shifrpod=-1;     -- университет

--- конец определения коледж или университет


---Подсчет рабочих дней
            Days=0;
            dateb   = y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            for
                select DayNo from tabel join person on tabel.shifrid=person.shifrid
                            where person.w_r=1        and
                                  person.main>0       and
                                  person.tabno=:tabno and
                                  person.monthvy=:m   and
                                  person.yearvy=:y    and
                                  tabel.code in (1,2,3,5,6,8,10,11,12,13,16)
--                                  tabel.code in (1,2,3,5,8,10,11,12,13,16,19) -- добавлен 19 - простой 26 04 2020
                                  and DayNo<=:l
                            into  :DayNo
            do
              begin
--                    if (dayno) then
                    d=:Y||'-'||:M||'-01';
                    select l from lenmonth(:d) into :l;
                    if (dayno<=l) then
                       begin
                            d=:Y||'-'||:M||'-'||:dayno;
                            select first 1 subbota from TestSubbota(:D,:shifrpod) into Musor;
                            if (Musor=0) then
                               Days=Days+1;
                       end
              end
---Подсчет количества календарных дней
            dateb   = y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee   = y||'-'||m||'-'||l;
            DateC   = DateB;
            Musor   = 0;
            Kal_Day = 0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
           --         select first 1 subbota from TestSubbota(:DateC) into Musor1;
           --         if (Musor1=0) then
           --            select first 1 voskr from TestVoskr(:DateC) into Musor1;
                    IsOtpBezOplDay=0;
                    for
                       select a.code from tabel a
                                          join person b on a.shifrid=b.shifrid
                                     where b.tabno=:tabno
                                           and b.monthvy=:m
                                           and b.yearvy=:y
                                           and a.dayno=:musor
                                     into :tmpi
                       do
                          begin
                                tmpi=coalesce(tmpi, 0);
                                if (tmpi=7) then   -- 7 - отпуск без оплаты
                                   begin
                                        IsOtpBezOplDay=1;
                                        break;
                                   end

                                if (IsOtpBezOplDay=0) then
                                if ((y=2012) and (m=1) and (musor between 3 and 13) )then
                                   begin
                                       select count(*) from  tb_otpusk_2012_01 a where a.tabno=:tabno   and selected=1
                                              into IsOtpBezOplDay;
                                       if (IsOtpBezOplDay>0) then
                                           IsOtpBezOplDay=1;
                                       if (IsOtpBezOplDay=1) then
                                          break;
                                   end
                                if (IsOtpBezOplDay=1) then break;
                          end

                    if (not exists (select dateprz from prazdniki where mode=2 and dateprz=:Datec)) then
--                       if (Musor1=0) then
                    if (IsOtpBezOplDay<>1) then
                          Kal_Day=Kal_Day+1;
              end
---Получение оклад
            select first 1 oklad from person
                   where :tabno=person.tabno and
                          1=person.w_r and
                          person.monthvy=extract(month from :currdate) and
                          person.yearvy=extract(year from :currdate) and
                          person.main>0
                   into :oklad;
            if (oklad is null) then Oklad=0;
---Извлечение коеэффициента
            Koef=1;

       --     select first 1 koef from bol_koe
       --           where /*DateB<:CurrDate and */ bol_koe.mode=2 and
       --                  extract(Month from DateZa)=extract(Month from :CurrDate) and
       --                  extract(Year from DateZa)=extract(Year from :CurrDate) /*and
       --                  dateb<cast(:curryear||'-'||:currmonth||'-01' as date)*/
       --            order by DateB desc
       --            into :Koef;
       --     if (Koef is null or Koef<1.0) then Koef=1.0;

             koefRazr=1;
             if (datefr<'2020-12-12') then
                begin
                     select first 1 coalesce(koef,1.0)
                            from pr_get_koef_razr(:datefr, :currdate, 2,:razrijad)
                            into :KoefRazr;
                     if (KoefRazr is null or KoefRazr<1) then
                        KoefRazr=1;
                end


--            if ((Extract(Year from CurrDate)=2008) and (Extract(Month from CurrDate)<9)) then
/*
            if (((Extract(Year from CurrDate)=YearKoefRazr) and
                 (Extract(Month from CurrDate)<=MonthKoefRazr)) or
                (Extract(Year from CurrDate)<YearKoefRazr))  then
               begin
                    select first 1 tb_razr_proc.koef_otp from tb_razr_proc
                       where tb_razr_proc.razr=:razrijad and
                             tb_razr_proc.datefr=:DateKoefRazr
                       order by tb_razr_proc.datefr desc
                       into uwkr;
                    if ((uwkr is null) or (uwkr<0) or (uwkr>10))  then uwkr=1;
                --    uwkr = (uwkr+1) * 1.045;
                    koef = koef * uwkr;
               end
*/
            Koef = Koef * KoefRazr;
            Sel = 0;
            if (I_Count<13) then Sel=1;
            if ((summa_bud+summa_vne+summa_gn+Summa_nis)<0.001) then
               begin
                     Days    = 0 ;
                     kal_day = 0 ;
                     oklad   = 0 ;
                     sel     = 0 ;
               end
            if (ModeDC=1) then
               begin
                    days=days*8;
                    kal_day=kal_day*8;
               end
            insert into tmp_otp_summy (CONNID,MONTH_ZA,YEAR_ZA,SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,Day_work,sel,Day_Kalend,Koef,Oklad_m,Manual_Calc)
                 values (current_connection, :M,:Y,:summa_bud, :summa_vne,:summa_gn,:summa_nis,:days, :Sel,:KAL_DAY,:Koef,:Oklad,0);
      end


  /* Procedure Text */
/*     suspend;*/
end^


ALTER PROCEDURE NUMBER_STRING_UKR (
    P_NUMBER NUMERIC(12,2))
RETURNS (
    NUMBER_STR VARCHAR(400))
AS
declare variable TMP_STR varchar(80);
declare variable TMP varchar(80);
declare variable KOP varchar(20);
declare variable STR_LEN integer;
declare variable C varchar(1);
declare variable RET_MLN varchar(30);
declare variable RER100000 varchar(30);
declare variable RET10_90 varchar(30);
declare variable RET11_19 varchar(30);
declare variable RET1000 varchar(30);
declare variable RET900 varchar(30);
declare variable RET10_90_1 varchar(30);
declare variable RET10_19_1 varchar(30);
declare variable RET1_10 varchar(30);
declare variable NUMBER varchar(100);
declare variable TMP2 varchar(10);
declare variable TCHK varchar(1);
declare variable IN_NUMBER varchar(20);
declare variable LN integer;
declare variable RET10_19_2 varchar(30);
declare variable PN integer;
begin
     pn = 0;
     in_number = cast(p_number as varchar(20));
     tmp_str = in_number;
     c = '0';
     str_len = -1;
     kop = '';
     number = '';
     ln = -1;
     while (c <> '' ) do
       begin
            c = substring(tmp_str from 1 for 1);
            tmp = substring(tmp_str from 2 for 12);
            tmp_str = tmp;
            ln = ln + 1;
            if (c ='.') then break;
            number = number || c;
       end
     if (ln = 1) then
        begin
             in_number = '000000'|| in_number;
     end
     if (ln = 2) then
        begin
             in_number = '00000'|| in_number;
        end
     if (ln = 3) then
        begin
             in_number = '0000'|| in_number;
        end
     if (ln = 4) then
        begin
             in_number = '000'|| in_number;
        end
     if (ln = 5) then
        begin
             in_number = '00'|| in_number;
        end
     if (ln = 6) then
        begin
             in_number = '0'|| in_number;
        end

     tmp_str = in_number;
     c = '0';
     str_len = -1;
     kop = '';
     number = '';
     while (c <> '' ) do
           begin
                c = substring(tmp_str from 1 for 1);
                tmp = substring(tmp_str from 2 for 12);
                tmp_str = tmp;
                str_len = str_len + 1;
                if (c ='.') then
                   begin
                        tchk = '.';
                   end
                if (tchk = '.') then
                   begin
                        kop = kop || c;
                   end
                else
                   begin
                        number = number || c;
                   end
           end

     kop =' грн. '|| substring(kop from 2 for 10) || ' коп.';

     tmp_str = number;-- Cast(in_number as varchar(80));
     ret_mln = '';
     rer100000 = '';
     ret10_90 = '';
     ret11_19 = '';
     ret1000 = '';
     ret900 = '';
     ret10_90_1 = '';
     ret10_19_1 = '';
     ret1_10 = '';
     number = '';
     str_len = -1;
     c = '0';
     while (c <> '' ) do
          begin
               c = substring(tmp_str from 1 for 1);
               tmp = substring(tmp_str from 2 for 12);
               tmp_str = tmp;
               str_len = str_len + 1;
               if (c ='.') then break;
               number = number || c;
          end
     if (substring(number from 1 for 1) = '1' and str_len = 7) then ret_mln = 'один мільйон ';
     if (substring(number from 1 for 1) = '2' and str_len = 7) then ret_mln = 'два мільйона ';
     if (substring(number from 1 for 1) = '3' and str_len = 7) then ret_mln = 'три мільйона ';
     if (substring(number from 1 for 1) = '4' and str_len = 7) then ret_mln = 'чотири мільйона ';
     if (substring(number from 1 for 1) = '5' and str_len = 7) then ret_mln = 'п''ять мільйонів ';
     if (substring(number from 1 for 1) = '6' and str_len = 7) then ret_mln = 'шість мільйонів ';
     if (substring(number from 1 for 1) = '7' and str_len = 7) then ret_mln = 'сім мільйонів ';
     if (substring(number from 1 for 1) = '8' and str_len = 7) then ret_mln = 'вісім мільйонів ';
     if (substring(number from 1 for 1) = '9' and str_len = 7) then ret_mln = 'дев''ять мільйонів ';
     tmp_str = substring(number from 2 for 10);

     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
          begin
               c = substring(tmp_str from 1 for 1);
               tmp = substring(tmp_str from 2 for 12);
               tmp_str = tmp;
               str_len = str_len + 1;
               if (c ='.') then break;
               number = number || c;
          end
     tmp2 = substring(number from 1 for 1);
     if (tmp2 = '1' and str_len = 6) then rer100000 = 'сто ';
     if (tmp2 = '2' and str_len = 6) then rer100000 = 'двісті ';
     if (tmp2 = '3' and str_len = 6) then rer100000 = 'триста ';
     if (tmp2 = '4' and str_len = 6) then rer100000 = 'чотириста ';
     if (tmp2 = '5' and str_len = 6) then rer100000 = 'п''ятсот ';
     if (tmp2 = '6' and str_len = 6) then rer100000 = 'шістсот ';
     if (tmp2 = '7' and str_len = 6) then rer100000 = 'сімсот ';
     if (tmp2 = '8' and str_len = 6) then rer100000 = 'вісімсот ';
     if (tmp2 = '9' and str_len = 6) then rer100000 = 'дев''ятсот ';
     if (substring(number from 2 for 2)= '00'  and str_len = 6 and rer100000 != '') then rer100000 = rer100000 || 'тисяч ';
     tmp_str = substring(number from 2 for 10);

     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
         begin
              c = substring(tmp_str from 1 for 1);
              tmp = substring(tmp_str from 2 for 12);
              tmp_str = tmp;
              str_len = str_len + 1;
              if (c ='.') then break;
              number = number || c;
         end
     tmp2 = substring(number from 1 for 2);
     if (tmp2 = '11' and str_len = 5) then ret11_19 = 'одинадцять тисяч  ';
     if (tmp2 = '12' and str_len = 5) then ret11_19 = 'дванадцять тисяч ';
     if (tmp2 = '13' and str_len = 5) then ret11_19 = 'тринадцять тисяч ';
     if (tmp2 = '14' and str_len = 5) then ret11_19 = 'чотирнадцять тисяч ';
     if (tmp2 = '15' and str_len = 5) then ret11_19 = 'п''ятнадцять тисяч ';
     if (tmp2 = '16' and str_len = 5) then ret11_19 = 'шістнадцять тисяч  ';
     if (tmp2 = '17' and str_len = 5) then ret11_19 = 'сімнадцять тисяч  ';
     if (tmp2 = '18' and str_len = 5) then ret11_19 = 'вісімнадцять тисяч  ';
     if (tmp2 = '19' and str_len = 5) then ret11_19 = 'дев''ятнадцять тисяч ';
     tmp2 = substring(number from 1 for 2);

     if (tmp2 = '10' and str_len = 5) then ret10_90 = 'десять тисяч  ';
     tmp2 = substring(number from 1 for 1);
     if (tmp2 = '2' and str_len = 5) then ret10_90 = 'двадцять ';
     if (tmp2 = '3' and str_len = 5) then ret10_90 = 'тридцять ';
     if (tmp2 = '4' and str_len = 5) then ret10_90 = 'сорок ';
     if (tmp2 = '5' and str_len = 5) then ret10_90 = 'п''ятдесят ';
     if (tmp2 = '6' and str_len = 5) then ret10_90 = 'шістдесят ';
     if (tmp2 = '7' and str_len = 5) then ret10_90 = 'сімдесят ';
     if (tmp2 = '8' and str_len = 5) then ret10_90 = 'вісімдесят ';
     if (tmp2 = '9' and str_len = 5) then ret10_90 = 'дев''яносто ';

     if ( substring(number from 2 for 1) = '0' and  substring(number from 1 for 1) != '1' and ln >= 5 and  ret10_90 != '' ) then ret10_90 = ret10_90 || 'тисяч ';
     tmp_str = substring(number from 2 for 10);

     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
         begin
              c = substring(tmp_str from 1 for 1);
              tmp = substring(tmp_str from 2 for 12);
              tmp_str = tmp;
              str_len = str_len + 1;
              if (c ='.') then break;
              number = number || c;
         end
     tmp2 = substring(number from 1 for 1);

     if (tmp2 = '1' and str_len = 4 and ret11_19 = '') then ret1000 = 'одна тисяча ';
     if (tmp2 = '2' and str_len = 4 and ret11_19 = '') then ret1000 = 'дві тисячі ';
     if (tmp2 = '3' and str_len = 4 and ret11_19 = '') then ret1000 = 'три тисячі ';
     if (tmp2 = '4' and str_len = 4 and ret11_19 = '') then ret1000 = 'чотири тисячі ';
     if (tmp2 = '5' and str_len = 4 and ret11_19 = '') then ret1000 = 'п''ять тисяч ';
     if (tmp2 = '6' and str_len = 4 and ret11_19 = '') then ret1000 = 'шість тисяч ';
     if (tmp2 = '7' and str_len = 4 and ret11_19 = '') then ret1000 = 'сім тисяч ';
     if (tmp2 = '8' and str_len = 4 and ret11_19 = '') then ret1000 = 'вісім тисяч ';
     if (tmp2 = '9' and str_len = 4 and ret11_19 = '') then ret1000 = 'дев''ять тисяч ';

     tmp_str = substring(number from 2 for 10);
     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
         begin
              c = substring(tmp_str from 1 for 1);
              tmp = substring(tmp_str from 2 for 12);
              tmp_str = tmp;
              str_len = str_len + 1;
              if (c ='.') then break;
              number = number || c;
         end
     tmp2 = substring(number from 1 for 1);

     if (tmp2 = '1' and str_len = 3) then ret900 = 'сто ';
     if (tmp2 = '2' and str_len = 3) then ret900 = 'двісті ';
     if (tmp2 = '3' and str_len = 3) then ret900 = 'триста ';
     if (tmp2 = '4' and str_len = 3) then ret900 = 'чотириста ';
     if (tmp2 = '5' and str_len = 3) then ret900 = 'п''ятсот ';
     if (tmp2 = '6' and str_len = 3) then ret900 = 'шістсот ';
     if (tmp2 = '7' and str_len = 3) then ret900 = 'сімсот ';
     if (tmp2 = '8' and str_len = 3) then ret900 = 'вісімсот ';
     if (tmp2 = '9' and str_len = 3) then ret900 = 'дев''ятсот ';

     tmp_str = substring(number from 2 for 10);
     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
         begin
              c = substring(tmp_str from 1 for 1);
              tmp = substring(tmp_str from 2 for 12);
              tmp_str = tmp;
              str_len = str_len + 1;
              if (c ='.') then break;
              number = number || c;
         end
     tmp2 = substring(number from 1 for 2);

     if (tmp2 = '10' and str_len = 2) then begin  ret10_90_1 = 'десять '; pn = 1; end
     if (tmp2 = '11' and str_len = 2) then  begin  ret10_90_1 = 'одинадцять '; pn = 1; end
     if (tmp2 = '12' and str_len = 2) then  begin  ret10_90_1 = 'дванадцять '; pn = 1; end
     if (tmp2 = '13' and str_len = 2) then  begin  ret10_90_1 = 'тринадцять '; pn = 1; end
     if (tmp2 = '14' and str_len = 2) then  begin  ret10_90_1 = 'чотирнадцять '; pn = 1; end
     if (tmp2 = '15' and str_len = 2) then  begin  ret10_90_1 = 'п''ятнадцять '; pn = 1; end
     if (tmp2 = '16' and str_len = 2) then  begin  ret10_90_1 = 'шістнадцять '; pn = 1; end
     if (tmp2 = '17' and str_len = 2) then  begin  ret10_90_1 = 'сімнадцять '; pn = 1; end
     if (tmp2 = '18' and str_len = 2) then  begin  ret10_90_1 = 'вісімнадцять '; pn = 1; end
     if (tmp2 = '19' and str_len = 2) then  begin  ret10_90_1 = 'дев''ятнадцять '; pn = 1; end

     tmp2 = substring(number from 1 for 1);

     if (tmp2 = '2' and str_len = 2 ) then ret10_19_1 = 'двадцять ';
     if (tmp2 = '3' and str_len = 2 ) then ret10_19_1 = 'тридцять ';
     if (tmp2 = '4' and str_len = 2 ) then ret10_19_1 = 'сорок ';
     if (tmp2 = '5' and str_len = 2 ) then ret10_19_1 = 'п''ятдесят ';
     if (tmp2 = '6' and str_len = 2 ) then ret10_19_1 = 'шістдесят ';
     if (tmp2 = '7' and str_len = 2 ) then ret10_19_1 = 'сімдесят ';
     if (tmp2 = '8' and str_len = 2 ) then ret10_19_1 = 'вісімдесят ';
     if (tmp2 = '9' and str_len = 2 ) then ret10_19_1 = 'дев''яносто ';

     tmp_str = substring(number from 2 for 10);
     c = '0';
     str_len = -1;
     number = '';
     while (c <> '' ) do
         begin
              c = substring(tmp_str from 1 for 1);
              tmp = substring(tmp_str from 2 for 10);
              tmp_str = tmp;
              str_len = str_len + 1;
              if (c ='.') then break;
              number = number || c;
         end
     tmp2 = substring(number from 1 for 1);
     if  (pn = 0) then
        begin
             if (tmp2 = '1' and str_len = 1 ) then ret1_10 = 'одна ';
             if (tmp2 = '2' and str_len = 1 ) then ret1_10 = 'дві ';
             if (tmp2 = '3' and str_len = 1 ) then ret1_10 = 'три ';
             if (tmp2 = '4' and str_len = 1 ) then ret1_10 = 'чотири ';
             if (tmp2 = '5' and str_len = 1 ) then ret1_10 = 'п''ять ';
             if (tmp2 = '6' and str_len = 1 ) then ret1_10 = 'шість ';
             if (tmp2 = '7' and str_len = 1 ) then ret1_10 = 'сім ';
             if (tmp2 = '8' and str_len = 1 ) then ret1_10 = 'вісім ';
             if (tmp2 = '9' and str_len = 1 ) then ret1_10 = 'дев''ять ';
        end
        number_str = ret_mln || rer100000 || ret10_90 || ret11_19 || ret1000 || ret900 || ret10_90_1 || ret10_19_1  || ret1_10 || kop;

      suspend;
end^


ALTER PROCEDURE OTP_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
declare variable id integer;
declare variable dayno integer;
declare variable code integer;
declare variable wd date;
declare variable l integer;
begin
   RetVal=0;
   select first 1 l from lenmonth(:Dt) into :l;
   if (l is null) then l=31;
   select first 1 shifrid from person a
          where tabno=:tabno and
                a.monthvy=extract(month from :dt) and
                a.yearvy=extract(year from :dt) and
                a.w_r=1
          into :id;
   if (id is not null) then
      begin

           for
              select b.dayno,b.code from tabel b
                     where b.shifrid=:id and b.dayno<=:L
                     order by b.dayno
                     into :dayno,:code
           do
              begin
                   if (:Code=1) then
                      begin
                            wd=extract(year from dt)||'-'||extract(month from dt)||'-'||dayno;
                            if (exists (select d.shifrid from otpuska d
                                           where :wd between d.f_data and d.l_data and
                                                 d.tabno=:tabno))  then
                               RetVal=RetVal + 1;
                      end
                    else
                     if (:Code=6) then
                         RetVal=RetVal+1;
              end
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE P_REP
RETURNS (
    FIO VARCHAR(60),
    TABNO INTEGER,
    TIN VARCHAR(10),
    E01 NUMERIC(15,2),
    E02 NUMERIC(15,2),
    E03 NUMERIC(15,2),
    E04 NUMERIC(15,2),
    E05 NUMERIC(15,2),
    E06 NUMERIC(15,2),
    E07 NUMERIC(15,2),
    E08 NUMERIC(15,2),
    E09 NUMERIC(15,2),
    E10 NUMERIC(15,2),
    E11 NUMERIC(15,2),
    E12 NUMERIC(15,2))
AS
BEGIN EXIT; END^


ALTER PROCEDURE PENS (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2))
RETURNS (
    SUMMAPENS DECIMAL(15,2))
AS
declare variable P decimal(15,2);
declare variable NEEDTABLE integer;
declare variable SHIFRKAT integer;
declare variable W_PLACE integer;
declare variable SUMMAADD decimal(15,2);
declare variable SUMMAFR decimal(15,2);
declare variable D date;
begin
      select first 1 summapens
             from pens_common(:tabno,:yearza,:monthza, :summa, 0)
             into :summapens;
      suspend;

end^


ALTER PROCEDURE PENS_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPENS DECIMAL(15,2))
AS
declare variable P decimal(15,3);
declare variable NEEDTABLE integer;
declare variable SHIFRKAT integer;
declare variable W_PLACE integer;
declare variable SUMMAADD decimal(15,2);
declare variable SUMMAFR decimal(15,2);
declare variable D date;
declare variable PROG_MIN decimal(15,2);
declare variable SHIFRIDPERSON integer;
begin
      SummaPens=0;
      p=0.02;
      needtable=0;
      w_place=1;
      shifrkat=null;
      shifridperson=0;
      D=yearza||'-'||:monthza||'-10';
      select first 1 a.limitpens from penshea a
                              where a.datefr<:D
                              order by a.datefr desc
                              into :p;
      if (P is Not Null and Summa>p) then Summa=p;
      p=0.02;
      select first 1 sslimity.progmin  from sslimity
             where sslimity.datefr<:d
             order by sslimity.datefr desc
             into :prog_min;
      if (Prog_Min is Null or Prog_min<1) then
         Prog_Min=669;
      if (yearza<=2007) then               -- До 2007 года с малооплачиваемых был 0.005 %
         if (Summa<=Prog_Min) then p=0.005;
      if (MODE=1) then
         begin
               select first 1 a.shifrkat,a.w_place,a.shifrid from tb_tmp_person a
                      where (a.w_r=1 or a.m_o_r=82) and
                            a.monthvy=:monthza      and
                            a.yearvy=:yearza        and
                            a.Tabno=:Tabno          and
                            a.main>0                and -- т е не старое место работы  изменение от 22 12 2010
                            a.w_place not between 151 and 168 --and
--                            CONN_ID=CURRENT_CONNECTION
                      into :shifrkat, :W_Place, :shifridperson;
--               exception testputboln 'Shifrkat_0='||coalesce(shifrkat, 'null');

               if (shifrkat is null) then
                  select first 1 a.shifrkat,a.w_place,a.shifrid from tb_tmp_person a
                         where (a.w_r=1 or a.m_o_r=82) and
                                a.Tabno=:Tabno          and
                                a.w_place not between 151 and 168 --and
--                                CONN_ID=CURRENT_CONNECTION
                         order by a.yearvy desc, a.monthvy desc
                         into :shifrkat, :W_Place,:shifridperson;
--               exception testputboln 'Shifrkat_1='||Shifrkat;
         end
      else
         select first 1 a.shifrkat,a.w_place from person a
                where (a.w_r=1 or a.m_o_r=82) and
                      a.monthvy=:monthza      and
                      a.yearvy=:yearza        and
                      a.Tabno=:Tabno          and
                      a.main>0                and -- т е не старое место работы  изменение от 22 12 2010
                      a.w_place not between 151 and 168 --not (a.w_place>150 and a.W_Place<169)
                into :shifrkat, :W_Place;
      if (ShifrKat is Null) then ShifrKat=2;
      if (ShifrKat=1) then NeedTable=1;
      if (NeedTable=1) then
         if (mode=1) then
            begin
                 if (exists (select * from tb_tmp_fcn a
                            where (a.shifrsta =116 or a.shifrsta=616) and
                                   a.shifridperson=:shifridperson
--                                   a.Tabno=:Tabno    and
--                                   a.year_vy=:YearZa and
--                                   a.month_vy=:MonthZa --and
--                                   CONN_ID=CURRENT_CONNECTION
                                   )) then
                    needtable=0;
            end
         else
            begin
                  if (exists (select * from fcn a
                            where (a.shifrsta =116 or a.shifrsta=616) and
                                   a.Tabno=:Tabno    and
                                   a.year_vy=:YearZa and
                                   a.month_vy=:MonthZa)) then
                  needtable=0;
            end
      else
          if (mode=1) then
             begin
                  if (exists (select * from tb_tmp_fcn a
                          where (a.shifrsta=115 or a.shifrsta=615) and
                                 a.shifridperson=:shifridperson
--                                a.Tabno=:Tabno    and
--                                a.year_vy=:YearZa and
--                                a.month_vy=:MonthZa and
--                                CONN_ID=CURRENT_CONNECTION
                                )) then
                  NeedTable=1;
             end
          else
             begin
                  if (exists (select * from fcn a
                          where (a.shifrsta=115 or a.shifrsta=615) and
                                a.Tabno=:Tabno    and
                                a.year_vy=:YearZa and
                                a.month_vy=:MonthZa)) then
                  NeedTable=1;
             end
      if (NeedTable=0) then
         begin
              if (Summa<150.01) then
              if (mode=1) then
                 begin
                      if (exists (select * from tb_tmp_fcn a
                                  where (a.shifrsta=114 or a.shifrsta=614) and
                                         a.shifridperson=:shifridperson
--                                         a.Tabno=:Tabno    and
--                                         a.year_vy=:YearZa and
--                                         a.month_vy=:MonthZa and
--                                         CONN_ID=CURRENT_CONNECTION
                                         )) then
                      p=0.01;
                 end
              else
                 begin
                      if (exists (select * from fcn a
                                  where (a.shifrsta=114 or a.shifrsta=614) and
                                         a.Tabno=:Tabno    and
                                         a.year_vy=:YearZa and
                                         a.month_vy=:MonthZa)) then
                      p=0.01;
                 end
             if (yearza>2007) then
                summapens=summa*p;
             else
                if (Summa<=prog_min) then
                   summapens=summa*0.005;
                else
                   summapens=(summa-prog_min)*0.02+prog_min*0.005;
         end
      else
          begin
               select first 1 b.summaadd,b.summafr,b.procpens from penshea a
                                                                    join penspr b on a.id=b.idpens
                              where a.datefr<:D and
                                    :summa>=b.summafr and :summa<=b.summato
                              order by a.datefr desc,b.summafr
                              into :summaadd,:summafr,:p;
               if (summaadd is null) then
                  begin
                       summaadd=12.50;
                       summafr=500;
                       p=0.05;
                  end
               if (YearZa<2007) then
                  summapens=(summa-summafr)*p+summaadd;
               else
                  summapens=summa*p;

          end
  suspend;
end^


ALTER PROCEDURE PODOH (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2))
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
declare variable ISLGOTY integer;
declare variable SUMMALGOTY decimal(15,2);
declare variable LIMITLGOTY decimal(15,2);
declare variable P decimal(15,2);
declare variable D date;
declare variable PU integer; /* Принят уволен */
declare variable SMR integer; /* Стороннее место работы */
declare variable LG decimal(15,2);
declare variable KD integer;
declare variable RASLIMITLGOTA decimal(15,2);
begin
     select first 1 summapod from PODOH_COMMON(:TABNO,:YEARZA,:MONTHZA,:SUMMA,:summaecb, 0)
     into :summapod;
     suspend;
/*
     IsLgoty=0;
/* Проверить пенсионера +/
     if (exists (SELECT FIRST 1 ShifrSta FROM FCN a
                        WHERE (A.SHIFRSTA=107 or ShifrSta=107+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa)) then SUMMAFZ=0;
     d=yearza||'-'||monthza||'-10';
     SELECT FIRST 1 a.summalgoty,a.limitlgoty,a.proc from podohtbl a
            where a.datefr<=:d
            order by a.datefr desc
            into :summalgoty,:limitlgoty,:p;
     if (p is null) then
        begin
             p=0.13;
             limitlgoty=630;
             summalgoty=131;
        end
     pu=0;            /* Принят уволен +/
     if (exists (SELECT FIRST 1 ShifrSta FROM FCN a
                        WHERE (A.SHIFRSTA=71 or ShifrSta=71+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa)) then pu=1;
     smr=0;           /* Сторонне место работы  +/
     if (exists (SELECT FIRST 1 TABNO FROM person a
                        WHERE (w_place in (82,121,161)) and
                              A.TABNO=:TABNO AND
                              a.monthvy=:MONTHZA AND
                              A.Yearvy=:YearZa)) then smr=1;

     /* Многодетной матери увеличить лимит на к-во детей+/
     raslimitlgota=limitlgoty;
     SELECT FIRST 1 PRIM FROM fcn a
            WHERE (a.shifrsta=127 or a.shifrsta=127+500) and
                  A.TABNO    = :TABNO AND
                  A.month_vy = :MONTHZA AND
                  A.Year_vy  = :YearZa into :kd;
             if (lg is null) then kd=0;
      if (kd>0 and kd<10) then
          raslimitlgota=raslimitlgota*kd;

     if (pu=0 and smr=0 and summa<raslimitlgota) then
        begin
             SELECT FIRST 1 SUMMA FROM fcn a
                        WHERE (a.shifrsta=117 or a.shifrsta=117+500) and
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa into :lg;
             if (lg is null) then lg=0;
             lg=summalgoty*(1+lg);
             summa=summa-lg;
             if (Summa<0) then Summa=0;
        end
     Summa=Summa-SummaPens-SummaSS-SummaFZ;
     if (Summa<0) then Summa=0;
     summapod=summa*p;
  suspend;*/
end^


ALTER PROCEDURE PODOH_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2))
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
declare variable ISLGOTY integer;
declare variable SUMMALGOTY decimal(15,2);
declare variable LIMITLGOTY decimal(15,2);
declare variable P decimal(15,2);
declare variable D date;
declare variable PU integer; /* Принят уволен */
declare variable SMR integer; /* Стороннее место работы */
declare variable LG decimal(15,2);
declare variable KD integer;
declare variable RASLIMITLGOTA decimal(15,2);
begin
     select first 1 summapod from PODOH_COMMON_2010(:TABNO,:YEARZA,:MONTHZA,:SUMMA,:summaecb,:summaecbill, 0)
     into :summapod;
     suspend;
end^


ALTER PROCEDURE PODOH_COMMON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
declare variable ISLGOTY integer;
declare variable SUMMALGOTY decimal(15,2);
declare variable LIMITLGOTY decimal(15,2);
declare variable P decimal(15,2);
declare variable D date;
declare variable PU integer; /* Принят уволен */
declare variable SMR integer; /* Стороннее место работы */
declare variable LG decimal(15,2);
declare variable KD integer;
declare variable RASLIMITLGOTA decimal(15,2);
declare variable LIMITFORSEC decimal(15,2);
declare variable ADDPODOH decimal(15,2);
declare variable PROCADD decimal(15,2);
declare variable SOC_LGOTA integer;
declare variable SUMMA_SOC_LGOTY decimal(15,2);
declare variable DOPLGOTYFORDETI decimal(15,2);
begin
     IsLgoty=0;
/* Проверить пенсионера */ /* c 2007 пенсионеры платят фонд зан */
/*
     if (mode=1) then
        begin
              if (exists (SELECT FIRST 1 ShifrSta FROM tb_tmp_FCN a
                        WHERE (A.SHIFRSTA=107 or ShifrSta=107+500) AND   --Пенсионер
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa  and
                              conn_id=current_connection)) then SUMMAFZ=0;
        end
     else
        begin
              if (exists (SELECT FIRST 1 ShifrSta FROM FCN a
                        WHERE (A.SHIFRSTA=107 or ShifrSta=107+500) AND   --Пенсионер
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa)) then SUMMAFZ=0;
        end
*/
--     exception t tabno||' '||YearZa||' '||MonthZa||' '||summa||' '||summaecb;

     d=yearza||'-'||monthza||'-10';
     SELECT FIRST 1 a.summalgoty,a.limitlgoty,a.proc,limitforsec,addpodoh, procadd from podohtbl a
            where a.datefr<=:d
            order by a.datefr desc
            into :summalgoty,:limitlgoty,:p,:limitforsec,:addpodoh,:procadd;
     if (p is null) then
        begin
             p=0.15;
             limitlgoty=1320;
             summalgoty=470.50;
        end
     limitforsec=coalesce(limitforsec,9410.00);
     addpodoh=coalesce(addpodoh, 1411.500);
     procadd=coalesce(procadd, 0.17);
     pu=0;            /* Принят уволен */
     if (mode=1) then
        begin
             if (exists (SELECT FIRST 1 ShifrSta FROM tb_tmp_FCN a
                        WHERE (A.SHIFRSTA=71 or ShifrSta=71+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa and
                              conn_id=current_connection)) then pu=1;
        end
     else
        begin
             if (exists (SELECT FIRST 1 ShifrSta FROM FCN a
                        WHERE (A.SHIFRSTA=71 or ShifrSta=71+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa)) then pu=1;
        end
     smr=0;           /* Сторонне место работы  */
     if (mode=1) then
        begin
             if (exists (SELECT FIRST 1 TABNO FROM tb_tmp_person a
                        WHERE (w_place in (82,121,161)) and
                              A.TABNO=:TABNO AND
                              a.monthvy=:MONTHZA AND
                              A.Yearvy=:YearZa and
                              conn_id=current_connection)) then smr=1;
        end
     else
        begin
             if (exists (SELECT FIRST 1 TABNO FROM person a
                        WHERE (w_place in (82,121,161)) and
                              A.TABNO=:TABNO AND
                              a.monthvy=:MONTHZA AND
                              A.Yearvy=:YearZa)) then smr=1;
        end
     /* Многодетной матери увеличить лимит на к-во детей*/
     raslimitlgota   = limitlgoty;
     doplgotyfordeti = 0;
     if (mode=1) then
          SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                 WHERE (a.shifrsta=127 or a.shifrsta=127+500) and
                        A.TABNO    = :TABNO   AND
                        A.month_vy = :MONTHZA AND
                        A.Year_vy  = :YearZa and
                        conn_id=current_connection into :kd;
     else
          SELECT FIRST 1 PRIM FROM fcn a
                 WHERE (a.shifrsta=127 or a.shifrsta=127+500) and
                        A.TABNO    = :TABNO AND
                        A.month_vy = :MONTHZA AND
                        A.Year_vy  = :YearZa into :kd;
      kd=coalesce(kd, 0);
      if (kd>0 and kd<10) then
          begin
               raslimitlgota=raslimitlgota*(kd+1);
               DOPLGOTYFORDETI=summalgoty*kd;
               if (summa<raslimitlgota) then
                   summa=summa-DOPLGOTYFORDETI;
               if (Summa<0) then
                   Summa=0;

   --            limitlgoty=limitlgoty*kd;
          end

     /* Лишен льгот если есть код 129 */
---     raslimitlgota=limitlgoty;
     if (mode=1) then
         if (exists (SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                            WHERE (a.shifrsta=129 or a.shifrsta=129+500) and
                                   A.TABNO    = :TABNO   AND
                                   A.month_vy = :MONTHZA AND
                                   A.Year_vy  = :YearZa and
                                   conn_id=current_connection)) then
            kd=1;
         else
            kd=0;
     else
         if ( exists(SELECT FIRST 1 PRIM FROM fcn a
                      WHERE (a.shifrsta=129 or a.shifrsta=129+500) and
                             A.TABNO    = :TABNO AND
                             A.month_vy = :MONTHZA AND
                             A.Year_vy  = :YearZa) ) then
            kd=1;
         else
            kd=0;
      if (kd=1) then
         raslimitlgota=0;
     /* C 01 01 2011 если нет кода 147, то нет и социальной льготы*/
     soc_lgota=0;
     if (Yearza>2010) then
     if (mode=1) then
         if (exists (SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                            WHERE (a.shifrsta in (117,147) or a.shifrsta in (117+500,147+500)) and
                                   A.TABNO    = :TABNO   AND
                                   A.month_vy = :MONTHZA AND
                                   A.Year_vy  = :YearZa and
                                   conn_id=current_connection)) then
            soc_lgota=1;
         else
            soc_lgota=0;
     else
         if ( exists(SELECT FIRST 1 PRIM FROM fcn a
                      WHERE (a.shifrsta in (117,147) or a.shifrsta in (117+500,147+500)) and
                             A.TABNO    = :TABNO AND
                             A.month_vy = :MONTHZA AND
                             A.Year_vy  = :YearZa)) then
            soc_lgota=1;
         else
            soc_lgota=0;
    -- exception t soc_lgota;
      if (soc_lgota=0) then
         begin
              summa_soc_lgoty=0;
              raslimitlgota=0;
         end
      else
         summa_soc_lgoty = summalgoty;
   ---------------------------------------------
--     exception t tabno||' '||YearZa||' '||MonthZa||' '||summa||' '||summaecb||' '||pu||' '||smr||' '||raslimitlgota;
     if (pu=0 and smr=0 and summa<raslimitlgota) then
        begin
             if (mode=1) then
                 SELECT FIRST 1 SUMMA FROM tb_tmp_fcn a
                        WHERE (a.shifrsta=117 or a.shifrsta=117+500) and
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa and
                              conn_id=current_connection into :lg;
             else
                 SELECT FIRST 1 SUMMA FROM fcn a
                        WHERE (a.shifrsta=117 or a.shifrsta=117+500) and
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa into :lg;
             lg=coalesce(lg,0);
             if ((lg>0) or (soc_lgota=1))  then
                lg=summalgoty*(1+lg);
             lg=lg+doplgotyfordeti;
--             if (kd>0) then
--                 lg=lg+summalgoty*kd;
             summa=summa-lg;
             if (Summa<0) then Summa=0;
        end
     Summa=Summa-SummaECb;
     if (Summa<0) then Summa=0;
     if (summa>limitforsec) then
        summapod=addpodoh+(summa-limitforsec)*procadd;
     else
        summapod=summa*p;
--  exception t tabno||' '||YearZa||' '||MonthZa||' '||summa||' '||summaecb||' '||summapod||' '||p||' '||limitforsec;
  suspend;
end^


ALTER PROCEDURE PODOH_COMMON_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAECB DECIMAL(15,2),
    SUMMAECBILL DECIMAL(15,2),
    MODE INTEGER)
RETURNS (
    SUMMAPOD DECIMAL(15,2))
AS
declare variable ISLGOTY integer;
declare variable SUMMALGOTY decimal(15,2);
declare variable LIMITLGOTY decimal(15,2);
declare variable P decimal(15,2);
declare variable D date;
declare variable PU integer; /* Принят уволен */
declare variable SMR integer; /* Стороннее место работы */
declare variable LG decimal(15,2);
declare variable KD integer;
declare variable RASLIMITLGOTA decimal(15,2);
declare variable LIMITFORSEC decimal(15,2);
declare variable ADDPODOH decimal(15,2);
declare variable PROCADD decimal(15,2);
declare variable SOC_LGOTA integer;
declare variable SUMMA_SOC_LGOTY decimal(15,2);
declare variable DOPLGOTYFORDETI decimal(15,2);
begin
     IsLgoty=0;
     d=yearza||'-'||monthza||'-10';
     SELECT FIRST 1 a.summalgoty,a.limitlgoty,a.proc,limitforsec,addpodoh, procadd from podohtbl a
            where a.datefr<=:d
            order by a.datefr desc
            into :summalgoty,:limitlgoty,:p,:limitforsec,:addpodoh,:procadd;
     if (p is null) then
        begin
             p=0.15;
             limitlgoty=1320;
             summalgoty=470.50;
        end
     limitforsec=coalesce(limitforsec,9410.00);
     addpodoh=coalesce(addpodoh, 1411.500);
     procadd=coalesce(procadd, 0.17);
     pu=0;            /* Принят уволен */
     if (mode=1) then
        begin
             if (exists (SELECT FIRST 1 ShifrSta FROM tb_tmp_FCN a
                        WHERE (A.SHIFRSTA=71 or ShifrSta=71+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa and
                              conn_id=current_connection)) then pu=1;
        end
     else
        begin
             if (exists (SELECT FIRST 1 ShifrSta FROM FCN a
                        WHERE (A.SHIFRSTA=71 or ShifrSta=71+500) AND
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa)) then pu=1;
        end
     smr=0;           /* Сторонне место работы  */
     if (mode=1) then
        begin
             if (exists (SELECT FIRST 1 TABNO FROM tb_tmp_person a
                        WHERE (w_place in (82,121,161)) and
                              A.TABNO=:TABNO AND
                              a.monthvy=:MONTHZA AND
                              A.Yearvy=:YearZa and
                              conn_id=current_connection)) then smr=1;
        end
     else
        begin
             if (exists (SELECT FIRST 1 TABNO FROM person a
                        WHERE (w_place in (82,121,161)) and
                              A.TABNO=:TABNO AND
                              a.monthvy=:MONTHZA AND
                              A.Yearvy=:YearZa)) then smr=1;
        end
     /* Многодетной матери увеличить лимит на к-во детей*/
     raslimitlgota   = limitlgoty;
     doplgotyfordeti = 0;
     if (mode=1) then
          SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                 WHERE (a.shifrsta=127 or a.shifrsta=127+500) and
                        A.TABNO    = :TABNO   AND
                        A.month_vy = :MONTHZA AND
                        A.Year_vy  = :YearZa and
                        conn_id=current_connection into :kd;
     else
          SELECT FIRST 1 PRIM FROM fcn a
                 WHERE (a.shifrsta=127 or a.shifrsta=127+500) and
                        A.TABNO    = :TABNO AND
                        A.month_vy = :MONTHZA AND
                        A.Year_vy  = :YearZa into :kd;
      if (lg is null) then kd=0;
      if (kd>0 and kd<10) then
          begin
               raslimitlgota=raslimitlgota*(kd+1);
               DOPLGOTYFORDETI=limitlgoty*kd;
   --            limitlgoty=limitlgoty*kd;
          end

     /* Лишен льгот если есть код 129 */
---     raslimitlgota=limitlgoty;
     if (mode=1) then
         if (exists (SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                            WHERE (a.shifrsta=129 or a.shifrsta=129+500) and
                                   A.TABNO    = :TABNO   AND
                                   A.month_vy = :MONTHZA AND
                                   A.Year_vy  = :YearZa and
                                   conn_id=current_connection)) then
            kd=1;
         else
            kd=0;
     else
         if ( exists(SELECT FIRST 1 PRIM FROM fcn a
                      WHERE (a.shifrsta=129 or a.shifrsta=129+500) and
                             A.TABNO    = :TABNO AND
                             A.month_vy = :MONTHZA AND
                             A.Year_vy  = :YearZa) ) then
            kd=1;
         else
            kd=0;
      if (kd=1) then
         raslimitlgota=0;
     /* C 01 01 2011 если нет кода 147, то нет и социальной льготы*/
     soc_lgota=0;
     if (Yearza>2010) then
     if (mode=1) then
         if (exists (SELECT FIRST 1 PRIM FROM tb_tmp_fcn a
                            WHERE (a.shifrsta=147 or a.shifrsta=147+500) and
                                   A.TABNO    = :TABNO   AND
                                   A.month_vy = :MONTHZA AND
                                   A.Year_vy  = :YearZa and
                                   conn_id=current_connection)) then
            soc_lgota=1;
         else
            soc_lgota=0;
     else
         if ( exists(SELECT FIRST 1 PRIM FROM fcn a
                      WHERE (a.shifrsta=147 or a.shifrsta=147+500) and
                             A.TABNO    = :TABNO AND
                             A.month_vy = :MONTHZA AND
                             A.Year_vy  = :YearZa) ) then
            soc_lgota=1;
         else
            soc_lgota=0;
      if (soc_lgota=0) then
         summa_soc_lgoty=0;
      else
         summa_soc_lgoty = summalgoty;
   ---------------------------------------------
     if (pu=0 and smr=0 and summa<raslimitlgota) then
        begin
             if (mode=1) then
                 SELECT FIRST 1 SUMMA FROM tb_tmp_fcn a
                        WHERE (a.shifrsta=117 or a.shifrsta=117+500) and
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa and
                              conn_id=current_connection into :lg;
             else
                 SELECT FIRST 1 SUMMA FROM fcn a
                        WHERE (a.shifrsta=117 or a.shifrsta=117+500) and
                              A.TABNO=:TABNO AND
                              A.month_vy=:MONTHZA AND
                              A.Year_vy=:YearZa into :lg;
             lg=coalesce(lg,0);
             if ((lg>0) or (soc_lgota=1))  then
                lg=summalgoty*(1+lg);
             lg=lg+doplgotyfordeti;
--             if (kd>0) then
--                 lg=lg+summalgoty*kd;
             summa=summa-lg;
             if (Summa<0) then Summa=0;
        end
     Summa=Summa-SummaECb-SummaECBIll;
     if (Summa<0) then Summa=0;
     if (summa>limitforsec) then
        summapod=addpodoh+(summa-limitforsec)*procadd;
     else
        summapod=summa*p;
  suspend;
end^


ALTER PROCEDURE PR_1DF_ITOGI (
    Y INTEGER,
    M INTEGER)
RETURNS (
    NAMEB VARCHAR(20),
    NMBOFLINE INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAPOD DECIMAL(15,2))
AS
begin
     select count(*),sum(summaadd),sum(summapod) from tb_1df
            where y=:y
            and m=:m
            and char_length(trim(coalesce(nal_code,'')))<>10
            into  :nmbofline, :summaadd,:summapod;
      nameb='без ИНН';
  /* Procedure Text */
      suspend;
      select count(*),sum(summaadd),sum(summapod) from tb_1df
             where y=:y
             and m=:m
             and char_length(trim(coalesce(nal_code,'')))=10
             into  :nmbofline, :summaadd,:summapod;
       nameb='с ИНН';
  /* Procedure Text */
      suspend;
      select count(*),sum(summaadd),sum(summapod) from tb_1df
             where y=:y
             and m=:m
             into  :nmbofline, :summaadd,:summapod;
       nameb='Итого';
  /* Procedure Text */
       suspend;
end^


ALTER PROCEDURE PR_1DF_MK_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable CURRKW integer;
declare variable TABNO integer;
declare variable FIO varchar(100);
declare variable NAL_CODE varchar(10);
declare variable DATA_PRI date;
declare variable DATA_UW date;
declare variable SUMMAADD1 decimal(15,2);
declare variable SUMMAADD2 decimal(15,2);
declare variable SUMMAADD3 decimal(15,2);
declare variable SUMMAPOD1 decimal(15,2);
declare variable SUMMAPOD2 decimal(15,2);
declare variable SUMMAPOD3 decimal(15,2);
declare variable SUMMAWS1 decimal(15,2);
declare variable SUMMAWS2 decimal(15,2);
declare variable SUMMAWS3 decimal(15,2);
declare variable M1 integer;
declare variable M2 integer;
declare variable M3 integer;
declare variable I integer;
declare variable CURRM integer;
declare variable SUMMAADD decimal(15,2);
declare variable SHIFRID integer;
declare variable CODE_PRIZ integer;
declare variable PRIZNAK varchar(6);
declare variable OZN_PILG integer;
declare variable INVALID integer;
declare variable W_R integer;
declare variable DT date;
declare variable LIMLGSUMMA decimal(15,2);
declare variable R decimal(15,2);
declare variable MS integer;
declare variable OKLAD decimal(15,2);
declare variable RAZRJAD integer;
declare variable CNT_PILG_REC integer;
declare variable SUMMA_PILG decimal(15,2);
declare variable KD integer;
declare variable NEED_LG integer;
begin
     DELETE FROM TB_1DF WHERE Y=:Y AND M=:M;
 --    execute procedure pr_1df_mk_dogpod(:y,:m);
 --    exit;
     CURRKW= CASE
               WHEN M BETWEEN 1 AND 3 THEN 1
               WHEN M BETWEEN 4 AND 6 THEN 2
               WHEN M BETWEEN 7 AND 9 THEN 3
               else 4
             END;
     m1=(currkw-1)*3+1;
     m2=(currkw-1)*3+2;
     m3=(currkw-1)*3+3;
     code_priz=0;
     FOR
        SELECT A.TABNO,sum(a.summa) FROM FADD A
                       JOIN PERSON B ON A.shifridperson=B.shifrid
                       join shifr c on c.shifr=a.shifrsta
                       WHERE B.yearvy=:Y
                       AND a.month_vy in (:m1,:m2,:m3)
                       AND abs(a.summa)>0.005
                       and c.podoh=1
                       and a.w_place not in (106) --не включать мат пом и договора подряда
                  --     and ((select first 1 retval from pr_is_dogpod(a.w_place))=0) --договора подряда
                  --     and a.shifrsta not in (32,158)  -- декретный больничный и договора подряда - не включать
                       and a.shifrsta not in (32)  -- декретный больничный и договора подряда - не включать
                 --      and b.tabno=1098
                       GROUP BY 1
                   --    having abs(sum(a.summa))>0.001
         union
         select e.tabno,0 from fud d
                          join person e on d.shifridperson=e.shifrid
                          where d.shifrsta in (50,161) -- 50 под налог 161 в сбор
                          and e.yearvy=:y
                          and e.monthvy in (:m1, :m2,:m3)
                          and d.w_place not in (106)
                --          and ((select first 1 retval from pr_is_dogpod(d.w_place))=0) --договора подряда
                          and not exists (select * from fadd f
                                  join shifr g on g.shifr=f.shifrsta
                                  join person h on h.shifrid=f.shifridperson
                                  where h.tabno=e.tabno
                                  and h.yearvy=:y
                                  and h.w_place not in (106)   --договора и мат пом исключить
                 --                 and ((select first 1 retval from pr_is_dogpod(h.w_place))=0) --договора подряда
                                  and g.podoh=1
                                  and h.monthvy in (:m1, :m2,:m3))
                 --                 and e.tabno=1098
                          group by 1,2
                       INTO :TABNO,summaadd
     DO
        BEGIN
             data_pri = null;
             data_uw  = null;
             fio      = null;
             nal_code = null;
             shifrid=gen_id(g_1df, 1);
             if (exists (select * from kadry where tabno=:tabno)) then
                select first 1 kadry.nal_code,kadry.fio,kadry.data_pri,kadry.data_uw
                       from kadry where kadry.tabno=:tabno
                       into :nal_code, :fio, :data_pri, :data_uw;
             else
                select first 1 person.nal_code,person.fio
                       from person where person.tabno=:tabno
                       order by yearvy,monthvy
                       into :nal_code, :fio;
             w_r=1;
             if (data_pri is not null) then
                if (not ( (extract(year from data_pri)=y) and
                         (extract(month from data_pri) in (m1,m2,m3))
                       )) then data_pri=null;
             if (data_uw is not null) then
                if (not ( (extract(year from data_uw)=y) and
                         (extract(month from data_uw) in (m1,m2,m3))
                       )) then data_uw=null;
             if (exists(select * from person where tabno=:tabno
                                             and yearvy=:y
                                             and monthvy in (:m1,:m2,:m3)
                                             and w_place in (82,121,161)
             )) then w_r=2;
             invalid=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (112,112+500)

             )) then invalid=1;
             ozn_pilg=0;
             cnt_pilg_rec=0;
             summa_pilg=0;
             select first 1 fcn.shifrid,fcn.summa from fcn join person on fcn.shifridperson=person.shifrid
                    where person.tabno=:tabno
                      and person.yearvy=:y
                      and person.monthvy in (:m1,:m2,:m3)
                      and fcn.shifrsta in (147,147+500)   -- льготы ПН 2011
                    into :cnt_pilg_rec,:summa_pilg;
             cnt_pilg_rec=coalesce(cnt_pilg_rec, 0);
             summa_pilg=coalesce(summa_pilg,0.00);
             if (cnt_pilg_rec>0) then
                ozn_pilg=case
                             when summa_pilg=0.5 then 2
                             when summa_pilg=1 then 3
                             else 1
                         end;
             kd=0;
             cnt_pilg_rec=null;
             select first 1 fcn.shifrid,fcn.prim from fcn
                    join person on fcn.shifridperson=person.shifrid
                    where person.tabno=:tabno
                      and person.yearvy=:y
                      and person.monthvy in (:m1,:m2,:m3)
                      and fcn.shifrsta in (127,127+500)        -- 127 льгота на детей
                    into :cnt_pilg_rec,:kd;
             cnt_pilg_rec=coalesce(cnt_pilg_rec,0);
             kd=coalesce(kd,0);
             if (kd>0) then
                ozn_pilg=4;

             cnt_pilg_rec=null;
             select first 1 fcn.shifrid from fcn
                    join person on fcn.shifridperson=person.shifrid
                    where person.tabno=:tabno
                      and person.yearvy=:y
                      and person.monthvy in (:m1,:m2,:m3)
                      and fcn.shifrsta in (129,129+500) -- не учитывать льготы
                    into :cnt_pilg_rec;
             cnt_pilg_rec=coalesce(cnt_pilg_rec,0);
             if (cnt_pilg_rec>0) then
                ozn_pilg=0;

             ozn_pilg=coalesce(ozn_pilg, 0);
             summaadd1 = 0;
             summaadd2 = 0;
             summaadd3 = 0;
             summapod1 = 0;
             summapod2 = 0;
             summapod3 = 0;
             summaws1  = 0;
             summaws2  = 0;
             summaws3  = 0;
             nal_code  = coalesce(nal_code,'');
             insert into tb_1df (shifrid,tabno,nal_code, fio, w_r,
                                 summaadd, summapod,summaws,
                                 summaadd1,summaadd2,summaadd3,
                                 summapod1,summapod2,summapod3,
                                 summaws1 ,summaws2 ,summaws3 ,
                                 datapri,datauw,code_priz,priznak,
                                 ozn_pilg,invalid,y,m) values (
                                 :shifrid,:tabno,:nal_code, :fio, :w_r,
                                 :summaadd1+:summaadd2+:summaadd3,
                                 :summapod1+:summapod2+:summapod3,
                                 :summaws1 +:summaws2 +:summaws3,
                                 :summaadd1,:summaadd2,:summaadd3,
                                 :summapod1,:summapod2,:summapod3,
                                 :summaws1 ,:summaws2 ,:summaws3,
                                 :data_pri,:data_uw,:code_priz,:priznak,
                                 :ozn_pilg,:invalid,:y, :m);

             insert into tb_1df_add (SHIFRID1DF,tabno, w_place,w_r,
                                            shifrgru,shifrkat,shifrsta,
                                            month_za,year_za,month_vy,year_vy,
                                            summa, fond,vypl)
                           select :shifrid,person.tabno, person.w_place,person.w_r,
                                  person.shifrgru,person.shifrkat,fadd.shifrsta,
                                  fadd.month_za,fadd.year_za,person.monthvy,person.yearvy,
                                  fadd.summa, fadd.fond,fadd.vypl from fadd
                                  join shifr on fadd.shifrsta=shifr.shifr
                                  join person on person.shifrid=fadd.shifridperson
                                  where fadd.tabno=:tabno
                                  and person.yearvy=:y
                                  and person.w_place not in (106)
                           --       and ((select first 1 retval from pr_is_dogpod(person.w_place))=0) --договора подряда
                           --       and fadd.shifrsta not in (32,158) -- декр болн и дог подр
                                  and fadd.shifrsta not in (32) -- декр болн и дог подр
                                  and person.monthvy in (:m1, :m2, :m3)
                                  and shifr.podoh=1;
             insert into tb_1df_ud (SHIFRID1DF, tabno,w_place,w_r, 
                                    SHIFRGRU,shifrkat,shifrsta,
                                    month_za,year_za,month_vy,year_vy,
                                    summa, vypl)
                    select :shifrid,person.tabno,person.w_place,person.w_r,
                           person.shifrgru,person.shifrkat,fud.shifrsta,
                           fud.month_za,fud.year_za,person.monthvy,person.yearvy,
                           fud.summa,fud.vypl from fud
                           join person on person.shifrid=fud.shifridperson
                           where fud.tabno=:tabno
                           and person.yearvy=:y
                           and person.w_place not in (106)
                 --          and (
                 --              ((select first 1 retval from pr_is_dogpod(person.w_place))=0) --договора подряда
                 --              and
                 --              (not exists (select * from fadd ffa where ffa.shifridperson=fud.shifridperson and ffa.shifrsta=158))
                 --              )
                           and person.monthvy in (:m1, :m2, :m3)
                           and fud.shifrsta in (50,161);
             i=0;
             while (I<3) do
              begin
                    i=i+1;
                    currm=case
                              when i=1 then m1
                              when i=2 then m2
                              when i=3 then m3
                          end;

                    select sum(tb_1df_add.summa) from tb_1df_add
                           where tb_1df_add.shifrid1df=:shifrid
                           and tb_1df_add.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaadd1=summaadd;
                    else if (i=2) then summaadd2=summaadd;
                    else summaadd3=summaadd;
          -- Выбрать подоходный налог
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=50
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summapod1=summaadd;
                    else if (i=2) then summapod2=summaadd;
                    else summapod3=summaadd;
          -- Выбрать военный сбор
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=161
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaws1=summaadd;
                    else if (i=2) then summaws2=summaadd;
                    else summaws3=summaadd;
              end
             select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (126,126+500)   -- разряд
                                         order by fcn.prim desc
                                         into :Razrjad;
             Razrjad=coalesce(razrjad, 0);
             if (ozn_pilg>0) then
                begin
                     i=0;
                     if (tabno=10023) then
                        i=0;
                     need_lg=0;
                     while (i<3) do
                       begin
                            i=i+1;
                            ms=(currkw-1)*3+i;
                            dt=y||'-'||ms||'-01';
                            select first 1 limitlgoty from podohtbl
                                   where datefr<:dt
                                   order by datefr desc
                                   into limlgsumma;

                            limlgsumma=coalesce(limlgsumma,0);
                            r=case
                                  when i=1 then summaadd1
                                  when i=2 then summaadd2
                                  else summaadd3
                              end;
                            select first 1 oklad from person
                                         where tabno = :tabno
                                         and yearvy  = :y
                                         and monthvy = :ms
                                         order by oklad desc
                                         into :oklad;
                            oklad=coalesce(oklad,0);
                            r=limlgsumma-r;
                   --         if  ((r>0.01) and (oklad<limlgsumma)) then
                   --             ozn_pilg=1;
                            if  (r>0.01) then
                                need_lg=1;
                       end
                       if (need_lg=0) then
                          ozn_pilg=0;
                end
              if (w_r<>1) then ozn_pilg=0;
              update tb_1df 
                     set summaadd=:summaadd1+:summaadd2+:summaadd3,
                         summapod=:summapod1+:summapod2+:summapod3,
                         summaws =:summaws1 +:summaws2 +:summaws3 ,
                         summaadd1=:summaadd1,
                         summaadd2=:summaadd2,
                         summaadd3=:summaadd3,
                         summapod1=:summapod1,
                         summapod2=:summapod2,
                         summapod3=:summapod3,
                         summaws1 =:summaws1 ,
                         summaws2 =:summaws2 ,
                         summaws3 =:summaws3 ,
                         ozn_pilg =:ozn_pilg
                     where shifrid=:shifrid;
        END
     -- Материальная помощь облагаемая
     code_priz=126;
     FOR
        SELECT A.TABNO,sum(a.summa) FROM FADD A
                       JOIN PERSON B ON A.shifridperson=B.shifrid
                       WHERE B.yearvy=:Y
                       AND a.month_vy in (:m1,:m2,:m3)
                       AND abs(a.summa)>0.005
                       and a.w_place in (106)
                       and a.shifrsta=141 -- М П облагаемая
                       GROUP BY 1
                   --    having abs(sum(a.summa))>0.001
         union
         select e.tabno,0 from fud d
                          join person e on d.shifridperson=e.shifrid
                          where d.shifrsta =50
                          and e.yearvy=:y
                          and e.monthvy in (:m1, :m2,:m3)
                          and d.w_place in (106)
                          and not exists (select * from fadd f
                                  join person h on h.shifrid=f.shifridperson
                                  where h.tabno=e.tabno
                                  and h.yearvy=:y
                                  and f.shifrsta=141
                                  and f.w_place=106
                                  and h.monthvy in (:m1, :m2,:m3))
                          group by 1,2
                       INTO :TABNO,summaadd
     DO
        BEGIN
             data_pri = null;
             data_uw  = null;
             fio      = null;
             nal_code = null;
             shifrid=gen_id(g_1df, 1);
             if (exists (select * from kadry where tabno=:tabno)) then
                select first 1 kadry.nal_code,kadry.fio,kadry.data_pri,kadry.data_uw
                       from kadry where kadry.tabno=:tabno
                       into :nal_code, :fio, :data_pri, :data_uw;
             else
                select first 1 person.nal_code,person.fio
                       from person where person.tabno=:tabno
                       order by yearvy,monthvy
                       into :nal_code, :fio;
             w_r=1;
             if (data_pri is not null) then
                if (not ( (extract(year from data_pri)=y) and
                         (extract(month from data_pri) in (m1,m2,m3))
                       )) then data_pri=null;
             if (data_uw is not null) then
                if (not ( (extract(year from data_uw)=y) and
                         (extract(month from data_uw) in (m1,m2,m3))
                       )) then data_uw=null;
             if (exists(select * from person where tabno=:tabno
                                             and yearvy=:y
                                             and monthvy in (:m1,:m2,:m3)
                                             and w_place in (82,121,161)
             )) then w_r=2;
             invalid=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (112,112+500)

             )) then invalid=1;
             ozn_pilg=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (114,114+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (147,147+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-0.5)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=2;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-1.0)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=3;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (127,127+500)

             )) then ozn_pilg=4;
             ozn_pilg=coalesce(ozn_pilg, 0);
             summaadd1 = 0;
             summaadd2 = 0;
             summaadd3 = 0;
             summapod1 = 0;
             summapod2 = 0;
             summapod3 = 0;
             summaws1  = 0;
             summaws2  = 0;
             summaws3  = 0;
             nal_code  = coalesce(nal_code,'');
             insert into tb_1df (shifrid,tabno,nal_code, fio, w_r,
                                 summaadd ,summapod, summaws,
                                 summaadd1,summaadd2,summaadd3,
                                 summapod1,summapod2,summapod3,
                                 summaws1 ,summaws2 ,summaws3 ,
                                 datapri,datauw,code_priz,priznak,
                                 ozn_pilg,invalid,y,m) values (
                                 :shifrid,:tabno,:nal_code, :fio, :w_r,
                                 :summaadd1+:summaadd2+:summaadd3,
                                 :summapod1+:summapod2+:summapod3,
                                 :summaws1 +:summaws2 +:summaws3 ,
                                 :summaadd1,:summaadd2,:summaadd3,
                                 :summapod1,:summapod2,:summapod3,
                                 :summaws1 ,:summaws3 ,:summaws3 ,
                                 :data_pri,:data_uw,:code_priz,:priznak,
                                 :ozn_pilg,:invalid,:y, :m);

             insert into tb_1df_add (SHIFRID1DF,tabno, w_place,w_r,
                                            shifrgru,shifrkat,shifrsta,
                                            month_za,year_za,month_vy,year_vy,
                                            summa, fond,vypl)
                           select :shifrid,person.tabno, person.w_place,person.w_r,
                                  person.shifrgru,person.shifrkat,fadd.shifrsta,
                                  fadd.month_za,fadd.year_za,person.monthvy,person.yearvy,
                                  fadd.summa, fadd.fond,fadd.vypl from fadd
                                  join person on person.shifrid=fadd.shifridperson
                                  where fadd.tabno=:tabno
                                  and person.yearvy=:y
                                  and person.w_place=106
                                  and fadd.shifrsta=141
                                  and person.monthvy in (:m1, :m2, :m3);
             insert into tb_1df_ud (SHIFRID1DF, tabno,w_place,w_r,
                                    SHIFRGRU,shifrkat,shifrsta,
                                    month_za,year_za,month_vy,year_vy,
                                    summa, vypl)
                    select :shifrid,person.tabno,person.w_place,person.w_r,
                           person.shifrgru,person.shifrkat,fud.shifrsta,
                           fud.month_za,fud.year_za,person.monthvy,person.yearvy,
                           fud.summa,fud.vypl from fud
                           join person on person.shifrid=fud.shifridperson
                           where fud.tabno=:tabno
                           and person.yearvy=:y
                           and person.monthvy in (:m1, :m2, :m3)
                           and fud.shifrsta in (50,161)
                           and fud.w_place=106;
             i=0;
             while (I<3) do
              begin
                    i=i+1;
                    currm=case
                              when i=1 then m1
                              when i=2 then m2
                              when i=3 then m3
                          end;

                    select sum(tb_1df_add.summa) from tb_1df_add
                           where tb_1df_add.shifrid1df=:shifrid
                           and tb_1df_add.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaadd1=summaadd;
                    else if (i=2) then summaadd2=summaadd;
                    else summaadd3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=50
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summapod1=summaadd;
                    else if (i=2) then summapod2=summaadd;
                    else summapod3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=161
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaws1=summaadd;
                    else if (i=2) then summaws2=summaadd;
                    else summaws3=summaadd;
              end
             select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (126,126+500)   -- разряд
                                         order by fcn.prim desc
                                         into :Razrjad;
             Razrjad=coalesce(razrjad, 0);
             if (ozn_pilg<1) then
             if (not (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (129,129+500)  -- не учитывать льготы

                ))) then
             if (Razrjad>5) then
                begin
                     i=0;
                     if (tabno=10023) then
                        i=0;
                     while (i<3) do
                       begin
                            i=i+1;
                            ms=(currkw-1)*3+i;
                            dt=y||'-'||ms||'-01';
                            select first 1 limitlgoty from podohtbl
                                   where datefr<:dt
                                   order by datefr desc
                                   into limlgsumma;

                            limlgsumma=coalesce(limlgsumma,0);
                            r=case
                                  when i=1 then summaadd1
                                  when i=2 then summaadd2
                                  else summaadd3
                              end;
                            select first 1 oklad from person
                                         where tabno = :tabno
                                         and yearvy  = :y
                                         and monthvy = :ms
                                         order by oklad desc
                                         into :oklad;
                            oklad=coalesce(oklad,0);
                            r=limlgsumma-r;
                            if ((r>0.01) and (oklad<limlgsumma)) then
                                ozn_pilg=1;
                       end
                end
              if (w_r<>1) then ozn_pilg=0;
              update tb_1df 
                     set summaadd=:summaadd1+:summaadd2+:summaadd3,
                         summapod=:summapod1+:summapod2+:summapod3,
                         summaws =:summaws1 +:summaws2 +:summaws3,
                         summaadd1=:summaadd1,
                         summaadd2=:summaadd2,
                         summaadd3=:summaadd3,
                         summapod1=:summapod1,
                         summapod2=:summapod2,
                         summapod3=:summapod3,
                         summaws1 =:summaws1,
                         summaws2 =:summaws2,
                         summaws3 =:summaws3,
                         ozn_pilg =:ozn_pilg
                     where shifrid=:shifrid;
        END

     -- Материальная помощь облагаемая
     code_priz=169;
     FOR
        SELECT A.TABNO,sum(a.summa) FROM FADD A
                       JOIN PERSON B ON A.shifridperson=B.shifrid
                       WHERE B.yearvy=:Y
                       AND a.month_vy in (:m1,:m2,:m3)
                       AND abs(a.summa)>0.005
                       and a.w_place in (106)
                       and a.shifrsta<>141 -- М П не облагаемая
                       GROUP BY 1
                   --    having abs(sum(a.summa))>0.001
                       INTO :TABNO,summaadd
     DO
        BEGIN
             data_pri = null;
             data_uw  = null;
             fio      = null;
             nal_code = null;
             shifrid=gen_id(g_1df, 1);
             if (exists (select * from kadry where tabno=:tabno)) then
                select first 1 kadry.nal_code,kadry.fio,kadry.data_pri,kadry.data_uw
                       from kadry where kadry.tabno=:tabno
                       into :nal_code, :fio, :data_pri, :data_uw;
             else
                select first 1 person.nal_code,person.fio
                       from person where person.tabno=:tabno
                       order by yearvy,monthvy
                       into :nal_code, :fio;
             w_r=1;
             if (data_pri is not null) then
                if (not ( (extract(year from data_pri)=y) and
                         (extract(month from data_pri) in (m1,m2,m3))
                       )) then data_pri=null;
             if (data_uw is not null) then
                if (not ( (extract(year from data_uw)=y) and
                         (extract(month from data_uw) in (m1,m2,m3))
                       )) then data_uw=null;
             if (exists(select * from person where tabno=:tabno
                                             and yearvy=:y
                                             and monthvy in (:m1,:m2,:m3)
                                             and w_place in (82,121,161)
             )) then w_r=2;
             invalid=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (112,112+500)

             )) then invalid=1;
             ozn_pilg=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (114,114+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (147,147+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-0.5)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=2;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-1.0)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=3;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (127,127+500)

             )) then ozn_pilg=4;
             ozn_pilg=coalesce(ozn_pilg, 0);
             summaadd1 = 0;
             summaadd2 = 0;
             summaadd3 = 0;
             summapod1 = 0;
             summapod2 = 0;
             summapod3 = 0;
             summaws1  = 0;
             summaws2  = 0;
             summaws3  = 0;
             nal_code  = coalesce(nal_code,'');
             insert into tb_1df (shifrid,tabno,nal_code, fio, w_r,
                                 summaadd, summapod, summaws,
                                 summaadd1,summaadd2,summaadd3,
                                 summapod1,summapod2,summapod3,
                                 summaws1 ,summaws2 ,summaws3 ,
                                 datapri,datauw,code_priz,priznak,
                                 ozn_pilg,invalid,y,m) values (
                                 :shifrid,:tabno,:nal_code, :fio, :w_r,
                                 :summaadd1+:summaadd2+:summaadd3,
                                 :summapod1+:summapod2+:summapod3,
                                 :summaws1 +:summaws2 +:summaws3 ,
                                 :summaadd1,:summaadd2,:summaadd3,
                                 :summapod1,:summapod2,:summapod3,
                                 :summaws1 ,:summaws2 ,:summaws3 ,
                                 :data_pri,:data_uw,:code_priz,:priznak,
                                 :ozn_pilg,:invalid,:y, :m);

             insert into tb_1df_add (SHIFRID1DF,tabno, w_place,w_r,
                                            shifrgru,shifrkat,shifrsta,
                                            month_za,year_za,month_vy,year_vy,
                                            summa, fond,vypl)
                           select :shifrid,person.tabno, person.w_place,person.w_r,
                                  person.shifrgru,person.shifrkat,fadd.shifrsta,
                                  fadd.month_za,fadd.year_za,person.monthvy,person.yearvy,
                                  fadd.summa, fadd.fond,fadd.vypl from fadd
                                  join person on person.shifrid=fadd.shifridperson
                                  where fadd.tabno=:tabno
                                  and person.yearvy=:y
                                  and person.w_place=106
                                  and fadd.shifrsta<>141
                                  and person.monthvy in (:m1, :m2, :m3);
             i=0;
             while (I<3) do
              begin
                    i=i+1;
                    currm=case
                              when i=1 then m1
                              when i=2 then m2
                              when i=3 then m3
                          end;

                    select sum(tb_1df_add.summa) from tb_1df_add
                           where tb_1df_add.shifrid1df=:shifrid
                           and tb_1df_add.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaadd1=summaadd;
                    else if (i=2) then summaadd2=summaadd;
                    else summaadd3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=50
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summapod1=summaadd;
                    else if (i=2) then summapod2=summaadd;
                    else summapod3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=161
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaws1=summaadd;
                    else if (i=2) then summaws2=summaadd;
                    else summaws3=summaadd;
              end
             select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (126,126+500)   -- разряд
                                         order by fcn.prim desc
                                         into :Razrjad;
             Razrjad=coalesce(razrjad, 0);
             if (ozn_pilg<1) then
             if (not (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (129,129+500)  -- не учитывать льготы

                ))) then
             if (Razrjad>5) then
                begin
                     i=0;
                     if (tabno=10023) then
                        i=0;
                     while (i<3) do
                       begin
                            i=i+1;
                            ms=(currkw-1)*3+i;
                            dt=y||'-'||ms||'-01';
                            select first 1 limitlgoty from podohtbl
                                   where datefr<:dt
                                   order by datefr desc
                                   into limlgsumma;

                            limlgsumma=coalesce(limlgsumma,0);
                            r=case
                                  when i=1 then summaadd1
                                  when i=2 then summaadd2
                                  else summaadd3
                              end;
                            select first 1 oklad from person
                                         where tabno = :tabno
                                         and yearvy  = :y
                                         and monthvy = :ms
                                         order by oklad desc
                                         into :oklad;
                            oklad=coalesce(oklad,0);
                            r=limlgsumma-r;
                            if ((r>0.01) and (oklad<limlgsumma)) then
                                ozn_pilg=1;
                       end
                end
              if (w_r<>1) then ozn_pilg=0;
              update tb_1df 
                     set summaadd=:summaadd1+:summaadd2+:summaadd3,
                         summapod=:summapod1+:summapod2+:summapod3,
                         summaws =:summaws1 +:summaws2 +:summaws3 ,
                         summaadd1=:summaadd1,
                         summaadd2=:summaadd2,
                         summaadd3=:summaadd3,
                         summapod1=:summapod1,
                         summapod2=:summapod2,
                         summapod3=:summapod3,
                         summaws1 =:summaws1 ,
                         summaws2 =:summaws2 ,
                         summaws3 =:summaws3 ,
                         ozn_pilg =:ozn_pilg
                     where shifrid=:shifrid;
        END



     -- Декретный дольничный (32 шифр ) 09 04 2014
     code_priz=128;
     FOR
        SELECT A.TABNO,sum(a.summa) FROM FADD A
                       JOIN PERSON B ON A.shifridperson=B.shifrid
                       WHERE B.yearvy=:Y
                       AND a.month_vy in (:m1,:m2,:m3)
                       AND abs(a.summa)>0.005
                       and a.w_place  not in (106)
                   --    and ((select first 1 retval from pr_is_DOGpod(a.w_place))=0)
                       and a.shifrsta=32 -- Декр болн
                       GROUP BY 1
                   --    having abs(sum(a.summa))>0.001
                       INTO :TABNO,summaadd
     DO
        BEGIN
             data_pri = null;
             data_uw  = null;
             fio      = null;
             nal_code = null;
             shifrid=gen_id(g_1df, 1);
             if (exists (select * from kadry where tabno=:tabno)) then
                select first 1 kadry.nal_code,kadry.fio,kadry.data_pri,kadry.data_uw
                       from kadry where kadry.tabno=:tabno
                       into :nal_code, :fio, :data_pri, :data_uw;
             else
                select first 1 person.nal_code,person.fio
                       from person where person.tabno=:tabno
                       order by yearvy,monthvy
                       into :nal_code, :fio;
             w_r=1;
             if (data_pri is not null) then
                if (not ( (extract(year from data_pri)=y) and
                         (extract(month from data_pri) in (m1,m2,m3))
                       )) then data_pri=null;
             if (data_uw is not null) then
                if (not ( (extract(year from data_uw)=y) and
                         (extract(month from data_uw) in (m1,m2,m3))
                       )) then data_uw=null;
             if (exists(select * from person where tabno=:tabno
                                             and yearvy=:y
                                             and monthvy in (:m1,:m2,:m3)
                                             and w_place in (82,121,161)
             )) then w_r=2;
             invalid=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (112,112+500)

             )) then invalid=1;
             ozn_pilg=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (114,114+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (147,147+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-0.5)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=2;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-1.0)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=3;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (127,127+500)

             )) then ozn_pilg=4;
             ozn_pilg=coalesce(ozn_pilg, 0);
             summaadd1 = 0;
             summaadd2 = 0;
             summaadd3 = 0;
             summapod1 = 0;
             summapod2 = 0;
             summapod3 = 0;
             summaws1  = 0;
             summaws2  = 0;
             summaws3  = 0;
             nal_code  = coalesce(nal_code,'');
             insert into tb_1df (shifrid,tabno,nal_code, fio, w_r,
                                 summaadd, summapod, summaws,
                                 summaadd1,summaadd2,summaadd3,
                                 summapod1,summapod2,summapod3,
                                 summaws1 ,summaws2 ,summaws3 ,
                                 datapri,datauw,code_priz,priznak,
                                 ozn_pilg,invalid,y,m) values (
                                 :shifrid,:tabno,:nal_code, :fio, :w_r,
                                 :summaadd1+:summaadd2+:summaadd3,
                                 :summapod1+:summapod2+:summapod3,
                                 :summaws1 +:summaws2 +:summaws3 ,
                                 :summaadd1,:summaadd2,:summaadd3,
                                 :summapod1,:summapod2,:summapod3,
                                 :summaws1 ,:summaws3 ,:summaws3 ,
                                 :data_pri,:data_uw,:code_priz,:priznak,
                                 :ozn_pilg,:invalid,:y, :m);

             insert into tb_1df_add (SHIFRID1DF,tabno, w_place,w_r,
                                            shifrgru,shifrkat,shifrsta,
                                            month_za,year_za,month_vy,year_vy,
                                            summa, fond,vypl)
                           select :shifrid,person.tabno, person.w_place,person.w_r,
                                  person.shifrgru,person.shifrkat,fadd.shifrsta,
                                  fadd.month_za,fadd.year_za,person.monthvy,person.yearvy,
                                  fadd.summa, fadd.fond,fadd.vypl from fadd
                                  join person on person.shifrid=fadd.shifridperson
                                  where fadd.tabno=:tabno
                                  and person.yearvy=:y
                                  and person.w_place not in (106)
                         --         and ((select first 1 retval from pr_is_dogpod(fadd.w_place))=0)
                                  and fadd.shifrsta=32
                                  and person.monthvy in (:m1, :m2, :m3);
             i=0;
             while (I<3) do
              begin
                    i=i+1;
                    currm=case
                              when i=1 then m1
                              when i=2 then m2
                              when i=3 then m3
                          end;

                    select sum(tb_1df_add.summa) from tb_1df_add
                           where tb_1df_add.shifrid1df=:shifrid
                           and tb_1df_add.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaadd1=summaadd;
                    else if (i=2) then summaadd2=summaadd;
                    else summaadd3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=50
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summapod1=summaadd;
                    else if (i=2) then summapod2=summaadd;
                    else summapod3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           and tb_1df_ud.shifrsta=161
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaws1=summaadd;
                    else if (i=2) then summaws2=summaadd;
                    else summaws3=summaadd;
              end
             select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (126,126+500)   -- разряд
                                         order by fcn.prim desc
                                         into :Razrjad;
             Razrjad=coalesce(razrjad, 0);
             if (ozn_pilg<1) then
             if (not (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (129,129+500)  -- не учитывать льготы

                ))) then
             if (Razrjad>5) then
                begin
                     i=0;
                     if (tabno=10023) then
                        i=0;
                     while (i<3) do
                       begin
                            i=i+1;
                            ms=(currkw-1)*3+i;
                            dt=y||'-'||ms||'-01';
                            select first 1 limitlgoty from podohtbl
                                   where datefr<:dt
                                   order by datefr desc
                                   into limlgsumma;

                            limlgsumma=coalesce(limlgsumma,0);
                            r=case
                                  when i=1 then summaadd1
                                  when i=2 then summaadd2
                                  else summaadd3
                              end;
                            select first 1 oklad from person
                                         where tabno = :tabno
                                         and yearvy  = :y
                                         and monthvy = :ms
                                         order by oklad desc
                                         into :oklad;
                            oklad=coalesce(oklad,0);
                            r=limlgsumma-r;
                            if ((r>0.01) and (oklad<limlgsumma)) then
                                ozn_pilg=1;
                       end
                end
              if (w_r<>1) then ozn_pilg=0;
              update tb_1df 
                     set summaadd=:summaadd1+:summaadd2+:summaadd3,
                         summapod=:summapod1+:summapod2+:summapod3,
                         summaws =:summaws1 +:summaws2 +:summaws3 ,
                         summaadd1=:summaadd1,
                         summaadd2=:summaadd2,
                         summaadd3=:summaadd3,
                         summapod1=:summapod1,
                         summapod2=:summapod2,
                         summapod3=:summapod3,
                         summaws1 =:summaws1 ,
                         summaws2 =:summaws2 ,
                         summaws3 =:summaws3 ,
                         ozn_pilg =:ozn_pilg
                     where shifrid=:shifrid;
        END


      -- execute procedure pr_1df_mk_dogpod(:y,:m);

   select count(*) from tb_1df where y=:y and m=:m into Retval;

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_1DF_MK_DOGPOD (
    Y INTEGER,
    M INTEGER)
AS
declare variable CURRKW integer;
declare variable TABNO integer;
declare variable FIO varchar(100);
declare variable NAL_CODE varchar(10);
declare variable DATA_PRI date;
declare variable DATA_UW date;
declare variable SUMMAADD1 decimal(15,2);
declare variable SUMMAADD2 decimal(15,2);
declare variable SUMMAADD3 decimal(15,2);
declare variable SUMMAPOD1 decimal(15,2);
declare variable SUMMAPOD2 decimal(15,2);
declare variable SUMMAPOD3 decimal(15,2);
declare variable M1 integer;
declare variable M2 integer;
declare variable M3 integer;
declare variable I integer;
declare variable CURRM integer;
declare variable SUMMAADD decimal(15,2);
declare variable SHIFRID integer;
declare variable CODE_PRIZ integer;
declare variable PRIZNAK varchar(6);
declare variable OZN_PILG integer;
declare variable INVALID integer;
declare variable W_R integer;
declare variable DT date;
declare variable LIMLGSUMMA decimal(15,2);
declare variable R decimal(15,2);
declare variable MS integer;
declare variable OKLAD decimal(15,2);
declare variable RAZRJAD integer;
begin
    -- Договора подряда - 09 04 2014
     CURRKW= CASE
               WHEN M BETWEEN 1 AND 3 THEN 1
               WHEN M BETWEEN 4 AND 6 THEN 2
               WHEN M BETWEEN 7 AND 9 THEN 3
               else 4
             END;
     m1=(currkw-1)*3+1;
     m2=(currkw-1)*3+2;
     m3=(currkw-1)*3+3;
     code_priz=0;

     code_priz=102;
     FOR
        SELECT A.TABNO,sum(a.summa) FROM FADD A
                       JOIN PERSON B ON A.shifridperson=B.shifrid
                       join shifr c on c.shifr=a.shifrsta
                       WHERE B.yearvy=:Y
                       AND a.month_vy in (:m1,:m2,:m3)
                       AND abs(a.summa)>0.005
                       and c.podoh=1
                       and (
                           ((select first 1 retval from pr_is_dogpod(b.w_place))=1) --договора подряда
                           or (a.shifrsta=158)
                           )
                       GROUP BY 1
                   --    having abs(sum(a.summa))>0.001
         union
         select e.tabno,0 from fud d
                          join person e on d.shifridperson=e.shifrid
                          where d.shifrsta =50
                          and e.yearvy=:y
                          and e.monthvy in (:m1, :m2,:m3)
                          and (
                              ((select first 1 retval from pr_is_dogpod(e.w_place))=1)
           --                   or (exists (select * from fadd fa where fa.shifridperson=d.shifridperson and fa.shifrsta=158))
                              )
                          and not exists (select * from fadd f
                                  join shifr g on g.shifr=f.shifrsta
                                  join person h on h.shifrid=f.shifridperson
                                  where h.tabno=e.tabno
                                  and h.yearvy=:y
                                  and ((select first 1 retval from pr_is_dogpod(f.w_place))=1) --договора подряда
                                  and g.podoh=1
                                  and h.monthvy in (:m1, :m2,:m3))
                          group by 1,2
                       INTO :TABNO,summaadd
     DO
        BEGIN
             data_pri = null;
             data_uw  = null;
             fio      = null;
             nal_code = null;
             shifrid=gen_id(g_1df, 1);
             if (exists (select * from kadry where tabno=:tabno)) then
                select first 1 kadry.nal_code,kadry.fio,kadry.data_pri,kadry.data_uw
                       from kadry where kadry.tabno=:tabno
                       into :nal_code, :fio, :data_pri, :data_uw;
             else
                select first 1 person.nal_code,person.fio
                       from person where person.tabno=:tabno
                       order by yearvy,monthvy
                       into :nal_code, :fio;
             w_r=1;
             if (data_pri is not null) then
                if (not ( (extract(year from data_pri)=y) and
                         (extract(month from data_pri) in (m1,m2,m3))
                       )) then data_pri=null;
             if (data_uw is not null) then
                if (not ( (extract(year from data_uw)=y) and
                         (extract(month from data_uw) in (m1,m2,m3))
                       )) then data_uw=null;
             if (exists(select * from person where tabno=:tabno
                                             and yearvy=:y
                                             and monthvy in (:m1,:m2,:m3)
                                             and w_place in (82,121,161)
             )) then w_r=2;
             invalid=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (112,112+500)

             )) then invalid=1;
             ozn_pilg=0;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (114,114+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (147,147+500)

             )) then ozn_pilg=1;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-0.5)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=2;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and abs(abs(fcn.summa)-1.0)<0.01
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (117,117+500)

             )) then ozn_pilg=3;
             if (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (127,127+500)

             )) then ozn_pilg=4;
             ozn_pilg=coalesce(ozn_pilg, 0);
             summaadd1 = 0;
  --           SELECT sum(a.summa) FROM FADD A
  --                  JOIN PERSON B ON A.shifridperson=B.shifrid
  --                  join shifr c on c.shifr=a.shifrsta
  --                  WHERE B.yearvy=:Y
  --                    and b.tabno=:tabno
  --                    AND a.month_vy in (:m1)
  --                     AND abs(a.summa)>0.005
  --                     and c.podoh=1
  --                     and (
  --                         ((select first 1 retval from pr_is_dogpod(b.w_place))=1) --договора подряда
  --                         or (a.shifrsta=158)
  --                         )
  --              into :summaadd1;

             summaadd1=coalesce(summaadd1,0);
             summaadd2 = 0;
  --           SELECT sum(a.summa) FROM FADD A
  --                  JOIN PERSON B ON A.shifridperson=B.shifrid
  --                  join shifr c on c.shifr=a.shifrsta
  --                  WHERE B.yearvy=:Y
  --                    and b.tabno=:tabno
  --                    AND a.month_vy in (:m2)
  --                     AND abs(a.summa)>0.005
  --                     and c.podoh=1
  --                    and (
  --                         ((select first 1 retval from pr_is_dogpod(b.w_place))=1) --договора подряда
  --                         or (a.shifrsta=158)
  --                         )
  --              into :summaadd2;
             summaadd2=coalesce(summaadd2,0);
             summaadd3 = 0;
  --           SELECT sum(a.summa) FROM FADD A
  --                  JOIN PERSON B ON A.shifridperson=B.shifrid
  --                  join shifr c on c.shifr=a.shifrsta
  --                  WHERE B.yearvy=:Y
  --                   and b.tabno=:tabno
  --                    AND a.month_vy in (:m3)
  --                     AND abs(a.summa)>0.005
  --                     and c.podoh=1
  --                     and (
  --                         ((select first 1 retval from pr_is_dogpod(b.w_place))=1) --договора подряда
  --                         or (a.shifrsta=158)
  --                         )
  --              into :summaadd3;
             summaadd3=coalesce(summaadd3,0);
             summapod1 = 0;
             summapod2 = 0;
             summapod3 = 0;
             summaadd  = coalesce(summaadd1,0.00) + coalesce(summaadd2,0.00) + coalesce(summaadd3,0.00);
             nal_code  = coalesce(nal_code,'');
             insert into tb_1df (shifrid,tabno,nal_code, fio, w_r,
                                 summaadd, summapod,
                                 summaadd1,summaadd2,summaadd3,
                                 summapod1,summapod2,summapod3,
                                 datapri,datauw,code_priz,priznak,
                                 ozn_pilg,invalid,y,m) values (
                                 :shifrid,:tabno,:nal_code, :fio, :w_r,
                         --        :summaadd1+:summaadd2+:summaadd3,
                                 :summaAdd,
                                 :summapod1+:summapod2+:summapod3,
                                 :summaadd1,:summaadd3,:summaadd3,
                         --         10.00,20.00,30.00,
                                 :summapod1,:summapod3,:summapod3,
                                 :data_pri,:data_uw,:code_priz,:priznak,
                                 :ozn_pilg,:invalid,:y, :m);

             insert into tb_1df_add (SHIFRID1DF,tabno, w_place,w_r,
                                            shifrgru,shifrkat,shifrsta,
                                            month_za,year_za,month_vy,year_vy,
                                            summa, fond,vypl)
                           select :shifrid,person.tabno, person.w_place,person.w_r,
                                  person.shifrgru,person.shifrkat,fadd.shifrsta,
                                  fadd.month_za,fadd.year_za,person.monthvy,person.yearvy,
                                  fadd.summa, fadd.fond,fadd.vypl from fadd
                                  join shifr on fadd.shifrsta=shifr.shifr
                                  join person on person.shifrid=fadd.shifridperson
                                  where fadd.tabno=:tabno
                                  and person.yearvy=:y
                                  and (
                                       ((select first 1 retval from pr_is_dogpod(person.w_place))=1) --договора подряда
                                       or (fadd.shifrsta=158)
                                      )
                                  and person.monthvy in (:m1, :m2, :m3)
                                  and shifr.podoh=1;

             insert into tb_1df_ud (SHIFRID1DF, tabno,w_place,w_r, 
                                    SHIFRGRU,shifrkat,shifrsta,
                                    month_za,year_za,month_vy,year_vy,
                                    summa, vypl)
                    select :shifrid,person.tabno,person.w_place,person.w_r,
                           person.shifrgru,person.shifrkat,fud.shifrsta,
                           fud.month_za,fud.year_za,person.monthvy,person.yearvy,
                           fud.summa,fud.vypl from fud
                           join person on person.shifrid=fud.shifridperson
                           where fud.tabno=:tabno
                           and person.yearvy=:y
                           and (
                                ((select first 1 retval from pr_is_dogpod(person.w_place))=1) --договора подряда
                                or
                               (exists (select * from fadd af where af.shifridperson=fud.shifridperson and af.shifrsta=158))
                               )
                           and person.monthvy in (:m1, :m2, :m3)
                           and fud.shifrsta=50;
             i=0;
             while (I<3) do
              begin
                    i=i+1;
                    currm=case
                              when i=1 then m1
                              when i=2 then m2
                              when i=3 then m3
                          end;

                    select sum(tb_1df_add.summa) from tb_1df_add
                           where tb_1df_add.shifrid1df=:shifrid
                           and tb_1df_add.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summaadd1=summaadd;
                    else if (i=2) then summaadd2=summaadd;
                    else summaadd3=summaadd;
                    select sum(tb_1df_ud.summa) from tb_1df_ud
                           where tb_1df_ud.shifrid1df=:shifrid
                           and tb_1df_ud.month_vy = :currm
                           into :summaadd;
                    summaadd=coalesce(summaadd,0);
                    if (i=1) then summapod1=summaadd;
                    else if (i=2) then summapod2=summaadd;
                    else summapod3=summaadd;
              end

             select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (126,126+500)   -- разряд
                                         order by fcn.prim desc
                                         into :Razrjad;
             Razrjad=coalesce(razrjad, 0);
             if (ozn_pilg<1) then
             if (not (exists(select first 1 fcn.shifrid from fcn join person on fcn.shifridperson=person.shifrid
                                         where person.tabno=:tabno
                                         and person.yearvy=:y
                                         and person.monthvy in (:m1,:m2,:m3)
                                         and fcn.shifrsta in (129,129+500)  -- не учитывать льготы

                ))) then
             if (Razrjad>5) then
                begin
                     i=0;
                     if (tabno=10023) then
                        i=0;
                     while (i<3) do
                       begin
                            i=i+1;
                            ms=(currkw-1)*3+i;
                            dt=y||'-'||ms||'-01';
                            select first 1 limitlgoty from podohtbl
                                   where datefr<:dt
                                   order by datefr desc
                                   into limlgsumma;

                            limlgsumma=coalesce(limlgsumma,0);
                            r=case
                                  when i=1 then summaadd1
                                  when i=2 then summaadd2
                                  else summaadd3
                              end;
                            select first 1 oklad from person
                                         where tabno = :tabno
                                         and yearvy  = :y
                                         and monthvy = :ms
                                         order by oklad desc
                                         into :oklad;
                            oklad=coalesce(oklad,0);
                            r=limlgsumma-r;
                            if ((r>0.01) and (oklad<limlgsumma)) then
                                ozn_pilg=1;
                       end
                end
              if (w_r<>1) then ozn_pilg=0;
              ozn_pilg=0;   -- для ДП - нет льгот

              update tb_1df 
                     set
                         summaadd=:summaadd1+:summaadd2+:summaadd3,
                         summapod=:summapod1+:summapod2+:summapod3,
                         summaadd1=:summaadd1,
                         summaadd2=:summaadd2,
                         summaadd3=:summaadd3,
                         summapod1=:summapod1,
                         summapod2=:summapod2,
                         summapod3=:summapod3,
                         ozn_pilg =:ozn_pilg
                     where shifrid=:shifrid;

        END
end^


ALTER PROCEDURE PR_1DF_SWOD_UD (
    Y INTEGER,
    CURRKW INTEGER)
RETURNS (
    SHIFRGRU INTEGER,
    NAMEGRU VARCHAR(20),
    SUMMA1 DECIMAL(15,2),
    SUMMA2 DECIMAL(15,2),
    SUMMA3 DECIMAL(15,2),
    SUMMAT DECIMAL(15,2))
AS
begin
for
select a.shifrgru,b.name,
sum(case
     when :currkw=1 and a.month_vy=1 and a.year_vy=:y then a.summa
     when :currkw=2 and a.month_vy=4 and a.year_vy=:y then a.summa
     when :currkw=3 and a.month_vy=7 and a.year_vy=:y then a.summa
     when :currkw=4 and a.month_vy=10 and a.year_vy=:y then a.summa
     else 0
    end) as summma1,
sum(case
     when :currkw=1 and a.month_vy=2 and a.year_vy=:y then a.summa
     when :currkw=2 and a.month_vy=5 and a.year_vy=:y then a.summa
     when :currkw=3 and a.month_vy=8 and a.year_vy=:y then a.summa
     when :currkw=4 and a.month_vy=11 and a.year_vy=:y then a.summa
     else 0
    end) as summma2,
sum(case
     when :currkw=1 and a.month_vy=3 and a.year_vy=:y then a.summa
     when :currkw=2 and a.month_vy=6 and a.year_vy=:y then a.summa
     when :currkw=3 and a.month_vy=9 and a.year_vy=:y then a.summa
     when :currkw=4 and a.month_vy=12 and a.year_vy=:y then a.summa
     else 0
    end) as summma3,
sum(case
     when :currkw=1 and a.month_vy in (1,2,3) and a.year_vy=:y then a.summa
     when :currkw=2 and a.month_vy in (4,5,6) and a.year_vy=:y then a.summa
     when :currkw=3 and a.month_vy in (7,8,9) and a.year_vy=:y then a.summa
     when :currkw=4 and a.month_vy in (10,11,12) and a.year_vy=:y then a.summa
     else 0
    end) as summmaT
from tb_1df_ud a
join gruppy b on b.shifr=a.shifrgru
group by 1,2
into :shifrgru,:namegru,:summa1,:summa2,:summa3, :summat
do
 begin
  /* Procedure Text */
  suspend;
 end
end^


ALTER PROCEDURE PR_1DFCMPT6 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    MNTH INTEGER,
    SUMMAADD1DF DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
declare variable CURRKW integer;
declare variable M1 integer;
declare variable M2 integer;
declare variable M3 integer;
begin
     CURRKW= CASE
               WHEN M BETWEEN 1 AND 3 THEN 1
               WHEN M BETWEEN 4 AND 6 THEN 2
               WHEN M BETWEEN 7 AND 9 THEN 3
               else 4
             END;
     m1=(currkw-1)*3+1;
     m2=(currkw-1)*3+2;
     m3=(currkw-1)*3+3;
     select sum(a1.summaadd1) from tb_1df a1
            where a1.y=:y
              and a1.m=:m
            into :SUMMAADD1DF;
     SUMMAADD1DF=coalesce(SUMMAADD1DF,0);
     select sum(b1.sum_total) from tb_e04t06c b1
            where b1.yearvy=:y
              and b1.monthvy=:m1
            into :summaaddt6;
     SUMMAADDT6=coalesce(SUMMAADDT6,0);
     mnth=m1;
     suspend;
     select sum(a2.summaadd2) from tb_1df a2
            where a2.y=:y
              and a2.m=:m
            into :SUMMAADD1DF;
     SUMMAADD1DF=coalesce(SUMMAADD1DF,0);
     select sum(b2.sum_total) from tb_e04t06c b2
            where b2.yearvy=:y
              and b2.monthvy=:m2
            into :summaaddt6;
     SUMMAADDT6=coalesce(SUMMAADDT6,0);
     mnth=m2;
     suspend;
     select sum(a3.summaadd3) from tb_1df a3
            where a3.y=:y
              and a3.m=:m
            into :SUMMAADD1DF;
     SUMMAADD1DF=coalesce(SUMMAADD1DF,0);
     select sum(b3.sum_total) from tb_e04t06c b3
            where b3.yearvy=:y
              and b3.monthvy=:m3
            into :summaaddt6;
     SUMMAADDT6=coalesce(SUMMAADDT6,0);
     mnth=m3;
     suspend;


end^


ALTER PROCEDURE PR_1DFCMPT6PERSON (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    SUMMAADDSWOD DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
declare variable SHIFRIDSWOD integer;
begin
     shifridswod=null;
     select first 1 sh.shifrid from tb_swody_hat sh
            where sh.yearvy=:y
              and sh.monthvy=:m
            order by sh.shifrid desc
            into :shifridswod;
     if (shifridswod is not null) then
     for
         select distinct tabno from tb_e04t06c a0
                where a0.yearvy=:y
                  and a0.monthvy=:m
         union
         select distinct a1.tabno from tb_swody_det_person_add a1
                where a1.shifridswod=:shifridswod
                  and a1.tabno not in (
                      select distinct tabno from tb_e04t06c a0
                         where a0.yearvy=:y
                           and a0.monthvy=:m
                      )
         into :tabno
     do
       begin
         summaaddswod=0;
         select a.summa from tb_swody_det_person_add a
             where a.tabno=:tabno
             into :summaaddswod;
         summaaddswod=coalesce(summaaddswod,0);
         summaaddt6=0;
         select sum(b.sum_total) from tb_e04t06c b
                where b.tabno=:tabno
                  and b.yearvy=:y
                  and b.monthvy=:m
                into :summaaddT6;
         summaaddt6=coalesce(summaaddt6,0);
         if (abs(summaaddswod-summaaddt6)>=0.01) then
            suspend;
       end

  /* Procedure Text */

end^


ALTER PROCEDURE PR_ADD_BOLN_TO_REE (
    SHIFRIDREE INTEGER,
    SHIFRIDBOLN INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
declare variable TABNO integer;
declare variable FIO varchar(51);
declare variable NOMER_B varchar(10);
declare variable DATEFR date;
declare variable DATETO date;
declare variable SWIDSS varchar(15);
declare variable CODEILL integer;
declare variable SHIFRIDR integer;
declare variable SUMMASS decimal(15,2);
declare variable SUMMAPSS decimal(15,2);
declare variable SUMMAESS decimal(15,2);
declare variable SUMMABASS decimal(15,2);
declare variable B_DAYSS integer;
declare variable SUMMA decimal(15,2);
declare variable B_DAY integer;
declare variable INN varchar(10);
declare variable SHIFRBUH integer;
begin
  /* Procedure Text */

      select first 1 a.tabno,a.fio,a.nomer_b,a.f_data,a.l_data,a.swidss,a.code_reason_ill,a.nal_code,a.shifrbuh  from boln a
                     where a.shifrid=:shifridboln
                     into :tabno, :fio, :nomer_b,:datefr,:dateto,:swidss,:codeill,:inn,:shifrbuh;

      if (tabno is not null) then
         begin
              delete from tb_ree_boln_det where shifridboln=:shifridboln;
              id=gen_id(g_ree_boln_det,1);
              update boln a
                    set a.shifridreb=:id
                    where a.shifrid=:shifridboln;
              for
                 select shifrid from boln_res
                        where boln_res.shifridboln=:shifridboln
                          and boln_res.shifrsta<>12
                         into :ShifrIdr
              do
                begin
                     update boln_res
                           set
                              summa_e_bud = summa_b_bud * 0.02,
                              summa_e_vne = summa_b_vne * 0.02,
                              summa_e_gn  = summa_b_gn  * 0.02,
                              summa_e_nis = summa_b_nis * 0.02
                        where shifrid=:Shifridr;
                     update boln_res
                           set
                              summa_p_bud = (summa_b_bud - summa_e_bud) * 0.15,
                              summa_p_vne = (summa_b_vne - summa_e_vne) * 0.15,
                              summa_p_gn  = (summa_b_gn  - summa_e_gn ) * 0.15,
                              summa_p_nis = (summa_b_nis - summa_e_nis) * 0.15
                        where shifrid=:Shifridr;
                     update boln_res
                           set
                              summa_ba_bud = summa_b_bud - Summa_p_bud - Summa_e_bud,
                              summa_ba_vne = summa_b_vne - Summa_p_vne - Summa_e_vne,
                              summa_ba_gn  = summa_b_gn  - Summa_p_gn  - Summa_e_gn ,
                              summa_ba_nis = summa_b_nis - Summa_p_nis - Summa_e_nis
                        where shifrid=:Shifridr;
                end


              select
                    sum(b.b_day),
                    sum(b.summa_b_bud)+sum(b.summa_b_vne)+sum(b.summa_b_gn)+sum(b.summa_b_nis) as summa_b,
                    sum(b.summa_p_bud)+sum(b.summa_p_vne)+sum(b.summa_p_gn)+sum(b.summa_p_nis) as summa_p,
                    sum(b.summa_e_bud)+sum(b.summa_e_vne)+sum(b.summa_e_gn)+sum(b.summa_e_nis) as summa_e,
                    sum(b.summa_ba_bud)+sum(b.summa_ba_vne)+sum(b.summa_ba_gn)+sum(b.summa_ba_nis) as summa_ba
                    from boln_res b
                    where b.shifridboln=:shifridboln and b.shifrsta<>12
                    into :b_dayss,:summass,:summapss, :summaess,:summabass;

              select
                    sum(b.b_day),
                    sum(b.summa_b_bud)+sum(b.summa_b_vne)+sum(b.summa_b_gn)+sum(b.summa_b_nis)
                    from boln_res b
                    where b.shifridboln=:shifridboln
                    into :b_day,:summa;


              insert into tb_ree_boln_det  (SHIFRID, SHIFRIDREE, SHIFRIDBOLN, TABNO, FIO,
                                            DATEFR , DATETO    , NMBOFDAY   , NMBOFDAYSS,
                                            summa  , SUMMASS   , SUMMAPODSS , SUMMAECBSS,
                                            SUMMABANKSS,NOMER_B, SWIDSS     , CODEILL   ,
                                            INN,SHIFRBUH)
                                     values(:id,:shifridree,:shifridboln, :tabno, :fio,
                                            :datefr,:dateto, :b_day,:b_dayss,
                                            :summa,:summass,:summapss,:summaess,
                                            :summabass,:nomer_b,:swidss,:codeill,
                                            :inn,:shifrbuh);
       end
  retval=1;
  suspend;
end^


ALTER PROCEDURE PR_ADD_FOR_SWOD (
    DATEFR DATE,
    DATETO DATE,
    SHIFRGRU INTEGER,
    NEEDPERIOD INTEGER)
RETURNS (
    LINENO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(52),
    SUMMA DECIMAL(15,2),
    PERIOD INTEGER)
AS
begin
  /* Procedure Text */
     lineno=0;
     for
        select a.shifrsta,trim(b.name)
              , case
                 when :needperiod=1 then a.month_za
                                    else 0
                end period
              ,sum(a.summa) from fadd a
               join shifr b on a.shifrsta=b.shifr
               where cast((a.year_vy||'-'||a.month_vy||'-01') as date) between :datefr and :dateto
                 and ((:shifrgru=0) or (:shifrgru=a.shifrgru))
               group by 1,2,3
               into :shifrsta,:namesta,:period, :summa
     do
     begin
          lineno=lineno+1;
          suspend;
     end
end^


ALTER PROCEDURE PR_ADD_TO_CHAIN (
    TABNO INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    W_PLACE INTEGER,
    W_R INTEGER)
AS
begin
    -- if (not exists (select * from tb_chain where
    --     tabno=:tabno and yearvy=:yearvy and monthvy=:monthvy and w_place=:w_place and w_r=:w_r)) then
         insert into tb_chain (tabno, YEARVY,MONTHVY,W_PLACE,W_R) values
                              (:tabno,:yearvy, :monthvy, :w_place,:w_r);

end^


ALTER PROCEDURE PR_BASEDL_FOR_INDEX (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(40),
    W_PLACE INTEGER)
AS
begin
      for
         select distinct a.tabno,b.fio,case
          when b.w_place=0 then a.w_place
          else b.w_place
         end
         from fcn a
         join person b on b.shifrid=a.shifridperson
         where a.shifrsta in (137,137+500)
         and b.yearvy=:y and b.monthvy=:m
         and a.prim||'-'||cast(a.summa as integer)||'-25' > (select
         max(d.datab) from tb_proc_ind_koe d)
         into :tabno,:fio,:w_place
      do
         suspend;

end^


ALTER PROCEDURE PR_BLD_OTP_TABEL (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    S VARCHAR(31))
AS
declare variable L integer;
declare variable DT date;
declare variable D integer;
declare variable ID integer;
begin
/*
   Процедура возвращает строку из 31 символа или менее, в которой символом '1'
   отмечены дни отпускных.
   Эта процедура используется при генерации данных нового месяца
   для заполнения табеля
*/
     s='';
     dt=y||'-'||m||'-01';
     select first 1 l from lenmonth(:dt) into :l;
     d = 0;
     while (d<l) do
      begin
           d  = d + 1;
           dt = y||'-'||m||'-'||d;
           id=0;
           select first 1 a.shifrid from otpuska a
                  where a.tabno=:tabno
                  and :dt>=a.f_data
                  and :dt<=a.l_data
                  and a.mode<>1       -- 2 компенсация, а не отпуск
                  into :id;
           id=coalesce(id,0);
           if (id>0) then
              s=s||'1';
           else
              s=s||'0';
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_BOLN_SWOD_LINES (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRKATB INTEGER,
    NAMEKATB VARCHAR(100),
    SHIFRBAY INTEGER,
    NAMEBAY VARCHAR(25),
    DAY_5 INTEGER,
    SUMMA_5 DECIMAL(15,2),
    DAY_O INTEGER,
    SUMMA_O DECIMAL(15,2),
    DAY_UH INTEGER,
    SUMMA_UH DECIMAL(15,2),
    DAY_DEK INTEGER,
    SUMMA_DEK DECIMAL(15,2),
    DAY_5_TOT INTEGER,
    SUMMA_5_TOT DECIMAL(15,2),
    DAY_TOT INTEGER,
    SUMMA_TOT DECIMAL(15,2))
AS
declare variable shifrbuh integer;
declare variable day_i integer;
declare variable summa_i decimal(15,2);
declare variable shifrkatboln integer;
declare variable shifr_u_k integer;
begin
  shifr_u_k=0;
  while (shifr_u_k<2) do
    begin
         shifr_u_k=shifr_u_k+1;
  shifrkatboln=0;
  while (shifrkatboln<4) do
    begin
          shifrkatboln=shifrkatboln+1;
  /* Procedure Text */
  for
     select shifrbuh from bay
            where shifrbuh not in (11,12)
            group by shifrbuh
            into :shifrbuh
  do
     begin
           select sum((select first 1 pr_get_boln_day.n_day from
           pr_get_boln_day(:shifrkatboln,boln_res.shifrid))),
                  sum(case
                           when :shifrkatboln=1 then boln_res.summa_b_bud
                           when :shifrkatboln=2 then boln_res.summa_b_vne
                           when :shifrkatboln=3 then boln_res.summa_b_gn
                           else  boln_res.summa_b_nis
                     end
                 ) from boln
                  join boln_res on boln.shifrid=boln_res.shifridboln
                  join kadry    on kadry.tabno=boln.tabno
                  where boln.year_vy=:y and boln.month_vy=:m and
                        boln.mode_ill<>10 and                      -- Командировки не учитывать
                        extract(year from boln.data_p_bud)>1991 and
                        ((boln.w_place in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)) or
                         (kadry.shifr_pod in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)))
                         and boln_res.shifrsta=12 and boln.mode_ill=0
                         and (
                              (:shifr_u_k=1 and boln.w_place not between 151 and 168 and kadry.shifr_pod not between 151 and 168) or
                              (:shifr_u_k=2 and (boln.w_place  between 151 and 168 or kadry.shifr_pod between 151 and 168))
                             )
                  into :day_i,:summa_i;
              shifrbay  = shifrbuh;
              namebay   = '';
              select first 1 operatory.fioop from operatory
                                             where operatory.shifrwrk=:shifrbuh
                                             into namebay;
              if (strlen(namebay)>3) then namebay=substr(namebay, 1,3);
              day_5     = 0;
              summa_5   = 0;
              day_o     = 0;
              summa_o   = 0;
              day_uh    = 0;
              summa_uh  = 0;
              day_dek   = 0;
              summa_dek = 0;
              day_5     = coalesce(day_i,0);
              summa_5   = coalesce(summa_i,0);
           select sum((select first 1 pr_get_boln_day.n_day from
                      pr_get_boln_day(:shifrkatboln,boln_res.shifrid))),
                  sum(case
                          when :shifrkatboln=1 then boln_res.summa_b_bud
                          when :shifrkatboln=2 then boln_res.summa_b_vne
                          when :shifrkatboln=3 then boln_res.summa_b_gn
                          else  boln_res.summa_b_nis
                      end
                 ) from boln
                  join boln_res on boln.shifrid=boln_res.shifridboln
                  join kadry    on kadry.tabno=boln.tabno
                  where boln.year_vy=:y and boln.month_vy=:m and
                        extract(year from boln.data_p_bud)>1991 and
                       ((boln.w_place in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)) or
                         (kadry.shifr_pod in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)))
                         and boln_res.shifrsta<>12 and boln.mode_ill=0
                         and (
                              (:shifr_u_k=1 and boln.w_place not between 151 and 168 and kadry.shifr_pod not between 151 and 168) or
                              (:shifr_u_k=2 and (boln.w_place  between 151 and 168 or kadry.shifr_pod between 151 and 168))
                             )
                  into :day_i,:summa_i;
              day_o     = coalesce(day_i,0);
              summa_o   = coalesce(summa_i,0);
           select sum((select first 1 pr_get_boln_day.n_day from
                      pr_get_boln_day(:shifrkatboln,boln_res.shifrid))),
                  sum(case
                          when :shifrkatboln=1 then boln_res.summa_b_bud
                          when :shifrkatboln=2 then boln_res.summa_b_vne
                          when :shifrkatboln=3 then boln_res.summa_b_gn
                          else  boln_res.summa_b_nis
                       end
                 ) from boln
                  join boln_res on boln.shifrid=boln_res.shifridboln
                  join kadry    on kadry.tabno=boln.tabno
                  where boln.year_vy=:y and boln.month_vy=:m and
                        extract(year from boln.data_p_bud)>1991 and
                        ((boln.w_place in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)) or
                         (kadry.shifr_pod in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)))
                         and boln.mode_ill=1
                         and (
                              (:shifr_u_k=1 and boln.w_place not between 151 and 168 and kadry.shifr_pod not between 151 and 168) or
                              (:shifr_u_k=2 and (boln.w_place  between 151 and 168 or kadry.shifr_pod between 151 and 168))
                             )
                  into :day_i,:summa_i;
              day_dek     = coalesce(day_i,0);
              summa_dek   = coalesce(summa_i,0);
           select sum((select first 1 pr_get_boln_day.n_day from
                      pr_get_boln_day(:shifrkatboln,boln_res.shifrid))),
                  sum(case
                          when :shifrkatboln=1 then boln_res.summa_b_bud
                          when :shifrkatboln=2 then boln_res.summa_b_vne
                          when :shifrkatboln=3 then boln_res.summa_b_gn
                          else  boln_res.summa_b_nis
                  end
                 ) from boln
                  join boln_res on boln.shifrid=boln_res.shifridboln
                  join kadry    on kadry.tabno=boln.tabno
                  where boln.year_vy=:y and boln.month_vy=:m and
                        extract(year from boln.data_p_bud)>1991 and
                        ((boln.w_place in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)) or
                         (kadry.shifr_pod in (select bay.shifrpod from bay where bay.shifrbuh=:shifrbuh)))
                         and boln.mode_ill=2
                         and (
                              (:shifr_u_k=1 and boln.w_place not between 151 and 168 and kadry.shifr_pod not between 151 and 168) or
                              (:shifr_u_k=2 and (boln.w_place  between 151 and 168 or kadry.shifr_pod between 151 and 168))
                             )
                  into :day_i,:summa_i;
              day_uh     = coalesce(day_i,0);
              summa_uh   = coalesce(summa_i,0);
              day_5_tot  = day_5;
              summa_5_tot= summa_5;
              day_tot    = coalesce(day_o,0)+coalesce(day_dek,0)+coalesce(day_uh,0);
              summa_tot  = coalesce(summa_o,0) + coalesce(summa_uh,0) + coalesce(summa_dek,0);
              namekatb=case
                        when shifr_u_k=1 then
                             case
                                 when shifrkatboln=1 then 'Бюджет'
                                 when shifrkatboln=2 then 'ВнеБюджет'
                                 when shifrkatboln=3 then 'ГН'
                                 when shifrkatboln=4 then 'НИС'
                                 else 'Неверный'
                             end
                        when shifr_u_k=2 then
                             case
                                 when shifrkatboln=1 then 'БюджетК'
                                 when shifrkatboln=2 then 'ВнеБюджетК'
                                 when shifrkatboln=3 then 'ГН-К'
                                 when shifrkatboln=4 then 'НИС-К'
                                 else 'Неверный-К'
                             end
                       end;
              shifrkatb=shifrkatboln;
              if (day_5<>0 or day_o<>0 or day_dek<>0 or day_uh<>0) then
                 suspend;
     end
   end
   end
end^


ALTER PROCEDURE PR_CALCKOEFOTP (
    WANTEDDATA DATE)
AS
declare variable OKLAD decimal(15,4);
declare variable DATEOLD date;
declare variable RAZR integer;
begin
     select max(a.datefr) from tb_razr_proc a
            where a.datefr<:wanteddata
            into :dateold;
  /* Procedure Text */
     if (extract(year from dateold)>2010) then
        for
           select a.oklad,a.razr from tb_razr_proc a
                  where a.datefr=:dateold
                        and a.razr between 1 and 25
                  order by a.razr
                  into :oklad,:razr

        do
          if (:razr between 1 and 25) then
             update tb_razr_proc a
                    set a.koef_otp=cast(a.oklad as decimal(15,4)) / :oklad
                    where a.datefr=:wanteddata and
                          a.razr=:razr;
end^


ALTER PROCEDURE PR_CANMOVEOTP (
    SHIFRIDOTP INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SUMMABUD decimal(15,2);
declare variable SUMMAVNE decimal(15,2);
declare variable SUMMAGN decimal(15,2);
declare variable SUMMANIS decimal(15,2);
declare variable DATA_PERE_BUD date;
declare variable DATA_PERE_VNE date;
declare variable DATA_PERE_GN date;
declare variable DATA_PERE_NIS date;
declare variable FLAG_BUD integer;
declare variable FLAG_VNE integer;
declare variable FLAG_GN integer;
declare variable FLAG_NIS integer;
begin
     retval=0;
     select sum(a.summa_o_bud) from otp_res a
            where a.shifridotp=:shifridotp
            into :summabud;
     summabud=coalesce(summabud,0);
     select sum(a.summa_o_vne) from otp_res a
            where a.shifridotp=:shifridotp
            into :summavne;
     summavne=coalesce(summavne,0);
     select sum(a.summa_o_gn) from otp_res a
            where a.shifridotp=:shifridotp
            into :summagn;
     summagn=coalesce(summagn,0);
     select sum(a.summa_o_nis) from otp_res a
            where a.shifridotp=:shifridotp
            into :summanis;
     summanis=coalesce(summanis,0);
     select first 1 a.data_pere_bud from otpuska a
                                    where a.shifrid=:shifridotp
                                    into :data_pere_bud;
     data_pere_bud=coalesce(data_pere_bud,'1900-01-01');
     select first 1 a.data_pere_vne from otpuska a
                                    where a.shifrid=:shifridotp
                                    into :data_pere_vne;
     data_pere_vne=coalesce(data_pere_vne,'1900-01-01');
     select first 1 a.data_pere_gn from otpuska a
                                   where a.shifrid=:shifridotp
                                   into :data_pere_gn;
     data_pere_gn=coalesce(data_pere_gn,'1900-01-01');
     select first 1 a.data_pere_nis from otpuska a
                                    where a.shifrid=:shifridotp
                                    into :data_pere_nis;
     data_pere_gn=coalesce(data_pere_nis,'1900-01-01');
     flag_bud=1;
     flag_vne=1;
     flag_gn=1;
     flag_nis=1;
     if ((summabud>0.01) and (extract(year from data_pere_bud)<2005)) then
        flag_bud=0;
     if ((summavne>0.01) and (extract(year from data_pere_vne)<2005)) then
        flag_vne=0;
     if ((summagn>0.01) and (extract(year from data_pere_gn)<2005)) then
        flag_gn=0;
     if ((summanis>0.01) and (extract(year from data_pere_nis)<2005)) then
        flag_nis=0;
     if (flag_bud=0) then retval=1;
     if (flag_vne=0) then retval=1;
     if (flag_gn=0) then retval=1;
     if (flag_nis=0) then retval=1;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_CMPINTANDCHAR (
    VAL1 INTEGER,
    VAL2 VARCHAR(32))
RETURNS (
    RETVAL INTEGER)
AS
declare variable I1 integer;
declare variable I2 integer;
declare variable S varchar(32);
declare variable I integer;
declare variable C varchar(1);
declare variable FINDED integer;
declare variable L integer;
begin
     retval=0;
     i1=coalesce(val1,0);
     s=coalesce(val2, '');
     s=ltrim(rtrim(s));
     if (strlen(s)=0) then
         suspend;
     else
         begin
              i=0;
              l=strlen(s);
              finded=0;
              while (i<l) do
                begin
                     i=i+1;
                     c=substr(s, i,i);
                     if (c not in ('0','1','2','3','4','5','6','7','8','9')) then
                        begin
                             finded=1;
                             break;
                        end
                end
              if (finded=0) then
                  begin
                        i2=cast(s as integer);
                        if (i1=i2) then
                           retval=1;
                  end
              suspend;
         end
end^


ALTER PROCEDURE PR_CR_SWOD (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    MODE1 INTEGER)
RETURNS (
    ISADD INTEGER,
    SHIFRSTA INTEGER,
    NAME VARCHAR(20),
    PERIOD INTEGER,
    SUMMA DECIMAL(15,2),
    FOND INTEGER)
AS
begin
  /* Procedure Text */
  -- mode = 0 -  не разбивать по периодам
  -- mode = 1 -  разбивать по периодам
  ---------------------------------------
  -- mode1 = 0 - свод для всех
  -- mode1 = 1 - свод для пенсионеров
  -- mode1 = 2 - свод для инвалидов
  isadd=1;
  for
     select f.shifrsta,d.shortname,
            case when :mode=0 then :m else f.month_za end,f.fond  , sum(f.summa) from fadd f
            join shifr d on f.shifrsta=d.shifr
            join person c on c.shifrid=f.shifridperson
            where c.yearvy=:y and
                  c.monthvy=:m and
                  (:mode1 =0 or
                   (exists (select first 1 b.shifrsta from fcn b
                                   join person a  on b.shifridperson=a.shifrid
                                   where
                                         c.tabno=a.tabno and
                                         a.yearvy=:y   and
                                         a.monthvy=:m  and
                                         (
                                          (:mode1=1 and b.shifrsta in (107,107+500)) or
                                          (:mode1=2 and b.shifrsta in (112,112+500))
                                         )
                           )
                   )
                  )
            group by 1,2,3,4
            into :Shifrsta,:name, :period,:fond,:summa
  do
    begin
         suspend;
    end
  isadd=2;
  for
     select u.shifrsta,d.shortname,
            case when :mode=0 then :m else u.month_za end, sum(u.summa) from fud u
            join shifr d on u.shifrsta=d.shifr
            join person c on c.shifrid=u.shifridperson
            where c.yearvy=:y and
                  c.monthvy=:m and
                  (:mode1 =0 or
                   (exists (select first 1 b.shifrsta from fcn b
                                   join person a  on b.shifridperson=a.shifrid
                                   where
                                         c.tabno=a.tabno and
                                         a.yearvy=:y   and
                                         a.monthvy=:m  and
                                         (
                                          (:mode1=1 and b.shifrsta in (107,107+500)) or
                                          (:mode1=2 and b.shifrsta in (112,112+500))
                                         )
                           )
                   )
                  )
            group by 1,2,3
            into :Shifrsta,:name, :period,:summa
  do
    begin
         suspend;
    end
end^


ALTER PROCEDURE PR_CR_TB_PREP_UWP (
    Y INTEGER)
AS
declare variable m integer;
declare variable tabno integer;
declare variable fio varchar(50);
declare variable dolg varchar(10);
declare variable summapr decimal(15,2);
declare variable summaoth decimal(15,2);
begin
     delete from tb_prep_uwp_2009;
     m=0;
     while (m<12) do
       begin
            m=m+1;
            for
               select tabno,fio,dolg,summasci,summaoth from pr_pr_and_not_pr(:y,:m)
                      into :tabno,:fio,:dolg,:summapr,:summaoth
            do
            begin
                  if (not exists (select tabno from
                      tb_prep_uwp_2009 where tabno=:tabno)) then
                    insert into tb_prep_uwp_2009 values(:tabno,:fio,:dolg,:summapr, :summaoth,2);
            end
       end
  /* Procedure Text */
 -- suspend;
end^


ALTER PROCEDURE PR_CR_TB_PREP_UWP_PERS (
    Y INTEGER,
    M INTEGER)
AS
declare variable tabno integer;
declare variable fio varchar(50);
declare variable dolg varchar(10);
declare variable summapr decimal(10,2);
declare variable summaoth decimal(10,2);
begin
     delete from tb_prep_uwp_pers_month a where a.yearvy=:y and a.monthvy=:m;
     for
        select tabno,fio,dolg,summasci,summaoth from pr_pr_and_not_pr_month(:y,:m)
               into :tabno,:fio,:dolg,:summapr,:summaoth
     do
        begin
            if (not exists (select tabno from
               tb_prep_uwp_pers_month where tabno=:tabno and yearvy=:y and monthvy=:m)) then
                    insert into tb_prep_uwp_pers_month (yearvy,monthvy,tabno,fio,dolg, summaprep,summaoth,mode)
                           values(:y, :m, :tabno,:fio,:dolg,:summapr, :summaoth,2);


       end
  /* Procedure Text */
 -- suspend;
end^


ALTER PROCEDURE PR_CR_TMP_TBLS_PERSON (
    TABNO INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    YEAR_VY INTEGER,
    MONTH_VY INTEGER)
AS
declare variable SHIFRID integer;
declare variable FIO char(30);
declare variable DOLG char(25);
declare variable W_R smallint;
declare variable SHIFRGRU smallint;
declare variable SHIFRKAT smallint;
declare variable M_O_R integer;
declare variable N_TEMY char(10);
declare variable WID_OPLATY smallint;
declare variable MODE smallint;
declare variable FROMPODR smallint;
declare variable PODOH integer;
declare variable MALO integer;
declare variable PROF smallint;
declare variable MAIN smallint;
declare variable STATE smallint;
declare variable AUTOMATIC integer;
declare variable START_DAY integer;
declare variable PENS integer;
declare variable BANK integer;
declare variable NAL_CODE char(10);
declare variable OKLAD numeric(15,2);
declare variable W_PLACE smallint;
declare variable SHIFRWRK smallint;
declare variable DATEWRK date;
declare variable RAZRJAD smallint;
declare variable NEED integer;
declare variable YEARVY integer;
declare variable MONTHVY integer;
begin
     delete from tb_tmp_person where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fadd   where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fud    where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fcn    where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_tabel  where conn_id=CURRENT_CONNECTION;
     for
        select person.ShifrId,count(fadd.shifrid),count(fud.shifrid) from person
               left outer join fadd on person.shifrid=fadd.shifridperson
               left outer join fud on person.shifrid=fud.shifridperson
               where person.tabno=:tabno and
                     (
                      ((fadd.year_za=:year_za and fadd.month_za=:month_za and
                     ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(fadd.shifrSTA))=1)
--                      fadd.shifrsta in (5,6,12,14,15,154,155,158 )
                      )
                       or
                       (fadd.year_vy=:year_za and fadd.month_vy=:month_za) or
                      (fud.year_za=:year_za and fud.month_za=:month_za)) and
                      (not (person.yearvy=:year_vy and person.monthvy=:month_vy) or :year_vy=0) or
                      (fadd.shifrid is null and fud.shifrid is null and person.yearvy=:year_za and person.monthvy=:month_za)
                     )
               group by 1
               into :shifrid,:need,:pens
     do
     begin
           select first 1 FIO       ,   DOLG    ,
                  W_R      , SHIFRGRU , SHIFRKAT  ,
                  M_O_R    , N_TEMY   , WID_OPLATY, MODE      , FROMPODR,
                  podoh    , MALO     , PROF      , MAIN      , STATE   ,
                  AUTOMATIC, START_DAY, PENS      , BANK      , NAL_CODE,
                  OKLAD    , W_PLACE  , SHIFRWRK  , DATEWRK   , RAZRJAD,
                  yearvy   , monthvy  from person
                  where ShifrId=:ShifrId
            into :FIO      , :DOLG      ,
                :W_R      , :SHIFRGRU , :SHIFRKAT  ,
                :M_O_R    , :N_TEMY   , :WID_OPLATY, :MODE      , :FROMPODR,
                :podoh    , :MALO     , :PROF      , :MAIN      , :STATE   ,
                :AUTOMATIC, :START_DAY, :PENS      , :BANK      , :NAL_CODE,
                :OKLAD    , :W_PLACE  , :SHIFRWRK  , :DATEWRK   , :RAZRJAD ,
                :yearvy   , :monthvy;
                  insert into tb_tmp_person (CONN_ID  , SHIFRID  , tabno     , FIO,        DOLG    ,
                                MONTHVY  , YEARVY   , W_R       , SHIFRGRU  , SHIFRKAT,
                                M_O_R    , N_TEMY   , WID_OPLATY, MODE      , FROMPODR,
                                podoh    , MALO     , PROF      , MAIN      , STATE   ,
                                AUTOMATIC, START_DAY, PENS      , BANK      , NAL_CODE,
                                OKLAD    , W_PLACE  , SHIFRWRK  , DATEWRK   , RAZRJAD)
                         VALUES
                           (current_connection   , :SHIFRID , :tabno     , :FIO       , :DOLG    ,
                               :MONTHVY            , :YEARVY , :W_R       , :SHIFRGRU  , :SHIFRKAT,
                               :M_O_R               , :N_TEMY  , :WID_OPLATY, :MODE      , :FROMPODR,
                               :podoh               , :MALO    , :PROF      , :MAIN      , :STATE   ,
                               :AUTOMATIC           , :START_DAY,:PENS      , :BANK      , :NAL_CODE,
                               :OKLAD               , :W_PLACE  ,:SHIFRWRK  , :DATEWRK   , :RAZRJAD);
                  insert into tb_tmp_tabel (CONN_ID,SHIFRID,DAYNO,CODE)
                         SELECT CURRENT_CONNECTION,SHIFRID,DAYNO,CODE FROM TABEL
                           WHERE TABEL.SHIFRID=:SHIFRID;
                  insert into tb_tmp_fadd (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                   W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                   year_za,MONTH_VY, YEAR_VY      ,SUMMA   , WDAY    ,
                                   WCLOCK ,FOND    , VYPL         ,sch     , shifrwrk, 
                                   datewrk,need)
                         select current_connection,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                   W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                   year_za,MONTH_VY, YEAR_VY      ,SUMMA   , WDAY    ,
                                   WCLOCK ,FOND    , VYPL         ,sch     , shifrwrk, 
                                   datewrk, 0 from fadd where fadd.shifridperson=:shifrid
                                   and (
                                       (fadd.month_za=:month_za and fadd.year_za=:year_za
                                   and ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(fadd.shifrSTA))=1)
                                   )

                                   or
                                       (fadd.month_vy=:month_za and fadd.year_vy=:year_za));
                  insert into tb_tmp_fud (CONN_ID ,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                   W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                   year_za,MONTH_VY, YEAR_VY      ,SUMMA   ,VYPL     ,
                                   sch    , shifrwrk, datewrk, need)
                    select current_connection,shifrid , SHIFRIDPERSON,tabno   , w_place  ,
                                   W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA, MONTH_ZA ,
                                   year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL     ,
                                   sch    ,shifrwrk, datewrk      ,0 from fud where fud.shifridperson=:shifrid
                                   and fud.month_za=:month_za and fud.year_za=:year_za;
                  insert into tb_tmp_fcn (CONN_ID     ,shifrid    , SHIFRIDPERSON , tabno       , w_place      ,
                                   W_R        ,shifrgru   , SHIFRKAT      , SHIFRSTA    , KOD          ,
                                   MONTH_VY   , YEAR_VY   , SUMMA         , DEJA_COUNTED, FLOW_SUMMA   ,
                                   LIMIT_SUMMA, sch       , shifrwrk      , datewrk     , prim         ,prim_1)
                      select current_connection    ,shifrid    , SHIFRIDPERSON,tabno         , w_place      ,
                                   W_R        ,shifrgru   , SHIFRKAT     ,SHIFRSTA      , kod          ,
                                   MONTH_VY   , YEAR_VY   , SUMMA        , DEJA_COUNTED , FLOW_SUMMA   ,
                                   LIMIT_SUMMA, sch       ,shifrwrk      , datewrk      , prim         , prim_1
                                   from fcn where fcn.shifridperson=:shifrid;
     end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_DATE_INC (
    ADATE DATE,
    Y SMALLINT,
    M SMALLINT,
    D SMALLINT)
RETURNS (
    OUT_DATE DATE)
AS
declare variable Y0 smallint;
declare variable M0 smallint;
declare variable D0 smallint;
declare variable MONTH_INC smallint;
begin

  if(   (:adate is null)
     or (:y is null)
     or (:m is null)
     or (:d is null)) then exit;

  y0 = extract(year from :adate) + :y;
  m0 = extract(month from :adate);
  if(:m > 0) then month_inc = 1;
  else month_inc = -1;

  while(:m <> 0) do begin
   m0 = :m0 + :month_inc;
    if(:m0 = 13) then begin m0 = 1; y0 = :y0 + 1; end
    else if(:m0 = 0) then begin m0 = 12; y0 = :y0 - 1; end
   m = :m - :month_inc;
  end
  d0 = extract(day from :adate);

  while(:out_date is null) do begin
  out_date = :y0 || '-' || :m0 || '-' || :d0;
  /* conversion error from string */
  when sqlcode -413 do d0 = :d0 - 1;
  end
   out_date = :out_date + :d;
   suspend;
end^


ALTER PROCEDURE PR_DELETE_ALL_FROM_TMP_BOLN
AS
declare variable musor integer;
begin
     delete from tmp_boln_summy          where connid=CURRENT_CONNECTION;
     delete from tmp_bolna               where connid=CURRENT_CONNECTION;
     delete from tmp_boln_res            where connid=CURRENT_CONNECTION;
     select count(*) from tmp_boln_summy where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_bolna      where connid=CURRENT_CONNECTION into :musor;
     select count(*) from tmp_boln_res   where connid=CURRENT_CONNECTION into :musor;
end^


ALTER PROCEDURE PR_DELETE_ALL_FROM_TMP_OTP
AS
declare variable musor integer;
begin
     DELETE FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION;
     DELETE FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION;
     SELECT COUNT(*) FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
     SELECT COUNT(*) FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
end^


ALTER PROCEDURE PR_DELETE_TMP_PERSON_TABLES (
    TABNO INTEGER)
AS
declare variable shifrid integer;
begin
     delete from tb_tmp_tabel  where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_person where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fadd   where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fud    where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fcn    where conn_id=CURRENT_CONNECTION;
     delete from tb_tmp_fadd   where tabno=:tabno;
     delete from tb_tmp_fud    where tabno=:tabno;
     delete from tb_tmp_fcn    where tabno=:tabno;
     for
        select tb_tmp_person.shifrid from tb_tmp_person
               where tb_tmp_person.tabno=:tabno
               into :shifrid
     do
        delete from tb_tmp_tabel  where shifrid=:ShifrId;
     delete from tb_tmp_person where tabno=:tabno;


  /* Procedure Text */
end^


ALTER PROCEDURE PR_DELETE_TMP_PERSON_TABLES_ALL
AS
begin
     delete from tb_tmp_person ;
     delete from tb_tmp_fadd   ;
     delete from tb_tmp_fud    ;
     delete from tb_tmp_fcn    ;
     delete from tb_tmp_tabel  ;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_DVV_AGE_REP_PEOPLES (
    MODE INTEGER)
RETURNS (
    CODE INTEGER,
    COMMENT VARCHAR(30),
    YOUNG DECIMAL(10,2),
    YOUNGST DECIMAL(10,2),
    MIDDLE DECIMAL(10,2),
    MIDDLEST DECIMAL(10,2),
    PENSIONER DECIMAL(10,2),
    PENSIONERST DECIMAL(10,2))
AS
begin
select
      1,
      'все',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             a.shifrwr=1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;
select
      2,
      'женщины',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             a.iswoman = 1 and
             (
             a.shifrwr  = 1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
             )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;
select
      3,
      'совместители',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )


      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;

select
      4,
      'все бюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             shifrgru=1 and
             (
             a.shifrwr=1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
             )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;
select
      5,
      'женщины бюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             a.iswoman  = 1 and
             a.shifrgru = 1 and
             (
             a.shifrwr  = 1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
             )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;
select
      6,
      'совместители бюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             shifrgru=1 and
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )


      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;

select
      7,
      'все внебюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             shifrgru<>1 and
             (
             a.shifrwr=1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
             )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;

select
      8,
      'женщины внебюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             a.iswoman  = 1 and
             a.shifrgru <> 1 and
             (
             a.shifrwr  = 1 or
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )
             )
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;

select
      9,
      'совместители внебюд',
      sum(iif(a.isyoung=1,iif(:mode=1,1,a.koef),0)) as young,
      sum(iif(a.isyoung=1 and a.isstepen=1 ,iif(:mode=1,1,a.koef),0)) as youngst,
      sum(iif(a.isyoung=0 and a.ispensioner=0,iif(:mode=1,1,a.koef),0)) as middle,
      sum(iif(a.isyoung=0 and a.ispensioner=0 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as middlest,
      sum(iif(a.ispensioner=1,iif(:mode=1,1,a.koef),0)) as pensioner,
      sum(iif(a.ispensioner=1 and a.isstepen=1,iif(:mode=1,1,a.koef),0)) as pensionerst
      from tb_dvv_rep_records a
       where
             shifrgru<>1 and
             ((a.shifrwr=2) and (not exists(select * from tb_dvv_rep_records b
                                          where b.tabno=a.tabno and b.shifrwr=1))
                                       )


  /* Procedure Text */
      into
         :code, :comment, :young,:youngst,:middle,:middlest,:pensioner,:pensionerst;
      suspend;

end^


ALTER PROCEDURE PR_DVV_AGE_REPORT_RECORDS (
    Y INTEGER,
    M INTEGER)
RETURNS (
    AMNT INTEGER)
AS
declare variable C char(1);
declare variable SHIFRKAT integer;
declare variable SHIFRPOD integer;
declare variable TABNO integer;
declare variable NAL_CODE varchar(10);
declare variable FIO varchar(30);
declare variable DOLG varchar(10);
declare variable DATABIRTH date;
declare variable ISWOMAN integer;
declare variable ISSTEP integer;
declare variable KOEF decimal(10,2);
declare variable SHIFRGRU integer;
declare variable SHIFRWR integer;
declare variable AGE integer;
declare variable ISPENSIONER integer;
declare variable ISYOUNG integer;
begin
     amnt=0;
     delete from tb_dvv_rep_records where y=:y and m=:m;
     for
        select  a.tabno,a.nal_code,(select first 1 coalesce(koef,0) from pr_get_koef_person_by_id(p.shifrid)),p.fio,p.dolg,p.shifrgru,
        (select first 1 shifrwr from pr_isosnwrbyid(p.shifrid)),
        iif(exists(select * from fcn c where c.shifridperson=p.shifrid and c.shifrsta =18),1,0),
        p.shifrkat,p.w_place
 from kadry a
                join person p on p.tabno=a.tabno
               where p.yearvy  = :y
                 and p.monthvy = :m
                 and p.w_place not in (76,79,81,82,85,86,87,89,91,98,101,102,105,106,121,140,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168)
                 and p.shifrkat in (1,3,5)
                 and p.oklad>0
                 and (select sum(f.summa) from fadd f
                                        where f.shifridperson=p.shifrid
                                          and f.shifrsta=1)>0.01
                 and char_length(trim(a.nal_code))=10
               into :tabno,:nal_code,:koef,:fio,:dolg,:shifrgru,:shifrwr,:isstep,
               :shifrkat,:shifrpod
     do
       begin
             if (koef is null) then koef=0;
             databirth=null;
             databirth=addday('1900-01-01',cast(substr(nal_code,1,5) as integer)-1);
             age=extract(year from cast(:y||'-'||:m||'-01' as date))-extract(year from databirth);
             iswoman=0;
             c='1';
             c=substr(nal_code, 9,9);
             if ( c in ('0','2','4','6','8')) then iswoman=1;
             isyoung=iif(age<35,1,0);
             ispensioner = case
                               when iswoman=1 and age>54 then 1
                               when iswoman=1 and age<55 then 0
                               when iswoman=0 and age>59 then 1
                               when iswoman=0 and age<60 then 0
                           end;
             insert into tb_dvv_rep_records(
                                            TABNO       , NAL_CODE  , FIO        , DOLG    , ISWOMAN  ,
                                            ISPENSIONER , ISYOUNG   , ISSTEPEN   , SHIFRWR , SHIFRGRU ,
                                            SHIFRPOD    , SHIFRKAT  , DATABIRTH  , AGE     , KOEF     ,
                                            Y           ,  M
                                           )
                                   values  (:tabno      , :nal_code , :fio       , :dolg   , :iswoman ,
                                            :ispensioner, :isyoung  , :isstep    , :shifrwr, :shifrgru,
                                            :shifrpod   , :shifrkat , :databirth , :age    , :koef    ,
                                            :y          , :m);
             amnt=amnt+1;
       end
   suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_E04T05_6C_DEKR (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable DATA_PRI date;
declare variable DATA_UW date;
declare variable START_D integer;
declare variable END_D integer;
declare variable NAL_CODE varchar(10);
declare variable SHIFRNF integer;
declare variable S varchar(20);
declare variable I integer;
declare variable UKR_GROMAD integer;
declare variable POL integer;
declare variable D char(1);
declare variable ROWNUM integer;
declare variable NRM_DT date;
declare variable ZO integer;
declare variable DATE1 date;
declare variable DATE2 date;
declare variable MODE_ILL integer;
declare variable ROWNUM6 integer;
declare variable KD_PTV integer;
declare variable LEN_M integer;
declare variable OTK integer;
begin

     DELETE FROM tb_e04t05c where yearvy=:y and monthvy=:m
                              and zo in (5,6);
                         --   and zo in (4,5);
     select max(a.rownum) from tb_e04t05c a
                          where a.yearvy=:y and a.monthvy=:m
                          into :rownum;
     select max(a.rownum) from tb_e04t06c a
                          where a.yearvy=:y and a.monthvy=:m
                          into :rownum6;
     rownum  = coalesce(rownum  , 0);
     rownum6 = coalesce(rownum6 , 0);
     date1=:y||'-'||:m||'-01';
     select coalesce(l,0) from lenmonth(:date1) into :len_m;
     date2=:y||'-'||:m||'-'||:len_m;
     nrm_dt   = '01-01-1990';
     ZO       = 5;
     for
           select b.tabno,b.fio,b.nal_code,b.f_data,b.l_data,coalesce(b.mode_ill,0) from boln b
                    join kadry k on b.tabno=k.tabno
                    where coalesce(b.mode_ill,0) in (1)
                    and not ((b.f_data>:date2) or (b.l_data<:date1))
                --    and b.year_vy  = :y
                --    and b.month_vy = :m
                    into :tabno,:fio,:nal_code, :data_pri,:data_uw,:mode_ill

     do
        begin
           --  if (mode_ill=1) then ZO=5;
           --                 else ZO=4;
             ZO=5;
             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from data_pri)=y)
                 and (extract(month from data_pri)=m)) then
                start_d=coalesce((extract(day from data_pri)),0);
             if ((extract(year from data_uw)=y)
                  and (extract(month from data_uw)=m)) then
                end_d=coalesce((extract(day from data_uw)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             otk=1;
             if (exists (select * from person where person.m_o_r in (82,121,161) and
                                       person.tabno=:tabno          and
                                       person.yearvy=:y             and
                                       person.monthvy=:m)) then
               otk=0;
             if ((Start_D>0) or (end_d>0))  then
                begin
                      if (Start_D>0) then
                         ZO=5;
                      else if (End_D>0) then
                         ZO=6;
                      rownum=rownum+1;
                      insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO);
                end
             rownum6=rownum6 + 1;
             kd_ptv=len_m;
             if (start_d>0) then
                kd_ptv=kd_ptv-start_d+1;
             if (end_d>0) then
                kd_ptv=kd_ptv-(len_m-end_d);
           /*
             insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , 1       , 0        , 0        ,
                                0        , 0           , 0       , 0        ,:otk   ,
                                0        , 10          , 0       , 0       , :kd_ptv  ,
                                0);
               */

        end

  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE PR_E04T05_DEKR_2019 (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable DATA_PRI date;
declare variable DATA_UW date;
declare variable START_D integer;
declare variable END_D integer;
declare variable NAL_CODE varchar(10);
declare variable SHIFRNF integer;
declare variable S varchar(20);
declare variable I integer;
declare variable UKR_GROMAD integer;
declare variable POL integer;
declare variable D char(1);
declare variable ROWNUM integer;
declare variable NRM_DT date;
declare variable ZO integer;
declare variable DATE1 date;
declare variable DATE2 date;
declare variable KIND integer;
declare variable ROWNUM6 integer;
declare variable KD_PTV integer;
declare variable LEN_M integer;
declare variable OTK integer;
declare variable DATEFR date;
declare variable DATETO date;
begin

     DELETE FROM tb_e04t05c where yearvy=:y and monthvy=:m
                              and zo in (4,5,6);
                         --   and zo in (4,5);
     select max(a.rownum) from tb_e04t05c a
                          where a.yearvy=:y and a.monthvy=:m
                          into :rownum;
     rownum  = coalesce(rownum  , 0);
     date1=:y||'-'||:m||'-01';
     select coalesce(l,0) from lenmonth(:date1) into :len_m;
     date2=:y||'-'||:m||'-'||:len_m;
     nrm_dt   = '01-01-1990';
     ZO       = 5;
     for
           select b.tabno,b.fio,b.inn,b.date_fr,b.date_to,coalesce(b.kind,4) from tb_dekr_ecb b
                    join kadry k on b.tabno=k.tabno
/*
                    where
                        (
                           ((extract(month from b.date_fr)=:m)
                        and (extract(year from b.date_fr)=:y))
                           or
                           ((extract(month from b.date_to)=:m)
                        and (extract(year from b.date_to)=:y))
                        )
*/
                    into :tabno,:fio,:nal_code, :data_pri,:data_uw,:kind

     do
        begin
           --  if (mode_ill=1) then ZO=5;
           --                 else ZO=4;
             datefr=coalesce(data_pri,'01-01-2100');
             dateto=coalesce(data_uw,'01-02-2101');
             ZO=KIND;
             if (not zo in (4,5,6)) then zo=4;
             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from data_pri)=y)
                 and (extract(month from data_pri)=m)) then
                start_d=coalesce((extract(day from data_pri)),0);
             if ((extract(year from data_uw)=y)
                  and (extract(month from data_uw)=m)) then
                end_d=coalesce((extract(day from data_uw)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             otk=1;
             if (exists (select * from person where person.m_o_r in (82,121,161) and
                                       person.tabno=:tabno          and
                                       person.yearvy=:y             and
                                       person.monthvy=:m)) then
               otk=0;
             if ((Start_D>0) or (end_d>0))  then
                begin
                      rownum=rownum+1;
                      insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO);
                end
             if (not ((date1>dateto) or (date2<datefr))) then
                begin
                     kd_ptv=len_m;
                     if (start_d>0) then
                        kd_ptv=kd_ptv-start_d+1;
                     if (end_d>0) then
                        kd_ptv=kd_ptv-(len_m-end_d);

                     insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , 1       , 0        , 0        ,
                                0        , 0           , 0       , 0        ,:otk   ,
                                0        , 10          , 0       , 0       , :kd_ptv  ,
                                0);
                 end


        end

  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE PR_E4_1_3_2013_PERSON (
    TABNO INTEGER,
    RNUM INTEGER,
    IS_N INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable M integer;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable KD_NP integer;
declare variable KD_NZP integer;
declare variable SHIFRIDP integer;
declare variable KD_PTV integer;
declare variable NRM integer;
declare variable DT date;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable L_MONTH integer;
declare variable PROC_ECB decimal(15,3);
declare variable SUMMATOT decimal(15,2);
declare variable SUMMAECBTOT decimal(15,2);
declare variable WANTEDECBSHIFR integer;
begin
/*
   Процедура перерасчета задним числом
   ЕСВ за янв-март 2013 из-за повышения з-п в апр вместо января
   Эта процедура нужна только в мае 2013 и все нигде больше не нужна
   вызывается в PR_E4N_PERSON и PR_E4_PERSON
*/
     m=0;
     if (is_n=1) then
        PROC_ECB = 0.061;
     else
        PROC_ECB = 0.036;
     summatot    = 0.00;
     summaecbtot = 0.00;
     WantedECBShifr=143;
     if (IS_N=2) then WantedECBShifr=142;
     while (m<3) do
       begin
           m=m+1;
           summa=null;
           select sum(a.summa
                + coalesce((select sum(coalesce(c.summa,0)) from  fadd c where c.shifridperson=a.shifridperson
                                and c.shifrsta in (7,8,17,16,18,22,30,37,41,42,45,47)
                                and c.year_za  = a.year_za
                                and c.month_za = a.month_za),0))
                from fadd a
                  join person p on a.shifridperson=p.shifrid
                where a.year_vy=2013
                  and a.month_vy=4
                  and a.shifrsta=1
                  and a.month_za =:m
                  and a.year_za=2013
                  and a.summa<58
                  and a.summa>0
                  and a.tabno=:tabno
                  and p.w_place not in (76,81,82,102,105,106,140,121,122)
                  and (exists (select u.summa from fud u where u.shifridperson=a.shifridperson
                             and  u.shifrsta=:WantedECBShifr
                             and u.year_vy=a.year_vy
                             and u.month_vy=a.month_vy))
                  into :summa;
           summa=coalesce(summa,0.00);
           if (summa>0.001) then
              begin
                  ukr_gromad=null;
                  select first 1 a.ukr_gromad , a.st    ,  a.numident , a.fio   ,
                                 a.nm         , a.ftn   ,  a.zo       , a.kd_np ,
                                 a.kd_nzp     , a.kd_ptv,  a.exp      , a.nrm   ,
                                 a.pay_tp     , a.otk
                                 from tb_e04t06c a
                                 where a.tabno=:tabno  and
                                       a.pay_year=2013 and
                                       a.pay_mnth=4    and
                                       (
                                         ((:is_n=1) and (a.zo in (25,32))) or
                                         ((:is_n=2) and (a.zo in (1,2)))
                                       )

                                 into
                                 :ukr_gromad  , :pol  , :nal_code , :fam   ,
                                 :nam         , :otc  , :zo       , :kd_np ,
                                 :kd_nzp      , :kd_ptv , :exp    , :nrm   ,
                                 :pay_tp      , :otk;
                  if (ukr_gromad is null) then
                      exception t case
                                       when (is_n=1) then 'не найден в научной базе т.н. '||:tabno
                                       else  'не найден в обычной базе т.н. '||:tabno
                                  end;
                  else
                     begin
                          kd_ptv      = 0;
                          rownum      = rnum+m;
                          summaecbras = summa * proc_ecb;
                          summatot    = summatot    + summa       ;
                          summaecbtot = summaecbtot + summaecbras ;
                          insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                          rownum   , ukr_gromad  , st      , numident , fio      ,
                                          nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                          pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                          exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                          nrm)
                                   values(2013     , 5           , :tabno  , 5        , 2013     ,
                                          :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                          :nam     , :otc        , :zo     , :pay_tp  , :m       ,
                                          2013     , :summa      , :summa  , :summaecbras,:otk   ,
                                          :exp     , 20          , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                         :nrm);
                     end
              end

       end
   if ((SummaTot>0.01) and (SummaEcbTot>0.01)) then
      begin
           rownum=rownum+1;
           insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                   rownum   , ukr_gromad  , st      , numident , fio      ,
                                   nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                   pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                   exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                   nrm)
                            values(2013     , 5           , :tabno  , 5        , 2013     ,
                                   :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                   :nam     , :otc        , :zo     , :pay_tp  , 4        ,
                                   2013     , -:summatot  ,-:summatot , -:summaecbtot,:otk   ,
                                   :exp     , 20          , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                   :nrm);
                     end

                        --     having <150
  /* Procedure Text */
end^


ALTER PROCEDURE PR_E4_13_CORR (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable SUMMA decimal(10,2);
declare variable MIN_SAL decimal(15,2);
declare variable SHIFRID integer;
declare variable SHIFRID1 integer;
declare variable PAY_YEAR integer;
declare variable PAY_MNTH integer;
declare variable DT date;
begin
     min_sal=1218;
     dt=y||'-'||M||'-01';

     select first 1 limproc from sslimity where sslimity.datefr<=:dt
            order by sslimity.datefr desc
            into :min_sal;

     for
        select a.tabno,a.pay_year,a.pay_mnth from tb_e04t06c a
               where a.yearvy=:y
                 and a.monthvy=:m
               group by 1,2,3
               into :tabno,:pay_year,:pay_mnth
     do
       begin
            summa=0;
            select sum(sum_total) from tb_e04t06c b
                   where b.tabno   = :tabno
                     and b.yearvy  = :y
                     and b.monthvy = :m
                     and b.pay_mnth = :pay_mnth
                     and b.pay_year = :pay_year
                     and b.pay_tp<>13
                   into :summa;
            summa=coalesce(summa,0);
            if (summa>min_sal) then
               begin
                     delete from tb_e04t06c c
                            where c.tabno   = :tabno
                              and c.yearvy  = :y
                              and c.monthvy = :m
                              and c.pay_tp  = 13;
              --      if (exists (select * from tb_e04)) then
               end

       end
            update tb_e04t06c
              set pay_tp=0
              where pay_tp=2
                and yearvy=:y
                and monthvy=:m;
            update tb_e04t06c
              set pay_tp=0,
                  sum_total = -sum_total,
                  sum_max   = -sum_max,
                  sum_ins   = -sum_ins,
                  sum_narah = -sum_narah
              where pay_tp=3
                and yearvy=:y
                and monthvy=:m;
  /*
     for
        select a.shifrid,a.tabno from tb_e04t06c a
               where a.yearvy=:y
                 and a.monthvy=:m
                 and a.pay_tp=2
               into :shifrid, :tabno
     do
       begin
            shifrid1=null;
            select first 1 d.shifrid from tb_e04t06c d
                   where d.tabno   = :tabno
                     and d.yearvy  = :y
                     and d.monthvy = :m
                     and d.pay_tp  = 0
                   into :shifrid1;
            shifrid1 = coalesce(shifrid1,0);
            if (shifrid1>0) then
               begin
                    update tb_e04t06c f
                       set f.sum_total=coalesce(f.sum_total, 0.00)+(select first 1 coalesce(g.sum_total,0.00)
                                                                           from tb_e04t06c g
                                                                           where g.shifrid=:shifrid)
                           ,
                           f.sum_ins=coalesce(f.sum_ins, 0.00)+(select first 1 coalesce(h.sum_ins,0.00)
                                                                           from tb_e04t06c h
                                                                           where h.shifrid=:shifrid)
                           ,
                           f.sum_max=coalesce(f.sum_max, 0.00)+(select first 1 coalesce(i.sum_max,0.00)
                                                                           from tb_e04t06c i
                                                                           where i.shifrid=:shifrid)
                           ,
                           f.sum_narah=coalesce(f.sum_narah, 0.00)+(select first 1 coalesce(j.sum_narah,0.00)
                                                                           from tb_e04t06c j
                                                                           where j.shifrid=:shifrid)

                       where f.shifrid=:shifrid1;
                    delete from tb_e04t06c e
                           where e.shifrid=:shifrid;
               end

       end
     for
        select a.tabno from tb_e04t06c a
               where a.yearvy=:y
                 and a.monthvy=:m
                 and a.pay_tp=2
               group by 1
               into :tabno
     do
       begin
            select first 1 z.shifrid from tb_e04t06c z
                   where z.tabno=:tabno
                   into :shifrid;
            shifrid = coalesce(shifrid,0);
            if (shifrid>0) then
               begin
                    update tb_e04t06c y
                       set y.sum_total=(select sum(coalesce(x.sum_total,0.00)) from tb_e04t06c x
                                               where x.tabno   = :tabno
                                                 and x.yearvy  = :y
                                                 and x.monthvy = :m
                                                 and x.pay_tp  = 2 )
                           ,
                           y.sum_ins=(select sum(coalesce(w.sum_ins,0.00)) from tb_e04t06c w
                                               where w.tabno   = :tabno
                                                 and w.yearvy  = :y
                                                 and w.monthvy = :m
                                                 and w.pay_tp  = 2 )
                           ,
                           y.sum_max=(select sum(coalesce(s.sum_max,0.00)) from tb_e04t06c s
                                               where s.tabno   = :tabno
                                                 and s.yearvy  = :y
                                                 and s.monthvy = :m
                                                 and s.pay_tp  = 2 )
                           ,
                           y.sum_narah=(select sum(coalesce(r.sum_narah,0.00)) from tb_e04t06c r
                                               where r.tabno   = :tabno
                                                 and r.yearvy  = :y
                                                 and r.monthvy = :m
                                                 and r.pay_tp  = 2 ),
                           y.pay_tp = 0,
                           y.pay_mnth=:m,
                           y.pay_year=:y
                       where y.shifrid=:shifrid;
                    delete from tb_e04t06c k
                     where k.tabno   = :tabno
                       and k.yearvy  = :y
                       and k.monthvy = :m
                       and k.pay_tp  = 2
                       and k.shifrid<>:shifrid;
               end

       end
  */
  /* Procedure Text */

end^


ALTER PROCEDURE PR_E4_CORRECT_AFTER_TEST (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA_MODY DECIMAL(15,2),
    SUMMA_NEED DECIMAL(15,2))
AS
declare variable SUM_TOTAL decimal(15,2);
declare variable SUM_SAL decimal(15,2);
declare variable SUMMA decimal(15,2);
declare variable YZA integer;
declare variable MZA integer;
declare variable ID integer;
declare variable SHIFR integer;
declare variable RETVAL integer;
begin
      summa_mody=0;
      summa_need=0;
      SELECT SUM_TOTAL,SUM_SAL FROM TB_TEST_e04
             where tabno=:tabno
               and abs(abs(sum_total)-abs(sum_sal))>0.01
               into :sum_total,:sum_sal;
      sum_total=coalesce(sum_total,0);
      sum_sal=coalesce(sum_sal,0);
      if (sum_sal>sum_total) then
         begin
              summa_need=sum_sal-sum_total;
              for
                 select a.summa,a.year_za,a.month_za,a.shifrsta from fadd a
                   where a.tabno=:tabno
                     and a.year_vy=:y
                     and a.month_vy=:m
                     and strlen(trim(coalesce(sch,'')))=0
                     and not exists(
                         select * from fud u
                                where u.shifridperson=a.shifridperson
                                  and u.shifrsta between 142 and 146
                                  and (
                                       (a.shifrsta not in (28,156))
                                    or (
                                       (a.shifrsta in (28,156)) and
                                       (a.month_za=u.month_za) and
                                       (a.year_za=u.year_za)

                                     )
                                  )
                     )
                     and (
                              (select s.ecb from shifr s where s.shifr=a.shifrsta)=1
                           or (select s.ecb_ill from shifr s where s.shifr=a.shifrsta)=1
                          )
                     and a.w_place not in (106,165)
                   into :summa,:yza,:mza,:shifr
              do
                 begin
                      select retval  from pr_isotherperiodecbshifr_pers(:shifr) into :retval;
                      retval=coalesce(retval,0);
                      if (retval<>1) then
                         begin
                             yza=y;
                             mza=m;
                         end
                      select first 1 c.shifrid from tb_e04t06c c
                             where c.tabno=:tabno
                               and c.yearvy=:y
                               and c.monthvy=:m
                               and c.pay_year=:yza
                               and c.pay_mnth=:mza
                             into :id;
                      if (id is not null) then
                         begin
                             update tb_e04t06c d
                                 set sum_total=sum_total+:summa
                                    where shifrid=:id;
                             summa_mody=summa_mody+summa;
                         end
                 end
         end
      suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_E4_CORRECT_NRC (
    YSRC INTEGER,
    MSRC INTEGER,
    YFR INTEGER,
    MFR INTEGER)
AS
begin
     update tb_e04t06c a
            set a.nrc=0
            where a.yearvy  = :ysrc
              and a.monthvy = :msrc
              and a.nrc<>11;

     update tb_e04t06c bb
            set bb.nrc=1
          where bb.yearvy  = :ysrc
            and bb.monthvy = :msrc
            and bb.nrc=11;

     update tb_e04t06c b
            set b.nrc=1
            where b.yearvy  = :ysrc
              and b.monthvy = :msrc
              and (
                   coalesce((select first 1 coalesce(c.nrc,0) from tb_e04t06c c
                          where c.yearvy=:yfr
                            and c.monthvy=:mfr
                            and c.tabno=b.tabno

              ),0)=1);
end^


ALTER PROCEDURE PR_E4_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable KD_NP integer;
declare variable KD_NZP integer;
declare variable SHIFRIDP integer;
declare variable KD_PTV integer;
declare variable NRM integer;
declare variable L_MONTH integer;
declare variable DT date;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable KD_VP integer;
declare variable ICOUNT integer;
declare variable SUM_DIFF decimal(10,2);
declare variable SUM_NARAH decimal(10,2);
declare variable NRC integer;
declare variable KOEF decimal(10,4);
declare variable KOEFT decimal(10,4);
declare variable SHIFRIDK integer;
declare variable MIN_SAL decimal(10,2);
declare variable W_DAY integer;
declare variable K_DAY integer;
declare variable SUMMA_OTP decimal(15,2);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0;
     Ukr_Gromad  = 1;
     pay_tp      = 0;
     pay_year    = y;
     pay_mnth    = m;
     exp         = 0;
     kd_np       = 0;
     kd_nzp      = 0;
     kd_ptv      = 0;
     nrm         = 0;
     kd_vp       = 0;
     sum_diff    = 0 ;
     sum_narah   = 0 ;
     nrc         = 0 ; -- Признак неповный рабочий час - тем которые работают < чем на ставку
     koef        = 0 ;
     min_sal     = 1378;
     k_day       = 0;
     w_day       = 0;
     dt=y||'-'||M||'-01';
     select first 1 limproc from sslimity where sslimity.datefr<=:dt
            order by sslimity.datefr desc
            into :min_sal;
     min_sal=coalesce(min_sal,1378.00);
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=1;  -- найманий працівник
     if (invalid=1) then
        zo=2;            -- інвалід
     select sum(a.summa) from fadd a
            join shifr b on a.shifrsta=b.shifr
            where a.month_vy = :m     and
                  a.year_vy  = :y     and
                  a.tabno    = :tabno and
                  b.ecb      = 1      and
                  a.sch not starting with '-'  and
                  (
                   ((select first 1 shifrwr from pr_isosnwrbyid(a.shifridperson))=1)
                     or
                     (a.w_place in (11,102))
                     or
                    ((select first 1 coalesce(oklad,0) from person p825 where p825.shifrid=a.shifridperson)<=10)
                     or
                 ((select first 1 coalesce(m_o_r,0) from person p8251 where p8251.shifrid=a.shifridperson) in (82,121))

                  )
                  and
                            --         ((select first 1 retval from pr_isotherperiodecbshifr(a.shifrsta))<>1)  and
                 ((select first 1 retval from pr_isbolnshifr(a.shifrsta))<>1) and
         --         a.shifrsta not in (12,14,15) and    -- больничные


                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
--                 not ((a.shifrsta in (28,156)) and
--                      not((a.year_za=:y) and (a.month_za=:m))
--                     ) and


                  not (((select retval from PR_ISOTHERPERIODECBSHIFR_PERS(a.shifrsta))=1) and
                      not ((a.year_za=:y) and (a.month_za=:m))
                     ) and


                  not (select first 1 retval from pr_isotpshifr(a.shifrsta))=1     -- отпускные буд мес
         --         not (a.shifrsta in (5,6,10)  and    -- отпускные буд мес
     --  с 01 01 2013 отпускные идут с кодом 10 даже за текущий м-ц            cast(('01-'||:m||'-'||:y) as date) <> cast(('01-'||a.month_za||'-'||a.year_za) as date)) and
/*
                   and
                  (
                  (exists (select first 1 g.shifrid from fud g
                                           where g.shifrsta = 142 and
                                                 g.month_vy =  :m and
                                                 g.year_vy  =  :y and
                                                 cast((:y||'-'||:m||'-01') as date) >= cast((g.year_za||'-'||g.month_za||'-01') as date) and
                                                 g.shifridperson=a.shifridperson) and
                          (
                            not exists
                                (select first 1 h.shifrid from fud h
                                         where h.shifrsta = 143 and
                                               h.month_vy =  :m and
                                               h.year_vy  =  :y and
                                               cast((:y||'-'||:m||'-01') as date) >= cast((h.year_za||'-'||h.month_za||'-01') as date) and
                                               h.shifridperson=a.shifridperson)
                          )
                  )  or
                       ((not exists (select first 1 i.shifrid from fud i
                                           where i.shifrsta in (142,143,144,145,146) and
                                                 i.month_vy =  :m and
                                                 i.year_vy  =  :y and
                                                 cast((:y||'-'||:m||'-01') as date) >= cast((i.year_za||'-'||i.month_za||'-01') as date) and
                                                 i.shifridperson=a.shifridperson))
                        and
                         ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=0))

                  )
*/
                   and
                  a.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  a.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
       --           a.w_place not in (81,140,157)  and              -- 81,140 договора подряда
              and (      -- c 22 11 2018 договора подряда
                         -- отделяются только для внешних совеместителей
                    ((select first 1 retval from pr_is_dogpod(a.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p82 where p82.shifrid=a.shifridperson)<>82)
                       )
                   )

--                  (select first 1 retval from pr_is_dogpod(a.w_place))<>1
                  and
                  ((a.shifrsta<>16) or -- перечитка нодочитка
                   (a.shifrsta=16  and a.w_place between 151 and 168))
-- 14 01 2016
/*
                  and (a.shifrkat not in (1) or
                       a.w_place between 151 and 168 or
                       a.w_place in (121)
                       )
*/
               -- 07 07 2016
               -- трудовые соглашения  совместителей со строны считать как договора подряда
     --              and not
     --              (
     --              (a.w_place=76) and (select first 1 coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
     --              )

                   /*and
------------------- Добавка от 04 04 2011 -----------------
                   ( not exists (select * from fcn g where g.shifridperson=a.shifridperson
                                                   and g.shifrsta in (100,100+500)
                                                   and g.prim in (4,1455)  ))   -- Повышение Или почасовка
*/
            into :summa;

---- отметить -------------
     update fadd  fa
      set fa.sch='--'
      where
                  fa.month_vy = :m     and
                  fa.year_vy  = :y     and
                  fa.tabno    = :tabno and
                  fa.sch not starting with '-'  and
                (
                   ((select first 1 shifrwr from pr_isosnwrbyid(fa.shifridperson))=1)
                     or
                     (fa.w_place in (11,102) )
                     or
                    ((select first 1 coalesce(oklad,0) from person p825 where p825.shifrid=fa.shifridperson)<=10)
                     or
                 ((select first 1 coalesce(m_o_r,0) from person p82511 where p82511.shifrid=fa.shifridperson) in (82,121))
                  )
                  and

                  (select first 1 fb.ecb from shifr fb where fb.shifr=fa.shifrsta) = 1      and
         --         ((select first 1 retval from pr_isotherperiodecbshifr(a.shifrsta))<>1)  and
                 ((select first 1 retval from pr_isbolnshifr(fa.shifrsta))<>1) and
         --         a.shifrsta not in (12,14,15) and    -- больничные


                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
                 not ((fa.shifrsta in (28,156)) and
                      not((fa.year_za=:y) and (fa.month_za=:m))
                     ) and


                  not (select first 1 retval from pr_isotpshifr(fa.shifrsta))=1      -- отпускные буд мес
         --         not (a.shifrsta in (5,6,10)  and    -- отпускные буд мес
     --  с 01 01 2013 отпускные идут с кодом 10 даже за текущий м-ц            cast(('01-'||:m||'-'||:y) as date) <> cast(('01-'||a.month_za||'-'||a.year_za) as date)) and
                   and
/*
                  (
                  (exists (select first 1 fg.shifrid from fud fg
                                           where fg.shifrsta = 142 and
                                                 fg.month_vy =  :m and
                                                 fg.year_vy  =  :y and
                                                 cast((:y||'-'||:m||'-01') as date) >= cast((fg.year_za||'-'||fg.month_za||'-01') as date) and
                                                 fg.shifridperson=fa.shifridperson) and
                          (
                            not exists
                                (select first 1 fh.shifrid from fud fh
                                         where fh.shifrsta = 143 and
                                               fh.month_vy =  :m and
                                               fh.year_vy  =  :y and
                                               cast((:y||'-'||:m||'-01') as date) >= cast((fh.year_za||'-'||fh.month_za||'-01') as date) and
                                               fh.shifridperson=fa.shifridperson)
                          )
                  )  or
                       ((not exists (select first 1 fi.shifrid from fud fi
                                           where fi.shifrsta in (142,143,144,145,146) and
                                                 fi.month_vy =  :m and
                                                 fi.year_vy  =  :y and
                                                 cast((:y||'-'||:m||'-01') as date) >= cast((fi.year_za||'-'||fi.month_za||'-01') as date) and
                                                 fi.shifridperson=fa.shifridperson))
                        and
                         ((select first 1 retval from pr_is_sciped(fa.shifridperson,0))=0))

                  )
                   and
*/
                  fa.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  fa.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
   --               fa.w_place not in (81,140,157)  and              -- 81,140 договора подряда
              and (      -- c 22 11 2018 договора подряда
                         -- отделяются только для внешних совеместителей
                    ((select first 1 retval from pr_is_dogpod(fa.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(fa.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p82 where p82.shifrid=fa.shifridperson)<>82)
                       )
                   )

--                  (select first 1 retval from pr_is_dogpod(fa.w_place))<>1
                  and
                  ((fa.shifrsta<>16) or -- перечитка нодочитка
                   (fa.shifrsta=16  and fa.w_place between 151 and 168))
/*
                  and (fa.shifrkat not in (1) or
                       fa.w_place between 151 and 168 or
                       fa.w_place in (121)
                       )
*/
               -- 07 07 2016
               -- трудовые соглашения  совместителей со строны считать как договора подряда
   --                and not
   --                (
   --                (fa.w_place=76) and (select first 1  coalesce(fper.m_o_r,0) from person fper where fper.shifrid=fa.shifridperson)=82
   --                )

                       ;
                   /*and
------------------- Добавка от 04 04 2011 -----------------
                   ( not exists (select * from fcn g where g.shifridperson=a.shifridperson
                                                   and g.shifrsta in (100,100+500)
                                                   and g.prim in (4,1455)  ))   -- Повышение Или почасовка
*/


----- конец отметки -------

      summaecbras=0;
/*
       --     Таблица 6                -------
     select sum(a.summa) from fud a
            where a.year_vy  = :y
              and a.month_vy = :m
              and a.year_za  = :y
              and a.sch not starting with '-'

              and ((a.month_za = :m)
                 or ((a.w_place  in (121)) and
                   (a.month_za in (select b.month_za from fud b where b.tabno=:tabno and
                                                           b.year_vy=:y   and
                                                           b.month_vy=:m  and
                                                           b.month_za<>:m and
                                                           b.shifrsta in (142) and
                                                           exists(select * from fadd c
                                                                               where c.shifridperson=b.shifridperson
                                                                                --     and c.shifrsta not in (14,15,5,6)
                                                                                     and ((select first 1 retval from pr_isotherperiodecbshifr_pers(c.shifrsta))<>1)
                                                                                     and c.month_za=b.month_za
                                                           ))))
                 )

              and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||a.month_za||'-'||a.year_za) as date)
              and a.tabno    = :tabno
              and a.shifrsta in (142)
            into :SummaECBRas;
-------------------- отметка ----------------------
     update fud fu
       set fu.sch='--'
            where fu.year_vy  = :y
              and fu.month_vy = :m
              and fu.year_za  = :y
              and fu.sch not starting with '-'

              and ((fu.month_za = :m)
                 or ((fu.w_place  in (121)) and
                   (fu.month_za in (select fb.month_za from fud fb where fb.tabno=:tabno and
                                                           fb.year_vy=:y   and
                                                           fb.month_vy=:m  and
                                                           fb.month_za<>:m and
                                                           fb.shifrsta in (142) and
                                                           exists(select * from fadd fc
                                                                               where fc.shifridperson=fb.shifridperson
                                                                                --     and c.shifrsta not in (14,15,5,6)
                                                                                     and ((select first 1 retval from pr_isotherperiodecbshifr_pers(fc.shifrsta))<>1)
                                                                                     and fc.month_za=fb.month_za
                                                           ))))
                 )

              and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||fu.month_za||'-'||fu.year_za) as date)
              and fu.tabno    = :tabno
              and fu.shifrsta in (142);

-------------------- конец отметки ----------------
*/


     summa=coalesce(summa,0);
     summaECBRas=coalesce(summaECBRas,0);
     select first 1 a.shifrid from person a
                              where a.tabno=:tabno
                                    and a.yearvy=:y
                                    and a.monthvy=:m
                                    and exists (select * from tabel t where t.shifrid=a.shifrid and t.code=7)
                              into :shifridp;
     if (shifridp>0) then
        select count(*) from tabel t where t.shifrid=:shifridp and t.code=7
                        into :kd_nzp;
     select d.wdays from tb_days d where d.yearza=:y and d.monthza=:m into :i;
     if (i>25) then
         i=25;
     if (kd_nzp>:i) then
         kd_nzp=i;

     --- Вычисление дней трудовых отношений
     dt=y||'-'||M||'-01';
     select first 1 l from lenmonth(:dt) into :l_month;
     kd_ptv=l_month;
     start_dt = null;
     end_dt   = null;
     select first 1 a.start_dt,a.end_dt from tb_e04t05c a
                    where a.tabno=:tabno and a.yearvy=:y and a.monthvy=:m
                    into :start_dt , :end_dt;
     start_dt = coalesce(start_dt,0);
     end_dt   = coalesce(end_dt,0);
     if (start_dt > kd_ptv) then start_dt = 0;
     if (end_dt   > kd_ptv) then end_dt   = 0;
     if (start_dt>0) then kd_ptv=kd_ptv-start_dt+1;
     if (end_dt>0) then kd_ptv=kd_ptv-(l_month-end_dt);
     if (kd_ptv>l_month) then kd_ptv=l_month;
     if (kd_ptv<0) then kd_ptv=l_month;
     if ((coalesce(pay_mnth,0)<>m) or (coalesce(pay_year,0)<>Y))  then
        kd_ptv=0;
     kd_ptv=coalesce(kd_ptv,0);
     if ((kd_ptv>0) and (exists(select 1 from tb_e04t06c a
                                         where a.tabno=:tabno
                                           and a.yearvy=:y
                                           and a.monthvy=:m
                                           and coalesce(a.kd_ptv,0)>0
                        ))) then
        kd_ptv=0;

     --- Конец вычисления дней трудовых отношений

     if ((abs(summa)>0.01) or (abs(summaECBRas)>0.01))  then
        begin
              rownum = rown + 1;

              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/

        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                         values(:y       , :m          , :tabno  , :m       ,   :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code,   :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  ,   :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  ,   :kd_ptv  ,
                                :nrm     , :kd_vp      , 0       ,:sum_narah,  :nrc);

  --- 08.06.2015        --------
  --- вычисление доли ставки ---
            select first 1 retval from work_day(:tabno,:dt) into w_day;
            select first 1 a.wdays from tb_days a
                   where a.yearza  = :y
                     and a.monthza = :m
                   into :k_day;
            if (k_day>25) then
                k_day=25;
            if (w_day>k_day) then
                w_day=k_day;

            if ((y=pay_year) and (m=pay_mnth) and (abs(summa)>0.01)--- and  (k_day=w_day)
                and ((not exists (select * from person pso
                                       where pso.tabno   = :tabno
                                         and pso.yearvy  = :y
                                         and pso.monthvy = :m
                                         and pso.w_place in (82)))
                     or (exists (select * from person pso
                                       where pso.tabno   = :tabno
                                         and pso.yearvy  = :y
                                         and pso.monthvy = :m
                                         and pso.w_r     = 1
                                         and pso.w_place not in (82)))
                    )
               ) then

               begin
                    koef=0;
                    for
                       select pe.shifrid from person pe
                              where pe.tabno   = :tabno
                                and pe.yearvy  = :y
                                and pe.monthvy = :m
                                and (select sum(fpe.summa) from fadd fpe
                                         where fpe.shifridperson=pe.shifrid)>0.01
                                and (select sum(fpu.summa) from fud  fpu
                                         where fpu.shifridperson = pe.shifrid
                                           /*and fpu.shifrsta=142*/)>0.01
                                and (pe.w_place not in (76,81,82,102,140))
                       into :shifridk
                    do
                      begin
                           koeft = null;
                           select first 1 fcn.summa from fcn
                                  where fcn.shifridperson=:shifridk
                                    and fcn.shifrsta in (99,99+500)
                                  into :koeft;
                           koeft = coalesce(koeft,1);
                           koef  = koef + koeft;
                      end
                   if ((koef<0.99) and (koef>0.001)) then
                            nrc=1;
                   select sum(zp.summa_razn) from tb_sv_less_min_zp zp where zp.y=:y and zp.m=:m and zp.tabno=:tabno
                          into :sum_diff;
                   sum_diff=coalesce(sum_diff,0);
                   if (abs(sum_diff)>0.01) then
                      begin
       --                     if (summa<min_sal) then
                               begin
       --                             sum_diff = min_sal-summa;
                                    pay_tp   = 13;
                               end
                      end
               end
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
  --- конец от 08.06.2015 ------
        if (pay_tp=13) then
           begin
              sum_narah=case
                             when zo in (2,32) then sum_diff*8.41 / 100.0
                             else sum_diff*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                         values(:y       , :m          , :tabno  , :m       ,   :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code,   :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  ,   :pay_mnth,
                                :pay_year, 0           , 0       , 0        ,   :otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  ,   0,             --:kd_ptv  ,
                                :nrm     , :kd_vp      , :sum_diff, :sum_narah,  :nrc);

           end


       /*
        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , lineno      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  , :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 10          , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                :nrm     , :kd_vp);
            */
        end
    pay_year = :y-1;
    pay_mnth = :m;
    if (pay_mnth<1) then
       begin
            pay_year=pay_year-1;
            pay_mnth=12;
       end

    icount   = 0;
    while (not ((pay_year=:y) and (pay_mnth=:m)))
    do
      begin
            icount=icount+1;
            if (icount>12) then
                leave;
            pay_mnth=pay_mnth+1;
            if (pay_mnth>12) then
               begin
                    pay_mnth=1;
                    pay_year=pay_year+1;
               end
   --- удержния за прошл. месяцы
/*
            select sum(u.summa) from fud u
                   where u.shifrsta=142       and
                         u.tabno=:tabno       and
                         u.year_za=:pay_year  and
                         u.month_za=:pay_mnth and
                         u.year_vy=:y         and
                         u.month_vy=:m        and
                         u.sch not starting with '-'
             -- 05.07.2015  and
             --            exists (select * from fadd a
             --                           where a.shifrsta=156
             --                             and a.shifridperson=u.shifridperson)
                   into :summaecbras;
*/
             summaecbras=coalesce(summaecbras,0);
   --- начиления за прошл. месяцы
            select sum(a.summa) from fadd a
                   where a.shifrsta in (28,156) and
                         a.year_za=:pay_year  and
                         a.month_za=:pay_mnth and
                         a.year_vy=:y         and
                         a.month_vy=:m        and
                         a.tabno=:tabno       and
                         a.sch not starting with '-' and
                         ((select retval from pr_is_sciped(a.shifridperson,0))=0)
 --                        exists(select * from fud b
 --                                      where b.shifridperson=a.shifridperson
 --                                        and b.shifrsta=142
 --                                        and b.month_za=:pay_mnth
 --                                        and b.year_za=:pay_year)
                   into :summa;
            summa=coalesce(summa,0);
            -- проверить отпускные 13 09 2015
            summa_otp=0;
            if (abs(summa)<0.01) then
               begin
                   select sum(a.summa) from fadd a
                        where
                             (select first 1 retval from pr_isotpshifr(a.shifrsta))=1 and
                             a.year_za=:pay_year and
                             a.month_za=:pay_mnth and
                             a.year_vy=:y and
                             a.month_vy=:m and
                             a.tabno=:tabno and
                             a.sch not starting with('-') and
                             ((select retval from pr_is_sciped(a.shifridperson,0))=0)
                       into :summa_otp;
                   summa_otp=coalesce(summa_otp,0);

               end

            if (
                 (abs(SummaECBRas)>0.008 or abs(summa)>0.008)
                 and
                 (abs(summa_otp)<0.01)
               )   then
            begin

--------------- Отметка ------------------
            if (abs(summa)>0.008) then
            update fadd fa
             set sch='--'
                   where fa.shifrsta in (28,156) and
                         fa.year_za=:pay_year and
                         fa.month_za=:pay_mnth and
                         fa.year_vy=:y and
                         fa.month_vy=:m and
                         fa.tabno=:tabno and
                         fa.sch not starting with '-' and
                         ((select retval from pr_is_sciped(fa.shifridperson,0))=0);

--                         exists(select * from fud fb
--                                       where fb.shifridperson=fa.shifridperson
--                                         and fb.shifrsta=142
--                                         and fb.month_za=:pay_mnth
--                                         and fb.year_za=:pay_year);
/*
            if (abs(summaecbras)>0.008) then
            update fud u
              set u.sch='--'
                   where u.shifrsta=142       and
                         u.year_za=:pay_year  and
                         u.month_za=:pay_mnth and
                         u.year_vy=:y         and
                         u.month_vy=:m        and
                         u.tabno=:tabno       and
                         u.sch not starting with '-'
        --  05.07.2015   and
        --                 exists (select * from fadd a
        --                                where a.shifrsta=156
        --                                 and a.shifridperson=u.shifridperson)
                         ;

--------------- Конец отметки ------------
*/
            pay_tp=2;
/*
            if (SummaECBRas>0) then Pay_Tp=2;
            else
               begin
                    Pay_Tp=3;
                    SummaECBRas = -SummaECBRas;
                    summa       = -Summa;
               end
*/
            if (Pay_Tp>0) then
               kd_ptv=0;
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
            insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff,sum_narah , nrc)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  , :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                :nrm     , :kd_vp      , 0       , :sum_narah    ,0 );

             end
      end

/*
    if ((y=2013) and (m=5)) then
        begin
             execute procedure pr_e4_1_3_2013_person :tabno,:rownum,2 returning_values :i;
             rownum=i;
        end
*/


end^


ALTER PROCEDURE PR_E4_SETLIMIT (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
AS
declare variable LIMIT decimal(15,2);
declare variable CURRSUMMA decimal(15,2);
declare variable SUMMA decimal(15,2);
declare variable ID integer;
begin
      select first 1 a.limitmax from sslimity a
             where a.datefr<cast(('10-'||:m||'-'||:y) as date)
             order by a.datefr desc
             into :limit;
      limit=coalesce(limit,14115.00);
      currsumma=0;
      for
         select a.shifrid, a.sum_total from tb_e04t06c a
                where a.tabno = :tabno
                and a.monthvy = :m
                and a.yearvy = :y
                and ((a.pay_year is null) or (a.pay_year=0) or (a.pay_year=:y) and
                     (a.pay_mnth is null) or (a.pay_mnth=0) or (a.pay_mnth=:m))
                order by a.lineno
                into :id,:summa
      do
        begin
              if (currsumma>limit) then
                 update tb_e04t06c
                    set sum_max=0,
                        sum_narah=0
                    where shifrid=:id;
              else
                 if (currsumma+summa>limit) then
                    update tb_e04t06c
                       set sum_max=:limit-:currsumma,
                           sum_narah=case
                                       when zo in (1,25)      then (:limit-:currsumma)*36.3 / 100.0
                                       when zo in (26)        then (:limit-:currsumma)*34.7 / 100.0
                                       when zo in (29, 36,42) then (:limit-:currsumma)*33.2 / 100.0
                                       when zo in (2,32)      then (:limit-:currsumma)*8.41 / 100.0
                                     end

                     where shifrid=:id;
              currsumma=currsumma+summa;
        end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_E4_SOWM_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable KD_NP integer;
declare variable KD_NZP integer;
declare variable SHIFRIDP integer;
declare variable KD_PTV integer;
declare variable NRM integer;
declare variable DT date;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable L_MONTH integer;
declare variable KD_VP integer;
declare variable ICOUNT integer;
declare variable SUM_DIFF decimal(10,2);
declare variable SUM_NARAH decimal(10,2);
declare variable NRC integer;
declare variable KOEF decimal(10,4);
declare variable KOEFT decimal(10,4);
declare variable SHIFRIDK integer;
declare variable W_DAY integer;
declare variable MIN_SAL decimal(10,2);
declare variable K_DAY integer;
declare variable SUMMA_OTP decimal(15,2);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0 ;
     Ukr_Gromad  = 1 ;
     pay_tp      = 0 ;
     pay_year    = y ;
     pay_mnth    = m ;
     exp         = 1 ;
     kd_np       = 0 ;
     kd_nzp      = 0 ;
     kd_ptv      = 0 ;
     nrm         = 0 ;
     kd_vp       = 0 ; -- кол дней вагитнисть  та пологи -05102013
     sum_diff    = 0 ;
     sum_narah   = 0 ;
     nrc         = 11 ; -- Признак неповный рабочий час - тем которые работают < чем на ставку
     koef        = 0 ;
     min_sal     = 1378; -- Ищменить на выборку
     w_day       = 0;
     k_day       = 0;
     dt=y||'-'||M||'-01';
     select first 1 limproc from sslimity where sslimity.datefr<=:dt
            order by sslimity.datefr desc
            into :min_sal;
     min_sal=coalesce(min_sal,1378.00);

     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             nal_code=null;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(trim(nam))=0) then nam='НЕМА';
     if (strlen(trim(otc))=0) then otc='НЕМА';
     if (strlen(trim(nal_code))>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=null;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     invalid=coalesce(invalid,0);
     ZO=1;
   --  ZO=25; -- 10 01 2011 для обычнх   научных
     if (invalid=1) then
        zo=2;
   --     zo=32; -- 10 01 2011 для инвалидов  научных
     select sum(a.summa) from fadd a
            join shifr b on a.shifrsta=b.shifr
            where a.month_vy = :m     and
                  a.year_vy  = :y     and
                  a.tabno    = :tabno and
                  b.ecb      = 1      and
                  a.sch not starting with '-' and
                  (select first 1 shifrwr from pr_isosnwrbyid(a.shifridperson))=2 and
                 ((select first 1 coalesce(oklad,0) from person p825 where p825.shifrid=a.shifridperson)>10)
                 and
                 ((select first 1 coalesce(m_o_r,0) from person p8251 where p8251.shifrid=a.shifridperson) not in (82,121))
                 and

--                  a.shifrsta not in (12,14,15) and    -- больничные
                 ((select first 1 retval from pr_isbolnshifr(a.shifrsta))<>1) and
--                  not (a.shifrsta in (5,6,10) and     -- отпускные буд мес
                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
         --        not ((a.shifrsta=156) and
                  not (((select retval from PR_ISOTHERPERIODECBSHIFR_PERS(a.shifrsta))=1) and
                      not ((a.year_za=:y) and (a.month_za=:m))
                     ) and
                  not (select first 1 retval from pr_isotpshifr(a.shifrsta))=1  and    -- отпускные буд мес
                  ((select first 1 retval from pr_is_sciped(a.shifridperson,0))<>1)
                  and
                  a.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  a.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
                  and a.w_place not in (11,79,102)         -- премии и договора в основное место работы
         ---         a.w_place not in (81,140,157)  and              -- 81,140 договора подряда
              and (      -- c 22 11 2018 договора подряда
                         -- отделяются только для внешних совеместителей
                    ((select first 1 retval from pr_is_dogpod(a.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p82 where p82.shifrid=a.shifridperson)<>82)
                       )
                   )
                  and
                  ((a.shifrsta<>16) or -- перечитка нодочитка
                   (a.shifrsta=16  and a.w_place between 151 and 168))

               -- 07 07 2016
               -- трудовые соглашения  совместителей со строны считать как договора подряда
       --            and not
       --            (
       --            (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
       --            )
--                   and a.shifrkat in (1,3,5,7)
/*
                    or
------------------- Добавка от 04 04 2011 -----------------
                   ( exists (select * from fcn g where g.shifridperson=a.shifridperson
                                                   and g.shifrsta in (100,100+500)
                                                   and g.prim in (4,1455)  ))   -- Повышение Или почасовка
*/
            into :summa;

------------------- Отметка --------------------------
     update fadd fa
      set sch='---'
            where fa.month_vy = :m     and
                  fa.year_vy  = :y     and
                  fa.tabno    = :tabno and
                  fa.sch not starting with '-' and
                  (select first 1 shifrwr from pr_isosnwrbyid(fa.shifridperson))=2 and
                  ((select first 1 coalesce(oklad,0) from person p825 where p825.shifrid=fa.shifridperson)>10)
                 and
                 ((select first 1 coalesce(m_o_r,0) from person p82511 where p82511.shifrid=fa.shifridperson) not in (82,121))
                  and
--                  a.shifrsta not in (12,14,15) and    -- больничные
                 ((select first 1 retval from pr_isbolnshifr(fa.shifrsta))<>1) and
--                  not (a.shifrsta in (5,6,10) and     -- отпускные буд мес
                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
         --        not ((a.shifrsta=156) and
                  not (((select retval from PR_ISOTHERPERIODECBSHIFR_PERS(fa.shifrsta))=1) and
                      not ((fa.year_za=:y) and (fa.month_za=:m))
                     ) and
                  not (select first 1 retval from pr_isotpshifr(fa.shifrsta))=1  and    -- отпускные буд мес
                  ((select first 1 retval from pr_is_sciped(fa.shifridperson,0))<>1)
                  and
                  fa.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  fa.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
                  and fa.w_place not in (11,79,102)         -- премии и договора в основное место работы
         ---         a.w_place not in (81,140,157)  and              -- 81,140 договора подряда
              and (      -- c 22 11 2018 договора подряда
                         -- отделяются только для внешних совеместителей
                    ((select first 1 retval from pr_is_dogpod(fa.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(fa.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p821 where p821.shifrid=fa.shifridperson)<>82)
                       )
                   )
                  and
                  ((fa.shifrsta<>16) or -- перечитка нодочитка
                   (fa.shifrsta=16  and fa.w_place between 151 and 168))
                   ;

------------------- конец отметки --------------------
     summa=coalesce(summa,0);
     summaECBRas=coalesce(summaECBRas,0);
     select first 1 a.shifrid from person a
                              where a.tabno=:tabno
                                    and a.yearvy=:y
                                    and a.monthvy=:m
                                    and exists (select * from tabel t where t.shifrid=a.shifrid and t.code=7)  --оптуск без оплаті
                              into :shifridp;
     if (shifridp>0) then
        select count(*) from tabel t where t.shifrid=:shifridp and t.code=7
                        into :kd_nzp;
     select d.wdays from tb_days d where d.yearza=:y and d.monthza=:m into :i;
     if (i>25) then
         i=25;
     if (kd_nzp>:i) then
         kd_nzp=i;

     --- Вычисление дней трудовых отношений
     dt=y||'-'||M||'-01';
     select first 1 l from lenmonth(:dt) into :l_month;
     kd_ptv=l_month;
     start_dt = null;
     end_dt   = null;
     select first 1 a.start_dt,a.end_dt from tb_e04t05c a
                    where a.tabno=:tabno and a.yearvy=:y and a.monthvy=:m
                    into :start_dt , :end_dt;
     start_dt = coalesce(start_dt,0);
     end_dt   = coalesce(end_dt,0);
     if (start_dt > kd_ptv) then start_dt = 0;
     if (end_dt   > kd_ptv) then end_dt   = 0;
     if (start_dt>0) then kd_ptv=kd_ptv-start_dt+1;
     if (end_dt>0) then kd_ptv=kd_ptv-(l_month-end_dt);
     if (kd_ptv>l_month) then kd_ptv=l_month;
     if (kd_ptv<0) then kd_ptv=l_month;
     if ((coalesce(pay_mnth,0)<>m) or (coalesce(pay_year,0)<>Y))  then
        kd_ptv=0;
     kd_ptv=coalesce(kd_ptv,0);
     if ((kd_ptv>0) and (exists(select 1 from tb_e04t06c a
                                         where a.tabno=:tabno
                                           and a.yearvy=:y
                                           and a.monthvy=:m
                                           and coalesce(a.kd_ptv,0)>0
                        ))) then
        kd_ptv=0;

     --- Конец вычисления дней трудовых отношений
     if ((abs(summa)>0.01) or (abs(summaECBRas)>0.01))  then
        begin
              rownum = rown + 1;
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                         values(:y       , :m          , :tabno  , :m       ,   :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code,   :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  ,   :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  ,   :kd_ptv  ,
                                :nrm     , :kd_vp      , 0       , :sum_narah,  :nrc);
       end
end^


ALTER PROCEDURE PR_E4_TEST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_ECB_SV DECIMAL(15,2),
    SUM_TOTAL_SV DECIMAL(15,2),
    SUM_TOTALZP_SV DECIMAL(15,2))
AS
declare variable TABNO integer;
declare variable NAL_CODE varchar(10);
declare variable FAM varchar(50);
declare variable OTC varchar(50);
declare variable NAM varchar(50);
declare variable FIO varchar(100);
declare variable I integer;
declare variable PAY_TB integer;
declare variable ZO integer;
declare variable EXP integer;
declare variable SUM_TOTAL decimal(15,2);
declare variable SUM_TOTAL_C decimal(15,2);
declare variable SUM_TOTAL_N decimal(15,2);
declare variable SUM_TOTAL_DP decimal(15,2);
declare variable SUM_TOTAL_ILL decimal(15,2);
declare variable SUM_MAX decimal(15,2);
declare variable SUM_INS decimal(15,2);
declare variable SUM_INS_ILL decimal(15,2);
declare variable SUM_INS_C decimal(15,2);
declare variable SUM_INS_N decimal(15,2);
declare variable SUM_INS_DP decimal(15,2);
declare variable SUM_ILL decimal(15,2);
declare variable SUM_ILL_5 decimal(15,2);
declare variable SUM_ILL_SS decimal(15,2);
declare variable SUM_ECB decimal(15,2);
declare variable SUM_ECB_C decimal(15,2);
declare variable SUM_ECB_N decimal(15,2);
declare variable SUM_ECB_ILL decimal(15,2);
declare variable SUM_ECB_DP decimal(15,2);
declare variable SUM_SAL decimal(15,2);
declare variable SUM_SAL_DP decimal(15,2);
declare variable SUM_SAL_C decimal(15,2);
declare variable SUM_SAL_N decimal(15,2);
declare variable PAY_TP integer;
begin
     delete from tb_test_e04;

     for
         select tabno,NUMIDENT,fio,nm,ftn,coalesce(sum_total,0),coalesce(sum_max,0),coalesce(sum_ins,0),exp,zo,pay_tp from tb_e04t06c
                where yearvy=:y and monthvy=:m
--                and tabno=7027
                into :tabno,:nal_code, :fam,:nam,:otc, :sum_total, :sum_max,:sum_ins,:exp, :zo,:pay_tp
     do
       begin
            sum_ins=coalesce(sum_ins,0);
            if (coalesce(pay_tp, 0)=3) then
               sum_ins=-sum_ins;
            fio=trim(fam)||' '||trim(nam)||' '||trim(otc);
            if (not exists (select * from tb_test_e04 where tabno=:tabno)) then
               insert into tb_test_e04 (tabno, fio, nal_code)
                 values(:tabno,:fio,:nal_code);
             SUM_TOTAL_C  =0;
             SUM_TOTAL_N  =0;
             SUM_TOTAL_DP =0;
             SUM_TOTAL_ILL=0;
             SUM_INS_ILL  =0;
             SUM_INS_C    =0;
             SUM_INS_N    =0;
             SUM_INS_DP   =0;
             if (exp=1) then
                begin
                    sum_total_n=sum_total;
                    sum_ins_n=sum_ins;
                end
             else
               if (zo=26) then
                  begin
                       sum_total_dp=sum_total;
                       sum_ins_dp=sum_ins;
                  end
             else
               if (zo=29) then
                  begin
                       sum_total_ill=sum_total;
                       sum_ins_ill=sum_ins;
                  end
             else
                begin
                     sum_total_c = sum_total;
                     sum_ins_c   = sum_ins;
                end

            update tb_test_e04 set
                      sum_total    = sum_total     + :sum_total     ,
                      sum_max      = sum_max       + :sum_max       ,
                      sum_ins      = sum_ins       + :sum_ins       ,
                      SUM_TOTAL_C  = SUM_TOTAL_C   + :sum_total_c   ,
                      SUM_TOTAL_N  = SUM_TOTAL_N   + :SUM_TOTAL_N   ,
                      SUM_TOTAL_DP = SUM_TOTAL_DP  + :SUM_TOTAL_DP  ,
                      SUM_TOTAL_ILL= SUM_TOTAL_ILL + :SUM_TOTAL_ILL ,
                      SUM_INS_ILL  = SUM_INS_ILL   + :SUM_INS_ILL   ,
                      SUM_INS_C    = SUM_INS_C     + :SUM_INS_C     ,
                      SUM_INS_N    = SUM_INS_N     + :SUM_INS_N     ,
                      SUM_INS_DP   = SUM_INS_DP    + :SUM_INS_DP
                      where tabno=:tabno;
       end


     for
         select person.tabno,person.fio,
                sum(case when (exists (select * from fud where fud.shifrsta=142 and fud.shifridperson=fadd.shifridperson)) then fadd.summa else 0 end),
                sum(case when (exists (select * from fud where fud.shifrsta=143 and fud.shifridperson=fadd.shifridperson)) then fadd.summa else 0 end),
                sum(case when (exists (select * from fud where fud.shifrsta=146 and fud.shifridperson=fadd.shifridperson)) then fadd.summa else 0 end),
                sum(case when (fadd.shifrsta=12) then fadd.summa else 0 end),
                sum(case when ((fadd.shifrsta in (13,14)) or (fadd.shifrsta=16 and fadd.w_place not between 151 and 168)) then fadd.summa else 0 end),
                sum(fadd.summa)
                from fadd
                join person on person.shifrid=fadd.shifridperson
                where person.yearvy=:y and person.monthvy=:m
                      and fadd.shifrsta not in (23,31,44)
                      and fadd.w_place not in (106,165)
--                      and person.tabno=7027
                group by 1,2
                into :tabno, :fam, :sum_sal_c,:sum_sal_n, :sum_sal_dp,
                     :sum_ill_5,:sum_ill_ss,:sum_sal

     do
       begin
            fio=trim(fam);
            if ( not exists (select * from tb_test_e04 where tabno=:tabno)) then
               insert into tb_test_e04 (tabno,fio, nal_code)
                      values(:tabno,:fio,'1111111111');
               update tb_test_e04 set
                      sum_sal    = sum_sal    + :sum_sal    ,
                      sum_sal_c  = sum_sal_c  + :sum_sal_c  ,
                      sum_sal_n  = sum_sal_n  + :sum_sal_n  ,
                      sum_sal_dp = sum_sal_dp + :sum_sal_dp ,
                      sum_ill    = sum_ill    + :sum_ill    ,
                      sum_ill_5  = sum_ill_5  + :sum_ill_5  ,
                      sum_ill_ss = sum_ill_ss + :sum_ill_ss
                      where tabno=:tabno;
       end
     for
         select person.tabno,person.fio,sum(fud.summa),
                sum(case when fud.shifrsta=142 then fud.summa else 0 end),
                sum(case when fud.shifrsta=143 then fud.summa else 0 end),
                sum(case when fud.shifrsta=145 then fud.summa else 0 end),
                sum(case when fud.shifrsta=146 then fud.summa else 0 end)
          from fud
                join person on person.shifrid=fud.shifridperson
                where person.yearvy  = :y
                 and  person.monthvy = :m
                 and shifrsta in (142,143,145,146)
--                 and person.tabno=7027
                group by 1,2
                into :tabno, :fam, :sum_ecb,:sum_ecb_c,:sum_ecb_n,:sum_ecb_ill,:sum_ecb_dp
     do
       begin
            fio=trim(fam);
            if (not exists (select * from tb_test_e04 where tabno=:tabno)) then
               insert into tb_test_e04 (tabno, fio,nal_code)
                      values(:tabno,:fio,'1111111111');
               update tb_test_e04 set
                      sum_ecb     = sum_ecb     + :sum_ecb     ,
                      sum_ecb_c   = sum_ecb_c   + :sum_ecb_c   ,
                      sum_ecb_n   = sum_ecb_n   + :sum_ecb_n   ,
                      sum_ecb_ill = sum_ecb_ill + :sum_ecb_ill ,
                      sum_ecb_dp  = sum_ecb_dp  + :sum_ecb_dp
                      where tabno=:tabno;
       end

  select sum(sum_ins),sum(sum_ecb) from tb_test_e04 into :sum_ins_sv, :sum_ecb_sv;
  select sum(sum_total),sum(sum_sal) from tb_test_e04 into :sum_total_sv, :sum_totalzp_sv;
  /* Procedure Text */
   suspend;
end^


ALTER PROCEDURE PR_E4DP_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable YZA integer;
declare variable MZA integer;
declare variable SUMMATOT decimal(15,2);
declare variable SUMMATOTUD decimal(15,2);
declare variable SUMMATOTUDOTH decimal(15,2);
declare variable SUMMATOTOTH decimal(15,2);
declare variable SUM_NARAH decimal(10,2);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0;
     Ukr_Gromad  = 1;
     pay_tp      = 0;
     pay_year    = y;
     pay_mnth    = m;
     exp         = 0;
     sum_narah   = 0;
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=26;
   --  if (invalid=1) then
   --     zo=2;
     select sum(a.summa) from fadd a
               where a.tabno    = :tabno
                 and a.year_vy  = :y
                 and a.month_vy = :m
                 and a.sch not starting with '-'
                 and
                 (
                  ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                  or
                   (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
                 )
               into :summatot;
     select sum(a.summa) from fadd a
               where a.tabno    = :tabno
                 and a.year_vy  = :y
                 and a.month_vy = :m
                 and a.sch not starting with '-'
                 and not (a.year_za  = :y      -- др дата - не текущая
                      and a.month_za = :m)
                 and (
                      ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                      or
                   (a.w_place=76) and (select first 1  coalesce(fper.m_o_r,0) from person fper where fper.shifrid=a.shifridperson)=82

                 )
               into :summatototh;
     select sum(a.summa) from fud a
               where a.tabno    = :tabno
                 and a.year_vy  = :y
                 and a.month_vy = :m
                 and a.sch not starting with '-'
                 and a.shifrsta = 146
                 and (
                   ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                   or
                   (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82


                 )
               into :summatotud;
     select sum(a.summa) from fud a
               where a.tabno    = :tabno
                 and a.year_vy  = :y
                 and a.month_vy = :m
                 and a.sch not starting with '-'
                 and not (a.year_za  = :y
                      and a.month_za = :m)
                 and a.shifrsta=146
                 and (
                      ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                      or
                   (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82

                 )
               into :summatotudoth;
     for
        select coalesce(a.year_za,0),coalesce(a.month_za,0) from fadd a
               where a.tabno    = :tabno
                 and a.year_vy  = :y
                 and a.month_vy = :m
                 and a.sch not starting with '-'
                 and (
                      ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                      or
                   (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
                 )
               group by 1,2
               into :yza, :mza

     do
       begin
            select sum(a.summa) from fadd a
                   join shifr b on a.shifrsta=b.shifr
                   where a.tabno    = :tabno and
                         a.month_vy = :m     and
                         a.year_vy  = :y     and
                         a.month_za = :mza   and
                         a.sch not starting with '-' and
                         a.year_za  = :yza   and
                         (
                           ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                           or
                          (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
                         )

            into :summa;

------------ Отметка -------------------
            update fadd fa
             set sch='------'
                   where fa.tabno    = :tabno and
                         fa.month_vy = :m     and
                         fa.year_vy  = :y     and
                         fa.month_za = :mza   and
                         fa.year_za  = :yza   and
                         fa.sch not starting with '-'  and
                         (
                           ((select first 1 retval from pr_is_dogpod(fa.w_place))=1)
                           or
                          (fa.w_place=76) and (select first 1  coalesce(fper.m_o_r,0) from person fper where fper.shifrid=fa.shifridperson)=82
                         );
------------ Конец отметки -------------


       --     Таблица 6                -------
            select sum(a.summa) from fud a
                   where a.tabno    = :tabno
                     and a.year_vy  = :y
                     and a.month_vy = :m
                     and a.year_za  = :yza
                     and a.month_za = :mza
                     and a.sch not starting with '-'
                     and  (
                          ((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                           or
                          (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
                     )

                     and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||a.month_za||'-'||a.year_za) as date)
                     and a.shifrsta in (146)
                   into :SummaECBRas;
----------------- Отметка ------------------------
            update fud fu
              set sch='------'
                   where fu.tabno    = :tabno
                     and fu.year_vy  = :y
                     and fu.month_vy = :m
                     and fu.year_za  = :yza
                     and fu.month_za = :mza
                     and fu.sch not starting with '-'
                     and (
                        ((select first 1 retval from pr_is_dogpod(fu.w_place))=1)
                           or
                         (fu.w_place=76) and (select first 1  coalesce(fper.m_o_r,0) from person fper where fper.shifrid=fu.shifridperson)=82

                     )
                     and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||fu.month_za||'-'||fu.year_za) as date)
                     and fu.shifrsta in (146);
----------------- Конец отметки ------------------
            -- Проверить если был взят общий налог то разделить - его
             if ((Summatotud>0.01) and (summa>0.01)) then
                if (not ((y=yza) and (m=mza))) then
                   begin
                        if (abs(summaecbras)<0.01) then
                           select summaecb from ecbdp_common(:tabno,:yza, :mza, :summa) into :summaecbras;
                   end
                else
                   if (
                       (abs(SummaTotUdOth)<0.01) and
                       (abs(SummaTotUd)>0.01)
                      ) then
                        SummaEcbRas= SummaTotUd-coalesce((select summaecb from ecbdp_common(:tabno,:y, :m, :summatototh)),0);




            -- конец проверки


            pay_mnth=mza;
            pay_year=yza;
            summa=coalesce(summa,0);
            summaECBRas=coalesce(summaECBRas,0);
            if ((abs(summa)>0.001) or (abs(summaECBRas)>0.001))  then
               begin
                    rownum = rown + 1;
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
                    insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , lineno      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff,sum_narah,nrc)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  , :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 30          , 0       , 0        , 0        ,
                                0        , 0           , 0       , :sum_narah , 0 );
              end

        end


end^


ALTER PROCEDURE PR_E4ILL_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable BASELN integer;
declare variable KD_NP integer;
declare variable KD_NZP integer;
declare variable L integer;
declare variable DT date;
declare variable MODE_DAY_CLOCK integer;
declare variable KD_NPC integer;
declare variable KD_PTV integer;
declare variable NRM integer;
declare variable ICOUNT integer;
declare variable SUM_NARAH decimal(10,4);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0;
     Ukr_Gromad  = 1;
     pay_tp      = 0;
     pay_year    = y;
     pay_mnth    = m;
     exp         = 0;
     kd_np       = 0;
     kd_nzp      = 0;
     kd_ptv      = 0;
     nrm         = 0;
     sum_narah   = 0;
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=29;    -- листи непрацездатності
 --     ZO=0;    -- листи непрацездатності
     if (invalid=1) then  -- с 10 01 2012
        zo=36;             --   этот код для больничных инвалидов
     baseln=40;
    pay_year = :y-1;
    pay_mnth = :m;
    icount   = 0;
 --   while (not ((pay_year=:y) and (pay_mnth=:m))) do
    while (icount<18) do
      begin
          icount=icount+1;
          if (icount>18) then
             leave;
          pay_mnth=pay_mnth+1;
          if (pay_mnth>12) then
             begin
                  pay_mnth=1;
                  pay_year=pay_year+1;
             end
             select sum(a.summa) from fadd a
                    join shifr b on a.shifrsta=b.shifr
              where a.month_vy = :m     and
                    a.year_vy  = :y     and
                    a.year_za  = :pay_year and
                    a.month_za = :pay_mnth and
                    a.tabno    = :tabno and
                    a.sch not starting with'-' and
                    b.ecb_ill   = 1      and
                 --   a.shifrsta in (12,14,15) and    -- больничные
                    ((select first 1 retval from pr_isbolnshifr(a.shifrsta))=1) and
                    a.shifrsta not in (31,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                               -- внесено в кассу
                    a.w_place not in (106,165) and                -- 106 материальная помощь подразделение пособие до 3-х лет
                    ((a.shifrsta<>16) or
                     (a.shifrsta=16  and a.w_place not between 151 and 168))
                   into :summa;
                 summa=coalesce(summa,0);
-------------- Отметка --------------------------------
             if (abs(summa)>0.01) then
             update fadd fa
                set sch='----'
              where fa.month_vy = :m     and
                    fa.year_vy  = :y     and
                    fa.year_za  = :pay_year and
                    fa.month_za = :pay_mnth and
                    fa.tabno    = :tabno and
                    fa.sch not starting with '-' and
                    ((select fb.ecb_ill from shifr fb where fb.shifr=fa.shifrsta)  = 1)      and
                 --   a.shifrsta in (12,14,15) and    -- больничные
                    ((select first 1 retval from pr_isbolnshifr(fa.shifrsta))=1) and
                    fa.shifrsta not in (31,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                               -- внесено в кассу
                    fa.w_place not in (106,165) and                -- 106 материальная помощь подразделение пособие до 3-х лет
                    ((fa.shifrsta<>16) or
                     (fa.shifrsta=16  and fa.w_place not between 151 and 168));

-------------- Конец отметки --------------------------
       --     Таблица 6                -------
            select sum(a.summa) from fud a
                   where a.year_vy  = :y
                   and a.month_vy = :m
                   and a.sch not starting with '-'
                   and a.year_za  = :pay_year
                   and a.month_za = :pay_mnth
                   and a.tabno    = :tabno
                   and a.shifrsta in (145)
              into :SummaECBRas;
            summaecbras=coalesce(summaecbras,0);
------------- Отметка --------------------
          if (abs(summaecbras)>0.01) then
           update fud fu2
              set sch='----'
                   where fu2.year_vy  = :y
                   and fu2.month_vy = :m
                   and fu2.sch not starting with '-'
                   and fu2.year_za  = :pay_year
                   and fu2.month_za = :pay_mnth
                   and fu2.tabno    = :tabno
                   and fu2.shifrsta in (145);
------------- Конец отметки --------------

            kd_np  = 0;
            kd_nzp = 0;
            dt     = pay_year||'-'||pay_mnth||'-01';
            for
                select a.mode_day_clock,sum(b.b_day)  from boln a
                       join boln_res b on a.shifrid=b.shifridboln
                       where a.tabno   = :tabno
                         and :pay_year = b.year_za
                         and :pay_mnth = b.month_za
                       group by 1
                       into :mode_day_clock,:kd_npc
            do
              begin
                   mode_day_clock=coalesce(mode_day_clock,0);
                   if (mode_day_clock=1) then kd_npc=kd_npc/8;
                   kd_np=kd_np+kd_npc;
              end

            select first 1 a.l from lenmonth(:dt) a into :l;
            if (kd_np>l) then kd_np=l;
            ZO=29;    -- листи непрацездатності
            if (invalid=1) then  -- с 10 01 2012
               zo=36;             --   этот код для больничных инвалидов
            -- Проверка декретных больничных --
            -- изменения от 14 08 2013
            if (exists(select * from fadd w where w.tabno=:tabno
                                              and w.shifrsta=32
                                              and w.year_za  = :pay_year
                                              and w.month_za = :pay_mnth
                                              and w.year_vy  = :y
                                              and w.month_vy = :m)) then
               begin
                    ZO=42;
                    if (invalid=1) then
                       ZO=43;
               end
            -- конец изменеий
            if ((abs(summa)>0.001) or (abs(summaECBRas)>0.001))  then
               begin
                    rownum = rown + 1;
                    baseln=baseln+1;
                    sum_narah=case
                                  when zo in (2,32) then summa*22.00 / 100.0
                                  else summa*22.00 / 100.0
                              end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
                    insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                            rownum   , ukr_gromad  , st      , numident , fio      ,
                                            nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                            pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                            exp      , lineno      , kd_np   , kd_nzp   , kd_ptv   ,
                                            nrm      , kd_vp       , sum_diff,sum_narah, nrc)
                                     values(:y       , :m          , :tabno  , :m       , :y       ,
                                            :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                            :nam     , :otc        , :zo     , 0        , :pay_mnth,
                                            :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                            :exp     , :baseln     , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                            :nrm     , 0           , 0       , :sum_narah , 0 );
               end
        end

end^


ALTER PROCEDURE PR_E4N_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable KD_NP integer;
declare variable KD_NZP integer;
declare variable SHIFRIDP integer;
declare variable KD_PTV integer;
declare variable NRM integer;
declare variable DT date;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable L_MONTH integer;
declare variable KD_VP integer;
declare variable ICOUNT integer;
declare variable SUM_DIFF decimal(10,2);
declare variable SUM_NARAH decimal(10,2);
declare variable NRC integer;
declare variable KOEF decimal(10,4);
declare variable KOEFT decimal(10,4);
declare variable SHIFRIDK integer;
declare variable W_DAY integer;
declare variable MIN_SAL decimal(10,2);
declare variable K_DAY integer;
declare variable SUMMA_OTP decimal(15,2);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0 ;
     Ukr_Gromad  = 1 ;
     pay_tp      = 0 ;
     pay_year    = y ;
     pay_mnth    = m ;
     exp         = 1 ;
     kd_np       = 0 ;
     kd_nzp      = 0 ;
     kd_ptv      = 0 ;
     nrm         = 0 ;
     kd_vp       = 0 ; -- кол дней вагитнисть  та пологи -05102013
     sum_diff    = 0 ;
     sum_narah   = 0 ;
     nrc         = 0 ; -- Признак неповный рабочий час - тем которые работают < чем на ставку
     koef        = 0 ;
     min_sal     = 1378; -- Ищменить на выборку
     w_day       = 0;
     k_day       = 0;
     dt=y||'-'||M||'-01';
     select first 1 limproc from sslimity where sslimity.datefr<=:dt
            order by sslimity.datefr desc
            into :min_sal;
     min_sal=coalesce(min_sal,1378.00);

     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             nal_code=null;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(trim(nam))=0) then nam='НЕМА';
     if (strlen(trim(otc))=0) then otc='НЕМА';
     if (strlen(trim(nal_code))>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=null;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     invalid=coalesce(invalid,0);
   --  ZO=1;
     ZO=25; -- 10 01 2011 для обычнх
     if (invalid=1) then
   --     zo=2;
        zo=32; -- 10 01 2011 для инвалидов
     select sum(a.summa) from fadd a
            join shifr b on a.shifrsta=b.shifr
            where a.month_vy = :m     and
                  a.year_vy  = :y     and
                  a.tabno    = :tabno and
                  b.ecb      = 1      and
                  a.sch not starting with '-' and
--                  a.shifrsta not in (12,14,15) and    -- больничные
                 ((select first 1 retval from pr_isbolnshifr(a.shifrsta))<>1) and
--                  not (a.shifrsta in (5,6,10) and     -- отпускные буд мес
                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
         --        not ((a.shifrsta=156) and
                  not (((select retval from PR_ISOTHERPERIODECBSHIFR_PERS(a.shifrsta))=1) and
                      not ((a.year_za=:y) and (a.month_za=:m))
                     ) and




                  not (select first 1 retval from pr_isotpshifr(a.shifrsta))=1  and    -- отпускные буд мес

       --    отпускные теперь с 01 01 2013 идут с кодом 10 в люб случае        cast(('01-'||:m||'-'||:y) as date) <> cast(('01-'||a.month_za||'-'||a.year_za) as date)) and

          /*        (exists (select first 1 * from fud c
                                           where c.shifrsta=143 and
                                                 c.month_vy=:m  and
                                                 c.year_vy=:y and
                                                 cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||c.month_za||'-'||c.year_za) as date) and
                                                 c.shifridperson=a.shifridperson) or
                     (a.shifrkat in (1) and
                      (a.w_place not between 151 and 168) and
                      (a.w_place not in (121))))
                                               and
             */

                  ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=1)
                  and
                  a.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  a.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
         ---         a.w_place not in (81,140,157)  and              -- 81,140 договора подряда
              and (      -- c 22 11 2018 договора подряда
                         -- отделяются только для внешних совеместителей
                    ((select first 1 retval from pr_is_dogpod(a.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(a.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p82 where p82.shifrid=a.shifridperson)<>82)
                       )
                   )
                  and
                  ((a.shifrsta<>16) or -- перечитка нодочитка
                   (a.shifrsta=16  and a.w_place between 151 and 168))

               -- 07 07 2016
               -- трудовые соглашения  совместителей со строны считать как договора подряда
       --            and not
       --            (
       --            (a.w_place=76) and (select first 1  coalesce(per.m_o_r,0) from person per where per.shifrid=a.shifridperson)=82
       --            )
--                   and a.shifrkat in (1,3,5,7)
/*
                    or
------------------- Добавка от 04 04 2011 -----------------
                   ( exists (select * from fcn g where g.shifridperson=a.shifridperson
                                                   and g.shifrsta in (100,100+500)
                                                   and g.prim in (4,1455)  ))   -- Повышение Или почасовка
*/
            into :summa;

------------------- Отметка --------------------------
     update fadd fa
      set sch='---'
            where fa.month_vy = :m     and
                  fa.year_vy  = :y     and
                  fa.tabno    = :tabno and
                  fa.sch not starting with '-' and
                  (select fb.ecb from shifr fb where fb.shifr=fa.shifrsta) = 1      and
--                  a.shifrsta not in (12,14,15) and    -- больничные
                 ((select first 1 retval from pr_isbolnshifr(fa.shifrsta))<>1) and
--                  not (a.shifrsta in (5,6,10) and     -- отпускные буд мес
                 -- 07 04 2013 статья 156 перерасчет за прошлые периоды
            --     not ((fa.shifrsta=156) and
                 not  (((select retval from pr_isotherperiodecbshifr_pers(fa.shifrsta))=1) and
                      not ((fa.year_za=:y) and (fa.month_za=:m))
                     ) and




                  not (select first 1 retval from pr_isotpshifr(fa.shifrsta))=1  and    -- отпускные буд мес

       --    отпускные теперь с 01 01 2013 идут с кодом 10 в люб случае        cast(('01-'||:m||'-'||:y) as date) <> cast(('01-'||a.month_za||'-'||a.year_za) as date)) and

          /*        (exists (select first 1 * from fud c
                                           where c.shifrsta=143 and
                                                 c.month_vy=:m  and
                                                 c.year_vy=:y and
                                                 cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||c.month_za||'-'||c.year_za) as date) and
                                                 c.shifridperson=a.shifridperson) or
                     (a.shifrkat in (1) and
                      (a.w_place not between 151 and 168) and
                      (a.w_place not in (121))))
                                               and
             */

                  ((select first 1 retval from pr_is_sciped(fa.shifridperson,0))=1)
                  and
                  fa.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                              -- внесено в кассу
                  fa.w_place not in (106,165)               -- 106 материальная помощь подразделение пособие до 3-х лет
        --          fa.w_place not in (81,140,157)  and              -- 81,140 договора подряда
                 and  (    -- с 22 11 2018 договора подряда отделяются
                           -- только для внешних совместителей
                    ((select first 1 retval from pr_is_dogpod(fa.w_place))<>1)
                     or
                      (((select first 1 retval from pr_is_dogpod(fa.w_place))=1)
                        and
                        ((select first 1 coalesce(m_o_r,0) from person p82 where p82.shifrid=fa.shifridperson)<>82)
                       )
                   )


--                  (select first 1 retval from pr_is_dogpod(fa.w_place))<>1
                  and
                  ((fa.shifrsta<>16) or -- перечитка нодочитка
                   (fa.shifrsta=16  and fa.w_place between 151 and 168))

               -- 07 07 2016
               -- трудовые соглашения  совместителей со строны считать как договора подряда
         --          and not
         --          (
         --          (fa.w_place=76) and (select first 1 coalesce(fper.m_o_r,0) from person fper where fper.shifrid=fa.shifridperson)=82
         --          )


                   ;

------------------- конец отметки --------------------
-- удержания отключены 13-03-2016
if (1=0) then
   begin
       --     Таблица 6                -------
     select sum(a.summa) from fud a
            where a.year_vy  = :y
              and a.month_vy = :m
              and a.year_za  = :y
              and a.sch not starting with '-'
              and ((a.month_za = :m)
                 or ((a.w_place  in (121)) and
                   (a.month_za in (select b.month_za from fud b where b.tabno=:tabno and
                                                           b.year_vy=:y   and
                                                           b.month_vy=:m  and
                                                           b.month_za<>:m and
                                                           b.shifrsta in (143)
                               -- 05.07.2015             and
                               --                            exists(select * from fadd c
                               --                                                where c.shifridperson=b.shifridperson
                               --                                              --        and c.shifrsta not in (14,15,5,6)
                               --                                                     and ((select first 1 retval from pr_isotherperiodecbshifr(c.shifrsta))<>1)
                               --                                                      and c.month_za=b.month_za
                               --                            )
                                                           )))
                 )
              and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||a.month_za||'-'||a.year_za) as date)
              and a.tabno    = :tabno
              and a.shifrsta in (143)
            into :SummaECBRas;

--------------- Отметка ----------------------
     update fud fu
      set sch='---'
            where fu.year_vy  = :y
              and fu.month_vy = :m
              and fu.year_za  = :y
              and fu.sch not starting with '-'
              and ((fu.month_za = :m)
                 or ((fu.w_place  in (121)) and
                   (fu.month_za in (select fb.month_za from fud fb where fb.tabno=:tabno and
                                                           fb.year_vy=:y   and
                                                           fb.month_vy=:m  and
                                                           fb.month_za<>:m and
                                                           fb.shifrsta in (143)
                  --   05.07.2015                          and
                  --                                         exists(select * from fadd fc
                  --                                                             where fc.shifridperson=fb.shifridperson
                  --                                                           --        and c.shifrsta not in (14,15,5,6)
                  --                                                                   and ((select first 1 retval from pr_isotherperiodecbshifr(fc.shifrsta))<>1)
                  --                                                                   and fc.month_za=fb.month_za
                  --                                         )
                                                           )))
                 )
              and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||fu.month_za||'-'||fu.year_za) as date)
              and fu.tabno    = :tabno
              and fu.shifrsta in (143);

--------------- Конец отметки ----------------
 end    -- конец отключения
     summa=coalesce(summa,0);
     summaECBRas=coalesce(summaECBRas,0);
     select first 1 a.shifrid from person a
                              where a.tabno=:tabno
                                    and a.yearvy=:y
                                    and a.monthvy=:m
                                    and exists (select * from tabel t where t.shifrid=a.shifrid and t.code=7)  --оптуск без оплаті
                              into :shifridp;
     if (shifridp>0) then
        select count(*) from tabel t where t.shifrid=:shifridp and t.code=7
                        into :kd_nzp;
     select d.wdays from tb_days d where d.yearza=:y and d.monthza=:m into :i;
     if (i>25) then
         i=25;
     if (kd_nzp>:i) then
         kd_nzp=i;

     --- Вычисление дней трудовых отношений
     dt=y||'-'||M||'-01';
     select first 1 l from lenmonth(:dt) into :l_month;
     kd_ptv=l_month;
     start_dt = null;
     end_dt   = null;
     select first 1 a.start_dt,a.end_dt from tb_e04t05c a
                    where a.tabno=:tabno and a.yearvy=:y and a.monthvy=:m
                    into :start_dt , :end_dt;
     start_dt = coalesce(start_dt,0);
     end_dt   = coalesce(end_dt,0);
     if (start_dt > kd_ptv) then start_dt = 0;
     if (end_dt   > kd_ptv) then end_dt   = 0;
     if (start_dt>0) then kd_ptv=kd_ptv-start_dt+1;
     if (end_dt>0) then kd_ptv=kd_ptv-(l_month-end_dt);
     if (kd_ptv>l_month) then kd_ptv=l_month;
     if (kd_ptv<0) then kd_ptv=l_month;
     if ((coalesce(pay_mnth,0)<>m) or (coalesce(pay_year,0)<>Y))  then
        kd_ptv=0;
     kd_ptv=coalesce(kd_ptv,0);
     if ((kd_ptv>0) and (exists(select 1 from tb_e04t06c a
                                         where a.tabno=:tabno
                                           and a.yearvy=:y
                                           and a.monthvy=:m
                                           and coalesce(a.kd_ptv,0)>0
                        ))) then
        kd_ptv=0;

     --- Конец вычисления дней трудовых отношений
     if ((abs(summa)>0.01) or (abs(summaECBRas)>0.01))  then
        begin
              rownum = rown + 1;
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*22 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                         values(:y       , :m          , :tabno  , :m       ,   :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code,   :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  ,   :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  ,   :kd_ptv  ,
                                :nrm     , :kd_vp      , 0       , :sum_narah,  :nrc);

  --- 08.06.2015        --------
  --- вычисление доли ставки ---
            select first 1 retval from work_day(:tabno,:dt) into w_day;
            select first 1 a.wdays from tb_days a
                   where a.yearza  = :y
                     and a.monthza = :m
                   into :k_day;
            if (k_day>25) then
                k_day=25;
            if (w_day>k_day) then
                w_day=k_day;

            if ((y=pay_year) and (m=pay_mnth) and (abs(summa)>0.01) --and  (k_day=w_day)
                and ((not exists (select * from person pso
                                       where pso.tabno   = :tabno
                                         and pso.yearvy  = :y
                                         and pso.monthvy = :m
                                         and pso.w_place in (82)))
                     or (exists (select * from person pso
                                       where pso.tabno   = :tabno
                                         and pso.yearvy  = :y
                                         and pso.monthvy = :m
                                         and pso.w_r     = 1
                                         and pso.w_place not in (82)))
                       )


               ) then
               begin

                    koef=0;
                    for
                       select pe.shifrid from person pe
                              where pe.tabno   = :tabno
                                and pe.yearvy  = :y
                                and pe.monthvy = :m
                                and (select sum(fpe.summa) from fadd fpe
                                         where fpe.shifridperson=pe.shifrid)>0.01
                                and (select sum(fpu.summa) from fud  fpu
                                         where fpu.shifridperson = pe.shifrid
                                           /*and fpu.shifrsta=143*/)>0.01
                                and (pe.w_place not in (76,81,82,102,140))
                       into :shifridk
                    do
                      begin
                           koeft = null;
                           select first 1 fcn.summa from fcn
                                  where fcn.shifridperson=:shifridk
                                    and fcn.shifrsta in (99,99+500)
                                  into :koeft;
                           koeft = coalesce(koeft,1);
                           koef  = koef + koeft;
                      end
                   if ((koef<0.99) and (koef>0.001)) then
                            nrc=1;
                   select sum(zp.summa_razn) from tb_sv_less_min_zp zp where zp.y=:y and zp.m=:m and zp.tabno=:tabno
                          into :sum_diff;
                   sum_diff=coalesce(sum_diff,0);
                   if (abs(sum_diff)>0.01) then
                      begin
--                            if (summa<min_sal) then
                               begin
--                                    sum_diff = min_sal-summa;
                                    pay_tp   = 13;
                               end
                      end
               end
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
  --- конец от 08.06.2015 ------

        if (pay_tp=13) then
           begin
              sum_narah=case
                             when zo in (2,32) then sum_diff*8.41 / 100.0
                             else sum_diff*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
        insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                         values(:y       , :m          , :tabno  , :m       ,   :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code,   :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  ,   :pay_mnth,
                                :pay_year, 0           , 0       , 0        ,   :otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  ,   0      ,   --  :kd_ptv  ,
                                :nrm     , :kd_vp      , :sum_diff,:sum_narah        ,  :nrc);
           end
        end
    pay_year = :y-1;
    pay_mnth = :m-1;
    if (pay_mnth<1) then
       begin
            pay_year=pay_year-1;
            pay_mnth=12;
       end
    icount   = 0;
    while (not ((pay_year=:y) and (pay_mnth=:m))) do
      begin
          icount=icount+1;
          if (icount>12) then
             leave;
          pay_mnth=pay_mnth+1;
          if (pay_mnth>12) then
             begin
                  pay_mnth=1;
                  pay_year=pay_year+1;
             end
/*  - отключить удержания 13-03-2016
          select sum(u.summa) from fud u
            where u.year_vy  = :y
              and u.month_vy = :m
              and u.year_za=:pay_year
              and u.month_za=:pay_mnth
              and u.tabno=:tabno
              and u.shifrsta=143
              and u.sch not starting with('-')
        --      and exists (select * from fadd a
        --                  where a.shifrsta=156
        --                  and a.shifridperson=u.shifridperson)
            into :SummaECBRas;
*/
          summaecbras=coalesce(summaecbras,0);
      --------------------
            select sum(a.summa) from fadd a
                   where a.shifrsta in (28,156) and
                         a.year_za=:pay_year and
                         a.month_za=:pay_mnth and
                         a.year_vy=:y and
                         a.month_vy=:m and
                         a.tabno=:tabno and
                         a.sch not starting with('-') and
                         ((select retval from pr_is_sciped(a.shifridperson,0))=1)
                   into :summa;
            summa=coalesce(summa,0);
            -- проверить отпускные
            summa_otp=0;
            if (abs(summa)<0.01) then
               begin
                   select sum(a.summa) from fadd a
                        where
                             (select first 1 retval from pr_isotpshifr(a.shifrsta))=1 and
                             a.year_za=:pay_year and
                             a.month_za=:pay_mnth and
                             a.year_vy=:y and
                             a.month_vy=:m and
                             a.tabno=:tabno and
                             a.sch not starting with('-') and
                             ((select retval from pr_is_sciped(a.shifridperson,0))=1)
                       into :summa_otp;
                   summa_otp=coalesce(summa_otp,0);

               end
            if (
                 (abs(SummaECBRas)>0.008 or abs(summa)>0.008)
                 and
                 (abs(summa_otp)<0.01)
               )   then
            begin
            -------------- Отметка ----------------------
            if (abs(summa)>0.008) then
            update fadd fa
              set sch='---'
                   where fa.shifrsta in (28,156) and
                         fa.year_za=:pay_year and
                         fa.month_za=:pay_mnth and
                         fa.year_vy=:y and
                         fa.month_vy=:m and
                         fa.tabno=:tabno and
                         fa.sch not starting with('-') and
                         ((select retval from pr_is_sciped(fa.shifridperson,0))=1);
/*     13-03-2016
          if (abs(summaecbras)>0.008) then
            update fud u
              set u.sch='---'
            where u.year_vy  = :y
              and u.month_vy = :m
              and u.year_za=:pay_year
              and u.month_za=:pay_mnth
              and u.shifrsta=143
              and u.tabno=:tabno
              and u.sch not starting with '-'
              and exists (select * from fadd a
                          where a.shifrsta in (28,156)
                          and a.shifridperson=u.shifridperson);

*/
-------------- конец отметки ----------------
            pay_tp = 2;
--            if (SummaECBRas>0) then Pay_Tp=2;
--            else
--               begin
--                    Pay_Tp=3;
--                    SummaECBRas = -SummaECBRas;
--                    Summa       = -Summa;
--               end
            if (Pay_Tp>0) then
               kd_ptv=0;
              sum_narah=case
                             when zo in (2,32) then summa*8.41 / 100.0
                             else summa*22.00 / 100.0
                        end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/

            insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                rownum   , ukr_gromad  , st      , numident , fio      ,
                                nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                exp      , LineNo      , kd_np   , kd_nzp   , kd_ptv   ,
                                nrm      , kd_vp       , sum_diff,sum_narah , nrc)
                         values(:y       , :m          , :tabno  , :m       , :y       ,
                                :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                :nam     , :otc        , :zo     , :pay_tp  , :pay_mnth,
                                :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                :exp     , 20          , :kd_np  , :kd_nzp  , :kd_ptv  ,
                                :nrm     , :kd_vp      , 0       , :sum_narah,0 );
            end
      end

/*
    if ((y=2013) and (m=5)) then
        begin
             execute procedure pr_e4_1_3_2013_person :tabno,:rownum,1 returning_values :i;
             rownum=i;
        end
*/

end^


ALTER PROCEDURE PR_E4OTP_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    ROWN INTEGER,
    SHIFRECB INTEGER)
RETURNS (
    ROWNUM INTEGER)
AS
declare variable SHIFRNF smallint;
declare variable SUMMA decimal(15,2);
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable OTK integer;
declare variable INVALID integer;
declare variable ZO integer;
declare variable SUMMAECBRAS decimal(15,2);
declare variable PAY_TP integer; /* режим записи */
declare variable PAY_MNTH integer;
declare variable PAY_YEAR integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable EXP integer;
declare variable POL integer;
declare variable D char(1);
declare variable UKR_GROMAD integer;
declare variable BASELN integer;
declare variable SUMMAECBFULLPREV decimal(10,2);
declare variable SUMMAECBRASO decimal(10,2);
declare variable SHIFRIDT6 integer;
declare variable SUMMATOTALPREV decimal(15,2);
declare variable SUM_NARAH decimal(10,4);
begin
    -- musor=gen_id(G_TEST,1);
     Pol         = 0;
     Ukr_Gromad  = 1;
     pay_tp      = 10;  -- Для отпускных - код 10 с 01 01 2013
     pay_year    = y;
     pay_mnth    = m;
     exp         = 0;
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u = null;
             name_u  = null;
             fath_u  = null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
             d=substr(nal_code, 9,9);
             if (d in ('1','3','5','7','9')) then
                pol = 1;   -- мужчина
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
        ukr_gromad=0;
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
                                         fcn.month_vy=:m  and
                                         fcn.year_vy=:y   and
                                         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=1;
     if (invalid=1) then
        zo=2;
--     if (((select first 1 retval from pr_is_sciped(a.shifridperson,0))=1)) then
     if (ShifrECB=143) then
        begin
             zo=25;
             if (invalid=1) then
                zo=32;
        end
     baseln=80;
     for
            select a.year_za,a.month_za from fadd a
                        where a.year_vy  = :y
                        and a.month_vy   = :m
--                        and ((a.year_vy<>a.year_za) or
--                             (a.month_vy<>a.month_za))
  -- все отпускные с кодом 10 с 01 01 2013                       and cast('01-'||a.month_za||'-'||a.year_za as date) <> cast('01-'||:m||'-'||:y as date)
                        and a.tabno      = :tabno
                        and a.sch not starting with '-'
                      --  and a.shifrsta in (5,6,10)
                        and  ((select first 1 retval  from pr_isotpshifr(a.shifrsta))=1)
                        and  (

                        (abs((select coalesce(sum(c.summa),0) from fud c
                                           where c.shifrsta=:shifrecb and
                                                 c.month_vy=:m  and
                                                 c.year_vy=:y   and
                                                 c.month_za=a.month_za  and
                                                 c.year_za=a.year_za    and
                                                 c.shifridperson=a.shifridperson))>0.01)

/*
                        exists (select first 1 * from fud c
                                           where c.shifrsta=:shifrecb and
                                                 c.month_vy=:m  and
                                                 c.year_vy=:y   and
                                                 c.month_za=a.month_za  and
                                                 c.year_za=a.year_za    and
                                                 c.shifridperson=a.shifridperson)
*/
                                                  or
                                            (
                                             (
                                              (
                                                (:shifrecb=143) and
                                                ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=1)
                                              )
                                                or
                                              (
                                                (:shifrecb=142) and
                                                ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=0)
                                              )
                                             )
--                                                and
--                                                ((select count(*) from fud fu
--                                                     where fu.shifrsta in (142,143,144,145,146) and
--                                                     fu.month_vy=:m  and
--                                                     fu.year_vy=:y   and
--                                                     fu.month_za=a.month_za  and
--                                                     fu.year_za=a.year_za    and
--                                                     fu.shifridperson=a.shifridperson)=0)
                                            )

/*                               (:shifrecb=142 and
                                           (select count(*) from fud fu
                                                     where fu.shifrsta in (142,143,144,145,146) and
                                                     fu.month_vy=:m  and
                                                     fu.year_vy=:y   and
                                                     fu.month_za=a.month_za  and
                                                     fu.year_za=a.year_za    and
                                                     fu.shifridperson=a.shifridperson)=0)
*/
/*                               (:shifrecb=142 and not exists (
                                           select first 1 * from fud d
                                               where d.shifrsta in (142,143,144,145,146) and
                                                     d.month_vy=:m  and
                                                     d.year_vy=:y   and
                                                     d.month_za=a.month_za  and
                                                     d.year_za=a.year_za    and
                                                     d.shifridperson=a.shifridperson)                                 )
*/

                              )
                      group by  1,2
              into :pay_year, :pay_mnth
     do
        begin
             select sum(a.summa) from fadd a
                    join shifr b on a.shifrsta=b.shifr
              where a.month_vy = :m     and
                    a.year_vy  = :y     and
                    a.year_za  = :pay_year and
                    a.month_za = :pay_mnth and
                    a.tabno    = :tabno    and
                    a.sch not starting with '-' and

                    b.ecb      = 1      and
               --     a.shifrsta in (5,6,10) and    -- отпускные
                    ((select first 1 retval from pr_isotpshifr(a.shifrsta))=1) and    -- отпускные

                    (
                      (
                       (select count(*) from fud fu2
                                           where fu2.shifrsta=:shifrecb and
                                                 fu2.month_vy=:m  and
                                                 fu2.year_vy=:y and
                                                 fu2.month_za=:pay_mnth  and
                                                 fu2.year_za=:pay_year   and
                                                 fu2.shifridperson=a.shifridperson)>0
                       and
                       (
                        ((:shifrecb=143) and (select first 1 retval from pr_is_sciped(a.shifridperson,0))=1)
                        or
                        ((:shifrecb=142) and (select first 1 retval from pr_is_sciped(a.shifridperson,0))=0)
                       )
                      )
                     or
                       (
                        (
                         (
                          (:shifrecb=143) and
                           ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=1)
                         )
                         or
                         (
                          (:shifrecb=142) and
                           ((select first 1 retval from pr_is_sciped(a.shifridperson,0))=0)
                         )
                        )
--                        and
--                         (
--                           (select count(*) from fud fu
--                                  where fu.shifrsta in (142,143,144,145,146)
--                                    and fu.month_vy = :m
--                                    and fu.year_vy  = :y
--                                    and fu.month_za = a.month_za
--                                    and fu.year_za  = a.year_za
--                                    and fu.shifridperson = a.shifridperson)=0
--                         )
                        )

                     )
                    and
                    a.shifrsta not in (31,32,44)            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                               -- внесено в кассу
                   into :summa;

------------------- Отметка ---------------------------
           update fadd fa
                set fa.sch='-----'
              where fa.month_vy = :m     and
                    fa.year_vy  = :y     and
                    fa.year_za  = :pay_year and
                    fa.month_za = :pay_mnth and
                    fa.tabno    = :tabno and
                    fa.sch not starting with '-' and

                    (select fb.ecb from shifr fb where fb.shifr=fa.shifrsta)     = 1      and
               --     a.shifrsta in (5,6,10) and    -- отпускные
                    ((select first 1 retval from pr_isotpshifr(fa.shifrsta))=1) and    -- отпускные

                    (
                      (
                       (select count(*) from fud fu21
                                           where fu21.shifrsta=:shifrecb and
                                                 fu21.month_vy=:m  and
                                                 fu21.year_vy=:y and
                                                 fu21.month_za=:pay_mnth  and
                                                 fu21.year_za=:pay_year   and
                                                 fu21.shifridperson=fa.shifridperson)>0
                       and
                       (
                        ((:shifrecb=143) and (select first 1 retval from pr_is_sciped(fa.shifridperson,0))=1)
                        or
                        ((:shifrecb=142) and (select first 1 retval from pr_is_sciped(fa.shifridperson,0))=0)
                       )
                      )
                     or
                       (
                        (
                         (
                          (:shifrecb=143) and
                           ((select first 1 retval from pr_is_sciped(fa.shifridperson,0))=1)
                         )
                         or
                         (
                          (:shifrecb=142) and
                           ((select first 1 retval from pr_is_sciped(fa.shifridperson,0))=0)
                         )
                        )
/*
                        and
                         (
                           (select count(*) from fud fu22
                                  where fu22.shifrsta in (142,143,144,145,146)
                                    and fu22.month_vy = :m
                                    and fu22.year_vy  = :y
                                    and fu22.month_za = fa.month_za
                                    and fu22.year_za  = fa.year_za
                                    and fu22.shifridperson = fa.shifridperson)=0
                         )
*/
                        )

                     )
                    and
                    fa.shifrsta not in (31,32,44);            -- материальную помощь не включать
                                                              -- декретный больничеый не включать
                                                              -- пособие до 3-х лет
                                                               -- внесено в кассу



------------------- конец отметки ---------------------


       --     Таблица 6                -------
/*
            select sum(a.summa) from fud a
                   where a.year_vy  = :y
                   and a.month_vy = :m
                   and a.year_za  = :pay_year
                   and a.month_za = :pay_mnth
                   and a.tabno    = :tabno
                   and a.sch not starting with '-'
                   and a.shifrsta = :shifrecb
              into :SummaECBRas;
*/
----------------- Отметка ---------------------
            update fud fu9
             set fu9.sch='-----'
                   where fu9.year_vy  = :y
                   and fu9.month_vy = :m
                   and fu9.year_za  = :pay_year
                   and fu9.month_za = :pay_mnth
                   and fu9.tabno    = :tabno
                   and fu9.sch not starting with '-'
                   and fu9.shifrsta = :shifrecb;

----------------- конец отметки ---------------


            if ((pay_year=y) and (pay_mnth=m)) then
               begin
                    summaEcbFullPrev=null;
                    shifridt6=null;
                    select first 1 a.sum_ins,a.sum_total,a.shifrid from  tb_e04t06c a
                                             where a.tabno=:tabno and
                                                   a.yearvy=:y    and
                                                   a.monthvy=:m   and
                                                   a.ZO not in (10,29,36,26) and   --29,36-boln 26-догпо 10 отпускн
                                                   a.exp=case
                                                             when (:shifrecb=143) then 1
                                                             else 0
                                                         end
                                                             and
                                                   a.pay_tp=0     and
                                                   ((coalesce(a.pay_year,:y)=:y) or
                                                    (a.pay_year=0)) and
                                                   ((coalesce(a.pay_mnth,:m)=:m) or
                                                    (a.pay_mnth=0))
                                             into :summaEcbFullPrev,:summaTotalPrev,:shifrIdT6;

                    summaEcbFullPrev=coalesce(summaEcbFullPrev,0);
                    shifridt6=coalesce(shifridt6,0);
                    if ((ShifrIdT6>0) and abs(summaEcbFullPrev)>0.01) then
                       begin
   -- 13 09 2015
                             if (abs(summaTotalPrev)<0.01) then
                                begin
                                     SummaECBRas=summaEcbFullPrev;
                                end
                             else
                                begin
                             SummaECBRasO=case
                                           when (ShifrECB=143) then summa*0.061
                                           else  summa*0.036
                                          end;
                             if (abs(abs(SummaECBRasO)-abs(SummaECBFullPrev))>0.01) then
                                 begin
                                       SummaECBRas=SummaECBRasO;
                                       update tb_e04t06c
                                              set sum_ins=sum_ins-:summaecbras
                                              where shifrid=:shifridt6;
                                 end
                                end
                             if (abs(summaTotalPrev)<0.01) then
                                 delete from tb_e04t06c
                                        where shifrid=:shifridt6;
                       end
               end
            summa=coalesce(summa,0);
            summaECBRas=coalesce(summaECBRas,0);
            if ((abs(summa)>0.001) or (abs(summaECBRas)>0.001))  then
               begin
                    rownum = rown + 1;
                    if (shifrecb=143) then exp=1;
                    baseln=baseln+1;
                    sum_narah=case
                               when zo in (2,32) then summa*8.41 / 100.0
                               else summa*22.00 / 100.0
                              end;
/*
            sum_narah=case
                      --     when zo in (1,25)      then summa*36.3 / 100.0
                           when zo in (1,25)      then summa*6.1 / 100.0
                      --     when zo in (26)        then summa*34.7 / 100.0
                           when zo in (26)        then summa*2.6 / 100.0
                      --     when zo in (29, 36,42) then summa*33.2 / 100.0
                           when zo in (29, 36,42) then summa*2 / 100.0
                      --   when zo in (2,32)      then summa*8.41 / 100.0
                           when zo in (2,32)      then summa*6.1 / 100.0
                           else 0
                        end;
*/
                    insert into tb_e04t06c (yearvy   , monthvy     , tabno   , period_m , period_y ,
                                            rownum   , ukr_gromad  , st      , numident , fio      ,
                                            nm       , ftn         , zo      , pay_tp   , pay_mnth ,
                                            pay_year , sum_total   , sum_max , sum_ins  , otk      ,
                                            exp      , lineno      , kd_np   , kd_nzp   , kd_ptv   ,
                                            nrm      , kd_vp       , sum_diff, sum_narah, nrc)
                                     values(:y       , :m          , :tabno  , :m       , :y       ,
                                            :rownum  , :ukr_gromad , :pol    , :nal_code, :fam     ,
                                            :nam     , :otc        , :zo     , :pay_tp  , :pay_mnth,
                                            :pay_year, :summa      , :summa  , :summaecbras,:otk   ,
                                            :exp     , :baseln     , 0       , 0        , 0        ,
                                            0        , 0           , 0       , :sum_narah  , 0) ;
               end
        end

end^


ALTER PROCEDURE PR_E7_ALL_PERSON (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable FAM varchar(100);
declare variable NAM varchar(100);
declare variable OTC varchar(100);
declare variable NUMIDENT varchar(10);
declare variable UKR_GROMAD integer;
declare variable POL integer;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable DAYS integer;
declare variable START_DT_1 integer;
declare variable END_DT_1 integer;
declare variable DT date;
declare variable NORMA integer;
begin
  /* Procedure Text */
    for
       select a.tabno from tb_e04t06c a
               where a.monthvy    = :m
                     and a.yearvy = :y
                     and a.exp    = 1
                     and (not exists (
                           select * from tb_e04t06c aa
                                  where aa.tabno=a.tabno
                                    and aa.yearvy=:y
                                    and aa.monthvy=:m
                                    and aa.exp<>1)
                         or (
                            exists (
                              select * from person pa
                                     where pa.tabno    = a.tabno
                                       and pa.monthvy  = :m
                                       and pa.yearvy   = :y
                                       and pa.w_r      = 1
                                       and pa.shifrkat in (1,3)
                                       and (select sum(fa.summa) from fadd fa
                                                   where fa.shifridperson=pa.shifrid)>5.0
                            )
                         )
                   )
               group by 1
               into :tabno
    do
      begin
           select first 1 a.fio,a.nm,a.ftn,a.ukr_gromad,a.st,a.numident from tb_e04t06c a
                  where a.tabno=:tabno
                  order by a.yearvy desc, a.monthvy desc
                  into :fam,:nam, :otc,:ukr_gromad,:pol,:numident;
           start_dt=1;
           dt=:y||'-'||:m||'-01';
           select first 1 l from lenmonth(:dt) into end_dt;
        -- Для тех, кто есть в табл 5 проверить даты
           if (exists (select * from tb_e04t05c
                                where tb_e04t05c.tabno=:tabno
                                      and tb_e04t05c.yearvy=:y
                                      and tb_e04t05c.monthvy=:m)
              ) then
              begin
                   select first 1  tb_e04t05c.start_dt,tb_e04t05c.end_dt from tb_e04t05c
                          where tb_e04t05c.tabno=:tabno
                                and tb_e04t05c.yearvy=:y
                                and tb_e04t05c.monthvy=:m
                          into :start_dt_1,:end_dt_1;
                   start_dt_1 = coalesce(start_dt_1,0);
                   end_dt_1   = coalesce(end_dt_1,0);
                   if (start_dt_1>0) then
                      start_dt=start_dt_1;
                   if (end_dt_1>0) then
                       end_dt=end_dt_1;
              end

           days=end_dt-start_dt+1;
           norma=end_dt-start_dt+1;
           insert into tb_e04t07c (yearvy     , monthvy  , tabno  , period_m , period_y,
                                   ukr_gromad , numident , fio    , nm       , ftn     ,
                                   c_pid      , start_dt , end_dt , days     , norma   ,
                                   seazon)
                           values (:y         , :m       ,:tabno  , :m       , :y      ,
                                   :ukr_gromad,:numident ,:fam    , :nam     ,:otc     ,
                                   'ЗНТ024А1' ,:start_dt ,:end_dt , :days    , :norma   ,
                                   1);

      end
end^


ALTER PROCEDURE PR_FIILL_ALL_PERS
RETURNS (
    T INTEGER)
AS
declare variable tabno integer;
declare variable y integer;
begin
     Y=2007;
     FOR
        SELECT FIRST 100 TABNO FROM person
             WHERE PERSON.yearvy=:Y and (SELECT SUM(SUMMA) from FADD WHERE FADD.shifridperson=PERSON.SHIFRID)>0
             GROUP BY 1
             INTO :TABNO
     DO
       BEGIN
        T=TABNO;
        SUSPEND;
        EXECUTE PROCEDURE PR_FIILL_PERS_PERSON (:TABNO,:y);
       END
  /* Procedure Text */

end^


ALTER PROCEDURE PR_FIILL_PERS_PERSON (
    TABNO INTEGER,
    Y INTEGER)
AS
declare variable period integer;
declare variable summa decimal(15,2);
declare variable i integer;
declare variable summaboln decimal(15,0);
declare variable dateb date;
declare variable l integer;
declare variable datee date;
declare variable datec date;
declare variable musor bigint;
declare variable kal_day integer;
declare variable datepri date;
declare variable dateuw date;
declare variable p decimal(10,2);
declare variable szp decimal(15,2);
declare variable summapensras decimal(15,2);
declare variable tin varchar(10);
declare variable krpou varchar(12);
declare variable dtin date;
declare variable pol char(1);
declare variable otk integer;
declare variable svr decimal(10,2);
declare variable ktsz char(1);
declare variable invalid integer;
declare variable pensioner integer;
declare variable svz decimal(10,2);
declare variable ic decimal(10,0);
declare variable km integer;
declare variable kd integer;
declare variable kmz integer;
declare variable idec decimal(15,0);
begin
     krpou='02070714';
     dtin=(Y+1)||'-02-10';
     delete from tb_apm_ank where tabno=:tabno;

     select count(*) from kadry where tabno=:tabno into :i;
     if (i<0) then
        Exit;
     select first 1 kadry.data_pri,kadry.data_uw,kadry.nal_code,kadry.data_birth from kadry where tabno=:tabno
            into :datepri,:dateuw,:tin,:datec;
     if (dateuw is not null and extract(year from dateuw)<y) then
        Exit;
     if (DatePri is Null or DatePri<Y||'-01-01' or DatePri>Y||'-12-31' ) then
        DatePri=Y||'-01-01';
     if (DateUw is Null or DateUw>Y||'-12-31' ) then
        DateUw=Y||'-12-31';
     period=gen_id(g_apm, 1);
     pol='Ч';
     if (strlen(ltrim(rtrim(tin)))=10) then
        begin
             ic=cast(tin as decimal(10,0));
             idec=ic/100;
             idec=idec*100;
             ic=ic-idec;
             ic=ic/10;
             if (ic in (0,2,4,6,8)) then
                pol='Ж';
        end
     insert into tb_apm_ank (shifrid,tabno,tin,krpou,d_tin,rnpd,toz,pol,d_rog) values(:period,:tabno,:tin,:krpou,:dtin,0,0,:pol,:datec);
     i=gen_id(g_apm, 1);
     otk=0;
     if (exists (select * from person where person.m_o_r in (82,161) and person.tabno=:tabno and person.yearvy=:y)) then
        otk=1;
     insert into tb_apm_ind (ktf,shifrid,shifridank,dpr,dzr,tin,krpou,Zvit_r,Zvit_p,Splat_r,otk)
            values(1,:i,:period, :DatePri,:DateUw,:tin,:krpou,:y, 0,:Y,:otk);
     svr=0;
     svz=0;
     invalid=0;
     for
        select fadd.month_za,sum(fadd.summa),
               sum(case when fadd.shifrsta in (12,14,15,16) then fadd.summa else 0.00 end) from fadd
               where fadd.year_za=:y and fadd.tabno=:tabno
               group by 1
               into :period, :summa,:summaboln
     do
       begin
---Подсчет количества календарных дней
            dateb=y||'-'||period||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||period||'-'||l;
            DateC=DateB;
            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||period||'-'||musor;
                   if (datec between DatePri and DateUw) then
                      Kal_Day=Kal_Day+1;
              end
            DateC=y||'-'||period||'-10';
            select first 1 a.limitpens from penshea a
                           where a.datefr<:DateC
                           order by a.datefr desc
                           into :p;
            if (SUmma>p) then
               szp=p;
            else
               szp=summa;
            svr=svr+Summa;
            select first 1 Summapens from pens(:tabno,:Y,:Period, :Summa) into :SummaPensRas;
            svz=svz+:SummaPensRas;
            invalid=0;
            if (exists (select * from fcn where fcn.tabno=:tabno and fcn.month_vy=:period and fcn.year_vy=:y and fcn.shifrsta in (112,112+500))) then
               invalid=1;
            pensioner=0;
            if (exists (select * from fcn where fcn.tabno=:tabno and fcn.month_vy=:period and fcn.year_vy=:y and fcn.shifrsta in (107,107+500))) then
               pensioner=1;
            insert into tb_apm_ind_body(shifridind,period,sz,szp,sl,spd,kd,isinvalid,ispensioner)
                   values(:i, :period,:summa,:szp,:summaboln,:SummaPensRas,:kal_day,:invalid,:pensioner);


       end
       KTSZ='1';
       pensioner=0;
       invalid=0;
       if (exists (select * from tb_apm_ind_body where tb_apm_ind_body.shifridind  =:i and tb_apm_ind_body.isinvalid=1)) then
          invalid=1;
       pensioner=0;
       if (exists (select * from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i and tb_apm_ind_body.ispensioner=1)) then
          pensioner=1;
       p=0.318;
       IF (invalid=1) then
          begin
               KTSZ     = '2';
               p        = 0.04;
          end
/*
          ind:SZ  = ind:sz1+ind:sz2+ind:sz3+ind:sz4+ind:sz5+ind:sz6+ind:sz7+ind:sz8+ind:sz9+ind:sz10+ind:sz11+ind:sz12
          ind:SL  = ind:sL1+ind:sL2+ind:sL3+ind:sL4+ind:sL5+ind:sL6+ind:sL7+ind:sL8+ind:sL9+ind:sL10+ind:sL11+ind:sL12
          ind:SZP = ind:szP1+ind:szP2+ind:szP3+ind:szP4+ind:szP5+ind:szP6+ind:szP7+ind:szP8+ind:szP9+ind:szP10+ind:szP11+ind:szP12
          ind:SP  = ind:sPD1+ind:sPD2+ind:sPD3+ind:sPD4+ind:sPD5+ind:sPD6+ind:sPD7+ind:sPD8+ind:sPD9+ind:sPD10+ind:sPD11+ind:sPD12
          ind:KD  = ind:KD1+ind:KD2+ind:KD3+ind:KD4+ind:KD5+ind:KD6+ind:KD7+ind:KD8+ind:KD9+ind:KD10+ind:KD11+ind:KD12
!          ind:SVR = round(a$*p$,0.01)
   !       ind:SVR = round(ind:SZP*p$,0.01)
          ind:SVZ = ind:sp
 */
       -- Подсчет стажа
       Musor=0;
       km=0;
       kd=0;
       while (Musor<12) do
         begin
              Musor=Musor+1;
              dateb=y||'-'||Musor||'-01';
              select first 1 l from lenmonth(:dateb) into :l;
              datee=y||'-'||musor||'-'||l;
              if (DatePri<=DateB and DateUw>=DateE) then
                 km=km+1;
              if (DatePri<=DateB and DateUw<DateE and DateUw>DateB) then
                 kd=kd+extract(day from DateUw);
              if (DatePri>DateB and DateUw>=DateE) then
                 kd=kd+(extract(day from DateE)-extract(day from DatePri)+1);
              if (DatePri>DateB and DateUw<DateE) then
                 kd=kd+(extract(day from DateUw)-extract(day from DatePri)+1);
         end
       if (kd>28) then
          begin
               km=km+1;
               kd=0;
          end
       if (km>12) then
          begin
               km=12;
               kd=0;
          end
       update tb_apm_ind set
        sz          = (select sum(sz) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i) ,
        sl          = (select sum(sl) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i) ,
        szp         = (select sum(szp) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        sp          = (select sum(spd) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        kd          = (select sum(kd) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        svz         = sp,
        svr         = (select sum(cast((szp*:p) as decimal(15,2))) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        ktsz        = :ktsz,
        isinvalid   = :invalid,
        ispensioner = :pensioner,
        kpm         = :km,
        kpd         = :kd,
        rnpd        = 0,
        npd         = 0,
        dfd         = (:Y+1)||'-02-10',
        kpfu        = '',
        nzv         = '',
        kop         = '',
        toz         = ''
        where shifrid=:i;

        musor=0;
        kmz=0;
        while (musor<12) do
          begin
                musor=musor+1;
                if (exists (select * from person
                                     where person.tabno=:tabno and person.yearvy=:y
                                           and person.monthvy=:musor and person.shifrkat=1
                                           and (select sum(summa) from fadd where fadd.shifridperson=person.shifrid) >0)) then
                   kmz=kmz+1;
          end
        if (kmz>12) then
           kmz=12;
        if (Kmz>0) then
           insert into tb_apm_ind_ss (ShifrIdInd,Kplg,Kmz,Ksl,Ssm,Nsl)
                  values (:i,'ЗНТ024А1',:kmz,'1',:Kmz,:Kmz);
  /* Procedure Text */
end^


ALTER PROCEDURE PR_FIILL_PERS_PERSON_ANK (
    TABNO INTEGER,
    Y INTEGER)
AS
declare variable period integer;
declare variable i integer;
declare variable datec date;
declare variable datepri date;
declare variable dateuw date;
declare variable tin varchar(10);
declare variable krpou varchar(12);
declare variable dtin date;
declare variable pol char(1);
declare variable ic decimal(10,0);
declare variable idec decimal(15,0);
declare variable wantedmode integer;
declare variable shifrind integer;
declare variable i_count integer;
declare variable forced_mode integer;
begin
     krpou='02070714';
     dtin=(Y+1)||'-02-10';
     delete from tb_apm_ank where tabno=:tabno;

     select count(*) from kadry where tabno=:tabno into :i;
     if (i<0) then
        Exit;
     select first 1 kadry.data_pri,kadry.data_uw,kadry.nal_code,kadry.data_birth from kadry where tabno=:tabno
            into :datepri,:dateuw,:tin,:datec;
  --   if (dateuw is not null and extract(year from dateuw)<y) then
  --      Exit;
     if (DatePri is Null or DatePri<Y||'-01-01' or DatePri>Y||'-12-31' ) then
        DatePri=Y||'-01-01';
     if (DateUw is Null or DateUw>Y||'-12-31' or DateUw<Y||'-01-01')  then
        DateUw=Y||'-12-31';
     if (DateUw<DatePri) then
         DateUw=DatePri+1;
     period=gen_id(g_apm, 1);
     pol='Ч';
     if (strlen(ltrim(rtrim(tin)))=10) then
        begin
             ic=cast(tin as decimal(10,0));
             idec=ic/100;
             idec=idec*100;
             ic=ic-idec;
             ic=ic/10;
             if (ic in (0,2,4,6,8)) then
                pol='Ж';
        end
     insert into tb_apm_ank (shifrid,tabno,tin,krpou,d_tin,rnpd,toz,pol,d_rog) values(:period,:tabno,:tin,:krpou,:dtin,0,0,:pol,:datec);
--     if (exists (select * from person_97 where person_97.tabno=:tabno)) then
     if (exists (select * from tb_prep_uwp_2009 a where a.tabno=:tabno and a.summaprep>100)) then
        WantedMode=2;          -- Две строки
     else
        WantedMode=1;          -- Одна строка
     if (WantedMode=1) then
         execute procedure pr_fill_pers_person_ind(tabno, y,period, TIN,KRPOU, DatePri,dateuw,0,0);
     else
      begin
--           select first 1 mode from person_97 where tabno=:tabno into :forced_mode;
           select first 1 mode from tb_prep_uwp_2009  a where a.tabno=:tabno and a.summaprep>100 into :forced_mode;
           if (forced_mode=0) then
              execute procedure pr_fill_pers_person_ind(tabno, y,period, TIN,KRPOU, DatePri,dateuw,2,2);
           if (forced_mode=1) then
              execute procedure pr_fill_pers_person_ind(tabno, y,period, TIN,KRPOU, DatePri,dateuw,1,1);
           if (forced_mode=2) then
              begin
           -- Науковий работник
                   execute procedure pr_fill_pers_person_ind(tabno, y,period, TIN,KRPOU, DatePri,dateuw,1,0);
           -- Обычный стаж
                   execute procedure pr_fill_pers_person_ind(tabno, y,period, TIN,KRPOU, DatePri,dateuw,2,0);
              end
           i_count=0;
           for
              select tb_apm_ind.shifrid from tb_apm_ank
                     join tb_apm_ind on tb_apm_ank.shifrid=tb_apm_ind.shifridank where tb_apm_ank.tabno=:tabno into :ShifrInd
           do
             begin
                   if (exists (select * from tb_apm_ind_ss
                          where tb_apm_ind_ss.shifridind=:shifrind)) then
                      i_count=i_count+1;
             end
           if (i_count>1) then
              exception E_INVALIDIND cast(tabno as char(5));
      end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_FILL_B_REE_LINE (
    SHIFRIDREB INTEGER)
RETURNS (
    FIO VARCHAR(51),
    SWIDSS VARCHAR(15),
    NOMER_B VARCHAR(10),
    CODEILL INTEGER,
    PERIODILL VARCHAR(25),
    DAYTOT INTEGER,
    DAYSS INTEGER,
    SUMMATOT DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
declare variable SHIFRID integer;
begin
      for
          select a.fio,a.swidss,a.nomer_b,a.codeill,
                 extract(day from a.datefr)||'.'||extract(month from a.datefr)||'.'||(extract(year from a.datefr)-2000)||'-'||
                 extract(day from a.dateto)||'.'||extract(month from a.dateto)||'.'||(extract(year from a.dateto)-2000),
                 a.nmbofday,a.summa,
                 a.nmbofdayss,a.summass
                 from tb_ree_boln_det a
                           where a.shifridree=:shifridreb
                           into :fio,:swidss, :nomer_b, :codeill,:periodill,:daytot,:summatot,
                                :dayss,:summass
      do
         begin
              codeill=coalesce(codeill,1);
              swidss=coalesce(swidss, ' ');
              suspend;
         end
      /* Procedure Text */
end^


ALTER PROCEDURE PR_FILL_B_REE_LINE_06_2012 (
    SHIFRIDREB INTEGER)
RETURNS (
    FIO VARCHAR(51),
    SWIDSS VARCHAR(15),
    NOMER_B VARCHAR(10),
    CODEILL INTEGER,
    DATAFR VARCHAR(10),
    DATATO VARCHAR(10),
    DAYTOT INTEGER,
    DAYSS INTEGER,
    SUMMATOT DECIMAL(15,2),
    SUMMASS DECIMAL(15,2))
AS
declare variable SHIFRID integer;
begin
      for
          select a.fio,a.swidss,a.nomer_b,a.codeill,
                 extract(day from a.datefr)||'.'||extract(month from a.datefr)||'.'||(extract(year from a.datefr)-2000) as dataFr,
                 extract(day from a.dateto)||'.'||extract(month from a.dateto)||'.'||(extract(year from a.dateto)-2000) as dataTo,
                 a.nmbofday,a.summa,
                 a.nmbofdayss,a.summass
                 from tb_ree_boln_det a
                           where a.shifridree=:shifridreb
                           into :fio,:swidss, :nomer_b, :codeill,:datafr,:datato,:daytot,:summatot,
                                :dayss,:summass
      do
         begin
              codeill=coalesce(codeill,1);
              swidss=coalesce(swidss, ' ');
              suspend;
         end
      /* Procedure Text */
end^


ALTER PROCEDURE PR_FILL_DET_PERSON (
    Y INTEGER,
    M INTEGER,
    YCURR INTEGER,
    MCURR INTEGER)
AS
declare variable TABNO integer;
declare variable GUID varchar(30);
declare variable SHIFRIDOWN integer;
declare variable ISSCIPED integer;
declare variable ISDP integer;
declare variable SHIFRIDPERSON integer;
declare variable SHIFRPOD integer;
declare variable SUMMAADD decimal(15,2);
declare variable SUMMAUD decimal(15,2);
declare variable ISBLOCKED integer;
declare variable AUTOMATIC integer;
declare variable ISOSN integer;
declare variable W_R integer;
declare variable SUMMALIMITECB decimal(15,2);
declare variable SUMMAECBN decimal(15,2);
declare variable SUMMAECB decimal(15,2);
declare variable SUMMAECBDP decimal(15,2);
declare variable SUMMAECBILL decimal(15,2);
declare variable SUMMAPOD decimal(15,2);
declare variable SUMMAADDECBN decimal(15,2);
declare variable SUMMAADDECB decimal(15,2);
declare variable SUMMAADDECBDP decimal(15,2);
declare variable SUMMAADDECBILL decimal(15,2);
declare variable SUMMAADDPOD decimal(15,2);
declare variable D date;
declare variable LIMITFORECB decimal(15,2);
declare variable SHIFRIDDET integer;
declare variable SUMMA decimal(15,2);
declare variable A decimal(15,2);
begin

     for
        select a.tabno,a.shifrid,
               a.summaecbnras     - a.summaecbnud   ,
               a.summaecbras      - a.summaecbud    ,
               a.summaecbdpras    - a.summaecbdpud  ,
               a.summaecbillras   - a.summaecbillud ,
               a.summapodras      - a.summapodud    ,
               a.summaaddecbn,a.summaaddecb,a.summaaddecbdp,a.summaaddecbill,a.summaaddpod
                from tb_recalc_podoh a
                       where a.yearza  = :y
                         and a.monthza = :m
                         and ((abs(abs(a.summaecbnras)-abs(a.summaecbnud))>0.01) or
                              (abs(abs(a.summaecbras)-abs(a.summaecbud))>0.01) or
                              (abs(abs(a.summaecbdpras)-abs(a.summaecbdpud))>0.01) or
                              (abs(abs(a.summaecbillras)-abs(a.summaecbillud))>0.01) or
                              (abs(abs(a.summapodras)-abs(a.summapodud))>0.01))

                       into :tabno,:shifridown,:summaecbn,:summaecb,:summaecbdp,:summaecbill,:summapod,
                            :summaaddecbn,:summaaddecb,:summaaddecbdp,:summaaddecbill,:summaaddpod
     do
       begin
             summaecbn   = coalesce(summaecbn,0);
             summaecb    = coalesce(summaecb,0);
             summaecbdp  = coalesce(summaecbdp,0);
             summaecbill = coalesce(summaecbill,0);
             summapod    = coalesce(summapod,0);
             for
                 select (select first 1 guid from pr_getguid(b.shifrid,0)),b.shifrid,b.w_place,b.automatic,b.w_r from person b
                           where b.yearvy=:ycurr
                             and b.monthvy=:mcurr
                             and b.tabno=:tabno
                             and b.w_place not in (82)
                           into :guid,:shifridperson,:shifrpod,:automatic,:w_r
             do
               begin
                    isosn=0;
                    if (w_r=1) then isosn=1;
                    select sum(summa) from fadd d
                                      where d.shifridperson=:shifridperson
                                      into :summaadd;
                    select sum(summa) from fud d
                                      where d.shifridperson=:shifridperson
                                      into :summaud;
                    summaadd = coalesce(summaadd,0);
                    summaud  = coalesce(summaud,0);
                    if ((abs(abs(summaadd)-abs(summaud))<0.01) and (SummaAdd<0.01)) then
                       isblocked=1;
                    else
                       isblocked=0;
                    select first 1 retval from pr_is_sciped(:shifridperson,0) into :issciped;
                    if (shifrpod in (81,140)) then isdp=1;
                    else isdp=0;
                    if (isblocked=0) then
                       if (automatic<>1) then
                          isblocked=1;
                    if (isblocked=0) then
                    insert into tb_recalc_podoh_det
                             (shifridown     , tabno        ,  guid          ,  issciped       ,     isdp  ,
                              isblocked      , isosn)
                       values(:shifridown,:tabno, :guid, :issciped,:isdp,:isblocked,:isosn);
               end
/*
             d=y||'-'||m||'-01';
             select first 1 v.limitmax from sslimity v
                                       where v.datefr<=:d
                                       order by v.datefr desc
                                       into :limitforecb;
             summalimitecb=0;
             if (abs(summaecbn)>0.01) then
                begin
                     for
                        select first 1 w.shifrid,w.summaaddecbn from tb_recalc_podoh_det w
                                                 where w.issciped = 1 and
                                                       w.tabno    = :tabno
                                                 into :shifriddet,:summa
                     do
                        begin
                              summa=coalesce(summa,0);
                              if (summa<0.01) then
                              a=summa*0.061;
                              i
                         select first 1 w.shifrid from tb_recalc_podoh_det w
                                                  where w.issciped = 1 and
                                                        w.w_r      = 1
                                                  into :shifriddet;
                end
*/
       end

  /* Procedure Text */
end^


ALTER PROCEDURE PR_FILL_E04T05C (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable DATA_PRI date;
declare variable DATA_UW date;
declare variable START_D integer;
declare variable END_D integer;
declare variable NAL_CODE varchar(10);
declare variable SHIFRNF integer;
declare variable S varchar(20);
declare variable I integer;
declare variable UKR_GROMAD integer;
declare variable POL integer;
declare variable D char(1);
declare variable ROWNUM integer;
declare variable NRM_DT date;
declare variable ZO integer;
declare variable DOG_CPH integer;
declare variable CODE_UWOL integer;
declare variable REASON_UWOL varchar(150);
declare variable DATAPRIK date;
declare variable NOMERPRIK TVARCHAR15;
declare variable IDCLASSIFICATOR integer;
declare variable KODKP varchar(6);
declare variable KODZKPPTR varchar(5);
declare variable NAMEDOL varchar(250);
declare variable NAMEPROF varchar(250);
declare variable PID varchar(250);
declare variable NOMERDOG varchar(64);
declare variable REASONOK varchar(512);
declare variable DATABEG date;
declare variable DATAEND date;
begin

     DELETE FROM tb_e04t05c where yearvy=:y and monthvy=:m;
     rownum   = 0;
     nrm_dt   = '01-01-1990';
     ZO       = 1;
     for
          select tabno, fio, nal_code,data_pri,data_uw,code_uwol from kadry
                 where (extract(year from kadry.data_pri)=:y and extract(month from kadry.data_pri)=:m) or
                       (extract(year from kadry.data_uw)=:y and extract(month from kadry.data_uw)=:m)
                 into :tabno,:fio,:nal_code, :data_pri,:data_uw,:code_uwol
     do
        begin

             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             dog_cph  = 0;   -- Договор подряда для стороннего
                             -- 0 - нет 1 -да
             code_uwol=coalesce(code_uwol,0);
             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from data_pri)=y)
                 and (extract(month from data_pri)=m)) then
                start_d=coalesce((extract(day from data_pri)),0);
             if ((extract(year from data_uw)=y)
                  and (extract(month from data_uw)=m)) then
                end_d=coalesce((extract(day from data_uw)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             rownum=rownum+1;
             ZO=1;
             if (exists (select * from person where person.m_o_r in (82,121,161) and
                                  person.tabno=:tabno          and
                                  person.yearvy=:y             and
                                  person.monthvy=:m)) then
             if (not (exists (select * from person where person.m_o_r not in (82,121,161) and
                                  person.tabno=:tabno          and
                                  person.yearvy=:y             and
                                  person.monthvy=:m))) then
                zo=2;   -- трудовая книжка не на предприятии
             reason_uwol=null;
             if (end_d>0)     then
             if (code_uwol>0) then
                begin
                     select first 1 coalesce(a.reason,'') from tb_dismis a
                            where id=:code_uwol
                            into :reason_uwol;
                end

             insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO, DOG_CPH,
                                     PID_ZV)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO,:DOG_CPH,
                                     :reason_uwol);
        end

/* Переводы отключены 17 09 2019 (по просьбе Т И)
     for
          select kk.tabno, kk.fio, kk.nal_code,kk.data_pri,kk.data_uw,kk.code_uwol,
                 pr.nomerprik,pr.dataprik,coalesce(pr.idclassificator,0),
                 substr(pr.kodkp,1,6),substr(pr.kodzkpptr,1,5), coalesce(pr.namedol,''), coalesce(pr.nameprof,'')
                 from kadry kk
                 join tb_prikazy pr on kk.tabno=pr.tabno
                 where pr.y=:y
                   and pr.m=:m
                   and pr.shifridtyp=7

                 into :tabno,:fio,:nal_code, :data_pri,:data_uw,:code_uwol,
                  :nomerprik,:dataprik,:idclassificator,
                  :kodkp ,:kodzkpptr,:namedol,:nameprof
     do
        begin

             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);


             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             dog_cph  = 0;   -- Договор подряда для стороннего
                             -- 0 - нет 1 -да
             code_uwol=coalesce(code_uwol,0);

             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
--             if ((extract(year from data_pri)=y)
--                 and (extract(month from data_pri)=m)) then
--                start_d=coalesce((extract(day from data_pri)),0);
--             if ((extract(year from data_uw)=y)
--                  and (extract(month from data_uw)=m)) then
--                end_d=coalesce((extract(day from data_uw)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             rownum=rownum+1;
             ZO=1;
             if (exists (select * from person where person.m_o_r in (82,121,161) and
                                  person.tabno=:tabno          and
                                  person.yearvy=:y             and
                                  person.monthvy=:m)) then
             if (not (exists (select * from person where person.m_o_r not in (82,121,161) and
                                  person.tabno=:tabno          and
                                  person.yearvy=:y             and
                                  person.monthvy=:m))) then
                zo=2;   -- трудовая книжка не на предприятии
             reason_uwol=null;
             if (end_d>0)     then
             if (code_uwol>0) then
                begin
                     select first 1 coalesce(a.reason,'') from tb_dismis a
                            where id=:code_uwol
                            into :reason_uwol;
                end
             pid='';
             dataprik=coalesce(dataprik,'1900-01-01');
             nomerprik=coalesce(nomerprik,'');
             if ((extract(year from dataprik)>2017)
                and
                (strlen(trim(nomerprik))>0)) then
                pid='Приказ '||trim(nomerprik)||' від '||case
                                                           when extract(day from dataprik)<10 then '0'||extract(day from dataprik)
                                                           else extract(day from dataprik)
                                                         end
                                                        ||'.'||
                                                         case
                                                             when extract(month from dataprik)<10 then '0'||extract(month from dataprik)
                                                             else extract(month from dataprik)
                                                         end
                                                        ||'.'||extract(year from dataprik);
             if (strlen(nameprof)>250) then
                 nameprof=substr(nameprof,1,250);
             if (strlen(nameprof)>250) then
                 nameprof=substr(nameprof,1,250);
             if (strlen(namedol)>250) then
                 namedol=substr(namedol,1,250);
             if (strlen(pid)>250) then
                 pid=substr(pid,1,250);
             if (strlen(reason_uwol)>150) then
                 reason_uwol=substr(reason_uwol,1,150);
             insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO, DOG_CPH,
                                     PID_ZV,
                                     PNR,ZKPP,PROF,POS,PID,VZV)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO,:DOG_CPH,
                                     :reason_uwol,
                                     :nameprof,:kodzkpptr,:kodkp,:namedol, :pid,'');

        end
*/
    -- Совместители
     for
          select kk.tabno, kk.fio, kk.nal_code,kk.data_pri,kk.data_uw,kk.code_uwol,
                 pr.nomerprik,pr.dataprik,coalesce(pr.idclassificator,0),
                 substr(pr.kodkp,1,6),substr(pr.kodzkpptr,1,5), coalesce(pr.namedol,''), coalesce(pr.nameprof,'')
                 ,coalesce(pr.databeg,'1900-01-01'),coalesce(pr.dataend,'1900-01-01')
                 from kadry kk
                 join tb_prikazy pr on kk.tabno=pr.tabno
                 where pr.y=:y
                   and pr.m=:m
                   and  (
                             not pr.content is null
                         and (upper(pr.content) like '%СУМІС%')
                         and (upper(pr.content) like '%ПРИЙНЯТИ%')
                        )

                 into :tabno,:fio,:nal_code, :data_pri,:data_uw,:code_uwol,
                  :nomerprik,:dataprik,:idclassificator,
                  :kodkp ,:kodzkpptr,:namedol,:nameprof
                  ,:databeg,:dataend
     do
        begin

             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);


             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             dog_cph  = 0;   -- Договор подряда для стороннего
                             -- 0 - нет 1 -да
             code_uwol=coalesce(code_uwol,0);

             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from databeg)=y)
                 and (extract(month from databeg)=m)) then
               start_d=coalesce((extract(day from databeg)),0);
             if ((extract(year from dataend)=y)
                  and (extract(month from dataend)=m)) then
                end_d=coalesce((extract(day from databeg)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             rownum=rownum+1;
             ZO=2;
             reason_uwol=null;
             pid='';
             dataprik=coalesce(dataprik,'1900-01-01');
             nomerprik=coalesce(nomerprik,'');
             if ((extract(year from dataprik)>2017)
                and
                (strlen(trim(nomerprik))>0)) then
                pid='Приказ '||trim(nomerprik)||' від '||case
                                                           when extract(day from dataprik)<10 then '0'||extract(day from dataprik)
                                                           else extract(day from dataprik)
                                                         end
                                                        ||'.'||
                                                         case
                                                             when extract(month from dataprik)<10 then '0'||extract(month from dataprik)
                                                             else extract(month from dataprik)
                                                         end
                                                        ||'.'||extract(year from dataprik);
             if (strlen(nameprof)>250) then
                 nameprof=substr(nameprof,1,250);
             if (strlen(nameprof)>250) then
                 nameprof=substr(nameprof,1,250);
             if (strlen(namedol)>250) then
                 namedol=substr(namedol,1,250);
             if (strlen(pid)>250) then
                 pid=substr(pid,1,250);
             if (strlen(reason_uwol)>150) then
                 reason_uwol=substr(reason_uwol,1,150);
             insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO, DOG_CPH,
                                     PID_ZV,
                                     PNR,ZKPP,PROF,POS,PID,VZV)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO,:DOG_CPH,
                                     :reason_uwol,
                                     :nameprof,:kodzkpptr,:kodkp,:namedol, :pid,'');

        end


     for
                 select person.tabno
               , kadry.fio
               , kadry.nal_code
               , tb_dogovora_gn_det.datefr
               , tb_dogovora_gn_det.dateto
               , kadry.code_uwol
--               , fcn.prim
               , tb_dogovora_gn.nomer
               , tb_dogovora_gn_det.reasonok
                 from kadry
                 join person on person.tabno=kadry.tabno
                 join fcn on fcn.shifridperson=person.shifrid
                 join tb_dogovora_gn_det on tb_dogovora_gn_det.id=fcn.prim
                 join tb_dogovora_gn on tb_dogovora_gn.id=tb_dogovora_gn_det.iddog
                 where (fcn.shifrsta=173+500)
                   and (person.yearvy=:y and person.monthvy=:m)
                 into :tabno,:fio,:nal_code, :data_pri,:data_uw,:code_uwol,
                      :nomerdog,:reasonok
     do
        begin

             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d  = 0;
             end_d    = 0;
             pol      = 0;      -- женщина
             dog_cph  = 1;   -- Договор подряда для стороннего
                             -- 0 - нет 1 -да
             code_uwol=coalesce(code_uwol,0);
             if (strlen(trim(nal_code))=10) then
                begin
                     d=substr(nal_code, 9,1);
                     if (d in ('1','3','5','7','9')) then
                        pol = 1;   -- мужчина
                end
             else
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from data_pri)=y)
                 and (extract(month from data_pri)=m)) then
                start_d=coalesce((extract(day from data_pri)),0);
             if ((extract(year from data_uw)=y)
                  and (extract(month from data_uw)=m)) then
                end_d=coalesce((extract(day from data_uw)),0);
             ukr_gromad=1;
             if (exists (select * from tb_notukrgromad where tabno=:tabno)) then
                ukr_gromad=0;
             rownum=rownum+1;
             ZO=2;  -- трудовая книжка не на предприятии
             reason_uwol=reasonok;

             insert into tb_E04t05C (yearvy,monthvy,tabno,period_m,period_y,
                                     rownum, ukr_gromad, numident, fio, nm,
                                     ftn,START_DT,END_DT, NRM_DT, ZO, DOG_CPH,
                                     PID_ZV)
                             values (:y,    :m,    :tabno,:m,      :y,
                                     :rownum,:ukr_gromad,:nal_code, :fam, :nam,
                                     :otc, :start_d, :end_d, :nrm_dt, :ZO,:DOG_CPH,
                                     :reason_uwol);
        end

  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE PR_FILL_KOMAND_OLD
RETURNS (
    K INTEGER)
AS
declare variable SHIFRIDKMND integer;
declare variable SHIFRIDB integer;
declare variable SHIFRIDBRES integer;
declare variable SHIFRIDKRES integer;
declare variable SHIFRIDBSUM integer;
declare variable SHIFRIDKSUM integer;
declare variable SHIFRIDBA integer;
declare variable SHIFRIDKA integer;
begin
     k=0;
     delete from tb_komand;
     for 
        select  a.shifrid from boln a
               where a.mode_ill=10
               into :shifridb
     do
       begin
            shifridkmnd=gen_id(g_komand,1);
            k=k+1;
            insert into tb_komand(
                   SHIFRID    , TABNO        , NAL_CODE     , FIO         , W_PLACE      ,
                   SHIFRKAT   , SHIFRGRU     , F_DATA       , F_MONTH     , F_YEAR       ,
                   L_DATA     , L_MONTH      , L_YEAR       , WID_RAB     , DATA_VY      ,
                   MONTH_VY   , YEAR_VY      , OKLAD        , K_WO_DAY    , SHIFR_STA    ,
                   MEAN_DAY   , MEAN_DAY_BUD , MEAN_DAY_VNE , MEAN_DAY_GN , MEAN_DAY_NIS ,
                   SUMMA_KMD  , SUMMA_KMD_B  , SUMMA_KMD_V  , SUMMA_KMD_G , SUMMA_KMD_N  ,
                   DATA_P_BUD , DATA_P_VNE   , DATA_P_GN    , DATA_P_NIS  , MODE_V_Z     ,
                   SHIFRBUH

            )
            select :shifridkmnd, TABNO        , NAL_CODE     , FIO         , W_PLACE      ,
                   SHIFRKAT   , SHIFRGRU     , F_DATA       , F_MONTH     , F_YEAR       ,
                   L_DATA     , L_MONTH      , L_YEAR       , WID_RAB     , DATA_VY      ,
                   MONTH_VY   , YEAR_VY      , OKLAD        , K_WO_DAY    , SHIFR_STA    ,
                   MEAN_DAY   , MEAN_DAY_BUD , MEAN_DAY_VNE , MEAN_DAY_GN , MEAN_DAY_NIS ,
                   SUMMA_BOL  , SUMMA_BOL_B  , SUMMA_BOL_V  , SUMMA_BOL_G , SUMMA_BOL_N  ,
                   DATA_P_BUD , DATA_P_VNE   , DATA_P_GN    , DATA_P_NIS  , MODE_V_Z     ,
                   SHIFRBUH
            from boln
                 where shifrid=:shifridb;


            for
               select a.shifrid from boln_res a
                                where a.shifridboln=:shifridb
                                into :shifridbres

            do
              begin
                   shifridkres=gen_id(g_komand_res,1);
                   insert into tb_komand_res (
                          SHIFRID  , SHIFRIDKMND , SHIFRSTA    , K_DAY      ,  MONTH_ZA    ,
                          YEAR_ZA  , SUMMA_K_BUD , SUMMA_K_VNE , SUMMA_K_GN , SUMMA_K_NIS  ,
                          SHIFRWRK , DATEWRK     , SUMMAZARL   , NEEDMOV
                   )
                   select
                          :shifridkres  , :shifridkmnd , SHIFRSTA , B_DAY   ,  MONTH_ZA    ,
                          YEAR_ZA  , SUMMA_B_BUD , SUMMA_B_VNE , SUMMA_B_GN , SUMMA_B_NIS  ,
                          SHIFRWRK , DATEWRK     , 0.00        , 0
                     from boln_res
                     where shifrid=:shifridbres;


              end

            for
               select a.shifrid from boln_summy a
                                where a.shifridboln=:shifridb
                                into :shifridbsum

            do
              begin
                   shifridksum=gen_id(g_komand_summy,1);
                   insert into tb_komand_summy (
                          SHIFRID   , SHIFRIDKMND , SEL      , MONTH_ZA  ,  YEAR_ZA ,
                          SUMMA_BUD , SUMMA_VNE   , SUMMA_GN , SUMMA_NIS , OKLAD_M  ,
                          DAYS      , GRAPHIC_DAY , KOEF     , SHIFRWRK  , DATEWRK  ,
                          MANUAL_CALC
                   )
                   select
                          :shifridksum  , :shifridkmnd , SEL , MONTH_ZA  ,  YEAR_ZA ,
                          SUMMA_BUD , SUMMA_VNE   , SUMMA_GN , SUMMA_NIS , OKLAD_M  ,
                          DAYS      , GRAPHIC_DAY , KOEF     , SHIFRWRK  , DATEWRK  ,
                          MANUAL_CALC
                     from boln_summy
                     where shifrid=:shifridbsum;

                   for
                      select shifrid from bolna a
                                     where a.shifridboln      = :shifridb
                                       and a.shifridbolnsummy = :shifridbsum
                                     plan (a index(bolna_IDX2))
                                     into :shifridba
                   do
                     begin
                          shifridka=gen_id(g_komand_add,1);
                          insert into tb_komand_add (
                                 SHIFRID  , SHIFRIDKMND , SHIFRIDKMNDSUMMY , W_PLACE  , W_R     ,
                                 SHIFRGRU , SHIFRKAT    , SHIFRSTA         , MONTH_ZA , YEAR_ZA ,
                                 MONTH_VY , YEAR_VY     , SUMMA            , VYPL     , MARKED  ,
                                 SHIFRWRK , DATEWRK     , TABNO
                          )
                          select
                                 :shifridka , :shifridkmnd , :shifridksum , W_PLACE  , W_R     ,
                                 SHIFRGRU   , SHIFRKAT     , SHIFRSTA     , MONTH_ZA , YEAR_ZA ,
                                 MONTH_VY   , YEAR_VY      , SUMMA        , VYPL     , MARKED  ,
                                 SHIFRWRK   , DATEWRK      , TABNO                                from bolna
                          where shifrid=:shifridba;
                     end





              end

       end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_FILL_P04T05B (
    Y INTEGER,
    M INTEGER)
AS
declare variable tabno integer;
declare variable fio varchar(120);
declare variable fam varchar(50);
declare variable nam varchar(50);
declare variable otc varchar(50);
declare variable data_pri date;
declare variable data_uw date;
declare variable start_d integer;
declare variable end_d integer;
declare variable nal_code varchar(10);
declare variable shifrnf integer;
declare variable s varchar(20);
declare variable i integer;
begin
     DELETE FROM tb_p04t05b where yearvy=:y and monthvy=:m;
     for 
/*
          select tabno, nal_code,fio, data_pri,data_uw from kadry
                 where (extract(year from kadry.data_pri)=:y and extract(month from kadry.data_pri)=:m) or
                       (extract(year from kadry.data_uw)=:y and extract(month from kadry.data_uw)=:m)
                 into :tabno,:fio,:nal_code, :data_pri,:data_uw
*/
          select tabno, fio, nal_code,data_pri,data_uw from kadry
                 where (extract(year from kadry.data_pri)=:y and extract(month from kadry.data_pri)=:m) or
                       (extract(year from kadry.data_uw)=:y and extract(month from kadry.data_uw)=:m)
                 into :tabno,:fio,:nal_code, :data_pri,:data_uw
     do
        begin
             execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
             fam=upper(fam);
             nam=upper(nam);
             otc=upper(otc);
             start_d=0;
             end_d=0;
             if (strlen(trim(nal_code))<>10) then
                begin
                     select first 1 idcode from tb_bk
                            where tabno=:tabno
                            into :nal_code;
                     if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                        begin
                             shifrnf=gen_id(g_p4_nf, 1);
                             nal_code='БКНН000000';
                             s=shifrnf;
                             s=trim(s);
                             i=strlen(s);
                             nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                        end
                end
             if ((extract(year from data_pri)=y)
                 and (extract(month from data_pri)=m)) then
                start_d=coalesce((extract(day from data_pri)),0);
             if ((extract(year from data_uw)=y)
                  and (extract(month from data_uw)=m)) then
                end_d=coalesce((extract(day from data_uw)),0);
             insert into tb_p04t05b (yearvy,monthvy,tabno,numident,fio,nm,ftn,START_DT,END_DT)
                    values (:y, :m,:tabno, :nal_code,:fam, :nam,:otc, :start_d, :end_d);
        end

  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE PR_FILL_PERS_PERSON_IND (
    TABNO INTEGER,
    Y INTEGER,
    SHIFRIDANK INTEGER,
    TIN VARCHAR(10),
    KRPOU VARCHAR(12),
    DATEPRI DATE,
    DATEUW DATE,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
declare variable I integer;
declare variable OTK integer;
declare variable PERIOD integer;
declare variable SZP decimal(15,2);
declare variable SVR decimal(15,2);
declare variable SVZ decimal(15,2);
declare variable INVALID integer;
declare variable SUMMA decimal(15,2);
declare variable SUMMABOLN decimal(15,2);
declare variable MUSOR integer;
declare variable KAL_DAY integer;
declare variable DATEC date;
declare variable P decimal(15,3);
declare variable SUMMAPENSRAS decimal(15,2);
declare variable PENSIONER integer;
declare variable KTSZ varchar(10);
declare variable DATEB date;
declare variable DATEE date;
declare variable KD integer;
declare variable KM integer;
declare variable KMZ integer;
declare variable L integer;
declare variable MINPERIOD integer;
declare variable MAXPERIOD integer;
declare variable SHIFRIDIND integer;
declare variable KMR integer;
declare variable KMZLAST integer;
declare variable ISRCNZNT integer;
begin
   /* FORCED_MODE 0 - как получится 1 - преподаватель 2 - не преподаватель*/
     i=gen_id(g_apm, 1);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and person.tabno=:tabno and person.yearvy=:y)) then
        otk=0;
     shifridind=i;
     insert into tb_apm_ind (ktf,shifrid,shifridank,dpr,dzr,tin,krpou,Zvit_r,Zvit_p,Splat_r,otk)
            values(1,:shifridind,:ShifrIdAnk, :DatePri,:DateUw,:tin,:krpou,:y, 0,:Y,:otk);
     svr       =  0 ;
     svz       =  0 ;
     invalid   =  0 ;
     minperiod = 12 ;
     maxperiod =  0 ;
     for
        select fadd.month_za,sum(fadd.summa),
--               sum(case when fadd.shifrsta in (12,14,15,16) then fadd.summa else 0.00 end) from fadd
               sum(case when fadd.shifrsta in (12,14,15) then fadd.summa else 0.00 end) from fadd
               where fadd.year_za=:y and fadd.tabno=:tabno
                     and fadd.shifrsta not in (31,32,7,44)            -- материальную помощь не включать
                                                                      -- декретный больничеый не включать
                                                                      -- пособие до 3-х лет
                                                                      -- внесено в кассу
                     and fadd.w_place not in (106,165)                -- 106 материальная помощь подразделение пособие до 3-х лет
                     and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                           -- все
                          (:WantedKat=1 and (select retval from pr_is_sciped(fadd.shifridperson,0)) =1) or    -- ППС
                          (:WantedKat=2 and (select retval from pr_is_sciped(fadd.shifridperson,0)) =0 ))     -- не ППС
               group by 1
               having sum(fadd.summa)>0.01
               into :period, :summa,:summaboln
     do
       begin
            if (minperiod>period) then
               minperiod=period;
            if (maxperiod<period) then
               maxperiod=period;
---Подсчет количества календарных дней
            dateb=y||'-'||period||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||period||'-'||l;
            DateC=DateB;
            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||period||'-'||musor;
                   if (datec between DatePri and DateUw) then
                      Kal_Day=Kal_Day+1;
              end
            if (Kal_Day>l) then
                Kal_Day=l;
            DateC=y||'-'||period||'-10';
            select first 1 a.limitpens from penshea a
                           where a.datefr<:DateC
                           order by a.datefr desc
                           into :p;
            if (Summa>p) then
               szp=p;
            else
               szp=summa;
            svr=svr+Summa;
       --     select first 1 Summapens from pens(:tabno,:Y,:Period, :Summa) into :SummaPensRas;
       --     Взносы в пенсионный фонд -------
            select sum(fud.summa) from fud
                   where fud.year_za=:y
                         and fud.tabno=:tabno
                         and fud.shifrsta in (75)
                         and fud.month_za=:period
                         and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                     -- все
                              (:WantedKat=1 and (select retval from pr_is_sciped(fud.shifridperson,0)) =1) or  -- ППС
                              (:WantedKat=2 and (select retval from pr_is_sciped(fud.shifridperson,0)) =0))   -- не ППС
                   into :SummaPensRas;
    ----------------------------------------------------------------------------
            svz=svz+:SummaPensRas;
            invalid=0;
            if (exists (select * from fcn where fcn.tabno=:tabno and fcn.month_vy=:period and fcn.year_vy=:y and fcn.shifrsta in (112,112+500))) then
               invalid=1;
            pensioner=0;
            if (exists (select * from fcn where fcn.tabno=:tabno and fcn.month_vy=:period and fcn.year_vy=:y and fcn.shifrsta in (107,107+500))) then
               pensioner=1;
            if (summa>0.01 or szp>0.01 or summaboln>0.01 or SummaPensRas>0.01  ) then
               begin
                     if (kal_day=0) then
                        kal_day=l;
                     insert into tb_apm_ind_body(shifridind,period,sz,szp,sl,spd,kd,isinvalid,ispensioner)
                            values(:i, :period,:summa,:szp,:summaboln,:SummaPensRas,:kal_day,:invalid,:pensioner);
               end
       end
--     настройка дат приема и увольнения
       if ((minperiod between 1 and 12) and minperiod<>extract(month from :datepri)) then
               DatePri=Y||'-'||minperiod||'-01';
       if ((maxperiod between 1 and 12) and maxperiod<>extract(month from :dateuw)) then
          begin
               DateUw=Y||'-'||maxperiod||'-01';
               select first 1 l from lenmonth(:DateUw) into :l;
               DateUw=Y||'-'||maxperiod||'-'||l;
          end
       if (DateUw<=DatePri) then
          DateUw=DatePri+1;
       update tb_apm_ind set
          dpr=:DatePri,
          dzr=:DateUw
          where shifrid=:ShifrIdInd;
-- Конец корректировки дат
       KTSZ      = '1';
       pensioner =  0;
       invalid   =  0;
       if (exists (select * from tb_apm_ind_body where tb_apm_ind_body.shifridind  =:i and tb_apm_ind_body.isinvalid=1)) then
          invalid=1;
       pensioner=0;
       if (exists (select * from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i and tb_apm_ind_body.ispensioner=1)) then
          pensioner=1;
       p=0.332;
       IF (invalid=1) then
          begin
               KTSZ     = '2';
               p        = 0.04;
          end
/*
          ind:SZ  = ind:sz1+ind:sz2+ind:sz3+ind:sz4+ind:sz5+ind:sz6+ind:sz7+ind:sz8+ind:sz9+ind:sz10+ind:sz11+ind:sz12
          ind:SL  = ind:sL1+ind:sL2+ind:sL3+ind:sL4+ind:sL5+ind:sL6+ind:sL7+ind:sL8+ind:sL9+ind:sL10+ind:sL11+ind:sL12
          ind:SZP = ind:szP1+ind:szP2+ind:szP3+ind:szP4+ind:szP5+ind:szP6+ind:szP7+ind:szP8+ind:szP9+ind:szP10+ind:szP11+ind:szP12
          ind:SP  = ind:sPD1+ind:sPD2+ind:sPD3+ind:sPD4+ind:sPD5+ind:sPD6+ind:sPD7+ind:sPD8+ind:sPD9+ind:sPD10+ind:sPD11+ind:sPD12
          ind:KD  = ind:KD1+ind:KD2+ind:KD3+ind:KD4+ind:KD5+ind:KD6+ind:KD7+ind:KD8+ind:KD9+ind:KD10+ind:KD11+ind:KD12
!          ind:SVR = round(a$*p$,0.01)
   !       ind:SVR = round(ind:SZP*p$,0.01)
          ind:SVZ = ind:sp
 */
       -- Подсчет стажа
       Musor = 0;
       km    = 0;
       kd    = 0;
       while (Musor<12) do
         begin
              Musor=Musor+1;
              dateb=y||'-'||Musor||'-01';
              select first 1 l from lenmonth(:dateb) into :l;
              datee=y||'-'||musor||'-'||l;
              if (DatePri<=DateB and DateUw>=DateE) then
                 km=km+1;
              if (DatePri<=DateB and DateUw<DateE and DateUw>DateB) then
                 kd=kd+extract(day from DateUw);
              if (DatePri>DateB and DateUw>=DateE) then
                 kd=kd+(extract(day from DateE)-extract(day from DatePri)+1);
              if (DatePri>DateB and DateUw<DateE) then
                 kd=kd+(extract(day from DateUw)-extract(day from DatePri)+1);
         end
       if (kd>28) then
          begin
               km=km+1;
               kd=0;
          end
       if (km>12) then
          begin
               km=12;
               kd=0;
          end
 --- Подсчет количество месяцев оплаты
       select count(*) from tb_apm_ind_body
            where tb_apm_ind_body.shifridind=:shifridind and
                  tb_apm_ind_body.spd>0.005
            into kmr;
       if (kmr<km) then
           km=kmr;
 -------------------------------------
       update tb_apm_ind set
        sz          = (select sum(sz)  from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i) ,
        sl          = (select sum(sl)  from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i) ,
        szp         = (select sum(szp) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        sp          = (select sum(spd) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        kd          = (select sum(kd)  from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        svz         = sp,
        svr         = (select sum(cast((szp*:p) as decimal(15,2))) from tb_apm_ind_body where tb_apm_ind_body.shifridind=:i),
        ktsz        = :ktsz,
        isinvalid   = :invalid,
        ispensioner = :pensioner,
        kpm         = :km,
        kpd         = :kd,
        rnpd        = 0,
        npd         = 0,
        dfd         = (:Y+1)||'-01-10',
        kpfu        = '',
        nzv         = '',
        kop         = '',
        toz         = ''
        where shifrid=:i;

        if (forced_mode in (0,1)) then
        if ((WantedKat=0) or (WantedKat=1)) then
           begin
                musor = 0;
                kmz   = 0;
                while (musor<12) do
                  begin
                       musor=musor+1;
--                       if (exists (select * from person
--                                     where person.tabno=:tabno and person.yearvy=:y
--                                           and person.monthvy=:musor and person.shifrkat=1
--                                           and (select sum(summa) from fadd where fadd.shifridperson=person.shifrid) >0)) then
                       if (exists (select * from fadd
                                     where fadd.tabno=:tabno and fadd.year_za=:y
                                           and fadd.shifrsta not in (31,32,7)                              -- материальную помощь не включать
                                           and fadd.month_za=:musor
                                           and ((select retval from pr_is_sciped(fadd.shifridperson,0))=1 or :Forced_Mode=1)    -- ППС
                                           and fadd.summa>0.01
                                           and fadd.w_place not in (81,76,105,106,121,140,165))) then
                       kmz=kmz+1;
                  end
                if (kmz>12) then
                   kmz=12;
                if (kmz>km) then
                   kmz=km;
--   Извлечь последний период получения научной суммы kmzlast
                select first 1 fadd.month_za from fadd
                       where fadd.tabno=:tabno and fadd.year_za=:y
                             and fadd.shifrsta not in (31,32,7)    -- материальную помощь не включать
                             and ((select retval from pr_is_sciped(fadd.shifridperson,0))=1 or :Forced_Mode=1)    -- ППС
                             and fadd.w_place not in (81,76,105,106,121,140,165)
                             and fadd.summa>0.01
                       group by 1
                       order by 1 desc
                       into :kmzlast;
                       if ((kmzlast is null) or (kmzlast not between 1 and 12)) then
                          kmzlast=kmz;


--                       if (exists (select * from fadd
--                                     where fadd.tabno=:tabno and fadd.year_za=:y
--                                           and fadd.shifrsta not in (31)                        -- материальную помощь не включать
--                                          and fadd.month_za=:musor and fadd.shifrkat in (1,3)
--                                           and fadd.summa>0.01)) then

               -- Рецензентам не давать научный стаж
               IsRcnznt=0;
               select count(*) from tb_apm_ind_body
                       where tb_apm_ind_body.shifridind=:shifridind into :musor;
                if (musor=1) then
                   begin
                         if (exists (select * from person
                                      where person.yearvy=:y and
                                            person.tabno=:tabno and
                                            person.w_place=121)) then
                            IsRcnznt=1;
                   end
                if (IsRcnznt=0) then
                if (Kmz>0) then
                   insert into tb_apm_ind_ss (ShifrIdInd,Kplg,Kmz,Ksl,Ssm,Nsl)
                          values (:i,'ЗНТ024А1',:kmzlast,'1',:Kmz,:Kmz);
           end
       delete from  tb_apm_ind
              where tb_apm_ind.shifrid=:shifridind and
                    tb_apm_ind.svr = 0 and
                    tb_apm_ind.svz = 0 and
                    tb_apm_ind.sz  = 0 and
                    tb_apm_ind.kpm = 0 and
                    tb_apm_ind.kpd = 0;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_FILL_REEB_SUM (
    SHIFRID INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SUMMA decimal(15,2);
declare variable SUMMASS decimal(15,2);
declare variable SUMMAPODSS decimal(15,2);
declare variable SUMMAECBSS decimal(15,2);
declare variable SUMMABANKSS decimal(15,2);
declare variable CNTB integer;
begin
/*
     for
         select shifrid from boln
                 where boln.shifridreb=:shifrid
                 into :shifridb
     do
        begin
              for
                  select shifrid from boln_res
                         where boln_res.shifridboln=:shifridb
                           and boln_res.shifrsta<>12
                         into :ShifrIdr
              do
                begin
                     update boln_res
                            set
                               summa_e_bud = summa_b_bud * 0.02,
                               summa_e_vne = summa_b_vne * 0.02,
                               summa_e_gn  = summa_b_gn  * 0.02,
                               summa_e_nis = summa_b_nis * 0.02
                            where shifrid=:Shifridr;
                     update boln_res
                            set
                               summa_p_bud = (summa_b_bud - summa_e_bud) * 0.15,
                               summa_p_vne = (summa_b_vne - summa_e_vne) * 0.15,
                               summa_p_gn  = (summa_b_gn  - summa_e_gn ) * 0.15,
                               summa_p_nis = (summa_b_nis - summa_e_nis) * 0.15
                            where shifrid=:Shifridr;
                     update boln_res
                            set
                               summa_ba_bud = summa_b_bud - Summa_p_bud - Summa_e_bud,
                               summa_ba_vne = summa_b_vne - Summa_p_vne - Summa_e_vne,
                               summa_ba_gn  = summa_b_gn  - Summa_p_gn  - Summa_e_gn ,
                               summa_ba_nis = summa_b_nis - Summa_p_nis - Summa_e_nis
                            where shifrid=:Shifridr;
                end
        end
*/
  /* Procedure Text */
  select count(*) from tb_ree_boln_det b
         where b.Shifridree=:shifrid
         into :cntb;
  select sum(b.summa) from tb_ree_boln_det b
         where b.Shifridree=:shifrid
         into :summa;
  select sum(b.summass),
         sum(b.summapodss),
         sum(b.summaecbss),
         sum(b.summabankss)
   from tb_ree_boln_det b
         where b.Shifridree=:shifrid
         into :summass,:summapodss,:summaecbss,:summabankss;
  update tb_ree_boln
         set
            tb_ree_boln.summa       = :summa       ,
            tb_ree_boln.summass     = :summass     ,
            tb_ree_boln.summapodss  = :summapodss  ,
            tb_ree_boln.summaecbss  = :summaecbss  ,
            tb_ree_boln.summabankss = :summabankss ,
            tb_ree_boln.nmbofbln    = :cntb
      where shifrid=:shifrid;
  retval=1;
  suspend;
end^


ALTER PROCEDURE PR_FONDY (
    Y INTEGER,
    MFR INTEGER,
    MTO INTEGER,
    SHIFRGRU INTEGER)
RETURNS (
    RAZR INTEGER,
    NMBOFSTW DECIMAL(15,2),
    NMBOFPERS DECIMAL(15,2),
    SUMMAFOP DECIMAL(15,2),
    SUMMAOKL DECIMAL(15,2),
    SUMMADOPLO DECIMAL(15,2),
    SUMMADOPLN DECIMAL(15,2),
    SUMMAPREM DECIMAL(15,2),
    SUMMADOMIN DECIMAL(15,2),
    SUMMAOTH DECIMAL(15,2),
    SUMMAPREM102 DECIMAL(15,2))
AS
begin
   RAZR=0;
   update fadd set sch=null where year_vy=:y and shifrgru=:shifrgru;
   WHILE (razr BETWEEN 0 AND 24) DO
    BEGIN
         RAZR         = RAZR + 1;
      --   if (razr>1) then leave;
         NMBOFSTW     = 0;
         NMBOFPERS    = 0;
         SUMMAFOP     = 0;
         SUMMAOKL     = 0;
         SUMMADOPLO   = 0;
         SUMMADOPLN   = 0;
         SUMMAPREM    = 0;
         SUMMADOMIN   = 0;
         SUMMAOTH     = 0;
         SUMMAPREM102 = 0;
         SELECT count(distinct p.tabno) FROM PERSON P
                WHERE
                     P.shifrgru=:shifrgru
                 and (
                  ((select first 1 razrijad from pr_get_razr_p_by_id_for_swod(p.shifrid))=:razr)
                 or
                 ((select first 1 razrijad from pr_get_razr_p_by_dolg_for_swod(p.shifrid))=:razr)
                 )
             --    and (select sum(fa.summa) from fadd fa
             --       where fa.shifridperson=p.shifrid
             --    )>10.0
                 and coalesce(p.oklad,0.00)>1.0
                 AND P.yearvy=:Y
                 AND P.monthvy = :MFR
            INTO :nmbofpers;
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 AND A.SHIFRSTA=1
            INTO :summaokl;
         UPDATE fadd fo
                set sch='okl'
                WHERE
                     fo.shifrgru=:shifrgru
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(fo.shifridperson,'OKL'))=:razr
                 AND fo.sch is null
                 AND fo.year_vy=:Y
                 AND fo.month_vy BETWEEN :MFR AND :MTO
                 AND fo.SHIFRSTA=1;

         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (7 -- доплата за выслугу
                       ,8   -- надбавка за выслугу лет
                       ,17  -- за почетное звание
                       ,18  -- за ученую степень
                       ,22  -- за учетное звание
                       ,41  -- за зав кафедрой
                       ,42  -- за зам декана
                       ,47  -- за декана
                       ,159
                       )
            INTO :summadoplo;
         UPDATE FADD fdo
                set sch='doplo'
                WHERE
                     fdo.shifrgru=:shifrgru
                 AND fdo.sch is null
                 AND fdo.year_vy=:Y
                 AND fdo.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(fdo.shifridperson,'OKL'))=:razr
                 AND FDO.SHIFRSTA in (7 -- доплата за выслугу
                       ,8   -- надбавка за выслугу лет
                       ,17  -- за почетное звание
                       ,18  -- за ученую степень
                       ,22  -- за учетное звание
                       ,41  -- за зав кафедрой
                       ,42  -- за зам декана
                       ,47  -- за декана
                       ,159
                       );
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (24 -- персональная надбавка
                                   ,26    --персональная надбавка НИС
                                   ,30 -- надбавка к зарплате
                                   ,33 -- доплата к зарплате
                                   ,39 -- праздничные
                                   ,40 -- ночные
                                   ,169 -- доплала до мин 2,5 %
                                   ,171 -- донорские
                                   )
            INTO :summadopln;
         update FADD fdn
            set sch='dopln'
                WHERE
                     fdn.shifrgru=:shifrgru
                 AND fdn.sch is null
                 AND fdn.year_vy=:Y
                 AND fdn.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(fdn.shifridperson,'OKL'))=:razr
                 AND fdn.SHIFRSTA in (24 -- персональная надбавка
                                   ,26    --персональная надбавка НИС
                                   ,30 -- надбавка к зарплате
                                   ,33 -- доплата к зарплате
                                   ,39 -- праздничные
                                   ,40 -- ночные
                                   ,169 -- доплала до мин 2,5 %
                                   ,171 -- донорские
                                   );
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (34)
            INTO :summadomin;
         UPDATE FADD FDM
                SET SCH='FDM'
                WHERE
                     FDM.shifrgru=:shifrgru
                 AND fDM.sch is null
                 AND FDM.year_vy=:Y
                 AND FDM.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_person_for_swod(fdm.shifridperson,'OKL'))=:razr
                 AND FDM.SHIFRSTA in (34);
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (2,3)
                 and not a.w_place in (102)
            INTO :summaprem;
         UPDATE FADD FDP
                SET SCH='PREM'
                WHERE
                     FDP.shifrgru=:shifrgru
                 AND fdp.sch is null
                 AND FDP.year_vy=:Y
                 AND FDP.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(fdp.shifridperson,'OKL'))=:razr
                 AND FDP.SHIFRSTA in (2,3)
                 and not FDP.w_place in (102);
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (2,3)
                 and a.w_place in (102)
            INTO :summaprem102;
         update FADD f102
                set sch='102'
                WHERE
                     f102.shifrgru=:shifrgru
                 AND f102.sch is null
                 AND f102.year_vy=:Y
                 AND f102.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(f102.shifridperson,'OKL'))=:razr
                 AND f102.SHIFRSTA in (2,3)
                 and f102.w_place in (102);
         SELECT SUM(A.SUMMA) FROM FADD A
                JOIN PERSON P ON P.shifrid=A.shifridperson
                WHERE
                     P.shifrgru=:shifrgru
                 and a.sch is null
                 AND P.yearvy=:Y
                 AND P.monthvy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(a.shifridperson,'OKL'))=:razr
                 AND A.SHIFRSTA in (5,6   --отпускные
                                   ,9     --оздоровление
                                   ,10,11 --учебные отпуска
                                   ,12    --больничные 5 дней
                                   ,20    --помощь к отпуску на оздоровление
                                   ,28    --индексация
                                 )
            INTO :summaoth;
         update FADD foth
                set sch='oth'
                WHERE
                     foth.shifrgru=:shifrgru
                 AND foth.sch is null
                 AND foth.year_vy=:Y
                 AND foth.month_vy BETWEEN :MFR AND :MTO
                 and (select first 1 razrijad from pr_get_razr_p_for_swod(foth.shifridperson,'OKL'))=:razr
                 AND foth.SHIFRSTA in (5,6   --отпускные
                                   ,9     --оздоровление
                                   ,10,11 --учебные отпуска
                                   ,12    --больничные 5 дней
                                   ,20    --помощь к отпуску на оздоровление
                                   ,28    --индексация
                                 );

         suspend;
    END
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GEN_AGE_REPORT (
    Y INTEGER,
    M INTEGER)
RETURNS (
    YOUNGMAN DECIMAL(10,2),
    YOUNGWOMAN DECIMAL(10,2),
    MANS DECIMAL(10,2),
    WOMANS DECIMAL(10,2),
    PENSMAN DECIMAL(10,2),
    PENSWOMAN DECIMAL(10,2))
AS
declare variable TABNO integer;
declare variable YANGDATE date;
declare variable MANPENSDATE date;
declare variable WOMANPENSDATE date;
declare variable PERSONBIRHTDATE date;
declare variable ISWOMAN integer;
declare variable NAL_CODE varchar(10);
declare variable C char(1);
declare variable KOEF decimal(15,2);
declare variable FIO varchar(30);
begin
     yangdate      = '1978-01-01' ;
     manpensdate   = '1953-01-01' ;
     womanpensdate = '1958-01-01' ;
     youngman      = 0;
     youngwoman    = 0;
     mans          = 0;
     womans        = 0;
     pensman       = 0;
     penswoman     = 0;
     for
        select  a.tabno,a.nal_code,(select first 1 coalesce(koef,0) from pr_get_koef_person_by_id(p.shifrid)),p.fio from kadry a
                join person p on p.tabno=a.tabno
               where p.yearvy  = :y
                 and p.monthvy = :m
                 and p.w_place not in (76,79,81,82,85,86,87,89,91,98,101,102,105,106,121,140,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168)
                 and p.shifrkat in (1,3,5)
                 and p.oklad>0
                 and p.shifrgru<>1
                 and (select first 1 shifrwr from pr_isosnwrbyid(p.shifrid))<>1
                 and (select sum(f.summa) from fadd f
                                        where f.shifridperson=p.shifrid
                                          and f.shifrsta=1)>0.01
                 and char_length(trim(a.nal_code))=10
               into :tabno,:nal_code,:koef,:fio
     do
       begin
             if (koef is null) then koef=0;
             if (tabno=29) then
                 tabno=29;
             personbirhtdate=null;
             personbirhtdate=addday('1900-01-01',cast(substr(:nal_code,1,5) as integer)-1);
          --//   select addday('1900-01-01',cast(substr(a.nal_code,1,5) as integer)-1) from kadry a
          --          where a.tabno=:tabno
          --          into :personbirhtdate;
             iswoman=0;
             c='1';
             c=substr(nal_code, 9,9);
             if ( c in ('0','2','4','6','8')) then iswoman=1;
             if (personbirhtdate>=yangdate) then
                if (iswoman=1) then youngwoman=youngwoman+koef;
                else youngman=youngman+koef;
             else if (personbirhtdate>=iif(iswoman=1,womanpensdate,manpensdate)) then
                      if (iswoman=1) then womans=womans+koef;
                      else mans=mans+koef;
             else
                 if (iswoman=1) then penswoman=penswoman+koef;
                                else pensman=pensman+koef;

       end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GEN_KREDIT_SPR (
    TABNO INTEGER,
    DOLG VARCHAR(100))
RETURNS (
    SHIFRID INTEGER)
AS
declare variable FIO varchar(100);
declare variable I integer;
declare variable SUMMA decimal(15,2);
declare variable NOMER integer;
declare variable CURRDATE date;
declare variable Y integer;
declare variable M integer;
declare variable SUMMAUD decimal(15,2);
declare variable REKTOR varchar(250);
declare variable GLBUH varchar(250);
begin
     shifrid=gen_id(g_kredit_spr, 1);
     select first 1 fio from kadry where kadry.tabno=:tabno into :fio;
     select count(*) from tb_kredit_spr into  :i;
     if (i>0) then
        select max(nomer) from tb_kredit_spr into :nomer;
     else
        nomer=0;
     nomer=nomer+1;
     rektor = null;
     glbuh  = null;
     select first 1 name from tb_param a
            where a.codemes=1
            order by a.datefr desc
            into :rektor;
     rektor=coalesce(rektor, 'Голубенко О.Л.');
     select first 1 name from tb_param a
            where a.codemes=2
            order by a.datefr desc
            into :glbuh;
     glbuh=coalesce(glbuh, 'Бєлоусова Л.І.');
     if (strlen(ltrim(rtrim(dolg)))=0 or (dolg is null) ) then
        select first 1 a.dolg from PR_GET_DOLG_PERSON(:tabno) a into :dolg;
     INSERT INTO tb_kredit_spr (SHIFRID,NOMER,DATEFR,TABNO,FIO,DOLG,
                                SUMMATOT,Y,RUKOWODIT,GLBUH) VALUES (
                                :shifrid,:nomer, CURRENT_DATE,:tabno,:fio,:dolg,
                                0,extract(year from CURRENT_DATE),trim(:rektor),trim(:glbuh));
     i=0;
     currdate=current_date;
     y=extract(year from currdate);
     m=extract(month from currdate);
     while (i<6) do
      begin
            i=i+1;
            m=m-1;
            if (m<1) then
               begin
                    m=12;
                    y=y-1;
               end
            summa=0;
            select  sum(fadd.summa)from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where person.tabno=:tabno and
                         (
                           (shifrsta in (5,6,12,14,15,32) and (year_za=:y and month_za=:m)) or
                           (
                            (shifrsta not in (5,6,12,14,15,32)) and
                            (((:y<2011)  and (year_za=:y and month_za=:m)) or
                             ((:y>=2011) and (year_vy=:y and month_vy=:m)))
                           )
                         )
--                   fadd.year_za=:y and fadd.month_za=:m
                   into summa;
            if (summa is null) then
                summa=0;
            summaud=0;
            select  sum(fud.summa)from fud
                   join person on fud.shifridperson=person.shifrid
                   where person.tabno=:tabno and fud.year_za=:y and fud.month_za=:m
                         and fud.shifrsta not in (51,52,53,67,69,70,76,77,78,80,86,87,91,102,103,104,123,124,125,131,132,133,134,135,136)
                   into summaud;
            if (summaud is null) then
                summaud=0;
            insert into tb_kredit_spr_pr(shifridowner,y, m,summa)
                   values (:shifrid,:y,:m,:summa-:summaud);
      end
     select sum(summa) from tb_kredit_spr_pr
            where tb_kredit_spr_pr.shifridowner  =:shifrid
            into :summa;

     update tb_kredit_spr
       set summatot=:summa
       where shifrid=:shifrid;
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GEN_NEW_SBS_SPR (
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    MODE_ZA_VY INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable FIO varchar(150);
declare variable NAL_CODE varchar(10);
declare variable SHIFRIDPERSON integer;
declare variable SHIFRPOD integer;
declare variable SHIFRDOL integer;
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_R integer;
declare variable NAME_W_R varchar(15);
declare variable NAMEDOL varchar(40);
declare variable SHIFRID integer;
declare variable BUH_NAME varchar(50);
declare variable SHIFRWRK integer;
declare variable PROREKTOR varchar(50);
declare variable GLBUH varchar(50);
declare variable M1 varchar(15);
declare variable M2 varchar(15);
begin
  /* Procedure Text */
  retval=0;
  select first 1 a.fio,a.nal_code from kadry a
                       where a.tabno=:tabno
                       into :fio,:nal_code;
  select first 1 a.shifrid,a.w_place from person a
                           where a.tabno=:tabno
                           and a.yearvy=extract(year from :l_data)
                           and a.monthvy=extract(month from :l_data)
                           and a.w_r=1
                           into :shifridperson,:shifrpod;
  shifridperson=coalesce(shifridperson,0);
  if (shifridperson=0) then exit;
  if (shifrpod in (82,121,140,156,164)) then
     select first 1 a.shifrid,a.w_place from person a
                           where a.tabno=:tabno
                           and a.w_r=2
                           and a.w_place not in (82,121,140,156,164)
                           and a.yearvy=extract(year from :l_data)
                           and a.monthvy=extract(month from :l_data)
                           into :shifridperson,:shifrpod;
  shifridperson=coalesce(shifridperson,0);
  if (shifridperson=0) then exit;
     select first 1 a.shifrgru,a.shifrkat,a.w_r from person a
                           where a.shifrid=:shifridperson
                           into :shifrgru,:shifrkat,:w_r;
  if (w_r=1) then
     name_w_r='основна';
  else
     name_w_r='за суміцтвом';
  select first 1 a.prim from  fcn a
                        where a.shifridperson=:shifridperson
                        and a.shifrsta in (100,100+500)
                        into :shifrdol;
  shifrdol=coalesce(shifrdol,0);
   select first 1 dolg from pr_get_dolg_person(:tabno) into namedol;
  namedol=coalesce(namedol,'');
  namedol=trim(namedol);
 -- select first 1 fio from tb_sbs_param where shifrid=1 into prorektor;
  select first 1 name from tb_param a where a.codemes=1 order by a.datefr desc into prorektor;
  prorektor=coalesce(prorektor,'О.Л.Голубенко');
  prorektor=trim(prorektor);
--  prorektor=coalesce(prorektor,'Смірний М.Ф.');
  select first 1 name from tb_param a where shifrid=2 order by a.datefr desc into glbuh;
  glbuh=coalesce(glbuh,'Л.І.Бєлоусова');
  glbuh=trim(glbuh);

  select first 1 retval from PR_GETMONTHNAMEUKR(extract(month from :f_data)) into m1;
  select first 1 retval from PR_GETMONTHNAMEUKR(extract(month from :l_data)) into m2;
  m1=coalesce(m1,'не вказан');
  m2=coalesce(m2,'не вказан');
  shifrid=gen_id(g_sbs_spr,1);
  insert into tb_sprsbstable (shifrid) values (:shifrid);
  select first 1 shifrwrk from tb_sprsbstable where shifrid=:shifrid into :shifrwrk;
  select first 1 fio from pr_getfioope(:shifrwrk) into :buh_name;

  update tb_sprsbstable
         set tabno    = :tabno, 
             nal_code = :nal_code,
             fio      = :fio,
             w_place  = :shifrpod,
             shifr_kat= :shifrkat,
             shifr_gru= :shifrgru,
             data_vy  = current_date,
             month_vy = extract(month from current_date),
             year_vy  = extract(year from current_date),
             mode_vy_za=:mode_za_vy,
             buh_name = trim(:buh_name),
             dolg     = :namedol,
             w_r_name = :name_w_r,
             kod_w_r  = :w_r,
             summa_prop = ' ',
             summa_tot= 0,
             period   = trim(:m1)||' '||extract(year from :f_data)||' - '||trim(:m2)||' '||extract(year from :l_data),
             f_data   = :f_data,
             l_data   = :l_data,
             prorektor= :prorektor,
             gl_buh   = :glbuh,
             f_month  = extract(month from :f_data),
             f_year   = extract(year from :f_data),
             l_month  = extract(month from :l_data),
             l_year   = extract(year from :l_data)
         where shifrid=:shifrid;
  execute procedure PR_gen_sbs_Spr(:shifrid);
  retval=shifrid;
  suspend;
end^


ALTER PROCEDURE PR_GEN_RENEW_SBS_SPR (
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    MODE_ZA_VY INTEGER,
    SHIFRIDSBS INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
  /* Procedure Text */
  retval=0;
  delete from tb_sprsbsprtable where shifridowner=:shifridsbs;
  update tb_sprsbstable
         set f_data   = :f_data,
             l_data   = :l_data,
             f_month  = extract(month from :f_data),
             f_year   = extract(year from :f_data),
             l_month  = extract(month from :l_data),
             l_year   = extract(year from :l_data),
             mode_vy_za = :mode_za_vy
         where shifrid=:shifridsbs;
  execute procedure PR_gen_sbs_Spr(:shifridsbs);
  retval=shifridsbs;
  suspend;
end^


ALTER PROCEDURE PR_GEN_SBS_FOR_PERIOD (
    TABNO INTEGER,
    DATAZA DATE,
    MODE_ZA_VY INTEGER,
    SHIFRIDSBS INTEGER)
AS
declare variable Y integer;
declare variable M integer;
declare variable SHIFRIDPR integer;
begin
  /* Procedure Text */
     y=extract(year from :dataza);
     m=extract(month from :dataza);
     delete from tb_sprsbsprtable a
            where a.shifridowner=:shifridsbs and
                  a.year_za=:y and
                  a.month_za=:m;
     insert into tb_sprsbsprtable (SHIFRIDOWNER,YEAR_ZA,MONTH_ZA,
                                   SUMMA,SUMMA_ZARPL,SUMMA_VNE,SUMMA_ALIM)
            values (:shifridsbs,:y, :m,0,0,0,0);
     select first 1 a.shifrid  from tb_sprsbsprtable a
                               where a.shifridowner=:shifridsbs and
                                     a.year_za=:y and
                                     a.month_za=:m
                               into :shifridpr;

     insert into tb_sbs_sad_table (SHIFRIDOWNER,TABNO,W_PLACE,W_R,SHIFRGRU,
                                   SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,MONTH_VY,YEAR_VY,
                                   SUMMA,WDAY,WCLOCK,FOND,VYPL,SCH,MARK)
                  select :shifridpr,:tabno,a.w_place,a.w_r,a.shifrgru,
                         a.shifrkat,a.shifrsta,a.month_za,a.year_za,a.month_vy,a.year_vy,
                         a.summa,a.wday,a.wclock,a.fond,a.vypl,a.sch,1
                         from fadd a
                         where a.tabno=:tabno and
                               a.shifrsta not in (44) and  -- внесено в кассу
                               (
                                (:mode_za_vy=1 and a.year_za=:y and a.month_za=:m)
                                or
                                (:mode_za_vy=2 and
                                   (
                                     (a.year_vy=:y and a.month_vy=:m and a.year_za=:y and a.month_za=:y) or
                                     (a.year_vy=:y and a.month_vy=:m and a.shifrsta not in (12,14,15,5,6,10,11,19,32)) or
                                     (a.year_za=:y and a.month_za=:m and a.shifrsta in (12,14,15,5,6,10,11,19,32))
                                   )
                                 )

                               );
     insert into tb_sbs_sud_table (SHIFRIDOWNER,TABNO,W_PLACE,W_R,SHIFRGRU,
                                   SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,MONTH_VY,YEAR_VY,
                                   SUMMA,VYPL,MARK)
                  select :shifridpr,:tabno,a.w_place,a.w_r,a.shifrgru,
                         a.shifrkat,a.shifrsta,a.month_za,a.year_za,a.month_vy,a.year_vy,
                         a.summa,a.vypl,1
                         from fud a
                         where a.tabno=:tabno and
                               a.shifrsta in (55,56,57,58) and  -- алименты
                               (
                                (:mode_za_vy=1 and a.year_za=:y and a.month_za=:m)
                                or
                                (:mode_za_vy=2 and a.year_vy=:y and a.month_vy=:m)
                               );
end^


ALTER PROCEDURE PR_GEN_SBS_SPR (
    SHIFRIDSBS INTEGER)
AS
declare variable DT date;
declare variable Y integer;
declare variable M integer;
declare variable MODE_ZA_VY integer;
declare variable LAST_DT date;
declare variable TABNO integer;
declare variable SUMMA_PROP varchar(400);
declare variable SUMMA_TOT decimal(15,2);
declare variable DATEFR date;
declare variable DATETO date;
declare variable M1 varchar(15);
declare variable M2 varchar(15);
begin
  /* Procedure Text */

  select first 1 a.f_data,a.mode_vy_za,a.l_data,a.tabno,a.f_data,a.l_data from tb_sprsbstable a
                                       where a.shifrid=:shifridsbs
                                       into :dt,:mode_za_vy,:last_dt,:tabno,:datefr,:dateto;
  dt=extract(year from dt)||'-'||extract(month from dt)||'-01';
  last_dt=extract(year from last_dt)||'-'||extract(month from last_dt)||'-01';
  while (dt<=last_dt) do
   begin
        execute procedure pr_gen_sbs_for_period(:tabno, :dt, :mode_za_vy,:shifridsbs);
        execute procedure pr_sbs_calc_for_period(:dt, :shifridsbs);
        y=extract(year from dt);
        m=extract(month from dt);
        m=m+1;
        if (m>12) then
           begin
                m=1;
                y=y+1;
           end
        dt=y||'-'||m||'-01';
   end
  select sum(coalesce(b.summa,0))-sum(coalesce(b.summa_alim,0)) from tb_sprsbsprtable b
                      where b.shifridowner=:shifridsbs
                      into :summa_tot;
  select first 1 a.number_str from NUMBER_STRING_UKR(:summa_tot) a
         into :summa_prop;
  select first 1 retval from PR_GETMONTHNAMEUKR(extract(month from :datefr)) into m1;
  select first 1 retval from PR_GETMONTHNAMEUKR(extract(month from :dateto)) into m2;
  m1=coalesce(m1,'не вказан');
  m2=coalesce(m2,'не вказан');
  update tb_sprsbstable a
         set a.summa_tot=:summa_tot,
             a.summa_prop=:summa_prop
     where a.shifrid=:shifridsbs;

end^


ALTER PROCEDURE PR_GEN_Y_SPR (
    TABNO INTEGER,
    Y INTEGER,
    MODE_ZA INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
declare variable FIO varchar(100);
declare variable I integer;
declare variable SUMMAADD decimal(15,2);
declare variable SUMMAPODOH decimal(15,2);
declare variable SUMMAECB decimal(15,2);
declare variable SUMMAADD1 decimal(15,2);
declare variable SUMMAADD2 decimal(15,2);
declare variable SUMMAADD3 decimal(15,2);
declare variable SUMMAPOD1 decimal(15,2);
declare variable SUMMAPOD2 decimal(15,2);
declare variable SUMMAPOD3 decimal(15,2);
declare variable M integer;
declare variable L integer;
declare variable SUMMAADDC decimal(15,2);
declare variable SUMMAPODC decimal(15,2);
declare variable REKTOR varchar(50);
declare variable GLBUH varchar(50);
begin
/* Исправлена 17 01 2017 военный сбор вместо ЕСВ */

     shifrid=gen_id(g_y_spr, 1);
     select first 1 fio from kadry where kadry.tabno=:tabno into :fio;
     select first 1 name from tb_param a where a.codemes=1 order by a.datefr desc into rektor;
     rektor=coalesce(rektor,'О.Л.Голубенко');
     rektor=trim(rektor);
--  prorektor=coalesce(prorektor,'Смірний М.Ф.');
     select first 1 name from tb_param a where shifrid=2 order by a.datefr desc into glbuh;
     glbuh=coalesce(glbuh,'Л.І.Бєлоусова');
     glbuh=trim(glbuh);

     INSERT INTO tb_spr_zarpl (SHIFRID,TABNO,Y,FIO,SUMMATOT,SUMMAPODOHTOT,
                               DIREKTOR,GLBUH,DATAPRINT,DATAFR,mode_za) VALUES (
                               :shifrid,:tabno,:y, :fio,0.0,0.0,
                               trim(:rektor),trim(:glbuh),current_date, current_date,:mode_za);
     i=0;
     while (i<12) do
      begin
            i=i+1;
            summaadd=0;
            select  sum(fadd.summa)from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where person.tabno=:tabno and
                   (
                     (
                      fadd.year_za=:y and fadd.month_za=:i and :mode_za=1 -- За
                     ) or (
--                      fadd.year_vy=:y and fadd.month_vy=:i and :mode_za=2 -- в
----------------------   05 12 2011
                         (
                           (fadd.shifrsta in (5,6,12,14,15,32) and (fadd.year_za=:y and fadd.month_za=:i)) or
                           (
                            (fadd.shifrsta not in (5,6,12,14,15,32)) and
                            (((:y<2011)  and (fadd.year_za=:y and fadd.month_za=:i)) or
                             ((:y>=2011) and (fadd.year_vy=:y and fadd.month_vy=:i)))
                           )
                         ) and :mode_za=2 --- в
----------------------
                     )
                   )
                   into summaadd;
            if (summaadd is null) then
                summaadd=0;
            summapodoh=0;
            summaecb=0;
            select  sum(case
                            when fud.shifrsta=50 then fud.summa
                            else 0
                        end),
                    sum(case
                            when fud.shifrsta<>50  then fud.summa
                            else 0
                        end)

                             from fud
                    join person on fud.shifridperson=person.shifrid
                    where person.tabno=:tabno
         --           and fud.shifrsta in (50,142,143,145,146)
                    and fud.shifrsta in (50,161)
                    and
                    (
                     (
                      fud.year_za=:y and fud.month_za=:i and :mode_za=1 -- За
                     ) or (
                           (:mode_za=2) and
                           ((:y>2010) and (fud.year_za=:y and fud.month_za=:i) )
                           or (
                               (:y<2011) and fud.year_vy=:y and fud.month_vy=:i and :mode_za=2
                              )
                           )    -- в
                    )
                    into summapodoh,summaecb;
            summapodoh=coalesce(summapodoh, 0);
            summaecb=coalesce(summaecb, 0);
            insert into tb_spr_zarpl_pr(shifridowner,period,summaadd, summapod,summaecb)
                   values (:shifrid,:i,:summaadd, :summapodoh,:summaecb);
      end
     select sum(summaadd),sum(summapod),sum(summaecb) from tb_spr_zarpl_pr
            where tb_spr_zarpl_pr.shifridowner=:shifrid
            into :summaadd,:summapodoh,:summaecb;

     update tb_spr_zarpl
       set summatot      = :summaadd,
           summapodohtot = :summapodoh,
           summaecbtot   = :summaecb
       where shifrid=:shifrid;

  /* взять данные в 1DF*/
    summaadd1=null;
    summaadd2=null;
    summaadd3=null;
    summapod1=null;
    summapod2=null;
    summapod3=null;
    for
       select a.m,sum(a.summaadd1),sum(a.summaadd2),sum(a.summaadd3), sum(a.summapod1),sum(a.summapod2),sum(a.summapod3) from tb_1df a
        where a.tabno=:tabno
        and a.y=:y
        group by 1
        into :m,:summaadd1, :summaadd2, :summaAdd3,
                :summapod1,  :summapod2, :summaPod3
    do
      begin
           i=case
              when m in (1,2,3)  then 0
              when m in (4,5,6)  then 3
              when m in (7,8,9)  then 6
              else 9
             end;
           l=i+3;
           while (i<l) do
            begin
                 i=i+1;
                 summaaddc=case
                               when i in (1,4,7,10) then summaadd1
                               when i in (2,5,8,11) then summaadd2
                               else summaadd3
                          end;
                 summapodc=case
                               when i in (1,4,7,10) then summapod1
                               when i in (2,5,8,11) then summapod2
                               else summapod3
                          end;
                 update tb_spr_zarpl_pr
                    set summaadd=:summaaddc, 
                        summapod=:summapodc
                  where shifridowner=:shifrid
                    and period=:i;
            end

      end
 /*
    update tb_spr_zarpl_pr
       set summaecb=0
     where shifridowner=:shifrid;
     --  and period=:m;
*/
/*
  --  тепер военный сбор 17 01 2017
  -- Взять ЕСБ из персонофикации
    for
       select  b.monthvy,sum(b.sum_ins) from tb_e04t06c b
                where b.tabno  = :tabno
                  and b.yearvy = :y
                  and b.monthvy between 1 and 12
                group by 1
                into :m,:summaecb
    do
      begin
           update tb_spr_zarpl_pr
              set summaecb=:summaecb
            where shifridowner=:shifrid
              and period=:m;

      end
 */

     select sum(summaadd),sum(summapod),sum(summaecb) from tb_spr_zarpl_pr
            where tb_spr_zarpl_pr.shifridowner=:shifrid
            into :summaadd,:summapodoh,:summaecb;

     update tb_spr_zarpl
       set summatot      = :summaadd,
           summapodohtot = :summapodoh,
           summaecbtot   = :summaecb
       where shifrid=:shifrid;
  /* конец вставки */

     -- 163 7562 21 нужно  22 1401 по 29 01 25 р б 14 а берет 13
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_BASE_DATA_FOR_IND (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    DATAB DATE)
AS
declare variable DATEW date;
declare variable BASEM integer;
declare variable BASEY integer;
begin
       datew=y||'-'||m||'-15';
       basem = null;
       basey = null;
       select first 1 cast(c.summa as integer),c.prim from fcn c
                      join person a on a.shifrid=c.shifridperson
                      where c.tabno    = :tabno
                        and a.w_place not in (81,82,102,140)
                        and (select shifriddolg from pr_get_dolg_person_by_id(a.shifrid)) not in (4,5,6,7,8,9,1455,1500,1510,1520,1530)
                        and c.month_vy = :m
                        and c.year_vy  = :y
                        and c.shifrsta in (137,137+500)
                        and coalesce(a.main,1)<>0
                      into :basem, :basey;
       basem=coalesce(basem,0);
       if (basem not between 1 and 12) then basem=0;
       basey=coalesce(basey,0);
       if (basey not between 2008 and 2020) then basey=0;
       datab=current_date;
       if (basem>0 and basey>0) then
          datab=basey||'-'||basem||'-15';   -- базовая дата сотрудника



  suspend;
end^


ALTER PROCEDURE PR_GET_BOLN_DAY (
    SHIFRKATBOLN INTEGER,
    SHIFRID INTEGER)
RETURNS (
    N_DAY INTEGER)
AS
declare variable summa_bud decimal(15,2);
declare variable summa_vne decimal(15,2);
declare variable summa_gn decimal(15,2);
declare variable summa_nis decimal(15,2);
declare variable b_day integer;
declare variable summa decimal(15,2);
declare variable day_bud integer;
declare variable day_vne integer;
declare variable day_gn integer;
declare variable day_nis integer;
declare variable day_s integer;
begin
     n_day=0;
     select first 1 boln_res.summa_b_bud,
                    boln_res.summa_b_vne,
                    boln_res.summa_b_gn ,
                    boln_res.summa_b_nis,
                    boln_res.b_day
                    from boln_res where boln_res.shifrid=:shifrid
                    into
                        summa_bud,summa_vne,summa_gn,summa_nis,b_day;
     summa=summa_bud + summa_vne + summa_gn + summa_nis;
     if ((b_day>0) and (summa>0.01)) then
        if (not ((shifrkatboln=1 and summa_bud<0.01) or
                 (shifrkatboln=2 and summa_vne<0.01) or
                 (shifrkatboln=3 and summa_gn <0.01)  or
                 (shifrkatboln=4 and summa_nis<0.01))) then
           begin
                day_bud = cast(b_day as decimal(15,2))*summa_bud /summa;
                day_vne = cast(b_day as decimal(15,2))*summa_vne /summa;
                day_gn  = cast(b_day as decimal(15,2))*summa_gn  /summa;
                day_nis = cast(b_day as decimal(15,2))*summa_nis /summa;
                day_s   = day_bud+day_vne+day_gn+day_nis;
                if (day_s<b_day) then
                   begin
                   if ((day_bud>=day_vne) and
                       (day_bud>=day_gn)  and
                       (day_bud>=day_nis)) then  day_bud=day_bud+1;
                   else
                      if ((day_vne>=day_bud) and
                          (day_vne>=day_gn)  and
                          (day_vne>=day_nis)) then  day_vne=day_vne+1;
                      else
                         if ((day_gn>=day_bud)  and
                             (day_gn>=day_vne)  and
                             (day_gn>=day_nis)) then  day_gn=day_gn+1;
                         else
                             if ((day_nis>=day_bud)  and
                                 (day_nis>=day_vne)  and
                                 (day_nis>=day_gn)) then  day_nis=day_nis+1;
                   end
                else
                if (day_s>b_day) then
                   begin
                   if ((day_bud>=day_vne) and
                       (day_bud>=day_gn)  and
                       (day_bud>=day_nis)) then  day_bud=day_bud-1;
                   else
                      if ((day_vne>=day_bud) and
                          (day_vne>=day_gn)  and
                          (day_vne>=day_nis)) then  day_vne=day_vne-1;
                      else
                         if ((day_gn>=day_bud)  and
                             (day_gn>=day_vne)  and
                             (day_gn>=day_nis)) then  day_gn=day_gn-1;
                         else
                             if ((day_nis>=day_bud)  and
                                 (day_nis>=day_vne)  and
                                 (day_nis>=day_gn)) then  day_nis=day_nis-1;
                   end
                if ((day_bud=0) and (day_vne>1) and (summa_bud>0.01)) then
                   begin
                         Day_bud=1;
                         Day_Vne=Day_Vne-1;
                   end
                else
                   if ((day_vne=0) and (day_bud>1) and (summa_vne>0.01)) then
                      begin
                            Day_vne=1;
                            Day_bud=Day_bud-1;
                      end

                if (shifrkatboln=1) then n_day=day_bud;
                 else
                 if (shifrkatboln=2) then n_day=day_vne;
                 else
                   if (shifrkatboln=3) then n_day=day_gn;
                   else n_day=day_nis;
                /*
                 then n_day=case
                        when shifrkatboln=1 then day_bud
                        when shifrkatboln=2 then day_vne
                        when shifrkatboln=3 then day_gn
                        else day_nis
                      end;
                       */
           end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_BUH_ACC_PODR
RETURNS (
    SHIFRPOD INTEGER)
AS
declare variable shifrpra integer;
declare variable need integer;
declare variable shifrwrk integer;
begin
     for
        select podr.shifrpod from podr
               order by podr.shifrpod
               into :shifrpod
     do
       begin
             select first 1 shifrpra from currshifrpra
                    into :shifrpra;
             need=0;
             if ((shifrpra is not null) and (shifrpra>2)) then
                need=1;
             if (need<>1) then
                begin
                     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
                     if (shifrwrk is null) then shifrwrk=0;
                     if (exists (select * from tb_buh_access
                                          where shifrbuh=:shifrwrk and
                                                shifrpod=:shifrpod)) then need=1;
                end
             if (need=1) then
                suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_BUH_BAY_PODR_LIST
RETURNS (
    SHIFRPOD INTEGER)
AS
declare variable shifrwrk integer;
begin
     SHifrWrk=null;
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
     if (shifrwrk is null) then shifrwrk=0;
     if (ShifrWrk>0) then
        for
           select ShifrPod from bay where ShifrBuh=:ShifrWrk
                  order by bay.shifrpod
                  into :shifrpod
        do
               suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_BUH_DOP_PODR_LIST
RETURNS (
    SHIFRPOD INTEGER)
AS
declare variable shifrwrk integer;
begin
     SHifrWrk=null;
     select first 1 shifrwrk from currshifrwrk into :shifrwrk;
--     ShifrWrk=14;
     if (shifrwrk is null) then shifrwrk=0;
     if (ShifrWrk>0) then
        for
           select ShifrPod from tb_buh_dop_podr where ShifrBuh=:ShifrWrk
                  order by tb_buh_dop_podr.shifrpod
                  into :shifrpod
        do
               suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_DOLG_ID_PERSON_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRDOL INTEGER)
AS
declare variable I integer;
declare variable SHIFRPOD integer;
begin
     shifrdol=0;
     i=0;
     select first 1 fcn.prim,person.w_place from fcn
            join person on fcn.shifridperson=person.shifrid
            where person.yearvy=:y and person.monthvy=:m and person.w_r=1 and
                  person.tabno=:tabno and
                  fcn.shifrsta in (100,100+500)
            into :i,:shifrpod;
     if (shifrpod in (82,156) ) then
        select first 1 fcn.prim,person.w_place from fcn
               join person on fcn.shifridperson=person.shifrid
               where person.yearvy=:y and person.monthvy=:m and -- person.w_r=1 and
                     person.tabno=:tabno and
                     fcn.shifrsta in (100,100+500) and
                     person.w_place not in (82,156)
               into :i,:shifrpod;
     shifrpod=coalesce(shifrpod,0);
     i=coalesce(i, 0);
     shifrdol = i;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_DOLG_PERSON (
    TABNO INTEGER)
RETURNS (
    DOLG VARCHAR(100))
AS
declare variable Y integer;
declare variable M integer;
declare variable I integer;
declare variable SHIFRPOD integer;
begin
     dolg='';
     y=extract(year from current_date);
     m=extract(month from current_date);
     m=m-1;
     if (m<0) then
        begin
             y = y - 1;
             m = 12;
        end
     i=0;
     select first 1 fcn.prim,person.w_place from fcn
            join person on fcn.shifridperson=person.shifrid
            where person.yearvy=:y and person.monthvy=:m and person.w_r=1 and
                  person.tabno=:tabno and
                  fcn.shifrsta in (100,100+500)
            into :i,:shifrpod;
     if (shifrpod in (82,156) ) then
        select first 1 fcn.prim,person.w_place from fcn
               join person on fcn.shifridperson=person.shifrid
               where person.yearvy=:y and person.monthvy=:m and -- person.w_r=1 and
                     person.tabno=:tabno and
                     fcn.shifrsta in (100,100+500) and
                     person.w_place not in (82,156)
               into :i,:shifrpod;
     shifrpod=coalesce(shifrpod,0);
     i=coalesce(i, 0);
     if (i>0) then
        begin
             select first 1 tb_dolg.name from tb_dolg where tb_dolg.shifrdol=:i
                    into :dolg;
        end
     if (dolg is null) then
         dolg='';
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_DOLG_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    SHIFRIDDOLG INTEGER)
AS
begin
     select first 1 fcn.prim from fcn
            where fcn.shifridperson=:shifrid and
                  fcn.shifrsta in (100,100+500)
            into :shifriddolg;
     shifriddolg=coalesce(shifriddolg,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_DOLG_PERSON_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    DOLG VARCHAR(100))
AS
declare variable I integer;
declare variable SHIFRPOD integer;
begin
     dolg='';
     /*
   --  y=extract(year from current_date);
   --  m=extract(month from current_date);
     m=m-1;
     if (m<0) then
        begin
             y = y - 1;
             m = 12;
        end
        */
     i=0;
     select first 1 fcn.prim,person.w_place from fcn
            join person on fcn.shifridperson=person.shifrid
            where person.yearvy=:y and person.monthvy=:m and person.w_r=1 and
                  person.tabno=:tabno and
                  fcn.shifrsta in (100,100+500)
            into :i,:shifrpod;
     if (shifrpod in (82,156) ) then
        select first 1 fcn.prim,person.w_place from fcn
               join person on fcn.shifridperson=person.shifrid
               where person.yearvy=:y and person.monthvy=:m and -- person.w_r=1 and
                     person.tabno=:tabno and
                     fcn.shifrsta in (100,100+500) and
                     person.w_place not in (82,156)
               into :i,:shifrpod;
     shifrpod=coalesce(shifrpod,0);
     i=coalesce(i, 0);
     if (i>0) then
        begin
             select first 1 tb_dolg.name from tb_dolg where tb_dolg.shifrdol=:i
                    into :dolg;
        end
     if (dolg is null) then
         dolg='';
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_FNO_PERSON (
    FIO VARCHAR(120))
RETURNS (
    F VARCHAR(50),
    N VARCHAR(50),
    O VARCHAR(50))
AS
declare variable L integer;
declare variable I integer;
declare variable C integer;
declare variable CH char(1);
declare variable FIO_V varchar(120);
begin
     F='';
     N='';
     O='';
     L=strlen(fio);
     fio_v=trim(fio);
     fio_v=replace(fio_v, '   ',' ');
     fio_v=replace(fio_v, '  ',' ');
     if (l>0) then
        begin
              i=0;
              c=1;
              while (i<L) do
               begin
                    i=i+1;
                    ch=substrlen(fio_v,i,1);
                    if (ch not in ('.',',')) then
                       begin
                            if (ch=' ') then
                               c=c+1;
                            else
                                if (c=1) then f=trim(f)||ch;
                                else if (c=2) then n=trim(n)||ch;
                                     else if (c=3) then o=trim(o)||ch;
                       end
               end
        end
end^


ALTER PROCEDURE PR_GET_GT_2660 (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    MODE INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO CHAR(51),
    NAL_CODE CHAR(10),
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_PREV DECIMAL(15,2),
    PENSLIMIT DECIMAL(15,2))
AS
begin
     select first 1 c.limitmax from sslimity c
            where c.datefr<=cast(:yearvy||'-'||:monthvy||'-01' as date)
            order by c.datefr desc
            into :penslimit;
     if (penslimit is null) then
         penslimit=0;
     for
        select a.tabno,c.fio,c.nal_code,sum(a.summa),
               sum(case when a.shifrgru=1 then a.summa else 0 end),
               sum(case when a.shifrgru in (3,4,16) then a.summa else 0 end)
               from fadd a
               join person b on a.shifridperson=b.shifrid
               join kadry c on c.tabno=b.tabno
               where (:mode<>1 and a.year_vy=:yearvy and a.month_vy=:monthvy) or
                     (:mode=1 and a.year_za=:yearvy and a.month_za=:monthvy)
               group by 1,2,3
               having sum(a.summa)>:PensLimit
               order by 4 desc
               into :tabno,:fio,:nal_code ,:summa, :summa_bud, :summa_gn
     do
       begin
            summa_vne=summa-summa_bud-summa_gn;
            summa_prev=summa-penslimit;
            suspend;
       end
end^


ALTER PROCEDURE PR_GET_GT_2660_CMP (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    MODE INTEGER)
RETURNS (
    PERIOD INTEGER,
    TABNO INTEGER,
    FIO CHAR(51),
    NAL_CODE CHAR(10),
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_PREV DECIMAL(15,2),
    PENSLIMIT DECIMAL(15,2),
    SUMMA_OP DECIMAL(15,2),
    SUMMA_PREV_OP DECIMAL(15,2))
AS
begin
     select first 1 c.limitmax from sslimity c
            where c.datefr<=cast(:yearvy||'-'||:monthvy||'-01' as date)
            order by c.datefr desc
            into :penslimit;
     if (penslimit is null) then
         penslimit=0;
     for
        select a.tabno,c.fio,c.nal_code,sum(a.summa),
               sum(case when a.shifrgru=1 then a.summa else 0 end),
               sum(case when a.shifrgru in (3,4,16) then a.summa else 0 end)
               from fadd a
               join person b on a.shifridperson=b.shifrid
               join kadry c on c.tabno=b.tabno
               where (:mode<>1 and a.year_vy=:yearvy and a.month_vy=:monthvy) or
                     (:mode=1 and a.year_za=:yearvy and a.month_za=:monthvy)
               group by 1,2,3
               having sum(a.summa)>:PensLimit
               order by 4 desc
               into :tabno,:fio,:nal_code ,:summa, :summa_bud, :summa_gn
     do
       begin
            summa_vne=summa-summa_bud-summa_gn;
            summa_prev=summa-penslimit;
            summa_op=0;
            summa_prev_op=0;
            select first 1 sum(a.summa)
               from fadd a
               where ((:mode=1 and a.year_vy=:yearvy and a.month_vy=:monthvy) or
                     (:mode<>1 and a.year_za=:yearvy and a.month_za=:monthvy)) and
                     a.tabno=:tabno
               into summa_op;
            if (summa_op>PensLimit) then
               summa_prev_op=summa_op-PensLimit;
            period=Monthvy;
            suspend;
       end
end^


ALTER PROCEDURE PR_GET_KAT_DOLG_PERSON_FOR_Y_M (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SHIFRKAT INTEGER,
    SHIFRDOL INTEGER)
AS
begin
     SHIFRKAT=0;
     SHIFRDOL=0;
     select first 1 fcn.prim,person.shifrkat from fcn
            join person on fcn.shifridperson=person.shifrid
            where person.yearvy=:y and person.monthvy=:m and person.w_r=1 and
                  person.tabno=:tabno and
                  fcn.shifrsta in (100,100+500)   -- код профессии
            into :shifrdol,:shifrkat;
     if (shifrdol is null) then shifrdol=0;
     if (shifrkat is null) then shifrkat=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_KOEF_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2))
AS
begin
     select first 1 b.summa from person a
                         join fcn b on b.shifridperson=a.shifrid
                    where a.shifrid=:shifrid and
                          b.shifrsta in (99,99+500)
                    into :koef;
     koef=coalesce(koef,0);

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_KOEF_PERSON_IND (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    KOEF DECIMAL(15,2),
    KOEFBUD DECIMAL(10,2),
    KOEFVNE DECIMAL(10,2),
    KOEFOSN DECIMAL(10,2),
    KOEFOSNBUD DECIMAL(10,2),
    KOEFOSNVNE DECIMAL(10,2))
AS
declare variable K decimal(10,2);
declare variable SHIFRGRU integer;
declare variable SHIFRIDPERSON integer;
declare variable SHIFRWR integer;
begin
     koef       = 0;
     KOEFBUD    = 0;
     KOEFVNE    = 0;
     koefosn    = 0;
     koefosnbud = 0;
     koefosnvne = 0;
     for
         select b.summa,a.shifrgru,a.shifrid from person a
                         join fcn b on b.shifridperson=a.shifrid
                    where a.monthvy= :m     and
                          a.yearvy = :y     and
                          a.tabno  = :tabno and
                          a.main<>0   and
                          b.shifrsta in (99,99+500) AND
                          not (
                               (a.automatic=2) and ((select sum(c.summa) from fadd c where c.tabno=:tabno and c.year_za=:y and c.month_za=:m and
                                                            ((select first 1 guid from pr_getguid(a.shifrid,0))=
                                                             (select first 1 guid from pr_getguid(c.shifridperson,0)))
                                                    )<1.00)
                          ) and
                          a.w_place not in (76,81,82,98,102,105,106,121,128,140,156,161,164) and
                          (coalesce((select first 1 shifriddolg from pr_get_dolg_person_by_id(a.shifrid)),0) not in (0,4,5,6,7,8,9,1455,1500,1510,1520,1530))   -- 4 - повышение 7 - надбавка  8 - премия
                    into :k,:shifrgru,:shifridperson
     do
       begin
              shifrwr=1;
              shifridperson=coalesce(shifridperson,0);
              select first 1 shifrwr from pr_isosnwrbyid(:shifridperson) into :shifrwr;
              shifrwr=coalesce(shifrwr, 1);
              shifrgru=coalesce(shifrgru,11);
              k    = coalesce(k,0);
              koef = koef+k;
              if (shifrgru=1) then
                 koefbud=koefbud+k;
              else
                 koefvne=koefvne+k;
              if (shifrwr=1) then
                 begin
                      koefosn = koefosn+k;
                      if (shifrgru=1) then
                         koefosnbud=koefosnbud+k;
                      else
                         koefosnvne=koefosnvne+k;
                 end
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_KOEF_PERSON_TMP (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2))
AS
begin
     select first 1 b.summa from tb_tmp_person a
                         join tb_tmp_fcn b on b.shifridperson=a.shifrid
                    where a.shifrid=:shifrid and
                          b.shifrsta in (99,99+500)
                    into :koef;
     koef=coalesce(koef,0);

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_KOEF_RAZR (
    DATAFR DATE,
    CURRDATA DATE,
    MODE INTEGER,
    RAZR INTEGER)
RETURNS (
    KOEF DECIMAL(15,5))
AS
declare variable DATAKOEF date;
declare variable CURRKOEF float;
declare variable INITKOEF float;
declare variable OKLADCURR float;
declare variable OKLADPAST float;
declare variable WKOEF decimal(15,4);
begin
     if (mode=2) then
        begin
             select first 1 a.oklad from tb_razr_proc a
                    where a.datefr <= :DataFr and a.razr=:razr
                    order by a.datefr desc
                    into :okladcurr;
             select first 1 a.oklad from tb_razr_proc a
                    where a.datefr <= :CurrData and a.razr=:razr
                    order by a.datefr desc
                    into :okladpast;
             okladcurr=coalesce(okladcurr, 0);
             okladpast=coalesce(okladpast, 1);
             wkoef=1;
             if (okladpast>1) then
                wkoef= okladcurr / okladpast;
             koef=wkoef;
             suspend;
        end
     else
      begin
     koef=1;
     initkoef=koef;
     for
        select a.datefr from tb_change_razr_grid a
               where a.datefr > :CurrData and
                     a.datefr < :DataFr
               order by a.datefr asc
               into DataKoef
     do
       begin
             select first 1 case when :mode=1 then b.koef_boln else b.koef_otp end
                    from tb_razr_proc b
                    where b.razr=:razr and
                          b.datefr=:datakoef
                    into :CurrKoef;
             if ((CurrKoef is null) or (CurrKoef<1.0)) then
                CurrKoef=1;
             initKoef=initKoef*CurrKoef;
       end
  koef=initkoef;
  suspend;
    end
end^


ALTER PROCEDURE PR_GET_LIMIT_FOR_PENS (
    WANTEDDATA DATE)
RETURNS (
    SUMMALIMITA DECIMAL(15,2))
AS
begin
      select first 1 a.limitmax from sslimity a
                                where a.datefr<:wanteddata
                                order by a.datefr desc
                                into :summalimita;
      summalimita=coalesce(summalimita,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_LIST_PERSON_FOR_RECALC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    NMES INTEGER)
RETURNS (
    YEARVY INTEGER,
    MONTHVY INTEGER,
    W_PLACE INTEGER,
    SHIFRID INTEGER,
    FIO VARCHAR(50),
    DOLG VARCHAR(50),
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    W_R INTEGER,
    M_O_R INTEGER,
    MAIN INTEGER,
    FROMPODR INTEGER,
    OKLAD DECIMAL(15,2),
    AUTOMATIC INTEGER)
AS
begin
     for
         select a.yearvy,a.monthvy, a.shifrid,a.fio,a.dolg,a.shifrkat,a.shifrgru,
                a.w_r,a.m_o_r,a.main,a.frompodr,a.oklad,a.automatic,a.w_place
                 from person a where tabno=:tabno
                  and ((monthvy=:m and yearvy=:y and not (monthvy=:nmes and yearvy=extract(year from current_date))) or
                       (
                         exists (select * from fadd b where b.shifridperson=a.shifrid
                        --        and b.shifrsta in (5,6,10,11,12,14,15,19,32)
                                and (select first 1 retval from pr_isotherperiodecbshifr(b.shifrsta))=1
                                and b.month_za=:m and b.year_za=:y and b.month_vy<>:nmes)
                       ) or
                       (
                         exists (select * from fud c where c.shifridperson=a.shifrid
                                and c.shifrsta in (50,55,56,142,143,144,145,146)
                                and c.month_za=:m and c.year_za=:y and c.month_vy<>:nmes)
                       )
                      )
               into :yearvy,:monthvy,:shifrid,:fio,:dolg,:shifrkat,:shifrgru,
                    :w_r,:m_o_r,:main,:frompodr,:oklad,:automatic,:w_place
     do
        begin
  /* Procedure Text */
             suspend;
        end
end^


ALTER PROCEDURE PR_GET_M_NOT_PR (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
declare variable id integer;
begin
     summa=0;
     select first 1 a.shifrid from person a
       join fcn b on a.shifrid=b.shifridperson
       where a.w_r=1 and
             a.tabno=:tabno and
             a.yearvy=:y and
             a.monthvy=:m and
             b.shifrsta in (100,600) and
             (
              (a.shifrkat not in (1,3) and a.w_place>1) or
              (b.prim not in (10,20,30,40) and a.w_place=1)
             )
       into :id;
     if (id is null or id<1) then Exit;
     select sum(c.summa) from fadd c
      where c.tabno=:tabno and
            c.year_za=2006 and
            c.month_za=:m and
            c.shifrkat not in (1,3)
      into :summa;

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_POD_ECB_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAALIMADD DECIMAL(15,2),
    SUMMAALIMUD DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2))
AS
declare variable SUMMAPODRAS decimal(15,2);
declare variable SUMMAPODRAZN decimal(15,2);
declare variable SUMMAALIMRAS decimal(15,2);
declare variable SUMMALIMRAZ decimal(15,2);
declare variable SUMMAECBNRAS decimal(15,2);
declare variable SUMMAECBNRAZN decimal(15,2);
declare variable SUMMAECBRAS decimal(15,2);
declare variable SUMMAECBDPRAZN decimal(15,2);
declare variable SUMMAECBDPRAS decimal(15,2);
declare variable SUMMAECBRAZN decimal(15,2);
declare variable SUMMAECBILLRAS decimal(15,2);
declare variable SUMMAECBILLRAZN decimal(15,2);
begin
      SUMMAPODADD     = 0;
      SUMMAPODUD      = 0;
      SUMMAALIMADD    = 0;
      SUMMAALIMUD     = 0;
      SUMMAECBADD     = 0;
      SUMMAECBUD      = 0;
      SUMMAECBILLADD  = 0;
      SUMMAECBILLUD   = 0;
      SUMMAPODRAS     = 0;
      SUMMAPODRAZN    = 0;
      SUMMAALIMRAS    = 0;
      SUMMALIMRAZ     = 0;
      SUMMAECBNRAS    = 0;
      SUMMAECBNRAZN   = 0;
      SUMMAECBRAS     = 0;
      SUMMAECBRAZN    = 0;
      SUMMAECBDPRAS   = 0;
      SUMMAECBDPRAZN  = 0;
      SUMMAECBILLRAS  = 0;
      SUMMAECBILLRAZN = 0;


--      if (tabno=9112) then
--      exception  e_p07 summaecbadd;

      select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbnadd, :summaecbnud;
 --     exception  e_p07 summaecbnadd;

      select first 1 SummaECB from ecbn_common(:Tabno,:YearZa,:MonthZa,:SummaEcbNAdd) into :SummaECBnRas;
      SummaECBNRazn=:SummaECBNRas-:SummaECBNUd;
      select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbadd, :summaecbud;
--      exception  e_p07 summaecbadd;

      select first 1 SummaECB from ecb_common(:Tabno,:YearZa,:MonthZa,:SummaEcbAdd,1,0) into :SummaECBRas;
      SummaECBRazn=:SummaECBRas-:SummaECBUd;
      select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbdpadd, :summaecbdpud;
--      exception  e_p07 summaecbadd;

      select first 1 SummaECB from ecbdp_common(:Tabno,:YearZa,:MonthZa,:SummaEcbDpAdd) into :SummaECBDpRas;
      SummaECBDpRazn=:SummaECBDpRas-:SummaECBDpUd;

      select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbilladd, :summaecbillud;
      select first 1 SummaECBIll from ecbill_common(:Tabno,:YearZa,:MonthZa,:SummaEcbIllAdd) into :SummaECBIllRas;
      SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
      select first 1 summaadd,summapod from getpodnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summapodadd, :summapodud;
   --   if (tabno=9112) then
   --   exception  e_p07 summapodadd;
      select first 1 SummaPod from podoh_common(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:summaecbnras+:summaecbras+:summaecbillras,1) into :SummaPodRas;
      SummaPodRazn=:SummaPodRas-:SummaPodUd;
      select first 1 summaadd,summaalim from getalimnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summaalimadd, :summaalimud;
      select first 1 SummaAlim from alim_common(:tabno,:YearZa,:MonthZa, :SummaAlimAdd,1) into :SummaAlimRas;
   --   exception  e_p07 summaecbadd;

  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_POD_PENS_SS_FZ_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAFZADD DECIMAL(15,2),
    SUMMAFZUD DECIMAL(15,2),
    SUMMASSADD DECIMAL(15,2),
    SUMMASSUD DECIMAL(15,2),
    SUMMAPENSADD DECIMAL(15,2),
    SUMMAPENSUD DECIMAL(15,2),
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAALIMADD DECIMAL(15,2),
    SUMMAALIMUD DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2))
AS
declare variable SUMMAFZRAS decimal(15,2);
declare variable SUMMAFZRAZN decimal(15,2);
declare variable SUMMASSRAS decimal(15,2);
declare variable SUMMASSRAZN decimal(15,2);
declare variable SUMMAPENSRAS decimal(15,2);
declare variable SUMMAPENSRAZN decimal(15,2);
declare variable SUMMAPODRAS decimal(15,2);
declare variable SUMMAPODRAZN decimal(15,2);
declare variable SUMMAALIMRAS decimal(15,2);
declare variable SUMMALIMRAZ decimal(15,2);
declare variable SUMMAECBNRAS decimal(15,2);
declare variable SUMMAECBNRAZN decimal(15,2);
declare variable SUMMAECBRAS decimal(15,2);
declare variable SUMMAECBDPRAZN decimal(15,2);
declare variable SUMMAECBDPRAS decimal(15,2);
declare variable SUMMAECBRAZN decimal(15,2);
declare variable SUMMAECBILLRAS decimal(15,2);
declare variable SUMMAECBILLRAZN decimal(15,2);
begin
      summafzadd      = 0;
      SUMMAFZUD       = 0;
      SUMMASSADD      = 0;
      SUMMASSUD       = 0;
      SUMMAPENSADD    = 0;
      SUMMAPENSUD     = 0;
      SUMMAPODADD     = 0;
      SUMMAPODUD      = 0;
      SUMMAALIMADD    = 0;
      SUMMAALIMUD     = 0;
      SUMMAECBADD     = 0;
      SUMMAECBUD      = 0;
      SUMMAECBILLADD  = 0;
      SUMMAECBILLUD   = 0;
      SUMMAFZRAS      = 0;
      SUMMAFZRAZN     = 0;
      SUMMASSRAS      = 0;
      SUMMASSRAZN     = 0;
      SUMMAPENSRAS    = 0;
      SUMMAPENSRAZN   = 0;
      SUMMAPODRAS     = 0;
      SUMMAPODRAZN    = 0;
      SUMMAALIMRAS    = 0;
      SUMMALIMRAZ     = 0;
      SUMMAECBNRAS    = 0;
      SUMMAECBNRAZN   = 0;
      SUMMAECBRAS     = 0;
      SUMMAECBRAZN    = 0;
      SUMMAECBDPRAS   = 0;
      SUMMAECBDPRAZN  = 0;
      SUMMAECBILLRAS  = 0;
      SUMMAECBILLRAZN = 0;


/*
      select first 1 summaadd,summafz from getfznachud_common(:tabno,:yearza,:monthza,1,0,0) into :summafzadd, :summafzud;
      select first 1 SummaFZ from FZ(:SummaFzAdd,:yearza,:MonthZa,:tabno) into :SummaFzRas;
      SummaFZRazn=:SummaFzRas-:SummaFzUd;
      select first 1 summaadd,summass from getssnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summassadd, :summassud;
      select first 1 SummaSS from SS(:SummaSSAdd,:YearZa,:MonthZa) into :SummaSsRas;
      SummaSSRazn=:SummaSSRas-:SummaSSUd;
      select first 1 summaadd,summapens from getpensnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summapensadd, :summapensud;
      select first 1 SummaPens from pens_common(:Tabno,:YearZa,:MonthZa,:SummaPensAdd,1) into :SummaPensRas;
      SummaPensRazn=:SummaPensRas-:SummaPensUd;
*/
--      if (tabno=9112) then
--      exception  e_p07 summaecbadd;

      select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbnadd, :summaecbnud;
 --     exception  e_p07 summaecbnadd;

      select first 1 SummaECB from ecbn_common(:Tabno,:YearZa,:MonthZa,:SummaEcbNAdd) into :SummaECBnRas;
      SummaECBNRazn=:SummaECBNRas-:SummaECBNUd;
      select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbadd, :summaecbud;
--      exception  e_p07 summaecbadd;

      select first 1 SummaECB from ecb_common(:Tabno,:YearZa,:MonthZa,:SummaEcbAdd,1,0) into :SummaECBRas;
      SummaECBRazn=:SummaECBRas-:SummaECBUd;
      select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbdpadd, :summaecbdpud;
--      exception  e_p07 summaecbadd;

      select first 1 SummaECB from ecbdp_common(:Tabno,:YearZa,:MonthZa,:SummaEcbDpAdd) into :SummaECBDpRas;
      SummaECBDpRazn=:SummaECBDpRas-:SummaECBDpUd;

      select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbilladd, :summaecbillud;
      select first 1 SummaECBIll from ecbill_common(:Tabno,:YearZa,:MonthZa,:SummaEcbIllAdd) into :SummaECBIllRas;
      SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
      select first 1 summaadd,summapod from getpodnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summapodadd, :summapodud;
   --   if (tabno=9112) then
   --   exception  e_p07 summapodadd;
      select first 1 SummaPod from podoh_common(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:summaecbnras+:summaecbras+:summaecbdpras+:summaecbillras,1) into :SummaPodRas;
      SummaPodRazn=:SummaPodRas-:SummaPodUd;
      select first 1 summaadd,summaalim from getalimnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summaalimadd, :summaalimud;
      select first 1 SummaAlim from alim_common(:tabno,:YearZa,:MonthZa, :SummaAlimAdd,1) into :SummaAlimRas;
   --   exception  e_p07 summaecbadd;

  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_PODR_NAME_HIST (
    SHIFRPOD INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL VARCHAR(200))
AS
declare variable DT date;
begin
     retval='';
     dt=cast((:Y||'-'||:m||'-01') as date);
     select first 1 a.name from tb_podr_history a
            where a.shifrpod=:shifrpod
              and dateto>:dt
              and extract(year from coalesce(dateto,cast('1900-01-01' as date)))>1990
            order by dateto desc
            into :retval;
     retval=coalesce(retval,'');
     if (strlen(retval)<1) then
         select first 1 b.name from podr b where b.shifrpod=:shifrpod
                into :retval;
     suspend;
end^


ALTER PROCEDURE PR_GET_RAZR
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(20),
    DOLG CHAR(25),
    W_R INTEGER,
    W_PLACE INTEGER,
    SHIFR_KAT INTEGER,
    SHIFR_GRU INTEGER,
    RAZRJAD INTEGER,
    UCH_ZW INTEGER,
    UCH_ST INTEGER,
    KOEF DECIMAL(15,2),
    SHIFRDOL INTEGER,
    NAMEDOL CHAR(50),
    RAZRDOL INTEGER,
    OKLAD DECIMAL(15,2),
    POVOKLAD DECIMAL(15,2))
AS
declare variable shifrid integer;
begin
     for
         select person.shifrid,person.tabno,person.fio,person.dolg,
                person.w_r,person.w_place,person.shifrkat,person.shifrgru,
                (select first 1 a.summa from fcn a where a.shifridperson=person.shifrid and a.shifrsta=18),
                (select first 1 a.summa from fcn a where a.shifridperson=person.shifrid and a.shifrsta=22),
                (select first 1 a.summa from fcn a where a.shifridperson=person.shifrid and a.shifrsta=99+500),
                (select first 1 a.prim from fcn a where a.shifridperson=person.shifrid and a.shifrsta=100+500)
                 from person
                where person.yearvy=2007 and person.monthvy=6
                into :shifrid,:tabno,:fio,:dolg,:w_r,:w_place,:Shifr_kat,:Shifr_gru,:uch_st,:uch_zw,:koef,:shifrdol

     do
       begin
             razrjad=0;
             select first 1 fcn.prim from fcn
                    where fcn.shifridperson=:shifrid and
                          (fcn.shifrsta=126 or fcn.shifrsta=126+500)
                    into :razrjad;
             if ((razrjad is null) or (razrjad<1) ) then
                begin
                      select first 1 fcn.prim from fcn join person on fcn.shifridperson=person.shifrid
                             where fcn.tabno=:tabno        and
                                   fcn.w_place=:w_place    and
                                   fcn.shifrgru=:shifr_gru and
                                   fcn.shifrkat=:shifr_kat and
                                   fcn.w_r=:w_r            and
                                   fcn.prim>0              and
                                   person.dolg=:dolg       and
                                   (fcn.shifrsta=126 or fcn.shifrsta=126+500)
                             order by fcn.year_vy desc,  fcn.month_vy desc
                             into :razrjad;

                end
             namedol='';
             razrdol=0;
             select first 1 name,razr  from tb_dolg where tb_dolg.shifrdol=:shifrdol
                    into :namedol, :razrdol;
             oklad=0;
             if (razrdol=0 and razrjad>0) then razrdol=razrjad;
             select first 1 oklad from tb_razr_proc where razr=:razrdol
                    into oklad;
             povoklad=oklad;
             povoklad=povoklad*koef;
             if (shifr_kat=1) then povoklad=povoklad*1.15;
             suspend;

       end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_RAZR_P_BY_DOLG_FOR_SWOD (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
declare variable SHIFRDOL integer;
declare variable Y integer;
declare variable M integer;
declare variable SHIFRIDN integer;
declare variable SHIFRPOD integer;
declare variable TABNO integer;
begin
      SELECT first 1 w_place,yearvy,monthvy,tabno from person pp where pp.shifrid=:shifrid into :shifrpod,:y,:m,:tabno;
      y=coalesce(y,0);
      m=coalesce(m,0);
      tabno=coalesce(tabno,0);
      shifrpod=coalesce(shifrpod,0);
      if ((shifrpod in (1,3,6)) and (y<>2019) and (m<>1)) then
         begin
               select first 1 fc.shifridperson from fcn fc
                      where fc.tabno=:tabno
                        and fc.year_vy=2019
                        and fc.month_vy=1
                        and fc.shifrsta=126+500
                        and fc.prim>0
                     into :shifridn;
               shifridn=coalesce(shifridn,0);
               if (shifridn<0) then
                   shifrid=shifridn;
         end

      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
      if (razrijad=0) then
         begin
              select first 1 shifriddolg from pr_get_dolg_person_by_id(:shifrid)
               into :shifrdol;
              shifrdol=coalesce(shifrdol,0);
              if (shifrdol>0) then
                 begin
                      select first 1 d.razr from tb_dolg d
                             where d.shifrdol=:shifrdol
                             into razrijad;
                      razrijad=coalesce(razrijad,0);
                      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                         razrijad=0;
                 end
         end
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_P_BY_ID_FOR_SWOD (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
declare variable Y integer;
declare variable M integer;
declare variable SHIFRIDN integer;
declare variable SHIFRPOD integer;
declare variable TABNO integer;
begin
      SELECT first 1 w_place,yearvy,monthvy,tabno from person pp where pp.shifrid=:shifrid into :shifrpod,:y,:m,:tabno;
      y=coalesce(y,0);
      m=coalesce(m,0);
      tabno=coalesce(tabno,0);
      shifrpod=coalesce(shifrpod,0);
      if ((shifrpod in (1,3,6)) and (y<>2019) and (m<>1)) then
         begin
               select first 1 fc.shifridperson from fcn fc
                      where fc.tabno=:tabno
                        and fc.year_vy=2019
                        and fc.month_vy=1
                        and fc.shifrsta=126+500
                        and fc.prim>0
                     into :shifridn;
               shifridn=coalesce(shifridn,0);
               if (shifridn<0) then
                   shifrid=shifridn;
         end
      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_P_FOR_SWOD (
    SHIFRID INTEGER,
    MODE VARCHAR(10))
RETURNS (
    RAZRIJAD INTEGER)
AS
declare variable SHIFRDOL integer;
declare variable Y integer;
declare variable M integer;
declare variable CNT integer;
declare variable TABNO integer;
declare variable SHIFRIDN integer;
declare variable SHIFRPOD integer;
begin
      SELECT first 1 w_place,yearvy,monthvy,tabno from person pp where pp.shifrid=:shifrid into :shifrpod,:y,:m,:tabno;
      y=coalesce(y,0);
      m=coalesce(m,0);
      tabno=coalesce(tabno,0);
      shifrpod=coalesce(shifrpod,0);
      if ((shifrpod in (1,3,6)) and (y<>2019) and (m<>1)) then
         begin
               select first 1 fc.shifridperson from fcn fc
                      where fc.tabno=:tabno
                        and fc.year_vy=2019
                        and fc.month_vy=1
                        and fc.shifrsta=126+500
                        and fc.prim>0
                     into :shifridn;
               shifridn=coalesce(shifridn,0);
               if (shifridn<0) then
                   shifrid=shifridn;
         end




      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
      if (razrijad>0) then
         begin
              suspend;
              exit;
         end
      if (upper(mode) in ('OKL')) then
         begin
              select first 1 shifriddolg from pr_get_dolg_person_by_id(:shifrid)
               into :shifrdol;
              shifrdol=coalesce(shifrdol,0);
              if (shifrdol>0) then
                 begin
                      select first 1 d.razr from tb_dolg d
                             where d.shifrdol=:shifrdol
                             into razrijad;
                      razrijad=coalesce(razrijad,0);
                      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                         razrijad=0;
                 end
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end

               select first 1 p1.yearvy,p1.monthvy,p1.tabno from person p1
                      where p1.shifrid=:shifrid
                      into :y, :m, :tabno;
/*
               select first 1
                       r, count(*) from (
                      select (select first 1 razrijad from pr_get_razr_person_by_id(pd.shifrid)) r
                        from person pd
                      where
                            pd.yearvy=:y
                        and pd.monthvy=:m
                        and (select first 1 shifriddolg from pr_get_dolg_person_by_id(pd.shifrid))=:shifrdol
                        and (select first 1 razrijad from pr_get_razr_person_by_id(pd.shifrid))>0
                      )
                      group by r
                      order by count(*) desc
                      into :razrijad,:cnt;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end
*/
               select first 1 razrijad from pr_get_razr_person_by_dolg(:shifrid) into :razrijad;
               razrijad=coalesce(razrijad,0);
               if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                   razrijad=0;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end

                select first 1 cc.prim from fcn cc
                              where cc.tabno=:tabno
                                and cc.year_vy=:y
                                and cc.month_vy=:m
                                and (select first 1 coalesce(pc.oklad,0.00) from person pc where pc.shifrid=cc.shifridperson)>1.00
                                and cc.shifrsta=126+500
                              into :razrijad;
               if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                   razrijad=0;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end
         end
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_PERSON (
    TABNO INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
begin
      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.tabno=:tabno     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0           and
                   fcn.w_r=1
             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_PERSON_BY_DOLG (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
declare variable SHIFRDOL integer;
begin
      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
      if (razrijad=0) then
         begin
              select first 1 shifriddolg from pr_get_dolg_person_by_id(:shifrid)
               into :shifrdol;
              shifrdol=coalesce(shifrdol,0);
              if (shifrdol>0) then
                 begin
                      select first 1 d.razr from tb_dolg d
                             where d.shifrdol=:shifrdol
                             into razrijad;
                      razrijad=coalesce(razrijad,0);
                      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                         razrijad=0;
                 end
         end
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_PERSON_BY_ID (
    SHIFRID INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
begin
      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_PERSON_FOR_SWOD (
    SHIFRID INTEGER,
    MODE VARCHAR(10))
RETURNS (
    RAZRIJAD INTEGER)
AS
declare variable SHIFRDOL integer;
declare variable Y integer;
declare variable M integer;
declare variable CNT integer;
declare variable TABNO integer;
begin
      RAZRIJAD=0;
      select first 1 fcn.prim from fcn
             where fcn.shifridperson=:shifrid     and
                   fcn.shifrsta=126+500 and
                   fcn.prim>0         --  and
--                   fcn.w_r=1
--             order by fcn.year_vy desc,fcn.month_vy desc
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
      if (razrijad>0) then
         begin
              suspend;
              exit;
         end
      if (upper(mode) in ('OKL')) then
         begin
              select first 1 shifriddolg from pr_get_dolg_person_by_id(:shifrid)
               into :shifrdol;
              shifrdol=coalesce(shifrdol,0);
              if (shifrdol>0) then
                 begin
                      select first 1 d.razr from tb_dolg d
                             where d.shifrdol=:shifrdol
                             into razrijad;
                      razrijad=coalesce(razrijad,0);
                      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                         razrijad=0;
                 end
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end

               select first 1 p1.yearvy,p1.monthvy,p1.tabno from person p1
                      where p1.shifrid=:shifrid
                      into :y, :m, :tabno;
/*
               select first 1
                       r, count(*) from (
                      select (select first 1 razrijad from pr_get_razr_person_by_id(pd.shifrid)) r
                        from person pd
                      where
                            pd.yearvy=:y
                        and pd.monthvy=:m
                        and (select first 1 shifriddolg from pr_get_dolg_person_by_id(pd.shifrid))=:shifrdol
                        and (select first 1 razrijad from pr_get_razr_person_by_id(pd.shifrid))>0
                      )
                      group by r
                      order by count(*) desc
                      into :razrijad,:cnt;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end
*/
               select first 1 razrijad from pr_get_razr_person_by_dolg(:shifrid) into :razrijad;
               razrijad=coalesce(razrijad,0);
               if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                   razrijad=0;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end

                select first 1 cc.prim from fcn cc
                              where cc.tabno=:tabno
                                and cc.year_vy=:y
                                and cc.month_vy=:m
                                and (select first 1 coalesce(pc.oklad,0.00) from person pc where pc.shifrid=cc.shifridperson)>1.00
                                and cc.shifrsta=126+500
                              into :razrijad;
               if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
                   razrijad=0;
               if (razrijad>0) then
                   begin
                       suspend;
                       exit;
                   end
         end
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_RAZR_PERSON_VY (
    TABNO INTEGER,
    MONTH_VY INTEGER,
    YEAR_VY INTEGER)
RETURNS (
    RAZRIJAD INTEGER)
AS
begin
      RAZRIJAD=0;
      select first 1 person.razrjad from person
             where person.monthvy=:month_vy and
                   person.yearvy=:YEAR_VY   and
                   person.w_r=1
             into :razrijad;
    --  if ((razrijad is null) or (razrijad<1) or (razrijad>25))  then
         select first 1 fcn.prim from fcn
             join person on fcn.shifridperson=PERSON.shifrid
             where fcn.tabno=:tabno         and
                   fcn.shifrsta=126+500     and
                   fcn.prim>0               and
                   person.w_r=1             and
                   PERSON.monthvy=:month_vy and
                   PERSON.yearvy=:YEAR_VY
             into :razrijad;
      if ((razrijad is null) or (razrijad<0) or (razrijad>25)) then
         razrijad=0;
  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_GET_REP_CLOCKS (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    KWARTAL INTEGER,
    SHIFRPOD INTEGER,
    CURRYEAR INTEGER,
    CURRMONTH INTEGER)
RETURNS (
    CLOCKSPPSINNER DECIMAL(15,2),
    CLOCKSPPSOUTER DECIMAL(15,2),
    CLOCKSOTHERINNER DECIMAL(15,2),
    CLOCKSOTHEROUTER DECIMAL(15,2))
AS
declare variable SHIFRIDPERSON integer;
declare variable SHIFRKAT integer;
declare variable M_O_R integer;
declare variable CLOCKS integer;
begin
  /*
     mode = 1 за указанный месяц
     mode = 2 за указанный квартал
     mode = 3 за указанный год
  */
  clocksotherinner =0;
  clocksotherouter =0;
  clocksppsinner   =0;
  clocksppsouter   =0;
  for
     select p.shifrid,p.shifrkat,p.m_o_r from person p
         where
               p.w_place = :shifrpod
           and p.oklad>1.00
           and p.yearvy=:y
           and ((p.yearvy<:curryear)
                or
                (p.monthvy < :m and :curryear=p.yearvy)
               )
           and
               case
                   when :mode=2 then
                      case
                          when :kwartal=1 and p.monthvy in (1,2,3) then 1
                          when :kwartal=2 and p.monthvy in (4,5,6) then 1
                          when :kwartal=3 and p.monthvy in (7,8,9) then 1
                          when :kwartal=4 and p.monthvy in (10,11,12) then 1
                          else 0
                      end
                   when :mode=1 then
                        case
                            when p.monthvy=:m then 1
                            else 0
                        end
                   else 1
               end =1
          into :shifridperson,:shifrkat,:m_o_r
     do
       begin
            select retval from pr_work_clock_lera(:shifridperson) into :clocks;
            clocks=coalesce(clocks, 0);
            if (clocks>0.1) then
               if (m_o_r=82) then
                   if (shifrkat=1) then
                       clocksPPSouter=clocksPPSouter+clocks;
                   else
                       clocksotherouter=clocksotherouter+clocks;
               else
                   if (shifrkat=1) then
                       clocksPPSinner=clocksPPSinner+clocks;
                   else
                       clocksotherinner=clocksotherinner+clocks;
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_SECRETWORKER_LIST
RETURNS (
    TABNO INTEGER)
AS
begin
     for
         select tabno from tb_secret_tabno order by tabno into :tabno
     do
       suspend;

  /* Procedure Text */
end^


ALTER PROCEDURE PR_GET_SWM_MODE_PERSON_TMP (
    SHIFRIDPERSON INTEGER)
RETURNS (
    SWM_MODE INTEGER)
AS
begin
      swm_mode = 3;
      if (exists ( select first 1 a.shifrsta from tb_tmp_fcn a
                    where a.shifridperson=:shifridperson and
                      a.shifrsta in (105,105+500))) -- sowmestit_cn_shifr
          then
              swm_mode=2;
      else
          if (exists ( select first 1 a.shifrsta from tb_tmp_fcn a
                    where a.shifridperson=:shifridperson and
                      a.shifrsta in (82,82+500)))    -- OSN_MESTO_RABOTY_SHIFR
             then
                 swm_mode=1;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GET_TOT_KOEF_PERSON (
    SHIFRID INTEGER)
RETURNS (
    KOEF DECIMAL(15,2),
    OKLAD DECIMAL(15,2))
AS
begin
     select first 1 sum(b.summa),sum(a.oklad) from person a
                         join fcn b on b.tabno=a.tabno
                    where a.shifrid=:shifrid        and
                          b.year_vy=a.yearvy        and
                          b.month_vy=a.monthvy      and
                          b.shifrsta in (99,99+500) and
                          a.w_place not in (76,81,82,102,140)
                          and ((select first 1 c.prim from fcn c
                                where c.shifridperson=b.shifridperson
                                and c.shifrsta in (100,100+500)) not in (4,5,8)
                          )

                    into :koef,:oklad;
     koef=coalesce(koef,0);
     oklad=coalesce(oklad,0);

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETESTSUMMAFORINDPERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
declare variable SHIFRIDPERSON integer;
declare variable SUMMAC decimal(15,2);
declare variable KOD integer;
declare variable SUMMACN decimal(15,2);
begin
  summa=0;
  for
     select a.shifrid,a.oklad from person a
                      where a.tabno=:tabno
                      and a.yearvy=:y
                      and a.monthvy=:m
                      and a.main<>0
                      and  not (
                               (a.automatic=2) and ((select sum(c.summa) from fadd c where c.tabno=:tabno and c.year_za=:y and c.month_za=:m and
                                                            ((select first 1 guid from pr_getguid(a.shifrid,0))=
                                                             (select first 1 guid from pr_getguid(c.shifridperson,0)))
                                                    )<1.00)
                          )
             --         and coalesce(a.state,1)<>8  -- не уволен
                      and coalesce(a.main,1)<>0
                      and not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
                      and (select first 1  shifriddolg from pr_get_dolg_person_by_id(a.shifrid)) not in (4,6,7,8,9,1455,1500) -- почасовка и больничный
                      into :shifridperson,:summac
  do
    begin
         summac = coalesce(summac, 0);
         summa  = summa +summac;
         for
              select a.kod,a.summa from fcn a
                                   where a.shifridperson=:shifridperson
                                   and a.kod between 1 and 6
                                   and a.automatic=1
                                   and exists (select * from shifr b where b.mode=1 and b.shifr=a.shifrsta)
                     into :kod,:summacn
         do
            begin
                  summacn=coalesce(summacn,0);
                  if (kod in (2,4,6)) then summacn=summacn/100.00*summac;
                  summa=summa+summacn;
            end
    end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETESTSUMMAFORINDPERSONBP (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2))
AS
declare variable SHIFRIDPERSON integer;
declare variable SUMMAC decimal(15,2);
declare variable KOD integer;
declare variable SUMMACN decimal(15,2);
declare variable OKLADBEF decimal(10,2);
declare variable KOEF decimal(10,2);
declare variable RAZR integer;
begin
  summa=0;      -- з п перед повышением
  for
     select a.shifrid,a.oklad,
            (select first 1 RAZRIJAD from pr_get_razr_person_by_id(a.ShifrId)) as r,
            (select first 1 koef from pr_get_koef_person_by_id(a.ShifrID)),
            (select first 1 oklad from tb_razr_proc b where b.datefr<cast((:Y||'-'||:M||'-01') as date) and
                                      b.razr=(select first 1 RAZRIJAD from pr_get_razr_person_by_id(a.ShifrId))
                                 order by b.datefr desc
            )
                      from person a
                      where a.tabno=:tabno
                      and a.yearvy=:y
                      and a.monthvy=:m
                      and coalesce(a.main,1)<>0
              --       and coalesce(a.state,1)<>8  -- не уволен
                      and  not (
                               (a.automatic=2) and ((select sum(c.summa) from fadd c where c.tabno=:tabno and c.year_za=:y and c.month_za=:m and
                                                            ((select first 1 guid from pr_getguid(a.shifrid,0))=
                                                             (select first 1 guid from pr_getguid(c.shifridperson,0)))
                                                    )<1.00)
                          )

                      and not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
                      and (select first 1  shifriddolg from pr_get_dolg_person_by_id(a.shifrid)) not in (4,6,8,9,1455,1500) -- почасовка и больничный
                      into :shifridperson,:summac,:razr,:koef,:okladbef
  do
    begin
         summac = coalesce(summac, 0);
         koef   = coalesce(koef, 0);
         okladbef = coalesce(okladbef,0);
         okladbef = okladbef * koef;
         summac = okladbef;
         summa  = summa +summac;
         for
              select a.kod,a.summa from fcn a
                                   where a.shifridperson=:shifridperson
                                   and a.kod between 1 and 6
                                   and a.automatic=1
                                   and exists (select * from shifr b where b.mode=1 and b.shifr=a.shifrsta)
                     into :kod,:summacn
         do
            begin
                  summacn=coalesce(summacn,0);
                  if (kod in (2,4,6)) then summacn=summacn/100.00*summac;
                  summa=summa+summacn;
            end
    end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETFIOOPE (
    SHIFRWRK INTEGER)
RETURNS (
    FIO VARCHAR(50))
AS
begin
     fio='';
     select first 1 operatory.fioop from operatory where operatory.shifrwrk=:shifrwrk
            into :fio;
     if (fio is null) then
        fio='';
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETGUID (
    SHIFRIDPERSON INTEGER,
    MODE INTEGER)
RETURNS (
    GUID VARCHAR(30))
AS
begin
     guid='';
     if (mode=1) then
        select first 1 a.prim_1 from tb_tmp_fcn a
               where a.shifridperson=:shifridperson
               and a.shifrsta=140+500
               into :guid;
     else
        if (mode=0) then
           select first 1 a.prim_1 from fcn a
                  where a.shifridperson=:shifridperson
                  and a.shifrsta=140+500
                  into :guid;
   /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETKOEFIND (
    BASEDATA DATE,
    WANTEDDATE DATE)
RETURNS (
    PROCIND DECIMAL(15,1),
    KKK DECIMAL(15,6),
    K4 DECIMAL(15,6))
AS
declare variable K float;
declare variable KK float;
begin
     k=1;
     for
        select a.procinf from tb_infproc a
                         where a.data between :basedata and :wanteddate
                         order by a.data
                         into :kk
     do
       begin
            kk=coalesce(kk, 100);
         --   if (kk>=101) then
               begin
            k=cast(k*kk/cast(100.00 as float) as decimal(15,6));
            k4=cast(kk/cast(100.00 as float) as decimal(15,6));
               end
            kkk=k;
            suspend;
       end
  /* Procedure Text */
  if (k*100<100) then
     Procind=0;
  else
     PROCIND=cast(k*100-100 as decimal(15,5));
  suspend;
end^


ALTER PROCEDURE PR_GETLGCNPN2011 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    LGOTYPN DECIMAL(15,2),
    ISLGOTY INTEGER,
    KWOD INTEGER,
    FINDED INTEGER)
AS
declare variable SHIFRIDPERSON integer;
begin
  /**
     Процедура используется для поиска реквизитов льгот
     в процедура анализа налогов программы на Дельфи
  */
     lgotypn = 0;
     islgoty = 0;
     kwod    = 0;
     finded  = 0;
     select first 1 a.shifrid from person a
                    where a.tabno=:tabno and
                      --    a.yearvy=:y    and
                      --    a.monthvy=:m   and
                          cast(a.yearvy||'-'||a.monthvy||'-10' as date)<=cast(:y||'-'||:m||'-10' as date)
                          and a.w_r=1
                    order by a.yearvy desc,a.monthvy desc
                    into :shifridperson;
     shifridperson=coalesce(shifridperson, 0);
     if (shifridperson>0) then
        begin
             finded=1;
             select first 1 a.summa from fcn a
                                    where a.shifridperson=:shifridperson
                                      and a.shifrsta=117+500
                                      and a.kod=100
                                    into :lgotypn;
             lgotypn=coalesce(lgotypn,0);
             if (exists (select first 1 a.summa from fcn a
                                    where a.shifridperson=:shifridperson
                                      and a.shifrsta=147+500
                                      and a.kod=100)) then
               islgoty=1;
             select first 1 a.prim from fcn a
                                    where a.shifridperson=:shifridperson
                                      and a.shifrsta=127+500
                                      and a.kod=100
                                    into :kwod;
             kwod=coalesce(kwod,0);
        end


  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETMONTHNAMEUKR (
    M INTEGER)
RETURNS (
    RETVAL VARCHAR(15))
AS
begin
      retval=case
         when m=1 then 'січень'
         when m=2 then 'лютий'
         when m=3 then 'березень'
         when m=4 then 'квітень'
         when m=5 then 'травень'
         when m=6 then 'червень'
         when m=7 then 'липень'
         when m=8 then 'серпень'
         when m=9 then 'вересень'
         when m=10 then 'жовтень'
         when m=11 then 'листопад'
         else 'грудень'
      end;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GETPICK (
    SHIFRWRK INTEGER)
RETURNS (
    SHIFRPOD INTEGER,
    TABNO INTEGER,
    W_R INTEGER)
AS
begin
  /* Procedure Text */
     select first 1 shifrpod, tabno,w_r from tb_pick
            where tb_pick.shifrwrk = :shifrwrk
            into :shifrpod,:tabno,:w_r;
     suspend;
end^


ALTER PROCEDURE PR_GETPODRNAMER (
    SHIFRPOD INTEGER)
RETURNS (
    NAME VARCHAR(256))
AS
begin
   select first 1 name from podr a where a.shifrpod=:shifrpod into :name;
   if (UPPER(NAME) LIKE 'РЕЗЕ%') then
      begin
           select first 1 s.name from podr_sv s
                  where
                        s.shifrpod=:shifrpod
                    and not (UPPER(s.NAME) LIKE 'РЕЗЕ%')
                       order by datefr desc
                  into :name;
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_GT_LIMIT_2014 (
    Y INTEGER,
    M INTEGER,
    DATEFR DATE)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA DECIMAL(15,2))
AS
begin
 for
     select tn,fio,sza from
        (
          select a.tabno tn,a.fio fio,coalesce((
                 select sum(coalesce(b.summa,0.00)) from fadd b where b.tabno=a.tabno
                        and (
                             (b.year_vy=:y  and
                              b.month_vy=:m and
                              (select first 1 d.retval from pr_isotherperiodecbshifr(b.shifrsta) d)=0
                             ) or
                             (b.year_za=:y  and
                              b.month_za=:m and
                              (select first 1 e.retval from pr_isotherperiodecbshifr(b.shifrsta) e)=1
                              )
                             )

                        ),0.00) sza from kadry a
                 group by 1,2
                 )
              where sza>(select first 1  c.minsal from sslimity c where  c.datefr<:dateFr
              order by c.datefr desc)*15
              into :tabno,:fio,:summa
 do
  /* Procedure Text */
   suspend;
end^


ALTER PROCEDURE PR_GT_LIMIT_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    DATEFR DATE)
RETURNS (
    SUMMA DECIMAL(15,2),
    SUMMA_BUD DECIMAL(15,2),
    SUMMA_VNE DECIMAL(15,2),
    SUMMA_GN DECIMAL(15,2))
AS
begin
     select sum(coalesce(b.summa,0.00)),
            sum(case
                    when b.shifrgru<>1 then 0
                    else b.summa
                end
            ),
            sum(case                      -- вне
                    when not b.shifrgru in (1,3,4,16) then 0
                    else b.summa
                end
            ),                     -- ГН
            sum(case
                    when not b.shifrgru in (3,4,16) then 0
                    else b.summa
                end
            )
      from fadd b
       where b.tabno=:tabno
         and (
              (b.year_vy=:y  and
               b.month_vy=:m and
               (select first 1 d.retval from pr_isotherperiodecbshifr(b.shifrsta) d)=0
               ) or
               (b.year_za=:y  and
                b.month_za=:m and
                (select first 1 e.retval from pr_isotherperiodecbshifr(b.shifrsta) e)=1
               )
              )
           and (cast(cast((b.year_vy||'-'||b.month_vy||'-01') as varchar(10)) as date)<:datefr)
          into :summa,:summa_bud,:summa_vne,:summa_gn;
   summa=coalesce(summa,0);
   summa_bud=coalesce(summa_bud,0);
   suspend;
end^


ALTER PROCEDURE PR_I_MOVTOKADRY
RETURNS (
    RETVAL INTEGER)
AS
declare variable MAXTABNO integer;
declare variable I integer;
declare variable TABNO integer;
declare variable FIO varchar(50);
declare variable ID_NAL varchar(10);
declare variable DATA_PRI date;
begin
     retval=0;
     delete from kadry where shifr_pod=179;
     select max(a.tabno) from kadry a  into maxtabno;
     i=maxtabno;
     for
          select a.nt,a.fio,a.id_nal,cast(a.dpost as date) from tb_i_person a
                 order by nt
            into :tabno,:fio,:id_nal,:data_pri
     do
       begin
          if (id_nal is not null) then
          if (not (exists (select * from kadry a where a.nal_code=:id_nal))) then
             begin
                  i=i+1;
                  insert into kadry (tabno,fio,nal_code,data_pri,shifr_pod)
                        values(:i, :fio, :id_nal,:data_pri,179 );
                  update tb_i_person a
                         set a.tabno_vnu=:i
                         where a.nt=:tabno;
                  retval=retval+1;
             end
       end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_INDFICSPERSON201208 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SUMMAIND decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable KOEFBUD decimal(10,2);
declare variable WDAY integer;
declare variable KALENDAY integer;
declare variable FIO varchar(50);
declare variable DTTMP date;
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable RAZR integer;
declare variable KOEF decimal(10,2);
declare variable DOLG varchar(50);
declare variable COMM varchar(50);
declare variable DATABASEIND date;
declare variable SHIFRPOD integer;
declare variable MP integer;
declare variable YP integer;
begin
      retval   = 0;
      SummaInd = null;
      mp       = m;
      yp       = y;
      mp       = mp - 1;
      if (mp<1) then
         begin
              mp=12;
              yp=yp-1;
         end
      delete from tb_ind_calc_12_7 a
             where a.yearza  = :y
               and a.monthza = :m
               and a.tabno   = :tabno;

      select first 1 a.summapostind,a.koefosnbud,a.koefosnvne,a.fio,a.razra,a.dolg,a.databaseind,a.shifrpod from tb_ind_calc_12_7 a
                      where a.yearza=:yp   and
                            a.monthza=:mp  and
                            a.needind=1    and
                            a.ispovrazr=1  and
                            a.summapostind>0.01 and
                            a.tabno   =  :tabno
                      into :summaind,:koefbud,:koefvne,:fio,:razr,:dolg,:databaseind,:shifrpod;
      if (SummaInd is null ) then
         Exit;
      DTTMP=CAST((:y||'-'||:m||'-01')  AS DATE);
      select first 1 retval from work_day(:tabno, :dttmp) into wday;
      wday=coalesce(wday,0);
      select first 1 wdays from tb_days where yearza=:y and monthza=:m into :kalenday;
      kalenday=coalesce(kalenday,0);
      if (wday>kalenday) then
          wday=kalenday;
      summaind=coalesce(summaind,0.00);
      if (wday<1) then
          summaind=0;
      summaindwday=summaind * cast(wday as decimal(12,2)) / cast(kalenday as decimal(12,2));
      if (koefbud+koefvne>0.01) then
         summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
      summaindvne = summaindwday - summaindbud;
      comm='Фиксир. сумма с прошл.мес. '||summaind;
      insert  into tb_ind_calc_12_7  (tabno, yearza,monthza,summapostind,koefosnbud,koefosnvne,fio,
                                      workdaya,kalenddaya,summaindbud, summaindvne,movedbud,movedvne,
                                      summaindwday,dataza,razra,needind,koefa,dolg,databaseind, comment,
                                      ispovrazr, shifrpod, summafixprev)
                               values(:tabno, :y, :m, :summaind, :koefbud, :koefvne, :fio,
                                      :wday, :kalenday,:summaindbud,:summaindvne,0,0,
                                      :summaindwday,:dttmp,:razr,1,:koef,:dolg,:databaseind, :comm,
                                       1, :shifrpod, :summaind);
      retval=1;
      suspend;
  /* Procedure Text */

end^


ALTER PROCEDURE PR_INITFILLTBOTPUSK201201
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
  /* Procedure Text */
    delete from tb_otpusk_2012_01;
    for
       select tabno,shifr_pod from kadry a where ((a.data_uw is null) or
              (extract(year from a.data_uw)>2011)) and tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              into :tabno,:w_place
    do
      begin
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_01(tabno,selected,w_place) values(:tabno,0,:w_place);
      end

end^


ALTER PROCEDURE PR_INITFILLTBOTPUSK201204
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
  /* Procedure Text */
    delete from tb_otpusk_2012_04;
    for
       select tabno,shifr_pod from kadry a where ((a.data_uw is null) or
              (coalesce(a.data_uw,'1900-01-01')>'2012-04-30')) and tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              into :tabno,:w_place
    do
      begin
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_04(tabno,w_place) values(:tabno,:w_place);
      end

end^


ALTER PROCEDURE PR_IO_ISFREE (
    NSRV INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable STAMP timestamp;
declare variable SEC1 bigint;
declare variable SEC2 bigint;
begin
    retval=0;
    select first 1 a.state,a.datewrk from tb_io_podr_monitor a
           where a.shifrpod=:nsrv
           into :retval,:stamp;
    retval=coalesce(retval,0);
    if (retval=0) then
       retval=1;        -- cвободен
    else
       retval=0;        -- занят
    if (retval=0) then
       begin
            sec1=extract(SECOND from current_timestamp);
            sec2=extract(second from stamp);
            if ((sec1-sec2)>1) then
               begin
                    update tb_io_podr_monitor b
                        set state=0
                        where b.shifrpod=:nsrv;
                    retval=1;  --свободен
               end
       end
    suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_IO_LOCK (
    NSRV INTEGER,
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
begin
    retval=0;
    update tb_io_podr_monitor a
      set  IP=:ip, mac=:mac, DATEWRK=current_timestamp,state=1
      where shifrpod=:nsrv;
    if (row_count=0) then
       begin
            insert into tb_io_podr_monitor
             values (:nsrv, :ip,:mac,current_timestamp,1);
            if (row_count=1) then
                retval=1;
       end
    else
    if (row_count=1) then
        retval=1;
    suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_IO_UNLOCK (
    NSRV INTEGER,
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
begin
    update tb_io_podr_monitor a
      set  datewrk=current_timestamp,state=0
      where shifrpod=:nsrv
        and trim(ip)=trim(:ip)
        and trim(mac)=trim(:mac);
    if (row_count=1) then
        retval=1;
    else
        retval=0;
    suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_IO_UNLOCK_ALL_MY (
    IP VARCHAR(30),
    MAC VARCHAR(30))
RETURNS (
    RETVAL INTEGER)
AS
begin
    retval=0;
    update tb_io_podr_monitor a
      set  DATEWRK=current_timestamp,state=0
      where IP=:ip and  mac=:mac;
    retval=row_count;
    suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_IS_COLEDGPODR (
    SHIFRPOD INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
  /* Procedure Text */
     if (shifrpod between 151 and 168) then
        retval=1;
  suspend;
end^


ALTER PROCEDURE PR_IS_DOGPOD (
    SHIFRPOD INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     shifrpod=coalesce(shifrpod,0);
     if (shifrpod in (81,140,157,180)) then
        retval=1;
     else
        retval=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_IS_OTP_BEZ_O (
    TABNO INTEGER,
    DATEC DATE)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
begin
     retval=0;
     for
        select shifrid from person a
               where a.tabno=:tabno
                 and a.yearvy=extract (year from :datec)
                 and a.monthvy=extract(month from :datec)
               into :id
     do
        begin
             if (exists (
                   select * from tabel b
                         where b.shifrid=:id
                           and b.dayno=extract(day from :datec)
                           and b.code=7
             )) then
                begin
                     retval=1;
                     break;
                end
        end
     suspend;
end^


ALTER PROCEDURE PR_IS_SCIPED (
    SHIFRIDPERSON INTEGER,
    MODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SHIFRKAT integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable NEEDSCI integer;
declare variable PREMONLY integer;
declare variable M_O_R integer;
declare variable ISOSNNOTSCI integer;
declare variable TABNO integer;
begin
  --   exception t ShifrKat||'-2';

     shifrkat=0;
     retval=0;
     isosnnotsci=0;
     if (mode=1) then
        select first 1 shifrkat,w_place,w_r,m_o_r from tb_tmp_person
               where shifrid=:shifridperson
                 and conn_id=CURRENT_CONNECTION
              into :shifrkat,:w_place,:w_r,:m_o_r;
     else
        select first 1 shifrkat,w_place,w_r,m_o_r from person
               where shifrid=:shifridperson
              into :shifrkat,:w_place,:w_r,m_o_r;
  --   exception t 'ShifrKat1='||ShifrKat;
     if (shifrkat is null or shifrkat<1) then
        begin
              suspend;
              Exit;
        end
     if (w_place is null) then
        begin
              suspend;
              exit;
        end

     if (w_place between 151 and 168) then
        begin
              suspend;     -- колледж убрать
              exit;
        end
     if (w_place in (106)) then
        begin
              suspend;     -- колледж убрать
              Exit;
        end
   --  if (w_place in (81,140,121) and w_r<>1) then
     if (w_place in (81,140,157) and w_r<>1) then
        begin
           if (m_o_r=82) then
              begin
                 suspend;     -- в трудов согл (76) дог под (81,140) 102 совместиетлей не считать
                 Exit;
              end
        end
  --   exception t 'ShifrKat='||ShifrKat;
     w_r=coalesce(w_r,0);
     if (Shifrkat=2) then
        begin
              suspend;
              Exit;
        end
     if (mode=1) then
        begin
             if ((shifrkat in (1,3)) or ((exists (select * from tb_tmp_fcn
                          where tb_tmp_fcn.shifridperson=:shifridperson and
                                tb_tmp_fcn.shifrsta in (100,100+500) and
                                tb_tmp_fcn.kod=100 and
                                tb_tmp_fcn.conn_id=CURRENT_CONNECTION and
                                tb_tmp_fcn.prim in (150,230,240,490))))
                          and   shifrkat<>2)      /* убрать завлабов */
             then
                 retval=1;
            if (retval=0) then
               begin
                    if (exists (select * from tb_tmp_fcn
                                        where tb_tmp_fcn.shifridperson=:shifridperson and
                                              tb_tmp_fcn.shifrsta in (115,115+500)    and  --ecb 6,1%
                                              tb_tmp_fcn.kod=100)
                     ) then retval=1;
               end
            else
               begin
                    if (exists (select * from tb_tmp_fcn
                                        where tb_tmp_fcn.shifridperson=:shifridperson and
                                              tb_tmp_fcn.shifrsta in (116,116+500)    and  --ecb 3,2%
                                              tb_tmp_fcn.conn_id=current_connection   and
                                              tb_tmp_fcn.kod=100)
                     ) then retval=0;
               end

        end
     else
        begin
             if ((shifrkat in (1,3)) or ((exists (select * from fcn
                                      where fcn.shifridperson=:shifridperson and
                                            fcn.shifrsta in (100,100+500) and
                                            fcn.kod=100 and
                                            fcn.prim in (150,230,240,490))))
                                        and shifrkat<>2)      /* убрать завлабов */
            then
              retval=1;
            if (retval=0) then
               begin
                    if (exists (select * from fcn
                                        where fcn.shifridperson=:shifridperson and
                                              fcn.shifrsta in (115,115+500)    and  --ecb 6,1%
                                              fcn.kod=100)
                     ) then retval=1;
               end
            else
               begin
                    if (exists (select * from fcn
                                        where fcn.shifridperson=:shifridperson and
                                              fcn.shifrsta in (116,116+500)    and  --ecb 3,2%
                                              fcn.kod=100)
                     ) then retval=0;
               end
        end
  -- Добавка от 18.12.2016
  -- совместители теперь не считаются как ученые кроме премии и
  -- ии специально помеченных в CN 168 шифром с 1 в поле prim

  if (retval=1) then
  if (mode=1) then
     begin
          select first 1 tb_tmp_person.w_r from  tb_tmp_person
                where tb_tmp_person.shifrid=:shifridperson
                into :w_r;
          w_r=coalesce(w_r,0);
          if (w_r=0) then
            select count(*) from fcn
                   where fcn.shifridperson=:shifridperson and
                         fcn.shifrsta in (82,82+500)
                   into :w_r;
          w_r=coalesce(w_r,2);
          select first 1 tb_tmp_fcn.prim from tb_tmp_fcn
                  where tb_tmp_fcn.shifridperson=:shifridperson
                    and tb_tmp_fcn.shifrsta in (168,168+500)
                  into :needsci;
          needsci=coalesce(needsci,0);
          premonly=1;
          if (exists(
              select * from tb_tmp_fadd 
                       where tb_tmp_fadd.shifridperson=:shifridperson
                         and tb_tmp_fadd.shifrsta<>2
          )) then
          if (coalesce(w_place,0)<>102) then
             premonly=0;
--          if ((w_r=2) and (m_o_r=82)) then
          if ((w_r=2)) then
             if (needsci<>1) then
                if (premonly=0) then
                 retval=0;           --у совместителе не считать научной работой

     end

  else
     begin
          select first 1 shifrwr from pr_isosnwrbyid(:shifridperson) into :w_r;
          w_r=coalesce(w_r,2);
          select first 1 fcn.prim from fcn
                  where fcn.shifridperson=:shifridperson
                    and fcn.shifrsta in (168,168+500)
                  into :needsci;
          needsci=coalesce(needsci,0);
          premonly=1;
          if (exists(
              select * from fadd 
                       where fadd.shifridperson=:shifridperson
                         and fadd.shifrsta<>2
          )) then
          if (coalesce(w_place,0)<>102) then
             premonly=0;
          isosnnotsci=0;
          if (w_r=2) then
             begin
                  select first 1 pi1.tabno from person pi1
                         where pi1.shifrid=:shifridperson
                         into :tabno;
                  tabno = coalesce(tabno,0);
                  if (tabno>0) then
                     begin
                          select first 1 pi.w_r from person pi
                                 where pi.tabno=:tabno
                                   and pi.w_r=1
                                   and pi.w_place not in (11,79,81,82,102,121,140)
                                   and not pi.shifrkat in (1,3)
                                  into :isosnnotsci;
                          isosnnotsci=coalesce(isosnnotsci, 0);
                          if (isosnnotsci<>1) then
                            isosnnotsci=0;
                          if (isosnnotsci=1) then
                             needsci=1;           /* оставить научную если по основной - не научная */
                     end
             end
  --        if ((w_r=2) and (m_o_r=82)) then
          if ((w_r=2)) then
             if (needsci<>1) then
                if (premonly=0) then
                 retval=0;           --у совместителе не считать научной работой
     end

     suspend;
end^


ALTER PROCEDURE PR_IS_ZAWLAB (
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
     if (exists (select * from fcn
                          where fcn.shifridperson=:shifridperson and
                                fcn.shifrsta in (100,100+500) and
                                fcn.kod=100 and
                                fcn.prim in (150,230,240,490)
                )
        ) then
       retval=1;
  suspend;
end^


ALTER PROCEDURE PR_ISBOLNSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
  --   if (ShifrVal in (14,15,12,32,5,6,10,11,13)) then
     if (ShifrVal in (14,15,12,32)) then
        RetVal=1;
  /* Procedure Text */
     suspend;
end^


ALTER PROCEDURE PR_ISNEEDIND (
    TABNO INTEGER,
    M INTEGER,
    Y INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable BASEM integer;
declare variable BASEY integer;
declare variable BASEDATA date;
declare variable DATAMAX date;
begin
       select first 1 cast(c.summa as integer),c.prim from fcn c
                      join person a on a.shifrid=c.shifridperson
                      where c.tabno    = :tabno
                        and c.month_vy = :m
                        and c.year_vy  = :y
                        and c.shifrsta in (137,137+500)
                        and coalesce(a.main,1)<>0
                      into :basem, :basey;
       basem=coalesce(basem,0);
       if (basem not between 1 and 12) then basem=0;
       basey=coalesce(basey,0);
       if (basey not between 2008 and 2020) then basey=0;
       basedata='1900-01-01';
       if (basem>0 and basey>0) then
          basedata=basey||'-'||basem||'-01';   -- базовая дата сотрудника
       else
          begin
/*
                     basedata=null;
                     select first 1 a.data_pri from kadry a where a.tabno=:tabno into :basedata;
                     basedata=coalesce(basedata,'2008-10-01');
                     if (BaseData<'2008-10-01') then
                        BaseData='2008-10-01';
*/
               basedata=current_date; -- у кого дата не указана - не индексировать
          end
        select first 1  a.datab  from tb_proc_ind_koe a
               order by 1 desc
               into :datamax;
        datamax=coalesce(datamax, cast('1900-01-01' as date));
        if (basedata > DataMax) then
           retval=0;
        else
           retval=1;

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_ISOSNWRBYID (
    SHIFRID INTEGER)
RETURNS (
    SHIFRWR INTEGER)
AS
begin
     select w_r from person where shifrid=:shifrid into :shifrwr;
     shifrwr=coalesce(shifrwr,0);
     if (shifrwr<>1) then
        begin
            select count(*) from fcn
                   where fcn.shifridperson=:shifrid and
                         fcn.shifrsta in (82,82+500)
                   into :shifrwr;
            shifrwr=coalesce(shifrwr,0);
            if (shifrwr<>1) then shifrwr=2;
        end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_ISOTHERPERIODECBSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
--     if (ShifrVal in (14,15,12,32,5,6,10,11,13,154,155)) then
--     if (ShifrVal in (5,6,14,15,12,28,32,10,11,154,155,156,158)) then -- убран 13-й шифр - комп за неисп отпуск 31.01.2013
--     if (ShifrVal in (5,6,10,11,13,14,15,12,13,28,32,154,155,156,158)) then -- возвращен 13-й шифр 10.03.2016  (А В)
     if (ShifrVal in (5,6,10,11,13,14,15,12,13,28,32,154,155,156)) then -- возвращен 13-й шифр 10.03.2016  (А В)
     -- 28 - индексация (21 07 15 Алла Витальена сказала)
        RetVal=1;
  /* Procedure Text */
     suspend;
end^


ALTER PROCEDURE PR_ISOTHERPERIODECBSHIFR_PERS (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
--     if (ShifrVal in (14,15,12,32,5,6,10,11,13,154,155)) then
--     if (ShifrVal in (5,6,14,15,12,28,32,10,11,154,155,156,158)) then -- убран 13-й шифр - комп за неисп отпуск 31.01.2013
--     if (ShifrVal in (5,6,10,11,13,14,15,12,13,28,32,154,155,156,158)) then -- возвращен 13-й шифр 10.03.2016  (А В)
     if (ShifrVal in (5,6,10,11,13,14,15,12,13,28,32,154,155,156)) then -- убран 158 шифр 06.12.2018  (Т И)
     -- 28 - индексация (21 07 15 Алла Витальена сказала)
        RetVal=1;
  /* Procedure Text */
     suspend;
end^


ALTER PROCEDURE PR_ISOTHERPERIODECBSHIFR_Y (
    SHIFRVAL INTEGER,
    Y INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     if (y<2016) then
        retval=0;
     else
        select retval from pr_isotherperiodecbshifr(:shifrval) into :retval;
     suspend;
end^


ALTER PROCEDURE PR_ISOTPSHIFR (
    SHIFRVAL INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
begin
     retval=0;
  --   if (ShifrVal in (14,15,12,32,5,6,10,11,13)) then
  --   if (ShifrVal in (5,6,10,11,13)) then
     if (ShifrVal in (5,6,10,11)) then
        RetVal=1;
  /* Procedure Text */
     suspend;
end^


ALTER PROCEDURE PR_K_ADDPERSONTOSHTATRASP (
    SHIFRIDRASP INTEGER,
    SHIFRIDPERSON INTEGER,
    MODEFAC INTEGER)
AS
declare variable LINENO integer;
declare variable TABNO integer;
declare variable W_R integer;
declare variable SHIFRGRU integer;
declare variable KOEF decimal(15,2);
declare variable SHIFRIDDOLG integer;
declare variable SHIFRIDSHT integer;
declare variable SHIFRIDK integer;
declare variable FIO varchar(50);
declare variable SHIFRUS integer;
declare variable SHIFRUZ integer;
declare variable SHIFRPODOSN integer;
declare variable KOEFBUD decimal(15,2);
declare variable KOEFVNE decimal(15,2);
declare variable RAZR integer;
declare variable OKLADRAZR decimal(10,2);
declare variable SHIFRUSW integer;
declare variable PROCNUS integer;
declare variable SUMMANUSB decimal(10,2);
declare variable SUMMANUSV decimal(10,2);
declare variable OKLADB decimal(10,2);
declare variable OKLADV decimal(10,2);
declare variable PROCNUZ decimal(10,2);
declare variable SUMMANUZB decimal(10,2);
declare variable SUMMANUZV decimal(10,2);
declare variable STAGPY integer;
declare variable STAGPM integer;
declare variable STAGP decimal(10,2);
declare variable PROCNPSTAG decimal(10,2);
declare variable SUMMANPSTAGB decimal(10,2);
declare variable SUMMANPSTAGV decimal(10,2);
declare variable SHIFRPSTAGN integer;
declare variable PRIORITY integer;
declare variable SHIFRZASL integer;
declare variable PROCNZASL decimal(10,2);
declare variable SUMMANZASLB decimal(10,2);
declare variable SUMMANZASLV decimal(15,2);
declare variable TMPINT integer;
declare variable SHIFRIDDOLGFORFINDING integer;
declare variable WANTEDDATE date;
declare variable SUMMAPOV decimal(10,2);
declare variable SUMMAPOVBUD decimal(10,2);
declare variable SUMMAPOVVNE decimal(10,2);
declare variable SUMMAPOVFULL decimal(10,2);
declare variable SHIFRKAF integer;
declare variable ISZAWKAF integer;
declare variable ISDOCONOTHERDOLG integer;
declare variable PROCNADBZAWKAF decimal(10,2);
declare variable SUMMANADBZAWKAF decimal(10,2);
declare variable SUMMANADBZAWKAFBUD decimal(10,2);
declare variable SUMMANADBZAWKAFVNE decimal(10,2);
declare variable FIXED integer;
declare variable ISZAMDEKANA integer;
declare variable SUMMAZAMDECVNE decimal(15,2);
declare variable SUMMAZAMDECBUD decimal(15,2);
declare variable SUMMAZAMDECTOT decimal(15,2);
declare variable PROCZAMDEC decimal(15,2);
declare variable ISDEKAN integer;
declare variable SHIFRDOLOSN integer;
begin
     if (modefac=0) then
        select first 1 a.datefr,a.shifrpod from tb_k_shtraspped a
                                where a.shifrid=:shifridrasp
                                into :wanteddate,:shifrkaf;
     else
        select first 1 a.datefr,a.shifrfac from tb_k_shtraspped a
                                where a.shifrid=:shifridrasp
                                into :wanteddate,:shifrkaf;



     select a.tabno,
            (select first 1 shifrwr from pr_isosnwrbyid(a.shifrid)) as w_r,
            a.shifrgru,
            (select first 1 koef from PR_GET_KOEF_PERSON_BY_ID(a.shifrid)) as koef,
            (select first 1 shifriddolg from PR_GET_DOLG_PERSON_BY_ID(a.shifrid)) as shifriddolg,
            a.m_o_r,
            (select first 1 razrijad from PR_GET_RAZR_PERSON_BY_ID(a.shifrid)) as razr
            from person a
            where a.Shifrid=:ShifridPerson
            into :tabno,:w_r,:shifrgru,:koef,:shifriddolg,:shifrpodosn,:razr;
 -- Проверить - не блокирована ли
 -- Если блокирован то выйти
     fixed=null;
     select first 1 a.fixed from tb_k_shtrasppedrec a
       --             join tb_k_shtraspped b on a.shifridown=b.shifrid
                    where a.tabno=coalesce(:tabno,0)
                      and a.shifridown=:shifridrasp
                      and a.shifrwr=coalesce(:w_r,1)
                    into :fixed;
     if (coalesce(:fixed,0)=1) then
        Exit;
 --   выйти, если ручной вариант
 --   конец проверки


     koef=coalesce(koef,0);
     razr=coalesce(razr,0);
     if (razr=0) then
        if (shifriddolg=160) then
           razr=19;
     if (razr=0) then
         razr = case
                    when shifriddolg in (90,100)          then  21   -- зав. каф
                    when shifriddolg in (110,120,130,140) then  20   -- профессор
                    when shifriddolg in (150,160,170)     then  19   -- доцент
                    when shifriddolg in (200,210)         then  17   -- старш.преп.
                    when shifriddolg in (190)             then  16   -- преподаватель
                    when shifriddolg in (220,230)         then  16   -- асс.
                    when shifriddolg in (1439)            then  16   -- преподаватель 1-й категории
                    when shifriddolg in (240)             then  15   -- преп-стажер
                end;

     shifriddolgforfinding= case
                               when shifriddolg in (90,100)          then  90   -- зав. каф.
                               when shifriddolg in (110,120,130,140) then  110  -- профессор
                               when shifriddolg in (150,160,170)     then  150  -- доцент
                               when shifriddolg in (200,210)         then  200  -- старш.преп.
                               when shifriddolg in (190)             then  190  -- преподаватель
                               when shifriddolg in (220,230,1439)    then  220  -- асс.
                               when shifriddolg in (1439)            then  1439 -- преподаватель 1-й категории
                               when shifriddolg in (240)             then  240  -- преп-стажер
                             end;
     if (modefac>0) then
        shifriddolgforfinding=case (modefac)
                                  when 1 then 70     -- декан
                                  when 2 then 80     -- зам декана
                                  when 3 then 47     -- директор
                                  when 4 then 80     -- замдекана
                              end;
     select first 1 a.shifrid,a.fio from tb_k_Kadry a
            where a.tabno=:tabno
            into :shifridk,:fio;
     shifridk = coalesce(:shifridk,0);
     iszawkaf = 0;
     if (shifriddolg not in(90,100)) then
        begin
              select first 1 a.shifrusz from tb_k_kadrypr a
                           where a.shifridowner=:shifridk
                             and a.codetype=5
                             and coalesce(a.datefr,cast('1900-01-01' as date))<=:wanteddate
                             and (
                                  (coalesce(a.dateto,current_date)>=:wanteddate) or
                                  (extract(year from coalesce(a.dateto, cast('1900-01-01' as date )))<1950)
                                 )
                           into :iszawkaf;
              iszawkaf=coalesce(iszawkaf, 0);
              if (iszawkaf=shifrkaf) then
                 iszawkaf=1;
              else
                 iszawkaf=0;
        end
     else
        iszawkaf=1;


  -- проверить доцента на др должности
    ISDOCONOTHERDOLG=0;
    select first 1 a.shifrusz from tb_k_kadrypr a
           where a.shifridowner=:shifridk
             and a.codetype=8
             and coalesce(a.datefr,cast('1900-01-01' as date))<=:wanteddate
             and (
                  (coalesce(a.dateto,current_date)>=:wanteddate) or
                  (extract(year from coalesce(a.dateto, cast('1900-01-01' as date )))<1950)
                 )
           into :ISDOCONOTHERDOLG;
    ISDOCONOTHERDOLG=coalesce(ISDOCONOTHERDOLG,0);
  -- конец проверки доцента на др должности



     shifridsht=null;
     select first 1 b.shifrid from tb_k_shtrasppedrec b
                              where b.tabno      = :tabno      and
                                    b.shifridown = :shifridrasp and
                                    b.shifrwr    = :w_r        and
                                    b.shifrdol   = :shifriddolgforfinding
                              into :shifridsht;
     if (shifridsht is not null) then    -- была запись, значит только добавить бюджетную или внебюджетную части
           begin
                if (shifrgru=1) then
                   begin
                        update tb_k_shtrasppedrec a    -- заполнить бюджетную часть
                           set a.summapovvne  = a.summapovfull * (coalesce(a.koefbud,0.00)+coalesce(a.koefvne,0.00)+:koef)
                     --     a.summapovbud  = a.summapov*:koef
                           where
                              shifrid=:shifridsht;
                        update tb_k_shtrasppedrec a    -- заполнить бюджетную часть
                           set a.koefbud             = coalesce(a.koefbud, 0.00)              + :koef,
                               a.okladb              = coalesce(a.okladb, 0.00)               + coalesce(a.okladrazr,0.00)*:koef,
                               a.summanusb           = coalesce(a.summanusb, 0.00)            + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnus,0.00)         / 100.00),
                               a.summanuzb           = coalesce(a.summanuzb, 0.00)            + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnuz,0.00)         / 100.00),
                               a.summanpstagb        = coalesce(a.summanpstagb, 0.00)         + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnpstag,0.00)      / 100.00),
                               a.summanzaslb         = coalesce(a.summanzaslb, 0.00)          + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnzasl,0.00)       / 100.00),
                               a.summazamdecbud      = coalesce(a.summazamdecbud, 0.00)       + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.proczamdec,0.00)      / 100.00),
                               a.summanadbzawkafbud  = coalesce(a.summanadbzawkafbud, 0.00)   + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnadbzawkaf,0.00)  / 100.00)
                     --          a.summapovvne  = a.summapovfull * (coalesce(a.koefbud,0.00)+coalesce(a.koefvne,0.00)+:koef)
                     --     a.summapovbud  = a.summapov*:koef
                           where
                              shifrid=:shifridsht;
                   end
                else
                   begin
                        update tb_k_shtrasppedrec a
                           set
                               a.summapovvne  = a.summapovfull * (coalesce(a.koefbud,0.00)+coalesce(a.koefvne,0.00)+:koef)
                          where
                               shifrid=:shifridsht;
                        update tb_k_shtrasppedrec a
                           set a.koefvne             = coalesce(a.koefvne, 0.00)              + :koef,
                               a.okladv              = coalesce(a.okladv, 0.00)               + coalesce(a.okladrazr,0.00)*:koef,
                               a.summanusv           = coalesce(a.summanusv, 0.00)            + (coalesce(a.okladrazr,0.00)*:koef+coalesce(summapovvne,0.00))*(coalesce(a.procnus,0.00)        / 100.00),
                               a.summanuzv           = coalesce(a.summanuzv, 0.00)            + (coalesce(a.okladrazr,0.00)*:koef+coalesce(summapovvne,0.00))*(coalesce(a.procnuz,0.00)        / 100.00),
                               a.summanpstagv        = coalesce(a.summanpstagv, 0.00)         + (coalesce(a.okladrazr,0.00)*:koef+coalesce(summapovvne,0.00))*(coalesce(a.procnpstag,0.00)     / 100.00),
                               a.summanzaslv         = coalesce(a.summanzaslv, 0.00)          + (coalesce(a.okladrazr,0.00)*:koef+coalesce(summapovvne,0.00))*(coalesce(a.procnzasl,0.00)      / 100.00),
                               a.summazamdecvne      = coalesce(a.summazamdecvne, 0.00)       + coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.proczamdec,0.00)      / 100.00),
                               a.summanadbzawkafvne  = coalesce(a.summanadbzawkafvne, 0.00)   + (coalesce(a.okladrazr,0.00)*:koef+coalesce(summapovvne,0.00))*(coalesce(a.procnadbzawkaf,0.00) / 100.00)
         --                      a.summapovvne  = a.summapovfull * (coalesce(a.koefbud,0.00)+coalesce(a.koefvne,0.00)+:koef)
                          where
                               shifrid=:shifridsht;
                   end
                update  tb_k_shtrasppedrec a
                   set a.summapov=coalesce(a.summapovbud,0.00)+coalesce(a.summapovvne,0.00),
                       a.summazamdectot=coalesce(a.summazamdecbud,0.00)+coalesce(a.summazamdecvne,0.00)
                     where
                          shifrid=:shifridsht;
        end
     else                                -- добавить новую запись
         begin
              LineNo   = LineNo + 1;
              shifridk = null;
              fio      = null;
              select first 1 a.shifrid,a.fio from tb_k_Kadry a where a.tabno=:tabno into :shifridk,:fio;
              shifridk = coalesce(:shifridk,0);
              fio      = coalesce(fio, 'Не найден в кадрах');
              fio      = trim(fio);
              koefbud  = null;
              koefvne  = null;
     --         koefbud  = 0;
     --         koefvne  = 0;
              if (:shifrgru=1) then
                 koefbud = koef;
              else
                 koefvne = koef;
              okladrazr = null;
              if (razr between 1 and 25) then
                 select first 1 a.oklad from tb_razr_proc a
                                        where a.razr=:razr and a.datefr<=:wanteddate
                                        order by a.datefr desc
                                        into :okladrazr;
              okladrazr = coalesce(okladrazr , 0.00);
              okladb    = okladrazr * koefbud;
              okladv    = okladrazr * koefvne;

                -- Ученая степень
              shifrusw = null;
              shifrus  = null;
              select first 1 b.shifrusz from tb_k_kadrypr b
                                        where b.shifridowner=:shifridk and
                                              b.codetype=1             and
                                              b.datefr<=:wanteddate    and
                                              coalesce(b.datepodtv,b.datefr)<=:Wanteddate and
                                              coalesce(b.dateto,current_date) >:WantedDate
                                        order by b.datefr desc
                                        into :shifrus;
             shifrus  = coalesce(shifrus,0);
             summanusb = 0.00;
             summanusv = 0.00;
             procnus   = 0.00;
             if (shifrus>0) then     -- кандидат или доктор
                begin
                     shifrusw=null;
                     select first 1 a.shifrwiduchst from tb_k_uch_st_spr a
                                       where a.shifrid=:shifrus
                                       into :shifrusw;
                     shifrusw=coalesce(:shifrusw,0);
                     if (shifrusw in (1,2)) then    -- 1 - канд: 2 - докт
                        begin
                             procnus = null;
                             select first 1  b.summa from tb_k_widnadb a
                                                  join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                                  where b.datefr<=:wanteddate and
                                                        b.shifrid=:shifrusw
                                                  order by b.datefr desc
                                                  into :procnus;
                             procnus   = coalesce(procnus,0);
                             summanusb = okladb*procnus/100.00;
                             summanusv = okladv*procnus/100.00;
                             summanusb = coalesce(summanusb,0.00);
                             summanusv = coalesce(summanusv,0.00);
                        end
                end

                -- Ученое звание
             shifruz=null;
             select first 1 b.shifrusz from tb_k_kadrypr b
                                       where b.shifridowner=:shifridk and
                                             b.codetype=2             and
                                             b.datefr<=:wanteddate    and
                                             coalesce(b.datepodtv,b.datefr) <= :Wanteddate and
                                             coalesce(b.dateto,current_date) >:WantedDate

                                       order by b.datefr desc
                                            into :shifruz;
              shifruz   = coalesce(shifruz,0);    -- доц(1) проф(2) или снс(3)
              summanuzb = 0.00;
              summanuzv = 0.00;
              procnuz   = 0.00;
              if (shifruz>0) then
                 begin
--                          shifruzw=null;
--                            select first 1 a.shifrwiduchst from tb_k_uch_st_spr a
--                                             where a.shifrid=:shifrus
--                                             into :shifrusw;
--                            shifrusw=coalesce(:shifrusw,0);
                      if (shifruz in (1,2,3)) then
                         begin
                              procnuz=null;
                              if (shifruz in (1,2)) then  -- доц или проф
                                 tmpint=shifruz+2;
                              else
                                 tmpint=10;     -- с н с
                              select first 1  b.summa from tb_k_widnadb a
                                                join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                                where b.datefr<=:wanteddate and
                                                      b.shifrid=:tmpint
                                                order by b.datefr desc
                                                into :procnuz;
                              procnuz   = coalesce(procnuz,0.00);
                              summanuzb = okladb * procnuz / 100.00;
                              summanuzv = okladv * procnuz / 100.00;
                              summanuzb = coalesce(summanuzb,0.00);
                              summanuzv = coalesce(summanuzv,0.00);
                         end
                 end
                -- Декан
             isdekan = 0;
             if (modefac in (1,3)) then
                begin
                     select first 1 b.shifrid,b.proczamdec from tb_k_decany b
                                       where b.shifridkadry   = :shifridk and
                                             b.codedolg in (1,3)      and
                                             :wanteddate between b.datefr and
                                             coalesce(b.dateto,cast('2050-01-01' as date))
                                       order by b.datefr desc
                                            into :isdekan,:proczamdec;
                     isdekan=coalesce(isdekan, 0);
                     proczamdec=coalesce(proczamdec,0.00);
                     if (proczamdec>2) then  -- надбавка 6% некоторым деканам
                        begin
                             SUMMAZAMDECBUD=0;
                             SUMMAZAMDECVNE = (coalesce(okladb,0.00) +
                                               coalesce(okladv, 0.00)) * proczamdec / 100.00;
                             SUMMAZAMDECTOT = SUMMAZAMDECBUD + SUMMAZAMDECVNE;
                        end

                     if (isdekan>0) then
                        isdekan=1;
                end
                -- Зам декана
             iszamdekana=0;
             if (modefac in (2,4)) then
                begin
                     select first 1 b.shifrid,b.proczamdec from tb_k_decany b
                                       where b.shifridkadry   = :shifridk and
                                             b.codedolg in (2,4)      and
                                             :wanteddate between b.datefr and
                                             coalesce(b.dateto,cast('2050-01-01' as date))
                                       order by b.datefr desc
                                            into :iszamdekana,:proczamdec;
                     iszamdekana = coalesce(iszamdekana , 0   );
                     proczamdec  = coalesce(proczamdec  , 0.00);
                     if (iszamdekana>0) then
                        iszamdekana = 1   ;
                     SUMMAZAMDECBUD = 0.00;
                     SUMMAZAMDECVNE = 0.00;
                     SUMMAZAMDECTOT = 0.00;
                     if (iszamdekana>0) then
                        begin
                             if (proczamdec<10) then
                                 proczamdec=30;
                             SUMMAZAMDECBUD = okladb * proczamdec / 100.00;
                             SUMMAZAMDECVNE = okladv * proczamdec / 100.00;
                             SUMMAZAMDECBUD = coalesce(SUMMAZAMDECBUD,0.00);
                             SUMMAZAMDECVNE = coalesce(SUMMAZAMDECVNE,0.00);
                             SUMMAZAMDECTOT = SUMMAZAMDECBUD + SUMMAZAMDECVNE;
                        end
                 end


    -- Підвищення до 01 03 2012 була
              shifrusw=coalesce(shifrusw, 0);
              summapov     = 0;
              summapovbud  = 0;
              summapovvne  = 0;
              summapovfull = 0;
              if (WantedDate<cast('2012-03-01' as date)) then
                 begin
                      if (shifrusw=1) then summapov  = 183;
                      else if (shifrusw=2) then summapov  = 732;
                      if (summapov<0.01) then
                         if (shifruz=1) then summapov  = 183;
                         else if (shifruz=2) then summapov  = 732;
                      --     if (shifrgru=1) then
                      --        summapovbud = summapov * koef;
                      --     else
                      summapovfull=summapov;
                      summapovvne = summapovfull * koef;
              -- скорректировать надбавки с учетом повышения
                      if (Procnus>0.01) then
                         begin
                             summanusv = (coalesce(okladv,0.00)+coalesce(summapovvne,0.00))*procnus/100.00;
                             summanusv = coalesce(summanusv,0.00);
                         end

                      if (Procnuz>0.01) then
                         begin
                              summanuzv = (coalesce(okladv,0.00)+coalesce(summapovvne,0.00))*procnuz/100.00;
                              summanuzv = coalesce(summanuzv,0.00);
                         end

                 end
          -- Надбавка за звание заслуженного  (діяча, артиста, юриста, винахідника и т д)
              shifrzasl=null;
              select first 1 b.shifrusz from tb_k_kadrypr b
                                        where b.shifridowner=:shifridk and
                                              b.codetype=3             and
                                              b.datefr<=:wanteddate    and
                                              coalesce(b.datepodtv,b.datefr)<=:Wanteddate and
                                              coalesce(b.dateto,current_date) >:WantedDate
                                        order by b.datefr desc
                                        into :shifrzasl;
              shifrzasl   = coalesce(shifrzasl,0);
              summanzaslb = 0.00;
              summanzaslv = 0.00;
              procnzasl   = 0.00;
              if (shifrzasl>0) then
                 begin
                      procnzasl = null;
                      select first 1  b.summa from tb_k_widnadb a
                             join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                             join tb_k_widyzasl c on a.shifrid=c.shifrnadb
                             where b.datefr<=:wanteddate and
                                   c.shifrid=:shifrzasl
                             order by b.datefr desc
                             into :procnzasl;
                      procnzasl   = coalesce(procnzasl,0.00);
                      summanzaslb = okladb * procnzasl / 100.00;
                      summanzaslv = (coalesce(okladv,0.00)+coalesce(summapovvne,0.00)) * procnzasl / 100.00;
                      summanzaslb = coalesce(:summanzaslb,0.00);
                      summanzaslv = coalesce(:summanzaslv,0.00);
                 end

          -- Надбавка за зав. кафедрой (дается доцентам. с 1.04.2012 12% а была 20%)

              procnadbzawkaf     = 0.00;
              summanadbzawkaf    = 0.00;
              summanadbzawkafbud = 0.00;
              summanadbzawkafvne = 0.00;
              if (iszawkaf=1) then
                 begin
                     select first 1 a.summa from fcn a
                                            where a.shifridperson=:shifridperson
                                              and a.shifrsta=41  -- надбавка за заведевание
                                            into :procnadbzawkaf;
                     procnadbzawkaf=coalesce(procnadbzawkaf, 0.00);

                 end
              if (procnadbzawkaf>0.01) then
                 begin
                      summanadbzawkafbud = okladb * procnadbzawkaf / 100.00;
                      summanadbzawkafvne = (coalesce(okladv,0.00)+coalesce(summapovvne,0.00)) * procnadbzawkaf / 100.00;
                      summanadbzawkafbud = coalesce(:summanadbzawkafbud,0.00);
                      summanadbzawkafvne = coalesce(:summanadbzawkafvne,0.00);
                 end


              --- Пед стаж ---

              stagpy       = 0;
              stagpm       = 0;
              stagp        = 0.00;
              procnpstag   = 0.00;
              summanpstagb = 0.00;
              summanpstagv = 0.00;
              select first 1 y,m from pr_k_pedstag(:tabno,:wanteddate) into :stagpy,:stagpm;
              stagpy       = coalesce(stagpy,0);
              stagpm       = coalesce(stagpm,0);
              stagp        = cast(stagpy as decimal(12,2)) + (cast(stagpm as decimal(12,2)) / 12.00);
              stagp        = coalesce(stagp,0);
              shifrpstagn   = case
                                  when (stagp between 3 and 9.99)   then 8
                                  when (stagp between 10 and 19.99) then 7
                                  when (stagp>=20)                  then 6
                                  else 0
                              end;
              if (shifrpstagn>4) then
                 begin
                      procnpstag = null;
                      select first 1  b.summa from tb_k_widnadb a
                             join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                             where b.datefr<=:wanteddate and
                                   b.shifrid=:shifrpstagn
                             order by b.datefr desc
                             into :procnpstag;
                      procnpstag   = coalesce(procnpstag,0.00);
                      summanpstagb = okladb * procnpstag / 100.00;
                      summanpstagv = (coalesce(okladv,0.00)+coalesce(summapovvne,0.00)) * procnpstag / 100.00;
                      summanpstagb = coalesce(:summanpstagb,0.00);
                      summanpstagv = coalesce(:summanpstagv,0.00);
                 end
              priority= case
                            when iszawkaf=1                       then 14  -- зав. каф.
                            when shifriddolg in (90,100)          then 14  -- зав. каф.
                            when shifriddolg in (110,120,130,140) then 12  -- профессор
                            when shifriddolg in (150,160,170)     then 10  -- доцент
                            when shifriddolg in (200,210)         then  8  -- старш.преп.
                            when shifriddolg in (190)             then  6  -- преподаватель
                            when shifriddolg in (220,230)         then  4  -- асс.
                            when shifriddolg in (240)             then  2  -- преп-стажер
                            else 0
                        end;
              if ((tabno=4671) and (priority>0)) then   -- 4671 Коваль - зам зав военной кафедры и печатать его вторым
                  priority=priority-1;

               select first 1 shifrdol from pr_get_dolg_id_person_y_m(:tabno,extract(year from :wanteddate),extract(month from :wanteddate)) into :shifrdolosn;
               shifrdolosn=coalesce(:shifrdolosn,0);
               insert into tb_k_shtrasppedrec (shifridown     ,  lineno         ,  shifridk    ,  tabno   , fio ,
                                               shifrus        ,  shifruz        ,  shifrdol    ,  koefbud , koefvne,
                                               shifrpodosn    ,  shifrwr        ,  datefr            ,  dateto  ,
                                               razr           ,  okladrazr      , okladb             ,  okladv  ,
                                               procnus        ,  summanusb      , summanusv          ,
                                               procnuz        ,  summanuzb      , summanuzv          ,
                                               stagpy         ,  stagpm         , stagp              ,
                                               procnpstag     ,  summanpstagb   , summanpstagv       ,
                                               shifrzasl      ,  procnzasl      , summanzaslb        , summanzaslv  ,
                                               priority       ,  summapov       , summapovbud        , summapovvne  ,
                                               summapovfull   ,  iszawkaf       , ISDOCONOTHERSTAWKA ,
                                               procnadbzawkaf , summanadbzawkaf , summanadbzawkafbud , summanadbzawkafvne,
                                               iszamdekana    , summazamdecbud  , summazamdecvne     , summazamdectot ,
                                               proczamdec     , isdekan , shifrdolosn)
                                      values (:shifridRASP    , :lineno          , :shifridk     , :tabno      , :fio ,
                                              :shifrus        , :shifruz         , :shifriddolgforfinding  , :koefbud    , :koefvne,
                                              :shifrpodosn    , :w_r             , :wanteddate             , :wanteddate ,
                                              :razr           , :okladrazr       , :okladb                 , :okladv     ,
                                              :procnus        , :summanusb       , :summanusv              ,
                                              :procnuz        , :summanuzb       , :summanuzv              ,
                                              :stagpy         , :stagpm          , :stagp                  ,
                                              :procnpstag     , :summanpstagb    , :summanpstagv           ,
                                              :shifrzasl      , :procnzasl       , :summanzaslb            , :summanzaslv ,
                                              :priority       , :summapov        , :summapovbud            , :summapovvne ,
                                              :summapovfull   , :iszawkaf        , :isdoconotherdolg       ,
                                              :procnadbzawkaf , :summanadbzawkaf , :summanadbzawkafbud     , :summanadbzawkafvne,
                                              :iszamdekana    , :summazamdecbud  , :summazamdecvne         , :summazamdectot,
                                              :proczamdec     , :isdekan, :shifrdolosn);
         end
end^


ALTER PROCEDURE PR_K_CMPSHTRASP (
    DATEFR DATE,
    DATETO DATE,
    SHIFRWR INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    MES VARCHAR(1024))
AS
declare variable SHIFRIDSHT integer;
declare variable SHIFRIDSHTRECFR integer;
declare variable KOEFBUDFR decimal(15,2);
declare variable KOEFVNEFR decimal(15,2);
declare variable SHIFRUSFR integer;
declare variable SHIFRUZFR integer;
declare variable SHIFRZASLFR integer;
declare variable RAZRFR integer;
declare variable ISDEKANFR integer;
declare variable ISZAWKAFFR integer;
declare variable ISDOCONOTHERSTAWKAFR integer;
declare variable ISZAMDEKANAFR integer;
declare variable SHIFRIDSHTRECTO integer;
declare variable KOEFBUDTO decimal(15,2);
declare variable KOEFVNETO decimal(15,2);
declare variable SHIFRUSTO integer;
declare variable SHIFRUZTO integer;
declare variable SHIFRZASLTO integer;
declare variable RAZRTO integer;
declare variable ISDEKANTO integer;
declare variable ISZAWKAFTO integer;
declare variable ISDOCONOTHERSTAWKATO integer;
declare variable ISZAMDEKANATO integer;
declare variable SHIFRPODFR integer;
declare variable SHIFRPODTO integer;
declare variable SHIFRDOLFR integer;
declare variable SHIFRDOLTO integer;
declare variable NAMEDOLFR varchar(50);
declare variable NAMEDOLTO varchar(50);
begin
     for
        select a.shifrid,a.shifrpod from  tb_k_shtraspped a
                         where a.datefr=:datefr
                         into  :shifridsht,:shifrpodfr
     do
        for
           select b.shifrid,b.tabno,b.koefbud,b.koefvne,
                  b.shifrus,b.shifruz,b.shifrzasl,b.razr,
                  b.isdekan,b.iszawkaf,b.iszamdekana,b.isdoconotherstawka,
                  b.fio,b.shifrdol
                            from  tb_k_shtrasppedrec b
                            where b.shifridown = :shifridsht and
                                  b.shifrwr    = :shifrwr
                            into  :shifridshtrecfr,:tabno,:koefbudfr,:koefvnefr,
                                  :shifrusfr,:shifruzfr,:shifrzaslfr,:razrfr,
                  :isdekanfr,:iszawkaffr,:iszamdekanafr,:isdoconotherstawkafr,
                  :fio,:shifrdolfr
        do
           begin
                shifridshtrecto=null;
                select first 1 c.shifrid,c.koefbud,c.koefvne,
                  c.shifrus,c.shifruz,c.shifrzasl,c.razr,
                  c.isdekan,c.iszawkaf,c.iszamdekana,c.isdoconotherstawka,
                  d.shifrpod,c.shifrdol
                  from tb_k_shtrasppedrec c
                       join tb_k_shtraspped d on c.shifridown=d.shifrid
                  where c.tabno   = :tabno
                    and d.datefr  = :dateto
                    and c.shifrwr = :shifrwr
                  into  :shifridshtrecto,:koefbudto,:koefvneto,
                        :shifrusto,:shifruzto,:shifrzaslto,:razrto,
                        :isdekanto,:iszawkafto,:iszamdekanato,:isdoconotherstawkato,
                        :shifrpodto,:shifrdolto;
                  mes='';
                  if (coalesce(shifridshtrecto,0)=0) then
                     Mes='Не найден в шт.расписании за '||:dateto||', но есть за '||:datefr||' в подр '||:shifrpodfr;
               --      'Не найден во втором штатном расписании';
                  else
                     begin
                          if (coalesce(Koefbudfr,0)<>coalesce(Koefbudto,0)) then
                             mes=' К-т буд '||Koefbudfr||' - '||Koefbudto;
                          if (coalesce(Koefvnefr,0)<>coalesce(Koefvneto,0)) then
                             mes=trim(mes)||' К-т вне '||Koefvnefr||' - '||Koefvneto;
                          if (coalesce(shifrusfr,0)<>coalesce(shifrusto,0)) then
                             mes=mes||' Уч ст '||shifrusfr||' - '||shifrusto;
                          if (coalesce(shifruzfr,0)<>coalesce(shifruzto,0)) then
                             mes=mes||' Уч зв '||shifruzfr||' - '||shifruzto;
                          if (coalesce(shifrzaslfr,0)<>coalesce(shifrzaslto,0)) then
                             mes=mes||' Засл ст '||shifrzaslfr||' - '||shifrzaslto;
                          if (coalesce(razrfr,0)<>coalesce(razrto,0)) then
                             mes=mes||' Разряд '||razrfr||' - '||razrto;
                          if (coalesce(isdekanfr,0)<>coalesce(isdekanto,0)) then
                             mes=mes||' Декан '||isdekanfr||' - '||isdekanto;
                          if (coalesce(iszamdekanafr,0)<>coalesce(iszamdekanato,0)) then
                             mes=mes||' Зам.декана. '||iszamdekanafr||' - '||iszamdekanato;
                          if (coalesce(iszawkaffr,0)<>coalesce(iszawkafto,0)) then
                             mes=mes||' Зав.каф. '||iszawkaffr||' - '||iszawkafto;
                          if (coalesce(isdoconotherstawkafr,0)<>coalesce(isdoconotherstawkato,0)) then
                             mes=mes||' Доц.на др.ставке '||isdoconotherstawkafr||' - '||isdoconotherstawkato;
                          if (coalesce(shifrpodfr,0)<>coalesce(shifrpodto,0)) then
                             mes=mes||' Кафедра '||shifrpodfr||' - '||shifrpodto;
                          if (coalesce(shifrdolfr,0)<>coalesce(shifrdolto,0)) then
                             begin
                                  select first 1 a.name from tb_dolg a
                                                  where a.shifrdol=:shifrdolfr
                                                  into namedolfr;
                                  select first 1 a.name from tb_dolg a
                                                  where a.shifrdol=:shifrdolto
                                                  into namedolto;
                                  mes=mes||' Должность '||trim(namedolfr)||' - '||trim(namedolto);
                             end
                     end
                 if (strlen(trim(mes))>0) then
                    suspend;


           end
   -- 2-й шаг
  mes='Отсутствующие в '||:dateFr|| ' и присутсвтующие в '||:DateTo;
  fio='--- Второй шаг проверки --';
  tabno=0;
  suspend;
     for
        select e.shifrid,e.shifrpod from  tb_k_shtraspped e
                         where e.datefr=:dateto
                         into  :shifridsht,:shifrpodto
     do
        for
           select f.tabno,f.fio
                            from  tb_k_shtrasppedrec f
                            where f.shifridown = :shifridsht and
                                  f.shifrwr    = :shifrwr and
                                  not exists (
                                     select * from tb_k_shtrasppedrec g
                                              join tb_k_shtraspped h on h.shifrid=g.shifridown
                                              where g.tabno   = f.tabno and
                                                    g.shifrwr =  :shifrwr and
                                                    h.datefr  =  :datefr
                                  )
                            into  :tabno,:fio
        do
           begin
                mes='Не найден в шт.расписании за '||:datefr||', но есть за '||:dateto||' в подр '||:shifrpodto;
                 if (strlen(trim(mes))>0) then
                    suspend;
           end
  mes='';
  fio='---Конец анализа сравнения--';
  tabno=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CMPSTAGSHTRASPWITHSAL (
    DATEFR DATE,
    SHIFRWR INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    MES VARCHAR(1024))
AS
declare variable SHIFRIDSHT integer;
declare variable SHIFRIDSHTRECFR integer;
declare variable KOEFBUDFR decimal(15,2);
declare variable KOEFVNEFR decimal(15,2);
declare variable SHIFRUSFR integer;
declare variable SHIFRUZFR integer;
declare variable SHIFRZASLFR integer;
declare variable RAZRFR integer;
declare variable ISDEKANFR integer;
declare variable ISZAWKAFFR integer;
declare variable ISDOCONOTHERSTAWKAFR integer;
declare variable ISZAMDEKANAFR integer;
declare variable SHIFRIDSHTRECTO integer;
declare variable KOEFBUDTO decimal(15,2);
declare variable KOEFVNETO decimal(15,2);
declare variable SHIFRUSTO integer;
declare variable SHIFRUZTO integer;
declare variable SHIFRZASLTO integer;
declare variable RAZRTO integer;
declare variable ISDEKANTO integer;
declare variable ISZAWKAFTO integer;
declare variable ISDOCONOTHERSTAWKATO integer;
declare variable ISZAMDEKANATO integer;
declare variable SHIFRPODFR integer;
declare variable SHIFRPODTO integer;
declare variable SHIFRDOLFR integer;
declare variable SHIFRDOLTO integer;
declare variable NAMEDOLFR varchar(50);
declare variable NAMEDOLTO varchar(50);
declare variable PROCNUSFR decimal(10,2);
declare variable PROCNUSTO decimal(10,2) = 0;
declare variable PROCNUZFR decimal(15,2);
declare variable PROCNUZTO decimal(15,2);
declare variable PROCNPSTAGFR decimal(15,2);
declare variable PROCNPSTAGTO decimal(15,2);
begin
     for
        select a.shifrid,a.shifrpod from  tb_k_shtraspped a
                         where a.datefr=:datefr
                         into  :shifridsht,:shifrpodfr
     do
        for
           select b.shifrid,b.tabno,b.koefbud,b.koefvne,
                  b.shifrus,b.shifruz,b.shifrzasl,b.razr,
                  b.isdekan,b.iszawkaf,b.iszamdekana,b.isdoconotherstawka,
                  b.fio,b.shifrdol,coalesce(b.procnus,0),coalesce(b.procnuz,0),coalesce(b.procnpstag,0)
                            from  tb_k_shtrasppedrec b
                            where b.shifridown = :shifridsht and
                                  b.shifrwr    = :shifrwr
                              --    and b.tabno=1542
                            into  :shifridshtrecfr,:tabno,:koefbudfr,:koefvnefr,
                                  :shifrusfr,:shifruzfr,:shifrzaslfr,:razrfr,
                  :isdekanfr,:iszawkaffr,:iszamdekanafr,:isdoconotherstawkafr,
                  :fio,:shifrdolfr,:procnusfr,:procnuzfr,:procnpstagfr
        do
           begin
                if (tabno=1542) then
                   tabno=1542;
                shifridshtrecto=null;
                procnusto=0;
                procnuzto=0;
                procnpstagto=0;
                select first 1 coalesce(d.summa,0.00)
                  from person c
                       join fcn d on c.shifrid=d.shifridperson
                  where c.tabno   = :tabno
                    and c.yearvy  = extract(year  from :datefr)
                    and c.monthvy = extract(month from :datefr)
                    and d.shifrsta=18   -- за научную степень
                  into  :procnusto;
                select first 1 coalesce(h.summa,0.00)
                  from person g
                       join fcn h on g.shifrid=h.shifridperson
                  where g.tabno   = :tabno
                    and g.yearvy  = extract(year  from :datefr)
                    and g.monthvy = extract(month from :datefr)
                    and h.shifrsta=22   -- за ученое звание
                  into  :procnuzto;
                select first 1 coalesce(f.summa,0.00)
                  from person e
                       join fcn f on e.shifrid=f.shifridperson
                  where e.tabno   = :tabno
                    and e.yearvy  = extract(year  from :datefr)
                    and e.monthvy = extract(month from :datefr)
                    and f.shifrsta=8   -- за выслугу лет
                  into  :procnpstagto;
                mes='';
                if (procnusfr<>procnusto) then
                   Mes='Науч.степ.в з.п. '||:procnusto||', в приказе '||:procnusfr;
                if (procnuzfr<>procnuzto) then
                   Mes='уч.зван.в з.п. '||:procnuzto||', в приказе '||:procnuzfr;
                if (procnpstagfr<>procnpstagfr) then
                   Mes='Стаж. в з.п. '||:procnpstagto||', в приказе '||:procnpstagfr;
                if (strlen(trim(mes))>0) then
                   begin
                        mes=trim(mes)||' подр='||:shifrpodfr;
                        suspend;
                   end
           end
  /*
   -- 2-й шаг
  mes='Отсутствующие в '||:dateFr|| ' и присутсвтующие в '||:DateTo;
  fio='--- Второй шаг проверки --';
  tabno=0;
  suspend;
     for
        select e.shifrid,e.shifrpod from  tb_k_shtraspped e
                         where e.datefr=:dateto
                         into  :shifridsht,:shifrpodto
     do
        for
           select f.tabno,f.fio
                            from  tb_k_shtrasppedrec f
                            where f.shifridown = :shifridsht and
                                  f.shifrwr    = :shifrwr and
                                  not exists (
                                     select * from tb_k_shtrasppedrec g
                                              join tb_k_shtraspped h on h.shifrid=g.shifridown
                                              where g.tabno   = f.tabno and
                                                    g.shifrwr =  :shifrwr and
                                                    h.datefr  =  :datefr
                                  )
                            into  :tabno,:fio
        do
           begin
                mes='Не найден в шт.расписании за '||:datefr||', но есть за '||:dateto||' в подр '||:shifrpodto;
                 if (strlen(trim(mes))>0) then
                    suspend;
           end
  mes='';
  */
  fio='---Конец анализа сравнения--';
  tabno=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CREATEFULLTEXTORDER (
    WANTEDDATE DATE,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRID integer;
declare variable S varchar(50);
declare variable MODEFACCMP integer;
begin
     shifrid=null;
     modefaccmp=modefac;
 --    if (modefac=3) then
 --       modefaccmp=2;
     select first 1 a.shifrid from tb_k_orders a
                    where a.dateord=:wanteddate
                      and a.shifridwidord=:modefac
                      and
                      (
                       ((:shifrwr=1) and (a.nameord not like 'совм%')) or
                       ((:shifrwr=2) and (a.nameord like 'совм%'))
                      )
                    into shifrid;
     shifrid=coalesce(shifrid,0);

     if (shifrid=0) then
        begin
             shifrid=gen_id(g_k_order,1);
             if (shifrwr=2) then
                s='совм';
             else
                s='осн';
             if (ModeFac=2) then
                s='деканы';
             if (ModeFac=3) then
                s='зам.деканы';
             insert into tb_k_orders(shifrid, nameord, dateord,NomerOrd,shifridwidord)
                    values(:shifrid,:s, :wanteddate,33,:modefac);
        end
     select k from pr_k_makeordertext(:shifrid, :shifrwr,:modefac) into k;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CREATEONERECORDFORORDER (
    SHIFRIDSHTRASPREC INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable FIO varchar(50);
declare variable SHIFRWR integer;
declare variable SHIFRIDOWN integer;
declare variable SHIFRPOD integer;
declare variable DATEFR date;
declare variable S varchar(4096);
declare variable SHIFRIDORDER integer;
declare variable MODEFAC integer;
declare variable SHIFRFAC integer;
declare variable ISZAMDEC integer;
declare variable PROCZAMDEC decimal(15,2);
begin
      tabno   = null;
      k       = 0;
      modefac = 1;
      iszamdec = null;
      proczamdec=null;
      select first 1 a.tabno,a.fio,a.shifrwr, a.shifridown,a.iszamdekana,a.proczamdec from tb_k_shtrasppedrec a
                                             where a.shifrid=:shifridshtrasprec
                                             into :tabno, :fio,:shifrwr,:shifridown,
                                                  :iszamdec, :proczamdec;
      if (tabno is null) then
         begin
              suspend;
              Exit;
         end
      shifrpod=null;
      shifrfac=null;
      select first 1 a.shifrpod,a.datefr,a.shifrfac from tb_k_shtraspped a
                     where a.shifrid=:shifridown
                     into :shifrpod,:datefr,:shifrfac;
      if ((shifrpod is null) and (shifrfac is not null))  then
         if (iszamdec=1) then
            modefac=3;
         else
            modefac=2;

      select first 1 s from pr_k_maketextorderrec201201(:shifridshtrasprec,:datefr,:modefac) into :s;
      if (exists (select * from tb_k_orderrectext where shifridshtrasprec=:shifridshtrasprec)) then
         update tb_k_orderrectext
            set text=:s
            where shifridshtrasprec=:shifridshtrasprec;
      else
          begin
               shifridorder=null;
               select first 1 a.shifridowner from tb_k_orderrectext a
                      join tb_k_shtrasppedrec b on a.shifridshtrasprec=b.shifrid
                      join tb_k_shtraspped c on c.shifrid=b.shifridown
                      where c.datefr=:datefr
                        and b.shifrwr=:shifrwr
                 --       and b.shifrid=:shifridshtrasprec
                      into :shifridorder;
               if (ShifrIdOrder is null) then
                  begin
                       shifridorder=gen_id(g_k_order,1);
                       insert into tb_k_orders(shifrid,nomerord,NOMERORDALPHA,
                                              DATEORD,SHIFRIDWIDORD,NAMEORD,
                                              SHIFRISP,NAMEISP)
                              values(:ShifridOrder,:ShifridOrder,cast(:ShifridOrder as varchar(15)),
                                     :dateFr,1,'АВТОМАТИЧ',1,'АВТОМАТ');
                  end
               insert into tb_k_orderrectext(SHIFRIDOWNER, SHIFRPOD, LINENO, shifrfac, 
                                             TABNO       , FIO     , TEXT  ,
                                             FIXED       , shifridshtrasprec)
                                 values (:shifridorder,:shifrpod, 0, :shifrfac ,
                                         :tabno, :FIO, :s, 0, :shifridshtrasprec);
          end
        k=1;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CREATEORDER (
    SHIFRIDORD INTEGER)
AS
declare variable SHIFRID integer;
declare variable PIBD varchar(50);
declare variable LINENO integer;
declare variable TABNO integer;
declare variable SHIFRPOD integer;
declare variable PED_STAG_Y integer;
declare variable PED_STAG_M integer;
declare variable PSTAGE float;
declare variable WDATE date;
begin
  /* Procedure Text */
     LINENO=0;
     shifrpod=57;
     select first 1 a.dateord from tb_k_orders a where a.shifrid=:shifridord
             into :wdate;
     wdate=coalesce(wdate,CURRENT_DATE);
     for
         select k.shifrid,k.pib_dat_pad,k.tabno from tb_k_kadry k
                where (exists (select * from person p where p.tabno=k.tabno
                                        and p.w_place=:shifrpod
                                        and p.yearvy=2012
                                        and p.monthvy=4
                                       and p.shifrkat=1))
                into :shifrid,:pibd,:tabno
     do
       begin
            LineNo=LineNo+1;
            select a.y,a.m from pr_k_pedstag(:tabno,:wdate) a
                           into :ped_stag_y,:ped_stag_m;

            ped_stag_y=coalesce(ped_stag_y,0);
            ped_stag_m=coalesce(ped_stag_m,0);
            pstage=cast(ped_stag_y as float)+  cast(ped_stag_m  as float) / 12.00;
            insert into tb_k_orderrec (SHIFRIDORDER,LINENO,tabno,FIO,shifrPod,
                                       pstag,proc_pstag
             )
             values (:SHIFRIDORD,:LINENO,:tabno,:pibd, :shifrpod,
                     :pstage,
                      case
                          when :pstage<5 then 0
                          when :pstage>=5 and :pstage<10 then 10
                          when :pstage>=10 and :pstage<20 then 20
                          else 30
                      end);

       end

  suspend;
end^


ALTER PROCEDURE PR_K_CREATESHRASPALL (
    WANTEDDATE DATE,
    MODE INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRPOD integer;
declare variable T integer;
begin

  -- 1)Михаловская 170 доц бз а нужно надбавку политология  то же Зазаруив из 95 подр
  -- 2) ст преп и доц попупаны местами
  -- 3) проф и доц тоже самое
  -- 4) доц на должн ассист Церковна из прововедения
  -- 5) Гаркевец Сергей Алксеевич - докт наук а надбавка почему-то кандидата (96 психология)  нужно доктрора
  -- 6) Яковенко 61 подр доц на долж ст преп с окладом ст преп
  -- 7) Клименко из каф 34 написано доц а он проф разряд - не соотв долности (20 р-д)
  -- 8) Воронцов -тех маш проф на должно доцента
  -- 9) зав кафедрой по дате Григорьева и Кривоколиско
     k=0;
 --    delete from tb_k_shtraspped a
 --           where a.datefr=:wanteddate;
     if (mode=1) then
        begin
              for
                  select a.shifrpod from tb_k_podr a
                         where strlen(trim(a.name_k))>0
                         order by name_k
                         into :shifrpod
              do
                   begin
                        k=k+1;
                        select k from pr_k_createshtrasp(:wanteddate, :shifrpod) into :t;

                   end
        end
    else
        begin
              for
                  select a.shifrid from tb_k_facultety a
                         where strlen(trim(a.name_k))>0
                           and :wanteddate<=coalesce(a.dateclose,cast('2020-01-01' as date))
                         order by name_k
                         into :shifrpod
              do
                   begin
                        k=k+1;
                        select k from pr_k_createshtraspdec(:wanteddate, :shifrpod) into :t;

                   end
        end


  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CREATESHTRASP (
    WANTEDDATE DATE,
    NSRV INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRID integer;
declare variable LINENO integer;
declare variable TABNO integer;
declare variable W_R integer;
declare variable SHIFRGRU integer;
declare variable KOEF decimal(15,2);
declare variable SHIFRIDDOLG integer;
declare variable SHIFRIDSHT integer;
declare variable SHIFRIDK integer;
declare variable FIO varchar(50);
declare variable SHIFRUS integer;
declare variable SHIFRUZ integer;
declare variable SHIFRPODOSN integer;
declare variable KOEFBUD decimal(15,2);
declare variable KOEFVNE decimal(15,2);
declare variable SHIFRIDPERSON integer;
declare variable RAZR integer;
declare variable OKLADRAZR decimal(10,2);
declare variable SHIFRUSW integer;
declare variable PROCNUS integer;
declare variable SUMMANUSB decimal(10,2);
declare variable SUMMANUSV decimal(10,2);
declare variable OKLADB decimal(10,2);
declare variable OKLADV decimal(10,2);
declare variable PROCNUZ decimal(10,2);
declare variable SUMMANUZB decimal(10,2);
declare variable SUMMANUZV decimal(10,2);
declare variable STAGPY integer;
declare variable STAGPM integer;
declare variable STAGP decimal(10,2);
declare variable PROCNPSTAG decimal(10,2);
declare variable SUMMANPSTAGB decimal(10,2);
declare variable SUMMANPSTAGV decimal(10,2);
declare variable SHIFRPSTAGN integer;
declare variable PRIORITY integer;
declare variable SHIFRZASL integer;
declare variable PROCNZASL decimal(10,2);
declare variable SUMMANZASLB decimal(10,2);
declare variable SUMMANZASLV decimal(15,2);
declare variable TMPINT integer;
declare variable SHIFRIDDOLGFORFINDING integer;
declare variable C integer;
declare variable CC integer;
begin
  k=0;
  WANTEDDATE=CAST(EXTRACT(YEAR FROM WANTEDDATE)||'-'||EXTRACT(MONTH FROM WANTEDDATE)||'-01' AS DATE);
  shifrId=null;
  select first 1 a.shifrid from tb_k_shtraspped a
                           where a.shifrpod=:nsrv and
                                 a.datefr=:wanteddate
                           into :shifrid;
  if (ShifrId is not Null) then
     begin
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1
                                              into :c;
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              into :cc;
          delete from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1;
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1
                                              into :cc;
     end
  else
     begin
          delete from tb_k_shtraspped  a where a.shifrpod=:nsrv and a.datefr=:wanteddate;
          insert into tb_k_shtraspped (SHIFRPOD,DATEFR,DATETO)
                 values(:nsrv, :WANTEDDATE,:WANTEDDATE);
          select first 1 a.shifrid from tb_k_shtraspped a
                                   where a.shifrpod=:nsrv and
                                         a.datefr=:wanteddate
                                   into :shifrid;
     end
  if (shifrid is null) then
     begin
          exit;
     end
  lineno=0;
  for
     select a.tabno,
            (select first 1 shifrwr from pr_isosnwrbyid(a.shifrid)) as w_r,
            a.shifrgru,
            (select first 1 koef from PR_GET_KOEF_PERSON_BY_ID(a.shifrid)) as koef,
            (select first 1 shifriddolg from PR_GET_DOLG_PERSON_BY_ID(a.shifrid)) as shifriddolg,
            a.m_o_r,a.shifrid,
            (select first 1 razrijad from PR_GET_RAZR_PERSON_BY_ID(a.shifrid)) as razr
            from person a
            where a.w_place = :nsrv and
                  a.monthvy = extract(MONTH from :wanteddate) and
                  a.yearvy  = extract(YEAR from :wanteddate)  and
                  a.shifrkat = 1 and
                  a.oklad>0.01 and
                  a.main in (1,2,3) and  -- 1 основное место работы 2- переведен в этом месяце 3 - создан в этом месяце
                  ( not exists (select * from tb_k_exl_sal z where z.tabno=a.tabno
                                                               and z.datefr=:wanteddate
                                                               and exists (select * from fcn y
                                                                                    where y.shifridperson=a.shifrid
                                                                                      and cast(y.summa as integer)=z.shifruni)
                               )
                  ) and
                  ((select first 1 shifriddolg from PR_GET_DOLG_PERSON_BY_ID(a.shifrid)) in (90,100,110,120,130,140,150,160,170,190,200,210,220,230,240,1439)) and
                  ((exists (select first 1 * from fadd b      -- исключить уволенныхх
                                         where b.tabno=a.tabno and
                                               b.shifrsta in (1,5,6,14,15) and
                                               b.month_za=a.monthvy and
                                               b.year_za=a.yearvy))
                    or (exists (select first 1 * from boln c where c.tabno=a.tabno and
                                                                 :wanteddate between c.f_data and c.l_data))
                    or (exists (select first 1 * from otpuska d where d.tabno=a.tabno and
                                                                 :wanteddate between d.f_data and d.l_data))

                   )
                   and trim(a.dolg) not like 'пов%'
                   and trim(a.dolg) not like 'ПОВ%'
              --   and a.tabno=2996
            order by a.fio
            into :tabno,:w_r,:shifrgru,:koef,:shifriddolg,:shifrpodosn,:shifridperson,:razr
  do
     begin
          if (tabno=2996) then
             tabno=tabno;
          execute procedure pr_k_addpersontoshtatrasp(:shifrid, :Shifridperson,0);
          lineno=lineno+1;
    /*
          koef=coalesce(koef,0);
          shifriddolgforfinding= case
                                  when shifriddolg in (110,120,130,140) then  110  -- профессор
                                  when shifriddolg in (150,160,170)     then  150  -- доцент
                                  when shifriddolg in (200,210)         then  200  -- старш.преп.
                                  when shifriddolg in (190)             then  190  -- преподаватель
                                  when shifriddolg in (220,230)         then  220  -- асс.
                                  when shifriddolg in (240)             then  240  -- преп-стажер
                                 end;

          shifridsht=null;
          select first 1 b.shifrid from tb_k_shtrasppedrec b
                                   where b.tabno      = :tabno      and
                                         b.shifridown = :shifrid    and
                                         b.shifrwr    = :w_r        and
                                         b.shifrdol   = :shifriddolgforfinding
                                   into :shifridsht;
          if (shifridsht is not null) then    -- была запись, значит только добавить бюджетную или внебюджетную части
             if (shifrgru=1) then
                update tb_k_shtrasppedrec a    -- заполнить бюджетную часть
                       set a.koefbud      = :koef,
                           a.okladb       = coalesce(a.okladrazr,0.00)*:koef,
                           a.summanusb    = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnus,0.00)    / 100.00),
                           a.summanuzb    = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnuz,0.00)    / 100.00),
                           a.summanpstagb = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnpstag,0.00) / 100.00),
                           a.summanzaslv  = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnzasl,0.00)  / 100.00)
                   where
                        shifrid=:shifridsht;
             else
                update tb_k_shtrasppedrec a
                       set a.koefvne=:koef,
                           a.okladv       = coalesce(a.okladrazr,0.00)*:koef,
                           a.summanusv    = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnus,0.00)    / 100.00),
                           a.summanuzv    = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnuz,0.00)    / 100.00),
                           a.summanpstagv = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnpstag,0.00) / 100.00),
                           a.summanzaslv  = coalesce(a.okladrazr,0.00)*:koef*(coalesce(a.procnzasl,0.00)  / 100.00)
                   where
                        shifrid=:shifridsht;
          else                                -- добавить новую запись
              begin
                   LineNo   = LineNo + 1;
                   shifridk = null;
                   fio      = null;
                   select first 1 a.shifrid,a.fio from tb_k_Kadry a where a.tabno=:tabno into :shifridk,:fio;
                   shifridk = coalesce(:shifridk,0);
                   fio      = coalesce(fio, 'Не нвйден в кадрах');
                   fio      = trim(fio);
                   koefbud  = null;
                   koefvne  = null;
                   if (:shifrgru=1) then
                      koefbud = koef;
                   else
                      koefvne = koef;
                   okladrazr = null;
                   if (razr between 1 and 25) then
                           select first 1 a.oklad from tb_razr_proc a
                                                  where a.razr=:razr and a.datefr<=:wanteddate
                                                  order by a.datefr desc
                                                  into :okladrazr;
                   okladrazr = coalesce(okladrazr , 0.00);
                   okladb    = okladrazr * koefbud;
                   okladv    = okladrazr * koefvne;

                -- Ученая степень

                   shifrus=null;
                   select first 1 b.shifrusz from tb_k_kadrypr b
                                             where b.shifridowner=:shifridk and
                                                   b.codetype=1             and
                                                   b.datefr<=:wanteddate
                                             order by b.datefr desc
                                             into :shifrus;
                   shifrus  = coalesce(shifrus,0);
                   summanusb = 0.00;
                   summanusv = 0.00;
                   procnus   = 0.00;
                   if (shifrus>0) then     -- кандидат или доктор
                      begin
                            shifrusw=null;
                            select first 1 a.shifrwiduchst from tb_k_uch_st_spr a
                                             where a.shifrid=:shifrus
                                             into :shifrusw;
                            shifrusw=coalesce(:shifrusw,0);
                            if (shifrusw in (1,2)) then    -- 1 - канд: 2 - докт
                                begin
                                      procnus = null;
                                      select first 1  b.summa from tb_k_widnadb a
                                                      join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                                      where b.datefr<=:wanteddate and
                                                            b.shifrid=:shifrusw
                                                      order by b.datefr desc
                                                      into :procnus;
                                      procnus   = coalesce(procnus,0);
                                      summanusb = okladb*procnus/100.00;
                                      summanusv = okladv*procnus/100.00;
                                      summanusb = coalesce(summanusb,0.00);
                                      summanusv = coalesce(summanusv,0.00);
                                end
                      end

                -- Ученое звание

                   shifruz=null;
                   select first 1 b.shifrusz from tb_k_kadrypr b
                                             where b.shifridowner=:shifridk and
                                                   b.codetype=2             and
                                                   b.datefr<=:wanteddate
                                             order by b.datefr desc
                                             into :shifruz;
                   shifruz   = coalesce(shifruz,0);    -- доц(1) проф(2) или снс(3)
                   summanuzb = 0.00;
                   summanuzv = 0.00;
                   procnuz   = 0.00;
                   if (shifruz>0) then
                      begin
--                            shifruzw=null;
--                            select first 1 a.shifrwiduchst from tb_k_uch_st_spr a
--                                             where a.shifrid=:shifrus
--                                             into :shifrusw;
--                            shifrusw=coalesce(:shifrusw,0);
                            if (shifruz in (1,2,3)) then
                                begin
                                      procnuz=null;
                                      if (shifruz in (1,2)) then  -- доц или проф
                                         tmpint=shifruz+2;
                                      else
                                         tmpint=10;     -- с н с
                                      select first 1  b.summa from tb_k_widnadb a
                                                      join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                                      where b.datefr<=:wanteddate and
                                                            b.shifrid=:tmpint
                                                      order by b.datefr desc
                                                      into :procnuz;
                                      procnuz   = coalesce(procnuz,0.00);
                                      summanuzb = okladb * procnuz / 100.00;
                                      summanuzv = okladv * procnuz / 100.00;
                                      summanuzb = coalesce(summanuzb,0.00);
                                      summanuzv = coalesce(summanuzv,0.00);
                                end
                      end

                -- Надбавка за звание заслуженного  (діяча, артиста, юриста, винахідника и т д)
                   shifrzasl=null;
                   select first 1 b.shifrusz from tb_k_kadrypr b
                                             where b.shifridowner=:shifridk and
                                                   b.codetype=3             and
                                                   b.datefr<=:wanteddate
                                             order by b.datefr desc
                                             into :shifrzasl;
                   shifrzasl   = coalesce(shifrzasl,0);
                   summanzaslb = 0.00;
                   summanzaslv = 0.00;
                   procnzasl   = 0.00;
                   if (shifrzasl>0) then
                      begin
                           procnzasl = null;
                           select first 1  b.summa from tb_k_widnadb a
                                  join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                  where b.datefr<=:wanteddate and
                                        b.shifrid=5
                                  order by b.datefr desc
                                  into :procnzasl;
                           procnzasl   = coalesce(procnzasl,0.00);
                           summanzaslb = okladb * procnzasl / 100.00;
                           summanzaslv = okladv * procnzasl / 100.00;
                           summanzaslb = coalesce(:summanzaslb,0.00);
                           summanzaslv = coalesce(:summanzaslv,0.00);
                      end

                   --- Пед стаж ---

                   stagpy       = 0;
                   stagpm       = 0;
                   stagp        = 0.00;
                   procnpstag   = 0.00;
                   summanpstagb = 0.00;
                   summanpstagv = 0.00;
                   select first 1 y,m from pr_k_pedstag(:tabno,:wanteddate) into :stagpy,:stagpm;
                   stagpy       = coalesce(stagpy,0);
                   stagpm       = coalesce(stagpm,0);
                   stagp        = cast(stagpy as decimal(12,2)) + (cast(stagpm as decimal(12,2)) / 12.00);
                   stagp        = coalesce(stagp,0);
                   shifrpstagn   = case
                                       when (stagp between 3 and 9.99)   then 8
                                       when (stagp between 10 and 19.99) then 7
                                       when (stagp>=20)                  then 6
                                       else 0
                                   end;
                   if (shifrpstagn>4) then
                      begin
                           procnpstag = null;
                           select first 1  b.summa from tb_k_widnadb a
                                  join tb_k_widnadbstw b on a.shifrid=b.shifridowner
                                  where b.datefr<=:wanteddate and
                                        b.shifrid=:shifrpstagn
                                  order by b.datefr desc
                                  into :procnpstag;
                           procnpstag   = coalesce(procnpstag,0.00);
                           summanpstagb = okladb * procnpstag / 100.00;
                           summanpstagv = okladv * procnpstag / 100.00;
                           summanpstagb = coalesce(:summanpstagb,0.00);
                           summanpstagv = coalesce(:summanpstagv,0.00);
                      end
                   priority= case
                                  when shifriddolg in (110,120,130,140) then 12  -- профессор
                                  when shifriddolg in (150,160,170)     then 10  -- доцент
                                  when shifriddolg in (200,210)         then  8  -- старш.преп.
                                  when shifriddolg in (190)             then  6  -- преподаватель
                                  when shifriddolg in (220,230)         then  4  -- асс.
                                  when shifriddolg in (240)             then  2  -- преп-стажер
                                  else 0
                             end;
                   insert into tb_k_shtrasppedrec (shifridown   ,  lineno       ,  shifridk    ,  tabno   , fio ,
                                                   shifrus      ,  shifruz      ,  shifrdol    ,  koefbud , koefvne,
                                                   shifrpodosn  ,  shifrwr      ,  datefr      ,  dateto  ,
                                                   razr         ,  okladrazr    , okladb       ,  okladv  ,
                                                   procnus      ,  summanusb    , summanusv    ,
                                                   procnuz      ,  summanuzb    , summanuzv    ,
                                                   stagpy       ,  stagpm       , stagp        ,
                                                   procnpstag   ,  summanpstagb , summanpstagv ,
                                                   shifrzasl    , procnzasl    ,  summanzaslb  , summanzaslv  ,
                                                   priority)
                                           values (:shifrid     , :lineno       , :shifridk     , :tabno      , :fio ,
                                                   :shifrus     , :shifruz      , :shifriddolgforfinding  , :koefbud    , :koefvne,
                                                   :shifrpodosn , :w_r          , :wanteddate   , :wanteddate ,
                                                   :razr        , :okladrazr    , :okladb       , :okladv     ,
                                                   :procnus     , :summanusb    , :summanusv    ,
                                                   :procnuz     , :summanuzb    , :summanuzv    ,
                                                   :stagpy      , :stagpm       , :stagp        ,
                                                   :procnpstag  , :summanpstagb , :summanpstagv ,
                                                   :shifrzasl   , :procnzasl    , :summanzaslb  , :summanzaslv ,
                                                   :priority);
              end
    */
       end
  k=lineno;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_CREATESHTRASPDEC (
    WANTEDDATE DATE,
    NSRV INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRID integer;
declare variable LINENO integer;
declare variable TABNO integer;
declare variable W_R integer;
declare variable SHIFRGRU integer;
declare variable KOEF decimal(15,2);
declare variable SHIFRIDDOLG integer;
declare variable SHIFRIDSHT integer;
declare variable SHIFRIDK integer;
declare variable FIO varchar(50);
declare variable SHIFRUS integer;
declare variable SHIFRUZ integer;
declare variable SHIFRPODOSN integer;
declare variable KOEFBUD decimal(15,2);
declare variable KOEFVNE decimal(15,2);
declare variable SHIFRIDPERSON integer;
declare variable RAZR integer;
declare variable OKLADRAZR decimal(10,2);
declare variable SHIFRUSW integer;
declare variable PROCNUS integer;
declare variable SUMMANUSB decimal(10,2);
declare variable SUMMANUSV decimal(10,2);
declare variable OKLADB decimal(10,2);
declare variable OKLADV decimal(10,2);
declare variable PROCNUZ decimal(10,2);
declare variable SUMMANUZB decimal(10,2);
declare variable SUMMANUZV decimal(10,2);
declare variable STAGPY integer;
declare variable STAGPM integer;
declare variable STAGP decimal(10,2);
declare variable PROCNPSTAG decimal(10,2);
declare variable SUMMANPSTAGB decimal(10,2);
declare variable SUMMANPSTAGV decimal(10,2);
declare variable SHIFRPSTAGN integer;
declare variable PRIORITY integer;
declare variable SHIFRZASL integer;
declare variable PROCNZASL decimal(10,2);
declare variable SUMMANZASLB decimal(10,2);
declare variable SUMMANZASLV decimal(15,2);
declare variable TMPINT integer;
declare variable SHIFRIDDOLGFORFINDING integer;
declare variable C integer;
declare variable CC integer;
declare variable SHIFRIDDEC integer;
declare variable CODEDOLG integer;
declare variable MODEFAC integer;
declare variable SHIFRIDPERSON1 integer;
begin
  k=0;
  WANTEDDATE=CAST(EXTRACT(YEAR FROM WANTEDDATE)||'-'||EXTRACT(MONTH FROM WANTEDDATE)||'-01' AS DATE);
  shifrId=null;
  select first 1 a.shifrid from tb_k_shtraspped a
                           where a.shifrfac=:nsrv and
                                 a.datefr=:wanteddate
                           into :shifrid;
  if (ShifrId is not Null) then
     begin
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1
                                              into :c;
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              into :cc;
          delete from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1;
          select count(*) from tb_k_shtrasppedrec  a where a.shifridown=:shifrid
                                              and coalesce(a.fixed,0)<>1
                                              into :cc;
     end
  else
     begin
          delete from tb_k_shtraspped  a where a.shifrfac=:nsrv and a.datefr=:wanteddate;
          insert into tb_k_shtraspped (SHIFRFAC,DATEFR,DATETO)
                 values(:nsrv, :WANTEDDATE,:WANTEDDATE);
          select first 1 a.shifrid from tb_k_shtraspped a
                                   where a.shifrFAC=:nsrv and
                                         a.datefr=:wanteddate
                                   into :shifrid;
     end
  if (shifrid is null) then
     begin
          exit;
     end
  lineno=0;
  for
     select a.shifrid,a.codedolg,a.shifridkadry
            from tb_k_decany a
            where a.shifrfac = :nsrv
              and  a.datefr in (select max(b.datefr) from tb_k_decany b
                               where b.shifridkadry=a.shifridkadry
                                 and b.datefr<=:wanteddate
                             )
            order by a.codedolg
            into :shifriddec,:codedolg,:shifridk
  do
     begin
          if (shifridk=99) then
             shifridk=99;
          select first 1 a.tabno from tb_k_kadry a
                 where a.shifrid=:shifridk
                 into :tabno;
          select first 1 b.shifrid from person b
                 where b.tabno=:tabno
                   and b.yearvy  = extract(year from :wanteddate)
                   and b.monthvy = extract(month from :wanteddate)
                   and b.w_r=1
                 into : shifridperson;
          modefac = case (codedolg)
                       when 1 then 1
                       when 2 then 2
                       when 3 then 3
                       when 4 then 4
                    end;
     /*     if (codedolg in (1,3)) then
             modefac=1;
          else
             modefac=2;
      */
          execute procedure pr_k_addpersontoshtatrasp(:shifrid, :Shifridperson,:modefac);
          tabno=coalesce(tabno,0);
          if (tabno>0) then
             for
                select a.shifrid  from person a
                       where a.shifrid<>:shifridperson
                         and a.tabno=:tabno
                         and a.yearvy=extract(year from :wanteddate)
                         and a.monthvy=extract(month from :wanteddate)
                         and a.main in (1,2)
                         and coalesce(a.oklad,0.00)>100
                         and (select first 1 coalesce(shifrwr,0) from pr_isosnwrbyid(a.shifrid))=1
                       into :shifridperson1
             do
                execute procedure pr_k_addpersontoshtatrasp(:shifrid, :Shifridperson1,:modefac);
          lineno=lineno+1;
       end
  k=lineno;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_DOCONOTHERSTAWKA (
    WANTEDDATE DATE)
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable ID integer;
declare variable SHIFRIDDOL integer;
declare variable SHIFRTMP integer;
declare variable NAMEK varchar(150);
declare variable M integer;
declare variable Y integer;
declare variable DATETMP date;
begin
     k=0;
 --    delete from tb_k_kadrypr where codetype=3;
--     exit;
     y=extract(year  from wanteddate);
     m=extract(month from wanteddate);
     wanteddate=y||'-'||m||'-01';
     for
        select a.tabno,(select d.shifriddolg from pr_get_dolg_person_by_id(a.shifrid) d) from  person a
               where a.dolg containing 'доц'
                 and a.yearvy  = :y
                 and a.monthvy = :m
                 and (
                      (select c.shifriddolg from pr_get_dolg_person_by_id(a.shifrid) c) not in (6,7,90,100,110,120,130,140,150,160,170)
                     )
                and (
                     not exists (
                                 select * from tb_k_kadry e
                                          join tb_k_kadrypr f on e.shifrid=f.shifridowner
                                          where e.tabno=a.tabno
                                            and f.codetype=2
                                            and f.shifrusz=1
                               )
                    )
               into :tabno,shifriddol
     do
       begin
            id=null;
            select a.shifrid from tb_k_kadry a where a.tabno=:tabno into :id;
            if (id is not null) then
               begin
                    shifrtmp=null;
                    select a.shifrid from tb_k_kadrypr a
                                      where a.codetype     = 8
                                        and :wanteddate between a.datefr and a.dateto
                                        and a.shifridowner = :id
                                      into :shifrtmp;
                    if (shifrtmp is null) then
                       begin
                            k=k+1;
                            namek='доцент на др. ставке';
                        insert into tb_k_kadrypr (SHIFRIDOWNER,CODETYPE,SHIFRUSZ,
                                           DATEFR , dateto,  NAME)
                               values (:id, 8,1,:wanteddate,:wanteddate,:namek);
                       end
               end
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_GET_ZAMDEK (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    PROC DECIMAL(15,2),
    SUMMA DECIMAL(15,2),
    FIO VARCHAR(50),
    DOLG VARCHAR(20),
    SHIFRPOD INTEGER,
    NAMEKAF VARCHAR(120),
    ISTFIN VARCHAR(10),
    OSN_DOLG VARCHAR(20),
    OSN_OKLAD DECIMAL(15,2),
    SHIFRFAC INTEGER,
    NAMEFAC VARCHAR(128),
    SHIFRIDK INTEGER)
AS
declare variable SHIFRKAF integer;
begin
     for
select distinct a.tabno,
         case
             when b.summa<100 then b.summa
             else 0
         end proc,
         case
             when b.summa>100 then b.summa
             else 0
         end summa,
 a.fio,a.dolg,a.w_place,
 (
   select first 1 p.name from podr p where p.shifrpod=a.w_place
   ) kaf

           from person a
            join fcn b on a.shifrid=b.shifridperson
            where a.yearvy=:y
              and a.monthvy=:m
              and b.shifrsta in (42,42+500)
              and exists (select * from fadd d where d.shifridperson=a.shifrid
                                   and d.summa>0 and d.shifrsta=42)
union
 select distinct aa.tabno,
         case
             when bb.summa<100 then bb.summa
             else 0
         end proc,
         case
             when bb.summa>100 then bb.summa
             else 0
         end summa,
 aa.fio, aa.dolg,aa.w_place, 
 (
   select first 1 pp.name from podr pp where pp.shifrpod=aa.w_place
   ) kaf


           from person aa
            join fcn bb on aa.shifrid=bb.shifridperson
            where aa.yearvy=:y
              and aa.monthvy=:m
              and bb.shifrsta in (30,30+500,7,7+500)
              and aa.w_place not between 151 and 168
              and aa.w_place not in (1,2,3,4,13,26,69,81,84,102,105,106,107,121,175)
              and aa.tabno not in (48,87,870,1103,849,1626,2375)
              and bb.summa>200
              and bb.summa<1000
        /*      and (abs(abs(bb.summa)-874.20)<0.01 or
                   abs(abs(bb.summa)-766.80)<0.01 or
                   abs(abs(bb.summa)-713.10)<0.01)
        */
              and exists (select * from fadd dd where dd.shifridperson=aa.shifrid
                                   and dd.summa>0 and dd.shifrsta=bb.shifrsta)
              into :tabno,:proc,:summa,:fio,:dolg, :shifrpod,:namekaf
     do
       begin
            select first 1 pa.dolg,
                           pa.oklad,
                           case pa.shifrgru
                                when 1 then 'бюд'
                                else 'вне'
                           end istfin
                            from person pa where pa.tabno=:tabno
                                            and pa.yearvy=:y
                                            and pa.monthvy=:m
                                            and pa.w_r=1
                            into :osn_dolg ,:osn_oklad,:istfin;
             shifrkaf=null;
             select first 1 kk.shifrid  from tb_k_kaf kk
                    where kk.shifrkafbuh=:shifrpod
                    into :shifrkaf;
             shifrfac=null;
             namefac='';
             if (coalesce(shifrkaf,0)>0) then
                begin
                     select first 1 f.shifrid, f.name from tb_k_facultety f
                            join tb_k_k_f kf on kf.shifrfac=f.shifrid
                            where case
                                   when :y=2013 and :m=1 then cast('2013-06-30' as date)
                                   else cast('2013-09-01' as date)
                                  end=kf.datefr
                              and kf.shifrkaf=:shifrkaf
                            into :shifrfac,:namefac;
                end
             shifridk=null;
             select first 1 kka.shifrid from tb_k_kadry kka where kka.tabno=:tabno
                    into shifridk;
  /* Procedure Text */
             suspend;
       end
end^


ALTER PROCEDURE PR_K_GETORDERID (
    WANTEDDATE DATE,
    SHIFRWR INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
begin
     shifrid=null;
     select first 1 a.shifrid from tb_k_orders a
                    where a.dateord=:wanteddate
                      and
                      (
                       ((:shifrwr=1) and (a.nameord not like 'совм%')) or
                       ((:shifrwr=2) and (a.nameord like 'совм%'))
                      )
                    into shifrid;
     shifrid=coalesce(shifrid,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_GETORDERIDFORMODE (
    SHIFRIDOLD INTEGER,
    MODEFAC INTEGER)
RETURNS (
    SHIFRID INTEGER)
AS
declare variable DATEORD date;
declare variable NAMEORD varchar(30);
declare variable SHIFRWR integer;
begin
     shifrid=null;
     select first 1 c.dateord,c.nameord from tb_k_orders c
            where c.shifrid=:shifridold
            into :dateord,:nameord;
     if (nameord like 'совм%') then
        shifrWr=2;
     else
        shifrWr=1;
     if (modefac in (2,3)) then
        select first 1 b.shifrid from tb_k_orders b
               where b.dateord=:dateord
                 and b.shifridwidord=:modefac
               into :shifrid;
     else
        select first 1 d.shifrid from tb_k_orders d
               where d.dateord=:dateord
                 and d.shifridwidord=:modefac
                 and (
                       ((:shifrwr=1) and (d.nameord not like 'совм%')) or
                       ((:shifrwr=2) and (d.nameord like 'совм%'))
                     )
               into :shifrid;


     shifrid=coalesce(shifrid,0);
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MAKEORDERTEXT (
    SHIFRIDORD INTEGER,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRPOD integer;
declare variable S varchar(4096);
declare variable LINENO integer;
declare variable WANTEDDATE date;
declare variable TABNO integer;
declare variable FIO varchar(50);
declare variable SHIFRIDREC integer;
declare variable SHIFRFAC integer;
begin
     shifrpod=null;
     shifrfac=null;
     select first 1 a.dateord from tb_k_orders a
                              where a.shifrid=:shifridord
                              into :wanteddate;
     delete from tb_k_orderrectext where shifridowner=:shifridord and
                                         coalesce(fixed,0)<>1;
     k=0;
     if (modefac not in (2,3)) then
        begin
              for
                 select a.shifrpod from tb_k_podr a
                        where strlen(trim(a.name_k))>0
                        order by name_s
                        into :shifrpod
              do
                begin
                     k=k+1;
                     lineno=0;
                     for
                        select s,tabno,fio,shifridrec from pr_k_maketextordkaf(:shifrpod, :wanteddate, :shifrwr,:modefac) a
                               where (not (exists (select first 1 * from tb_k_orderrectext b where b.SHIFRIDSHTRASPREC=a.shifridrec)))

                               into :s,:tabno, :fio,:shifridrec
                     do
                       begin
                             Lineno=Lineno+1;

               --       if (not (exists (select first 1 * from tb_k_orderrectext where SHIFRIDSHTRASPREC=:shifridrec))) then
                             insert into tb_k_orderrectext (SHIFRIDOWNER,SHIFRPOD,LINENO,TEXT,tabno, fio,SHIFRIDSHTRASPREC)
                                    values (:shifridord,:shifrpod,:lineno, :s,:tabno,:fio,:shifridrec);
                        end

                end
           end
        else
           begin
              for
                 select a.shifrid from tb_k_facultety a
                        where :wanteddate<coalesce(a.dateclose, cast('2020-01-01' as date))
                        order by name_s
                        into :shifrfac
              do
                begin
                     if (shifrfac=21) then
                        shifrfac=21;
                     k=k+1;
                     lineno=0;
                     for
                        select s,tabno,fio,shifridrec from pr_k_maketextordkaf(:shifrfac, :wanteddate, :shifrwr,:modefac) a
                               where (not (exists (select first 1 * from tb_k_orderrectext b where b.SHIFRIDSHTRASPREC=a.shifridrec)))

                               into :s,:tabno, :fio,:shifridrec
                     do
                       begin
                              if (strlen(s)>0) then
                                 begin
                                      Lineno=Lineno+1;

               --       if (not (exists (select first 1 * from tb_k_orderrectext where SHIFRIDSHTRASPREC=:shifridrec))) then
                                      insert into tb_k_orderrectext (SHIFRIDOWNER,SHIFRPOD,shifrfac, LINENO,TEXT,tabno, fio,SHIFRIDSHTRASPREC)
                                             values (:shifridord,:shifrpod,:shifrfac,:lineno, :s,:tabno,:fio,:shifridrec);
                                 end
                        end

                end
           end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MAKETEXTORDERREC (
    SHIFRIDSHTREC INTEGER,
    WANTEDDATE DATE)
RETURNS (
    S VARCHAR(4096))
AS
declare variable TABNO integer;
declare variable PIBD varchar(70);
declare variable SHIFRIDK integer;
declare variable SHIFRUS integer;
declare variable SHIFRUZ integer;
declare variable NAMEUS varchar(30);
declare variable NAMEUZ varchar(30);
declare variable SHIFRDOL integer;
declare variable NAMEDOL varchar(30);
declare variable SHIFRPOD integer;
declare variable NAMEPOD varchar(150);
declare variable DATES varchar(15);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable OKLADB decimal(10,2);
declare variable OKLADV decimal(10,2);
declare variable PROCNUS decimal(10,2);
declare variable SUMMANUSB decimal(10,2);
declare variable SUMMANUSV decimal(10,2);
declare variable PROCNUZ decimal(10,2);
declare variable SUMMANUZB decimal(10,2);
declare variable SUMMANUZV decimal(10,2);
declare variable PROCNPSTAG decimal(10,2);
declare variable STAGP decimal(10,2);
declare variable SUMMANPSTAGB decimal(10,2);
declare variable SUMMANPSTAGV decimal(15,2);
declare variable PROCNZASL decimal(10,2);
declare variable SUMMANZASLB decimal(10,2);
declare variable SUMMANZASLV decimal(10,2);
declare variable NAMEZASL varchar(50);
declare variable SHIFRZASL integer;
declare variable SHIFRWR integer;
declare variable SUMMAPOV decimal(10,2);
declare variable SUMMAPOVBUD decimal(10,2);
declare variable SUMMAPOVVNE decimal(10,2);
begin
     select first 1 a.tabno      , a.shifrus     , a.shifruz      , a.shifrdol , b.shifrpod,
                    a.koefbud    , a.koefvne     , a.okladb       , a.okladv   ,
                    a.procnus    , a.summanusb   , a.summanusv    ,
                    a.procnuz    , a.summanuzb   , a.summanuzv    ,
                    a.procnpstag , a.stagp       , a.summanpstagb , a.summanpstagv ,
                    a.shifrzasl  , a.procnzasl   , a.summanzaslb  , a.summanzaslv  ,
                    a.shifrwr    , a.summapov    , a.summapovbud  , a.summapovvne
            from tb_k_shtrasppedrec a
                 join tb_k_shtraspped b on a.shifridown=b.shifrid
            where a.shifrid=:shifridshtrec
            into :tabno , :shifrus   , :shifruz      , :shifrdol     , :shifrpod,
            :koefbud    , :koefvne   , :okladb       , :okladv       ,
            :procnus    , :summanusb , :summanusv    ,
            :procnuz    , :summanuzb , :summanuzv    ,
            :procnpstag , :stagp     , :summanpstagb , :summanpstagv ,
            :shifrzasl  , :procnzasl , :summanzaslb  , :summanzaslv  ,
            :shifrwr    , :summapov  , :summapovbud  , :summapovvne;
     tabno        = coalesce(tabno,0);
     shifrus      = coalesce(shifrus,0);
     shifruz      = coalesce(shifruz,0);
     shifrdol     = coalesce(shifrdol,0);
     shifrpod     = coalesce(shifrpod,0);
     koefbud      = coalesce(koefbud,0.00);
     koefvne      = coalesce(koefvne,0.00);
     okladb       = coalesce(okladb,0.00);
     okladv       = coalesce(okladv,0.00);
     procnus      = coalesce(procnus,0);
     summanusb    = coalesce(summanusb,0);
     summanusv    = coalesce(summanusv,0);
     procnuz      = coalesce(procnuz,0);
     summanuzb    = coalesce(summanuzb,0);
     summanuzv    = coalesce(summanuzv,0);
     stagp        = coalesce(stagp,0);
     summanpstagb = coalesce(summanpstagb,0);
     summanpstagv = coalesce(summanpstagv,0);
     shifrzasl    = coalesce(shifrzasl,0);
     procnzasl    = coalesce(procnzasl,0);
     summanzaslb  = coalesce(summanzaslb,0);
     summanzaslv  = coalesce(summanzaslv,0);
     shifrwr      = coalesce(shifrwr,1);
     summapov     = coalesce(summapov,0);
     summapovbud  = coalesce(summapovbud,0);
     summapovvne  = coalesce(summapovvne,0);
     if (Shifrwr<>2) then
         shifrwr=1;
     nameus       = '';
     nameuz       = '';
     namezasl     = '';
     s            = '';
     if (tabno=0) then
         exit;
     -- Получить фамилию
     select first 1 a.pib_dat_pad,a.shifrid
            from tb_k_kadry a
            where a.tabno=:tabno
            into :pibd, :shifridk;
     s = trim(PIBD)||', ';     --'ІВАНОВУ Івану Івановичу, '
     -- ученое звание
     if (shifruz>0) then
        begin
             select first 1 a.namesokr
                    from tb_k_usz a
                    where a.shifrid=:shifruz
                    into :nameuz;
             nameuz=coalesce(nameuz,'Не найдено уч.зв. '||Shifrus);
             s=trim(s)||' '||trim(nameuz)||',';  -- 'доц.,'
        end
     -- ученая степень
     if (shifrus>0) then
        begin
             select first 1 a.shortname
                    from tb_k_uch_st_spr a
                    where a.shifrid=:shifrus
                    into :nameus;
             nameus = coalesce(nameus,'Не найдена уч.ст. '||Shifrus);
             s = trim(s)||' '||trim(nameus)||','; --'к.т.н.,'
        end
     -- Звание заслуженного
     if (shifrzasl>1) then
        begin
             select first 1 a.shortname
                    from tb_k_widyzasl a
                    where a.shifrid=:shifrzasl
                    into :namezasl;
        --     namezasl='Заслужений діяч науки і техніки України';
             namezasl = coalesce(namezasl,'Не найден шифр засл '||Shifrzasl);
             s=trim(s)||' '||trim(namezasl)||',';
        end
     namedol = case
                   when shifrdol in (110,120,130,140) then 'проф.'          -- профессор
                   when shifrdol in (150,160,170)     then 'доц.'           -- доцент
                   when shifrdol in (200,210)         then 'ст.викл.'       -- старш.преп.
                   when shifrdol in (190)             then 'викл. '         -- викладач
                   when shifrdol in (220,230)         then 'асс.'           -- асс.
                   when shifrdol in (240)             then 'викл.-стаж.'    -- преп-стажер
                   else 'помилка долж'
               end;
     s=trim(s)||' '||trim(namedol);
     select first 1 a.name_k from tb_k_podr a where a.shifrpod=:shifrpod
                             into namepod;
     s=trim(s)||' каф."'||trim(namepod)||'"' ;      ------------- м б на каф а подг курсы
     dates=extract(day from wanteddate)||'.'||
     case
         when extract(month from wanteddate)<10 then '0'||extract(month from wanteddate)
         else extract(month from wanteddate)
     end
     ||'.'||(extract(year from wanteddate)-2000);
     if (shifrwr=2) then
        s=trim(s)||' за сумісництвом';
     s=trim(s)||' з '||trim(dates)||' р. встановити посадовий оклад з розрахунку ';
     s=trim(s)||' '||(koefbud+koefvne)||' ст. '||trim(namedol)||' каф."'||trim(namepod)||'" у розмірі';
     s=trim(s)||' '||(okladb+okladv)||' грн. ('||(okladb+okladv)||' грн. - оклад за ЄТС)';
     if ((okladb>0.01) and (okladv>0.01)) then
        s=trim(s)||', '||trim(koefbud)||' ст. - '||okladb||' грн. з бюдж. фінанс. та '||trim(koefvne)||' ст. - '||okladv||' грн. з позабюдж. фінанс.';
      else
        if (okladb>0.01) then
           s=trim(s)||' з бюдж. фінанс.';
        else
           s=trim(s)||' з позабюдж. фінанс.';

      -- Підвищення
      if (WantedDate<cast('2012-03-01' as date)) then
         if ((SummaPovBud+SummaPovVne)>0.01) then
            begin
                 s=trim(s)||' Підвищення '||(SummaPovBud+SummaPovVne)||' грн.';
                 if ((SummaPovBud>0.01) and (SummaPovVne>0.01)) then
                    s=trim(s)||' ('||SummaPovBud||' грн. з бюдж. фінанс., '||SummaPovVne||' грн. з позабюдж. фінанс.).';
                 else if (SummaPovBud>0.01) then
                    s=trim(s)||' з бюдж. фінанс.';
                 else if (SummaPovVne>0.01) then
                    s=trim(s)||' з позабюдж. фінанс.';
            end

      -- Надбавки
      -- 1 за степень и звание и звание заслуженного
      if ((summanusb+summanusv+summanuzb+summanuzv+summanzaslb+summanzaslv)>1) then
         begin
              s=trim(s)||' Плюс доплати за:';
              -- 1 - за звание
              if ((summanuzb+summanuzv)>1) then
                  begin
                       s=trim(s)||' вчене звання '||cast(procnuz as integer)||'% від п/о - '||(summanuzb+summanuzv)||' грн.';
                       if ((summanuzb>0.01) and (summanuzv>0.01)) then
                          s=trim(s)||' ( '||summanuzb||' грн. з бюдж. фінанс. та '||summanuzv||' грн. з позабюдж. фінанс.)';
                       else
                           if (summanuzb>0.01) then
                              s=trim(s)||' з бюдж. фінанс.';
                           else
                              s=trim(s)||' з позабюдж. фінанс.';
                  end
              -- 2 - за степень
              if ((summanusb+summanusv)>1) then
                  begin
                       if ((summanuzb+summanuzv)>1) then
                           s=trim(s)||',';
                       s=trim(s)||' науковий ступінь '||cast(procnus as integer)||'% від п/о - '||(summanusb+summanusv)||' грн.';
                       if ((summanusb>0.01) and (summanusv>0.01)) then
                          s=trim(s)||' ( '||summanusb||' грн. з бюдж. фінанс. та '||summanusv||' грн. з позабюдж. фінанс.).';
                       else
                           if (summanusb>0.01) then
                              s=trim(s)||' з бюдж. фінанс.';
                           else
                              s=trim(s)||' з позабюдж. фінанс.';
                  end
              -- 3 - за звание заслуженного
              if ((summanzaslb+summanzaslv)>1) then
                  begin
                       s=trim(s)||' Плюс надбавка за почесне звання';
                       s=trim(s)||' '||trim(namezasl)||' у розмірі '||cast(procnzasl as integer)||'% від п/о - '||(summanzaslb+summanzaslv)||' грн.';
                       if ((summanzaslv>0.01) and (summanzaslv>0.01)) then
                          s=trim(s)||' ( '||summanzaslb||' грн. з бюдж. фінанс. та '||summanzaslv||' грн. з позабюдж. фінанс.)';
                       else
                           if (summanzaslb>0.01) then
                              s=trim(s)||' з бюдж. фінанс.';
                           else
                              s=trim(s)||' з позабюдж. фінанс.';
                  end
         end
      -- 2 за пед стаж
      if ((summanpstagb+summanpstagv)>1) then
         begin
              s=trim(s)||' Плюс надбавка за вислугу років (н/п стаж скаладає '||trim(cast(stagp as decimal(15,1)))||' р.) у розмірі';
              s=trim(s)||' '||trim(cast(procnpstag as integer))||'% від п/о -';
              s=trim(s)||' '||trim(summanpstagb+summanpstagv)||' грн.';
              if ((summanpstagb>0.01) and (summanpstagv>0.01)) then
                 s=trim(s)||' ( '||summanpstagb||' грн. з бюдж. фінанс. та '||summanpstagv||' грн. з позабюдж. фінанс.)';
                       else
                           if (summanpstagb>0.01) then
                              s=trim(s)||' з бюдж. фінанс.';
                           else
                              s=trim(s)||' з позабюдж. фінанс.';
         end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MAKETEXTORDERREC201201 (
    SHIFRIDSHTREC INTEGER,
    WANTEDDATE DATE,
    MODEFAC INTEGER)
RETURNS (
    S VARCHAR(4096))
AS
declare variable TABNO integer;
declare variable PIBD varchar(70);
declare variable SHIFRIDK integer;
declare variable SHIFRUS integer;
declare variable SHIFRUZ integer;
declare variable NAMEUS varchar(30);
declare variable NAMEUZ varchar(30);
declare variable SHIFRDOL integer;
declare variable NAMEDOL varchar(30);
declare variable SHIFRPOD integer;
declare variable NAMEPOD varchar(150);
declare variable DATES varchar(15);
declare variable KOEFBUD decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable OKLADB decimal(10,2);
declare variable OKLADV decimal(10,2);
declare variable PROCNUS decimal(10,2);
declare variable SUMMANUSB decimal(10,2);
declare variable SUMMANUSV decimal(10,2);
declare variable PROCNUZ decimal(10,2);
declare variable SUMMANUZB decimal(10,2);
declare variable SUMMANUZV decimal(10,2);
declare variable PROCNPSTAG decimal(10,2);
declare variable STAGP decimal(10,2);
declare variable SUMMANPSTAGB decimal(10,2);
declare variable SUMMANPSTAGV decimal(15,2);
declare variable PROCNZASL decimal(10,2);
declare variable SUMMANZASLB decimal(10,2);
declare variable SUMMANZASLV decimal(10,2);
declare variable NAMEZASL varchar(50);
declare variable SHIFRZASL integer;
declare variable SHIFRWR integer;
declare variable SUMMAPOV decimal(10,2);
declare variable SUMMAPOVBUD decimal(10,2);
declare variable SUMMAPOVVNE decimal(10,2);
declare variable SK varchar(10);
declare variable SKK varchar(10);
declare variable SKOP varchar(10);
declare variable SKV varchar(10);
declare variable SKN varchar(150);
declare variable ISZAWKAF integer;
declare variable ISDOCONOTHERSTAWKA integer;
declare variable NAMEDOL1 varchar(50);
declare variable NAMEDOPL varchar(50);
declare variable NAMEBUD varchar(50);
declare variable NAMEVNE varchar(50);
declare variable PROCNADBZAWKAF decimal(10,2);
declare variable SUMMANADBZAWKAF decimal(10,2);
declare variable SUMMANADBZAWKAFBUD decimal(10,2);
declare variable SUMMANADBZAWKAFVNE decimal(10,2);
declare variable RAZR integer;
declare variable SHIFRPODOSN integer;
declare variable ISZAMDEKAN integer;
declare variable PROCZAMDEKAN decimal(10,2);
declare variable SUMMAZAMDEKBUD decimal(15,2);
declare variable SUMMAZAMDEKVNE decimal(15,2);
declare variable SUMMAZAMDEKTOT decimal(15,2);
declare variable ISDEKAN integer;
declare variable NAMEVNEZD varchar(32);
declare variable SHIFRDOLOSN integer;
declare variable SHIFRDOLSAV integer;
declare variable NDOL varchar(64);
declare variable IND integer;
declare variable C varchar(1);
declare variable FLAGND integer;
declare variable LD integer;
declare variable SHIFRFAC integer;
declare variable PROCNADBDEC decimal(15,2);
declare variable SUMMANADBDEC decimal(15,2);
declare variable NAMEISTFINNADBDEC varchar(256);
begin
     NameBud =  'з бюдж. фінанс.';
     NameVne =  'з позабюдж. фінанс.';
     procnadbdec  = 0;
     summanadbdec = 0;
     nameistfinnadbdec=0;
     select first 1 a.tabno      , a.shifrus     , a.shifruz      , a.shifrdol , b.shifrpod,
                    a.koefbud    , a.koefvne     , a.okladb       , a.okladv   ,
                    a.procnus    , a.summanusb   , a.summanusv    ,
                    a.procnuz    , a.summanuzb   , a.summanuzv    ,
                    a.procnpstag , a.stagp       , a.summanpstagb , a.summanpstagv ,
                    a.shifrzasl  , a.procnzasl   , a.summanzaslb  , a.summanzaslv  ,
                    a.shifrwr    , a.summapov    , a.summapovbud  , a.summapovvne  ,
                    a.iszawkaf   , a.ISDOCONOTHERSTAWKA ,
                    a.procnadbzawkaf, a.summanadbzawkaf, a.summanadbzawkafbud, a.summanadbzawkafvne,
                    a.razr       , a.shifrpodosn , a.iszamdekana  , a.isdekan,
                    a.summazamdecbud, a.summazamdecvne, a.summazamdectot,a.proczamdec,
                    a.shifrdolosn,b.shifrfac
            from tb_k_shtrasppedrec a
                 join tb_k_shtraspped b on a.shifridown=b.shifrid
            where a.shifrid=:shifridshtrec
            into :tabno , :shifrus   , :shifruz      , :shifrdol     , :shifrpod,
            :koefbud    , :koefvne   , :okladb       , :okladv       ,
            :procnus    , :summanusb , :summanusv    ,
            :procnuz    , :summanuzb , :summanuzv    ,
            :procnpstag , :stagp     , :summanpstagb , :summanpstagv ,
            :shifrzasl  , :procnzasl , :summanzaslb  , :summanzaslv  ,
            :shifrwr    , :summapov  , :summapovbud  , :summapovvne  ,
            :iszawkaf   , :ISDOCONOTHERSTAWKA ,
            :procnadbzawkaf, :summanadbzawkaf, :summanadbzawkafbud,:summanadbzawkafvne,
            :razr       , :shifrpodosn, :iszamdekan , :isdekan,
            :summazamdekbud,:summazamdekvne, :summazamdektot, :proczamdekan,
            :shifrdolosn, :shifrfac;
     tabno        = coalesce(tabno,0);
     shifrus      = coalesce(shifrus,0);
     shifruz      = coalesce(shifruz,0);
     shifrdol     = coalesce(shifrdol,0);
     shifrpod     = coalesce(shifrpod,0);
     koefbud      = coalesce(koefbud,0.00);
     koefvne      = coalesce(koefvne,0.00);
     okladb       = coalesce(okladb,0.00);
     okladv       = coalesce(okladv,0.00);
     procnus      = coalesce(procnus,0);
     summanusb    = coalesce(summanusb,0);
     summanusv    = coalesce(summanusv,0);
     procnuz      = coalesce(procnuz,0);
     summanuzb    = coalesce(summanuzb,0);
     summanuzv    = coalesce(summanuzv,0);
     stagp        = coalesce(stagp,0);
     summanpstagb = coalesce(summanpstagb,0);
     summanpstagv = coalesce(summanpstagv,0);
     shifrzasl    = coalesce(shifrzasl,0);
     procnzasl    = coalesce(procnzasl,0);
     summanzaslb  = coalesce(summanzaslb,0);
     summanzaslv  = coalesce(summanzaslv,0);
     shifrwr      = coalesce(shifrwr,1);
     summapov     = coalesce(summapov,0);
     summapovbud  = coalesce(summapovbud,0);
     summapovvne  = coalesce(summapovvne,0);
     iszawkaf     = coalesce(iszawkaf,0);
     isdoconotherstawka = coalesce(ISDOCONOTHERSTAWKA,0);
     procnadbzawkaf = coalesce(procnadbzawkaf,0.00);
     summanadbzawkaf = coalesce(summanadbzawkaf,0.00);
     summanadbzawkafbud = coalesce(summanadbzawkafbud, 0.00);
     summanadbzawkafvne = coalesce(summanadbzawkafvne, 0.00);
     shifrpodosn   = coalesce(shifrpodosn,0);
     iszamdekan    = coalesce(iszamdekan,0);
     isdekan       = coalesce(isdekan,0);
     summazamdekbud = coalesce(summazamdekbud, 0.00);
     summazamdekvne = coalesce(summazamdekvne, 0.00);
     summazamdektot = coalesce(summazamdektot, 0.00);
     proczamdekan   = coalesce(proczamdekan, 0.00);
     shifrdolosn    = coalesce(shifrdolosn,0);
     shifrfac       = coalesce(:shifrfac,0);
     if ((modefac=2) and (proczamdekan>1)) then  -- 6% некоторым деканам
        begin
             procnadbdec=proczamdekan;
             summanadbdec=summazamdekvne;
        end
     razr           = coalesce(razr,0);
     if ((modefac<>1) and (shifrpod=0) and (shifrfac>0)) then
        shifrpod=shifrfac;
     if (iszawkaf>1) then
        iszawkaf=0;
     if (Shifrwr<>2) then
         shifrwr=1;
     nameus       = '';
     nameuz       = '';
     namezasl     = '';
     s            = '';
     if (ShifrPod=141) then   -- Для военной кафедры на внебюджет а 811-3
        NameVne='з р/р 811/3';
     if (ShifrPod=101) then   -- Для кафедры фундаментальных дисциплин
        NameVne='з р/р 811/1';
     if (ShifrPod=104) then   -- Для курсов подг иноср граждан
        NameVne='з р/р 811/11';
     if ((ShifrPod in (176,177,178)) or
         ((modefac in (2,3)) and (ShifrPod=6))
        )  then   -- Социальной работы и менеджмент социальной работы
        NameVne='з р/р 811/12';
     if (tabno=0) then
         exit;
     -- Получить фамилию
     select first 1 a.pib_dat_pad,a.shifrid
            from tb_k_kadry a
            where a.tabno=:tabno
            into :pibd, :shifridk;
     s = trim(PIBD)||', ';     --'ІВАНОВУ Івану Івановичу, '
     -- ученое звание
     if ((shifruz>0) and (modefac<>3)) then    -- зам деканам не надо
        begin
             select first 1 a.namesokr
                    from tb_k_usz a
                    where a.shifrid=:shifruz
                    into :nameuz;
             nameuz=coalesce(nameuz,'Не найдено уч.зв. '||Shifrus);
             s=trim(s)||' '||trim(nameuz)||',';  -- 'доц.,'
        end
     -- ученая степень
     if ((shifrus>0) and (modefac<>3)) then
        begin
             select first 1 a.shortname
                    from tb_k_uch_st_spr a
                    where a.shifrid=:shifrus
                    into :nameus;
             nameus = coalesce(nameus,'Не найдена уч.ст. '||Shifrus);
             s = trim(s)||' '||trim(nameus)||','; --'к.т.н.,'
        end
     -- Звание заслуженного
     if ((shifrzasl>0) and (modefac<>3)) then
        begin
             select first 1 a.shortname
                    from tb_k_widyzasl a
                    where a.shifrid=:shifrzasl
                    into :namezasl;
        --     namezasl='Заслужений діяч науки і техніки України';
             namezasl = coalesce(namezasl,'Не найден шифр засл '||Shifrzasl);
             s=trim(s)||' '||trim(namezasl)||',';
        end
     if ((modefac=3) and (shifrdolosn>0)) then
        begin
             shifrdolsav=shifrdol;
             shifrdol=shifrdolosn;
        end
     namedol = case
                   when iszawkaf=1                    then 'зав.'            -- заведующий кафедрой
                   when shifrdol in (90,100)          then 'зав.'            -- заведующий кафедрой
                   when shifrdol in (110,120,130,140) then 'проф.'           -- профессор
                   when shifrdol in (150,160,170)     then 'доц.'            -- доцент
                   when shifrdol in (200,210)         then 'ст. викл.'       -- старш.преп.
                   when shifrdol in (190)             then 'викл. '          -- викладач
                   when shifrdol in (220,230)         then 'асист.'          -- асс.
                   when shifrdol in (240)             then 'викл. -стаж.'    -- преп-стажер
                   when shifrdol in (1439)            then 'викл. 1-й кат.'  -- преп-стажер
                   when shifrdol in (47)              then 'директору'       -- директор
                   when shifrdol in (70)              then 'декану'          -- директор
                   when shifrdol in (80)              then 'заст.декана'     -- директор
                   else 'помилка долж'
               end;
     if (modefac=3) then
       if (shifrdolosn>0) then
          shifrdol=shifrdolsav;
/*
       else
          begin
               select first 1 dolg from pr_get_dolg_person_y_m(:tabno,extract(year from :wanteddate),extract(month from :wanteddate))
                      into :namedol;
               namedol=trim(namedol);
               namedol=coalesce(namedol,'ош.зам.дек.');
               if (substr(namedol, 1,1) in ('0','1','2','3','4','5','6','7','8','9')) then
                  begin
                       flagnd = 0;
                       ind  = 0;
                       ld   = strlen(namedol);
                       ndol = '';
                       while (ind<ld) do
                         begin
                              ind=ind+1;
                              c=substr(namedol, ind,ind);
                              if (c not in ('0','1','2','3','4','5','6','7','8','9')) then
                                 flagnd=1;
                              if (flagnd=1) then
                              ndol=ndol||c;
                         end
                       ndol=trim(ndol);
                       namedol=ndol;

                  end

          end
  */
     namedol1=NameDol;
     -- nameDol = для первой строки
     -- nameDOL1 = для строки со ставкой
     if (isDocOnOtherStawka in (1,2)) then
     if ((namedol like '%проф%') and (isDocOnOtherStawka=2)) then
        begin
             namedol='проф.';                    -- проф на должности доцента
             if (razr=19) then
                NameDol1 = 'доц.';
             else
             if (razr=20) then
                NameDol1 = namedol;

        end
     else
     if ((namedol like '%доц%') and (isDocOnOtherStawka=1)) then
        begin
             namedol='доц.';                    -- проф на должности доцента
             if (razr in (17,16)) then
                namedol1= case
                              when razr=17 then 'ст.викл'
                              when razr=16 then 'асист.'
                              else namedol1
                           end;
             else
             if (razr = 19) then
                namedol1=namedol;

        end
     else
     if ((shifrdol in (150,160,170)) and (isDocOnOtherStawka=2)) then
        begin
             namedol='проф.';                    -- проф на должности доцента
             if (razr=19) then
                NameDol1 = 'доц.';
             else
             if (razr=20) then
                NameDol1 = namedol;

        end
     else
     if (isDocOnOtherStawka=1) then
        begin
             namedol='доц.';
             if (razr in (17,16)) then
                namedol1= case
                              when razr=17 then 'ст.викл'
                              when razr=16 then 'асист.'
                              else namedol1
                           end;
             else
             if (razr=19) then
                NameDol1 = namedol;
        end
  --   if (iszawkaf=1) then
  --      namedol='зав.';



     if ((tabno=4671) and (shifrpod=141)) then      -- Каваль т н 4671 - зам зав каферой а не зав кафедрой
        begin
             NameDol  = 'заст. зав.';
             NameDol1 = NameDol;
        end
 --    if (:tabno=337) then
 --       exception wdayzero namedol1;
/*
     if (shifrdol not in(90,100)) then
        begin
              select first 1 a.shifrusz from tb_k_kadrypr a
                           where a.shifridowner=:shifridk
                             and a.codetype=5
                             and coalesce(a.datefr,cast('1900-01-01' as date))<=:wanteddate
                             and (coalesce(a.dateto,current_date)>=:wanteddate)
                           into :iszawkaf;
              iszawkaf=coalesce(iszawkaf, 0);
              if (iszawkaf=shifrpod) then
                 iszawkaf=1;
              else
                 iszawkaf=0;
              if (iszawkaf=1) then
                 namedol='зав.';
        end
*/


     -- 17 10 2012 --
     -- для языковых кафедр на асист а викл
     if (SHIFRPOD IN (34,50,131,144)) then
        begin
             if (namedol containing 'асист') then
                NameDol='викл.';
             if (namedol1 containing 'асист') then
                NameDol1='викл.';
        end
     s=trim(s)||' '||trim(namedol);
     if (modefac not in (2,3)) then
        select first 1 a.name_k from tb_k_podr a where a.shifrpod=:shifrpod
                                into :namepod;
     else
        select first 1 a.name_k from tb_k_facultety a where a.shifrid=:shifrpod
                                into :namepod;
-- замдеканам взять название должности из осно места работи
     if (modefac=3) then
        begin
             select first 1 a.name_k from tb_k_podr a where a.shifrpod=:shifrpodosn
                                into :namepod;
        end

     if ((ShifrPod<>104) AND (mODEFAC<>2)) then
        s=trim(s)||' каф. "'||trim(namepod)||'"' ;      ------------- м б на каф а подг курсы
     else
        s=trim(s)||' '||trim(namepod);                  ------------- м б на каф а подг курсы
     dates=extract(day from wanteddate)||'.'||
     case
         when extract(month from wanteddate)<10 then '0'||extract(month from wanteddate)
         else extract(month from wanteddate)
     end
     ||'.'||(extract(year from wanteddate)-2000);
     if (shifrwr=2) then
        s=trim(s)||' за сумісництвом';
     if (modefac<>3) then
        s=trim(s)||' з '||trim(dates)||ascii_char(160)||'р. встановити посадовий оклад (п/о)';
     else
        begin     -- Зам декана --
--             s=trim(s)||' з '||trim(dates)||ascii_char(160)||'р. встановити доплату за виконаня обов''язків заст.декану ';
             select first 1 a.name_k from tb_k_facultety a where a.shifrid=:shifrpod
                                into :namepod;
             if (namepod like '%акульт%') then
                begin    -- зам деканам - за замдекана
                      s=trim(s)||' з '||trim(dates)||ascii_char(160)||'р. встановити доплату за виконаня обов''язків заст.декану ';

                        -- Всегда из внебюджета

                      s=trim(s)||' '||trim(namepod);
                end
             else  -- в институтах - за складність та напруженість
                s=trim(s)||' з '||trim(dates)||ascii_char(160)||'р. встановити надбавку за складність, напруженість у роботі';

             if (not ((proczamdekan>1 and proczamdekan<29))) then
                 proczamdekan=30;
             s=trim(s)||' у розмірі '||cast(ProcZamDekan as integer)||'% від п/о - '||trim(cast(summazamdektot as decimal(12,2)))||' грн.';
             if (shifrpod=5) then  -- міжнародний ф-т рр - 811/11
                namevnezd=' з р/p 811/11';
             else
                namevnezd=' з позабюдж. фінанс.';
             if ((summazamdekbud>1) and
                 (summazamdekvne<1)) then
                if (namepod not like '%акульт%') then
                   s=trim(s)||trim(namevnezd);
                else
                    s=trim(s)||' з бюдж. фінанс.';
             else
             if ((summazamdekbud<1) and (summazamdekvne>1)) then
                s=trim(s)||trim(namevnezd);
             else
                if (namepod not like '%акульт%') then
                   s=trim(s)||trim(namevnezd);
                else
                   begin
                        s=trim(s)||' у т.ч. '||trim(cast(summazamdekbud as decimal(12,2)))||' грн. з бюджетного фінансування,';
                        s=trim(s)||' '||trim(cast(summazamdekvne as decimal(12,2)))||' грн.'||trim(namevnezd);
                    end
             suspend;  --- выход из процедуры - остальное для зам деканов - нен нужно
             exit;
        end
     if ((ISDOCONOTHERSTAWKA in (1,2)) and (trim(namedol)<>trim(namedol1))) then
        s=trim(s)||' '||trim(namedol1);
     s=trim(s)||' з розрахунку ';
                                    -- неразрывный пробел перед р.
                                    -- после слов (п/о) должность для доц старшого викладача
     sk=(koefbud+koefvne);
     if (sk like '%00') then
        sk=cast((koefbud+koefvne) as decimal(12,0));
     else
        if (sk like '%0') then
           sk=cast((koefbud+koefvne) as decimal(12,1));
     s=trim(s)||' '||sk||' ст.';
      -- Для военной кафедры писать не вне бюджет а
      -- з р/р 811/3
      -- Для Коваля с военной каф написать зам зав каф
      -- Фраза для надбавки зав каф доц
      -- Плюс доплата за виконання обовязків зав.каф. у розмірі 12.5% від п/о - ГГГ.кк грн., у т.ч.: 77. грн. з бюдж.фінанс., 67.67 грн. з позабюдж. фінанс
      -- Процент с апр 12% а до того был 20% и наверное разделения на бюдж и вне бюдж теперь нет
      --
      -- Проф может быть на долж. доцент
     if ((koefbud>0) and (koefvne>0)) then
        begin
             sk=koefbud;
             if (sk like '%00') then
                sk=cast((koefbud) as decimal(12,0));
             else
             if (sk like '%0') then
                sk=cast((koefbud) as decimal(12,1));
             skk=koefvne;
             if (skk like '%00') then
                skk=cast((koefvne) as decimal(12,0));
             else
             if (skk like '%0') then
                skk=cast((koefvne) as decimal(12,1));
             s=trim(s)||' ('||sk||' ст. '||Trim(nameBud)||' + '||skk||' ст. '||Trim(nameVne)||')';

        end
     else
     if (koefbud>0.01) then
        s=trim(s)||' '||trim(NameBud);
     else
        s=trim(s)||' '||trim(NameVne);

/*
     if (koefbud>0.01) then
        s=trim(s)||' '||koefbud||' ст. з бюдж.фінанс.';
     if (koefvne>0.01) then
        s=trim(s)||' '||koefvne||' ст. з позабюдж.фінанс.';
*/
--        s=trim(s)||' '||(koefbud+koefvne)||' ст. ';

     s=trim(s)|| ' у розмірі';
     sk=(okladb+okladv+summapovvne);
     if (sk like '%00') then
        sk=cast((okladb+okladv+summapovvne) as decimal(12,0));
     else
        if (sk like '%0') then
           sk=cast((okladb+okladv+summapovvne) as decimal(12,1));

     s=trim(s)||' '||sk||ascii_char(160)||'грн.';
     if (summapovvne>0.0) then
       begin
          sk=(okladb+okladv);
          if (sk like '%00') then
             sk=cast((okladb+okladv) as decimal(12,0));
          else
             if (sk like '%0') then
                sk=cast((okladb+okladv) as decimal(12,1));
          s=trim(s)|| ' ('||sk||ascii_char(160)||'грн. - оклад за ЄТС + ';
          sk=(summapovvne);
          if (sk like '%00') then
             sk=cast((summapovvne) as decimal(12,0));
          else
             if (sk like '%0') then
                sk=cast((summapovvne) as decimal(12,1));
          s=trim(s)||sk||ascii_char(160)||'грн. підвищення)';
       end


--   расшифровка
     sk=(okladb);
     if (sk like '%00') then
         sk=cast((okladb) as decimal(12,0));
     else
         if (sk like '%0') then
             sk=cast((okladb) as decimal(12,1));
     skk=(summapovvne);
     if (skk like '%00') then
         skk=cast((summapovvne) as decimal(12,0));
     else
         if (skk like '%0') then
             skk=cast((summapovvne) as decimal(12,1));
     skop=(okladv+summapovvne);
     if (skop like '%00') then
         skop=cast((okladv+summapovvne) as decimal(12,0));
     else
         if (skop like '%0') then
             skop=cast((okladv+summapovvne) as decimal(12,1));
     skv=(okladv);
     if (skv like '%00') then
         skv=cast((okladv) as decimal(12,0));
     else
         if (skv like '%0') then
             skv=cast((okladv) as decimal(12,1));
     if ((koefbud>0.01) and (koefvne<0.01) and (summapovvne>0.01)) then
      s=trim(s)||', у т.ч.: '||sk||ascii_char(160)||'грн. '||trim(NameBud)||', '||skk||ascii_char(160)||'грн. '||trim(NameVne);
     else if ((koefbud>0.01) and (koefvne>0.01) and (summapovvne>0.01)) then
      s=trim(s)||', у т.ч.: '||sk||ascii_char(160)||'грн. '||trim(NameBud)||', '||skop||ascii_char(160)||'грн. '||trim(NameVne);
     else if ((koefbud<0.01) and (koefvne>0.01) and (summapovvne>0.01)) then
      s=trim(s);
     else if ((koefbud>0.01) and (koefvne>0.01) and (summapovvne<0.01)) then
      s=trim(s)||', у т.ч.: '||sk||ascii_char(160)||'грн. '||trim(NameBud)||', '||skv||ascii_char(160)||'грн. '||trim(NameVne);
     else if ((koefbud>0.01) and (koefvne<0.01) and (summapovvne<0.01)) then
      s=trim(s);
     else if ((koefbud<0.01) and (koefvne>0.01) and (summapovvne<0.01)) then
      s=trim(s);

/*
     if ((okladb>0.01) and (okladv>0.01)) then
        s=trim(s)||', '||trim(koefbud)||' ст. - '||okladb||' грн. з бюдж. фінанс. та '||trim(koefvne)||' ст. - '||okladv||' грн. з позабюдж. фінанс.';
      else
        if (okladb>0.01) then
           s=trim(s)||' з бюдж. фінанс.';
        else
           s=trim(s)||' з позабюдж. фінанс.';

      -- Підвищення
      if (WantedDate<cast('2012-03-01' as date)) then
         if ((SummaPovBud+SummaPovVne)>0.01) then
            begin
                 s=trim(s)||' Підвищення '||(SummaPovBud+SummaPovVne)||' грн.';
                 if ((SummaPovBud>0.01) and (SummaPovVne>0.01)) then
                    s=trim(s)||' ('||SummaPovBud||' грн. з бюдж. фінанс., '||SummaPovVne||' грн. з позабюдж. фінанс.).';
                 else if (SummaPovBud>0.01) then
                    s=trim(s)||' з бюдж. фінанс.';
                 else if (SummaPovVne>0.01) then
                    s=trim(s)||' з позабюдж. фінанс.';
            end
*/
      -- Надбавки
      -- 1 за степень и звание и звание заслуженного
--      if ((summanusb+summanusv+summanuzb+summanuzv+summanzaslb+summanzaslv)>1) then
      if ((summanusb+summanusv+summanuzb+summanuzv)>1) then
         begin
             -- Варианты доплат
             -- 1
             -- Плюс доплати за: (как сейчас)
             -- 2
             -- Плюс доплата за ..  (одна доплата и без двоеточия)

              NameDopl=' Плюс доплати за:';
              if (
                   ((summanusb+summanusv)>0.01     and (summanuzb+summanuzv)<0.01) or
                   ((summanuzb+summanuzv)>0.01     and (summanusb+summanusv)<0.01)
       --            ((summanzaslb+summanzaslv)>0.01 and (summanusb+summanusv+summanuzb+summanuzv)<0.01)
                 ) then
                        NameDopl=' Плюс доплата за';
              s=trim(s)||' '||trim(NameDopl);
              -- 1 - за звание
              if ((summanuzb+summanuzv)>1) then
                  begin
                       s=trim(s)||' вчене звання '||cast(procnuz as integer)||'% від п/о - '||(summanuzb+summanuzv)||ascii_char(160)||'грн.';
                       if ((summanuzb>0.01) and (summanuzv>0.01)) then
                          s=trim(s)||', у т.ч.: '||summanuzb||ascii_char(160)||'грн. '||trim(namebud)||', '||summanuzv||ascii_char(160)||'грн. '||NameVne;
                       else
                           if (summanuzb>0.01) then
                              s=trim(s)||' '||trim(NameBud);
                           else
                              s=trim(s)||' '||trim(NameVne);
                       if ((summanusb+summanusv+summanzaslb+summanzaslv)>1) then
                          s=trim(s)||';';
            --           else
            --              s=trim(s)||'.';
                  end
              -- 2 - за степень
              if ((summanusb+summanusv)>1) then
                  begin
             --          if ((summanuzb+summanuzv)>1) then
             --              s=trim(s)||',';
                       s=trim(s)||' науковий ступінь '||cast(procnus as integer)||'% від п/о - '||(summanusb+summanusv)||ascii_char(160)||'грн.';
                       if ((summanusb>0.01) and (summanusv>0.01)) then
                          s=trim(s)||', у т.ч.: '||summanusb||ascii_char(160)||'грн. '||trim(namebud)||', '||summanusv||ascii_char(160)||'грн. '||trim(nameVne);
                       else
                           if (summanusb>0.01) then
                              s=trim(s)||' '||trim(NameBud);
                           else
                              s=trim(s)||' '||trim(NameVne);
                   --    if ((summanzaslb+summanzaslv)>1) then
              --            s=trim(s)||';';
              --         else
                   --       s=trim(s)||'.';
                  end
         end
              -- 3 - за звание заслуженного
      if ((summanzaslb+summanzaslv)>1) then
        begin
             s=trim(s)||' Плюс надбавка за ';

             skn=trim(namezasl);
             if (
                 (skn like 'Засл%') or
                 (skn like 'засл%') or
                 (skn like 'ЗАСЛ%')
                ) then skn='почесне звання "Засл.."';
                skn=trim(skn);

             s=trim(s)||' '||trim(skn)||' у розмірі '||cast(procnzasl as integer)||'% від п/о - '||(summanzaslb+summanzaslv)||ascii_char(160)||'грн.';
             if ((summanzaslb>0.01) and (summanzaslv>0.01)) then
                s=trim(s)||', у т.ч.: '||summanzaslb||ascii_char(160)||'грн. '||trim(NameBud)||', '||summanzaslv||ascii_char(160)||'грн. '||trim(nameVne);
             else
                if (summanzaslb>0.01) then
                              s=trim(s)||' '||trim(NameBud);
                           else
                              s=trim(s)||' '||trim(NameVne);
                  end
      -- 2 за пед стаж
      if ((summanpstagb+summanpstagv)>1) then
         begin
              s=trim(s)||' Плюс надбавка за вислугу років (н/п стаж складає '||trim(cast(stagp as decimal(15,1)))||' р.) у розмірі';
              s=trim(s)||' '||trim(cast(procnpstag as integer))||'% від п/о -';
              s=trim(s)||' '||trim(summanpstagb+summanpstagv)||ascii_char(160)||'грн.';
              if ((summanpstagb>0.01) and (summanpstagv>0.01)) then
                 s=trim(s)||', у т.ч.: '||summanpstagb||ascii_char(160)||'грн. '||trim(nameBud)||', '||summanpstagv||ascii_char(160)||'грн. '||trim(NameVne);
                       else
                           if (summanpstagb>0.01) then
                              s=trim(s)||' '||trim(nameBud);
                           else
                              s=trim(s)||' '||trim(nameVne);
         end
              -- 4 - за зав кафедрой
      if ((procnadbzawkaf>0.01) and ((summanadbzawkafbud+summanadbzawkafvne)>1)) then
         begin
              s=trim(s)||' Плюс доплата за виконання обов''язків зав. каф. у розмірі ';
              sk=procnadbzawkaf;
              if (sk like '%00') then
                 sk=cast(procnadbzawkaf as decimal(12,0));
              else
              if (sk like '%0') then
                sk=cast(procnadbzawkaf as decimal(12,1));
                s=trim(s)||' '||sk||'% від п/о - '||(summanadbzawkafbud+summanadbzawkafvne)||ascii_char(160)||'грн.' ;

      -- Плюс доплата за виконання обовязків зав.каф. у розмірі 12.5% від п/о - ГГГ.кк грн., у т.ч.: 77. грн. з бюдж.фінанс., 67.67 грн. з позабюдж. фінанс
              if ((summanadbzawkafbud>0.01) and (summanadbzawkafvne>0.01)) then
                 s=trim(s)||', у т.ч.: '||summanadbzawkafbud||ascii_char(160)||'грн. '||trim(NameBud)||', '||summanadbzawkafvne||ascii_char(160)||'грн. '||trim(nameVne);
              else
                  if (summanadbzawkafbud>0.01) then
                     s=trim(s)||' '||trim(NameBud);
                  else
                     s=trim(s)||' '||trim(NameVne);
         end
      -- проверить надбавку 6% некоторін деканам
      if (modefac=2) then
      if ((abs(abs(procnadbdec)-6.00)<0.01) and
          (summanadbdec>10.00))then
         begin
              nameistfinnadbdec=' Плюс надбавка за складність та напруженість у роботі '||cast(procnadbdec as integer)||'% від п/о у ромірі '||summanadbdec||' грн. з позабюдж. фінанс.';
              s=trim(s)||' '||trim(nameistfinnadbdec);
         end


  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MAKETEXTORDKAF (
    SHIFRKAF INTEGER,
    WANTEDDATE DATE,
    SHIFRWR INTEGER,
    MODEFAC INTEGER)
RETURNS (
    S VARCHAR(4096),
    TABNO INTEGER,
    FIO VARCHAR(50),
    SHIFRIDREC INTEGER)
AS
declare variable SHIFRID integer;
begin
     shifrid=null;
     if (modefac=1) then
        select first 1  a.shifrid from tb_k_shtraspped a
                                  where a.shifrpod=:shifrkaf
                                    and a.datefr=:wanteddate
                                  into shifrid;
     else
        select first 1  a.shifrid from tb_k_shtraspped a
                                 where a.shifrfac=:shifrkaf
                                   and a.datefr=:wanteddate
                                  into shifrid;
     if (Shifrid is null) then
         exit;
     for
         select a.shifrid,a.tabno,a.fio from tb_k_shtrasppedrec a
                          where a.shifridown=:shifrid and
                                a.shifrwr=:shifrwr    and
                                coalesce(a.notprint,0)<>1      -- отмеченных не печатать
                             and (
                                  (:modefac not in (2,3)) or
                                  ((:modefac = 2) and (coalesce(a.iszamdekana,0)=0)) or
                                  ((:modefac = 3) and (coalesce(a.iszamdekana,0)=1))
                                 )

                              --  a.tabno=1228
                          order by a.priority desc, a.fio
                          into :shifridrec,:tabno,:fio
     do
        begin

--              select s from pr_k_maketextorderrec(:shifridrec, :wanteddate) into s;
              select s from PR_K_MAKETEXTORDERREC201201(:shifridrec, :wanteddate,:modefac) into s;
              suspend;
        end


  /* Procedure Text */

end^


ALTER PROCEDURE PR_K_MARKPEDRABOTNIKI
RETURNS (
    K INTEGER)
AS
declare variable ID integer;
declare variable TABNO integer;
declare variable TMP integer;
begin
     k=0;
     for
        select a.shifrid,a.tabno from tb_k_kadry a
                into :id,:tabno

     do
       begin
             tmp=0;
             select  count(*) from fadd b
                             join person c on b.shifridperson=c.shifrid
                    where c.yearvy>=2012 and
                          c.shifrkat=1 and
                          c.tabno=:tabno and
                          b.summa>0.01
                   -- order by c.yearvy desc, c.monthvy desc
                    into :tmp;
             tmp=coalesce(tmp,0);
             if (tmp>0) then
                begin
                     k=k+1;
                     update tb_k_kadry
                        set is_ped=1
                        where shifrid=:id;
                end
       end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MARKPEDST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable ID integer;
declare variable SUMMA decimal(15,2);
declare variable YPED integer;
declare variable MPED integer;
declare variable DT date;
begin
     k=0;
     dt=:y||'-'||:m||'-01';
     for
        select a.shifrid,a.tabno from tb_k_kadry a
                                 where a.is_ped=1 and
                                       a.date_stag_p is null and
                                       a.pedstagispriblisit is null
   --                                and a.tabno=113
               into :id,:tabno
     do
       begin
             summa=null;
             select first 1 b.summa from fcn b
                    where b.tabno=:tabno and
                          b.shifrsta=8  and   -- уч звание - 18 (15 - канд 25 - докт) ; 22 - уч звание 25 доцент 33 проф ; 17 - за звание заслуженного (20%)
                          b.year_vy=:y and b.month_vy=:m
                    into :summa;

             summa=coalesce(summa,0);
             if (summa>29.00) then
                begin
                     yped=20;
                     mped=1;
                end
             else if (summa>19.00) then
                begin
                     yped=10;
                     mped=1;
                end
             else if (summa>9.00) then
                begin
                     yped=5;
                     mped=1;
                end
             else
                begin
                     yped=0;
                     mped=1;
                end

             update tb_k_kadry a
                 set
                    a.stag_p_do_y=:yped,
                    a.stag_p_do_m=:mped,
                    a.date_stag_p=:dt,
                    a.pedstagispriblisit=1
                    where a.shifrid=:id;
             k=k+1;
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MARKUSZ
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable ID integer;
declare variable SUMMA decimal(15,2);
begin
     k=0;
     delete from tb_k_kadrypr where codetype=3;
--     exit;
     for
        select a.shifrid,a.tabno from tb_k_kadry a
                                 where a.is_ped=1
   --                                and a.tabno=113
               into :id,:tabno
     do
       begin
             summa=null;
             select first 1 b.summa from fcn b
                    where b.tabno=:tabno and
                          b.shifrsta=17  and   -- уч звание - 18 (15 - канд 25 - докт) ; 22 - уч звание 25 доцент 33 проф ; 17 - за звание заслуженного (20%)
                          b.year_vy=2012 and b.month_vy=4
                    into :summa;

             summa=coalesce(summa,0);
             if (Summa>0) then
                begin
                     k=k+1;
                     if (summa=20) then
                        insert into tb_k_kadrypr (SHIFRIDOWNER,CODETYPE,SHIFRUSZ,
                                           DATEFR ,  NAME)
                               values (:id, 3,1,'2012-04-01','засл. (авт)');
                     else
                         if (summa>20) then
                            insert into tb_k_kadrypr (SHIFRIDOWNER,CODETYPE,SHIFRUSZ,
                                           DATEFR ,  NAME)
                                   values (:id, 3,1,'2012-04-01','д-.т-.н-. (авт)');
                end

       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MARKZAWKAF
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable ID integer;
declare variable SHIFRPOD integer;
declare variable SHIFRTMP integer;
declare variable NAMEK varchar(150);
begin
     k=0;
 --    delete from tb_k_kadrypr where codetype=3;
--     exit;
     for
         select distinct a.tabno,a.w_place from person a
                  where a.yearvy=2012
                    and a.monthvy=1
                    and (
                         (a.dolg containing 'каф')    or
                         (a.dolg containing 'з.к')    or
                         (a.dolg containing 'з. к')   or
                         (a.dolg containing 'зав.к')  or
                         (a.dolg containing 'зав. к') or
                         (a.dolg containing 'зав к')  or
                         (a.dolg containing 'з к')
                        )
                  into :tabno,:shifrpod
     do
       begin
            id=null;
            select a.shifrid from tb_k_kadry a where a.tabno=:tabno into :id;
            if (id is not null) then
               begin
                    shifrtmp=null;
                    select a.shifrusz from tb_k_kadrypr a
                                     where a.codetype     = 5
                                       and a.shifridowner = :id
                                      into :shifrtmp;
                    if (shifrtmp is null) then
                       begin
                            k=k+1;
                            namek='';
                            select first 1 a.name_k from tb_k_podr a
                                                    where a.shifrpod=:shifrpod
                                                    into namek;
                            namek=substr('зав.каф.'||trim(:namek),1,50);
                        insert into tb_k_kadrypr (SHIFRIDOWNER,CODETYPE,SHIFRUSZ,
                                           DATEFR ,  NAME)
                               values (:id, 5,:shifrpod,'2012-01-01',:namek);
                       end
               end
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_MOVEFIXTOSHT (
    DATENEW DATE,
    DATEOLD DATE)
RETURNS (
    FINDED INTEGER,
    MAKED INTEGER)
AS
declare variable TABNO integer;
declare variable SHIFRIDOLD integer;
declare variable SHIFRWR integer;
declare variable SHIFRIDNEW integer;
declare variable OKLADRAZR decimal(10,2);
declare variable RAZR integer;
begin
     finded = 0;
     maked  = 0;
     for
        select b.tabno,b.shifrid,b.shifrwr,b.razr from tb_k_shtraspped a
               join tb_k_shtrasppedrec b on b.shifridown=a.shifrid
               where a.datefr=:dateold and
                     b.fixed=1
               into
                   :tabno,:shifridold,:shifrwr,:razr

      do
      begin
            finded=finded+1;
            shifridnew=null;
            select first 1 b.shifrid from tb_k_shtraspped a
               join tb_k_shtrasppedrec b on b.shifridown=a.shifrid
               where a.datefr=:datenew and
                     b.tabno=:tabno and
                     b.shifrwr=:shifrwr
               into
                   :shifridnew;
            if (shifridnew is not null) then
               begin
                    maked=maked+1;
                    update tb_k_shtrasppedrec a
                       set
                          a.fio                = (select first 1 b.fio                 from tb_k_shtrasppedrec b where b.shifrid=:shifridold),
                          a.shifrus            = (select first 1 c.shifrus             from tb_k_shtrasppedrec c where c.shifrid=:shifridold),
                          a.procnus            = (select first 1 d.procnus             from tb_k_shtrasppedrec d where d.shifrid=:shifridold),
                          a.summanusb          = (select first 1 e.summanusb           from tb_k_shtrasppedrec e where e.shifrid=:shifridold),
                          a.summanusv          = (select first 1 f.summanusv           from tb_k_shtrasppedrec f where f.shifrid=:shifridold),
                          a.shifruz            = (select first 1 g.shifruz             from tb_k_shtrasppedrec g where g.shifrid=:shifridold),
                          a.procnuz            = (select first 1 h.procnuz             from tb_k_shtrasppedrec h where h.shifrid=:shifridold),
                          a.summanuzb          = (select first 1 i.summanuzb           from tb_k_shtrasppedrec i where i.shifrid=:shifridold),
                          a.summanuzv          = (select first 1 j.summanuzv           from tb_k_shtrasppedrec j where j.shifrid=:shifridold),
                          a.shifrdol           = (select first 1 k.shifrdol            from tb_k_shtrasppedrec k where k.shifrid=:shifridold),
                          a.koefbud            = (select first 1 l.koefbud             from tb_k_shtrasppedrec l where l.shifrid=:shifridold),
                          a.okladb             = (select first 1 m.okladb              from tb_k_shtrasppedrec m where m.shifrid=:shifridold),
                          a.koefvne            = (select first 1 n.koefvne             from tb_k_shtrasppedrec n where n.shifrid=:shifridold),
                          a.okladv             = (select first 1 o.okladv              from tb_k_shtrasppedrec o where o.shifrid=:shifridold),
                          a.shifrpodosn        = (select first 1 p.shifrpodosn         from tb_k_shtrasppedrec p where p.shifrid=:shifridold),
                          a.shifrdolosn        = (select first 1 r.shifrdolosn         from tb_k_shtrasppedrec r where r.shifrid=:shifridold),
                          a.summanpstagb       = (select first 1 s.summanpstagb        from tb_k_shtrasppedrec s where s.shifrid=:shifridold),
                          a.summanpstagv       = (select first 1 u.summanpstagv        from tb_k_shtrasppedrec u where u.shifrid=:shifridold),
                          a.summanzaslb        = (select first 1 vv.summanzaslb        from tb_k_shtrasppedrec vv where vv.shifrid=:shifridold),
                          a.summanzaslv        = (select first 1 v.summanzaslv         from tb_k_shtrasppedrec v where v.shifrid=:shifridold),
                          a.razr               = (select first 1 w.razr                from tb_k_shtrasppedrec w where w.shifrid=:shifridold),
                          a.okladrazr          = (select first 1 x.okladrazr           from tb_k_shtrasppedrec x where x.shifrid=:shifridold),
                          a.summapov           = (select first 1 y.summapov            from tb_k_shtrasppedrec y where y.shifrid=:shifridold),
                          a.summapovbud        = (select first 1 z.summapovbud         from tb_k_shtrasppedrec z where z.shifrid=:shifridold),
                          a.summapovfull       = (select first 1 aa.summapovfull       from tb_k_shtrasppedrec aa where aa.shifrid=:shifridold),
                          a.iszawkaf           = (select first 1 ab.iszawkaf           from tb_k_shtrasppedrec ab where ab.shifrid=:shifridold),
                          a.isdekan            = (select first 1 ac.isdekan            from tb_k_shtrasppedrec ac where ac.shifrid=:shifridold),
                          a.iszamdekana        = (select first 1 ad.iszamdekana        from tb_k_shtrasppedrec ad where ad.shifrid=:shifridold),
                          a.isdoconotherstawka = (select first 1 ae.isdoconotherstawka from tb_k_shtrasppedrec ae where ae.shifrid=:shifridold),
                          a.procnadbzawkaf     = (select first 1 af.procnadbzawkaf     from tb_k_shtrasppedrec af where af.shifrid=:shifridold),
                          a.summanadbzawkaf    = (select first 1 ag.summanadbzawkaf    from tb_k_shtrasppedrec ag where ag.shifrid=:shifridold),
                          a.summanadbzawkafbud = (select first 1 ah.summanadbzawkafbud from tb_k_shtrasppedrec ah where ah.shifrid=:shifridold),
                          a.summanadbzawkafvne = (select first 1 ai.summanadbzawkafvne from tb_k_shtrasppedrec ai where ai.shifrid=:shifridold),
                          a.fixed = 1
                      where a.shifrid=:shifridnew;
                      okladrazr = null;
                      if (razr between 1 and 25) then
                         select first 1 a.oklad from tb_razr_proc a
                                        where a.razr=:razr and a.datefr<=:datenew
                                        order by a.datefr desc
                                        into :okladrazr;
                      okladrazr = coalesce(okladrazr , 0.00);
                    update tb_k_shtrasppedrec a
                       set
                          a.summanusb          = :okladrazr*coalesce(a.koefbud,0.00)*(coalesce(a.procnus,0.00) / 100.00),
                          a.summanusv          = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnus,0.00) / 100.00),
                          a.summanuzb          = :okladrazr*coalesce(a.koefbud,0.00)*(coalesce(a.procnuz,0.00) / 100.00),
                          a.summanuzv          = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnuz,0.00) / 100.00),
                          a.okladb             = :okladrazr*coalesce(a.koefbud,0.00),
                          a.okladv             = :okladrazr*coalesce(a.koefvne,0.00),
                          a.summanpstagb       = :okladrazr*coalesce(a.koefbud,0.00)*(coalesce(a.procnpstag,0.00) / 100.00),
                          a.summanpstagv       = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnpstag,0.00) / 100.00),
                          a.summanzaslb        = :okladrazr*coalesce(a.koefbud,0.00)*(coalesce(a.procnzasl,0.00)  / 100.00),
                          a.summanzaslv        = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnzasl,0.00)  / 100.00),
                          a.okladrazr          = :okladrazr,
                          a.summanadbzawkaf    = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnzasl,0.00)  / 100.00),
                          a.summanadbzawkafbud = :okladrazr*coalesce(a.koefbud,0.00)*(coalesce(a.procnadbzawkaf,0.00)  / 100.00),
                          a.summanadbzawkafvne = :okladrazr*coalesce(a.koefvne,0.00)*(coalesce(a.procnadbzawkaf,0.00)  / 100.00)
                      where a.shifrid=:shifridnew;


               end
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_PEDSTAG (
    TABNO INTEGER,
    WANTEDDATE DATE)
RETURNS (
    Y INTEGER,
    M INTEGER)
AS
declare variable START_Y_STAG integer;
declare variable START_M_STAG integer;
declare variable CURR_Y_STAG integer;
declare variable CURR_M_STAG integer;
declare variable C_Y integer;
declare variable C_M integer;
declare variable DATE_STAG_P date;
declare variable C_D date;
declare variable U_D date;
begin
  y=0;
  m=0;
  select first 1 a.stag_p_do_y,a.stag_p_do_m,a.date_stag_p  from tb_k_kadry a
                                      where a.tabno=:tabno
                                      into :start_y_stag,:start_m_stag,:date_stag_p;
  start_y_stag=coalesce(start_y_stag,0);
  start_m_stag=coalesce(start_m_stag,0);
  date_stag_p=coalesce(date_stag_p,CURRENT_DATE);
  curr_y_stag=start_y_stag;
  curr_m_stag=start_m_stag;
  C_M=extract(month from wanteddate);
  C_Y=extract(year from wanteddate);
  u_d=cast(c_Y||'-'||c_m||'-01' as date);
  C_M=extract(month from date_stag_p);
  C_Y=extract(year from date_stag_p);
  c_d=cast(c_Y||'-'||c_m||'-01' as date);
  if (u_d>c_d) then
      while (c_d<u_d) do
         begin
             curr_m_stag=curr_m_stag+1;
             if (curr_m_stag>=12) then
                begin
                    Curr_y_stag=Curr_y_stag+1;
                    Curr_m_stag=0;
                end
             c_d=addmonth(c_d, 1);
         end
  else
  if (u_d<c_d) then
      while (c_d>u_d) do
         begin
             curr_m_stag=curr_m_stag-1;
             if (curr_m_stag<1) then
                begin
                    Curr_y_stag=Curr_y_stag-1;
                    Curr_m_stag=12;
                end
             c_d=addmonth(c_d, -1);

         end

  y=curr_y_stag;
  m=curr_m_stag;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_PROFONOTHERSTAWKA (
    WANTEDDATE DATE)
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable ID integer;
declare variable SHIFRIDDOL integer;
declare variable SHIFRTMP integer;
declare variable NAMEK varchar(150);
declare variable M integer;
declare variable Y integer;
declare variable DATETMP date;
begin
     k=0;
 --    delete from tb_k_kadrypr where codetype=3;
 --    exit;
     y = extract(year  from wanteddate);
     m = extract(month from wanteddate);
     wanteddate=y||'-'||m||'-01';
     for
        select a.tabno,(select d.shifriddolg from pr_get_dolg_person_by_id(a.shifrid) d) from  person a
               where a.dolg containing 'проф'
                 and a.yearvy  = :y
                 and a.monthvy = :m
                 and (
                      (select c.shifriddolg from pr_get_dolg_person_by_id(a.shifrid) c) not in (6,7,90,100,110,130,140)
                     )
                and (
                     not exists (
                                 select * from tb_k_kadry e
                                          join tb_k_kadrypr f on e.shifrid=f.shifridowner
                                          where e.tabno=a.tabno
                                            and f.codetype=2
                                            and f.shifrusz=2
                               )
                    )
               into :tabno,shifriddol
     do
       begin
            id=null;
            select a.shifrid from tb_k_kadry a where a.tabno=:tabno into :id;
            if (id is not null) then
               begin
                    shifrtmp=null;
                    select a.shifrid from tb_k_kadrypr a
                                      where a.codetype     = 8
                                        and :wanteddate between a.datefr and a.dateto
                                        and a.shifridowner = :id
                                      into :shifrtmp;
                    if (shifrtmp is null) then
                       begin
                            k=k+1;
                            namek='профессор на др. ставке';
                            insert into tb_k_kadrypr (SHIFRIDOWNER,CODETYPE,SHIFRUSZ,
                                                      DATEFR , dateto,  NAME)
                               values (:id, 8,2,:wanteddate,:wanteddate,:namek);
                       end
               end
       end

  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_K_SELRECFORWORD (
    SHIFRIDORD INTEGER,
    SHIFRPOD INTEGER,
    MODEFAC INTEGER)
RETURNS (
    FIO VARCHAR(50),
    TEXT VARCHAR(4096))
AS
declare variable SHIFRIDSRR integer;
declare variable NEED integer;
declare variable NOTPRINT integer;
declare variable SHIFRDOL integer;
begin
      for
          select a.fio,a.text,a.shifridshtrasprec from tb_k_orderrectext a
                              where a.shifridowner=:shifridord
                                and  (
                                       ((:modefac=1) and (a.shifrpod=:shifrpod))
                                       or
                                       ((:modefac<>1) and (a.shifrfac=:shifrpod))
                                     )
                               order by a.lineno
                              into :fio,:text,:SHIFRIDSRR
      do
          begin
               shifridsrr=coalesce(shifridsrr,0);
               need=1;
               if (shifridsrr>0) then
                  begin
                        select first 1 a.notprint from tb_k_shtrasppedrec a
                                                  where a.shifrid=:shifridsrr
                                                  into :notprint;
                        notprint=coalesce(notprint,0);
                        if (notprint=1) then
                           need=0;
                        if (need=1) then
                            if (modefac in (2,3)) then
                                begin
                                    select first 1 aa.shifrdol   from tb_k_shtrasppedrec aa
                                           where aa.shifrid=:SHIFRIDSRR
                                           into :shifrdol;
                                    shifrdol=coalesce(:shifrdol,0);
                                    if (modefac=2) then
                                       begin
                                           if (shifrdol not in (70,47)) then
                                               need=0;
                                       end
                                    else
                                       if (shifrdol in (70,47)) then
                                          need=0;
                                end
                  end
               if (need=1) then
                  suspend;
          end

  /* Procedure Text */
 -- suspend;
end^


ALTER PROCEDURE PR_K_SHTRMOVEPODRREC (
    SHIFRIDREC INTEGER,
    SHIFRPOD INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable SHIFRIDPED integer;
declare variable SHIFRPODCURR integer;
declare variable DATEFR date;
declare variable SHIFRIDPEDNEW integer;
begin
     k=0;
  /* Procedure Text */
     shifridped = null;
     select a.shifridown from  tb_k_shtrasppedrec a
                         where a.shifrid=:shifridrec
                         into :shifridped;
     if (shifridped is null) then
        exit;
     shifrpodcurr=null;
     datefr=null;
     select a.shifrpod,a.datefr  from tb_k_shtraspped a
                                 where a.shifrid=:shifridped
                                 into :shifrpodcurr,:datefr;
     if (shifrpodcurr is null) then
         Exit;
     if (datefr is null) then
         Exit;
     if (Shifrpod=ShifrPodCurr) then
         Exit;
     shifridpednew=null;
     select a.shifrid  from tb_k_shtraspped a
                       where a.shifrpod=:shifrpod
                         and a.datefr=:datefr
                       into :shifridpednew;
     if (shifridpednew is null) then
        begin
              insert into tb_k_shtraspped (datefr,dateto,shifrpod)
                          values (:datefr,:datefr,:shifrpod);
              select a.shifrid  from tb_k_shtraspped a
                                where a.shifrpod=:shifrpod
                                  and a.datefr=:datefr
                                into :shifridpednew;
        end
     update tb_k_shtrasppedrec a
        set a.shifridown=:shifridpednew
        where a.shifrid=:shifridrec;
     k=1;
  suspend;
end^


ALTER PROCEDURE PR_K_TESTUSZ (
    WANTEDDATE DATE)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    COMMENT VARCHAR(150))
AS
declare variable ID integer;
declare variable SUMMA decimal(15,2);
declare variable SUMMAK decimal(10,2);
declare variable SHIFRUZ integer;
declare variable SHIFRUS integer;
declare variable Y integer;
declare variable M integer;
begin
     y=extract(year from wanteddate);
     m=extract(month from wanteddate);
     for
        select a.shifrid,a.tabno,a.fio from tb_k_kadry a
                                 where VERIFIED=1
                            --     and tabno=2139
                            into :id,:tabno,:fio
     do
       begin
            if (:tabno=3) then
               id=id;
            select sum(z.summa) from fadd z
                   where z.tabno=:tabno
                     and z.year_vy=:y
                     and z.month_vy=:m
                    into :summa;


            if (summa>0.01) then
                begin
            -- 1 test uch zvann
             summa=null;
             select first 1 b.summa from fcn b
                    where b.tabno=:tabno and
                          b.shifrsta=22  and   -- науч степень - 18 (15 - канд 25 - докт) ; 22 - уч звание 25 доцент 33 проф ; 17 - за звание заслуженного (20%)
                          b.year_vy=:y and b.month_vy=:m
                          order by b.summa desc
                    into :summa;
             summa=coalesce(summa,0);
             shifruz=null;
             select first 1 a.shifrusz from tb_k_kadrypr a
                            where a.shifridowner=:id  and
                                  a.codetype=2
                            into :shifruz;
             shifruz=coalesce(shifruz,0);
             if ((shifruz=1) and (summa<>25.00)) then
                   begin
                        comment='В кадрах доц а надбавки нет';
                        suspend;
                   end
             if ((shifruz<>1) and (summa=25.00)) then
                   begin
                        comment='Есть надбавка доц., а кадрах нет доц.';
                        suspend;
                   end
             if ((shifruz=2) and (summa<>33.00)) then
                   begin
                        comment='В кадрах профессор а надбавки нет';
                        suspend;
                   end
             if ((shifruz<>2) and (summa=33.00)) then
                   begin
                        comment='Есть надбавка проф., а в кадрах нет отметки проф.';
                        suspend;
                   end
            -- 2 test uch stepen
             shifrus=null;
             select first 1 a.shifrusz from tb_k_kadrypr a
                            where a.shifridowner=:id  and
                                  a.codetype=1
                            into :shifrus;
             shifrus=coalesce(shifrus,0);
             summa=null;
             select first 1 b.summa from fcn b
                    where b.tabno=:tabno and
                          b.shifrsta=18  and   -- уч звание - 18 (15 - канд 25 - докт) ; 22 - уч звание 25 доцент 33 проф ; 17 - за звание заслуженного (20%)
                          b.year_vy=:y   and
                          b.month_vy=:m  and
                          (
                            ((:shifrus between 1 and 48) and (b.summa=15.00))  or
                            ((:shifrus>49) and (b.summa=25.00))  or
                            (:shifrus < 1)
                          )
                          order by b.summa desc
                    into :summa;
             summa=coalesce(summa,0);
             shifrus=coalesce(shifrus,0);
             if ((shifrus between 1 and 40) and (summa<>15.00)) then
                   begin
                        comment='В кадрах канд наук а надбавки нет';
                        suspend;
                   end
             if ((shifrus not between 1 and 40) and (summa=15.00)) then
                   begin
                        comment='Есть надбавка к н а в кадрах не к.н.';
                        suspend;
                   end
             if ((shifrus>49) and (summa<>25.00)) then
                   begin
                        comment='В кадрах д. наук а надбавки нет';
                        suspend;
                   end
             if ((shifrus<50) and (summa=25.00)) then
                   begin
                        comment='Есть надбавка д. н., а в кадрах не д.н.';
                        suspend;
                   end
             end

       end
   comment='Проверка окончена';
   fio='';
   tabno=0;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_KOMAND_CALC (
    SHIFRID INTEGER,
    DATEFR DATE,
    DATETO DATE,
    WANTEDSHIFRSTA INTEGER,
    MODE_V_Z INTEGER,
    MODEDC INTEGER,
    MODERECALCCLOCK INTEGER)
RETURNS (
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    K_DAY INTEGER)
AS
declare variable SUMMA decimal(15,2);
declare variable DAYS decimal(15,2);
declare variable SUMMABUD decimal(15,2);
declare variable SUMMAVNE decimal(15,2);
declare variable SUMMAGN decimal(15,2);
declare variable SUMMANIS decimal(15,2);
declare variable MUSOR integer;
declare variable CURRDATE date;
declare variable M integer;
declare variable Y integer;
declare variable K_DAY_CURR integer;
declare variable B_DAY_5 integer;
declare variable SHIFRSTA integer;
declare variable TMPVAR integer;
declare variable CLOCKPERDAY decimal(15,4);
declare variable SHIFRPOD integer;
declare variable RETVAL integer;
begin
     clockPerDay=8.00;

     if (moderecalcclock<1) then -- если перерасчет после ручной корректировки то не удалять
        delete from tb_komand_res where shifridkmnd=:shifrid;
     update tb_komand_summy a
           set a.summa_vne=coalesce((select sum(summa) from tb_komand_add b
                                          where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
                                                 (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za)) and
                                                shifridkmnd=:shifrid and
                                                exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=2) and
                                                b.marked>0),0),
               a.summa_bud=coalesce((select sum(summa) from tb_komand_add b
                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
                                                (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za)) and
                                                shifridkmnd=:shifrid and
                                                exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=1) and
                                                b.marked>0),0),
               a.summa_gn=coalesce((select sum(summa) from tb_komand_add b
                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
                                                (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za)) and
                                                shifridkmnd=:shifrid and
                                                exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=3) and
                                                b.marked>0),0),
               a.summa_nis=coalesce((select sum(summa) from tb_komand_add b
                                         where ((:MODE_V_Z=1 AND b.month_vy=a.month_za and b.year_vy=a.year_za) or
                                                (:MODE_V_Z=0 AND b.month_za=a.month_za and b.year_za=a.year_za)) and
                                                shifridkmnd=:shifrid and
                                                exists (select shifr from gruppy c where c.shifr=b.shifrgru and c.shifrgrum=4) and
                                                b.marked>0),0)
       where shifridkmnd=:shifrid and Manual_Calc<>1;
     meanday     = 0;
     meanday_bud = 0;
     meanday_vne = 0;
     meanday_gn  = 0;
     meanday_nis = 0;
     select coalesce(sum(summa_bud) +
                     sum(summa_vne) +
                     sum(summa_gn) +
                     sum(summa_nis),0),
            coalesce(sum(Summa_Bud),0),
            coalesce(sum(Summa_Vne),0),
            coalesce(sum(Summa_GN),0),
            coalesce(sum(Summa_NIS),0)
              from tb_komand_summy a
            where shifridkmnd=:shifrid AND
                  a.sel>0
            into :summa,:summabud,:summavne,:summagn,:summanis;

     select sum(days) from tb_komand_summy a
            where shifridkmnd=:shifrid AND
                     (a.sel>0)
            into :days;
     Days=coalesce(Days,0);
     if (Days>0) then
         begin
              MeanDay     = cast(Summa    / Days as decimal(15,2));
              MeanDay_bud = cast(Summabud / Days as decimal(15,2));
              MeanDay_vne = cast(Summavne / Days as decimal(15,2));
              MeanDay_gn  = cast(Summagn  / Days as decimal(15,2));
              MeanDay_nis = cast(Summanis / Days as decimal(15,2));
         end
  -- exception e_p07 'days='||:days;
    CurrDate   = DateFr;
    k_day      = 0;
    k_day_curr = 0;
    m = extract(month from currdate);
    y = extract(year from currdate);
   --- Определить коледж или университет
    shifrpod = null;
    retval   = null;
    select first 1  a.w_place from tb_komand_add a
                              where a.shifridkmnd=:shifrid
                                and a.w_r=1
                              into :shifrpod;
    shifrpod=coalesce(:shifrpod,0);
    select first 1 retval from pr_is_coledgpodr(:shifrpod)
                          into :retval;
    retval=coalesce(retval,0);
    if (retval=1) then
       shifrpod=-2;     -- колледж
    else
       shifrpod=-1;     -- университет

    -- окончание лроеделения колледлжа или университета

    ShifrSta = 138;
    if (moderecalcclock<>1) then
       begin
          while (CurrDate<=DateTo) do
                begin
                      select first 1 IsBolnDt.b from IsBolnDt(:CurrDate,:shifrpod) into TmpVar;
                      TmpVar=coalesce(TmpVar,0);
                      if (TmpVar=0) then
                         begin
                               if (extract(month from CurrDate)<>m or extract(year from CurrDate)<>y) then
                                  begin
                                       if (k_day_curr>0) then
                                           begin
                                                if (ModeDC=1) then
                                                   k_day_curr=k_day_curr*clockPerDay;
                                                insert into tb_komand_res (shifridkmnd,shifrsta,k_day,month_za,year_za,
                                                                          summa_k_bud,summa_k_vne,summa_k_gn,summa_k_nis)
                                                       values(:shifrid,:ShifrSta,:k_day_curr, :m,:y,
                                                              :k_day_curr*:meanday_bud,:k_day_curr*:meanday_vne,
                                                              :k_day_curr*:meanday_gn ,:k_day_curr*:meanday_nis);
                                           end
                                       k_day_curr = 0;
                                       m = extract(month from currdate);
                                       y = extract(year  from currdate);
                                  end
                               k_day      = k_day      + 1;
                               k_day_curr = k_day_curr + 1;
                          end
                       CurrDate = CurrDate+1;
                  end         -- end loop
          ShifrSta=WantedShifrSta;
          if (k_day_curr>0) then
             begin
                  if (ModeDC=1) then
                     k_day_curr=k_day_curr*clockPerDay;
                  insert into tb_komand_res (shifridkmnd,shifrsta,k_day,month_za,year_za,
                                 summa_k_bud,summa_k_vne,summa_k_gn,summa_k_nis)
                         values(:shifrid,:ShifrSta,:k_day_curr, :m,:y,
                               :k_day_curr*:meanday_bud,:k_day_curr*:meanday_vne,
                               :k_day_curr*:meanday_gn ,:k_day_curr*:meanday_nis);
             end
      end
   else   -- блок расчета больничных в случае почасового с ручной установки часов
      begin
--           select first 1 b_day from tmp_boln_res where connid=CURRENT_CONNECTION into :b_day;
--           exception wdayzero 'b_day='||b_day;
           update tb_komand_res set
                  summa_k_bud = k_day * :MeanDay_bud,
                  summa_k_vne = k_day * :MeanDay_vne,
                  summa_k_gn  = k_day * :MeanDay_gn,
                  summa_k_nis = k_day * :MeanDay_Nis
              where shifridkmnd = :shifrid;
      end
   select sum(k_day) from tb_komand_res
                     where shifridkmnd = :shifrid
                     into :k_day;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_KOMAND_INIT (
    SHIFRID INTEGER,
    TABNO INTEGER,
    DATEFR DATE,
    CURRMONTH INTEGER,
    CURRYEAR INTEGER,
    MODE_ZA_VY INTEGER,
    MODE_ILL INTEGER,
    MODEDC DECIMAL(15,4))
AS
declare variable MUSOR integer;
declare variable Y integer;
declare variable M integer;
declare variable CURRDATE date;
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable SUMMA_BUD decimal(15,2);
declare variable SUMMA_GN decimal(15,2);
declare variable SUMMA_NIS decimal(15,2);
declare variable SUMMA_VNE decimal(15,2);
declare variable DAYS integer;
declare variable DAYNO integer;
declare variable D date;
declare variable SBOLN integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable ID_CLAR integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable DATEB date;
declare variable DATEE date;
declare variable DATEC date;
declare variable L integer;
declare variable MUSOR1 integer;
declare variable KAL_DAY integer;
declare variable KOEF decimal(15,4);
declare variable OKLAD decimal(15,2);
declare variable RAZRIJAD integer;
declare variable KOEFRAZR decimal(15,4);
declare variable DATEPRI date;
declare variable DATEUW date;
declare variable SDEKR integer;
declare variable SKOMANDIROWKI integer;
declare variable CLOCKPERDAY integer;
declare variable WDAYS integer;
declare variable CLOCKS decimal(15,2);
declare variable SHIFRIDKSUM integer;
declare variable SHIFRPOD integer;
declare variable ISCOLLEDG integer;
begin
     clockPerDay = 8.00;    -- 8 рабочих часов в день
     /*
         Удаление данных из вспомагательных таблиц
     */
     if (coalesce(ShifrId,0)>0) then
        begin
             delete from tb_komand_res   a where a.shifridkmnd=:shifrid;
             delete from tb_komand_summy a where a.shifridkmnd=:shifrid;
             delete from tb_komand_add   a where a.shifridkmnd=:shifrid;
        end
     -- Разряд
     select first 1 razrijad from pr_get_razr_person_vy(:tabno,extract(month from :datefr),extract(year from :datefr))
            into :razrijad;
     y = extract(year from datefr) ;
     m = extract(month from datefr);
     select first 1 kadry.data_pri,kadry.data_uw   from kadry  where tabno=:tabno into :datepri,:dateuw;
     if ((datepri is null) or (extract(year from datepri)<1950)) then
        datepri='1950-01-01';
     if ((dateuw is null) or (extract(year from dateuw)<1950)) then
        dateuw='2100-01-01';
     I_count=0;
     -- Главный цикл - 12 мес
     while (i_count<12) do
      begin
            i_count=i_count+1;
            m=m-1;
            if (m<1) then
               begin
                     m = 12;
                     y = y-1;
               end
            CurrDate    = Y||'-'||M||'-'||'01';
            shifridksum = gen_id(g_komand_summy,0);
            insert into tb_komand_summy (shifrid , shifridkmnd, month_za, year_za)
                                 values(:shifrid , :shifridksum, :m, :y);

            summa_bud = 0;
            summa_vne = 0;
            summa_gn  = 0;
            summa_nis = 0;
            for
                select fadd.summa,  fadd.shifrkat,fadd.shifrgru,shifr.komand,
                       fadd.W_PLACE,fadd.W_R,     fadd.shifrsta,fadd.Month_Za,
                       fadd.year_za,fadd.month_vy,fadd.year_vy ,fadd.vypl from fadd
                              join shifr on fadd.shifrsta=shifr.shifr
                              where ((:mode_za_vy=0     and     -- зп
                                      fadd.month_za=:m  and
                                      fadd.year_za=:y) or
                                    (:mode_za_vy=1     and      -- в
                                      fadd.month_vy=:m and
                                      fadd.year_vy=:y))  and
                                    fadd.tabno=:tabno and
                                    not exists (select i_podr.shifr_pod   from i_podr   where i_podr.shifr_pod   = fadd.w_place   and i_podr.mode=1) and
                                    not exists (select i_gruppy.shifr_gru from i_gruppy where i_gruppy.shifr_gru = fadd.shifrgru) and
                                    not exists (select i_kat.shifr_kat    from i_kat    where i_kat.shifr_kat    = fadd.shifrkat)
                   into :summa,:shifrkat,:shifrgru,:SKomandirowki,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl
            do
              begin
                    Marked  = 1;
                    SKomandirowki=coalesce(SKomandirowki,0);
                    if (SKomandirowki=0) then Marked=0;   -- Командировки
                    if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=1)) then
                       summa_bud=summa_bud+summa;   -- бюджет
                    else
                    if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=2)) then
                       summa_vne=summa_vne+summa;   -- вне бюджет
                    else
                    if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=3)) then
                       summa_gn=summa_gn+summa;    -- ГН
                    else
                    if (exists (select shifr from gruppy where shifr=:shifrgru and shifrgrum=4)) then
                       summa_nis=summa_nis+summa;  -- НИС
                    insert into tb_komand_add (shifridkmnd,shifridkmndsummy,W_PLACE,W_R,SHIFRGRU,
                                              SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                                              MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED)
                            values (:shifrid ,:shifridksum,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked);
              end   -- Конец цикла по статьям
--- Подсчет рабочих дней

--- определить коледж или университет
            shifrpod=null;
            iscolledg=null;
            select first 1  a.w_place from fadd a
                              where a.tabno=:tabno and
                                    :datefr>cast(a.year_vy||'-'||a.month_vy||'-01' as date)
                                and a.w_r=1
                              order by a.year_vy desc, a.month_vy desc
                              into :shifrpod;
            shifrpod=coalesce(:shifrpod,0);
            select first 1 retval from pr_is_coledgpodr(:shifrpod)
                                  into :iscolledg;
            iscolledg=coalesce(iscolledg,0);
            if (iscolledg=1) then
               shifrpod=-2;     -- колледж
            else
               shifrpod=-1;     -- университет

--- конец определения коледж или университет

            Days=0;
            for
                select distinct DayNo from tabel join person on tabel.shifrid=person.shifrid
                            where person.w_r=1        and
                                  person.main>0       and
                                  person.tabno=:tabno and
                                  person.monthvy=:m   and
                                  person.yearvy=:y    and
                           tabel.code in (1,2,3,5,8,10,11,12,16)
                            into  :DayNo
            do
              begin
                    d=:Y||'-'||:M||'-01';
                    select first 1 l from lenmonth(:d) into :l;
                    l=coalesce(l,0);
                    if (dayno<=l) then
                       begin
                             d=:Y||'-'||:M||'-'||:dayno;
                             select first 1 subbota from TestSubbota(:D,:shifrpod) into Musor;
                             if (Musor=0) then    -- Изменения от 13 04 2010 учесть
                                                  -- начисленные командировочные
                             if (exists (select * from boln aa
                                  where :d between aa.f_data and aa.l_data
                                  and aa.tabno=:tabno
                                 and coalesce(extract(year from aa.data_p_bud),1990)>2010
                                  /*and aa.mode_ill<10*/)) then Musor=1;
                             if (Musor=0) then
                                Days=Days+1;
                       end
              end
/* Подсчет количества каледарн_х дней изменился с 15 12 2009 */
---Подсчет количества календарных дней
            dateb=y||'-'||m||'-01';
            select first 1 l from lenmonth(:dateb) into :l;
            datee=y||'-'||m||'-'||l;
            DateC=DateB;

            Musor=0;
            Kal_Day=0;
            while (Musor<l) do
              begin
                   Musor=Musor+1;
                   DateC=Y||'-'||m||'-'||musor;
                   Musor1=0;
                   if (exists (select * from boln where boln.tabno=:tabno and :DateC between boln.f_data and boln.l_data)) then musor1=1;
                   else if (datec not between datepri and dateuw) then musor1=1;
                   if (Musor1=0) then
                      Kal_Day=Kal_Day+1;
              end

---Получение оклад
            select first 1 oklad from person
                   where :tabno=person.tabno and
                          1=person.w_r and
                          person.monthvy=extract(month from :currdate) and
                          person.yearvy=extract(year from :currdate) and
                          person.main>0
                   into :oklad;
            Oklad=coalesce(oklad,0);
---Извлечение коеэффициента
            select first 1 koef from bol_koe
                   where /*(DateB<:CurrDate and */bol_koe.mode=1 and
                         extract(Month from DateZa)=extract(Month from :CurrDate) and
                         extract(Year from DateZa)=extract(Year from :CurrDate) /*and
                         dateb<cast(:curryear||'-'||:currmonth||'-01' as date) */
                   order by DateB desc
                   into :Koef;
            if (Koef is null) then Koef=1;

            select first 1 koef from pr_get_koef_razr(:datefr, :currdate, 2,:razrijad)
                   into :KoefRazr;
            if (KoefRazr is null or KoefRazr<1) then
               KoefRazr=1;

            Koef = Koef * KoefRazr;
            Sel=0;
            if (I_Count<3) then Sel=1;
            if (ModeDC=1) then
               begin
                    select first 1 a.wdays,a.clocks from tb_days a
                           where a.yearza=:y and a.monthza=:m
                           into :wdays,:clocks;
                    wdays  = coalesce(wdays,0);
                    clocks = coalesce(clocks,clockPerDay);
                    if (wdays>10) then
                       days    = clocks;
                    else
                       days    = days * clockPerDay;
                    Kal_Day = Kal_Day * clockPerDay;
               end
            update tb_komand_summy a
                  set
                      SUMMA_BUD   = :summa_bud ,
                      SUMMA_VNE   = :summa_vne ,
                      SUMMA_GN    = :summa_gn  ,
                      SUMMA_NIS   = :summa_nis ,
                      Days        = :Days      ,
                      sel         = :sel       ,
                      Graphic_Day = :KAL_DAY   ,
                      Koef        = :Koef      ,
                      Oklad_m     = :Oklad     ,
                      MANUAL_CALC = 0
              where a.shifrid = :shifridksum;
--            insert into tb_komand_summy (shifridkmnd,MONTH_ZA,YEAR_ZA,SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,Days,sel,Graphic_Day,Koef,Oklad_m,MANUAL_CALC)
--                 values (:shifrid, :M,:Y,:summa_bud, :summa_vne,:summa_gn,:summa_nis,:days, :Sel,:KAL_DAY,:Koef,:Oklad,0);
      end


  /* Procedure Text */
/*     suspend;*/
end^


ALTER PROCEDURE PR_LIST_PENS_INV (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    SHIFRPOD INTEGER,
    NAMEPOD VARCHAR(256),
    SUMMA DECIMAL(15,2),
    NAMEKIND VARCHAR(32))
AS
declare variable SHIFRCNSTA integer;
begin
     -- mode = 1 - пенсионеры
     --      = 2 - инвалиды
     if (mode=2) then
         shifrcnsta=112;
     else
         shifrcnsta=107;
     for
        select a.tabno from person a
               where exists(select * from fcn b
                                     where b.shifridperson=a.shifrid
                                       and b.shifrsta in (:shifrcnsta, :shifrcnsta+500))
                 and a.yearvy  = :y
                 and a.monthvy = :m
               group by 1
               into :tabno
     do
       begin
            fio      = null;
            shifrpod = null;
            namepod  = null;
            summa    = null;
            select first 1 fio from kadry c
                   where c.tabno=:tabno
                   into :fio;
            select first 1 d.w_place from person d
                   where d.tabno=:tabno
                     and d.yearvy  = :y
                     and d.monthvy = :m
                     and ((select first 1 shifrwr from pr_isosnwrbyid(d.shifrid))=1)
                   into :shifrpod;
            if (shifrpod is null) then
               select first 1 e.w_place from person e
                      where e.tabno=:tabno
                        and e.yearvy  = :y
                        and e.monthvy = :m
                      into :shifrpod;
             if (shifrpod is not null) then
                select first 1 retval from pr_get_podr_name_hist(:shifrpod,:y,:m)
                       into :namepod;
             select sum(f.summa) from fadd f
                    where f.tabno    = :tabno
                      and f.year_vy  = :y
                      and f.month_vy = :m
                    into :summa;
             summa=coalesce(summa,0.00);
             if ((select first 1 retval from pr_is_coledgpodr(:shifrpod))=1) then
                 namekind='Колледж';
             else
                 namekind='Университет';

          suspend;
       end
end^


ALTER PROCEDURE PR_LIST_SOWM_IN_OUT (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    NEEDSUMMA INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(60),
    SHIFRPOD INTEGER,
    NAMEPOD VARCHAR(256),
    SUMMA DECIMAL(15,2),
    NAMEKIND VARCHAR(32))
AS
declare variable SHIFRIDPERSON integer;
begin
     -- mode = 1 - внешние    совместители
     --      = 2 - внутренние совместители

     for
        select a.w_place,a.tabno,a.shifrid from person a
               where a.yearvy  = :y
                 and a.monthvy = :m
                 and a.w_place  not in (76,79,81,82,85,86,89,91,102,105,106,121,140,156,157,158,165)
                 and (
                 ((:mode=1)
                       and
                           (exists(select first 1  * from person b
                                         where b.w_place in (82)
                                           and b.w_r=1
                                           and b.tabno   = a.tabno
                                           and b.yearvy  = :y
                                           and b.monthvy = :m))

                       and
                         (
                          ((select first 1 coalesce(k.shifr_pod,0) from kadry k where k.tabno=a.tabno)=0)
                         or
                          ((select first 1 coalesce(k1.shifr_pod,0) from kadry k1 where k1.tabno=a.tabno)=82)
                         )
                       and
                           (not exists(select first 1  * from person b
                                         where b.w_place not in (11,76,79,81,82,85,86,89,91,102,105,106,121,140,156,157,158,165)
                                           and b.w_r=1
                                           and b.tabno   = a.tabno
                                           and b.yearvy  = :y
                                           and b.monthvy = :m))
                      ) or
                      ((:mode=2)
                        and
                           not (exists(select first 1  * from person b
                                         where b.w_place in (82)
                                           and b.w_r=1
                                           and b.tabno   = a.tabno
                                           and b.yearvy  = :y
                                           and b.monthvy = :m))
                       and
                         (
                         ((select first 1 coalesce(k2.shifr_pod,0) from kadry k2 where k2.tabno=a.tabno)<>82)
             --            or
             --            (select first 1 coalesce(k1.shifr_pod,0) from kadry k1 where k1.tabno=a.tabno)=82)
                         )

                        and
                           ((select first 1 shifrwr from pr_isosnwrbyid(a.shifrid))<>1)

                      )
                    )
               into :shifrpod,:tabno,:shifridperson
     do
       begin
            fio      = null;
            namepod  = null;
            summa    = null;
            select first 1 fio from kadry c
                   where c.tabno=:tabno
                   into :fio;
             if (shifrpod is not null) then
                select first 1 retval from pr_get_podr_name_hist(:shifrpod,:y,:m)
                       into :namepod;
             select sum(f.summa) from fadd f
                    where f.shifridperson    = :shifridperson
                      and f.year_vy  = :y
                      and f.month_vy = :m
                    into :summa;
             summa=coalesce(summa,0.00);
             if ((select first 1 retval from pr_is_coledgpodr(:shifrpod))=1) then
                 namekind='Колледж';
             else
                 namekind='Университет';
             if (
                 ((needsumma=1) and (abs(summa)>0.01))
                 or
                 (needsumma<>1)
                 ) then
          suspend;
       end
end^


ALTER PROCEDURE PR_LT_MIN_SAL
RETURNS (
    TABNO INTEGER,
    TIN VARCHAR(10),
    FULLN_U VARCHAR(30),
    NAME_U VARCHAR(15),
    FATH_U VARCHAR(20),
    SUMMA_1 DECIMAL(15,2),
    SUMMA_2 DECIMAL(15,2),
    SUMMA_3 DECIMAL(15,2),
    SUMMA_4 DECIMAL(15,2),
    SUMMA_5 DECIMAL(15,2),
    SUMMA_6 DECIMAL(15,2),
    SUMMA_7 DECIMAL(15,2),
    SUMMA_8 DECIMAL(15,2),
    SUMMA_9 DECIMAL(15,2),
    SUMMA_10 DECIMAL(15,2),
    SUMMA_11 DECIMAL(15,2),
    SUMMA_12 DECIMAL(15,2))
AS
declare variable summa decimal(15,2);
declare variable period integer;
declare variable shifrid integer;
declare variable shifridind integer;
begin
     for
         select shifrid,tin,tabno,fulln_u,name_u,fath_u from tb_apm_ank
           into :shifrid, :tin, :tabno, :fulln_u,:name_u,:fath_u
     do
        begin
              select first 1 shifrid   from tb_apm_ind
                     where shifridank=:shifrid
                     into :shifridind;
              if (not ((shifridind is null) or (shifridind<=0))) then
                 begin
                       Summa_1=0;
                       Summa_2=0;
                       Summa_3=0;
                       Summa_4=0;
                       Summa_5=0;
                       Summa_6=0;
                       Summa_7=0;
                       Summa_8=0;
                       Summa_9=0;
                       Summa_10=0;
                       Summa_11=0;
                       Summa_12=0;
                       Summa=0;
                       for
                           select period,szp from tb_apm_ind_body
                             where shifridind=:shifridind and
                                   szp<case
                                            when period<4 then 400
                                            when period<7 then 420
                                            when period<10 then 440
                                            else 460
                                       end
                             order by period
                             into :period,:summa
                       do
                         begin
                               if ((summa is not null) and (period is not null))  then
                                  begin
                                        if (period=1) then Summa_1=summa;
                                        else if (period=2) then Summa_2=summa;
                                        else if (period=3) then Summa_3=summa;
                                        else if (period=4) then Summa_4=summa;
                                        else if (period=5) then Summa_5=summa;
                                        else if (period=6) then Summa_6=summa;
                                        else if (period=7) then Summa_7=summa;
                                        else if (period=8) then Summa_8=summa;
                                        else if (period=9) then Summa_9=summa;
                                        else if (period=10) then Summa_10=summa;
                                        else if (period=11) then Summa_11=summa;
                                        else Summa_12=summa;
                                  end
                         end
                       if ((summa_1>0.01) or
                          (summa_2>0.01) or
                          (summa_3>0.01) or
                          (summa_4>0.01) or
                          (summa_5>0.01) or
                          (summa_6>0.01) or
                          (summa_7>0.01) or
                          (summa_8>0.01) or
                          (summa_9>0.01) or
                          (summa_10>0.01) or
                          (summa_11>0.01) or
                          (summa_12>0.01)) then
                       suspend;
                 end
        end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_MAGISRATURA
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(20),
    DOLG VARCHAR(11),
    OKLAD DECIMAL(15,2),
    SUMMA_ST DECIMAL(15,2),
    SUMMA_ZW DECIMAL(15,2),
    SUMMA_ZASL DECIMAL(15,2),
    SUMMA_VYSL DECIMAL(15,2))
AS
begin
     for
       select b.tabno,b.dolg from person b
              where b.yearvy=2007 and b.w_place=79 and b.oklad>0
              group by 1,2
              into :tabno,:dolg
     do
       begin
            select first 1 oklad from person
                   where yearvy=2007 and w_place=79 and
                         (tabno=:tabno) and (dolg=:dolg) and oklad>0
                   order by monthvy desc
                   into oklad;
            select first 1 fio from person
                   where yearvy=2007 and w_place=79 and
                         (person.tabno=:tabno) and (dolg=:dolg) and oklad>0
                   order by monthvy desc
                   into :fio;
            select sum(summa) from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where (person.tabno=:tabno) and (dolg=:dolg)  and
                         person.yearvy=2007 and person.w_place=79 and
                         fadd.shifrsta=18
                   into summa_st;
            select sum(summa) from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where (person.tabno=:tabno) and (dolg=:dolg)  and
                         person.yearvy=2007 and person.w_place=79 and
                         fadd.shifrsta=22
                   into summa_zw;
            select sum(summa) from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where (person.tabno=:tabno) and (dolg=:dolg)  and
                         person.yearvy=2007 and person.w_place=79 and
                         fadd.shifrsta=8
                   into summa_vysl;
            select sum(summa) from fadd
                   join person on fadd.shifridperson=person.shifrid
                   where (person.tabno=:tabno) and (dolg=:dolg)  and
                         person.yearvy=2007 and person.w_place=79 and
                         fadd.shifrsta=17
                   into summa_zasl;
            if (summa_zasl is null) then
                summa_zasl=0;
            if (summa_zw is null) then
                summa_zw=0;
            if (summa_st is null) then
                summa_st=0;
            if (summa_vysl is null) then
                summa_vysl=0;
            suspend;
       end
end^


ALTER PROCEDURE PR_MAKE_CHAIN (
    YEARVY INTEGER,
    MONTHVY INTEGER)
AS
declare variable tabno integer;
declare variable w_r integer;
declare variable w_place integer;
begin
     delete from tb_chain where yearvy=:yearvy and monthvy=:monthvy;
     select count(*) from tb_chain
            where yearvy=:yearvy and monthvy=:monthvy
            into :tabno;
     for
        select tabno from person
               where yearvy=:yearvy and monthvy=:monthvy
               group by 1
               into  :tabno
     do
        begin
        /*    delete from tb_chain where tabno=:tabno and :yearvy=yearvy and monthvy=:monthvy;
             select count(*) from tb_chain
                    where tabno=:tabno   and
                          yearvy=:yearvy and
                          monthvy=:monthvy
                    into w_place;
        */
             for
                select w_r,w_place from person
                       where yearvy=:yearvy   and
                             monthvy=:monthvy and
                             tabno=:tabno
                       into  :w_r,:w_place
             do
                execute procedure pr_add_to_chain(:tabno,:yearvy,:monthvy,:w_place, :w_r);
        end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_MAKEIND201208
AS
declare variable TABNO integer;
declare variable Y integer;
declare variable M integer;
declare variable SUMMAIND decimal(10,2);
declare variable KOEFVNE decimal(10,2);
declare variable KOEFBUD decimal(10,2);
declare variable WDAY integer;
declare variable KALENDAY integer;
declare variable FIO varchar(50);
declare variable DTTMP date;
declare variable SUMMAINDBUD decimal(10,2);
declare variable SUMMAINDVNE decimal(10,2);
declare variable SUMMAINDWDAY decimal(10,2);
declare variable RAZR integer;
declare variable KOEF decimal(10,2);
declare variable DOLG varchar(50);
begin
      y=2012;
      m=8;
      delete from tb_ind_calc_12_7 a where a.yearza=:y and a.monthza=:m;
      for
         select a.tabno,a.summapostind,a.koefosnbud,a.koefosnvne,a.fio,a.razra,dolg from tb_ind_calc_12_7 a
                      where a.yearza=:y    and
                            a.monthza=:m-1 and
                            a.needind=1    and
                            a.summapostind>0.01
                      into :tabno,:summaind,:koefbud,:koefvne,:fio,:razr,:dolg
      do
        begin
             DTTMP=CAST((:y||'-'||:m||'-01')  AS DATE);
             select first 1 retval from work_day(:tabno, :dttmp) into wday;
             wday=coalesce(wday,0);
             select first 1 wdays from tb_days where yearza=:y and monthza=:m into :kalenday;
             kalenday=coalesce(kalenday,0);
             if (wday>kalenday) then
                 wday=kalenday;
             summaind=coalesce(summaind,0.00);
             if (wday<1) then
                summaind=0;
             summaindwday=summaind * cast(wday as decimal(12,2)) / cast(kalenday as decimal(12,2));
             if (koefbud+koefvne>0.01) then
                summaindbud = summaindwday*koefbud / (koefbud+Koefvne);
             summaindvne = summaindwday - summaindbud;
             insert  into tb_ind_calc_12_7  (tabno, yearza,monthza,summapostind,koefosnbud,koefosnvne,fio,
                                             workdaya,kalenddaya,summaindbud, summaindvne,movedbud,movedvne,
                                             summaindwday,dataza,razra,needind,koefa,dolg)
                                      values(:tabno, :y, :m, :summaind, :koefbud, :koefvne, :fio,
                                             :wday, :kalenday,:summaindbud,:summaindvne,0,0,
                                             :summaindwday,:dttmp,:razr,1,:koef,:dolg);
        end
  /* Procedure Text */

end^


ALTER PROCEDURE PR_MARK_ADD_FOR_OTP (
    SHIFRWR INTEGER)
AS
begin
  /* Procedure Text */
   update
         tmp_otp_add a
       set
          a.sel=0
       where a.connid=current_connection;
   if (shifrwr=1) then
          update
               tmp_otp_add a
               set
                  a.sel=1
               where a.connid=current_connection
                 and exists (select * from shifr s
                                 where coalesce(s.otp,0)>0 and s.shifr=a.shifrsta)
                 and (
                       (a.w_r=1)
                       or
                       (a.shifrsta in (2,3))
                       or
                       (a.w_place in (76,81,102,140))
                     );
   else
          update
               tmp_otp_add a
               set
                  a.sel=1
               where a.connid=current_connection
                 and exists (select * from shifr s
                                 where coalesce(s.otp,0)>0 and s.shifr=a.shifrsta)
                 and not (
                       (a.w_r=1)
                       or
                       (a.shifrsta in (2,3))
                       or
                       (a.w_place in (76,81,102,140))
                     );

end^


ALTER PROCEDURE PR_MARKMOALL
RETURNS (
    RETVAL INTEGER)
AS
declare variable SHIFRID integer;
declare variable SUMMA_B decimal(15,2);
declare variable SUMMA_V decimal(15,2);
declare variable SUMMA_G decimal(15,2);
declare variable SUMMA_N decimal(15,2);
begin
     for
        select a.shifrid from tmp_otp_res a
                            where a.connid=current_connection
                            into :shifrid
     do
        begin
              update tmp_otp_res a
                set a.need_pere_bud = 0,
                    a.need_pere_vne = 0,
                    a.need_pere_gn  = 0,
                    a.need_pere_nis = 0
                where a.shifrid=:shifrid;
              select first 1 a.summa_o_bud,a.summa_o_vne,a.summa_o_gn,a.summa_o_nis  from tmp_otp_res a
                     where a.shifrid=:shifrid
                     into :summa_b,:summa_v,:summa_g,:summa_n;
              summa_b=coalesce(summa_b,0);
              summa_v=coalesce(summa_v,0);
              summa_g=coalesce(summa_g,0);
              summa_n=coalesce(summa_n,0);
              if (summa_b>0.01) then
                 update tmp_otp_res a
                  set a.need_pere_bud=1
                  where a.shifrid=:shifrid;
              if (summa_v>0.01) then
                 update tmp_otp_res a
                  set a.need_pere_vne=1
                  where a.shifrid=:shifrid;
              if (summa_g>0.01) then
                 update tmp_otp_res a
                  set a.need_pere_gn=1
                  where a.shifrid=:shifrid;
              if (summa_n>0.01) then
                 update tmp_otp_res a
                  set a.need_pere_nis=1
                  where a.shifrid=:shifrid;
        end
  /* Procedure Text */
  retval=1;
  suspend;
end^


ALTER PROCEDURE PR_MK_E4_ALL (
    Y INTEGER,
    M INTEGER)
AS
declare variable TABNO integer;
declare variable WANTEDMODE integer;
declare variable FORCED_MODE integer;
declare variable VAL integer;
declare variable I integer;
declare variable J integer;
declare variable SUMMA143 decimal(15,2);
begin
     delete from tb_e04t05c where yearvy=:y and monthvy=:m;
     delete from tb_e04t06c where yearvy=:y and monthvy=:m;
     delete from tb_e04t07c where yearvy=:y and monthvy=:m;
     update fadd set sch='' where year_vy=:y and month_vy=:m;
     update fud  set sch='' where year_vy=:y and month_vy=:m;
     val=0;
     val=gen_id(G_E4_NF,val-gen_id(g_e4_nf, 0));
--     ALTER generator G_P4_NF RESTART WITH 0;
--   SET GENERATOR G_P4_NF TO 0;
     execute procedure PR_FILL_E04T05C(:y, :m);
     i=0;
     for
        select tabno from kadry
               where exists (select * from fadd where year_vy=:y  and
                                                      month_vy=:m and
                                                      tabno=kadry.tabno)
--                                                      or
--                     exists (select * from fud where year_vy=:y  and
--                                                     month_vy=:m and
--                                                     shifrsta in (142,143,144,145,146) and
--                                                     tabno=kadry.tabno)
               into :tabno
     do
--       if (tabno in (656)) then
       begin
            i=i+1;
            summa143=0;
            select sum(fud.summa) from fud where year_vy=:y
                      and month_vy=:m
                      and cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||month_za||'-'||year_za) as date)
                      and shifrsta in (143)
                      and tabno=:tabno -- Науч
                      into :summa143;
            summa143=coalesce(summa143,0);
            if (
               (abs(summa143)>0.01)
                                                or
               (exists (select * from fadd where year_vy=:y and month_vy=:m
                                           and fadd.shifrkat in (1,3,5,7)   -- Почасовка
                                           and fadd.tabno=:tabno
                                           and fadd.shifrsta=37
                                           and (select  first 1 coalesce(shifriddolg,0) from pr_get_dolg_person_by_id(fadd.shifridperson))=1455
                                  --         and fadd.w_place not in (76,81,105,106,121,140,157,180)
                                           and fadd.w_place not in (105,106,121)
                                           and fadd.w_place not between 151 and 168    )
                                                )
               or (exists (select * from fadd where fadd.year_vy = :y   -- педработник с з п больше пределеа за прошл мес (отпускные)
                                                and fadd.month_vy        = :m
                                                and fadd.tabno           = :tabno
                                                and
                                    ((select first 1 retval from pr_is_sciped(fadd.shifridperson, 0))=1)
                          )
                  )
               )
                then
               execute procedure pr_e4n_person :tabno,:y,:m,:i  returning_values :j;
                i=i;
/*
            if (exists (select * from fud where year_vy=:y  and
                                                month_vy=:m and
                                                cast(('01-'||:m||'-'||:y) as date) >= cast(('01-'||month_za||'-'||year_za) as date) and
                                                shifrsta in (142) and  -- Обычн
                                                tabno=:tabno)) then
*/
               execute procedure pr_e4_person :tabno,:y,:m,:i  returning_values :j;
                i=i;
               execute procedure pr_e4_sowm_person :tabno,:y,:m,:i  returning_values :j;
                i=i;
/*
            if (exists (select * from fud where year_vy=:y  and
                                                month_vy=:m and
                                                shifrsta in (146) and  -- ДП
                                                tabno=:tabno)) then
*/

            if (
               (exists (select * from fadd where tabno=:tabno and
                                                 year_vy=:y   and
                                                 month_vy=:m  and
                                                 (select first 1 retval from pr_is_dogpod(fadd.w_place))=1  -- ДП
                                                 ))
                or
             (exists (select * from fadd where tabno=:tabno and
                                                 year_vy=:y   and
                                                 month_vy=:m  and
                                                 (
                                                   (w_place=76)
                                                    and
                                                    (select first 1 coalesce(per1.m_o_r,0) from person per1 where per1.shifrid=shifridperson)=82
                                                 )
                                                 ))
               )

                                                 then
              execute procedure pr_e4dp_person :tabno,:y,:m,:i  returning_values :j;

                i=i;
            if ((exists (select * from fud where year_vy=:y  and
                                                month_vy=:m and
                                                shifrsta in (145) and  -- Б
                                                tabno=:tabno))
               or ( exists (select * from fadd where year_vy=:y and
                                               month_vy=:m  and
                                               tabno=:tabno and
                    ((select first 1 retval from pr_isbolnshifr(shifrsta))=1)
                                               ))
               )                                  then
              execute procedure pr_e4ill_person :tabno,:y,:m,:i  returning_values :j;
            if (exists (select * from fadd where year_vy=:y  and
                                                 month_vy=:m and
                                                 shifrsta in (5,6,10) and  -- О
                                                 tabno=:tabno)) then
              begin
                   execute procedure pr_e4otp_person :tabno,:y,:m,:i,143  returning_values :j;
                   execute procedure pr_e4otp_person :tabno,:y,:m,:i,142  returning_values :j;
              end
            execute procedure pr_e4_setlimit :tabno, :y, :m;
      end
  execute procedure pr_e4_13_corr :y, :m;
   execute procedure PR_E7_ALL_PERSON :y, :m;
 --  execute procedure PR_E04T05_6C_DEKR :y, :m;
  execute procedure pr_e04t05_dekr_2019 :y, :m;
   execute procedure PR_E4_CORRECT_NRC :y,:m,2018,10;
  --    select first 1 retval from pr_p4_cvt_5_to_9(:y,:m) into :i;
end^


ALTER PROCEDURE PR_MK_IND_0712_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable TABNO integer;
declare variable R decimal(10,2);
declare variable YP integer;
declare variable MP integer;
begin
     k=0;
     yp=y;
     mp=m;
     mp=m-1;
     if (mp<1) then
        begin
             mp=12;
             yp=yp-1;
        end
  --   delete from tb_ind_calc_12_7 where yearza=:y and monthza=:m;
     for
      --   select FIRST 300 tabno from kadry a
         select tabno from kadry a
                 where exists (select first 1 * from fadd b
                                     where a.tabno=b.tabno and
                                           b.year_za=:y and
                                           b.month_za=:m
                                     ) OR
                       exists (SELECT * FROM tb_ind_calc_12_7 c WHERE c.TABNO=a.tabno and c.yearza=:yp and c.monthza=:mp)

                 into :tabno
     do
     begin
          k=k+1;
          select retval from makeind201207(:tabno,:m,:y,0,0) into r;
     end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_MK_IND_0912_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable R decimal(10,2);
declare variable YP integer;
declare variable MP integer;
declare variable TABNO integer;
begin
     k  =   0 ;
     yp =   y ;
     mp =   m ;
     mp = m-1 ;
     if (mp<1) then
        begin
             mp=12;
             yp=yp-1;
        end
     delete from tb_ind_calc_12_7 where yearza=:y and monthza=:m;
     for
      --   select FIRST 300 tabno from kadry a
         select tabno from kadry a
                 where exists (select first 1 * from fadd b
                                     where a.tabno=b.tabno and
                                           b.year_za=:y and
                                           b.month_za=:m
                                     ) OR
                       exists (SELECT * FROM tb_ind_calc_12_7 c WHERE c.TABNO=a.tabno and c.yearza=:yp and c.monthza=:mp)

                 into :tabno
     do
     begin
          k=k+1;
          select retval from makeind201211(:tabno,:m,:y,0,0) into r;
     end
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_MK_IND_201404_8_9_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable R decimal(10,2);
declare variable YP integer;
declare variable MP integer;
declare variable TABNO integer;
declare variable DTF date;
declare variable DTT date;
begin
     if (y<>2014) then
        exit;
     if (m not in (2,3)) then
        exit;
     k  =   0 ;
     dtf=y||'-'||m||'-01';
     mp=m+1;
     yp=y;
     if (mp>12) then
        begin
             mp=1;
             yp=yp+1;
        end
     dtt=yp||'-'||mp||'-01';
     dtt=dtt-1;
     yp =   y ;
     mp =   m ;
     mp = m-1 ;
     if (mp<1) then
        begin
             mp=12;
             yp=yp-1;
        end
     delete from tb_ind_calc_12_7 where yearza=:y and monthza=:m;
     for
      --   select FIRST 300 tabno from kadry a
         select tabno from kadry a
                 where (
                        exists (select first 1 * from fadd b
                                     where a.tabno=b.tabno and
                                           b.year_za=:y and
                                           b.month_za=:m
                                     ) OR
                        exists (SELECT * FROM tb_ind_calc_12_7 c WHERE c.TABNO=a.tabno and c.yearza=:yp and c.monthza=:mp)
                       ) and
                       (coalesce(a.data_uw,'1900-01-01') not between :dtf and :dtt)

                 into :tabno
     do
     begin
          k=k+1;
          select retval from makeind201404_09_10(:tabno,:m,:y,0,0) into r;
     end
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_MK_IND_201404_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable R decimal(10,2);
declare variable YP integer;
declare variable MP integer;
declare variable TABNO integer;
declare variable DTF date;
declare variable DTT date;
begin
     k  =   0 ;
     dtf=y||'-'||m||'-01';
     mp=m+1;
     yp=y;
     if (mp>12) then
        begin
             mp=1;
             yp=yp+1;
        end
     dtt=yp||'-'||mp||'-01';
     dtt=dtt-1;
     yp =   y ;
     mp =   m ;
     mp = m-1 ;
     if (mp<1) then
        begin
             mp=12;
             yp=yp-1;
        end
     delete from tb_ind_calc_12_7 where yearza=:y and monthza=:m;
     for
      --   select FIRST 300 tabno from kadry a
         select tabno from kadry a
                 where (
                        exists (select first 1 * from fadd b
                                     where a.tabno=b.tabno and
                                           b.year_za=:y and
                                           b.month_za=:m
                                     ) OR
                        exists (SELECT * FROM tb_ind_calc_12_7 c WHERE c.TABNO=a.tabno and c.yearza=:yp and c.monthza=:mp)
                       ) and
                       (coalesce(a.data_uw,'1900-01-01') not between :dtf and :dtt)

                 into :tabno
     do
     begin
          k=k+1;
          select retval from makeind201404(:tabno,:m,:y,0,0) into r;
     end
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_MK_IND_201706_ALL (
    Y INTEGER,
    M INTEGER)
RETURNS (
    K INTEGER)
AS
declare variable R decimal(10,2);
declare variable YP integer;
declare variable MP integer;
declare variable TABNO integer;
declare variable DTF date;
declare variable DTT date;
begin
     k  =   0 ;
     dtf=y||'-'||m||'-01';
     mp=m+1;
     yp=y;
     if (mp>12) then
        begin
             mp=1;
             yp=yp+1;
        end
     dtt=yp||'-'||mp||'-01';
     dtt=dtt-1;
     yp =   y ;
     mp =   m ;
     mp = m-1 ;
     if (mp<1) then
        begin
             mp=12;
             yp=yp-1;
        end
     delete from tb_ind_calc_12_7 where yearza=:y and monthza=:m;
     for
      --   select FIRST 300 tabno from kadry a
         select tabno from kadry a
                 where (
                        exists (select first 1 * from fadd b
                                     where a.tabno=b.tabno and
                                           b.year_za=:y and
                                           b.month_za=:m
                                     )
                       OR exists (SELECT * FROM tb_ind_calc_12_7 c WHERE c.TABNO=a.tabno and c.yearza=:yp and c.monthza=:mp)
                       )
                       and (coalesce(a.data_uw,'1900-01-01') not between :dtf and :dtt)
           --            and a.tabno=9313

                 into :tabno
     do
     begin

          k=k+1;
--        if (tabno=9313) then
          select retval from makeind201706(:tabno,:m,:y,0,0) into r;
     end
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_MK_OTPSWOD (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
declare variable CURRSUMTOT numeric(15,2);
declare variable CURRSUMPE numeric(15,2);
declare variable CURRSUMNE numeric(15,2);
declare variable TABNO smallint;
declare variable SHIFRPOD integer;
declare variable UNI integer;
begin
     shifruni=0;
     while (shifruni<2) do
       begin
            shifruni=shifruni+1;
     for 
        select b.year_za,b.month_za  from otpuska a
               join otp_res b on a.shifrid=b.shifridotp
               where a.data_vy between :DATEFR and :DATETO
               group by 1,2
               into :year_za,:month_za
     do
       begin
            sumtot       = 0;
            sumperenes   = 0;
            sumneperenes = 0;
            for
               select a.tabno,
                      coalesce(b.summa_o_bud,0),
                      case
                           when coalesce(b.data_pere_bud,'1900-01-01')>'2010-06-01' then
                                  coalesce(b.summa_o_bud,0)
                           else 0
                      end,
                      case
                           when coalesce(b.data_pere_bud,'1900-01-01')>'2010-01-01' then
                            0
                           else coalesce(b.summa_o_bud,0)
                      end
               from otpuska a
               join otp_res b on a.shifrid=b.shifridotp
               where b.year_za=:year_za
                 and b.month_za=:month_za
                 and a.data_vy between :datefr and:dateto
               into :tabno, :currsumtot,:currsumpe,:currsumne
            do
              begin
                   select first 1 cc.w_place from person cc
                          where cc.tabno=:tabno
                            and cc.w_r=1
                            and cc.yearvy=2014
                            and cc.monthvy=6
                          into :shifrpod;
                   select retval from pr_is_coledgpodr(:shifrpod) into :uni;
                   if (
                      ((uni<>1) and (shifruni=1))
                      or
                      ((uni=1) and (shifruni=2))
                      )
                   then
                      begin
                           sumtot       = sumtot       + currsumtot;
                           sumperenes   = sumperenes   + currsumpe;
                           sumneperenes = sumneperenes + currsumne;
                      end
              end
            nameuni='Университет';
            if (shifruni=2) then
                nameuni='Колледж';
            if ((abs(sumtot)>0.01)
               or
               (abs(sumperenes)>0.01)
               or
               (abs(sumneperenes)>0.01)) then
            suspend;

       end
     end
end^


ALTER PROCEDURE PR_MK_OTPSWOD_ALL (
    DATEFR DATE,
    DATETO DATE,
    MODE_RUN INTEGER)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
begin
     if (mode_run=1) then
        begin
             for
                select SHIFRUNI,YEAR_ZA,MONTH_ZA,
                       SUMTOT,SUMPERENES,SUMNEPERENES,NAMEUNI from pr_mk_otpswod_arc(:DATEFR,:DATETO)
                     into
                       :SHIFRUNI,:YEAR_ZA,:MONTH_ZA,
                       :SUMTOT,:SUMPERENES,:SUMNEPERENES,:NAMEUNI
             do
               suspend;
        end
     else
        begin
             for
                select SHIFRUNI,YEAR_ZA,MONTH_ZA,
                       SUMTOT,SUMPERENES,SUMNEPERENES,NAMEUNI from pr_mk_otpswod(:DATEFR,:DATETO)
                     into
                       :SHIFRUNI,:YEAR_ZA,:MONTH_ZA,
                       :SUMTOT,:SUMPERENES,:SUMNEPERENES,:NAMEUNI
             do
               suspend;
        end
end^


ALTER PROCEDURE PR_MK_OTPSWOD_ARC (
    DATEFR DATE,
    DATETO DATE)
RETURNS (
    SHIFRUNI INTEGER,
    YEAR_ZA INTEGER,
    MONTH_ZA INTEGER,
    SUMTOT NUMERIC(15,2),
    SUMPERENES NUMERIC(15,2),
    SUMNEPERENES NUMERIC(15,2),
    NAMEUNI VARCHAR(25))
AS
declare variable CURRSUMTOT numeric(15,2);
declare variable CURRSUMPE numeric(15,2);
declare variable CURRSUMNE numeric(15,2);
declare variable TABNO smallint;
declare variable SHIFRPOD integer;
declare variable UNI integer;
begin
     shifruni=0;
     while (shifruni<2) do
       begin
            shifruni=shifruni+1;
     for 
        select b.year_za,b.month_za  from otpuska a
               join otp_res b on a.shifrid=b.shifridotp
               where a.data_vy between :DATEFR and :DATETO
               group by 1,2
               into :year_za,:month_za
     do
       begin
            sumtot       = 0;
            sumperenes   = 0;
            sumneperenes = 0;
            for
               select a.tabno,
                      coalesce(b.summa_o_bud,0),
                      case
                           when (exists (select * from fadd aa
                                                  where aa.tabno=a.tabno
                                                    and abs(abs(aa.summa)-abs(coalesce(b.summa_o_bud,0)))<0.01
                                                    and aa.year_vy=2015
                                                    and aa.month_vy>5
                                                    and aa.shifrsta in (5,6)
                                                    and aa.month_za=b.month_za
                                                    and aa.year_za=b.year_za
                                        )
                                ) then
                                  coalesce(b.summa_o_bud,0)
                           else 0
                      end,
                      case
                           when (not exists (select * from fadd aa
                                                  where aa.tabno=a.tabno
                                                    and abs(abs(aa.summa)-abs(coalesce(b.summa_o_bud,0)))<0.01
                                                    and aa.year_vy=2015
                                                    and aa.month_vy>5
                                                    and aa.shifrsta in (5,6)
                                                    and aa.month_za=b.month_za
                                                    and aa.year_za=b.year_za
                                        )
                                ) then
                                  coalesce(b.summa_o_bud,0)
                           else 0
                      end
               from otpuska a
               join otp_res b on a.shifrid=b.shifridotp
               where b.year_za=:year_za
                 and b.month_za=:month_za
                 and a.data_vy between :datefr and:dateto
               into :tabno, :currsumtot,:currsumpe,:currsumne
            do
              begin
                   select first 1 cc.w_place from person cc
                          where cc.tabno=:tabno
                            and cc.w_r=1
                            and cc.yearvy=2015
                            and cc.monthvy=6
                          into :shifrpod;
                   select retval from pr_is_coledgpodr(:shifrpod) into :uni;
                   if (
                      ((uni<>1) and (shifruni=1))
                      or
                      ((uni=1) and (shifruni=2))
                      )
                   then
                      begin
                           sumtot       = sumtot       + currsumtot;
                           sumperenes   = sumperenes   + currsumpe;
                           sumneperenes = sumneperenes + currsumne;
                      end
              end
            nameuni='Университет';
            if (shifruni=2) then
                nameuni='Колледж';
            if ((abs(sumtot)>0.01)
               or
               (abs(sumperenes)>0.01)
               or
               (abs(sumneperenes)>0.01)) then
            suspend;

       end
     end
end^


ALTER PROCEDURE PR_MK_P4_ALL (
    Y INTEGER,
    M INTEGER)
AS
declare variable tabno integer;
declare variable wantedmode integer;
declare variable forced_mode integer;
declare variable val integer;
declare variable i integer;
begin
     delete from tb_p04t05b where yearvy=:y and monthvy=:m;
     delete from tb_p04t06b where yearvy=:y and monthvy=:m;
     delete from tb_p04t07b where yearvy=:y and monthvy=:m;
     delete from tb_p04t08b where yearvy=:y and monthvy=:m;
     val=0;
     val=gen_id(G_P4_NF,val-gen_id(g_p4_nf, 0));
--     ALTER generator G_P4_NF RESTART WITH 0;
--   SET GENERATOR G_P4_NF TO 0;
     execute procedure PR_FILL_P04T05B(:y, :m);
     i=0;
     for
        select tabno from kadry
               where exists (select * from fadd where year_vy=:y  and
                                                      month_vy=:m and
                                                      tabno=kadry.tabno) or
                     exists (select * from fud where year_vy=:y  and
                                                     month_vy=:m and
                                                     shifrsta=75 and
                                                     tabno=kadry.tabno)
               into :tabno
     do
       begin
 --      if (tabno=7309) then
 --              begin
            i=i+1;
      --      if (i>100) then
      --         exception  e_p07 'табно='||tabno;

            if (exists (select * from tb_prep_uwp_pers_month a where a.tabno=:tabno  and
                                                                     a.summaprep>100 and
                                                                     a.yearvy=:y     and
                                                                     a.monthvy=:m)) then
                WantedMode=2;          -- Две строки
            else
                WantedMode=1;          -- Одна строка
            if (WantedMode=1) then
               execute procedure pr_p4_person(:tabno,:y,:m,0,0);
            else
               begin
--                    select first 1 mode from tb_prep_uwp_pers_month a where a.tabno=:tabno and a.summaprep>100 into :forced_mode;
--                    if (forced_mode=0) then
--                       execute procedure pr_p4_person(:tabno, :y,:m,2,2);
--                    if (forced_mode=1) then
--                       execute procedure pr_p4_person(:tabno, :y,:m,1,1);
--                   if (forced_mode=2) then
                       begin
              -- Науковий работник
                            execute procedure pr_p4_person(:tabno, :y,:m,1,0);
              -- Обычный стаж
                            execute procedure pr_p4_person(:tabno, :y, :m,2,0);
                       end
               end
--            end
      end
  --    select first 1 retval from pr_p4_cvt_5_to_9(:y,:m) into :i;
end^


ALTER PROCEDURE PR_MK_P4_ALL_2010 (
    Y INTEGER,
    M INTEGER)
AS
declare variable tabno integer;
declare variable wantedmode integer;
declare variable forced_mode integer;
declare variable val integer;
declare variable i integer;
begin
     delete from tb_p04t05b;
     delete from tb_p04t06b;
     delete from tb_p04t07b;
     delete from tb_p04t08b;
     val=0;
     val=gen_id(G_P4_NF,val-gen_id(g_p4_nf, 0));
--     ALTER generator G_P4_NF RESTART WITH 0;
--   SET GENERATOR G_P4_NF TO 0;
     execute procedure PR_FILL_P04T05B(:y, :m);
     i=0;
     for
        select tabno from kadry
               where exists (select * from fadd where year_vy<>2010  and
                                                      year_za=2010   and
                                                      tabno=kadry.tabno) or
                     exists (select * from fud where year_vy<>2010 and
                                                     year_za=2010 and
                                                     shifrsta=75 and
                                                     tabno=kadry.tabno)
               into :tabno
     do
       begin
            i=i+1;
            execute procedure pr_p4_person_2010(:tabno,:y,1,0,0);
      end
  --    select first 1 retval from pr_p4_cvt_5_to_9(:y,:m) into :i;
end^


ALTER PROCEDURE PR_MK_SWOD_MATHELP (
    Y INTEGER,
    M INTEGER,
    CURR_MODE INTEGER,
    PODR_MODE INTEGER)
RETURNS (
    SUMMA_MP_BUD DECIMAL(15,2),
    SUMMA_MP_VNE DECIMAL(15,2),
    SUMMA_OZD_BUD DECIMAL(15,2),
    SUMMA_OZD_VNE DECIMAL(15,2),
    SUMMA_POCH_BUD DECIMAL(15,2),
    SUMMA_POCH_VNE DECIMAL(15,2),
    SHIFRDOL INTEGER)
AS
declare variable shifrid integer;
declare variable tabno integer;
declare variable shifrkat integer;
declare variable shifrgru integer;
declare variable w_place integer;
declare variable m_vy integer;
begin
/*                                                                           */
/*    Процедура служит PR_MK_SWOD_MATHELP_DET для расшифровки пофамильной    */
/*                                                                           */

   SUMMA_MP_BUD   = 0;
   SUMMA_MP_VNE   = 0;
   SUMMA_OZD_BUD  = 0;
   SUMMA_OZD_VNE  = 0;
   SUMMA_POCH_BUD = 0;
   SUMMA_POCH_VNE = 0;
 --  curr_Mode=2;      -- преподаватели
   -- 1 --
--   if (Curr_mode=1) then
      for
          select person.shifrid,person.tabno,person.shifrgru,person.w_place,person.monthvy
                 from person
                 where (person.monthvy=:m or :m=0) and (person.yearvy=:y)
                 into :shifrid,:tabno,:shifrgru,:w_place,:m_vy
      do
         begin
              select first 1 shifrkat,shifrdol from pr_get_kat_dolg_person_for_y_m(:tabno,:y,:m_vy)
                     into :ShifrKat,:Shifrdol;
              if (((Curr_Mode=1) and (shifrkat=1)) or
                  ((Curr_Mode=2) and (shifrkat not in (1,4,5))) or
                  ((Curr_Mode=3) and (shifrkat in (4,5)))
                  )        then
              if ((Podr_Mode=1 and w_place not between 151 and 168) or   -- униветситет
                 (Podr_Mode=2 and w_place between 151 and 168) or       -- коледж
                 (Podr_Mode=3))     then                                 -- все
                 begin
              SUMMA_MP_BUD   = 0;
              SUMMA_MP_VNE   = 0;
              SUMMA_OZD_BUD  = 0;
              SUMMA_OZD_VNE  = 0;
              SUMMA_POCH_BUD = 0;
              SUMMA_POCH_VNE = 0;

              select
/*         материальная попмощь            */
                     sum(case
                             when (shifrgru=1 and
                                  (
                                    b.shifrsta=31 or
                                   (b.shifrsta=1 and ((:Podr_mode=1 and w_place in (105,106)) or
                                                      (:Podr_mode=2 and w_place in (158,168))))
                                  )
                                  )
                             then b.summa
                             else 0
                         end),
                     sum(case
                             when (shifrgru<>1 and
                                  (
                                    b.shifrsta=31 or
                                    (b.shifrsta=1 and ((:Podr_Mode=1 and w_place in (105,106)) or
                                                       (:Podr_Mode=2 and w_place in (158,168))))
                                  )
                                  )
                             then b.summa
                             else 0
                         end),
  /* оздоровление */
                     sum(case
                              when (shifrgru=1 and b.shifrsta=20)
                              then b.summa
                              else 0
                          end),
                     sum(case
                             when (shifrgru<>1 and b.shifrsta=20)
                             then b.summa
                             else 0
                         end),
/* почасовая оплата */

                     sum(case
                             when (shifrgru=1 and (w_place in (98,128)
                                                 or (w_place in(8,136) and b.shifrsta=37))   --37 -почасовая оплата
                                  )
                             then b.summa
                             else 0
                        end),
                     sum(case
                             when (shifrgru<>1 and (w_place in (98,128))
                                                 or (w_place in(8,136) and b.shifrsta=37))   --37 -почасовая оплата
                             then b.summa
                             else 0
                         end)
              from fadd b
              where :shifrid=b.shifridperson
              into :SUMMA_MP_BUD  , :SUMMA_MP_VNE  ,
                   :SUMMA_OZD_BUD , :SUMMA_OZD_VNE ,
                   :SUMMA_POCH_BUD,:SUMMA_POCH_VNE;
              if (summa_mp_bud is null)   then summa_mp_bud=0;
              if (summa_mp_vne is null)   then summa_mp_vne=0;
              if (summa_ozd_bud is null)  then summa_ozd_bud=0;
              if (summa_ozd_vne is null)  then summa_ozd_vne=0;
              if (summa_POCH_bud is null) then summa_POCH_bud=0;
              if (summa_POCH_vne is null) then summa_POCH_vne=0;
              suspend;
           end
        end


  /* Procedure Text */


end^


ALTER PROCEDURE PR_MK_SWOD_MATHELP_DET (
    Y INTEGER,
    M INTEGER,
    CURR_MODE INTEGER,
    PODR_MODE INTEGER,
    SHIFRDOL INTEGER)
RETURNS (
    SUMMA_MP_BUD DECIMAL(15,2),
    SUMMA_MP_VNE DECIMAL(15,2),
    SUMMA_OZD_BUD DECIMAL(15,2),
    SUMMA_OZD_VNE DECIMAL(15,2),
    SUMMA_POCH_BUD DECIMAL(15,2),
    SUMMA_POCH_VNE DECIMAL(15,2),
    W_PLACE INTEGER,
    SHIFRKAT INTEGER,
    SHIFRGRU INTEGER,
    TABNO INTEGER,
    FIO VARCHAR(100),
    SHIFRDOLW INTEGER)
AS
declare variable shifrid integer;
declare variable m_vy integer;
begin
   SUMMA_MP_BUD   = 0;
   SUMMA_MP_VNE   = 0;
   SUMMA_OZD_BUD  = 0;
   SUMMA_OZD_VNE  = 0;
   SUMMA_POCH_BUD = 0;
   SUMMA_POCH_VNE = 0;
 --  curr_Mode=2;      -- преподаватели
   -- 1 --
--   if (Curr_mode=1) then
      for
          select person.shifrid,person.tabno,person.shifrgru,person.w_place,person.monthvy,person.fio
                 from person
                 where (person.monthvy=:m or :m=0) and (person.yearvy=:y)
                 into :shifrid,:tabno,:shifrgru,:w_place,:m_vy,:FIO
      do
         begin
              select first 1 shifrkat,shifrdol from pr_get_kat_dolg_person_for_y_m(:tabno,:y,:m_vy)
                     into :ShifrKat,:ShifrdolW;
              if (ShifrDol=ShifrDolW) then
              if (((Curr_Mode=1) and (shifrkat=1)) or
                  ((Curr_Mode=2) and (shifrkat not in (1,4,5))) or
                  ((Curr_Mode=3) and (shifrkat in (4,5)))
                  )        then
              if ((Podr_Mode=1 and w_place not between 151 and 168) or   -- униветситет
                 (Podr_Mode=2 and w_place between 151 and 168) or       -- коледж
                 (Podr_Mode=3))     then                                 -- все
                 begin
              SUMMA_MP_BUD   = 0;
              SUMMA_MP_VNE   = 0;
              SUMMA_OZD_BUD  = 0;
              SUMMA_OZD_VNE  = 0;
              SUMMA_POCH_BUD = 0;
              SUMMA_POCH_VNE = 0;

              select
/*         материальная попмощь            */
                     sum(case
                             when (shifrgru=1 and
                                  (
                                    b.shifrsta=31 or
                                   (b.shifrsta=1 and ((:Podr_mode=1 and w_place in (105,106)) or
                                                      (:Podr_mode=2 and w_place in (158,168))))
                                  )
                                  )
                             then b.summa
                             else 0
                         end),
                     sum(case
                             when (shifrgru<>1 and
                                  (
                                    b.shifrsta=31 or
                                    (b.shifrsta=1 and ((:Podr_Mode=1 and w_place in (105,106)) or
                                                       (:Podr_Mode=2 and w_place in (158,168))))
                                  )
                                  )
                             then b.summa
                             else 0
                         end),
  /* оздоровление */
                     sum(case
                              when (shifrgru=1 and b.shifrsta=20)
                              then b.summa
                              else 0
                          end),
                     sum(case
                             when (shifrgru<>1 and b.shifrsta=20)
                             then b.summa
                             else 0
                         end),
/* почасовая оплата */

                     sum(case
                             when (shifrgru=1 and (w_place in (98,128)
                                                 or (w_place in(8,136) and b.shifrsta=37))   --37 -почасовая оплата
                                  )
                             then b.summa
                             else 0
                        end),
                     sum(case
                             when (shifrgru<>1 and (w_place in (98,128))
                                                 or (w_place in(8,136) and b.shifrsta=37))   --37 -почасовая оплата
                             then b.summa
                             else 0
                         end)
              from fadd b
              where :shifrid=b.shifridperson
              into :SUMMA_MP_BUD  , :SUMMA_MP_VNE  ,
                   :SUMMA_OZD_BUD , :SUMMA_OZD_VNE ,
                   :SUMMA_POCH_BUD,:SUMMA_POCH_VNE;
              if (summa_mp_bud is null)   then summa_mp_bud=0;
              if (summa_mp_vne is null)   then summa_mp_vne=0;
              if (summa_ozd_bud is null)  then summa_ozd_bud=0;
              if (summa_ozd_vne is null)  then summa_ozd_vne=0;
              if (summa_POCH_bud is null) then summa_POCH_bud=0;
              if (summa_POCH_vne is null) then summa_POCH_vne=0;
              if (abs(summa_mp_bud)   > 0.01 or
                  abs(summa_mp_vne)   > 0.01 or
                  abs(summa_ozd_bud)  > 0.01 or
                  abs(summa_ozd_vne)  > 0.01 or
                  abs(summa_poch_bud) > 0.01 or
                  abs(summa_poch_vne) > 0.01
              ) then
              suspend;
           end
        end


  /* Procedure Text */


end^


ALTER PROCEDURE PR_MOV_PFU
AS
declare variable y integer;
declare variable m integer;
begin
     y=2010;
     m=5;
     delete from tb_p04t05b;
     delete from tb_p04t05b_det;
     delete from tb_p04t06b;
     delete from tb_p04t06b_det;
     delete from tb_p04t06b_det_pens;
     delete from tb_p04t07b;
     delete from tb_p04t07b_det;
     delete from tb_p04t07b_det_pens;
     delete from tb_p04t08b;
     insert into tb_p04t05b (yearvy,monthvy,tabno,rownum,numident,fio,nm,ftn,start_dt,end_dt)
            select :y,:m,
                   (select first 1 b.tabno  from kadry b where b.nal_code=a.numident),
             a.rownum,a.numident,a.ln,a.nm,a.ftn,a.start_dt,a.end_dt  from p04t05b a;
     insert into tb_p04t06b (yearvy,monthvy,tabno,rownum,numident,fio,nm,ftn,zo,zic,
                             sum_total,sum_max,sum_ins,otk,exp)
            select :y,:m,
                   (select first 1 b.tabno  from kadry b where b.nal_code=a.numident),
             a.rownum,a.numident,a.ln,a.nm,a.ftn,a.zo,a.zic,
             a.sum_total,a.sum_max,a.sum_ins, a.otk, a.exp  from p04t06b a;
     insert into tb_p04t07b (yearvy,monthvy,tabno,rownum,numident,fio,nm,ftn,zo,zic,
                             pay_mnth,pay_year,pay_tp,
                             sum_total,sum_max,sum_ins,otk,exp)
            select :y,:m,
                   (select first 1 b.tabno  from kadry b where b.nal_code=a.numident),
             a.rownum,a.numident,a.ln,a.nm,a.ftn,a.zo,a.zic,
             a.pay_mnth,a.pay_year,a.pay_tp,
             a.sum_total,a.sum_max,a.sum_ins,a.otk, a.exp  from p04t07b a;
     insert into tb_p04t08b (yearvy,monthvy,tabno,rownum,numident,fio,nm,ftn,c_pid,days,
                             start_dt,end_dt,normz,hh,mm,
                             season,norma)
            select :y,:m,
                   (select first 1 b.tabno  from kadry b where b.nal_code=a.numident),
             a.rownum,a.numident,a.ln,a.nm,a.ftn,a.c_pid,a.days,
             a.start_dt,a.stop_dt,a.normz,a.hh,a.mm,
             a.season,a.norma  from p04t08b a;
  /* Proprcedure Text */
 -- suspend;
end^


ALTER PROCEDURE PR_OTPHELPLIST2011
RETURNS (
    RETVAL INTEGER)
AS
declare variable SHIFRID integer;
declare variable SUMMA decimal(15,2);
declare variable SHIFRGRU integer;
declare variable I integer;
declare variable MONTH_ZA integer;
declare variable DOLG varchar(10);
declare variable SUMMAH1 decimal(15,2);
declare variable SUMMAH2 decimal(15,2);
declare variable SHIFRGRUH1 integer;
declare variable SHIFRGRUH2 integer;
declare variable DATAH1 date;
declare variable DATAH2 date;
declare variable TABNO integer;
declare variable FIO varchar(50);
declare variable SHIFRDOL integer;
declare variable DOLGNAME varchar(10);
declare variable SUMMAO decimal(15,2);
declare variable DATAO date;
declare variable MONTH_ZAO integer;
declare variable DATAOTPFR date;
declare variable DATAOTPTO date;
declare variable DAYOTP integer;
declare variable SHIFRPODH integer;
declare variable SHIFRPODO integer;
declare variable MONTHO integer;
begin
     summah1=0;
     summah2=0;
     shifrgruh1=0;
     shifrgruh2=0;
     delete from tb_otphelplist2011;
     select count(*) from tb_otphelplist2011 into i;
     i=0;
     retval=0;
     for
        select b.tabno,b.fio,a.summa,a.month_za,b.shifrgru,b.dolg,b.shifrid,b.w_place from fadd a
               join person b on b.shifrid=a.shifridperson
               where b.yearvy=2010
                 and a.shifrsta=20
               into :tabno,:fio,:summa,:month_za,:shifrgru,:dolg,:shifrid,:shifrpodh
     do
       begin
             shifrdol=0;
             select first 1 g.prim from fcn g
                             where g.shifridperson=:shifrid
                               and g.shifrsta=(100+500)
                               and g.kod=100
                             into :shifrdol;
             shifrdol=coalesce(shifrdol,0);
             select count(*) from fadd z
                             where z.tabno=:tabno
                               and z.year_vy=2011
                               and z.shifrsta in (5,6)
                               and z.shifrgru=:shifrgru
                             into :i;
             month_zao = 0;
             summao    = 0;
             shifrpodo = 0;
             if (i>0) then
             select first 1  z.month_za, z.summa,z.w_place,z.month_vy from fadd z
                                 where z.tabno=:tabno
                                   and z.year_vy=2011
                                   and z.shifrsta in (5,6)
                                   and z.shifrgru=:shifrgru
                                 order by z.summa desc
                                 into :month_zao,:summao,:shifrpodo,:montho;
             month_zao=coalesce(month_zao, 0);
             summao=coalesce(summao,0);
             if (month_zao between 1 and 12) then
                datao='2011-'||month_zao||'-01';
             else
                datao='1900-01-01';


             if (not exists (select * from tb_otphelplist2011 f where f.tabno=:tabno)) then
              begin
                   summah1    = summa;
                   shifrgruh1 = shifrgru;
                   datah1     = '2010-'||:month_za||'-01';
                   if (tabno=1356) then
                      i=i;
                   dataotpfr = null;
                   dataotpto = null;
                   dayotp    = null;

                   select count(*) from otpuska y
                                   where y.tabno=:tabno
                                     and (y.data_pere_bud > '2011-02-01' or
                                          y.data_pere_vne > '2011-02-01' or
                                          y.data_pere_gn  > '2011-02-01' or
                                          y.data_pere_nis > '2011-02-01' or
                                          y.data_pere     > '2011-02-01')
                                     and :datao between cast((extract(year from y.f_data)||'-'||extract(month from y.f_data)||'-01') as date) and y.l_data
                                   into :i;
                   if (i>0) then
                   select first 1 y.f_data,y.l_data,y.itogo_o_day from otpuska y
                                                          where y.tabno=:tabno
                                                          and (y.data_pere_bud > '2011-02-01' or
                                                               y.data_pere_vne > '2011-02-01' or
                                                               y.data_pere_gn  > '2011-02-01' or
                                                               y.data_pere_nis > '2011-02-01' or
                                                               y.data_pere     > '2011-02-01')
                                                          and :datao between cast((extract(year from y.f_data)||'-'||extract(month from y.f_data)||'-01') as date) and y.l_data
                                                          into :dataotpfr,:dataotpto,:dayotp;
                   if (dataotpfr is null) then
                   select first 1 y.f_data,y.l_data,y.itogo_o_day from otpuska y
                                                          where y.tabno=:tabno
                                                          and :datao between cast((extract(year from y.f_data)||'-'||extract(month from y.f_data)||'-01') as date) and y.l_data
                                                          into :dataotpfr,:dataotpto,:dayotp;
                 --  dataotpfr=coalesce(data)
                   insert into tb_otphelplist2011
                               (TABNO        , FIO        , SHIFRDOL ,  DOLGNAME   ,
                                SUMMAH1      , SHIFRGRUH1 , DATAH1   ,  SHIFRPODH1 ,
                                SUMMAH2      , SHIFRGRUH2 , DATAH2   ,  SHIFRPODH2 ,
                                SUMMAOTP1    , SHIFRGRUO1 , DATAO1   ,  SHIFRPODO1 , MONTHO1,
                                SUMMAOTP2    , SHIFRGRUO2 , DATAO2   ,  SHIFRPODO2 , MONTHO2,
                                SUMMAPRE1    , SUMMAPRE2  ,
                                dataotpfr    , dataotpto  , dayotp)
                          values (:tabno     , :fio,  :shifrdol,  :dolg,
                                  :summa     , :shifrgru  , :datah1     , :shifrpodh,
                                  0          , 0          , '1900-01-01', 0         ,
                                  :summao    , :shifrgru  , :datao      , :shifrpodo, :montho,
                                  0          , 0          , '1900-01-01', 0         , 0,
                                  0          , 0          ,
                                  :dataotpfr , :dataotpto , :dayotp);
                   retval=retval+1;

              end
                    else
              begin
                   summah2    = summa;
                   shifrgruh2 = shifrgru;
                   datah2     = '2010-'||:month_za||'-01';
                   update tb_otphelplist2011 e
                     set e.summah2    = :summa,
                         e.shifrgruh2 = :shifrgru,
                         e.datah2     = :datah2,
                         e.shifrpodh2 = :shifrpodh, 
                         e.summaotp2  = :summao, 
                         e.datao2     = :datao ,
                         e.shifrpodo2 = :shifrpodo,
                         e.montho2    = :montho
                     where e.tabno=:tabno;
              end

       end
    update tb_otphelplist2011 
          set summapre1=coalesce(summah1,0) / 355 * coalesce(dayotp,0),
              summapre2=coalesce(summah2,0) / 355 * coalesce(dayotp,0)
          where coalesce(dayotp,0)>0;
    suspend;


   /*

select a.tabno, a.fio, a.dolgname,
       a.summah1,
       case
           when a.shifrgruh1=1 then 'Бюджет'
           else 'Внебюджет'
       end,
       a.datah1,a.shifrpodh1,
       a.summah2,
       case
           when summah2<0.01 then ' '
           else
               case
                   when a.shifrgruh2=1 then 'Бюджет'
                   else 'Внебюджет'
               end
       end,
       a.datah2,a.shifrpodh2,
       a.dataotpfr,a.dataotpto,a.dayotp,
       a.summaotp1,
       case
           when a.shifrgruh1=1 then 'Бюджет'
           else 'Внебюджет'
       end,
       a.datao1,a.shifrpodo1,
       a.summaotp2,
       case
           when a.summaotp2<0.01 then ' '
           else
               case
                   when a.shifrgruh2=1 then 'Бюджет'
                   else 'Внебюджет'
               end
       end,
       a.datao2,a.shifrpodo2,
       a.summapre1,
       a.summapre2



 from tb_otphelplist2011 a
         where (a.summaotp1>0.01 or
                a.summaotp2>0.01) and
               (a.summapre1>0.01 or a.summapre2>0.01) and
               (a.summapre1>-0.001) and
               (a.summapre2>-0.001)
         order by a.shifrpodo1,a.fio

   */
end^


ALTER PROCEDURE PR_P4_CVT_4_5_TO_9 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable tabno integer;
declare variable wy integer;
declare variable wm integer;
declare variable exp integer;
declare variable i integer;
declare variable summa_4 decimal(15,2);
declare variable summa_5 decimal(15,2);
declare variable summa_ins_4 decimal(15,2);
declare variable summa_ins_5 decimal(15,2);
declare variable summa_max_4 decimal(15,2);
declare variable summa_max_5 decimal(15,2);
declare variable nal_code varchar(10);
declare variable fam varchar(100);
declare variable nam varchar(100);
declare variable otc varchar(100);
declare variable zo integer;
declare variable zic integer;
declare variable otk integer;
begin
     retval=0;
     for
        select a.tabno,a.numident,a.fio,a.nm,a.ftn,
               a.zo,a.zic,a.pay_mnth,a.pay_year,
               a.sum_total,a.sum_max,a.sum_ins,
               a.otk,a.exp  from tb_p04t07b a
               where a.yearvy=:y
               and a.monthvy=:m
               and a.pay_tp=4
            --   and a.tabno=5018
               into :tabno,:nal_code,:fam,:nam,:otc,
               :zo,:zic,:wm,:wy, 
               :summa_4,:summa_max_4,:summa_ins_4,
               :otk,:exp
     do
       begin
            tabno=coalesce(tabno,0);
            if (not (exists (select * from tb_p04t07b b
                               where (b.tabno=:tabno or
                                      trim(b.numident)=trim(:nal_code)
                                     )
                               and b.yearvy=:y
                               and b.monthvy=:m
                               and b.pay_year=:wy
                               and b.pay_mnth=:wm
                               and b.pay_tp=9
                               and b.exp=:exp))) then
               insert into tb_p04t07b (tabno,yearvy,monthvy,numident,fio,nm,ftn,
                           zo,zic, pay_year,pay_mnth,pay_tp,otk,exp,
                           sum_total,sum_max,sum_ins)  values (
                           :tabno, 
                           :y,:m,:nal_code,:fam,:nam,:otc,
                           :zo,:zic,:wy, :wm, 9, :otk, :exp,
                           0,0,0);
               update tb_p04t07b c set
                      c.sum_total=c.sum_total+:summa_4,
                      c.sum_max=c.sum_max+:summa_max_4,
                      c.sum_ins=c.sum_ins+:summa_ins_4
                      where c.tabno=:tabno
                      and c.numident=:nal_code
                      and c.pay_tp=9
                      and c.pay_year=:wy
                      and c.pay_mnth=:wm
                      and c.exp=:exp;
       end

     for
        select a.tabno,a.numident,a.fio,a.nm,a.ftn,
               a.zo,a.zic,a.pay_mnth,a.pay_year,
               a.sum_total,a.sum_max,a.sum_ins,
               a.otk,a.exp  from tb_p04t07b a
               where a.yearvy=:y
               and a.monthvy=:m
               and a.pay_tp=5
               into :tabno,:nal_code,:fam,:nam,:otc,
               :zo,:zic,:wm,:wy, 
               :summa_5,:summa_max_5,:summa_ins_5,
               :otk,:exp
     do
       begin
            tabno=coalesce(tabno,0);
            if (not (exists (select * from tb_p04t07b b
                               where (b.tabno=:tabno or
                                      trim(b.numident)=trim(:nal_code)
                                     )
                               and b.yearvy=:y
                               and b.monthvy=:m
                               and b.pay_year=:wy
                               and b.pay_mnth=:wm
                               and b.pay_tp=9
                               and b.exp=:exp))) then
               insert into tb_p04t07b (tabno,yearvy,monthvy,numident,fio,nm,ftn,
                           zo,zic, pay_year,pay_mnth,pay_tp,otk,exp,
                           sum_total,sum_max,sum_ins)  values (
                           :tabno,
                           :y,:m,:nal_code,:fam,:nam,:otc,
                           :zo,:zic,:wy, :wm, 9, :otk, :exp,
                           0,0,0);
               update tb_p04t07b c set
                      c.sum_total=c.sum_total-:summa_5,
                      c.sum_max=c.sum_max-:summa_max_5,
                      c.sum_ins=c.sum_ins-:summa_ins_5
                      where c.tabno=:tabno
                      and c.numident=:nal_code
                      and c.pay_tp=9
                      and c.pay_year=:wy
                      and c.pay_mnth=:wm
                      and c.exp=:exp;
       end

     for
         select a.tabno,a.exp,a.sum_ins from tb_p04t07b a
                where a.yearvy=:y
                and a.monthvy=:m
                and a.pay_tp in (9)
                and abs(a.sum_ins)>0.005
                into :tabno,:exp, :summa_ins_4
     do
       begin
            retval=retval+1;
            if (exists (select * from tb_p04t06b a
                               where a.tabno=:tabno
                               and a.yearvy=:y
                               and a.monthvy=:m
                               and a.exp=:exp)) then
               update tb_p04t06b a
                      set a.sum_ins=a.sum_ins+:summa_ins_4
                       where a.tabno=:tabno
                             and a.yearvy=:y
                             and a.monthvy=:m
                             and a.exp=:exp;
            else
             begin
                  select first 1 c.numident,c.fio,c.nm,c.ftn,c.zo,c.zic,c.otk from tb_p04t07b c
                         where c.yearvy=:y
                         and c.monthvy=:m
                         and c.tabno=:tabno
                         and c.pay_tp in (9)
                         into :nal_code,:fam,:nam,:otc,:zo,:zic, :otk;
                  insert into tb_p04t06b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                          sum_total,sum_max,sum_ins,
                                          zo,zic,otk,exp)
                                  values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                         0,0,:summa_ins_4,
                                         :zo,:zic,:otk,:exp);
             end
       end
     update tb_p04t07b a
           set a.sum_ins=0
           where a.pay_tp = 9
           and a.yearvy   = :y
           and a.monthvy  = :m;
     delete from tb_p04t07b e where e.yearvy=:y and e.monthvy=:m and e.pay_tp in (4,5);

   suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_P4_CVT_5_TO_9 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable tabno integer;
declare variable wy integer;
declare variable wm integer;
declare variable exp integer;
declare variable i integer;
declare variable summa_4 decimal(15,2);
declare variable summa_5 decimal(15,2);
declare variable summa_ins_4 decimal(15,2);
declare variable summa_ins_5 decimal(15,2);
declare variable summa_max_4 decimal(15,2);
declare variable summa_max_5 decimal(15,2);
declare variable nal_code varchar(10);
declare variable fam varchar(100);
declare variable nam varchar(100);
declare variable otc varchar(100);
declare variable zo integer;
declare variable zic integer;
declare variable otk integer;
begin
     retval=0;
     update tb_p04t07b a
           set a.pay_tp   = 9
           where a.pay_tp = 4
           and a.yearvy   = :y
           and a.monthvy  = :m;
     for
         select a.tabno,a.exp,a.sum_ins from tb_p04t07b a
                where a.yearvy=:y
                and a.monthvy=:m
                and a.pay_tp in (9)
                and a.sum_ins>0.005
                into :tabno,:exp, :summa_ins_4
     do
       begin
            retval=retval+1;
            if (exists (select * from tb_p04t06b a
                               where a.tabno=:tabno
                               and a.yearvy=:y
                               and a.monthvy=:m
                               and a.exp=:exp)) then
               update tb_p04t06b a
                      set a.sum_ins=a.sum_ins+:summa_ins_4
                       where a.tabno=:tabno
                             and a.yearvy=:y
                             and a.monthvy=:m
                             and a.exp=:exp;
            else
             begin
                  select first 1 c.numident,c.fio,c.nm,c.ftn,c.zo,c.zic,c.otk from tb_p04t07b c
                         where c.yearvy=:y
                         and c.monthvy=:m
                         and c.tabno=:tabno
                         and c.pay_tp in (9)
                         into :nal_code,:fam,:nam,:otc,:zo,:zic, :otk;
                  insert into tb_p04t06b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                          sum_total,sum_max,sum_ins,
                                          zo,zic,otk,exp)
                                  values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                         0,0,:summa_ins_4,
                                         :zo,:zic,:otk,:exp);
             end
       end
     update tb_p04t07b a
           set a.sum_ins=0
           where a.pay_tp = 9
           and a.yearvy   = :y
           and a.monthvy  = :m;

   suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_P4_LINK_4_5 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable tabno integer;
declare variable wy integer;
declare variable wm integer;
declare variable exp integer;
declare variable i integer;
declare variable summa_4 decimal(15,2);
declare variable summa_5 decimal(15,2);
declare variable summa_ins_4 decimal(15,2);
declare variable summa_ins_5 decimal(15,2);
declare variable summa_max_4 decimal(15,2);
declare variable summa_max_5 decimal(15,2);
declare variable nal_code varchar(10);
declare variable fam varchar(100);
declare variable nam varchar(100);
declare variable otc varchar(100);
declare variable zo integer;
declare variable zic integer;
declare variable otk integer;
begin
     retval=0;
     for
         select a.tabno,a.exp,a.pay_year,a.pay_mnth,count(*) from tb_p04t07b a
                where a.yearvy=:y
                and a.monthvy=:m
--                and a.tabno=29
                and a.pay_tp in (4,5)
                group by 1,2,3,4
                having count(*)>1
                into :tabno,:exp, :wy,:wm, :i
     do
       begin
            retval=retval+1;
            select first 1 c.numident,c.fio,c.nm,c.ftn,c.zo,c.zic,c.otk from tb_p04t07b c
                where c.yearvy=:y
                and c.monthvy=:m
                and c.tabno=:tabno
                and c.pay_tp in (4,5)
                into :nal_code,:fam,:nam,:otc,:zo,:zic, :otk;

            summa_4=0;
            summa_5=0;
            summa_ins_5=0;
            summa_ins_4=0;
            summa_max_4=0;
            summa_max_5=0;
            select sum(case
                           when a.pay_tp=5 then -a.sum_total
                           else a.sum_total
                       end   ),
                   sum(case
                           when a.pay_tp=5 then -a.sum_ins
                           else a.sum_ins
                       end  )  from tb_p04t07b a
                   where a.tabno=:tabno
                         and a.yearvy=:y
                         and a.monthvy=:m
                         and a.pay_mnth=:wm
                         and a.pay_year=:wy
                         and a.exp=:exp
                         and a.pay_tp in (4,5)
                      into :summa_5,:summa_ins_5;

                  summa_5     = coalesce(summa_5,0);
                  summa_ins_5 = coalesce(summa_ins_5,0);

                  delete from tb_p04t07b e
                         where e.tabno=:tabno
                            and e.yearvy=:y
                            and e.monthvy=:m
                            and e.pay_mnth=:wm
                            and e.pay_year=:wy
                            and e.exp=:exp
                            and e.pay_tp in (4,5);

                  if (summa_5>0.005) then
                     begin
                          summa_4=summa_5;
                          summa_5=0;
                     end
                  else
                     begin
                          summa_5=-summa_5;
                          summa_4=0;
                     end
                  if (summa_ins_5>0.005) then
                     begin
                          summa_ins_4=summa_ins_5;
                          summa_ins_5=0;
                     end
                  else
                     begin
                          summa_ins_5=-summa_ins_5;
                          summa_ins_4=0;
                     end
                  if ((summa_4>0.005)or (summa_ins_4>0.005))  then
                     insert into tb_p04t07b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                             pay_mnth,pay_year,pay_tp,
                                             sum_total,sum_max,sum_ins,
                                             zo,zic,otk,exp)
                                             values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :wm, :wy, 4,
                                                    :summa_4,0,:summa_ins_4,
                                                    :zo,:zic,:otk,:exp);
                  if ((summa_5>0.005)or (summa_ins_5>0.005))  then
                     insert into tb_p04t07b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                             pay_mnth,pay_year,pay_tp,
                                             sum_total,sum_max,sum_ins,
                                             zo,zic,otk,exp)
                                             values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :wm, :wy, 5,
                                                    :summa_5,0,:summa_ins_5,
                                                    :zo,:zic,:otk,:exp);
       end

   suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_P4_PERSON (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable IDPERSON integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable IDADD integer;
declare variable IDUD integer;
declare variable IDMST integer;
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable SUMMA_M decimal(15,2);
declare variable OTK integer;
declare variable DATEC date;
declare variable P decimal(15,2);
declare variable INVALID integer;
declare variable ZO integer;
declare variable ZIC integer;
declare variable MUSOR integer;
declare variable ISRCNZNT integer;
declare variable DAYS integer;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable SUMMAPENSRAS decimal(15,2);
declare variable MODEREC integer; /* режим записи */
declare variable I_COUNT_7_1 integer;
declare variable I_COUNT_7_2 integer;
declare variable I_COUNT_7_3 integer;
declare variable I_COUNT_7_4 integer;
declare variable I_COUNT_7_5 integer;
declare variable I_COUNT_6 integer;
declare variable IDMST_7_1 integer;
declare variable IDMST_7_2 integer;
declare variable IDMST_7_3 integer;
declare variable IDMST_7_4 integer;
declare variable IDMST_7_5 integer;
declare variable IDMST7 integer;
declare variable DT date;
declare variable SHIFRNF integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable SUMMA_5 decimal(15,2);
declare variable SUMMA_INS_5 decimal(15,2);
declare variable SUMMA_4 decimal(15,2);
declare variable SUMMA_INS_4 decimal(15,2);
declare variable EXP decimal(15,2);
declare variable START_DT_1 integer;
declare variable END_DT_1 integer;
declare variable SUMMA_MAX_4 decimal(15,2);
declare variable SUMMA_MAX_5 decimal(15,2);
declare variable CNT integer;
begin
     musor=gen_id(G_TEST,1);
     I_count     = 0;
     i_count_6   = 0;
     i_count_7_1 = 0;
     i_count_7_2 = 0;
     i_count_7_3 = 0;
     i_count_7_4 = 0;
     i_count_7_5 = 0;
     idmst       = 0;
     shifrnf  = 0;    -- нумерация не найденых
     delete from tb_tmp_t07;
     delete from tb_tmp_p4t7;
     -- параметры абонента
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u=null;
             name_u=null;
             fath_u=null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
         fcn.month_vy=:m            and
         fcn.year_vy=:y             and
         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=1;
     zic=1;
     if (invalid=1) then
        begin
             zo=2;
             zic=2;
        end


     for
        select fadd.summa,  fadd.shifrkat,fadd.shifrgru,
               fadd.W_PLACE,fadd.W_R,     fadd.shifrsta,fadd.Month_Za,
               fadd.year_za,fadd.month_vy,fadd.year_vy ,fadd.vypl,
               FADD.shifrid, fadd.shifridperson,
               case
                   when (fadd.shifrsta in (5,6,10,11)) then 3  -- отпускные
                   when (fadd.shifrsta in (12))    then 1  -- 5 дней
                   when (fadd.shifrsta in (14,15)) then 2  -- больничные
                   when ((fadd.month_za)<>:m or (fadd.year_za<>:y)) then
                        case
                             when fadd.summa<-0.005 then 5         -- для перерасчетов с отрицательной суммой
                             else 4   -- перерасчеты с положительной суммой
                        end
                   else 0
               end
                from fadd
               join shifr on fadd.shifrsta=shifr.shifr
               where fadd.tabno=:tabno and
                     fadd.month_vy=:m  and
                     fadd.year_vy=:y   and
          --           fadd.year_za=:y   and
          --           fadd.month_za=:m  and
          --           fadd.shifrsta not in (31,32,7,44) and            -- материальную помощь не включать
                     fadd.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                                      -- декретный больничеый не включать
                                                                      -- пособие до 3-х лет
                                                                      -- внесено в кассу
                     fadd.w_place not in (106,165) and                -- 106 материальная помощь подразделение пособие до 3-х лет
    --                 not (fadd.shifrsta in (5,6,10,11) and fadd.month_za<>:m ) and                      -- отпусные
    --                 not (fadd.shifrsta in (12,14,15) and fadd.month_za<>:m) and                      -- больничные
--                     ((fadd.shifrsta<>16 and fadd.w_place not between 151 and 168) or -- перечитка нодочитка
                     ((fadd.shifrsta<>16) or -- перечитка нодочитка
                      (fadd.shifrsta=16  and fadd.w_place between 151 and 168)) and
                     shifr.pens=1
                     and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                           -- все
                          (:WantedKat=1 and (select first 1 retval from pr_is_sciped(fadd.shifridperson,0)) =1) or    -- ППС
                          (:WantedKat=2 and (select first 1 retval from pr_is_sciped(fadd.shifridperson,0)) =0 ))     -- не ППС
               into :summa,:shifrkat,:shifrgru,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl,:idadd,
                        :idperson,:moderec
            do
              begin
                    i_count=i_count+1;
                    if (moderec=1) then i_count_7_1=i_count_7_1+1;
                    else
                    if (moderec=2) then i_count_7_2=i_count_7_2+1;
                    else
                    if (moderec=3) then i_count_7_3=i_count_7_3+1;
                    else
                    if (moderec=4) then i_count_7_4=i_count_7_4+1;
                    else
                    if (moderec=5) then i_count_7_5=i_count_7_5+1;
                    else
                        i_count_6=i_count_6+1;
                    if ((i_count_6=1) and (moderec=0)) then
                       begin
                            idmst=gen_id(g_p04t06b, 1);
                            insert into tb_p04t06b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,zo,zic,otk,exp)
                                   values(:idmst, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,:zo,:zic,:otk,0);
                       end
                    else
                      if (moderec in (1,2,3,4,5)) then
                        begin
                              idmst7=0;
                              select first 1 a.shifridmst   from tb_tmp_t07 a where a.mode=:moderec   and
                                                             a.yearza=:year_za and
                                                             a.monthza=:month_za
                                                    into :idmst7;
                              if ((idmst7 is null) or (idmst7=0)) then
                                 begin
                                      idmst7=gen_id(g_p04t07b, 1);
                                      insert into tb_tmp_t07 (MODE,SHIFRIDMST,YEARZA,MONTHZA)
                                             values (:moderec,:idmst7,:year_za,:month_za);
                                      insert into tb_p04t07b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                                  pay_mnth,pay_year,pay_tp,
                                                  sum_total,sum_max,sum_ins,
                                                  zo,zic,otk,exp)
                                             values(:idmst7, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :month_za, :year_za, :moderec,
                                                    0,0,0,
                                                    :zo,:zic,:otk,0);
                                 end
                        end

                    Marked  = 1;
                    if (moderec=0) then
                       insert into tb_p04t06b_det (shifridmst,SHIFRIDPERSON,SHIFRIDADD,
                                   tabno, w_place,w_r,shifrgru,shifrkat,shifrsta,month_za,year_za,
                                    month_vy, year_vy,summa,vypl,marked)
                               values (:idmst,:idperson,:idadd,
                                    :tabno,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked);
                    else
                    if (moderec in (1,2,3,4,5)) then
                       begin
                              select first 1 a.shifridmst   from tb_tmp_t07 a where a.mode=:moderec  and
                                                             a.yearza=:year_za and
                                                             a.monthza=:month_za
                                                    into :idmst7;
                              if (idmst7 is null) then
                                 exception e_p07;
                              insert into tb_p04t07b_det (shifridmst,SHIFRIDPERSON,SHIFRIDADD,
                                   tabno, w_place,w_r,shifrgru,shifrkat,shifrsta,month_za,year_za,
                                    month_vy, year_vy,summa,vypl,marked)
                               values (:idmst7,:idperson,:idadd,
                                    :tabno,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked);
                       end
              end   -- Конец цикла по статьям
            select sum(summa) from tb_p04t06b_det
                   where tb_p04t06b_det.shifridmst=:idmst and
                   tb_p04t06b_det.marked=1
                   into summa;
            summa_m=summa;

            DateC=y||'-'||m||'-10';
            select first 1 summalimita from PR_GET_LIMIT_FOR_PENS(:DateC) into :p;
/*
            select first 1 a.limitpens from penshea a
                           where a.datefr<:DateC
                           order by a.datefr desc
                           into :p;
*/
            if (summa_m>p) then
               summa_m=p;
            update tb_p04t06b set
                sum_total = :summa,
                sum_max   = :summa_m
                where shifrid=:idmst;




            for
               select a.mode,a.shifridmst,a.yearza,a.monthza from tb_tmp_t07 a
                      into :moderec, :idmst7, :year_za,:month_za
            do
               begin
                     select sum(summa) from tb_p04t07b_det
                            where tb_p04t07b_det.shifridmst=:idmst7 and
                                  tb_p04t07b_det.marked=1
                            into summa;
                      select first 1 pay_tp from tb_p04t07b where shifrid=:idmst7 into :moderec;
                      if (moderec=5) then
                      if (summa<-0.005) then
                         summa=-summa;
                      summa_m=summa;
                      if (summa_m>p) then
                          summa_m=p;
                      update tb_p04t07b set
                             sum_total = :summa,
                             sum_max   = :summa_m
                             where shifrid=:idmst7;
               end






       --     Взносы в пенсионный фонд -------
       --     Таблица 6                -------
            select sum(fud.summa) from fud
                   where fud.year_vy=:y
                         and fud.month_vy=:m
                         and fud.year_za=:y
                         and fud.month_za=:m
                         and fud.tabno=:tabno
                         and fud.shifrsta in (75)
                         and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                     -- все
                              (:WantedKat=1 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =1) or  -- ППС
                              (:WantedKat=2 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =0))   -- не ППС
                   into :SummaPensRas;
            if ((SummaPensRas is not null) and (abs(:SummaPensRas)>0.005)) then
               begin
                    if (not exists (select * from tb_p04t06b where shifrid=:idmst)) then
                       begin
                            if (idmst=0) then
                               begin
                                     idmst=gen_id(g_p04t06b, 1);
                                     insert into tb_p04t06b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,zo,zic,sum_total,sum_max,sum_ins,otk,exp)
                                            values(:idmst, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,:zo,:zic,0,0,0,:otk,0);
                               end
                            else
                               exception e_p07 'нет нач-й 6 '||:tabno||' idmst='||:idmst;
                       end
                    update tb_p04t06b set
                           sum_ins   = :SummaPensRas
                           where shifrid=:idmst;
               end
       --     Таблица 7  -------


          for
            select fud.year_za, fud.month_za,sum(fud.summa) from fud
                   where fud.year_vy=:y
                         and fud.month_vy=:m
                         and (fud.year_za<>:y
                              or fud.month_za<>:m)
                         and fud.tabno=:tabno
                         and fud.shifrsta in (75)
                         and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                     -- все
                              (:WantedKat=1 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =1) or  -- ППС
                              (:WantedKat=2 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =0))   -- не ППС
                   group by 1,2
                   into :year_za,:month_za,:SummaPensRas
          do
            if ((summapensras is not null) and (abs(summapensras)>0.005)) then
             begin
                   idmst7=0;

                   if (summapensras<-0.005) then
                      begin
                           SummaPensRas=-SummaPensRas;
                           select first 1 a.shifridmst from tb_tmp_t07 a
                                  where monthza=:month_za and
                                        yearza=:year_za   and
                                        mode=5
                                  into :idmst7;
                           if ((idmst7 is not null) and (idmst7>0)) then
                              update tb_p04t07b set
                                     sum_ins   = :SummaPensRas
                                     where shifrid=:idmst7;
                           else
                              begin
                                   idmst7=gen_id(g_p04t07b, 1);
                                   insert into tb_tmp_t07 (MODE,SHIFRIDMST,YEARZA,MONTHZA)
                                          values (5,:idmst7,:year_za,:month_za);

                                   insert into tb_p04t07b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                                  pay_mnth,pay_year,pay_tp,
                                                  sum_total,sum_max,sum_ins,
                                                  zo,zic,otk,exp)
                                             values(:idmst7, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :month_za, :year_za, 5,
                                                    0,0,:SummaPensRas,
                                                    :zo,:zic,:otk,0);
                              end
                      end
                   else
                      begin
                          -- проверить отпускные
                           select first 1 a.shifridmst from tb_tmp_t07 a
                                  where monthza=:month_za and
                                        yearza=:year_za   and
                                        mode=3
                                  into :idmst7;
                          -- проверить др перерасчеты с 4-м кодом
                          -- за этот период
                           if (idmst7 is not null) then
                               begin
                                     select count(*) from tb_tmp_t07 a
                                            where monthza=:month_za and
                                                  yearza=:year_za   and
                                                  mode=4
                                            into :cnt;
                                     if (cnt>0) then  idmst7=null;
                               end
                           if (idmst7 is not null) then
                              begin
                                   -- это отпускные - записать в табл 6
                                   if (not exists (select * from tb_p04t06b where shifrid=:idmst)) then
                                      begin
                                           if (idmst=0) then
                                               begin
                                                    idmst=gen_id(g_p04t06b, 1);
                                                    insert into tb_p04t06b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,zo,zic,sum_total,sum_max,sum_ins,otk,exp)
                                                           values(:idmst, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,:zo,:zic,0,0,0,:otk,0);
                                               end
                                           else
                                               exception e_p07 'нет нач-й 6 '||:tabno||' idmst='||:idmst;
                                      end
                                   update tb_p04t06b set
                                       sum_ins   = sum_ins+:SummaPensRas
                                   where shifrid=:idmst;
                              end
                           else
                              begin
                          -- проверить перерасчет а не отпускные
                                    select first 1 a.shifridmst from tb_tmp_t07 a
                                           where monthza=:month_za and
                                                 yearza=:year_za   and
                                                 mode=4
                                           into :idmst7;
                                    if ((idmst7 is not null) and (idmst7>0)) then
                                       update tb_p04t07b set
                                              sum_ins   = :SummaPensRas
                                              where shifrid=:idmst7;
                                    else
                                        begin
                                             idmst7=gen_id(g_p04t07b, 1);
                                             insert into tb_tmp_t07 (MODE,SHIFRIDMST,YEARZA,MONTHZA)
                                                    values (4,:idmst7,:year_za,:month_za);
                                             insert into tb_p04t07b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                                                     pay_mnth,pay_year,pay_tp,
                                                                     sum_total,sum_max,sum_ins,
                                                                     zo,zic,otk,exp)
                                                     values(:idmst7, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                            :month_za, :year_za, 4,
                                                             0,0,:SummaPensRas,
                                                            :zo,:zic,:otk,0);
                                        end
                              end
                      end

/*
                   select first 1 a.shifridmst,a.mode from tb_tmp_t07 a
                          where monthza=:month_za and yearza=:year_za
                          order by a.mode --desc
                          into :idmst7,:moderec;
                   if ((idmst7 is null) or (idmst7=0) or ((summapensras>0.005) and (moderec=5))
                                                      or ((summapensras<0.005) and (moderec<>5))) then
                      begin
                           moderec=4;
                           if (summapensras<-0.005) then
                              begin
                                    summapensras=-summapensras;
                                    moderec=5;
                              end
                           idmst7=gen_id(g_p04t07b,1);
                           insert into tb_p04t07b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                                  pay_mnth,pay_year,pay_tp,
                                                  sum_total,sum_max,sum_ins,
                                                  zo,zic,otk,exp)
                                  values(:idmst7, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                         :month_za, :year_za, :moderec,
                                         0,0,:summapensras,
                                         :zo,:zic,:otk,0);
                      end
                   else
                      begin
          --                  if (SummaPensRas<-0.005) then
          --                      select first 1 pay_tp from tb_p04t07b where shifrid=:idmst7 order by pay_tp desc into :moderec;
          --                  else
          --                      select first 1 pay_tp from tb_p04t07b where shifrid=:idmst7 order by pay_tp into :moderec;
                            if (moderec=5) then
                            if (SummaPensRas<-0.005) then
                               SummaPensRas=-SummaPensRas;
                            update tb_p04t07b set
                                   sum_ins   = :SummaPensRas
                                   where shifrid=:idmst7;
                      end
*/
             end


       /* Определить научных работников (научный стаж) */
    --   if (idmst is not null) then
       if ((WantedKat=0) or (WantedKat=1) ) then
          begin
                musor=0;
                select first 1 fadd.month_za from fadd
                       where fadd.tabno=:tabno and
                             fadd.year_vy=:y   and
                             fadd.month_vy=:m  and
                             fadd.shifrsta not in (31,32)    -- материальную помощь не включать
                             and ((select first 1 retval from pr_is_sciped(fadd.shifridperson,0))=1 or :Forced_Mode=1)    -- ППС
                             and fadd.w_place not in (81,76,105,106,121,140,165)
                             and fadd.summa>0.01
                       group by 1
                       order by 1 desc
                       into :musor;
                if (musor>0) then
                   begin
                         IsRcnznt=0;
                         if (exists (select * from person
                                      where person.yearvy=:y    and
                                            person.monthvy=:m   and
                                            person.tabno=:tabno and
                                            person.w_place=121)) then
                            IsRcnznt=1;
                         if (IsRcnznt=0) then
                            begin
                                  if (idmst>0) then
                                      update tb_p04t06b
                                             set exp=1
                                             where shifrid=:idmst;
                                  if (idmst_7_1>0) then
                                      update tb_p04t07b
                                             set exp=1
                                             where shifrid=:idmst_7_1;
                                  if (idmst_7_2>0) then
                                      update tb_p04t07b
                                             set exp=1
                                             where shifrid=:idmst_7_2;
                                  if (idmst_7_3>0) then
                                      update tb_p04t07b
                                             set exp=1
                                             where shifrid=:idmst_7_3;
                                  if (idmst_7_4>0) then
                                      update tb_p04t07b
                                             set exp=1
                                             where shifrid=:idmst_7_4;
                                  if (idmst_7_5>0) then
                                      update tb_p04t07b
                                             set exp=1
                                             where shifrid=:idmst_7_5;
                                  start_dt=1;
                                  dt=:y||'-'||:m||'-01';
                                  select first 1 l from lenmonth(:dt) into end_dt;
                                  -- Для тех, кто есть в табл 5 проверить даты

                                  if (exists (select * from tb_p04t05b
                                               where tb_p04t05b.tabno=:tabno
                                               and tb_p04t05b.yearvy=:y
                                               and tb_p04t05b.monthvy=:m)
                                      ) then
                                      begin
                                           select first 1  tb_p04t05b.start_dt,tb_p04t05b.end_dt from tb_p04t05b
                                                  where tb_p04t05b.tabno=:tabno
                                                  and tb_p04t05b.yearvy=:y
                                                  and tb_p04t05b.monthvy=:m
                                                  into :start_dt_1,:end_dt_1;
                                           start_dt_1 = coalesce(start_dt_1,0);
                                           end_dt_1   = coalesce(end_dt_1,0);
                                           if (start_dt_1>0) then
                                               start_dt=start_dt_1;
                                           if (end_dt_1>0) then
                                               end_dt=end_dt_1;
                                      end

                                  days=end_dt-start_dt+1;
                                  insert into tb_p04t08b (yearvy,monthvy,numident,tabno, 
                                                          fio, nm, ftn,c_pid,
                                                          days,start_dt, end_dt,season)
                                         values (:y, :m, :nal_code, :tabno, 
                                                 :fam, :nam,:otc, 'ЗНТ024А1',
                                                 :days, :start_dt,:end_dt,1);

                            end
                   end

          end
       execute procedure PR_P6_REMAKE(:y, :m) returning_values (:summa,:musor);








/* Корректировки EXP в табл 7*/
       exp=0;
       for
          select shifrid from tb_p04t07b
                 where yearvy=:y and monthvy=:m and tabno=:tabno
                 into :i
       do
          begin
                if ((exists (select * from tb_p04t08b
                                    where tabno=:tabno
                                     and yearvy=:y
                                     and monthvy=:m)) and
                   not (exists (select * from tb_prep_uwp_pers_month
                                         where yearvy=:y and
                                               monthvy=:m and tabno=:tabno
                               )
                   )) then
                           begin
                                exp=1;
                                update tb_p04t07b
                                       set exp=1
                                       where shifrid=:i;
                           end
                else
                   if (WantedKat=1) then
                      begin
                            exp=1;
                            update tb_p04t07b
                                   set exp=1
                                   where shifrid=:i;
                      end


          end

/* Соединить 4 и 5 код в 7 таблице */

            summa_5     = 0;
            summa_ins_5 = 0;
            summa_max_5 = 0;
            summa_4     = 0;
            summa_ins_4 = 0;
            summa_max_4 = 0;
            for
               select a.pay_year,a.pay_mnth,count(*)  from tb_p04t07b a
                      where a.tabno=:tabno
                            and a.yearvy=:y
                            and a.monthvy=:m
                            and a.pay_tp in (4,5)
                            and exp=:exp
                      group by 1,2
                      having count(*)>1
                      into :year_za,:month_za,:i
            do
              begin
                --   if (exists (select * from
                --               tb_tmp_p4t7 a where
                --               a.tabno=:tabno and
                --               a.pay_year=:year_za and
                --               a.pay_mnth =:month_za
                --   )) then leave;

                  select sum(case
                                when a.pay_tp=5 then -a.sum_total
                                else a.sum_total
                             end   ),
                         sum(case
                                when a.pay_tp=5 then -a.sum_ins
                                else a.sum_ins
                             end  )  from tb_p04t07b a
                      where a.tabno=:tabno
                            and a.yearvy=:y
                            and a.monthvy=:m
                            and a.pay_mnth=:month_za
                            and a.pay_year=:year_za
                            and a.pay_tp in (4,5)
                      into :summa_5,:summa_ins_5;

                  summa_4     = 0;
                  summa_ins_4 = 0;
                  summa_max_4 = 0;

                  summa_5     = coalesce(summa_5,0);
                  summa_ins_5 = coalesce(summa_ins_5,0);

                  delete from tb_p04t07b a
                         where a.tabno=:tabno
                            and a.yearvy=:y
                            and a.monthvy=:m
                            and a.pay_mnth=:month_za
                            and a.pay_year=:year_za
                            and a.pay_tp in (4,5);

                  if (summa_5>0.005) then
                     begin
                          summa_4=summa_5;
                          summa_5=0;
                     end
                  else
                     begin
                          summa_5=-summa_5;
                          summa_4=0;
                     end
                  if (summa_ins_5>0.005) then
                     begin
                          summa_ins_4=summa_ins_5;
                          summa_ins_5=0;
                     end
                  else
                     begin
                          summa_ins_5=-summa_ins_5;
                          summa_ins_4=0;
                     end

                  if ((summa_4>0.005)or (summa_ins_4>0.005))  then
                     insert into tb_p04t07b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                             pay_mnth,pay_year,pay_tp,
                                             sum_total,sum_max,sum_ins,
                                             zo,zic,otk,exp)
                                             values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :month_za, :year_za, 4,
                                                    :summa_4,0,:summa_ins_4,
                                                    :zo,:zic,:otk,:exp);
                  if ((summa_5>0.005)or (summa_ins_5>0.005))  then
                     insert into tb_p04t07b (yearvy,monthvy,tabno, numident,fio, nm,ftn,
                                             pay_mnth,pay_year,pay_tp,
                                             sum_total,sum_max,sum_ins,
                                             zo,zic,otk,exp)
                                             values(:y, :m,:tabno,:nal_code, :fam,:nam,:otc,
                                                    :month_za, :year_za, 5,
                                                    :summa_5,0,:summa_ins_5,
                                                    :zo,:zic,:otk,:exp);

              end





/* Корректировки лимитов в табл 7*/
       for
          select shifrid,sum_max from tb_p04t07b
                 where yearvy=:y and monthvy=:m and tabno=:tabno
                 into :i,:summa
       do
          begin
                select sum(a.sum_max) from tb_p04t06b a
                                 where a.tabno=:tabno
                                     and a.yearvy=:y
                                     and a.monthvy=:m
                        into :summa_m;
                if (summa_m>0) then
                   begin
                         summa_m=p-summa_m;
                         if (summa>summa_m) then
                             update tb_p04t07b
                                    set sum_max=:summa_m
                                    where shifrid=:i;
                   end

          end


end^


ALTER PROCEDURE PR_P4_PERSON_2010 (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    WANTEDKAT INTEGER,
    FORCED_MODE INTEGER)
AS
declare variable I_COUNT smallint;
declare variable SUMMA decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable MONTH_ZA integer;
declare variable YEAR_ZA integer;
declare variable MONTH_VY integer;
declare variable YEAR_VY integer;
declare variable VYPL integer;
declare variable IDPERSON integer;
declare variable SHIFRSTA integer;
declare variable MARKED integer;
declare variable SEL integer;
declare variable IDADD integer;
declare variable IDUD integer;
declare variable IDMST integer;
declare variable FIO varchar(120);
declare variable FAM varchar(50);
declare variable NAM varchar(50);
declare variable OTC varchar(50);
declare variable NAL_CODE varchar(10);
declare variable SUMMA_M decimal(15,2);
declare variable OTK integer;
declare variable DATEC date;
declare variable P decimal(15,2);
declare variable INVALID integer;
declare variable ZO integer;
declare variable ZIC integer;
declare variable MUSOR integer;
declare variable ISRCNZNT integer;
declare variable DAYS integer;
declare variable START_DT integer;
declare variable END_DT integer;
declare variable SUMMAPENSRAS decimal(15,2);
declare variable MODEREC integer; /* режим записи */
declare variable I_COUNT_7_1 integer;
declare variable I_COUNT_7_2 integer;
declare variable I_COUNT_7_3 integer;
declare variable I_COUNT_7_4 integer;
declare variable I_COUNT_7_5 integer;
declare variable I_COUNT_6 integer;
declare variable IDMST_7_1 integer;
declare variable IDMST_7_2 integer;
declare variable IDMST_7_3 integer;
declare variable IDMST_7_4 integer;
declare variable IDMST_7_5 integer;
declare variable IDMST7 integer;
declare variable DT date;
declare variable SHIFRNF integer;
declare variable FULLN_U varchar(50);
declare variable NAME_U varchar(50);
declare variable FATH_U varchar(50);
declare variable S varchar(10);
declare variable I integer;
declare variable SUMMA_5 decimal(15,2);
declare variable SUMMA_INS_5 decimal(15,2);
declare variable SUMMA_4 decimal(15,2);
declare variable SUMMA_INS_4 decimal(15,2);
declare variable EXP decimal(15,2);
declare variable START_DT_1 integer;
declare variable END_DT_1 integer;
declare variable SUMMA_MAX_4 decimal(15,2);
declare variable SUMMA_MAX_5 decimal(15,2);
begin
     musor=gen_id(G_TEST,1);
     I_count     = 0;
     i_count_6   = 0;
     i_count_7_1 = 0;
     i_count_7_2 = 0;
     i_count_7_3 = 0;
     i_count_7_4 = 0;
     i_count_7_5 = 0;
     idmst       = 0;
     shifrnf  = 0;    -- нумерация не найденых
     delete from tb_tmp_t07;
     delete from tb_tmp_p4t7;
     -- параметры абонента
     select first 1 fio,nal_code from kadry
            where kadry.tabno=:tabno
            into :fio, :nal_code;
     execute procedure pr_get_fno_person(:fio) returning_values(:fam, :nam, :otc);
     fam=upper(fam);
     nam=upper(nam);
     otc=upper(otc);
     if (strlen(trim(nal_code))=10) then
        begin
             fulln_u=null;
             name_u=null;
             fath_u=null;
             select first 1 fulln_u, name_u,fath_u from tb_drfo
                    where tin=:nal_code
                    into :fulln_u,:name_u,:fath_u;
             if (fulln_u is not null) then  fam=fulln_u;
             if (name_u is not null)  then  nam=name_u;
             if (fath_u is not null)  then  otc=fath_u;
        end
     else
        begin
  --             shifrnf=shifrnf+1;
             select first 1 idcode from tb_bk
                    where tabno=:tabno
                    into :nal_code;
             if ((nal_code is null) or (strlen(trim(nal_code))<>10))  then
                begin
                     shifrnf=gen_id(g_p4_nf, 1);
                     nal_code='БКНН000000';
                     s=shifrnf;
                     s=trim(s);
                     i=strlen(s);
                     nal_code=substrlen(nal_code, 1,10-i)||trim(s);
                end
        end
     if (strlen(nam)=0) then nam='НЕМА';
     if (strlen(otc)=0) then otc='НЕМА';
     if (strlen(nal_code)>10) then nal_code=substrlen(nal_code, 1,10);
     otk=1;
     if (exists (select * from person where person.m_o_r in (82,121,161) and
         person.tabno=:tabno          and
         person.yearvy=:y             and
         person.monthvy=:m)) then
         otk=0;
     invalid=0;
     if (exists (select * from fcn where fcn.tabno=:tabno and
         fcn.month_vy=:m            and
         fcn.year_vy=:y             and
         fcn.shifrsta in (112,112+500))) then
         invalid=1;
     ZO=1;
     zic=1;
     if (invalid=1) then
        begin
             zo=2;
             zic=2;
        end


     for
        select fadd.summa,  fadd.shifrkat,fadd.shifrgru,
               fadd.W_PLACE,fadd.W_R,     fadd.shifrsta,fadd.Month_Za,
               fadd.year_za,fadd.month_vy,fadd.year_vy ,fadd.vypl,
               FADD.shifrid, fadd.shifridperson,
               0
                from fadd
               join shifr on fadd.shifrsta=shifr.shifr
               where fadd.tabno=:tabno and
            --         fadd.month_vy=:m  and
                     fadd.year_vy<>2010   and
                     fadd.year_za=2010   and
                     fadd.shifrsta not in (31,32,44) and            -- материальную помощь не включать
                                                                      -- декретный больничеый не включать
                                                                      -- пособие до 3-х лет
                                                                      -- внесено в кассу
                     fadd.w_place not in (106,165) and                -- 106 материальная помощь подразделение пособие до 3-х лет
                     ((fadd.shifrsta<>16) or -- перечитка нодочитка
                      (fadd.shifrsta=16  and fadd.w_place between 151 and 168)) and
                     shifr.pens=1
                     and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                           -- все
                          (:WantedKat=1 and (select first 1 retval from pr_is_sciped(fadd.shifridperson,0)) =1) or    -- ППС
                          (:WantedKat=2 and (select first 1 retval from pr_is_sciped(fadd.shifridperson,0)) =0 ))     -- не ППС
               into :summa,:shifrkat,:shifrgru,:W_Place,:w_r, :ShifrSta,
                        :Month_Za,:Year_Za,:Month_Vy,:Year_Vy,:Vypl,:idadd,
                        :idperson,:moderec
            do
              begin
                    i_count=i_count+1;
                    i_count_6=i_count_6+1;
                    if (i_count_6=1) then
                       begin
                            idmst=gen_id(g_p04t06b, 1);
                            insert into tb_p04t06b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,zo,zic,otk,exp)
                                   values(:idmst, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,:zo,:zic,:otk,0);
                       end

                    Marked  = 1;
                    insert into tb_p04t06b_det (shifridmst,SHIFRIDPERSON,SHIFRIDADD,
                                   tabno, w_place,w_r,shifrgru,shifrkat,shifrsta,month_za,year_za,
                                    month_vy, year_vy,summa,vypl,marked)
                               values (:idmst,:idperson,:idadd,
                                    :tabno,:W_Place,:w_r,:shifrgru,
                                    :ShifrKat,:ShifrSta,:Month_Za,:Year_Za,
                                    :Month_Vy,:Year_Vy,:Summa,:VYPL,:Marked);
              end   -- Конец цикла по статьям
            select sum(summa) from tb_p04t06b_det
                   where tb_p04t06b_det.shifridmst=:idmst and
                   tb_p04t06b_det.marked=1
                   into summa;
            summa_m=summa;

            DateC=y||'-'||m||'-10';
            select first 1 summalimita from PR_GET_LIMIT_FOR_PENS(:DateC) into :p;
            if (summa_m>p) then
               summa_m=p;
            update tb_p04t06b set
                sum_total = :summa,
                sum_max   = :summa_m
                where shifrid=:idmst;


       --     Взносы в пенсионный фонд -------
       --     Таблица 6                -------
            select sum(fud.summa) from fud
                   where fud.year_vy<>2010
                         and fud.year_za=2010
                         and fud.tabno=:tabno
                         and fud.shifrsta in (75)
                         and ((:WantedKat=0 or :Forced_Mode in (1,2)) or                     -- все
                              (:WantedKat=1 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =1) or  -- ППС
                              (:WantedKat=2 and (select first 1 retval from pr_is_sciped(fud.shifridperson,0)) =0))   -- не ППС
                   into :SummaPensRas;
            if ((SummaPensRas is not null) and (abs(:SummaPensRas)>0.005)) then
               begin
                    if (not exists (select * from tb_p04t06b where shifrid=:idmst)) then
                       begin
                            if (idmst=0) then
                               begin
                                     idmst=gen_id(g_p04t06b, 1);
                                     insert into tb_p04t06b (shifrid,yearvy,monthvy,tabno, numident,fio, nm,ftn,zo,zic,sum_total,sum_max,sum_ins,otk,exp)
                                            values(:idmst, :y, :m,:tabno,:nal_code, :fam,:nam,:otc,:zo,:zic,0,0,0,:otk,0);
                               end
                            else
                               exception e_p07 'нет нач-й 6 '||:tabno||' idmst='||:idmst;
                       end
                    update tb_p04t06b set
                           sum_ins   = :SummaPensRas
                           where shifrid=:idmst;
               end









end^


ALTER PROCEDURE PR_P4_TEST (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_PENS_SV DECIMAL(15,2),
    SUM_TOTAL_SV DECIMAL(15,2),
    SUM_TOTALZP_SV DECIMAL(15,2))
AS
declare variable TABNO integer;
declare variable NAL_CODE varchar(10);
declare variable FAM varchar(50);
declare variable OTC varchar(50);
declare variable NAM varchar(50);
declare variable SUM_TOTAL decimal(15,2);
declare variable SUM_MAX decimal(15,2);
declare variable SUM_INS decimal(15,2);
declare variable FIO varchar(100);
declare variable I integer;
declare variable PAY_TB integer;
begin
     delete from tb_test_p04;

     for
         select tabno,NUMIDENT,fio,nm,ftn,sum_total,sum_max,sum_ins from tb_p04t06b
                where yearvy=:y and monthvy=:m
                into :tabno,:nal_code, :fam,:nam,:otc, :sum_total, :sum_max,:sum_ins
     do
       begin
            fio=trim(fam)||' '||trim(nam)||' '||trim(otc);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_total_6 = sum_total_6 + :sum_total,
                      sum_max_6   = sum_max_6   + :sum_max,
                      sum_ins_6   = sum_ins_6   + :sum_ins
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,:nal_code,:sum_total,:sum_max,:sum_ins,0,0,0,0,0);
       end

     for
         select tabno,NUMIDENT,fio,nm,ftn,sum_total,sum_max,sum_ins,pay_tp from tb_p04t07b
                where yearvy=:y and monthvy=:m
--                      and tabno=6460
                into :tabno,:nal_code, :fam,:nam,:otc, :sum_total, :sum_max,:sum_ins,:pay_tb
     do
       begin
            if (pay_tb=5) then
               begin
                    sum_ins=-sum_ins;
                    sum_total=-sum_total;
               end
            fio=trim(fam)||' '||trim(nam)||' '||trim(otc);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_total_7 = sum_total_7 + :sum_total,
                      sum_max_7   = sum_max_7   + :sum_max,
                      sum_ins_7   = sum_ins_7   + :sum_ins
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,:nal_code,0,0,0,:sum_total,:sum_max,:sum_ins,0,0);
       end

     for
         select person.tabno,person.fio,sum(summa) from fadd
                join person on person.shifrid=fadd.shifridperson
                where person.yearvy=:y and person.monthvy=:m
                      and fadd.shifrsta not in (23,31,32,44)
                      and fadd.w_place not in (106,165)
                group by 1,2
                into :tabno, :fam, :sum_total
     do
       begin
            fio=trim(fam);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_sal = sum_sal + :sum_total
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,'1111111111',0,0,0,0,0,0,:sum_total,0);
       end
     for
         select person.tabno,person.fio,sum(summa) from fud
                join person on person.shifrid=fud.shifridperson
                where person.yearvy=:y and person.monthvy=:m  and shifrsta=75
                group by 1,2
                into :tabno, :fam, :sum_ins
     do
       begin
            fio=trim(fam);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_pens = sum_pens + :sum_ins
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,'1111111111',0,0,0,0,0,0,0,:sum_ins);
       end

  select sum(sum_ins_6)+sum(sum_ins_7),sum(sum_pens) from tb_test_p04 into :sum_ins_sv, :sum_pens_sv;
  select sum(sum_total_6)+sum(sum_total_7),sum(sum_sal) from tb_test_p04 into :sum_total_sv, :sum_totalzp_sv;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_P4_TEST_T7_1 (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUM_INS_SV DECIMAL(15,2),
    SUM_PENS_SV DECIMAL(15,2))
AS
declare variable TABNO integer;
declare variable NAL_CODE varchar(10);
declare variable FAM varchar(50);
declare variable OTC varchar(50);
declare variable NAM varchar(50);
declare variable SUM_TOTAL decimal(15,2);
declare variable SUM_MAX decimal(15,2);
declare variable SUM_INS decimal(15,2);
declare variable FIO varchar(100);
declare variable I integer;
declare variable PAY_TB integer;
begin
/*
     delete from tb_test_p04;

     for
         select tabno,NUMIDENT,fio,nm,ftn,sum_total,sum_max,sum_ins,pay_tp from tb_p04t07b
                where yearvy=:y and monthvy=:m and pay_tp=1
--                      and tabno=6460
                into :tabno,:nal_code, :fam,:nam,:otc, :sum_total, :sum_max,:sum_ins,:pay_tb
     do
       begin
            fio=trim(fam)||' '||trim(nam)||' '||trim(otc);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_total_7 = sum_total_7 + :sum_total,
                      sum_max_7   = sum_max_7   + :sum_max,
                      sum_ins_7   = sum_ins_7   + :sum_ins
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,:nal_code,0,0,0,:sum_total,:sum_max,:sum_ins,0,0);
       end

     for
         select person.tabno,person.fio,sum(summa) from fadd
                join person on person.shifrid=fadd.shifridperson
                where person.yearvy=:y and person.monthvy=:m
                      and fadd.shifrsta=12
                group by 1,2
                into :tabno, :fam, :sum_total
     do
       begin
            fio=trim(fam);
            if (exists (select * from tb_test_p04 where tabno=:tabno)) then
               update tb_test_p04 set
                      sum_sal = sum_sal + :sum_total
                      where tabno=:tabno;
            else
               insert into tb_test_p04 values(
                     :tabno,:fio,'1111111111',0,0,0,0,0,0,:sum_total,0);
       end

  select sum(sum_ins_6)+sum(sum_ins_7),sum(sum_pens) from tb_test_p04 into :sum_ins_sv, :sum_pens_sv;
  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE PR_P6_REMAKE (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMA DECIMAL(15,2),
    NMB INTEGER)
AS
declare variable tabno integer;
declare variable pay_tp integer;
declare variable pay_mnth integer;
declare variable pay_year integer;
declare variable sum_ins decimal(15,2);
declare variable shifrid integer;
declare variable fio varchar(100);
declare variable nm varchar(100);
declare variable ftn varchar(100);
declare variable zo integer;
declare variable zic integer;
declare variable otk integer;
declare variable exp integer;
declare variable numident varchar(10);
declare variable shifridt7 integer;
begin
     summa=0;
     nmb=0;
     for
         select a.tabno,a.pay_tp,a.pay_mnth,a.pay_year,a.sum_ins,
                fio,nm, ftn,zo,zic, otk,exp,numident,a.shifrid
                 from tb_p04t07b a where
                a.pay_tp in (1,2,3) and abs(a.sum_ins)>0.01
--                and not exists (select * from tb_p04t06b b where b.tabno=a.tabno)
                into :tabno, :pay_tp, :pay_mnth,:pay_year,:sum_ins,
                       :fio,:nm, :ftn,:zo,:zic,:otk, :exp,:numident,:shifridt7
     do
      begin
           nmb=nmb+1;
           summa=summa+sum_ins;
        select first 1 a.shifrid from tb_p04t06b a
                         where a.tabno=:tabno
                               and a.yearvy=:y
                               and a.monthvy=:m
                         into :shifrid;
        shifrid=coalesce(shifrid,0);
        if (shifrid>0) then
           update tb_p04t06b
                  set sum_ins=sum_ins+:sum_ins
                  where shifrid=:shifrid;
        else
           begin
                insert into tb_p04t06b (YEARVY,MONTHVY,TABNO,ROWNUM,NUMIDENT,
                                   FIO,NM,FTN,ZO,ZIC,
                                   SUM_TOTAL,sum_max,SUM_INS,OTK,
                                   EXP) VALUES (
                                   :y, :m,:tabno, null, :numident,
                                   :fio,:nm,:ftn,:zo,:zic,
                                   0,0,:sum_ins,:otk,:exp);
   --             select max(shifrid) from tb_p04t06b into :shifrid;
           end
        update tb_p04t07b
               set sum_ins=0
               where shifrid=:shifridt7;


  end


  /* Procedure Text */
 -- suspend;
end^


ALTER PROCEDURE PR_PERS_PREP
RETURNS (
    TABNO INTEGER,
    NAL_CODE VARCHAR(10),
    FIO VARCHAR(50),
    M_O_R INTEGER)
AS
declare variable temp integer;
begin
     for
         select a.tabno,a.nal_code,a.fio from  kadry a
                into :tabno, :nal_code,:fio
     do
--      if (tabno=7983) then
       begin
             select first 1 b.tabno,c.m_o_r from fadd b
                    join person c on c.shifrid=b.shifridperson
                    where b.tabno=:tabno and
                          b.year_za=2006 and
                          b.summa>0.01   and
                          b.w_place not in (76,81,85,86,87,89,91,98,105,106,128,136,140,155,156,168) and
                          b.shifrsta=1   and
                          (b.shifrkat in (1,3)   or
                           (exists (select first 1 d.shifrid from fcn d
                                    where d.shifridperson=c.shifrid and
                                          d.shifrsta in (100,600) and
                                          d.prim in (10,20,30,40)))
                          ) and 
                          not exists (select first 1 e.shifrid from fcn e
                                    where e.tabno=:tabno and
                                          e.w_r=1 and
                                          e.year_vy=2006 and
--                                          e.month_vy=c.monthvy and
                                          e.shifrsta in (100,600) and
                                          e.prim=240)                      -- stager
                    order by c.m_o_r
                    into :temp,:m_o_r;
             if (temp is not null and temp=tabno) then
                 suspend;
       end
end^


ALTER PROCEDURE PR_PERS_PREP_SOWM
RETURNS (
    TABNO INTEGER,
    NAL_CODE VARCHAR(10),
    FIO VARCHAR(50),
    M_O_R INTEGER,
    S1 DECIMAL(15,2),
    S2 DECIMAL(15,2),
    S3 DECIMAL(15,2),
    S4 DECIMAL(15,2),
    S5 DECIMAL(15,2),
    S6 DECIMAL(15,2),
    S7 DECIMAL(15,2),
    S8 DECIMAL(15,2),
    S9 DECIMAL(15,2),
    S10 DECIMAL(15,2),
    S11 DECIMAL(15,2),
    S12 DECIMAL(15,2))
AS
declare variable m integer;
declare variable summa decimal(15,2);
begin

     for
         select a.tabno,a.nal_code,a.fio,b.m_o_r from  kadry a
              join tb_pers_prep b on a.tabno=b.tabno
                into :tabno, :nal_code,:fio,:m_o_r
     do
--      if (tabno=7983) then
       begin
             s1=0;
             s2=0;
             s3=0;
             s4=0;
             s5=0;
             s6=0;
             s7=0;
             s8=0;
             s9=0;
             s10=0;
             s11=0;
             s12=0;
             m=0;
             while (m<12) do
               begin
                     m=m+1;
                     execute procedure pr_get_m_not_pr(tabno, 2006,m) returning_values(summa);
                     if (summa>0.01) then
                        if (m=1) then
                           s1=summa;
                        else
                        if (m=2) then
                           s2=summa;
                        else
                        if (m=3) then
                           s3=summa;
                        else
                        if (m=4) then
                           s4=summa;
                        else
                        if (m=5) then
                           s5=summa;
                        else
                        if (m=6) then
                           s6=summa;
                        else
                        if (m=7) then
                           s7=summa;
                        else
                        if (m=8) then
                           s8=summa;
                        else
                        if (m=9) then
                           s9=summa;
                        else
                        if (m=10) then
                           s10=summa;
                        else
                        if (m=11) then
                           s11=summa;
                        else
                        if (m=12) then
                           s12=summa;
               end
             if (s1>0.01 or s2>0.01 or s3>0.01 or
                s4>0.01  or s5>0.01 or s6>0.01 or
                s7>0.01  or s8>0.01 or s9>0.01 or
                s10>0.01 or s11>0.01 or s12>0.01) then
             suspend;
       end
end^


ALTER PROCEDURE PR_PERSON_ANALYZE_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRIDPERSON INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    DOLG VARCHAR(50),
    SHIFRKAT INTEGER,
    KATNAME VARCHAR(40),
    SHIFRGRU INTEGER,
    GRUNAME VARCHAR(40),
    KOEF DECIMAL(15,2),
    W_R INTEGER,
    W_R_NAME VARCHAR(10),
    W_PLACE INTEGER,
    W_P_NAME VARCHAR(100),
    SUMMAADD DECIMAL(15,2),
    SUMMAADDMAX DECIMAL(15,2),
    SUMMAUD DECIMAL(15,2),
    SUMMAUDR DECIMAL(15,2),
    SUMMAUDN DECIMAL(15,2),
    MODEPRSN INTEGER)
AS
declare variable NEED integer;
begin
     for
         select tb_tmp_person.shifrid,
                tb_tmp_person.dolg,
                tb_tmp_person.shifrkat,
                tb_tmp_person.shifrgru,
                tb_tmp_person.w_r,
                    (case when tb_tmp_person.w_r=1 then 'Осн' else 'Свм' end),
               tb_tmp_person.w_place,yearvy,monthvy,
               tb_tmp_person.automatic
      from tb_tmp_person
      where tb_tmp_person.tabno=:tabno --and yearza=:y and monthza=:m
      order by w_r,w_place
      into :shifridperson,:dolg,:shifrkat,:shifrgru,
           :w_r,:w_r_name,:w_place,:yearvy, :monthvy,:modeprsn
      do
         begin
               if (ShifridPerson=1560263) then
                   ShifridPerson=1560263;
               koef=1;
               select first 1 tb_tmp_fcn.summa from tb_tmp_fcn
                      where tb_tmp_fcn.shifridperson=:shifridperson and
                            tb_tmp_fcn.kod=100   and
                            tb_tmp_fcn.shifrsta in (100,100+500)
                      into :koef;
               if (koef is null or koef<0.005 or koef>1.2) then
                  koef=1;
               katname='Нет катег';
               if (exists(select first 1 kateg.name from  kateg where kateg.shifr=:shifrkat) ) then
                  select first 1 kateg.name from  kateg where kateg.shifr=:shifrkat into katname;
               gruname='Нет счета';
               if (exists(select first 1 gruppy.name from  gruppy where gruppy.shifr=:shifrgru) ) then
                  select first 1 gruppy.name from  gruppy where gruppy.shifr=:shifrgru into gruname;
               w_p_name='Нет подразд';
               if (exists(select first 1 podr.name from  podr where podr.shifrpod=:w_place) ) then
                  select first 1 podr.name from  podr where podr.shifrpod=:w_place into w_p_name;
               if (mode=1) then
                  select first 1 summaadd,summafz from getfznachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=2) then
                  select first 1 summaadd,summass from getssnachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=3) then
                  select first 1 summaadd,summapens from getpensnachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=4) then
                  select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=5) then
                  select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=6) then
                  select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=7) then
                  select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
              else
                  select first 1 summaadd,summapod from getpodnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
              need       = 0;
              summaadd   = coalesce(summaadd, 0);
              summaud    = coalesce(summaud, 0);
              summaudr   = 0;
              summaudn   = 0;
              summaaddmax = 0;
              if (abs(summaadd)>0.005) then
                 need=1;
              if (abs(summaud)>0.005) then
                 need=1;
              if (need=1) then
                 suspend;
         end



  /* Procedure Text */
end^


ALTER PROCEDURE PR_PERSON_CHAIN_ADD_REC (
    SHIFRIDPERSON INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(20),
    SUMMA DECIMAL(15,2))
AS
begin
     if (mode not in (4,5,6)) then
      for
          select a.shifrsta,
                 b.shortname,
                 a.summa
            from tb_tmp_fadd a
                 join shifr b on a.shifrsta=b.shifr
            where a.shifridperson=:shifridperson
                  and ((:mode=1 and b.fondz>0) or
                       (:mode=2 and b.ss>0) or
                       (:mode=3 and b.pens>0) or
                       (:mode=7 and b.ecb_ill>0) or
                       (:mode=0 and b.podoh>0)
                  )
--                  and a.year_za=:y and a.month_za=:m
                  and ((a.year_vy  = :y and a.month_vy = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))<>1)) or
                        (a.year_ZA  = :y and a.month_ZA = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))=1))
                       )
            order by 1
            into shifrsta,namesta,summa
      do
        suspend;
     else
      if (mode=6) then
        for
          select a.shifrsta,
                 b.shortname,
                 a.summa
            from tb_tmp_fadd a
                 join shifr b on a.shifrsta=b.shifr
            where a.shifridperson=:shifridperson
                  and a.year_za=:y and a.month_za=:m
                  and a.w_place in (81,140)
            order by 1
            into shifrsta,namesta,summa
        do
        suspend;
     else
      if (mode=4) then      /* Не научный работник*/
        for
          select a.shifrsta,
                 b.shortname,
                 a.summa
            from tb_tmp_fadd a
                 join shifr b on a.shifrsta=b.shifr
                 join tb_tmp_person c on c.shifrid=a.shifridperson
            where a.shifridperson=:shifridperson
                  and ((a.year_vy  = :y and a.month_vy = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))<>1)) or
                        (a.year_ZA  = :y and a.month_ZA = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))=1))
                       )
                  and a.w_place not in (81,140)
                  and b.ecb>0
                  and (c.shifrkat<>1 or
                       (c.shifrkat=1 and
                         ((a.w_place between 151 and 168) or (a.w_place=121))))
            order by 1
            into shifrsta,namesta,summa
        do
        suspend;
     else
      if (mode=5) then      /* Научный работник*/
        for
          select a.shifrsta,
                 b.shortname,
                 a.summa
            from tb_tmp_fadd a
                 join shifr b on a.shifrsta=b.shifr
                 join tb_tmp_person c on c.shifrid=a.shifridperson
            where a.shifridperson=:shifridperson
                  and ((a.year_vy  = :y and a.month_vy = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))<>1)) or
                        (a.year_ZA  = :y and a.month_ZA = :m and
                        ((select first 1 retval from PR_ISOTHERPERIODECBSHIFR(a.shifrSTA))=1))
                       )
                  and a.w_place not in (81,140,121)
                  and b.ecb>0
                  and c.shifrkat=1
                  and a.w_place not between 151 and 168
            order by 1
            into shifrsta,namesta,summa
        do
        suspend;

end^


ALTER PROCEDURE PR_PERSON_CHAIN_REC (
    TABNO INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRIDPERSON INTEGER,
    YEARVY INTEGER,
    MONTHVY INTEGER,
    DOLG VARCHAR(10),
    SHIFRKAT INTEGER,
    KATNAME VARCHAR(40),
    SHIFRGRU INTEGER,
    GRUNAME VARCHAR(40),
    KOEF DECIMAL(15,2),
    W_R INTEGER,
    W_R_NAME VARCHAR(10),
    W_PLACE INTEGER,
    W_P_NAME VARCHAR(100),
    SUMMAADD DECIMAL(15,2),
    SUMMAUD DECIMAL(15,2))
AS
declare variable NEED integer;
begin
     for
         select tb_tmp_person.shifrid,
                tb_tmp_person.dolg,
                tb_tmp_person.shifrkat,
                tb_tmp_person.shifrgru,
                tb_tmp_person.w_r,
                    (case when tb_tmp_person.w_r=1 then 'Осн' else 'Свм' end),
               tb_tmp_person.w_place,yearvy,monthvy
      from tb_tmp_person
      where tb_tmp_person.tabno=:tabno --and yearza=:y and monthza=:m
      order by w_r,w_place
      into :shifridperson,:dolg,:shifrkat,:shifrgru,
           :w_r,:w_r_name,:w_place,:yearvy, :monthvy
      do
         begin
               koef=1;
               select first 1 tb_tmp_fcn.summa from tb_tmp_fcn
                      where tb_tmp_fcn.shifridperson=:shifridperson and
                            tb_tmp_fcn.kod=100   and
                            tb_tmp_fcn.shifrsta in (100,100+500)
                      into :koef;
               if (koef is null or koef<0.005 or koef>1.2) then
                  koef=1;
               katname='Нет катег';
               if (exists(select first 1 kateg.name from  kateg where kateg.shifr=:shifrkat) ) then
                  select first 1 kateg.name from  kateg where kateg.shifr=:shifrkat into katname;
               gruname='Нет счета';
               if (exists(select first 1 gruppy.name from  gruppy where gruppy.shifr=:shifrgru) ) then
                  select first 1 gruppy.name from  gruppy where gruppy.shifr=:shifrgru into gruname;
               w_p_name='Нет подразд';
               if (exists(select first 1 podr.name from  podr where podr.shifrpod=:w_place) ) then
                  select first 1 podr.name from  podr where podr.shifrpod=:w_place into w_p_name;
               if (mode=1) then
                  select first 1 summaadd,summafz from getfznachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=2) then
                  select first 1 summaadd,summass from getssnachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=3) then
                  select first 1 summaadd,summapens from getpensnachud_common(:tabno,:y,:m,1,1,:shifridperson) into :summaadd, :summaud;
               else
               if (mode=4) then
                  select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=5) then
                  select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=6) then
                  select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
               else
               if (mode=7) then
                  select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
              else
                  select first 1 summaadd,summapod from getpodnachud_common(:tabno,:y,:m,1,1,:shifridperson,0) into :summaadd, :summaud;
              need=0;
              summaadd = coalesce(summaadd, 0);
              summaud  = coalesce(summaud, 0);
              if (abs(summaadd)>0.005) then
                 need=1;
              if (abs(summaud)>0.005) then
                 need=1;
              if (need=1) then
                 suspend;
         end



  /* Procedure Text */
end^


ALTER PROCEDURE PR_PERSON_CHAIN_UD_REC (
    SHIFRIDPERSON INTEGER,
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(20),
    SUMMA DECIMAL(15,2))
AS
begin
      for
          select a.shifrsta,
                 b.shortname,
                 a.summa
            from tb_tmp_fud a
                 join shifr b on a.shifrsta=b.shifr
            where a.shifridperson=:shifridperson
                  and ((:mode=1 and a.shifrsta=88) or
                       (:mode=2 and a.shifrsta=106) or
                       (:mode=3 and a.shifrsta=75) or
                       (:mode=4 and a.shifrsta=142) or
                       (:mode=5 and a.shifrsta=143) or
                       (:mode=6 and a.shifrsta=146) or
                       (:mode=7 and a.shifrsta=145) or
                       (:mode=0 and a.shifrsta=50)
                  )
                  and a.year_za=:y and a.month_za=:m
            order by 1
            into shifrsta,namesta,summa
      do
        suspend;
end^


ALTER PROCEDURE PR_PLAN_FOND_MK (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER,
    MODE_PERIOD INTEGER)
RETURNS (
    NMBOSNTOT INTEGER,
    SUMMAOSNTOT DECIMAL(15,2),
    NMBOSNWMN INTEGER,
    SUMMAOSNWMN DECIMAL(15,2),
    NMBSWMTOT INTEGER,
    SUMMASWMTOT DECIMAL(15,2),
    NMBSWMWMN INTEGER,
    SUMMASWMWMN DECIMAL(15,2))
AS
declare variable dt date;
declare variable tabno integer;
declare variable summa decimal(15,2);
declare variable iswomen integer;
declare variable s varchar(1);
declare variable nal_code varchar(10);
declare variable m1 integer;
declare variable m2 integer;
declare variable m3 integer;
declare variable currkw integer;
declare variable issowm integer;
begin
     NMBOSNTOT   = 0;
     SUMMAOSNTOT = 0;
     NMBOSNWMN   = 0;
     SUMMAOSNWMN = 0;
     NMBSWMTOT   = 0;
     SUMMASWMTOT = 0;
     NMBSWMWMN   = 0;
     SUMMASWMWMN = 0;
     dt=y||'-'||m||'-01';
     if (mode_period=2) then
        begin
             currkw=case
                       when m in (1,2,3) then 1
                       when m in (4,5,6) then 2
                       when m in (7,8,9) then 3
                       else 4
                    end;
             m1=(currkw-1)*3+1;
             m2=(currkw-1)*3+2;
             m3=(currkw-1)*3+3;
        end
     for
         select a.tabno,b.nal_code,sum(a.summa) from fadd a
                        join person b on a.shifridperson=b.shifrid
                        where b.yearvy=:y
                        and (
                             ((:mode_period=1) and (b.monthvy=:m)) or
                             ((:mode_period=2) and (b.monthvy in (:m1, :m2,:m3))) or
                             ((:mode_period=3))
                            )
                        and (((a.w_place between 151 and 168) and :mode=2) or
                             ((a.w_place not between 151 and 168) and :mode=1))
                        group by 1,2
                        into :tabno,:nal_code,:summa
     do
       begin
            iswomen=0;
            if (char_length(trim(nal_code))=10) then
               begin
                    s=substr(nal_code,9,9);
                    if (s in ('0','2','4','6','8')) then iswomen=1;
               end
            issowm=0;
            if (mode_period=1) then
               if (exists (select * from person w where w.tabno=:tabno
                                    and w.yearvy=:y and w.monthvy=:m and w.w_place in (82,121))) then
                  issowm=1;
               else
                  issowm=0;
            else
            if (mode_period=2) then
               if (exists (select * from person w where w.tabno=:tabno
                                    and w.yearvy=:y and w.monthvy in (:m1,:m2,:m3) and w.w_place in (82,121))) then
                  issowm=1;
               else
                  issowm=0;
            else
               if (exists (select * from person w where w.tabno=:tabno
                                    and w.yearvy=:y and w.w_place in (82,121))) then
                  issowm=1;
            if (issowm=1) then
               begin
                    NMBSWMTOT   = NMBSWMTOT   + 1;
                    SUMMASWMTOT = SUMMASWMTOT + SUMMA;
                    if (iswomen=1) then
                       begin
                            NMBSWMWMN   = NMBSWMWMN + 1;
                            SUMMASWMWMN = SUMMASWMWMN + summa;
                       end
               end
            else
               begin
                    NMBOSNTOT   = NMBOSNTOT+1;
                    SUMMAOSNTOT = SUMMAOSNTOT+summa;
                    if (iswomen=1) then
                       begin
                            NMBOSNWMN   = NMBOSNWMN   + 1;
                            SUMMAOSNWMN = SUMMAOSNWMN + summa;
                       end
               end

       end
     suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_PLAN_GRID_MK (
    Y INTEGER,
    M INTEGER,
    MODE INTEGER)
RETURNS (
    SUMMAFR DECIMAL(15,2),
    SUMMATO DECIMAL(15,2),
    NMBOFPRSN INTEGER,
    NMBOFWMN INTEGER)
AS
declare variable dt date;
declare variable dtc date;
declare variable tabno integer;
declare variable summa decimal(15,2);
declare variable iswomen integer;
declare variable s varchar(1);
declare variable nal_code varchar(10);
begin
     dtc=y||'-'||m||'-01';
     select first 1 datafr from tb_plan_grid a
            where a.datafr<=:dtc
            order by 1 desc
            into dt;
     dt=coalesce(dt,'2010-04-01');
     update tb_plan_grid 
            set nmbofall=0,
                nmbofwmn=0
            where datafr=:dt;
     dt=coalesce(dt,'2010-04-01');
     for
         select a.tabno,b.nal_code,sum(a.summa) from fadd a
                        join person b on a.shifridperson=b.shifrid
                        where b.yearvy=:y
                        and b.monthvy=:m
                        and (((a.w_place between 151 and 168) and :mode=2) or
                             ((a.w_place not between 151 and 168) and :mode=1))
                        group by 1,2
                        into :tabno,:nal_code,:summa
     do
       begin
            iswomen=0;
            if (char_length(trim(nal_code))=10) then
               begin
                    s=substr(nal_code,9,9);
                    if (s in ('0','2','4','6','8')) then iswomen=1;
               end
            update tb_plan_grid d
                   set nmbofall=nmbofall+1,
                       nmbofwmn=nmbofwmn+:iswomen
                   where datafr=:dt
                   and :summa between d.summafr and d.summato;

       end
     for
         select summafr, summato, nmbofall,nmbofwmn from tb_plan_grid e
                where e.datafr=:dt
                order by 1
                into :summafr,:summato,:nmbofprsn,:nmbofwmn
     do
        suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_PLAN_RAZR_SWOD (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    RAZROUT INTEGER,
    OKLADOUT DECIMAL(15,2),
    FOPOUT DECIMAL(15,2),
    FOPOKLADOUT DECIMAL(15,2),
    FOPDOPLOUT DECIMAL(15,2),
    INDOUT DECIMAL(15,2))
AS
declare variable i integer;
declare variable shifrid integer;
declare variable razr integer;
declare variable summa decimal(15,2);
declare variable shifrsta integer;
declare variable fop decimal(15,2);
declare variable fopoklad decimal(15,2);
declare variable fopdopl decimal(15,2);
declare variable summaind decimal(15,2);
declare variable im integer;
declare variable dt date;
begin
     delete from tb_razr_swod;
     i=0;
     while (i<25) do
      begin
           i=i+1;
           im=0;
           fopoklad=0;
           while (im<m) do
             begin
                  im=im+1;
                  dt=y||'-'||im||'-10';
                  select first 1 a.oklad from tb_razr_proc a
                                 where a.datefr<:dt
                                 and a.razr=:i
                                 order by a.datefr desc 
                                 into :fop;
                  fopoklad = fopoklad + fop / m;
             end
           fopoklad=cast(fopoklad as decimal(15,0));
           insert into tb_razr_swod
                  values(:i*10,:fopoklad,0,0,0,0);
      end
     for
         select a.shifrid,a.razrjad from person a
                          where a.yearvy=:y
                          and (((:iskoledg=0) and (a.w_place not between 151 and 168)) or
                               ((:iskoledg=1) and (a.w_place between 151 and 168))
                          )
                          into :shifrid,:razr
     do
       begin
             for
                select a.summa,a.shifrsta from fadd a
                               where a.shifridperson=:shifrid
                               into :summa,:Shifrsta
             do
               begin
                    fop      = 0;
                    fopoklad = 0;
                    fopdopl  = 0;
                    summaind = 0;
            ---        if (summa>0) then
                       fop=summa;
                    if (shifrsta=1) then  fopoklad=summa;
                    if (shifrsta=28) then summaind=summa;
                    if (shifrsta in ( 2, 3, 4, 7, 8, 9,17,18,
                                     20,22,24,26,27,30,31,33,
                                     34,35,38,39,40,41,42,45,
                                     46,47,48)) then
                       fopdopl=summa;
                    if (fop<fopoklad-0.005) then
                       i=1;
                    update tb_razr_swod a
                           set a.fop  = a.fop      + :fop     ,
                           a.fopoklad = a.fopoklad + :fopoklad,
                           a.fopdopl  = a.fopdopl  + :fopdopl ,
                           a.summaind = a.summaind + :summaind
                       where razr=:razr*10;
               end
       end
  for
     select a.razr,a.oklad,a.fop,a.fopoklad,a.fopdopl,a.summaind  from tb_razr_swod a
            order by 1
            into :razrout,:okladout,:fopout,:fopokladout,:fopdoplout,:indout
  do
     suspend;
end^


ALTER PROCEDURE PR_PR_AND_NOT_PR (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(120),
    DOLG VARCHAR(10),
    SUMMASCI DECIMAL(15,2),
    SUMMAOTH NUMERIC(15,2))
AS
declare variable W_R integer;
begin
/*  Список сотрудников (не преподавателей) в 2009 г, которые работали по совмешщению
     преподавателем */
      for
          select tabno,fio from kadry into :tabno,:fio
      do
         begin
               w_r=null;
               select first 1 w_r,dolg from person
                      where person.tabno=:tabno and
                            person.yearvy=:y  and
                            person.monthvy=:m   and
                            person.w_r = 1      and
                            person.shifrkat not in (1,3,5,7)
                      into :w_r,:dolg;
               if (not (w_r is null or w_r<>1)) then
                  begin
               select
                      sum(
           case
            when (select first 1 retval from pr_is_sciped(a.shifridperson,0))=1 then a.summa
            else 0
           end
          ) as a1,
          sum(
           case
            when (select first 1 retval from pr_is_sciped(a.shifridperson,0))=0 then a.summa
            else 0
           end
          ) as a2
         from fadd  a
              join person b on a.shifridperson=b.shifrid
         where a.year_za=:y and
               a.tabno=:tabno
           into :summasci, :summaoth;
        if (summasci>0.01 and summaoth>0.01) then
          suspend;
        end
      end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_PR_AND_NOT_PR_MONTH (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    DOLG VARCHAR(10),
    SUMMASCI DECIMAL(15,2),
    SUMMAOTH NUMERIC(15,2))
AS
declare variable W_R integer;
begin
/*  Список сотрудников (не преподавателей) в 2009 г, которые работали по совмешщению
     преподавателем */
      for
          select tabno,fio from kadry into :tabno,:fio
      do
         begin
               w_r=null;
               select first 1 w_r,dolg from person
                      where person.tabno=:tabno and
                            person.yearvy=:y  and
                            person.monthvy=:m   and
                            person.w_r = 1      and
                            person.shifrkat not in (1,3,5,7)
                      into :w_r,:dolg;
               if (not (w_r is null or w_r<>1)) then
                  begin
               select
                      sum(
           case
            when (select first 1 retval from pr_is_sciped(a.shifridperson,0))=1 then a.summa
            else 0
           end
          ) as a1,
          sum(
           case
            when (select first 1 retval from pr_is_sciped(a.shifridperson,0))=0 then a.summa
            else 0
           end
          ) as a2
         from fadd  a
              join person b on a.shifridperson=b.shifrid
         where a.year_za=:y and
               a.month_vy=:m and
               a.tabno=:tabno
           into :summasci, :summaoth;
        if (summasci>0.01 and summaoth>0.01) then
          suspend;
        end
      end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_PRINT_BOLN (
    SHIFRIDBOLN INTEGER)
AS
declare variable lineno integer;
declare variable month_za integer;
declare variable days integer;
declare variable summa_bud decimal(15,2);
declare variable summa_vne decimal(15,2);
declare variable summa_gn decimal(15,2);
declare variable summa_nis decimal(15,2);
declare variable monthname varchar(10);
declare variable fond varchar(10);
declare variable shifr_sta integer;
declare variable maxline integer;
declare variable mode_ill integer;
declare variable graphic_day integer;
begin
    Lineno=0;
    MaxLine=0;
    select first 1 mode_ill from boln where boln.shifrid=:shifridboln into :mode_ill;
    mode_ill=coalesce(mode_ill, 0);
    delete from tb_tmp_bol_print where conn_id=current_connection;
    for
       select a.month_za,a.days,a.summa_bud,a.summa_vne,a.summa_gn,a.summa_nis,a.graphic_day   from boln_summy a
              where a.shifridboln=:shifridboln  and a.sel>0
              order by a.year_za desc, a.month_za desc
              into :month_za,:days,:summa_bud,:summa_vne,:summa_gn,:summa_nis,:graphic_day
    do
       begin
            LineNo=LineNo+1;
            maxline=lineno;
            monthname=case
                          when month_za=1 then 'Сiчень'
                          when month_za=2 then 'Лютий'
                          when month_za=3 then 'Березень'
                          when month_za=4 then 'Квiтень'
                          when month_za=5 then 'Травень'
                          when month_za=6 then 'Червень'
                          when month_za=7 then 'Липень'
                          when month_za=8 then 'Серпень'
                          when month_za=9 then 'Вересень'
                          when month_za=10 then 'Жовтень'
                          when month_za=11 then 'Листопад'
                          when month_za=12 then 'Грудень'
                          else  'Не изв'
                      end;
            if (mode_ill=1) then days=graphic_day;
            insert into tb_tmp_bol_print (LINENO,"MONTH",DAYS,SUMMA_BUD,
                                          SUMMA_VNE,SUMMA_GN,SUMMA_NIS)
                   values (:lineno, :monthname,:days,:summa_bud,
                           :summa_vne,:summa_gn,:summa_nis);
       end
    LineNo=0;
    for
       select a.month_za,a.shifrsta,a.b_day,a.summa_b_bud,
              a.summa_b_vne,a.summa_b_gn,a.summa_b_nis   from boln_res a
              where a.shifridboln=:shifridboln
              order by a.year_za, a.month_za,a.shifrsta
              into :month_za,:shifr_sta,:days,:summa_bud,:summa_vne,:summa_gn,:summa_nis
    do
       begin
            LineNo=LineNo+1;
            monthname=case
                          when month_za=1 then 'Сiчень'
                          when month_za=2 then 'Лютий'
                          when month_za=3 then 'Березень'
                          when month_za=4 then 'Квiтень'
                          when month_za=5 then 'Травень'
                          when month_za=6 then 'Червень'
                          when month_za=7 then 'Липень'
                          when month_za=8 then 'Серпень'
                          when month_za=9 then 'Вересень'
                          when month_za=10 then 'Жовтень'
                          when month_za=11 then 'Листопад'
                          when month_za=12 then 'Грудень'
                          else  'Не изв'
                      end;
            fond='ФСС';
            if (shifr_sta=12) then
               fond='ФМП';
            if (LineNo<=MaxLine) then
               update tb_tmp_bol_print set
                      month_bol=:monthname,
                      shifr_sta=:shifr_sta,
                      day_bol=:days,
                      summabol_bud=:summa_bud,
                      summabol_vne=:summa_vne,
                      summabol_gn=:summa_gn,
                      summabol_nis=:summa_nis,
                      fond=:fond
                 where conn_id=CURRENT_CONNECTION and
                       LineNo=:LINENO;
            else
               insert into tb_tmp_bol_print (LINENO,MONTH_BOL,shifr_sta, DAY_BOL,SUMMABOL_BUD,
                                          SUMMABOL_VNE,SUMMABOL_GN,SUMMABOL_NIS,FOND)
                   values (:lineno, :monthname,:shifr_sta, :days,:summa_bud,
                           :summa_vne,:summa_gn,:summa_nis,:fond);
       end

  /* Procedure Text */
end^


ALTER PROCEDURE PR_RECALC_08
AS
declare variable m integer;
declare variable y integer;
declare variable shifrid integer;
declare variable tabno integer;
declare variable shifrgru integer;
declare variable dolg varchar(10);
declare variable fio varchar(20);
declare variable shifrkat integer;
declare variable razrjad integer;
declare variable oklad decimal(15,2);
declare variable kalend_day integer;
declare variable work_day integer;
declare variable ill_day integer;
declare variable otp_day integer;
declare variable new_oklad decimal(15,2);
declare variable old_vypl_oklad decimal(15,2);
declare variable new_vypl_oklad decimal(15,2);
declare variable w_place integer;
declare variable dt date;
declare variable koef decimal(15,2);
declare variable dopl_oklad decimal(15,2);
declare variable nadb_zw_pr decimal(15,2);
declare variable dopl_zw decimal(15,2);
declare variable nadb_st_pr decimal(15,2);
declare variable dopl_st decimal(15,2);
declare variable nadb_vysl_pr decimal(15,2);
declare variable dopl_vysl decimal(15,2);
declare variable w_r integer;
declare variable cn_osn integer;
declare variable ispovysh integer;
declare variable iskomp_n_o integer;
declare variable nadb_zs_pr decimal(15,2);
declare variable dopl_zs decimal(15,2);
declare variable dopl_p_zs decimal(15,2);
declare variable koef_o decimal(15,7);
declare variable shifrdol integer;
begin
  /* Procedure Text */
  y=2008;
  m=1;
  dt=y||'-'||M||'-01';
 -- DELETE FROM RCLC0108;
 -- SELECT COUNT(*) FROM RCLC0108 INTO :TABNO;
  kaleNd_day=21;
  if (m=3) then
     kaleNd_day=20;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             person.razrjad,person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
                   person.shifrkat=1 and person.oklad>0.01 and
                   person.dolg not like 'надб%' and
                   person.w_place not between 151 and 168  and
                   person.w_place not in (82,105) and
                   person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,:tabno,:fio,:dolg,
                  :shifrgru,:shifrkat,:w_place,
                  :razrjad,:oklad, :w_r
  do
     begin
           ISPOVYSH=0;
           if (ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'Повыш%' or
               ltrim(dolg) like 'повиш%' or
               ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'пов%') then
               ISPOVYSH=1;
           if (tabno=4624) then
               tabno=4624;
           if (razrjad not between 15 and 24) then
               begin
                     select first 1 prim from fcn
                            where fcn.shifridperson=:shifrid and
                            fcn.shifrsta=126+500
                            and fcn.kod=100
                            and fcn.prim>0
                            into :razrjad;
                     if (razrjad is null) then  razrjad=0;
               end
           if (razrjad=0) then
              begin
                     ShifrDol=0;
                     select first 1 prim from fcn
                            where fcn.shifridperson=:shifrid and
                            fcn.shifrsta=100+500
                            and fcn.kod=100
                            and fcn.prim>0
                            into :shifrdol;
                     if (not (ShifrDol is null or ShifrDol=0)) then
                        begin
                             Razrjad= case
                                          when ShifrDol=240 then 15
                                          when ShifrDol in (190,230) then 16
                                          when ShifrDol=210 then 17
                                          when ShifrDol in (150,170) then 19
                                          when ShifrDol=110 then 20
                                          when ShifrDol=90 then 21
                                          else 0
                                      end;
                        end
              end
           if ((razrjad between 15 and 24) or (ISPOVYSH=1)) then
              begin
                    nadb_vysl_pr=0;
                    select first 1 summa from fcn
                    where fcn.shifridperson=:shifrid and
                          (fcn.shifrsta=8 or fcn.shifrsta=8+500)
 --                         and fcn.kod=100
                          into :nadb_vysl_pr;
                    if (exists (select * from fcn
                       where fcn.shifridperson=:shifrid and
                            (fcn.shifrsta=82 or fcn.shifrsta=82+500)
                             and fcn.kod=100)) then
                       cn_osn=1;
                    else
                      cn_osn=0;
                    koef=1;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                                and fcn.kod=100
                          into :koef;
                    nadb_st_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                           into :nadb_st_pr;
                    if ((ispovysh=1) and (nadb_st_pr is null or nadb_st_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                                     into :nadb_st_pr;
                        end
                    if (nadb_st_pr is null) then
                       nadb_st_pr=0;
                    nadb_zw_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=22 or fcn.shifrsta=22+500)
 --                     and fcn.kod=100
                          into :nadb_zw_pr;
                    if ((ispovysh=1) and ((nadb_zw_pr is null) or (nadb_zw_pr=0))) then
                       begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=22 or  fcn.shifrsta=22+500)
 --                              and fcn.kod=100
                                     into :nadb_zw_pr;
                       end
                    if (nadb_zw_pr is null) then
                       nadb_zw_pr=0;
                    nadb_zs_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                           into :nadb_zs_pr;
                    if ((ispovysh=1) and (nadb_zs_pr is null or nadb_zs_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m  and
                                           fcn.year_vy=:y   and
                                           (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                                     into :nadb_zs_pr;
                        end
                    if (nadb_zs_pr is null) then
                       nadb_zs_pr=0;
                    iskomp_n_o=0;
                    select count(*) from fadd 
                                    where fadd.tabno=:tabno and
                                          fadd.year_vy=:y and
                                          fadd.month_vy between 1 and 3 and
                                          fadd.shifrsta=13
                                    into  iskomp_n_o;
                    if (iskomp_n_o is null) then
                        iskomp_n_o=0;
                    if (iskomp_n_o > 1) then
                        iskomp_n_o=1;

                    select first 1 retval from work_day(:tabno,:dt) into :work_day;
                    select first 1 retval from ill_day(:tabno,:dt)  into :ill_day;
                    select first 1 retval from otp_day(:tabno,:dt)  into :otp_day;
                    if (work_day=kalend_day) then
                       select sum(a.summa) from fadd a
                              where a.shifrsta=1             and
                              a.shifridperson=:shifrid  and
                              a.month_za = :m          and
                              a.year_za=:y
                              into :OLD_VYPL_OKLAD;
                    else
                       select sum(a.summa) from fadd a
                              join person b on a.shifridperson=b.shifrid
                              where a.shifrsta=1             and
                                    a.tabno=:tabno           and
                                    a.shifrgru=:shifrgru     and
                                    a.shifrkat=:shifrkat     and
                                    a.w_place=:w_place       and
                                    a.w_r=:w_r               and
                                    b.dolg=:dolg             and
                                    a.month_za = :m          and
                                    a.year_za=:y
                              into :OLD_VYPL_OKLAD;
                    new_oklad=case
                         when razrjad=24 then 1957
                         when razrjad=22 then 1803
                         when razrjad=21 then 1756
                         when razrjad=20 then 1674
                         when razrjad=19 then 1550
                         when razrjad=17 then 1370
                         when razrjad=16 then 1288
                         when razrjad=15 then 1210
                         else 0
                     end;
                    if (nadb_st_pr is null) then
                       nadb_st_pr=0;
                    if (nadb_zw_pr is null) then
                       nadb_zw_pr=0;
                    if (nadb_zs_pr is null) then
                       nadb_zs_pr=0;
                    if (NADB_VYSL_PR is null) then
                       nadb_vysl_pr=0;
                    new_oklad      = new_oklad*koef;
                    if (iskomp_n_o=0) then
                       new_vypl_oklad = new_oklad*work_day/kalend_day;
                    else
                       begin
                            if (tabno=1383) then
                               tabno=1383;
                        --  пенсионер уволен и получил компенсация на отпуск
                            if (:oklad>0) then
                               koef_o = old_vypl_oklad / oklad;
                            else
                               koef_o = 0;
                            new_vypl_oklad = new_oklad * koef_o;
                       end
                    dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    dopl_st        = (new_vypl_oklad-old_vypl_oklAD) * nadb_st_pr/100;
                    dopl_zw        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zw_pr/100;
                    dopl_zs        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zs_pr/100;
                    dopl_vysl      = (new_vypl_oklad-old_vypl_oklAD) * nadb_vysl_pr/100;
                    dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    dopl_st        = (new_vypl_oklad-old_vypl_oklAD) * nadb_st_pr/100;
                    dopl_zw        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zw_pr/100;
                    dopl_zs        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zs_pr/100;
                    dopl_vysl      = (new_vypl_oklad-old_vypl_oklAD) * nadb_vysl_pr/100;

                    if (ISPOVYSH=1) then
                        begin
                             new_oklad      =0;
                             new_vypl_oklad = 0;
                             dopl_oklad     = 0;
                             dopl_vysl      = 0;
                             dopl_zw        = oklad*nadb_zw_pr/100;
                             dopl_st        = oklad*nadb_st_pr/100;
                             dopl_zs        = oklad*nadb_zs_pr/100;
                        end
                    insert into rclc0108 (TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  POVYSH,   DOPL_P_VYSL,
                                          DOPL_P_ST,      DOPL_P_ZW,  w_r,        cn_osn,   iskomp_n_o,
                                          nadb_zs_pr,     dopl_zs,    DOPL_P_ZS      ) VALUES(
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl, 0,       0,
                                          0,              0,          :w_r,       :cn_osn,   :iskomp_n_o,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :DOPL_P_ZS) ;
           end       -- razrjad > 0
     end
end^


ALTER PROCEDURE PR_RECALC_10
AS
declare variable m integer;
declare variable y integer;
declare variable shifrid integer;
declare variable tabno integer;
declare variable shifrgru integer;
declare variable dolg varchar(10);
declare variable fio varchar(20);
declare variable shifrkat integer;
declare variable razrjad integer;
declare variable oklad decimal(15,2);
declare variable kalend_day integer;
declare variable work_day integer;
declare variable ill_day integer;
declare variable otp_day integer;
declare variable new_oklad decimal(15,2);
declare variable old_vypl_oklad decimal(15,2);
declare variable new_vypl_oklad decimal(15,2);
declare variable w_place integer;
declare variable dt date;
declare variable koef decimal(15,2);
declare variable dopl_oklad decimal(15,2);
declare variable nadb_zw_pr decimal(15,2);
declare variable dopl_zw decimal(15,2);
declare variable nadb_st_pr decimal(15,2);
declare variable dopl_st decimal(15,2);
declare variable nadb_vysl_pr decimal(15,2);
declare variable dopl_vysl decimal(15,2);
declare variable w_r integer;
declare variable cn_osn integer;
declare variable ispovysh integer;
declare variable iskomp_n_o integer;
declare variable nadb_zs_pr decimal(15,2);
declare variable dopl_zs decimal(15,2);
declare variable dopl_p_zs decimal(15,2);
declare variable koef_o decimal(15,7);
declare variable shifrdol integer;
declare variable isindex integer;
begin
  /* Procedure Text */
  y=2010;
  m=2;
  dt=y||'-'||M||'-01';
  DELETE FROM RCLC0108 where y=:y and m=:m;
  SELECT COUNT(*) FROM RCLC0108 INTO :TABNO;
  kaleNd_day=19;
  if (m=2) then
     kaleNd_day=20;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             person.razrjad,person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
                   person.oklad>0.01 and
                   person.razrjad between 1 and 7 and
                   person.dolg not like 'надб%' and
              --     person.w_place not between 151 and 168  and
                   person.w_place not in (82,105) -- and
            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,:tabno,:fio,:dolg,
                  :shifrgru,:shifrkat,:w_place,
                  :razrjad,:oklad, :w_r
  do
     begin
           select first 1 summa from fcn
                  where fcn.shifridperson=:shifrid and
                       (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                        and fcn.kod=100
                  into :koef;
           koef=coalesce(koef,1);
           isindex=0;
           select count(*) from fadd
                  where fadd.tabno=:tabno and
                        fadd.shifridperson=:shifrid and
                        fadd.year_vy=:y and
                        fadd.month_vy=:m and
                        fadd.shifrsta=28 -- Индксация
                        into  isindex;
           isindex=coalesce(isindex,0);
                    if (iskomp_n_o is null) then
                        iskomp_n_o=0;

           select first 1 retval from work_day(:tabno,:dt) into :work_day;
           select first 1 retval from ill_day(:tabno,:dt)  into :ill_day;
           select first 1 retval from otp_day(:tabno,:dt)  into :otp_day;
           if (work_day=kalend_day) then
               select sum(a.summa) from fadd a
                      where a.shifrsta=1             and
                            a.shifridperson=:shifrid and
                            a.month_za = :m          and
                           a.year_za   = :y
                      into :OLD_VYPL_OKLAD;
                    else
                       select sum(a.summa) from fadd a
                              join person b on a.shifridperson=b.shifrid
                              where a.shifrsta=1             and
                                    a.tabno=:tabno           and
                                    a.shifrgru=:shifrgru     and
                                    a.shifrkat=:shifrkat     and
                                    a.w_place=:w_place       and
                                    a.w_r=:w_r               and
                                    b.dolg=:dolg             and
                                    a.month_za = :m          and
                                    a.year_za=:y
                              into :OLD_VYPL_OKLAD;
                    new_oklad=869 * koef;
                    new_vypl_oklad=new_oklad;
                    if (work_day<kalend_day) then
                       new_vypl_oklad=new_oklad * work_day / kalend_day;
                    dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    if ((old_vypl_oklad is not null) and (old_vypl_oklad>1)) then
                    insert into rclc0108 (TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  POVYSH,   DOPL_P_VYSL,
                                          DOPL_P_ST,      DOPL_P_ZW,  w_r,        cn_osn,   iskomp_n_o,
                                          nadb_zs_pr,     dopl_zs,    DOPL_P_ZS,  y,        m        ) VALUES(
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl, 0,       0,
                                          0,              0,          :w_r,       :cn_osn,   :iskomp_n_o,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :DOPL_P_ZS, :y,   :m) ;

     end
end^


ALTER PROCEDURE PR_RECALC_10_2 (
    Y INTEGER,
    M INTEGER)
AS
declare variable SHIFRID integer;
declare variable TABNO integer;
declare variable SHIFRGRU integer;
declare variable DOLG varchar(10);
declare variable FIO varchar(20);
declare variable SHIFRKAT integer;
declare variable RAZRJAD integer;
declare variable OKLAD decimal(15,2);
declare variable KALEND_DAY integer;
declare variable WORK_DAY integer;
declare variable ILL_DAY integer;
declare variable OTP_DAY integer;
declare variable NEW_OKLAD decimal(15,2);
declare variable OLD_VYPL_OKLAD decimal(15,2);
declare variable NEW_VYPL_OKLAD decimal(15,2);
declare variable W_PLACE integer;
declare variable DT date;
declare variable KOEF decimal(15,2);
declare variable DOPL_OKLAD decimal(15,2);
declare variable NADB_ZW_PR decimal(15,2);
declare variable DOPL_ZW decimal(15,2);
declare variable NADB_ST_PR decimal(15,2);
declare variable DOPL_ST decimal(15,2);
declare variable NADB_VYSL_PR decimal(15,2);
declare variable DOPL_VYSL decimal(15,2);
declare variable W_R integer;
declare variable CN_OSN integer;
declare variable ISPOVYSH integer;
declare variable ISKOMP_N_O integer;
declare variable NADB_ZS_PR decimal(15,2);
declare variable DOPL_ZS decimal(15,2);
declare variable DOPL_P_ZS decimal(15,2);
declare variable KOEF_O decimal(15,7);
declare variable SHIFRDOL integer;
begin
  /* Procedure Text */
 -- y=2010;
 -- m=1;
  dt=y||'-'||M||'-01';
  DELETE FROM RCLC0110 where y=:y and m=:m;
  SELECT COUNT(*) FROM RCLC0110 INTO :TABNO;
  kalend_day=case
      when m=1 then 19
      when m=2 then 20
      when m=3 then 22
      when m=4 then 21
      when m=7 then 22
      else 0
  end;
  if (kalend_day=0) then
     exit;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             person.razrjad,person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
      --             person.shifrkat=1 and person.oklad>0.01 and
                   person.dolg not like 'надб%' and
              --     person.w_place not between 151 and 168  and
                   person.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140)-- and
            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,:tabno,:fio,:dolg,
                  :shifrgru,:shifrkat,:w_place,
                  :razrjad,:oklad, :w_r
  do
     begin
           ISPOVYSH=0;
           if (ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'Повыш%' or
               ltrim(dolg) like 'повиш%' or
               ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'під%'   or
               ltrim(dolg) like 'пов%') then
               ISPOVYSH=1;
           if (tabno=4624) then
               tabno=4624;
           if (razrjad not between 1 and 24) then
               begin
                     select first 1 prim from fcn
                            where fcn.shifridperson=:shifrid and
                            fcn.shifrsta=126+500
                            and fcn.kod=100
                            and fcn.prim>0
                            into :razrjad;
                     razrjad=coalesce(razrjad,0);
               end
           ShifrDol=0;
           select first 1 prim from fcn
                  where fcn.shifridperson=:shifrid and
                        fcn.shifrsta=100+500
                        and fcn.kod=100
                        and fcn.prim>0
                        into :shifrdol;
           shifrdol=coalesce(shifrdol, 0);
           if (razrjad=0) then
              begin
                     if (ShifrDol>0) then
                        begin
                             Razrjad= case
                                          when ShifrDol=240 then 15
                                          when ShifrDol in (190,230) then 16
                                          when ShifrDol=210 then 17
                                          when ShifrDol in (150,170) then 19
                                          when ShifrDol=110 then 20
                                          when ShifrDol=90 then 21
                                          else 0
                                      end;
                        end
              end
           if ((razrjad between 1 and 24) or (ISPOVYSH=1)) then
              begin
                    nadb_vysl_pr=0;    -- процент надбавки за вислугу
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=8 or fcn.shifrsta=8+500)
 --                         and fcn.kod=100
                          into :nadb_vysl_pr;
                    nadb_vysl_pr=coalesce(nadb_vysl_pr,0);
                    if (exists (select * from fcn
                                where fcn.shifridperson=:shifrid and
                                     (fcn.shifrsta=82 or fcn.shifrsta=82+500)
                                      and fcn.kod=100)) then
                       cn_osn=1; -- оcновное место работы
                    else
                      cn_osn=0;
                    koef=1;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                                and fcn.kod=100
                          into :koef;
                    koef=coalesce(koef,1);
                    nadb_st_pr=0;      -- процент надбавки за степень
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                           into :nadb_st_pr;
                    nadb_st_pr=coalesce(nadb_st_pr,0);
                    if ((ispovysh=1) and (nadb_st_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                                     into :nadb_st_pr;
                        end
                    nadb_st_pr=coalesce(nadb_st_pr,0);
                    nadb_zw_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=22 or fcn.shifrsta=22+500)
 --                     and fcn.kod=100
                          into :nadb_zw_pr;
                    nadb_zw_pr=coalesce(nadb_zw_pr,0);
                    if ((ispovysh=1) and (nadb_zw_pr=0)) then
                       begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=22 or  fcn.shifrsta=22+500)
 --                              and fcn.kod=100
                                     into :nadb_zw_pr;
                       end
                    nadb_zw_pr=coalesce(nadb_zw_pr,0);
                    nadb_zs_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                           into :nadb_zs_pr;
                    nadb_zs_pr=coalesce(nadb_zs_pr,0);
                    if ((ispovysh=1) and (nadb_zs_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m  and
                                           fcn.year_vy=:y   and
                                           (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                                     into :nadb_zs_pr;
                        end
                    nadb_zs_pr=coalesce(nadb_zs_pr,0);
                    iskomp_n_o=0;
            ---        select count(*) from fadd
            ---                        where fadd.tabno=:tabno and
            ---                              fadd.year_vy=:y and
            ---                              fadd.month_vy between 1 and 3 and
            ---                              fadd.shifrsta=13
            ---                        into  iskomp_n_o; -- компенсация за неисп отпуск
            ---        iskomp_n_o=coalesce(iskomp_n_o,0);
            ---        if (iskomp_n_o > 1) then
            ---            iskomp_n_o=1;

                    select first 1 retval from work_day(:tabno,:dt) into :work_day;
                    select first 1 retval from ill_day(:tabno,:dt)  into :ill_day;
                    select first 1 retval from otp_day(:tabno,:dt)  into :otp_day;
                    work_day=coalesce(work_day,0);
                    if ((:work_day=0) and (:otp_day=0)) then
                       select first 1 retval from work_day_for_sowm(:tabno,:dt) into :work_day;
                    OLD_VYPL_OKLAD=0;
              ---      if (work_day=kalend_day) then
                       begin
                             select sum(a.summa) from fadd a
                                    where a.shifrsta=1        and
                                    a.shifridperson=:shifrid  and
                                    a.month_za = :m           and
                                    a.year_za=:y
                                    into :OLD_VYPL_OKLAD;
                             Old_Vypl_Oklad=coalesce(Old_Vypl_Oklad,0);
                       end
/*
                    if ((work_day<kalend_day) or (Old_Vypl_Oklad<0.01))  then
                       select sum(a.summa) from fadd a
                              join person b on a.shifridperson=b.shifrid
                              where a.shifrsta=1             and
                                    a.tabno=:tabno           and
                                    a.shifrgru=:shifrgru     and
                                    a.shifrkat=:shifrkat     and
                                    a.w_place=:w_place       and
                                    a.w_r=:w_r               and
                                    b.dolg=:dolg             and
                                    b.shifrkat=:shifrkat     and
                                    b.shifrgru=:shifrgru     and
                                    a.month_za = :m          and
                                    a.year_za  = :y
                              into :OLD_VYPL_OKLAD;
                    OLD_VYPL_OKLAD=coalesce(OLD_VYPL_OKLAD,0);
*/
                    select first 1 a.oklad from tb_razr_proc a
                                           where a.razr=:razrjad
                                           order by a.datefr desc
                                           into new_oklad;
                    new_oklad=coalesce(new_oklad,0);
                    nadb_st_pr   = coalesce(nadb_st_pr,0);
                    nadb_zw_pr   = coalesce(nadb_zw_pr,0);
                    nadb_zs_pr   = coalesce(nadb_zs_pr,0);
                    nadb_vysl_pr = coalesce(nadb_vysl_pr,0);
                    new_oklad    = new_oklad*koef;
        ---            if (iskomp_n_o=0) then
                       new_vypl_oklad = new_oklad*work_day/kalend_day;
        ---            else
        ---               begin
        ---                    if (tabno=1383) then
        ---                       tabno=1383;
        ---                --  пенсионер уволен и получил компенсация на отпуск
        ---                    if (:oklad>0) then
        ---                       koef_o = old_vypl_oklad / oklad;
        ---                    else
        ---                       koef_o = 0;
        ---                    new_vypl_oklad = new_oklad * koef_o;
        ---               end
      --              dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
      --              dopl_st        = (new_vypl_oklad-old_vypl_oklAD) * nadb_st_pr/100;
      --              dopl_zw        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zw_pr/100;
      --              dopl_zs        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zs_pr/100;
      --              dopl_vysl      = (new_vypl_oklad-old_vypl_oklAD) * nadb_vysl_pr/100;
       -- Изменения от 24 05 2010
       -- если work_day<kalend_day и старый выплаченый= старому требуемому
       -- то и новый выплаченый = новому требуемому
                    if ((work_day<kalend_day)
                        and (oklad>0.01)
                        and (oklad=old_vypl_oklad)
                        and (new_oklad>oklad)
                        and ((new_vypl_oklad<old_vypl_oklad) or (new_vypl_oklad is null)))
                        then
                            begin
                                 new_vypl_oklad=new_oklad;
                                 dopl_oklad=new_vypl_oklad-old_vypl_oklad;
                            end
        -- конец изменений от 24 05 10

       -- Изменения от 14 08 2010
       -- если dopl_oklad<0 т е (new_vypl_oklad<old_vypl_oklad)
       -- то и новый выплаченый оклад рассчитать из пропроции со старым
                    dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    if (((new_vypl_oklad<old_vypl_oklad) and
                         (old_vypl_oklad>0.01) and
                         (oklad>0 )) or ((work_day=kalend_day) and (otp_day>0))
                         ) then
                            begin
                                 new_vypl_oklad=new_oklad * old_vypl_oklad / oklad;
                                 dopl_oklad=new_vypl_oklad-old_vypl_oklad;
                            end
                    if ((old_vypl_oklad<=0) and (oklad>0)) then
                       begin
                            new_vypl_oklad = 0;
                            dopl_oklad     = 0;
                       end
        -- конец изменений от 14 08 10



                   -- dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    dopl_st        = (new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100;
                    dopl_zw        = (new_vypl_oklad-old_vypl_oklad) * nadb_zw_pr/100;
                    dopl_zs        = (new_vypl_oklad-old_vypl_oklad) * nadb_zs_pr/100;
                    dopl_vysl      = (new_vypl_oklad-old_vypl_oklad) * nadb_vysl_pr/100;

                    if (ISPOVYSH=1) then
                        begin
                             new_oklad      =0;
                             new_vypl_oklad = 0;
                             dopl_oklad     = 0;
                             dopl_vysl      = 0;
                             dopl_zw        = oklad*nadb_zw_pr/100;
                             dopl_st        = oklad*nadb_st_pr/100;
                             dopl_zs        = oklad*nadb_zs_pr/100;
                        end
                    if ((ISPOVYSH=0) and
                        (Oklad>0.01) and
                        (Oklad is not null)) then
                    insert into rclc0110 (TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  POVYSH,   DOPL_P_VYSL,
                                          DOPL_P_ST,      DOPL_P_ZW,  w_r,        cn_osn,   iskomp_n_o,
                                          nadb_zs_pr,     dopl_zs,    DOPL_P_ZS , y ,       m,
                                          shifrdol     ) VALUES(
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl, 0,       0,
                                          0,              0,          :w_r,       :cn_osn,   :iskomp_n_o,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :DOPL_P_ZS ,:Y ,       :M,
                                          :shifrdol) ;
           end       -- razrjad > 0
     end
end^


ALTER PROCEDURE PR_RECALC_10N (
    Y INTEGER,
    M INTEGER)
AS
declare variable shifrid integer;
declare variable tabno integer;
declare variable shifrgru integer;
declare variable dolg varchar(10);
declare variable fio varchar(20);
declare variable shifrkat integer;
declare variable razrjad integer;
declare variable oklad decimal(15,2);
declare variable kalend_day integer;
declare variable work_day integer;
declare variable ill_day integer;
declare variable otp_day integer;
declare variable new_oklad decimal(15,2);
declare variable old_vypl_oklad decimal(15,2);
declare variable new_vypl_oklad decimal(15,2);
declare variable w_place integer;
declare variable dt date;
declare variable koef decimal(15,2);
declare variable dopl_oklad decimal(15,2);
declare variable nadb_zw_pr decimal(15,2);
declare variable dopl_zw decimal(15,2);
declare variable nadb_st_pr decimal(15,2);
declare variable dopl_st decimal(15,2);
declare variable nadb_vysl_pr decimal(15,2);
declare variable dopl_vysl decimal(15,2);
declare variable w_r integer;
declare variable cn_osn integer;
declare variable ispovysh integer;
declare variable iskomp_n_o integer;
declare variable nadb_zs_pr decimal(15,2);
declare variable dopl_zs decimal(15,2);
declare variable dopl_p_zs decimal(15,2);
declare variable koef_o decimal(15,7);
declare variable shifrdol integer;
begin
  /* Procedure Text */
 -- y=2010;
 -- m=1;
  dt=y||'-'||M||'-01';
  DELETE FROM RCLC0110 where y=:y and m=:m;
  SELECT COUNT(*) FROM RCLC0110 INTO :TABNO;
  kalend_day=case
      when m=1 then 19
      when m=2 then 20
      when m=3 then 22
      when m=4 then 21
      else 0
  end;
  if (kalend_day=0) then
     exit;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             person.razrjad,person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
      --             person.shifrkat=1 and person.oklad>0.01 and
                   person.dolg not like 'надб%' and
                   person.w_place not between 151 and 168  and
                   person.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140)-- and
            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,:tabno,:fio,:dolg,
                  :shifrgru,:shifrkat,:w_place,
                  :razrjad,:oklad, :w_r
  do
     begin
           ISPOVYSH=0;
           if (ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'Повыш%' or
               ltrim(dolg) like 'повиш%' or
               ltrim(dolg) like 'повыш%' or
               ltrim(dolg) like 'під%'   or
               ltrim(dolg) like 'пов%') then
               ISPOVYSH=1;
           if (tabno=4624) then
               tabno=4624;
           if (razrjad not between 8 and 24) then
               begin
                     select first 1 prim from fcn
                            where fcn.shifridperson=:shifrid and
                            fcn.shifrsta=126+500
                            and fcn.kod=100
                            and fcn.prim>0
                            into :razrjad;
                     if (razrjad is null) then  razrjad=0;
               end
           if (razrjad=0) then
              begin
                     ShifrDol=0;
                     select first 1 prim from fcn
                            where fcn.shifridperson=:shifrid and
                            fcn.shifrsta=100+500
                            and fcn.kod=100
                            and fcn.prim>0
                            into :shifrdol;
                     if (not (ShifrDol is null or ShifrDol=0)) then
                        begin
                             Razrjad= case
                                          when ShifrDol=240 then 15
                                          when ShifrDol in (190,230) then 16
                                          when ShifrDol=210 then 17
                                          when ShifrDol in (150,170) then 19
                                          when ShifrDol=110 then 20
                                          when ShifrDol=90 then 21
                                          else 0
                                      end;
                        end
              end
           if ((razrjad between 8 and 24) or (ISPOVYSH=1)) then
              begin
                    nadb_vysl_pr=0;
                    select first 1 summa from fcn
                    where fcn.shifridperson=:shifrid and
                          (fcn.shifrsta=8 or fcn.shifrsta=8+500)
 --                         and fcn.kod=100
                          into :nadb_vysl_pr;
                    if (exists (select * from fcn
                       where fcn.shifridperson=:shifrid and
                            (fcn.shifrsta=82 or fcn.shifrsta=82+500)
                             and fcn.kod=100)) then
                       cn_osn=1;
                    else
                      cn_osn=0;
                    koef=1;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                                and fcn.kod=100
                          into :koef;
                    nadb_st_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                           into :nadb_st_pr;
                    if ((ispovysh=1) and (nadb_st_pr is null or nadb_st_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
 --                              and fcn.kod=100
                                     into :nadb_st_pr;
                        end
                    if (nadb_st_pr is null) then
                       nadb_st_pr=0;
                    nadb_zw_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=22 or fcn.shifrsta=22+500)
 --                     and fcn.kod=100
                          into :nadb_zw_pr;
                    if ((ispovysh=1) and ((nadb_zw_pr is null) or (nadb_zw_pr=0))) then
                       begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m and
                                           fcn.year_vy=:y and
                                           (fcn.shifrsta=22 or  fcn.shifrsta=22+500)
 --                              and fcn.kod=100
                                     into :nadb_zw_pr;
                       end
                    if (nadb_zw_pr is null) then
                       nadb_zw_pr=0;
                    nadb_zs_pr=0;
                    select first 1 summa from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                           into :nadb_zs_pr;
                    if ((ispovysh=1) and (nadb_zs_pr is null or nadb_zs_pr=0))  then
                        begin
                              select first 1 summa from fcn
                                     where fcn.tabno=:tabno and
                                           fcn.month_vy=:m  and
                                           fcn.year_vy=:y   and
                                           (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
 --                              and fcn.kod=100
                                     into :nadb_zs_pr;
                        end
                    if (nadb_zs_pr is null) then
                       nadb_zs_pr=0;
                    iskomp_n_o=0;
                    select count(*) from fadd 
                                    where fadd.tabno=:tabno and
                                          fadd.year_vy=:y and
                                          fadd.month_vy between 1 and 3 and
                                          fadd.shifrsta=13
                                    into  iskomp_n_o;
                    if (iskomp_n_o is null) then
                        iskomp_n_o=0;
                    if (iskomp_n_o > 1) then
                        iskomp_n_o=1;

                    select first 1 retval from work_day(:tabno,:dt) into :work_day;
                    select first 1 retval from ill_day(:tabno,:dt)  into :ill_day;
                    select first 1 retval from otp_day(:tabno,:dt)  into :otp_day;
                    work_day=coalesce(work_day,0);
                    if (:work_day=0) then
                       select first 1 retval from work_day_for_sowm(:tabno,:dt) into :work_day;
                    OLD_VYPL_OKLAD=0;
                    if (work_day=kalend_day) then
                       begin
                             select sum(a.summa) from fadd a
                                    where a.shifrsta=1        and
                                    a.shifridperson=:shifrid  and
                                    a.month_za = :m           and
                                    a.year_za=:y
                                    into :OLD_VYPL_OKLAD;
                             Old_Vypl_Oklad=coalesce(Old_Vypl_Oklad,0);
                       end
                    if ((work_day<kalend_day) or (Old_Vypl_Oklad<0.01))  then
                       select sum(a.summa) from fadd a
                              join person b on a.shifridperson=b.shifrid
                              where a.shifrsta=1             and
                                    a.tabno=:tabno           and
                                    a.shifrgru=:shifrgru     and
                                    a.shifrkat=:shifrkat     and
                                    a.w_place=:w_place       and
                                    a.w_r=:w_r               and
                                    b.dolg=:dolg             and
                                    b.shifrkat=:shifrkat     and
                                    b.shifrgru=:shifrgru     and
                                    a.month_za = :m          and
                                    a.year_za  = :y
                              into :OLD_VYPL_OKLAD;
                    OLD_VYPL_OKLAD=coalesce(OLD_VYPL_OKLAD,0);
                    new_oklad=case
                         when m in (1,2,3) then
                              case
                                   when razrjad=24 then 2420
                                   when razrjad=23 then 2370
                                   when razrjad=22 then 2253
                                   when razrjad=21 then 2137
                                   when razrjad=20 then 2020
                                   when razrjad=19 then 1898
                                   when razrjad=18 then 1782
                                   when razrjad=17 then 1655
                                   when razrjad=16 then 1548
                                   when razrjad=15 then 1432
                                   when razrjad=14 then 1343
                                   when razrjad=13 then 1260
                                   when razrjad=12 then 1177
                                   when razrjad=11 then 1093
                                   when razrjad=10 then 1010
                                   when razrjad=9 then 960
                                   when razrjad=8 then 910
                                   else 0
                             end
                         when m =4  then
                              case
                                   when razrjad=24 then 2472
                                   when razrjad=23 then 2421
                                   when razrjad=22 then 2302
                                   when razrjad=21 then 2183
                                   when razrjad=20 then 2064
                                   when razrjad=19 then 1939
                                   when razrjad=18 then 1820
                                   when razrjad=17 then 1701
                                   when razrjad=16 then 1582
                                   when razrjad=15 then 1463
                                   when razrjad=14 then 1372
                                   when razrjad=13 then 1287
                                   when razrjad=12 then 1202
                                   when razrjad=11 then 1117
                                   when razrjad=10 then 1032
                                   when razrjad=9 then 981
                                   when razrjad=8 then 930
                                   else 0
                             end
                     end;
                    nadb_st_pr   = coalesce(nadb_st_pr,0);
                    nadb_zw_pr   = coalesce(nadb_zw_pr,0);
                    nadb_zs_pr   = coalesce(nadb_zs_pr,0);
                    nadb_vysl_pr = coalesce(nadb_vysl_pr,0);
                    new_oklad    = new_oklad*koef;
                    if (iskomp_n_o=0) then
                       new_vypl_oklad = new_oklad*work_day/kalend_day;
                    else
                       begin
                            if (tabno=1383) then
                               tabno=1383;
                        --  пенсионер уволен и получил компенсация на отпуск
                            if (:oklad>0) then
                               koef_o = old_vypl_oklad / oklad;
                            else
                               koef_o = 0;
                            new_vypl_oklad = new_oklad * koef_o;
                       end
      --              dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
      --              dopl_st        = (new_vypl_oklad-old_vypl_oklAD) * nadb_st_pr/100;
      --              dopl_zw        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zw_pr/100;
      --              dopl_zs        = (new_vypl_oklad-old_vypl_oklAD) * nadb_zs_pr/100;
      --              dopl_vysl      = (new_vypl_oklad-old_vypl_oklAD) * nadb_vysl_pr/100;
       -- Изменения от 24 05 2010
       -- если work_day<kalend_day и старый выплаченый= старому требуемому
       -- то и новый выплаченый = новому требуемому
                    if ((work_day<kalend_day)
                        and (oklad>0.01)
                        and (oklad=old_vypl_oklad)
                        and (new_oklad>oklad)
                        and ((new_vypl_oklad<old_vypl_oklad) or (new_vypl_oklad is null)))
                        then
                            begin
                                 new_vypl_oklad=new_oklad;
                                 dopl_oklad=new_vypl_oklad-old_vypl_oklad;
                            end
        -- конец изменений от 24 05 10



                    dopl_oklad     = new_vypl_oklad-old_vypl_oklad;
                    dopl_st        = (new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100;
                    dopl_zw        = (new_vypl_oklad-old_vypl_oklad) * nadb_zw_pr/100;
                    dopl_zs        = (new_vypl_oklad-old_vypl_oklad) * nadb_zs_pr/100;
                    dopl_vysl      = (new_vypl_oklad-old_vypl_oklad) * nadb_vysl_pr/100;

                    if (ISPOVYSH=1) then
                        begin
                             new_oklad      =0;
                             new_vypl_oklad = 0;
                             dopl_oklad     = 0;
                             dopl_vysl      = 0;
                             dopl_zw        = oklad*nadb_zw_pr/100;
                             dopl_st        = oklad*nadb_st_pr/100;
                             dopl_zs        = oklad*nadb_zs_pr/100;
                        end
                    if ((ISPOVYSH=0) and
                        (Oklad>0.01) and
                        (Oklad is not null)) then
                    insert into rclc0110 (TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  POVYSH,   DOPL_P_VYSL,
                                          DOPL_P_ST,      DOPL_P_ZW,  w_r,        cn_osn,   iskomp_n_o,
                                          nadb_zs_pr,     dopl_zs,    DOPL_P_ZS ,y ,m     ) VALUES(
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl, 0,       0,
                                          0,              0,          :w_r,       :cn_osn,   :iskomp_n_o,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :DOPL_P_ZS ,:Y ,:M) ;
           end       -- razrjad > 0
     end
end^


ALTER PROCEDURE PR_RECALC_13_1_2 (
    Y INTEGER,
    M INTEGER)
AS
declare variable SHIFRID integer;
declare variable TABNO integer;
declare variable SHIFRGRU integer;
declare variable DOLG varchar(10);
declare variable FIO varchar(20);
declare variable SHIFRKAT integer;
declare variable RAZRJAD integer;
declare variable OKLAD decimal(15,2);
declare variable KALEND_DAY integer;
declare variable WORK_DAY integer;
declare variable ILL_DAY integer;
declare variable OTP_DAY integer;
declare variable NEW_OKLAD decimal(15,2);
declare variable OLD_VYPL_OKLAD decimal(15,2);
declare variable NEW_VYPL_OKLAD decimal(15,2);
declare variable W_PLACE integer;
declare variable DT date;
declare variable KOEF decimal(15,2);
declare variable DOPL_OKLAD decimal(15,2);
declare variable NADB_ZW_PR decimal(15,2);
declare variable DOPL_ZW decimal(15,2);
declare variable NADB_ST_PR decimal(15,2);
declare variable DOPL_ST decimal(15,2);
declare variable NADB_VYSL_PR decimal(15,2);
declare variable DOPL_VYSL decimal(15,2);
declare variable W_R integer;
declare variable CN_OSN integer;
declare variable NADB_ZS_PR decimal(15,2);
declare variable DOPL_ZS decimal(15,2);
declare variable KOEF_O decimal(15,7);
declare variable SHIFRDOL integer;
declare variable GUID varchar(30);
declare variable DOPL_ZAM_DEK decimal(10,2);
declare variable NADB_ZAM_DEK_PR decimal(10,2);
declare variable NADB_ZAW_KAF_PR decimal(10,2);
declare variable DOPL_ZAW_KAF decimal(10,2);
declare variable SHIFRIDRCLC integer;
declare variable NAMESTA varchar(30);
begin
  /* Перерасчет начислений в апр 2013 за янв и фвр 13-го из-за повыш окладов задним числом */
 -- y=2013;
 -- m=1;
  dt=y||'-'||M||'-01';
  DELETE FROM TB_RCLC1301 where y=:y and m=:m;
  SELECT COUNT(*) FROM TB_RCLC1301 INTO :TABNO;
  kalend_day=case
      when m=1 then 21
      when m=2 then 20
      when m=3 then 20
      else 0
  end;
  if (kalend_day=0) then
     exit;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             coalesce(person.razrjad,0),person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
      --             person.shifrkat=1 and person.oklad>0.01 and
                   person.dolg not like 'надб%' and
              --     person.w_place not between 151 and 168  and
                   person.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140) and
                 -- Надбавки не перерасчитывать код должности  - 5
                   (select first 1 shifriddolg from pr_get_dolg_person_by_id(person.shifrid)) not in (5,1455) -- 1455  почасовка

            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,  :tabno,    :fio, :dolg,
                  :shifrgru, :shifrkat, :w_place,
                  :razrjad,  :oklad,    :w_r
  do
     begin
           if (tabno=1356) then
               tabno=1356;
           if (razrjad not between 1 and 24) then
              select first 1 prim from fcn
                     where fcn.shifridperson=:shifrid
                       and fcn.shifrsta=126+500
                       and fcn.kod=100
                       and fcn.prim>0
                     into :razrjad;
           ShifrDol=0;
           select first 1 coalesce(prim,0) from fcn
                  where fcn.shifridperson=:shifrid and
                        fcn.shifrsta=100+500
                        and fcn.kod=100
                        and fcn.prim>0
                        into :shifrdol;
           select coalesce(a.guid,'') from pr_GETGUID(:shifrid,0) a into :guid;
           if ((razrjad=0) and (ShifrDol>0)) then
              Razrjad= case
                           when ShifrDol=240 then 15
                           when ShifrDol in (190,230) then 16
                           when ShifrDol=210 then 17
                           when ShifrDol in (150,170) then 19
                           when ShifrDol=110 then 20
                           when ShifrDol=90 then 21
                           else 0
                       end;
           if ((razrjad between 1 and 24)) then
              begin
                    nadb_vysl_pr=0;    -- процент надбавки за вислугу
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=8 or fcn.shifrsta=8+500)
 --                         and fcn.kod=100
                          into :nadb_vysl_pr;
                    if (exists (select * from fcn
                                where fcn.shifridperson=:shifrid and
                                     (fcn.shifrsta=82 or fcn.shifrsta=82+500)
                                      and fcn.kod=100)) then
                       cn_osn=1; -- оcновное место работы
                    else
                      cn_osn=0;
                    koef=1;
                    select first 1 coalesce(summa,1.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                                and fcn.kod=100
                          into :koef;
                    nadb_st_pr=0;      -- процент надбавки за степень
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
                           into :nadb_st_pr;
                    nadb_zw_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=22 or fcn.shifrsta=22+500)
                          into :nadb_zw_pr;
                    nadb_zs_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
                           into :nadb_zs_pr;
                    nadb_zam_dek_pr = 0;
                    dopl_zam_dek    = 0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=42 or  fcn.shifrsta=42+500)
                           into :nadb_zam_dek_pr;

                    nadb_zaw_kaf_pr = 0;
                    dopl_zaw_kaf    = 0;
--                    select first 1 coalesce(summa,0.00) from fcn
--                           where fcn.shifridperson=:shifrid and
--                                 (fcn.shifrsta=42 or  fcn.shifrsta=42+500)
--                           into :nadb_zaw_kaf_pr;

                    select first 1 coalesce(retval,0) from work_day(:tabno,:dt) into :work_day;
                    select first 1 coalesce(retval,0) from ill_day(:tabno,:dt)  into :ill_day;
                    select first 1 coalesce(retval,0) from otp_day(:tabno,:dt)  into :otp_day;
                    if ((:work_day=0) and (:otp_day=0)) then
                       select first 1 coalesce(retval,0) from work_day_for_sowm(:tabno,:dt) into :work_day;
                    OLD_VYPL_OKLAD=0;

                    select sum(a.summa) from fadd a
                           where a.shifrsta=1
                             and a.shifridperson=:shifrid
                             and a.month_za = :m
                             and a.year_za=:y
                           into :OLD_VYPL_OKLAD;

/*
                    select sum(a.summa) from fadd a
                           where a.shifrsta=1
                             and (
                                  ((strlen(trim(:guid))>0) and (trim((select first 1 coalesce(guid,'') from pr_getguid(a.shifridperson,0)))
                                                               =trim(:guid))) or
                                  ((strlen(trim(:guid))=0) and (a.shifridperson=:shifrid))
                                                               
                                 )
                             and a.month_za = :m
                             and a.year_za=:y
                           into :OLD_VYPL_OKLAD;
*/
                    select first 1 coalesce(a.oklad,0) from tb_razr_proc a
                                           where a.razr=:razrjad
                                           order by a.datefr desc
                                           into new_oklad;
-- проверка проректоров
                    if (ShifrDol in (20,30,40)) then
                       begin
                            select first 1 coalesce(a.oklad,0) from tb_razr_proc a
                                           where a.razr=24
                                           order by a.datefr desc
                                           into new_oklad;
                            new_oklad=cast(new_oklad*0.95 as decimal(12,2));
                       end
                    new_oklad    = new_oklad*koef;
                    new_vypl_oklad = new_oklad*work_day/kalend_day;
                    dopl_oklad     = coalesce((new_vypl_oklad-old_vypl_oklad),0.00);
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    dopl_zw        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zw_pr/100,0.00);
                    dopl_zs        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zs_pr/100,0.00);
                    dopl_vysl      = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_vysl_pr/100,0.00);
                    dopl_zam_dek   = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zam_dek_pr/100,0.00);

--                  dopl_zaw_kaf   = (new_vypl_oklad-old_vypl_oklad) * nadb_zaw_kaf_pr/100;

                    SHIFRIDRCLC=GEN_ID(g_rclc_08,1);

                    insert into TB_RCLC1301 (SHIFRID, TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  nadb_zam_dek_pr,   DOPL_ZAM_DEK,
                                          NADB_ZAW_KAF_PR,  DOPL_ZAW_KAF,  w_r,        cn_osn,
                                          nadb_zs_pr,     dopl_zs,    y ,       m,
                                          shifrdol,guid     ) VALUES(
                                          :SHIFRIDRCLC,
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl,:NADB_ZAM_DEK_PR, :DOPL_ZAM_DEK,
                                          :NADB_ZAW_KAF_PR,:DOPL_ZAW_KAF,          :w_r,       :cn_osn,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :Y ,       :M,
                                          :shifrdol,:guid) ;
                    /*надбавка за степень */
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=18 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 18,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    /*надбавка за звание */
                    if (abs(dopl_zw)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=22 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 22,:nadb_zw_pr,:dopl_zw, :namesta);
                       end
                    /*надбавка за зв. заслуженного */
                    if (abs(dopl_zs)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=17 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 17,:nadb_zs_pr,:dopl_zs, :namesta);
                       end
                    /*надбавка за выслугу */
                    if (abs(dopl_vysl)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=8 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 8,:nadb_vysl_pr,:dopl_vysl, :namesta);
                       end
                    /* надбавка за зам декана */
                    if (abs(dopl_zam_dek)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=42 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 42,:nadb_zam_dek_pr,:dopl_zam_dek, :namesta);
                       end

                    /* 7-й шифр  */

                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=7 or  fcn.shifrsta=7+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=7 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 7,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=30 or  fcn.shifrsta=30+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=30 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 30,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=33 or  fcn.shifrsta=33+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=33 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 33,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=41 or  fcn.shifrsta=41+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=41 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 41,:nadb_st_pr,:dopl_st, :namesta);
                       end



           end       -- razrjad > 0
     end
end^


ALTER PROCEDURE PR_RECALC_15_9_SVDN (
    Y INTEGER,
    M INTEGER)
AS
declare variable SHIFRID integer;
declare variable TABNO integer;
declare variable SHIFRGRU integer;
declare variable DOLG varchar(10);
declare variable FIO varchar(20);
declare variable SHIFRKAT integer;
declare variable RAZRJAD integer;
declare variable OKLAD decimal(15,2);
declare variable KALEND_DAY integer;
declare variable WORK_DAY integer;
declare variable ILL_DAY integer;
declare variable OTP_DAY integer;
declare variable NEW_OKLAD decimal(15,2);
declare variable OLD_VYPL_OKLAD decimal(15,2);
declare variable NEW_VYPL_OKLAD decimal(15,2);
declare variable W_PLACE integer;
declare variable DT date;
declare variable KOEF decimal(15,2);
declare variable DOPL_OKLAD decimal(15,2);
declare variable NADB_ZW_PR decimal(15,2);
declare variable DOPL_ZW decimal(15,2);
declare variable NADB_ST_PR decimal(15,2);
declare variable DOPL_ST decimal(15,2);
declare variable NADB_VYSL_PR decimal(15,2);
declare variable DOPL_VYSL decimal(15,2);
declare variable W_R integer;
declare variable CN_OSN integer;
declare variable NADB_ZS_PR decimal(15,2);
declare variable DOPL_ZS decimal(15,2);
declare variable KOEF_O decimal(15,7);
declare variable SHIFRDOL integer;
declare variable GUID varchar(30);
declare variable DOPL_ZAM_DEK decimal(10,2);
declare variable NADB_ZAM_DEK_PR decimal(10,2);
declare variable NADB_ZAW_KAF_PR decimal(10,2);
declare variable DOPL_ZAW_KAF decimal(10,2);
declare variable SHIFRIDRCLC integer;
declare variable NAMESTA varchar(30);
declare variable KOEFR numeric(15,2);
declare variable OKLAD_RAZR_OLD numeric(15,2);
begin
  /* Перерасчет начислений в апр 2013 за янв и фвр 13-го из-за повыш окладов задним числом */
 -- y=2013;
 -- m=1;
  dt=y||'-'||M||'-01';
  DELETE FROM TB_RCLC1301 where y=:y and m=:m;
  SELECT COUNT(*) FROM TB_RCLC1301 INTO :TABNO;
  kalend_day=case
      when m=9 then 22
      else 0
  end;
  if (kalend_day=0) then
     exit;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             coalesce(person.razrjad,0),person.oklad,person.w_r from person
             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
      --             person.shifrkat=1 and person.oklad>0.01 and
                   person.dolg not like 'надб%' and
              --     person.w_place not between 151 and 168  and
                   person.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140) and
                 -- Надбавки не перерасчитывать код должности  - 5
                   (select first 1 shifriddolg from pr_get_dolg_person_by_id(person.shifrid)) not in (5,1455) -- 1455  почасовка
               and (select sum(coalesce(fadd.summa,0)) from fadd  where fadd.shifridperson=person.shifrid )>0.01

            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,  :tabno,    :fio, :dolg,
                  :shifrgru, :shifrkat, :w_place,
                  :razrjad,  :oklad,    :w_r
  do
     begin
           if (tabno=1356) then
               tabno=1356;
           if (razrjad not between 1 and 24) then
              select first 1 prim from fcn
                     where fcn.shifridperson=:shifrid
                       and fcn.shifrsta=126+500
                       and fcn.kod=100
                       and fcn.prim>0
                     into :razrjad;
           ShifrDol=0;
           select first 1 coalesce(prim,0) from fcn
                  where fcn.shifridperson=:shifrid and
                        fcn.shifrsta=100+500
                        and fcn.kod=100
                        and fcn.prim>0
                        into :shifrdol;
           select coalesce(a.guid,'') from pr_GETGUID(:shifrid,0) a into :guid;
           if ((razrjad=0) and (ShifrDol>0)) then
              Razrjad= case
                           when ShifrDol=240 then 15
                           when ShifrDol in (190,230) then 16
                           when ShifrDol=210 then 17
                           when ShifrDol in (150,170) then 19
                           when ShifrDol=110 then 20
                           when ShifrDol=90 then 21
                           else 0
                       end;
           if ((razrjad between 1 and 24)) then
              begin
                    nadb_vysl_pr=0;    -- процент надбавки за вислугу
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=8 or fcn.shifrsta=8+500)
 --                         and fcn.kod=100
                          into :nadb_vysl_pr;
                    if (exists (select * from fcn
                                where fcn.shifridperson=:shifrid and
                                     (fcn.shifrsta=82 or fcn.shifrsta=82+500)
                                      and fcn.kod=100)) then
                       cn_osn=1; -- оcновное место работы
                    else
                      cn_osn=0;
                    koef=1;
                    select first 1 coalesce(summa,1.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                (fcn.shifrsta=99 or fcn.shifrsta=99+500)
                                and fcn.kod=100
                          into :koef;
                    koef=coalesce(koef, 1);

                    select first 1 a.oklad from tb_razr_proc a
                            where a.datefr = (select max(b.datefr) from tb_razr_proc b
                      where b.datefr<(select max(c.datefr) from tb_razr_proc c)
                      )
                      and a.razr=:razrjad
                    into :oklad_razr_old;
                   oklad_razr_old=coalesce(oklad_razr_old,0);
                   koefr=0;
                   if (oklad_razr_old>0.01) then
                      koefr=oklad/oklad_razr_old;
                    koef=koefr;

                    nadb_st_pr=0;      -- процент надбавки за степень
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=18 or  fcn.shifrsta=18+500)
                           into :nadb_st_pr;
                    nadb_zw_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=22 or fcn.shifrsta=22+500)
                          into :nadb_zw_pr;
                    nadb_zs_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=17 or  fcn.shifrsta=17+500)
                           into :nadb_zs_pr;
                    nadb_zam_dek_pr = 0;
                    dopl_zam_dek    = 0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=42 or  fcn.shifrsta=42+500)
                           into :nadb_zam_dek_pr;

                    nadb_zaw_kaf_pr = 0;
                    dopl_zaw_kaf    = 0;
--                    select first 1 coalesce(summa,0.00) from fcn
--                           where fcn.shifridperson=:shifrid and
--                                 (fcn.shifrsta=42 or  fcn.shifrsta=42+500)
--                           into :nadb_zaw_kaf_pr;

                    select first 1 coalesce(retval,0) from work_day(:tabno,:dt) into :work_day;
                    select first 1 coalesce(retval,0) from ill_day(:tabno,:dt)  into :ill_day;
                    select first 1 coalesce(retval,0) from otp_day(:tabno,:dt)  into :otp_day;
                    if ((:work_day=0) and (:otp_day=0)) then
                       select first 1 coalesce(retval,0) from work_day_for_sowm(:tabno,:dt) into :work_day;
                    OLD_VYPL_OKLAD=0;

                    select sum(a.summa) from fadd a
                           where a.shifrsta=1
                             and a.shifridperson=:shifrid
                             and a.month_za = :m
                             and a.year_za=:y
                           into :OLD_VYPL_OKLAD;

/*
                    select sum(a.summa) from fadd a
                           where a.shifrsta=1
                             and (
                                  ((strlen(trim(:guid))>0) and (trim((select first 1 coalesce(guid,'') from pr_getguid(a.shifridperson,0)))
                                                               =trim(:guid))) or
                                  ((strlen(trim(:guid))=0) and (a.shifridperson=:shifrid))
                                                               
                                 )
                             and a.month_za = :m
                             and a.year_za=:y
                           into :OLD_VYPL_OKLAD;
*/
                    select first 1 coalesce(a.oklad,0) from tb_razr_proc a
                                           where a.razr=:razrjad
                                           order by a.datefr desc
                                           into new_oklad;
 --                   if (abs(old_vypl_oklad/koef-new_oklad)>1000) then

-- проверка проректоров
                    if (ShifrDol in (20,30,40)) then
                       begin
                            select first 1 coalesce(a.oklad,0) from tb_razr_proc a
                                           where a.razr=24
                                           order by a.datefr desc
                                           into new_oklad;
                            new_oklad=cast(new_oklad*0.95 as decimal(12,2));
                       end
                    new_oklad    = new_oklad*koef;
                    new_vypl_oklad = new_oklad*work_day/kalend_day;
                    dopl_oklad     = coalesce((new_vypl_oklad-old_vypl_oklad),0.00);
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    dopl_zw        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zw_pr/100,0.00);
                    dopl_zs        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zs_pr/100,0.00);
                    dopl_vysl      = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_vysl_pr/100,0.00);
                    dopl_zam_dek   = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_zam_dek_pr/100,0.00);

--                  dopl_zaw_kaf   = (new_vypl_oklad-old_vypl_oklad) * nadb_zaw_kaf_pr/100;

                    SHIFRIDRCLC=GEN_ID(g_rclc_08,1);

                    insert into TB_RCLC1301 (SHIFRID, TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                          dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                          koef,           razr,       old_oklad,  new_oklad,OLD_VYPL_OKLAD,
                                          NEW_VYPL_OKLAD, DOPL_OKLAD, NADB_ZW_PR, DOPL_ZW,  NADB_ST_PR,
                                          DOPL_ST,        NADB_VYSL,  dopl_vysl,  nadb_zam_dek_pr,   DOPL_ZAM_DEK,
                                          NADB_ZAW_KAF_PR,  DOPL_ZAW_KAF,  w_r,        cn_osn,
                                          nadb_zs_pr,     dopl_zs,    y ,       m,
                                          shifrdol,guid     ) VALUES(
                                          :SHIFRIDRCLC,
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :oklad,     :new_oklad,:old_vypl_oklad,
                                          :new_vypl_oklad,:dopl_oklad,:nadb_zw_pr,:DOPL_ZW,  :NADB_ST_PR,
                                          :dopl_st,       :nadb_vysl_pr,:dopl_vysl,:NADB_ZAM_DEK_PR, :DOPL_ZAM_DEK,
                                          :NADB_ZAW_KAF_PR,:DOPL_ZAW_KAF,          :w_r,       :cn_osn,
                                          :NADB_ZS_PR,    :DOPL_ZS,   :Y ,       :M,
                                          :shifrdol,:guid) ;
                    /*надбавка за степень */
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=18 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 18,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    /*надбавка за звание */
                    if (abs(dopl_zw)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=22 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 22,:nadb_zw_pr,:dopl_zw, :namesta);
                       end
                    /*надбавка за зв. заслуженного */
                    if (abs(dopl_zs)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=17 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 17,:nadb_zs_pr,:dopl_zs, :namesta);
                       end
                    /*надбавка за выслугу */
                    if (abs(dopl_vysl)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=8 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 8,:nadb_vysl_pr,:dopl_vysl, :namesta);
                       end
                    /* надбавка за зам декана */
                    if (abs(dopl_zam_dek)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=42 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 42,:nadb_zam_dek_pr,:dopl_zam_dek, :namesta);
                       end

                    /* 7-й шифр  */

                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=7 or  fcn.shifrsta=7+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=7 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 7,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    select first 1 shortname from shifr where shifr=30 into :namesta;
                    for
                        select coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid
                                 and fcn.kod=2 and
                                 (fcn.shifrsta=30 or  fcn.shifrsta=30+500)
                           into :nadb_st_pr
                    do
                       begin
                            nadb_st_pr=coalesce(nadb_st_pr,0);
                            if (nadb_st_pr>0 and nadb_st_pr<300) then
                               begin
                                dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                                if (dopl_st>0.01) then
                               insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                      values(:shifridrclc, 30,:nadb_st_pr,:dopl_st, :namesta);
                               end

                       end
/*
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=30 or  fcn.shifrsta=30+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=30 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 30,:nadb_st_pr,:dopl_st, :namesta);
                       end
*/
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 fcn.kod=2 and
                                 (fcn.shifrsta=33 or  fcn.shifrsta=33+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=33 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 33,:nadb_st_pr,:dopl_st, :namesta);
                       end
                    nadb_st_pr=0;
                    select first 1 coalesce(summa,0.00) from fcn
                           where fcn.shifridperson=:shifrid and
                                 (fcn.shifrsta=41 or  fcn.shifrsta=41+500)
                           into :nadb_st_pr;
                    dopl_st        = coalesce((new_vypl_oklad-old_vypl_oklad) * nadb_st_pr/100,0.00);
                    if (abs(dopl_st)>0.01) then
                       begin
                           select first 1 shortname from shifr where shifr=41 into :namesta;
                           insert into tb_rclc1301_pr(shifridowner, shifrsta,procent,dopl_summa,namesta)
                                  values(:shifridrclc, 41,:nadb_st_pr,:dopl_st, :namesta);
                       end



           end       -- razrjad > 0
     end
end^


ALTER PROCEDURE PR_RECALC_ALL_PEOPLE (
    Y INTEGER,
    M INTEGER,
    YCURR INTEGER,
    MCURR INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable TABNO integer;
begin
     DELETE FROM tb_recalc_podoh WHERE YEARZA=:Y AND MONTHZA=:M;
     delete from fud a
            where a.year_vy  = :ycurr
              and a.month_vy = :mcurr
              and a.shifrsta in (50,142,143,144,145,146)
              and a.vypl=0;
     for
        select a.tabno from fadd a
                       where a.year_za  = :y
                         and a.month_za = :m
                       group by 1
                       into :tabno
     do
       begin
             insert into tb_recalc_podoh
                             (TABNO          , yearza       ,  MONTHZA       ,  SUMMAADDTOT    ,     SUMMAADDECBN  ,
                              SUMMAECBNUD    , SUMMAECBNRAS ,  SUMMAADDECB   ,  SUMMAECBUD     ,     SUMMAECBRAS   ,
                              SUMMAADDECBDP  , SUMMAECBDPUD ,  SUMMAECBDPRAS ,  SUMMAADDECBILL ,     SUMMAECBILLUD ,
                              SUMMAECBILLRAS , SUMMAADDPOD  ,  SUMMAPODUD    ,  SUMMAPODRAS    ,
                              MOVEDPOD       , MOVEDECBN    ,  MOVEDECB      ,  MOVEDECBDP     ,     MOVEDECBILL)
                      select :tabno          , :Y           ,  :m            ,  0              ,     SUMMAECBNADD  ,
                              SUMMAECBNUD    , SUMMAECBNRAS ,  SUMMAECBADD   ,  SUMMAECBUD     ,     SUMMAECBRAS   ,
                              SUMMAECBDPADD  , SUMMAECBDPUD ,  SUMMAECBDPRAS ,  SUMMAECBILLADD ,     SUMMAECBILLUD ,
                              SUMMAECBILLRAS , SUMMAPODADD  ,  SUMMAPODUD    ,  SUMMAPODRAS    ,
                              0 , 0 , 0 , 0 , 0
                              FROM recalcpodohyear(:tabno, :y) b
                              where b.monthza=1;

       end
  RetVal=1;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_RECALC_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    SHIFRID INTEGER,
    DEBUGMODE INTEGER,
    GUID VARCHAR(30))
AS
declare variable DT date;
declare variable W_DAYS integer;
declare variable OKLAD decimal(15,5);
declare variable O_DAY integer;
declare variable SUMMA_OKL decimal(15,2);
declare variable SUMMA_R decimal(15,2);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable DOLG char(50);
declare variable W_R integer;
declare variable W_PLACE integer;
declare variable SHIFRSTA integer;
declare variable KOD integer;
declare variable SUMMA decimal(15,2);
declare variable FOND integer;
declare variable SUMMAFZADD decimal(15,2);
declare variable SUMMAFZUD decimal(15,2);
declare variable SUMMASSADD decimal(15,2);
declare variable SUMMASSUD decimal(15,2);
declare variable SUMMAPENSADD decimal(15,2);
declare variable SUMMAPENSUD decimal(15,2);
declare variable SUMMAPODADD decimal(15,2);
declare variable SUMMAPODUD decimal(15,2);
declare variable SUMMAFZRAZN decimal(15,2);
declare variable SUMMASSRAZN decimal(15,2);
declare variable SUMMAPENSRAZN decimal(15,2);
declare variable SUMMAPODRAZN decimal(15,2);
declare variable SUMMAFZRAS decimal(15,2);
declare variable SUMMASSRAS decimal(15,2);
declare variable SUMMAPENSRAS decimal(15,2);
declare variable SUMMAPODRAS decimal(15,2);
declare variable SUMMAVYPL decimal(15,2);
declare variable SUMMAPSBORUD decimal(15,2);
declare variable POLUCHATEL integer;
declare variable PROCENTPSBOR decimal(15,2);
declare variable SUMMAPSBOR decimal(15,2);
declare variable SHIFRIDPERSONTMP integer;
declare variable CNT integer;
declare variable SUMMAFAKT decimal(15,2);
declare variable SUMMANEED decimal(15,2);
declare variable SUMMAADDFORINDCALC decimal(15,2);
declare variable SUMMAMINSAL decimal(15,2);
declare variable SUMMARASIND decimal(15,2);
declare variable SUMMAFORINSERT decimal(15,2);
declare variable KOEF decimal(15,2);
declare variable RAZRJAD integer;
declare variable SUMMAECBADD decimal(15,2);
declare variable SUMMAECBUD decimal(15,2);
declare variable SUMMAECBRAS decimal(15,2);
declare variable SUMMAECBRAZN decimal(15,2);
declare variable SUMMAECBILL decimal(15,2);
declare variable SUMMAECBILLRAS decimal(15,2);
declare variable SUMMAECBILLRAZN decimal(15,2);
declare variable SUMMAECBILLUD decimal(15,2);
declare variable SUMMAECBILLADD decimal(15,2);
declare variable MODE_PERSON integer;
declare variable ID integer;
declare variable I integer;
declare variable ECBSHIFR integer;
declare variable PRIM integer;
begin
      w_days=0;
      dt=yearza||'-'||monthza||'-10';

  /*   0. Отработано дней по табелю */

      select first 1 retval  from work_day_common(:tabno,:dt,1) into :w_days;
--      exception wdayzero 'w_days='||W_days;
      if (w_days>31) then
         exception wdayzero 'w_days='||W_days;
      if (w_days<1 or w_days>31 or w_days is null)  then w_days=0;
--     exception wdayzero 'w_days='||W_days;


   /*  1. Получить оклад  */

      oklad=0;
      select first 1 b.oklad,b.shifrid from tb_tmp_person a
             join tb_tmp_person b on a.tabno=b.tabno
             where a.shifrid=:shifrid    and
                   (select guid from pr_getguid(a.shifrid,1))=
                   (select guid from pr_getguid(b.shifrid,1)) and
/*
                   a.dolg   =   b.dolg   and
                   a.shifrgru=b.shifrgru and
                   a.shifrkat=b.shifrkat and
                   a.w_r=b.w_r           and
                   a.w_place=b.w_place   and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(a.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d)) and
          --         b.conn_id=current_connection and
          --         b.tabno=:tabno        and
                   ((select first 1 koef from PR_GET_KOEF_PERSON_TMP(a.shifrid))=
                    (select first 1 koef from PR_GET_KOEF_PERSON_TMP(b.shifrid)))  and
*/
                   b.monthvy=:monthza    and
                   b.yearvy=:yearza
             into :oklad,:SHIFRIDPERSONTMP;
      select tb_tmp_person.razrjad
             from tb_tmp_person
             where tb_tmp_person.shifrid=:SHIFRIDPERSONTMP
             into razrjad;
      razrjad=coalesce(razrjad,1);
   /* Вставка для учета оклада при перерасчете за 1 и 2 2010 */
   /* т к оклад был повышен в матре за янв и фвр 2010        */
   /*                      22 03 2010                        */

      if ((yearza=2010) and (monthza in (1,2)) and (razrjad between 1 and 7) and (oklad>0.001)) then
         begin
              koef=1;
              select first 1 a.summa from   tb_tmp_fcn a
                     where  a.shifrsta in (99,99+500) and
                            a.shifridperson=:SHIFRIDPERSONTMP
                     into koef;
              koef=coalesce(koef, 1);
              if (Koef>1) then Koef=1;
              oklad=869 * koef;
         end
/* Конец вставки перерасчета за 1 и 2 2010 */

      if (razrjad not between 1 and 25) then razrjad=1;
      if (oklad is null or oklad<0) then
         begin
             select first 1 a.oklad from tb_tmp_person a
                    where a.shifrid=:shifrid
                    into :oklad;
         end
      if (oklad is null or oklad<0) then
         oklad=0;
 --     exception wdayzero cast(oklad as char(10));

   /*  2. Получить количество рабочих дней в месяце по графику  */

      select first 1 tb_days.wdays from tb_days where yearza=:yearza and monthza=:monthza
             into :o_day;
--      exception wdayzero cast(o_day as char(10));
      if (o_day is null or o_day<1 or o_day>31)   then
          o_day=20;
--      exception wdayzero 'o_day='||o_day;

--      summa_okl=cast(oklad as decimal(15,7)) / cast(o_day  as decimal(15,2)) * cast(w_days as decimal(15,2));

   /*  3. Расчитать оклад   */

--      summa_okl= oklad * cast(cast(w_days as decimal(15,2)) / cast(o_day as decimal(15,2)) as decimal(15,2));
      summa_okl= cast(
                       cast(oklad /
                                   cast(o_day as decimal(15,5)) as decimal(15,5)
                           )* cast(w_days as decimal(15,5))
                 as decimal(15,2));

--      exception wdayzero 'w_days='||W_days||' oklad='||oklad||' o_day='||o_day||' summa_okl='||summa_okl ;
--      exception wdayzero cast(summa_okl as char(12));
      delete from tb_tmp_fadd a
             where a.shifridperson=:shifrid and
                   a.shifrsta=1             and
                   a.vypl=0;
      select first 1 a.dolg,a.shifrgru,a.shifrkat,a.w_r,a.w_place from tb_tmp_person a where a.shifrid=:shifrid
             into :dolg, :shifrgru, :shifrkat, :w_r,:w_place;

      select sum(summa) from tb_tmp_fadd a join tb_tmp_person b
             on a.shifridperson=b.shifrid
             where a.shifrsta=1         and
                   ( (trim(:GUID)=(select trim(guid) from pr_getguid(b.shifrid,1)))
                      or  (b.tabno=:tabno         and
                        b.shifrgru=:shifrgru   and
                        b.shifrkat=:shifrkat   and
                        b.dolg=:dolg           and
                        b.w_r=:w_r             and
                        b.w_place=:w_place)
                   ) and
                   a.year_za  = :yearza   and
                   a.month_za = :monthza  and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))

             into summa_r;
      if (summa_r is null) then
         summa_r=0;
      summa_okl=summa_okl - summa_r;
 --     if (DEbugMode=1) then
 --     exception wdayzero 'w_days='||W_days||' oklad='||oklad||' o_day='||o_day||' summa_okl='||summa_okl||' summa_r='||summa_r ;
--     exception wdayzero 'w_days='||W_days;

      if (summa_okl>0.005 or  summa_okl<-0.005) then
         begin
              insert into tb_tmp_fadd (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                       W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                       year_za,MONTH_VY, YEAR_VY      ,SUMMA   , WDAY    ,
                                       WCLOCK ,FOND    , VYPL         ,sch     , need) values(
                                       current_connection, 0, :shifrid, :tabno,  :w_place,
                                   :W_R   ,:shifrgru, :SHIFRKAT     ,1,:MONTHZA ,
                                   :yearza,:MONTHza, :YEARza      ,:SUMMA_okl   ,:o_day-:w_days    ,
                                   0 ,1   , 0         ,' '     , 1);

         end
     /* Начисления */
--     exception wdayzero ' ShifrIdPersonTmp='||ShifrId;

--      if (ShifrIdPersonTmp>0) then

     --  ShifrIdPersonTmp - код работника в месяце за который производится перерасчет
     --  ShifrId          - код работника в месяце в котором производится перерасчет
--             if (shifridpersontmp=1054131) then
--     exception wdayzero 'w_d='||W_days

      for
         select a.shifrsta,a.kod,a.summa,a.prim from tb_tmp_fcn a join shifr b
                on a.shifrsta=b.shifr
                where --a.shifridperson=:shifrid and
                      b.mode = 1               and
                      a.kod in (1,2,3,4,5,6)   and
                      a.tabno = :tabno         and
--                      a.conn_id = current_connection   and
--                      a.shifridperson = :shifridpersontmp and
                      ((select first 1 guid from pr_getguid(a.shifridperson,1))=:GUID) and
                      a.shifrsta<500
                into :ShifrSta, :Kod,:summa,:prim
      do
        begin
--             if (shifridpersontmp=1054131) then
--     exception wdayzero 'sta='||shifrsta||' summa='||summa||' o_day='||o_day;
             prim=coalesce(prim, 0);
             if (shifrsta in (8,18,22)) then prim=0; -- Для надбавок за стаж и научн звания и степень Prim не учитывать
             if (kod in (2,4,6)) then
                begin
                     select sum(a.summa) from tb_tmp_fadd  a
                            join tb_tmp_person b on a.shifridperson=b.shifrid
                            where
              --              ((:shifrid=0) or (a.shifridperson=:shifrid)) and
                          a.year_za      = :yearza   and
                          a.month_za     = :monthza  and
    --                      tb_tmp_fadd.shifridperson =:shifridpersontmp  and
                    --      a.shifridperson=:shifrid and
                          a.shifrsta     = 1       and
                          b.tabno=:tabno         and
                         ((select first 1 guid from pr_getguid(a.shifridperson,1))=:GUID)
/*
                          b.shifrgru=:shifrgru   and
                          b.shifrkat=:shifrkat   and
                          b.dolg=:dolg           and
                          b.w_r=:w_r             and
                          b.w_place=:w_place     and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))
*/
                            into :summa_okl;
                     if (summa_okl is null) then
                        summa_okl=0;
      --     if (ShifrSTa=8) then
      --           exception testputboln 'summa_okl='||cast(summa_okl as  varchar(10));
             --        if (shifrid=1143172) then
             --            exception wdayzero 'summa_okl='||summa_okl;
                     summa=summa_okl*(summa/100.00);
                end
             else
                summa=cast(summa *
                           cast(
                                 cast(w_days as decimal(15,5)) /
                                 cast(o_day  as decimal(15,5))
                                as decimal(15,5))
                        as decimal(15,2));
--     if (ShifrSTa=30) then
--     exception wdayzero 'w_days='||W_days||' summa='||summa||' o_day='||o_day;

   --          exception wdayzero cast(summa as char(10));
 --          if (ShifrSTa=8) then
 --                exception testputboln 'summa_okl='||cast(summa_okl as  varchar(10))||' summa='||cast(summa as  varchar(10));

             delete from tb_tmp_fadd
                    where --a.shifridperson=:shifrid and
                          tb_tmp_fadd.shifrsta=:ShifrSta       and
                          tb_tmp_fadd.year_za      = :yearza   and
                          tb_tmp_fadd.month_za     = :monthza  and
                          tb_tmp_fadd.shifridperson =:shifrid  and
                          ((:prim=0) or  ((select retval from PR_CMPINTANDCHAR(:prim,tb_tmp_fadd.sch))=1)) and
                          tb_tmp_fadd.vypl=0;

             select sum(a.summa) from tb_tmp_fadd a
                    join tb_tmp_person b on a.shifridperson=b.shifrid
                    where --a.shifridperson=:shifrid and
                          a.shifrsta = :shifrsta    and
                          a.year_za  = :yearza      and
                    --      tb_tmp_fadd.shifridperson in (:shifrid,:shifridpersontmp) and
                          a.month_za = :monthza     and
                          a.tabno=:tabno            and
                          ((:prim=0) or  ((select retval from PR_CMPINTANDCHAR(:prim,a.sch))=1)) and
                         -- ((:prim=0) or (:prim=cast(a.sch as integer))) and

                         ((select first 1 guid from pr_getguid(a.shifridperson,1))=:GUID)

--                          a.shifrgru=:shifrgru      and
--                          a.shifrkat=:shifrkat      and
--                          b.dolg=:dolg              and
--                          a.year_za  = :yearza      and
--                          a.month_za = :monthza     and
--                          a.w_r   =    :w_r         and
--                          a.w_place =  :w_place     and
--                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
--                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))

                    into :summa_r;
--                 exception testputboln cast(summa_r as  varchar(10));

             summa_r=coalesce(summa_r,0);
  --           if (ShifrSTa=30) then
  --           exception  t  'is '||summa_r;
       -- if (prim=2) then
       --        exception testputboln 'summa_okl='||cast(summa_okl as  varchar(10))||' summa='||cast(summa as  varchar(10))||' summa_r='||cast(summa_r as  varchar(10));


--             exception wdayzero ' shifrid='||shifridpersontmp||' shifrsta='||ShifrSta||' y='||YearZa||' m='||monthza;


             if (kod in (1,2)) then fond=1;
             if (kod in (3,4)) then fond=2;
             if (kod in (5,6)) then fond=3;
--                     if (ShifrSta=8) then
--                     exception wdayzero ' Summa_Okl='||Summa_Okl;
         -- if (ShifrSTa=8) then
         --        exception testputboln 'summa_okl='||cast(summa_okl as  varchar(10))||' summa='||cast(summa as  varchar(10))||' summa_r='||cast(summa_r as  varchar(10));
             summa=summa-summa_r;
--          if (ShifrSTa=8) then
--                 exception testputboln 'summa_okl='||cast(summa_okl as  varchar(10))||' summa='||cast(summa as  varchar(10))||' summa_r='||cast(summa_r as  varchar(10));
--             exception wdayzero cast(summa as char(10));
             if (summa>0.005 or  summa<-0.005) then
                begin
                     insert into tb_tmp_fadd (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                              W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                              year_za,MONTH_VY, YEAR_VY      ,SUMMA   , WDAY    ,
                                              WCLoCK ,FOND    , VYPL         ,sch     , need) values(
                                              current_connection, 0, :shifrid, :tabno,  :w_place,
                                   :W_R   ,:shifrgru, :SHIFRKAT     ,:ShifrSta,:MONTHZA ,
                                   :yearza,:MONTHza, :YEARza      ,:SUMMA     ,:o_day-:w_days    ,
                                   0 ,:fond   , 0         ,
                                   case
                                       when :prim>0 then cast(:prim as varchar(8))
                                       else ' '
                                   end,

                                      1);

                end
        end

       /*    Индексация */
       delete from tb_tmp_fadd
               where --a.shifridperson=:shifrid and
                      tb_tmp_fadd.shifrsta     =    28     and
                      tb_tmp_fadd.year_za      = :yearza   and
                      tb_tmp_fadd.month_za     = :monthza  and
                      tb_tmp_fadd.shifridperson= :shifrid and
                      tb_tmp_fadd.vypl=0;

       select count(*) from tb_tmp_fadd a
                    join tb_tmp_person b on a.shifridperson=b.shifrid
              where a.shifrsta=28 and
                    a.year_za  = :yearza   and
         --           tb_tmp_fadd.shifridperson = :shifridpersontmp and
                    a.month_za      = :monthza and
                    a.tabno=:tabno         and
                    a.shifrgru=:shifrgru   and
                    a.shifrkat=:shifrkat   and
                    b.dolg=:dolg           and
                    a.year_za  = :yearza   and
                    a.w_r      = :w_r      and
                    a.w_place  = :w_place  and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))
              into :Cnt;
       if (cnt>0) then       -- рассчитывать, если была индексация
          begin
                -- Рассчитать сумму фактически выплаченной индексации
                select sum(a.summa) from tb_tmp_fadd a
                    join tb_tmp_person b on a.shifridperson=b.shifrid
                       where a.shifrsta=28 and
                             a.year_za  = :yearza   and
          --                   tb_tmp_fadd.shifridperson = :shifridpersontmp and
                             a.month_za = :monthza   and
                             a.tabno    = :tabno     and
                             a.shifrgru = :shifrgru  and
                             a.shifrkat = :shifrkat  and
                             b.dolg     = :dolg      and
                             a.w_r      = :w_r       and
                             a.w_place  = :w_place   and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))
                       into :SummaFakt;
                -- Рассчитать нужной индексации (при полном табеле)
                select max(tb_tmp_fadd.summa) from tb_tmp_fadd
                       where tb_tmp_fadd.shifrsta      = 28 and
                             tb_tmp_fadd.year_za       = :yearza   and
          --                   tb_tmp_fadd.shifridperson = :shifridpersontmp and
                             tb_tmp_fadd.month_za      = :monthza and
                             tb_tmp_fadd.summa>0.001
                       into :SummaNeed;

                -- Итого начислено для расчета индексации
                select sum(a.summa) from tb_tmp_fadd a join
                           tb_tmp_person b on a.shifridperson=b.shifrid
                       where a.shifrsta in (select e.shifr from shifr e
                                                             where e.mode>0 and
                                                                   e.ind=1 and
                             a.year_za       = :yearza   and
                             a.month_za      = :monthza  and
                             a.tabno         = :tabno    and
                             a.shifrgru=:shifrgru   and
                             a.shifrkat=:shifrkat   and
                             b.dolg=:dolg         and
                             a.year_za  = :yearza   and
                             a.w_r      = :w_r      and
                             a.w_place  = :w_place  and
                             ((b.w_r=1) or (exists(select * from tb_tmp_fcn f
                                                                        where f.shifridperson=b.shifrid and
                                                                              f.shifrsta=82+500)))) and
                   ((select first 1 c.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(b.shifrid) c) =
                    (select first 1 d.swm_mode from PR_GET_SWM_MODE_PERSON_TMP(:shifrid) d))

                       into :SummaAddForIndCalc;
                if (summaaddforindcalc is null) then
                   summaaddforindcalc=0;

                -- Минимальная зарплата
                select first 1 sslimity.minsal from sslimity
                       where sslimity.datefr<=:yearza||'-'||:monthza||'-01'
                       order by sslimity.datefr desc
                       into :summaminsal;
                if (summaminsal is null) then summaminsal=0;
                -- Индексация сниамется если начислено меньше мин зарплаты
                if (summaaddforindcalc<summaminsal and SummaMinSal>0.01) then
                   begin
                         SummaRasInd=SummaNeed*summaaddforindcalc/SummaMinSal;
                         SummaForInsert=SummaRasInd-SummaFakt;
                         insert into tb_tmp_fadd (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                                              W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                              year_za,MONTH_VY, YEAR_VY      ,SUMMA   , WDAY    ,
                                              WCLOCK ,FOND    , VYPL         ,sch     , need) values(
                                              current_connection, 0, :shifrid, :tabno,  :w_place,
                                   :W_R   ,:shifrgru, :SHIFRKAT     ,28,:MONTHZA ,
                                   :yearza,:MONTHza, :YEARza      ,:SUMMAforinsert     ,0    ,
                                   0 ,:fond   , 0         ,' '     , 1);

                   end
          end
        /* Конец расчета индексации*/





     /* Удержания */
     /* Удалить не блокированные налоги и алименты (56) почтовый сбор 95-96*/
      delete from tb_tmp_fud
             where tb_tmp_fud.shifrsta in (50,55,56,57,58,75,88,95,96,106,142,143,144,145,146) and
                   tb_tmp_fud.shifridperson=:ShifrId and
                   tb_tmp_fud.vypl=0;

      /* Пересчитать налоги */
     /* c 01 01 2011 соц страх, фонд з и пенс отменены
      select first 1 summaadd,summafz from getfznachud_common(:tabno,:yearza,:monthza,1,0,0) into :summafzadd, :summafzud;
      select first 1 SummaFZ from FZ(:SummaFzAdd,:YearZa,:MonthZa,:tabno) into :SummaFzRas;
      SummaFZRazn=:SummaFzRas-:SummaFzUd;
      select first 1 summaadd,summass from getssnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summassadd, :summassud;
      select first 1 SummaSS from SS(:SummaSSAdd,:YearZa,:MonthZa) into :SummaSsRas;
      SummaSSRazn=:SummaSSRas-:SummaSSUd;
      select first 1 summaadd,summapens from getpensnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summapensadd, :summapensud;
      select first 1 SummaPens from pens_common(:Tabno,:YearZa,:MonthZa,:SummaPensAdd,1) into :SummaPensRas;
  --    if (yearza=2009 and monthza=7) then
 --     if (DebugMode=1) then
 --         exception testputboln 'padd='||cast(summapensadd as  varchar(10))||' pud='||cast(summapensud as  varchar(10))||' pras='||cast(summapensras as  varchar(10));
      SummaPensRazn=:SummaPensRas-:SummaPensUd;
     */
      mode_person=0;
      select first 1 a.w_r from tb_tmp_person a where a.shifrid=:shifrid into :mode_person;
      if (mode_person=1) then mode_person=0; -- выбирать данные для всех записей
      else mode_person=1;                   -- для совмещений выбирать данные только для данного GUID
      select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:yearza,:monthza,1,0,:shifrid,:mode_person) into :summaecbadd, :summaecbud;
   --   if (DebugMode=1) then
--         exception wdayzero 'summaecbadd='||summaecbadd;
   --      exception wdayzero 'mode_person='||mode_person;

      id=0;
      if (mode_person=1) then id=:shifrid;
      select first 1 Summaecb from ecb_common(:tabno, :yearza,:monthza, :SummaECBAdd,1,:id) into :SummaEcbRas;
      SummaEcbRazn=:SummaEcbRas-:SummaECBUd;

      select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,1,0,:shifrid, :mode_person) into :summaecbilladd, :summaecbillud;
      select first 1 SummaECBIll from ecbill_common(:Tabno,:YearZa,:MonthZa,:SummaEcbIllAdd) into :SummaECBIllRas;
      SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;

   --   select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summaecbilladd, :summaecbillud;
   --   select first 1 SummaECBIll from ecbill_common(:Tabno,:YearZa,:MonthZa,:SummaEcbIllAdd,1) into :SummaECBIllRas;
   --   SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
      summafzras   = 0;
      summassras   = 0;
      summapensras = 0;
      select first 1 summaadd,summapod from getpodnachud_common(:tabno,:yearza,:monthza,1,0,:id, :mode_person) into :summapodadd, :summapodud;
--      exception t tabno||' '||YearZa||' '||MonthZa||' '||summapodadd||' '||summaecbras||' '||summaecbillras;
      if (mode_person=0) then
         select first 1 SummaPod from podoh_common(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:summaecbras+:summaecbillras,1) into :SummaPodRas;
      else
         summapodras=(SummaPodAdd-(summaecbras+summaecbillras))*0.15;
      SummaPodRazn=:SummaPodRas-:SummaPodUd;
--      exception t summapodras;

      summafzrazn   = 0;
      summassrazn   = 0;
      summapensrazn = 0;

      if (abs(SummaPodRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:shifrgru, :SHIFRKAT     ,50,:MONTHZA ,
                              :yearza,:MONTHza, :YEARza      ,:SUMMAPodRazn  , 0,
                               ' '     , 1);
      select first 1  retval from pr_is_sciped(:shifrid,1) into i;
      if (i=1) then ecbshifr=143;
      else ecbshifr=142;
      if (abs(SummaECBRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:ShifrGru, :ShifrKat     ,:ecbshifr ,:MonthZa ,
                              :YearZa,:MonthZa, :YearZa      ,:SummaECBRazn  , 0,
                               ' '     , 1);
      if (abs(SummaECBIllRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:ShifrGru, :ShifrKat     ,145 ,:MonthZa ,
                              :YearZa,:MonthZa, :YearZa      ,:SummaECBIllRazn  , 0,
                               ' '     , 1);
/*
      if (abs(SummaPensRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:shifrgru, :SHIFRKAT     ,75,:MONTHZA ,
                              :yearza,:MONTHza, :YEARza      ,:SUMMAPensRazn  , 0,
                               ' '     , 1);
      if (abs(SummaSSRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:shifrgru, :SHIFRKAT     ,106,:MONTHZA ,
                              :yearza,:MONTHza, :YEARza      ,:SUMMASSRazn  , 0,
                               ' '     , 1);
      if (abs(SummaFZRazn)>0.005) then
      insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place  ,
                               W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                               year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                               sch     , need) values(
                     current_connection, 0     , :shifrid     , :tabno,  :w_place,
                              :W_R     ,:shifrgru, :SHIFRKAT     ,88,:MONTHZA ,
                              :yearza,:MONTHza, :YEARza      ,:SUMMAfzRazn  , 0,
                               ' '     , 1);
*/
      /* Алименты и удержания*/
      for
         select a.shifrsta,a.kod,a.summa,a.prim from tb_tmp_fcn a join shifr b
                on a.shifrsta=b.shifr
                where a.shifridperson=:shifrid and
                      b.mode = 0               and      -- удержания
                      kod in (1,2,3)           and
                      a.tabno = :tabno         and
                      a.conn_id = current_connection
                into :ShifrSta, :Kod,:summa,:fond
      do
        begin
             delete from tb_tmp_fud
                    where tb_tmp_fud.shifrsta     = :ShifrSta and
                          tb_tmp_fud.shifridperson = :ShifrId and
                          tb_tmp_fud.year_za      = :yearza   and
                          tb_tmp_fud.month_za     = :monthza  and
                          tb_tmp_fud.vypl=0;
             select sum(summa) from tb_tmp_fud
                    where tb_tmp_fud.shifrsta     = :ShifrSta and
                          tb_tmp_fud.year_za      = :yearza   and
                          tb_tmp_fud.month_za     = :monthza  and
                          tb_tmp_fud.shifridperson = :ShifrId
                    into :summavypl;
             if (kod=1) then
                     summa=summa-:summavypl;
             else
                if (kod=2) then
                   begin
                        select sum(a.summa) from tb_tmp_fadd a
                               where a.shifridperson=:shifrid and
                                     a.year_za=:yearza         and
                                     a.month_za=:monthza       and
                                     a.shifrsta = 1
                               into :summa_okl;
                        summa=summa_okl*cast(summa/100.00 as decimal(15,2))-:summavypl;
                   end
                else
                   begin
                        if (ShifrSta=56) then       -- Алименты
                           begin
                                select sum(a.summa) from tb_tmp_fadd a
                                       where a.shifridperson=:shifrid  and
                                             a.year_za=:yearza         and
                                             a.month_za=:monthza
                                       into :summa_okl;
                                select sum(a.summa) from tb_tmp_fud a
                                       where a.shifridperson=:shifrid and
                                             a.year_za=:yearza         and
                                             a.month_za=:monthza       and
                                             a.shifrsta=50
                                       into :summapodud;
                                select sum(a.summa) from tb_tmp_fud a
                                       where a.shifridperson=:shifrid and
                                             a.year_za=:yearza         and
                                             a.month_za=:monthza       and
                                             a.shifrsta=75
                                       into :summapensud;
                                select sum(a.summa) from tb_tmp_fud a
                                       where a.shifridperson=:shifrid and
                                             a.year_za=:yearza         and
                                             a.month_za=:monthza       and
                                             a.shifrsta=106
                                       into :summassud;
                                select sum(a.summa) from tb_tmp_fud a
                                       where a.shifridperson=:shifrid and
                                             a.year_za=:yearza         and
                                             a.month_za=:monthza       and
                                             a.shifrsta=88
                                       into :summafzud;
                                summa=(summa_okl-summapodras-summapensras-summassras-summafzras)*cast(summa/100.00 as decimal(15,2))-:summavypl;

                           end
                        else
                           begin
                                select sum(a.summa) from tb_tmp_fadd a
                                       where a.shifridperson=:shifrid and
                                            a.year_za=:yearza         and
                                            a.month_za=:monthza
                                       into :summa_okl;
                                summa=summa_okl*cast(summa/100.00 as decimal(15,2))-:summavypl;
                           end
                   end
             if (summa>0.005 or  summa<-0.005) then
                begin
                     insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place   ,
                                              W_R    ,shifrgru, SHIFRKAT     ,SHIFRSTA,MONTH_ZA ,
                                              year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                                              sch     , need) values(
                                              current_connection, 0, :shifrid, :tabno,  :w_place,
                                              :W_R   ,:shifrgru, :SHIFRKAT     ,:ShifrSta,:MONTHZA ,
                                              :yearza,:MONTHza, :YEARza      ,:SUMMA   ,0    ,
                                              cast(:fond as char(8))     , 1);
                end
           /* Алименты */
             if (ShifrSta in (55,56,57,58)) then
                begin
                     delete from tb_tmp_fud a
                            where a.shifridperson=:shifrid and
                                  a.shifrsta=95            and
                                  a.year_za=:yearza        and
                                  a.month_za=:monthza      and
                                  (cast(a.sch as integer)=:fond or
                                   cast(a.sch as integer)=0) and
                                  a.vypl=0;
                     select sum(a.summa) from tb_tmp_fud a
                            where a.shifridperson=:shifrid and
                                  a.shifrsta=95            and
                                  a.year_za=:yearza        and
                                  a.month_za=:monthza      and
                                  (cast(a.sch as integer)=:fond or
                                   cast(a.sch as integer)=0) and
                                  a.vypl=0
                            into :summapsborud;
                     POLUCHATEL=mod(FOND,63488);
                     select first 1 a.procentpst   from alimenty a
                            where a.SHIFR=:poluchatel
                            into PROCENTPSBOR;
                     if (procentpsbor>0) then
                         SUMMAPSBOR=SUMMA*procentpsbor/100-summapsborud;
                     if (abs(summapsbor)>0.005) then
                        begin
                              insert into tb_tmp_fud (CONN_ID,shifrid , SHIFRIDPERSON,tabno   ,w_place   ,
                                              W_R    ,shifrgru, SHIFRKAT     ,shifrsta,MONTH_ZA ,
                                              year_za,MONTH_VY, YEAR_VY      ,SUMMA   , VYPL    ,
                                              sch     , need) values(
                                              current_connection, 0, :shifrid, :tabno,  :w_place,
                                              :W_R   ,:shifrgru, :SHIFRKAT     ,95,:MONTHZA ,
                                              :yearza,:MONTHza, :YEARza      ,:SUMMApsbor   ,0    ,
                                              cast(:fond as char(8))     , 1);
                        end
                end
        end
  /* Procedure Text */

end^


ALTER PROCEDURE PR_RECALC_POCHAS_13_1_3 (
    Y INTEGER,
    M INTEGER)
AS
declare variable SHIFRID integer;
declare variable TABNO integer;
declare variable DOLG varchar(25);
declare variable FIO varchar(30);
declare variable W_PLACE integer;
declare variable SHIFRDOL integer;
declare variable GUID varchar(30);
declare variable POCHASSHIFR integer;
declare variable POCHASDOLG integer;
declare variable SHIFRST integer;
declare variable SHIFRZW integer;
declare variable SHIFRIDRCLC integer;
declare variable STAWKANEW decimal(10,2);
declare variable ISMG integer;
declare variable SHIFRDOLS varchar(100);
declare variable ISDEK integer;
declare variable CLOCK decimal(10,2);
declare variable SUMMAPREV decimal(10,2);
declare variable DOPL decimal(10,2);
declare variable SUMMANEW decimal(10,2);
declare variable STAWKAOLD decimal(10,2);
declare variable SUMMACN decimal(10,2);
begin
  /* Перерасчет начислений в апр 2013 за янв и фвр 13-го из-за повыш окладов задним числом */
 -- y=2013;
 -- m=1;
 -- dt=y||'-'||M||'-01';
  POCHASSHIFR=37;
  POCHASDOLG=1455;
  DELETE FROM TB_RCLCPOCHAS1301 where y=:y and m=:m;
  SELECT COUNT(*) FROM TB_RCLCPOCHAS1301 INTO :TABNO;
  for
      select p.shifrid, p.tabno, p.fio,p.dolg,
             p.w_place from person p
             where p.yearvy=:y and
                   (
                     ((select first 1 shifriddolg from pr_get_dolg_person_by_id(p.shifrid))=:pochasdolg) or
                       (
                         (not exists (select * from fadd a where a.shifridperson=p.shifrid and a.shifrsta<>:pochasshifr))
                         and (exists (select * from fadd b where b.shifridperson=p.shifrid))
                        )
                   ) and
                   p.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140) and
                   exists (select * from fadd b where b.shifridperson=p.shifrid
                                                   and b.shifrsta=:pochasshifr
                                                   and b.month_za=:m
                                                   and b.year_za=:y)
             --      and p.tabno=1330

             into :shifrid,  :tabno,    :fio, :dolg,
                  :w_place
  do
     begin
           if (tabno=1356) then
               tabno=1356;
           ShifrDol=0;
           select first 1 coalesce(prim,0) from fcn
                  where fcn.shifridperson=:shifrid and
                        fcn.shifrsta=100+500
                        and fcn.kod=100
                        and fcn.prim>0
                        into :shifrdol;

           select coalesce(a.guid,'') from pr_GETGUID(:shifrid,0) a into :guid;
           shifrst=0;
           summacn=0;
           select first 1 coalesce(fcn.summa,0) from fcn
                  where fcn.tabno=:tabno and
                        fcn.shifrsta=18
                        and fcn.kod=2
                        and fcn.summa>0
                        and fcn.year_vy=:y
                        and fcn.month_vy=:m
                        into :summacn;
           shifrst=case
                       when abs(abs(summacn)-25.00)<1.00 then 2
                       when abs(abs(summacn)-15.00)<1.00 then 1
                       else 0
                   end;
           shifrzw=0;
           summacn=0;
           select first 1 coalesce(summa,0) from fcn
                  where fcn.tabno=:tabno and
                        fcn.shifrsta=22
                        and fcn.kod=2
                        and fcn.summa>0
                        and fcn.year_vy=:y
                        and fcn.month_vy=:m
                        into :summacn;
           shifrzw=case
                       when abs(abs(summacn)-33.00)<1.00 then 2
                       when abs(abs(summacn)-25.00)<1.00 then 1
                       else 0
                   end;
           ismg=0;
           isdek=0;
           if (w_place=79) then ismg=1;
           if (exists (select * from person per
                              where per.tabno=:tabno
                                and per.yearvy=:y
                                and per.monthvy=:m
                                and (select coalesce(shifriddolg,0) from pr_get_dolg_person_by_id(per.shifrid))=70 --декан
                      )) then
              isdek=1;
           if (isdek=0) then
              if (exists (select * from person per
                              where per.tabno=:tabno
                                and per.yearvy=:y
                                and per.monthvy=:m
                                and per.w_place=8
                                and (
                                     (LTRIM(RTRIM(TRIM(per.dolg)))='ДЕКАН')  --декан
                                  or
                                     (LTRIM(RTRIM(TRIM(per.dolg)))='ДИРЕКТОР')  --директор
                                    )
                      )) then
              isdek=1;
           select coalesce(dolg,'') from pr_get_dolg_person_y_m(:tabno,:y, :m) into :shifrdols;
           shifrdols=trim(upper(shifrdols));
           if (trim(shifrdols)='70 ДЕКАН.') then
              isdek=1;
           if ((trim(shifrdols)='70 ДЕКАН.')   OR
               (upper(trim(shifrdols))='ЗАВ.КАФ') OR
               (upper(trim(shifrdols))='ДИРЕКТОР')) then
              if ((shifrst=2) and (shifrzw=2)) then isdek=1;
           shifridrclc=gen_id(g_rclcpochas1301,1);
           if ((coalesce(ismg,01)=1) or (coalesce(isdek,0)=1))  then
              stawkanew=case
                            when shifrzw=2 then 91.85
                            when shifrst=2 then 72.68
                            when ((shifrst=1) or (shifrzw=1)) then 58.11
                            else 48.56
                        end;
           else
              stawkanew=case
                            when shifrzw=2 then 79.66
                            when shifrst=2 then 62.96
                            when ((shifrst=1) or (shifrzw=1)) then 48.56
                            else 38.77
                         end;


           insert into TB_RCLCPOCHAS1301 (SHIFRID ,TABNO,          FIO,       DOLG , SHIFRDOL,
                                          shifrtst , shifrzw, isdek, ismg, shifrpod,
                                          y,m,guid) VALUES(
                                          :shifridrclc     ,:tabno,         :fio,      :dolg, :shifrdol ,
                                          :shifrst,         :shifrzw,       :isdek,    :ismg, :w_place,
                                          :Y,               :m, :GUID);
           for
              select coalesce(d.wclock,0.00),coalesce(d.summa,0.00) from fadd d
                     where d.shifridperson=:shifrid
                       and d.shifrsta=:pochasshifr
                       and d.year_za=:y
                       and d.month_za=:m
                     into :clock,:summaprev
           do
             begin
                  summanew=clock*stawkanew;
                  stawkaold=0;
                  if (clock>0.01) then
                     stawkaold=summaprev/clock;
                  stawkanew=case
                                when abs(abs(stawkaold)-23.91)<0.01 then 24.28
                                when abs(abs(stawkaold)-28.53)<0.01 then 28.97
                                when abs(abs(stawkaold)-28.97)<0.01 then 28.97
                                when abs(abs(stawkaold)-38.17)<0.01 then 38.77
                                when abs(abs(stawkaold)-47.82)<0.01 then 48.56
                            --    when abs(abs(stawkaold)-54.72)<0.01 then 58.11
                                when abs(abs(stawkaold)-57.22)<0.01 then 58.11
                                when abs(abs(stawkaold)-62.00)<0.01 then 62.96
                                when abs(abs(stawkaold)-78.45)<0.01 then 79.66
                                when abs(abs(stawkaold)-90.44)<0.01 then 91.85
                                when abs(abs(stawkaold)-113.05)<0.01 then 114.81
                                else stawkanew
                            end;
                  summanew=clock*stawkanew;
                  dopl=summanew-summaprev;
                  insert into tb_rclcpochas1301_pr (shifridowner,
                         summaold, nmbofclock, stawkaold, stawkanew, summanew,
                         dopl) values  (
                           :shifridrclc,
                           :summaprev,:clock,:stawkaold,:stawkanew, :summanew,
                           :dopl);


             end
     end
end^


ALTER PROCEDURE PR_RECALC_PODOH_2012
RETURNS (
    FIO VARCHAR(51),
    TABNO INTEGER,
    SUMMAADD1 DECIMAL(10,2),
    SUMMAUD1 DECIMAL(10,2),
    SUMMARAS1 DECIMAL(10,2),
    SUMMAREZ1 DECIMAL(10,2),
    SUMMAADD2 DECIMAL(10,2),
    SUMMAUD2 DECIMAL(10,2),
    SUMMARAS2 DECIMAL(10,2),
    SUMMAREZ2 DECIMAL(10,2),
    SUMMAADD3 DECIMAL(10,2),
    SUMMAUD3 DECIMAL(10,2),
    SUMMARAS3 DECIMAL(10,2),
    SUMMAREZ3 DECIMAL(10,2),
    SUMMAADD4 DECIMAL(10,2),
    SUMMAUD4 DECIMAL(10,2),
    SUMMARAS4 DECIMAL(10,2),
    SUMMAREZ4 DECIMAL(10,2),
    SUMMAADD5 DECIMAL(10,2),
    SUMMAUD5 DECIMAL(10,2),
    SUMMARAS5 DECIMAL(10,2),
    SUMMAREZ5 DECIMAL(10,2),
    SUMMAADD6 DECIMAL(10,2),
    SUMMAUD6 DECIMAL(10,2),
    SUMMARAS6 DECIMAL(10,2),
    SUMMAREZ6 DECIMAL(10,2),
    SUMMAADD7 DECIMAL(10,2),
    SUMMAUD7 DECIMAL(10,2),
    SUMMARAS7 DECIMAL(10,2),
    SUMMAREZ7 DECIMAL(10,2),
    SUMMAADD8 DECIMAL(10,2),
    SUMMAUD8 DECIMAL(10,2),
    SUMMARAS8 DECIMAL(10,2),
    SUMMAREZ8 DECIMAL(10,2),
    SUMMAADD9 DECIMAL(10,2),
    SUMMAUD9 DECIMAL(10,2),
    SUMMARAS9 DECIMAL(10,2),
    SUMMAREZ9 DECIMAL(10,2),
    SUMMAADD10 DECIMAL(10,2),
    SUMMAUD10 DECIMAL(10,2),
    SUMMARAS10 DECIMAL(10,2),
    SUMMAREZ10 DECIMAL(10,2),
    SUMMAADD11 DECIMAL(10,2),
    SUMMAUD11 DECIMAL(10,2),
    SUMMARAS11 DECIMAL(10,2),
    SUMMAREZ11 DECIMAL(10,2),
    SUMMAADD12 DECIMAL(10,2),
    SUMMAUD12 DECIMAL(10,2),
    SUMMARAS12 DECIMAL(10,2),
    SUMMAREZ12 DECIMAL(10,2))
AS
declare variable M integer;
declare variable Y integer;
declare variable SUMMAADD decimal(10,2);
declare variable SUMMAUD decimal(10,2);
declare variable SUMMARAS decimal(10,2);
declare variable SUMMAREZ decimal(10,2);
declare variable SUMMALIM decimal(10,2);
begin
     Y=2012;
     delete from TB_R_2012;
     select first 1 a.limitforsec from podohtbl a
                                  where a.datefr<='2011-01-01'
                                  order by a.datefr desc
                                  into :summalim;
     for
        select a.tabno from person a
                       where a.yearvy=:Y
                       group by a.tabno
                       into :tabno
     do
       begin
            SUMMAADD1  =  0.00;
            SUMMAUD1   =  0.00;
            SUMMARAS1  =  0.00;
            SUMMAREZ1  =  0.00;
            SUMMAADD2  =  0.00;
            SUMMAUD2   =  0.00;
            SUMMARAS2  =  0.00;
            SUMMAREZ2  =  0.00;
            SUMMAADD3  =  0.00;
            SUMMAUD3   =  0.00;
            SUMMARAS3  =  0.00;
            SUMMAREZ3  =  0.00;
            SUMMAADD4  =  0.00;
            SUMMAUD4   =  0.00;
            SUMMARAS4  =  0.00;
            SUMMAREZ4  =  0.00;
            SUMMAADD5  =  0.00;
            SUMMAUD5   =  0.00;
            SUMMARAS5  =  0.00;
            SUMMAREZ5  =  0.00;
            SUMMAADD6  =  0.00;
            SUMMAUD6   =  0.00;
            SUMMARAS6  =  0.00;
            SUMMAREZ6  =  0.00;
            SUMMAADD7  =  0.00;
            SUMMAUD7   =  0.00;
            SUMMARAS7  =  0.00;
            SUMMAREZ7  =  0.00;
            SUMMAADD8  =  0.00;
            SUMMAUD8   =  0.00;
            SUMMARAS8  =  0.00;
            SUMMAREZ8  =  0.00;
            SUMMAADD9  =  0.00;
            SUMMAUD9   =  0.00;
            SUMMARAS9  =  0.00;
            SUMMAREZ9  =  0.00;
            SUMMAADD10 =  0.00;
            SUMMAUD10  =  0.00;
            SUMMARAS10 =  0.00;
            SUMMAREZ10 =  0.00;
            SUMMAADD11 =  0.00;
            SUMMAUD11  =  0.00;
            SUMMARAS11 =  0.00;
            SUMMAREZ11 =  0.00;
            SUMMAADD12 =  0.00;
            SUMMAUD12  =  0.00;
            SUMMARAS12 =  0.00;
            SUMMAREZ12 =  0.00;
            select first 1 a.fio from kadry a where a.tabno=:tabno into :fio;
            for
               select a.monthvy from person a
                                where a.yearvy=2012 and
                                      a.tabno=:tabno
                                group by a.monthvy
                                into :m
            do
               begin
                    summaadd = 0;
                    summaud  = 0;
                    summaras = 0;
                    summarez = 0;
                    select summaadd, summapod  from getpodnachud_common(:tabno, 2012,:m, 0,0,0,0)
                                               into :summaadd,:summaud;
                    SummaAdd=coalesce(SummaAdd,0.00);
                    if (SummaAdd>SummaLim) then
                       begin
                            select first 1 a.summapodras,a.summapodrazn from  pr_recalcpodohmonth_2010(:tabno, :y,:m) a
                                                                        into :summaras,:summarez;
                            summaras=coalesce(summaras,0.00);
                            summarez=coalesce(summarez,0.00);
                            if (m=1) then begin
                                               summaadd1 = SummaAdd;
                                               SummaUd1  = SummaUd;
                                               summaRas1 = SummaRas;
                                               SummaRez1 = SummaRez;
                                          end
                            else
                            if (m=2) then begin
                                               summaadd2 = SummaAdd;
                                               SummaUd2  = SummaUd;
                                               summaRas2 = SummaRas;
                                               SummaRez2 = SummaRez;
                                           end
                            else
                            if (m=3) then begin
                                               summaadd3 = SummaAdd;
                                               SummaUd3  = SummaUd;
                                               summaRas3 = SummaRas;
                                               SummaRez3 = SummaRez;
                                           end
                            else
                            if(m=4) then begin
                                               summaadd4 = SummaAdd;
                                               SummaUd4  = SummaUd;
                                               summaRas4 = SummaRas;
                                               SummaRez4 = SummaRez;
                                         end
                            else
                            if (m=5) then begin
                                               summaadd5 = SummaAdd;
                                               SummaUd5  = SummaUd;
                                               summaRas5 = SummaRas;
                                               SummaRez5 = SummaRez;
                                          end
                            else
                            if (m=6) then begin
                                               summaadd6 = SummaAdd;
                                               SummaUd6  = SummaUd;
                                               summaRas6 = SummaRas;
                                               SummaRez6 = SummaRez;
                                          end
                            else
                            if (m=7) then begin
                                               summaadd7 = SummaAdd;
                                               SummaUd7  = SummaUd;
                                               summaRas7 = SummaRas;
                                               SummaRez7 = SummaRez;
                                          end
                            else
                            if (m=8) then begin
                                               summaadd8 = SummaAdd;
                                               SummaUd8  = SummaUd;
                                               summaRas8 = SummaRas;
                                               SummaRez8 = SummaRez;
                                          end
                            else
                            if (m=9) then begin
                                               summaadd9 = SummaAdd;
                                               SummaUd9  = SummaUd;
                                               summaRas9 = SummaRas;
                                               SummaRez9 = SummaRez;
                                          end
                            else
                            if (m=10) then begin
                                                summaadd10 = SummaAdd;
                                                SummaUd10  = SummaUd;
                                                summaRas10 = SummaRas;
                                                SummaRez10 = SummaRez;
                                           end
                            else
                            if (m=11) then begin
                                                summaadd11 = SummaAdd;
                                                SummaUd11  = SummaUd;
                                                summaRas11 = SummaRas;
                                                SummaRez11 = SummaRez;
                                           end
                            else
                            if (m=12) then begin
                                                summaadd12 = SummaAdd;
                                                SummaUd12  = SummaUd;
                                                summaRas12 = SummaRas;
                                                SummaRez12 = SummaRez;
                                           end
                       end
               end
            if (
                 (abs(SummaRez1)>0.01) or
                 (abs(SummaRez2)>0.01) or
                 (abs(SummaRez3)>0.01) or
                 (abs(SummaRez4)>0.01) or
                 (abs(SummaRez5)>0.01) or
                 (abs(SummaRez6)>0.01) or
                 (abs(SummaRez7)>0.01) or
                 (abs(SummaRez8)>0.01) or
                 (abs(SummaRez9)>0.01) or
                 (abs(SummaRez10)>0.01) or
                 (abs(SummaRez11)>0.01) or
                 (abs(SummaRez12)>0.01)
               ) then
                 begin
                      insert into tb_r_2012(
                                             FIO ,   TABNO ,
                                             SUMMAADD1 ,  SUMMAUD1 , SUMMARAS1 , SUMMAREZ1 ,
                                             SUMMAADD2 ,  SUMMAUD2 , SUMMARAS2 , SUMMAREZ2 ,
                                             SUMMAADD3 ,  SUMMAUD3 , SUMMARAS3 , SUMMAREZ3 ,
                                             SUMMAADD4 ,  SUMMAUD4 , SUMMARAS4 , SUMMAREZ4 ,
                                             SUMMAADD5 ,  SUMMAUD5 , SUMMARAS5 , SUMMAREZ5 ,
                                             SUMMAADD6 ,  SUMMAUD6 , SUMMARAS6 , SUMMAREZ6 ,
                                             SUMMAADD7 ,  SUMMAUD7 , SUMMARAS7 , SUMMAREZ7 ,
                                             SUMMAADD8 ,  SUMMAUD8 , SUMMARAS8 , SUMMAREZ8 ,
                                             SUMMAADD9 ,  SUMMAUD9 , SUMMARAS9 , SUMMAREZ9 ,
                                             SUMMAADD10,  SUMMAUD10, SUMMARAS10, SUMMAREZ10,
                                             SUMMAADD11,  SUMMAUD11, SUMMARAS11, SUMMAREZ11,
                                             SUMMAADD12,  SUMMAUD12, SUMMARAS12, SUMMAREZ12)
                                       values(:fio, :tabno,
                                             :SUMMAADD1 ,  :SUMMAUD1 , :SUMMARAS1 , :SUMMAREZ1 ,
                                             :SUMMAADD2 ,  :SUMMAUD2 , :SUMMARAS2 , :SUMMAREZ2 ,
                                             :SUMMAADD3 ,  :SUMMAUD3 , :SUMMARAS3 , :SUMMAREZ3 ,
                                             :SUMMAADD4 ,  :SUMMAUD4 , :SUMMARAS4 , :SUMMAREZ4 ,
                                             :SUMMAADD5 ,  :SUMMAUD5 , :SUMMARAS5 , :SUMMAREZ5 ,
                                             :SUMMAADD6 ,  :SUMMAUD6 , :SUMMARAS6 , :SUMMAREZ6 ,
                                             :SUMMAADD7 ,  :SUMMAUD7 , :SUMMARAS7 , :SUMMAREZ7 ,
                                             :SUMMAADD8 ,  :SUMMAUD8 , :SUMMARAS8 , :SUMMAREZ8 ,
                                             :SUMMAADD9 ,  :SUMMAUD9 , :SUMMARAS9 , :SUMMAREZ9 ,
                                             :SUMMAADD10,  :SUMMAUD10, :SUMMARAS10, :SUMMAREZ10,
                                             :SUMMAADD11,  :SUMMAUD11, :SUMMARAS11, :SUMMAREZ11,
                                             :SUMMAADD12,  :SUMMAUD12, :SUMMARAS12, :SUMMAREZ12);

                      suspend;
                 end
       end

  /* Procedure Text */
end^


ALTER PROCEDURE PR_RECALCIND_10 (
    Y INTEGER,
    M INTEGER)
AS
declare variable SHIFRID integer;
declare variable TABNO integer;
declare variable SHIFRGRU integer;
declare variable DOLG varchar(10);
declare variable FIO varchar(20);
declare variable SHIFRKAT integer;
declare variable RAZRJAD integer;
declare variable OKLAD decimal(15,2);
declare variable KALEND_DAY integer;
declare variable WORK_DAY integer;
declare variable ILL_DAY integer;
declare variable OTP_DAY integer;
declare variable NEW_OKLAD decimal(15,2);
declare variable OLD_VYPL_OKLAD decimal(15,2);
declare variable NEW_VYPL_OKLAD decimal(15,2);
declare variable W_PLACE integer;
declare variable DT date;
declare variable KOEF decimal(15,2);
declare variable DOPL_OKLAD decimal(15,2);
declare variable NADB_ZW_PR decimal(15,2);
declare variable DOPL_ZW decimal(15,2);
declare variable NADB_ST_PR decimal(15,2);
declare variable DOPL_ST decimal(15,2);
declare variable NADB_VYSL_PR decimal(15,2);
declare variable DOPL_VYSL decimal(15,2);
declare variable W_R integer;
declare variable CN_OSN integer;
declare variable ISPOVYSH integer;
declare variable ISKOMP_N_O integer;
declare variable NADB_ZS_PR decimal(15,2);
declare variable DOPL_ZS decimal(15,2);
declare variable DOPL_P_ZS decimal(15,2);
declare variable KOEF_O decimal(15,7);
declare variable SHIFRDOL integer;
declare variable SUMMAIND decimal(15,2);
declare variable SUMMAFORIND decimal(15,2);
declare variable SUMMANEEDIND decimal(15,2);
declare variable DOPLIND decimal(15,2);
declare variable ISDOPL integer;
begin
  /* Procedure Text */
 -- y=2010;
 -- m=1;
  dt=y||'-'||M||'-01';
  DELETE FROM RCLCIND0110 where y=:y and m=:m;
  SELECT COUNT(*) FROM RCLCind0110 INTO :TABNO;
  kalend_day=case
      when m=1 then 19
      when m=2 then 20
      when m=3 then 22
      when m=4 then 21
      when m=5 then 17
      else 0
  end;
  if (kalend_day=0) then
     exit;
  work_day=kalend_day;
  ill_day=0;
  otp_day=0;
  for
      select person.shifrid, person.tabno, person.fio,person.dolg,
             person.shifrgru, person.shifrkat,person.w_place,
             person.razrjad,person.oklad,person.w_r from person
--             join podr on person.w_place=podr.shifrpod
             where person.yearvy=:y and person.monthvy=:m and
      --             person.shifrkat=1 and person.oklad>0.01 and
--                   person.w_place not between 151 and 168  and
--                   person.w_place not in (76,81,82,85,86,87,89,91,98,99,102,105,106,121,128,140) and
                   exists (select * from fadd where fadd.shifridperson=person.shifrid and fadd.shifrsta=28 and fadd.month_za=:m) and
                   person.razrjad between 1 and 5
            --       person.w_place=141
            --       (podr.name like 'Кафедра%' or
            --        podr.shifrpod in (8,104,133,134,135)
            --       ) -- and tabno=4624
             into :shifrid,:tabno,:fio,:dolg,
                  :shifrgru,:shifrkat,:w_place,
                  :razrjad,:oklad, :w_r
  do
     begin
          ISDOPL=0;
          if (exists (select * from fadd a
                          where a.tabno=  :tabno
                          and a.year_za=  :y
                          and a.month_za= :m
                          and a.shifrsta in (33,30,39,40))) then
             ISDOPL=1;

          select first 1 prim from fcn
                       where fcn.shifridperson=:shifrid and
                       fcn.shifrsta=100+500
                       and fcn.kod=100
                       and fcn.prim>0
                       into :shifrdol;
          shifrdol=coalesce(shifrdol, 0);
          select sum(fadd.summa) from fadd
                 where fadd.tabno=:tabno and
                       fadd.shifridperson=:shifrid and
                       fadd.shifrsta=28 and
                       fadd.month_za=:m
                 into  :summaind;
          select first 1 retval from work_day(:tabno,:dt) into :work_day;
          select first 1 retval from ill_day(:tabno,:dt)  into :ill_day;
          select first 1 retval from otp_day(:tabno,:dt)  into :otp_day;

          work_day=coalesce(work_day,0);
          if (:work_day=0) then
             select first 1 retval from work_day_for_sowm(:tabno,:dt) into :work_day;
          select sum(a.summa) from fadd a
                 where a.month_za=:m and a.year_za=:y and a.tabno=:Tabno and
--             not exists(select shifrsta from shifry_ind where shifry_ind.shifrsta=a.shifrsta)
                 exists(select * from shifr b where b.shifr=a.shifrsta and b.ind=1)  and
                 not exists(select * from i_podr c where c.shifr_pod=a.w_place and c.mode=5)
                 into :summaforind;
          summaforind=coalesce(summaforind,0);
          summaneedind=case
                          when isdopl=0 then
                                            case
                                                when m in (4,5) then
                                                     case
                                                         when summaforind>884 then 884
                                                         else summaforind
                                                     end * 0.019
                                                else 0
                                            end
                          else
                                            case
                                                when m in (4,5) then 0
                                                else 0
                                            end

                       end;
          doplind = summaneedind-summaind;

          if (summaind>0.001) then
             insert into rclcind0110 (TABNO,          FIO,        W_PLACE,    shifrgru, shifrkat,
                                      dolg,           work_day,   kalend_day, ill_day,  otp_day,
                                      koef,           razr,       shifrdol,
                                      sumindvypl,sumindneed,doplind,summaforindex,
                                      w_r, cn_osn, 
                                      y ,m,isdopl     ) VALUES(
                                          :tabno,         :fio,       :w_place,   :shifrgru, :shifrkat,
                                          :dolg,          :work_day,  :kalend_day,:ill_day,  :otp_day,
                                          :koef,          :razrjad,   :shifrdol,
                                          :summaind,:summaneedind,:doplind, :summaforind,
                                          :w_r,       :cn_osn,
                                          :Y ,:M,:isdopl) ;
           end
end^


ALTER PROCEDURE PR_RECALCPODOHMONTH_2010 (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
declare variable D date;
declare variable SUMMALIMITFORECB decimal(10,2);
declare variable SUMMAECB decimal(10,2);
begin
     SummaECBNAdd    = 0;
     SummaECBNRazn   = 0;
     SummaECBNRas    = 0;
     SummaECBNUd     = 0;
     SummaECBAdd     = 0;
     SummaECBRazn    = 0;
     SummaECBRas     = 0;
     SummaECBUd      = 0;
     SummaECBDPAdd   = 0;
     SummaECBDPRazn  = 0;
     SummaECBDpRas   = 0;
     SummaECBDpUd    = 0;
     SummaECBIllAdd  = 0;
     SummaECBIllRazn = 0;
     SummaECBIllRas  = 0;
     SummaECBIllUd   = 0;

     d=yearza||'-'||monthza||'-01';
     select first 1 limitmax  from sslimity
                              where datefr<:d
                              order by datefr desc
                              into :summalimitforecb;
     summalimitforecb=coalesce(summalimitforecb, 14000);
     select first 1 summaadd,summaecb    from getecbnnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbnadd, :summaecbnud;
     select first 1 summaadd,summaecb    from getecbnAchud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbadd, :summaecbud;
     select first 1 summaadd,summaecb    from getecbdpnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbdpadd, :summaecbdpud;
     select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbilladd, :summaecbillud;
     if (SummaECBNAdd>SummaLimitForECB) then
        begin
             SummaECBNAdd   = SummaLimitForECB;
             SummaECBAdd    = 0;
             SummaECBDpAdd  = 0;
             SummaECBIllAdd = 0;
        end
     else
     if (SummaECBNAdd+SummaECBAdd>SummaLimitForECB) then
        begin
             SummaECBAdd    = SummaLimitForECB - SummaECBNAdd;
             SummaECBDpAdd  = 0;
             SummaECBIllAdd = 0;
        end
     else
     if (SummaECBNAdd+SummaECBAdd+SummaECBDpAdd>SummaLimitForECB) then
        begin
             SummaECBDpAdd  = SummaLimitForECB - SummaECBNAdd - SummaECBAdd;
             SummaECBIllAdd = 0;
        end
     else
     if (SummaECBNAdd+SummaECBAdd+SummaECBDpAdd+SummaECBIllAdd>SummaLimitForECB) then
        begin
             SummaECBIllAdd = SummaLimitForECB - (SummaECBNAdd + SummaECBAdd + SummaECBDpAdd);
        end




     if (abs(SummaECBNAdd)>0.01) then
        begin
             select first 1 SummaECB from ECBN_common(:tabno, :YearZa,:MonthZa,:SummaEcbNAdd) into :SummaEcbNRas;
             SummaECBNRazn=:SummaECBNRas-:SummaECBNUd;
        end

     if (abs(SummaECBAdd)>0.01) then
        begin
             select first 1 SummaECB from ECB_common(:tabno, :YearZa,:MonthZa,:SummaecbAdd,0,0) into :SummaEcbRas;
             SummaECBRazn=:SummaECBRas-:SummaECBUd;
        end
     if (abs(SummaECBDpAdd)>0.01) then
        begin
             select first 1 SummaECB from ECBDp_common(:tabno, :YearZa,:MonthZa,:SummaECBDPAdd) into :SummaEcbDPRas;
             SummaECBDPRazn=:SummaECBDpRas-:SummaECBDpUd;
        end

     if (abs(SummaECBIllAdd)>0.01) then
        begin
             select first 1 SummaECBill from ECBIll_common(:tabno, :YearZa,:MonthZa,:SummaECBIllAdd) into :SummaEcbIllRas;
             SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
        end

     select first 1 summaadd,summapod from getpodnachud(:tabno,:yearza,:monthza) into :summapodadd, :summapodud;
     summaecb=coalesce(SummaECBNRas,0.00)+coalesce(SummaECBRas,0.00)+coalesce(SummaECBIllRas,0.00);
     select first 1 SummaPod from podoh_2010(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:SummaECB,0) into :SummaPodRas;
     SummaPodRazn=:SummaPodRas-:SummaPodUd;
     Suspend;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_REFILL_OTP_2012_01
RETURNS (
    NMBOFREC INTEGER)
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
    nmbofrec=0;
    for
       select tabno,shifr_pod from kadry a where tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              and not exists (select * from tb_otpusk_2012_01 b where b.tabno=a.tabno)
              and exists (select * from person c where c.tabno=a.tabno and c.yearvy=2011 and c.monthvy=12)
              into :tabno,:w_place
    do
      begin
           nmbofrec=nmbofrec+1;
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_01(tabno,selected,w_place) values(:tabno,0,:w_place);
      end
  --  nmbofrec=0;
    for
       select tabno,w_place from person a where tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              and not exists (select * from tb_otpusk_2012_01 b where b.tabno=a.tabno and b.w_place=a.w_place)
              into :tabno,:w_place
    do
      begin
           nmbofrec=nmbofrec+1;
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_01(tabno,selected,w_place) values(:tabno,0,:w_place);
      end
    suspend;
end^


ALTER PROCEDURE PR_REFILL_OTP_2012_04
RETURNS (
    NMBOFREC INTEGER)
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
    nmbofrec=0;
    for
       select tabno,shifr_pod from kadry a where tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              and not exists (select * from tb_otpusk_2012_01 b where b.tabno=a.tabno)
              and exists (select * from person c where c.tabno=a.tabno and c.yearvy=2011 and c.monthvy=12)
              into :tabno,:w_place
    do
      begin
           nmbofrec=nmbofrec+1;
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_01(tabno,w_place) values(:tabno,:w_place);
      end
  --  nmbofrec=0;
    for
       select tabno,w_place from person a where tabno>0 and
              strlen(ltrim(rtrim(a.fio)))>1 and a.fio not starting with 'неверно'
              and not exists (select * from tb_otpusk_2012_04 b where b.tabno=a.tabno and b.w_place=a.w_place)
              into :tabno,:w_place
    do
      begin
           nmbofrec=nmbofrec+1;
           w_place=coalesce(w_place,0);
           insert into tb_otpusk_2012_04(tabno,w_place) values(:tabno,:w_place);
      end
    suspend;
end^


ALTER PROCEDURE PR_RENEW_OTP_2012_01
RETURNS (
    NMBOFREC INTEGER)
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
     delete from tb_otpusk_2012_01 a
      where not exists (select first 1 * from person b
            where b.tabno=a.tabno and b.yearvy=2011 and b.monthvy=12)
            and a.selected=0;
    nmbofrec=0;
    suspend;
end^


ALTER PROCEDURE PR_RENEW_OTP_2012_04
RETURNS (
    NMBOFREC INTEGER)
AS
declare variable TABNO integer;
declare variable W_PLACE integer;
begin
     delete from tb_otpusk_2012_04 a
      where not exists (select first 1 * from person b
            where b.tabno=a.tabno and b.yearvy=2012 and b.monthvy=3)
            and  not (a.apr30=1 or a.may03=1 or a.may04=1 or a.may07=1 or a.may08=1 or a.may10=1 or a.may11=1);
    nmbofrec=0;
    suspend;
end^


ALTER PROCEDURE PR_REP_GANNA_SVDN (
    DATEFR DATE,
    DATETO DATE,
    SHIFRKAT INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(128),
    DOLG VARCHAR(32),
    OKLAD DECIMAL(15,2),
    COMMENT VARCHAR(128),
    SUMMAOPL DECIMAL(15,2),
    SUMMAOKL DECIMAL(15,2),
    SUMMAST DECIMAL(15,2),
    SUMMAZW DECIMAL(15,2),
    SUMMAVYSL DECIMAL(15,2),
    PROCST DECIMAL(15,2),
    PROCZW DECIMAL(15,2),
    PROCVYSL DECIMAL(15,2),
    SHIFRKAF INTEGER)
AS
declare variable DF date;
declare variable DT date;
declare variable SHIFRID integer;
begin
    -- shifrkat - 1 - АУП
    --          - 2 - ППС
    --          - 3 - УВП
    --          - 4 - АХЧ
    --          - 5 - Н С
     df=extract(year from datefr)||'-'||extract(month from datefr)||'-01';
     dt=extract(year from dateto)||'-'||extract(month from dateto)||'-01';
     dt=addmonth(dt,1);
     dt=dt-1;
     for
        select a.tabno,a.fio from kadry a
              where
                   exists (select * from person b
                                    where coalesce((select sum(c.summa) from fadd c where c.shifridperson=b.shifrid),0)>0.01
                                      and b.yearvy||'-'||b.monthvy||'-10' between :df and :dt
                                      and (select shifrwr from pr_isosnwrbyid(b.shifrid))=1
                                      and b.tabno=a.tabno
                                      and b.oklad>0.01
                                      and
                                         (
                                          ((:shifrkat=1) and (b.shifrkat in (5,7))) -- ППС
                                          or
                                          ((:shifrkat=2) and (b.shifrkat=1)) -- ППС
                                          or
                                          ((:shifrkat=3) and (b.shifrkat=2)) -- УВП
                                          or
                                          ((:shifrkat=4) and (b.shifrkat in (4,6))) -- АХЧ
                                          or
                                          ((:shifrkat=5) and (b.shifrkat=3)) -- Н С
                                         )
                                      )
       into :tabno,:fio
                                   --   b.shifrkat=:shifrkat)
     do
       begin
            shifrid= null;
            shifrkaf=null;
            select first 1 a.shifrid,a.w_place from person a
                   where coalesce((select sum(c.summa) from fadd c where c.shifridperson=a.shifrid),0)>0.01
                                      and a.yearvy||'-'||a.monthvy||'-10' between :df and :dt
                                      and (select shifrwr from pr_isosnwrbyid(a.shifrid))=1
                                      and a.tabno=:tabno
                                --      and a.shifrkat=:shifrkat
                                      and
                                         (
                                          ((:shifrkat=1) and (a.shifrkat in (5,7))) -- ППС
                                          or
                                          ((:shifrkat=2) and (a.shifrkat=1)) -- ППС
                                          or
                                          ((:shifrkat=3) and (a.shifrkat=2)) -- УВП
                                          or
                                          ((:shifrkat=4) and (a.shifrkat in (4,6))) -- АХЧ
                                          or
                                          ((:shifrkat=5) and (a.shifrkat=3)) -- Н С
                                         )



                                      and a.oklad>0.01
                   order by cast((a.yearvy||'-'||a.monthvy||'-10') as date) desc
                   into :shifrid,:shifrkaf;
            if (:shifrid is not null) then
               begin
                    dolg  = null;
                    oklad = null;
                    select dolg,oklad from person a where a.shifrid=:shifrid
                          into :dolg, :oklad;
                    oklad=coalesce(oklad,0.00);
                    summaokl  = oklad;
                    summast   = null;
                    summazw   = null;
                    summavysl = null;
                    procst    = null;
                    proczw    = null;
                    procvysl  = null;
                    select first 1 summa from fcn c
                           where c.shifridperson=:shifrid
                             and c.shifrsta=18
                           into :procst;
                    procst=coalesce(procst,0);
                    select first 1 summa from fcn c
                           where c.shifridperson=:shifrid
                             and c.shifrsta=22
                           into :proczw;
                    proczw=coalesce(proczw,0);
                    select first 1 summa from fcn c
                           where c.shifridperson=:shifrid
                             and c.shifrsta=8
                           into :procvysl;
                    procvysl=coalesce(procvysl,0);
                    comment='';
                    if ((procst=20.0) or (procst=25.0))  then
                       comment=trim(comment)||'д.н.';
                    if (procst=15.0) then
                       comment=trim(comment)||'к.н.';
                    if (proczw=25.0) then
                       comment=trim(comment)||' доц.';
                    if (proczw=33.0) then
                       comment=trim(comment)||' проф.';
                    summast   = coalesce(summaokl*procst/100.00,0.00);
                    summazw   = coalesce(summaokl*proczw/100.00,0.00);
                    summavysl = coalesce(summaokl*procvysl/100.00,0.00);

                    summaopl=summaokl+summast+summazw+summavysl;
                    comment=trim(comment);
                    suspend;
               end
       end
end^


ALTER PROCEDURE PR_REP_SINGL_RAS_FOR_DOUBLES (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    W_PLACE INTEGER)
AS
begin
     for
        select p.tabno,p.fio, p.w_place from person p
              where p.yearvy=:y
                and p.monthvy=:m
                and (select sum(a.summa) from fadd a
                            where a.shifridperson=p.shifrid
                              and a.shifrsta not in (31)
                              and a.w_place not in (106))>0.05
                and not exists (select * from fud u
                            where u.shifridperson=p.shifrid
                              and u.shifrsta in (50,142,143,144,145,146))
                and exists (select * from person p1
                              where p1.tabno=p.tabno
                                and p1.shifrid<>p.shifrid
                                and p1.yearvy=:y
                                and p1.monthvy=:m
                                and (select sum(a1.summa) from fadd a1
                                      where a1.shifridperson=p1.shifrid
                                        and a1.shifrsta not in (31)
                                        and a1.w_place not in (106))>0.05
                                and exists (select * from fud u1
                                    where u1.shifridperson=p1.shifrid
                                     and u1.shifrsta in (50,142,143,144,145,146))
                           )

        into
            :tabno,:fio,:w_place
     do
     begin
         suspend;
     end





end^


ALTER PROCEDURE PR_RESETDOTPMOV (
    CODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SHIFRID integer;
declare variable ISBUD integer;
declare variable ISVNE integer;
declare variable ISGN integer;
declare variable ISNIS integer;
begin
     -- CODE - 0 сбрсо всех дат
     -- CODE - 1 сброс отмеченных дат
     for
        select a.shifrid from tmp_otp_res a
                            where a.connid=current_connection
                            into :shifrid
     do
        begin
              select first 1 a.need_pere_bud,a.need_pere_vne,a.need_pere_gn,a.need_pere_nis  from tmp_otp_res a
                     where a.shifrid=:shifrid
                     into :isbud,:isvne,:isgn,:isnis;
              isbud=coalesce(isbud,0);
              isvne=coalesce(isvne,0);
              isgn =coalesce(isgn,0);
              isnis=coalesce(isnis,0);
              if ((isbud=1) or (code=0))  then
                 update tmp_otp_res a
                  set a.data_pere_bud=null
                  where a.shifrid=:shifrid;
              if ((isvne=1) or (code=0)) then
                 update tmp_otp_res a
                  set a.data_pere_vne=null
                  where a.shifrid=:shifrid;
              if ((isgn=1) or (code=0))  then
                 update tmp_otp_res a
                  set a.data_pere_gn=null
                  where a.shifrid=:shifrid;
              if ((isnis=1) or (code=0))  then
                 update tmp_otp_res a
                  set a.data_pere_nis=null
                  where a.shifrid=:shifrid;
        end
  /* Procedure Text */
  retval=1;
  suspend;
end^


ALTER PROCEDURE PR_ROOT_CHAIN_PERSON (
    TABNO INTEGER,
    YEARZA INTEGER,
    MONTHZA INTEGER,
    MODE INTEGER)
RETURNS (
    SUMMAADD DECIMAL(15,2),
    SUMMAUDF DECIMAL(15,2),
    SUMMAUDR DECIMAL(15,2),
    SUMMAUDN DECIMAL(15,2))
AS
declare variable SUMMAFZADD decimal(15,2);
declare variable SUMMAFZUD decimal(15,2);
declare variable SUMMAFZRAS decimal(15,2);
declare variable SUMMAFZRAZN decimal(15,2);
declare variable SUMMASSADD decimal(15,2);
declare variable SUMMASSUD decimal(15,2);
declare variable SUMMASSRAS decimal(15,2);
declare variable SUMMASSRAZN decimal(15,2);
declare variable SUMMAPENSADD decimal(15,2);
declare variable SUMMAPENSUD decimal(15,2);
declare variable SUMMAPENSRAS decimal(15,2);
declare variable SUMMAPENSRAZN decimal(15,2);
declare variable SUMMAPODADD decimal(15,2);
declare variable SUMMAPODUD decimal(15,2);
declare variable SUMMAPODRAS decimal(15,2);
declare variable SUMMAPODRAZN decimal(15,2);
declare variable SUMMAECBNADD decimal(15,2);
declare variable SUMMAECBNUD decimal(15,2);
declare variable SUMMAECBADD decimal(15,2);
declare variable SUMMAECBUD decimal(15,2);
declare variable SUMMAECBDPADD decimal(15,2);
declare variable SUMMAECBDPUD decimal(15,2);
declare variable SUMMAECBILLADD decimal(15,2);
declare variable SUMMAECBILLUD decimal(15,2);
declare variable SUMMAECBNRAS decimal(15,2);
declare variable SUMMAECBNRAZN decimal(15,2);
declare variable SUMMAECBRAS decimal(15,2);
declare variable SUMMAECBDPRAZN decimal(15,2);
declare variable SUMMAECBDPRAS decimal(15,2);
declare variable SUMMAECBRAZN decimal(15,2);
declare variable SUMMAECBILLRAS decimal(15,2);
declare variable SUMMAECBILLRAZN decimal(15,2);
begin
      summaadd=0;
      summaudf=0;
      summaudr=0;
      summaudn=0;
      SUMMAECBADD     = 0;
      SUMMAECBUD      = 0;
      SUMMAECBILLADD  = 0;
      SUMMAECBILLUD   = 0;
      SUMMAPODRAS     = 0;
      SUMMAPODRAZN    = 0;
      SUMMAECBNRAS    = 0;
      SUMMAECBNRAZN   = 0;
      SUMMAECBRAS     = 0;
      SUMMAECBRAZN    = 0;
      SUMMAECBDPRAS   = 0;
      SUMMAECBDPRAZN  = 0;
      SUMMAECBILLRAS  = 0;
      SUMMAECBILLRAZN = 0;

/*
      select first 1 summaadd,summafz from getfznachud_common(:tabno,:yearza,:monthza,1,0,0) into :summafzadd, :summafzud;
      select first 1 SummaFZ from FZ(:SummaFzAdd,:YearZa,:MonthZa,:tabno) into :SummaFzRas;
      SummaFZRazn=:SummaFzRas-:SummaFzUd;
      select first 1 summaadd,summass from getssnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summassadd, :summassud;
      select first 1 SummaSS from SS(:SummaSSAdd,:YearZa,:MonthZa) into :SummaSsRas;
      SummaSSRazn=:SummaSSRas-:SummaSSUd;
      select first 1 summaadd,summapens from getpensnachud_common(:tabno,:yearza,:monthza,1,0,0) into :summapensadd, :summapensud;
      select first 1 SummaPens from pens_common(:Tabno,:YearZa,:MonthZa,:SummaPensAdd,1) into :SummaPensRas;
      SummaPensRazn=:SummaPensRas-:SummaPensUd;
*/
      select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbnadd, :summaecbnud;


      select first 1 SummaECB from ecbn_common(:Tabno,:YearZa,:MonthZa,:SummaEcbNAdd) into :SummaECBnRas;
      SummaECBNRazn=:SummaECBNRas-:SummaECBNUd;
      select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbadd, :summaecbud;

      select first 1 SummaECB from ecb_common(:Tabno,:YearZa,:MonthZa,:SummaEcbAdd,1,0) into :SummaECBRas;
      SummaECBRazn=:SummaECBRas-:SummaECBUd;
      select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbdpadd, :summaecbdpud;

      select first 1 SummaECB from ecbdp_common(:Tabno,:YearZa,:MonthZa,:SummaEcbDpAdd) into :SummaECBDpRas;
      SummaECBDpRazn=:SummaECBDpRas-:SummaECBDpUd;

      select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summaecbilladd, :summaecbillud;
      select first 1 SummaECBIll from ecbill_common(:Tabno,:YearZa,:MonthZa,:SummaEcbIllAdd) into :SummaECBIllRas;
      SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
      select first 1 summaadd,summapod from getpodnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summapodadd, :summapodud;
      select first 1 SummaPod from podoh_common(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:summaecbnras+:summaecbras+:summaecbdpras+:summaecbillras,1) into :SummaPodRas;
      SummaPodRazn=:SummaPodRas-:SummaPodUd;



/*

      select first 1 summaadd,summapod from getpodnachud_common(:tabno,:yearza,:monthza,1,0,0,0) into :summapodadd, :summapodud;
      select first 1 SummaPod from podoh_common_2010(:tabno,:YearZa,:MonthZa, :SummaPodAdd,:SummaPensRas,:summassras,:summafzras,0,0,1) into :SummaPodRas;
      SummaPodRazn=:SummaPodRas-:SummaPodUd;
*/
      if (mode=1) then
         begin
              summaadd=summafzadd;
              summaudf=summafzud;
              summaudr=summafzras;
              summaudn=summafzrazn;
         end
      else
      if (mode=2) then
         begin
              summaadd=summassadd;
              summaudf=summassud;
              summaudr=summassras;
              summaudn=summassrazn;
         end
      else
      if (mode=3) then
         begin
              summaadd=summapensadd;
              summaudf=summapensud;
              summaudr=summapensras;
              summaudn=summapensrazn;
         end
      else
      if (mode=4) then
         begin
              summaadd=summaecbadd;
              summaudf=summaecbud;
              summaudr=summaecbras;
              summaudn=summaecbrazn;
         end
      else
      if (mode=5) then
         begin
              summaadd=summaecbnadd;
              summaudf=summaecbnud;
              summaudr=summaecbnras;
              summaudn=summaecbrazn;
         end
      else
      if (mode=6) then
         begin
              summaadd=summaecbdpadd;
              summaudf=summaecbdpud;
              summaudr=summaecbdpras;
              summaudn=summaecbdprazn;
         end
      else
      if (mode=7) then
         begin
              summaadd=summaecbilladd;
              summaudf=summaecbillud;
              summaudr=summaecbillras;
              summaudn=summaecbillrazn;
         end
      else
         begin
              summaadd=summapodadd;
              summaudf=summapodud;
              summaudr=summapodras;
              summaudn=summapodrazn;
         end

  /* Procedure Text */
      suspend;
end^


ALTER PROCEDURE PR_SBS_CALC_FOR_PERIOD (
    DATAZA DATE,
    SHIFRIDSBS INTEGER)
AS
declare variable Y integer;
declare variable M integer;
declare variable SHIFRIDSBSPR integer;
begin
     y=extract(year from :dataza);
     m=extract(month from :dataza);
     select first 1 a.shifrid  from tb_sprsbsprtable a
                               where a.shifridowner=:shifridsbs and
                                     a.year_za=:y and
                                     a.month_za=:m
                               into :shifridsbspr;
     shifridsbspr=coalesce(shifridsbspr,0);
     if (shifridsbspr=0) then exit;
     update tb_sprsbsprtable a
       set a.summa=(select sum(b.summa) from tb_sbs_sad_table b
                                        where b.shifridowner=a.shifrid
                                        and b.mark=1),
           a.summa_zarpl=0,
           a.summa_vne=0
       where a.shifrid=:shifridsbspr;
     update tb_sprsbsprtable a
       set a.summa_alim=(select sum(b.summa) from tb_sbs_sud_table b
                                        where b.shifridowner=a.shifrid
                                        and b.mark=1)
       where a.shifrid=:shifridsbspr;

  /* Procedure Text */

end^


ALTER PROCEDURE PR_SET_KADRY_PODR
RETURNS (
    RETVAL INTEGER)
AS
declare variable TABNO integer;
declare variable SHIFRPOD_OLD integer;
declare variable SHIFRPOD_NEW integer;
declare variable F varchar(55);
begin
     retval=0;
     for
       select tn,f,apod,pod from
       (
         select a.tabno tn ,a.fio f ,a.shifr_pod apod,
                coalesce((
            select first 1 coalesce(b.w_place,0) from person b
                   where b.tabno=a.tabno and
                   b.yearvy=2013 and
                   b.monthvy=9 and
                   b.main<>0   and
                   b.w_r=1
                        ),0) pod from kadry a
            where (a.shifr_pod not in (81,105,121,161,168,179))
       )
       where not ((apod=0) and (pod=0))
             and apod<>pod
       into :tabno,:f,:shifrpod_old,:shifrpod_new
     do
       begin
            retval=retval+1;
            update kadry
               set shifr_pod=:shifrpod_new
               where tabno=:tabno;
       end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PR_SETDOTPMOV (
    SHIFRIDOTP INTEGER,
    GRUPPA INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable SHIFRID integer;
declare variable ISBUD integer;
declare variable ISVNE integer;
declare variable ISGN integer;
declare variable ISNIS integer;
begin
     for
        select a.shifrid from otp_res a
                            where a.shifridotp=:shifridotp
                            into :shifrid
     do
        begin
              select first 1 a.need_pere_bud,a.need_pere_vne,a.need_pere_gn,a.need_pere_nis  from otp_res a
                     where a.shifrid=:shifrid
                     into :isbud,:isvne,:isgn,:isnis;
              isbud=coalesce(isbud,0);
              isvne=coalesce(isvne,0);
              isgn =coalesce(isgn,0);
              isnis=coalesce(isnis,0);
              if ((isbud=1) and (Gruppa=1))  then
                 update otp_res a
                  set a.data_pere_bud=current_timestamp
                  where a.shifrid=:shifrid;
              if ((isvne=1) and (Gruppa=2)) then
                 update otp_res a
                  set a.data_pere_vne=current_timestamp
                  where a.shifrid=:shifrid;
              if ((isgn=1) and (Gruppa=3))  then
                 update otp_res a
                  set a.data_pere_gn=current_timestamp
                  where a.shifrid=:shifrid;
              if ((isnis=1) and (Gruppa=4)) then
                 update otp_res a
                  set a.data_pere_nis=current_timestamp
                  where a.shifrid=:shifrid;
        end
  /* Procedure Text */
  retval=1;
  suspend;
end^


ALTER PROCEDURE PR_SETPICK (
    SHIFRWRK INTEGER,
    SHIFRPOD INTEGER,
    TABNO INTEGER,
    W_R INTEGER)
AS
begin
  /* Procedure Text */
     update tb_pick
       set tb_pick.shifrpod = :shifrpod,
           tb_pick.tabno    = :tabno,
           tb_pick.w_r      = :w_r
       where tb_pick.shifrwrk = :shifrwrk;
     if ((ROW_COUNT=0) AND (ShifrWrk is not null)) then
        insert into tb_pick (ShifrWrk,ShifrPod,W_R,tabno)
               values (:ShifrWrk, :ShifrPod, :W_R,:Tabno);
end^


ALTER PROCEDURE PR_SWOD_LI (
    Y INTEGER,
    M INTEGER)
RETURNS (
    SUMMAST DECIMAL(15,2),
    SUMMATOT DECIMAL(15,2),
    K DECIMAL(15,2))
AS
declare variable koef decimal(15,2);
declare variable summa decimal(15,2);
declare variable shifrid integer;
begin
  summast=0;
  summatot=0;
  for
     select  person.shifrid from person
             where person.monthvy=:m and person.yearvy=:y and
                   person.w_place in (select tmp_podr.shifrpod from tmp_podr) and
                   person.shifrkat=1 and
                   PERSON.shifrgru<>1 AND
                   upper(ltrim(rtrim(person.dolg))) not containing 'ПОВ' and
                   upper(ltrim(rtrim(person.dolg))) not containing 'НАД' and
                   upper(ltrim(rtrim(person.dolg))) not containing 'НАБД' and
                   ((person.w_r=2) and (NOT exists( select * from fcn where fcn.shifridperson=person.shifrid and fcn.shifrsta=82+500)))
             into :shifrid
  do
    begin
         select first 1 fcn.summa from fcn
                where fcn.shifridperson=:shifrid and
                      fcn.shifrsta=99+500 into :koef;
         if (koef is null or (koef<0.005) ) then koef=1;
         k=koef;
         suspend;
--         if (koef<1) then
--             koef=koef;
         select sum(fadd.summa) from fadd
                where fadd.shifridperson=:shifrid and
                      fadd.shifrsta in (1,8,18,22) into :summa;
         if (summa is null) then summa=0;
--         if (summa>0.01) then
            begin
                 summast=summast+koef;
                 summatot=summatot+summa;
            end
    end
   suspend;
end^


ALTER PROCEDURE PR_SWODY_CMP (
    SHIFRIDFR INTEGER,
    SHIFRIDTO INTEGER)
RETURNS (
    SHIFRSTAFR INTEGER,
    SHIFRPODFR INTEGER,
    PERIODFR INTEGER,
    SUMMAFR DECIMAL(10,2),
    NMBOFRECFR INTEGER,
    SHIFRSTATO INTEGER,
    SHIFRPODTO INTEGER,
    PERIODTO INTEGER,
    SUMMATO DECIMAL(10,2),
    NMBOFRECTO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(50),
    PERIOD INTEGER,
    SHIFRPOD INTEGER)
AS
declare variable SHIFRIDDETFR integer;
declare variable SHIFRIDDETTO integer;
begin
     for
        select fr.shifrid , fr.shifrsta , fr.shifrpod,
               fr.period  , fr.nmbofrec , fr.summa
                          from tb_swody_det fr
                          where fr.shifridswod=:shifridfr
                          into :shifriddetfr,:shifrstafr,:shifrpodfr,
                               :periodfr,:nmbofrecfr,:summafr

     do
       begin
            shifriddetfr = coalesce(shifriddetfr, 0);
            shifrstafr   = coalesce(shifrstafr  , 0);
            shifrpodfr   = coalesce(shifrpodfr  , 0);
            periodfr     = coalesce(periodfr    , 0);
            summafr      = coalesce(summafr     , 0);
            nmbofrecfr   = coalesce(nmbofrecfr  , 0);
            select  t.shifrid , t.shifrsta , t.shifrpod,
                    t.period  , t.nmbofrec , t.summa
                          from tb_swody_det t
                          where t.shifridswod = :shifridto
                            and t.shifrsta    = :shifrstafr
                            and t.shifrpod    = :shifrpodfr
                            and t.period      = :periodfr
        --                    and to.summa       = :summafr
                          into :shifriddetto,:shifrstato,:shifrpodto,
                               :periodto,:nmbofrecto,:summato;

            if ((nmbofrecfr<>coalesce(nmbofrecto,0)) or (summafr<>coalesce(summato,0.00)))  then
               begin
                    namesta=null;
                    shifrsta  = coalesce(shifrstafr , coalesce(shifrstato, 0));
                    select first 1 a.name from shifr a where a.shifr=:shifrsta
                                          into :namesta;
                    namesta   = coalesce(namesta,'');
                    period    = coalesce(periodfr   , coalesce(periodto, 0));
                    shifrpod  = coalesce(shifrpodfr , coalesce(shifrpodto, 0));
                    suspend;
               end
       end

  -- Second Step


     for
        select tt.shifrid , tt.shifrsta , tt.shifrpod,
               tt.period  , tt.nmbofrec , tt.summa
                          from tb_swody_det tt
                          where tt.shifridswod=:shifridto
                            and not exists (
                                select * from tb_swody_det ft
                                         where ft.shifridswod = :shifridfr
                                           and ft.shifrsta    = tt.shifrsta
                                           and ft.shifrpod    = tt.shifrpod
                                           and ft.period      = tt.period
                                )
                          into :shifriddetto,:shifrstato,:shifrpodto,
                               :periodto,:nmbofrecto,:summato

     do
       begin
            shifriddetto = coalesce(shifriddetfr, 0);
            shifrstato   = coalesce(shifrstato  , 0);
            shifrpodto   = coalesce(shifrpodto  , 0);
            periodto     = coalesce(periodto    , 0);
            summato      = coalesce(summato     , 0);
            nmbofrecto   = coalesce(nmbofrecto  , 0);
            shifriddetfr = null ;
            shifrstafr   = coalesce(shifrstato  , 0);
            shifrpodfr   = null ;
            periodfr     = null ;
            summafr      = null ;
            nmbofrecfr   = null ;
            namesta      = null;
            shifrsta  = coalesce(shifrstafr , coalesce(shifrstato, 0));
            select first 1 a.name from shifr a where a.shifr=:shifrsta
                             into :namesta;
            namesta   = coalesce(namesta,'');
            period    = coalesce(periodfr   , coalesce(periodto, 0));
            shifrpod  = coalesce(shifrpodfr , coalesce(shifrpodto, 0));
            suspend;
       end

  /* Procedure Text */
end^


ALTER PROCEDURE PR_T6CMPSWODPERSON (
    Y INTEGER,
    M INTEGER)
RETURNS (
    TABNO INTEGER,
    SUMMAADDSWOD DECIMAL(15,2),
    SUMMAADDT6 DECIMAL(15,2))
AS
declare variable SHIFRIDSWOD integer;
begin
     shifridswod=null;
     select first 1 sh.shifrid from tb_swody_hat sh
            where sh.yearvy=:y
              and sh.monthvy=:m
            order by sh.shifrid desc
            into :shifridswod;
     if (shifridswod is not null) then
     for
         select distinct tabno from tb_e04t06c a0
                where a0.yearvy=:y
                  and a0.monthvy=:m
         union
         select distinct a1.tabno from tb_swody_det_person_add a1
                where a1.shifridswod=:shifridswod
                  and a1.tabno not in (
                      select distinct tabno from tb_e04t06c a0
                         where a0.yearvy=:y
                           and a0.monthvy=:m
                      )
         into :tabno
     do
       begin
         summaaddswod=0;
         select a.summa from tb_swody_det_person_add a
             where a.tabno=:tabno
             into :summaaddswod;
         summaaddswod=coalesce(summaaddswod,0);
         summaaddt6=0;
         select sum(b.sum_total) from tb_e04t06c b
                where b.tabno=:tabno
                  and b.yearvy=:y
                  and b.monthvy=:m
                into :summaaddT6;
         summaaddt6=coalesce(summaaddt6,0);
         if (abs(summaaddswod-summaaddt6)>=0.01) then
            suspend;
       end

  /* Procedure Text */

end^


ALTER PROCEDURE PR_TEST_CHG_DOL
RETURNS (
    FIO VARCHAR(50),
    NSRV INTEGER,
    DOLG VARCHAR(40),
    DOLG1 VARCHAR(40),
    OKLAD DECIMAL(15,2),
    OKLAD1 INTEGER)
AS
declare variable SHIFRID integer;
declare variable SHIFRDOL integer;
declare variable SHIFRID1 integer;
declare variable SHIFRDOL1 integer;
declare variable TABNO integer;
begin
     for
        select a.shifrid,a.fio, a.w_place,a.tabno,a.oklad from person a
               where a.yearvy=2013 and a.monthvy=9
               into :shifrid,:fio,:nsrv,:tabno,:oklad
     do
       begin
            select b.shifriddolg from pr_get_dolg_person_by_id(:shifrid) b
                                into :shifrdol;
            shifrid1=null;
            oklad1=null;
            select first 1 c.shifrid,c.oklad from person c
               where c.tabno=:tabno and c.w_place=:nsrv and
                     c.yearvy=2013 and c.monthvy=8
                    and
                    (
                       coalesce((select first 1 guid from pr_getguid(:shifrid,0)),0)=
                       coalesce((select first 1 guid from pr_getguid(c.shifrid,0)),1)
                     )

               into :shifrid1,:oklad1;
            if (shifrid1 is not null) then
               begin
                    select d.shifriddolg from pr_get_dolg_person_by_id(:shifrid1) d
                                into :shifrdol1;
                    if (shifrdol<>shifrdol1) then
                       begin
                             select first 1 e.name from tb_dolg e where e.shifrdol=:shifrdol into :dolg;
                             select first 1 f.name from tb_dolg f where f.shifrdol=:shifrdol1 into :dolg1;
                             suspend;
                       end
               end
       end
  /* Procedure Text */
end^


ALTER PROCEDURE PR_TEST_MEM_LERA (
    Y INTEGER,
    M INTEGER,
    SHIFRGRU INTEGER)
RETURNS (
    NSRV INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMAT DECIMAL(15,2))
AS
declare variable summatot decimal(15,2);
declare variable summattot decimal(15,2);
begin
     summatot=0;
     summattot=0;
     for
         select w_place,sum(summa) from fadd where shifrgru=:shifrgru
                and month_vy=:m and year_vy=:y
                group by 1
                into :nsrv,:summa
     do
       begin
            summatot=summatot+summa;
            summat=0;
            select sum(summa) from test_add where shifrgru=:shifrgru  and nsrv=:nsrv
                   into :summat;
            suspend;
            if (summat is not null) then
               summattot=summattot+summat;
       end
    nsrv=0;
    summa=summatot;
    summat=summattot;
  /* Procedure Text */
end^


ALTER PROCEDURE PR_TESTSECRETWORKER (
    TABNO INTEGER)
RETURNS (
    RETVAL SMALLINT)
AS
declare variable shifrsp integer;
declare variable shifrwrk integer;
BEGIN
     if (Exists (select tabno from tb_secret_tabno where tabno=:tabno)) then
        begin
             select shifrwrk from currshifrwrk into :shifrwrk;
--             SELECT operatory.secretright FROM Operatory WHERE Login=CURRENT_USER INTO :ShifrSP;
             SELECT operatory.secretright FROM Operatory WHERE Operatory.shifrwrk=:shifrwrk INTO :ShifrSP;
             if (ShifrSp=1) then RetVal=1;
             else retval=0;
        end
     else
         RetVal=1;

     SUSPEND;
END^


ALTER PROCEDURE PR_TOR_PREM_ADD (
    Y INTEGER)
AS
declare variable tabno integer;
declare variable i integer;
declare variable shifrdol integer;
declare variable summapr decimal(15,2);
declare variable summanadb decimal(15,2);
declare variable namedol varchar(100);
declare variable shifridadd integer;
declare variable shifridperson integer;
declare variable shifrsta integer;
declare variable shifrgru integer;
begin
      delete from tb_torop_pr;
      for
          select a.shifrid,a.summa,a.month_vy,a.shifridperson,a.tabno,a.shifrsta,a.shifrgru from fadd a
                 where a.year_vy=:y
                 and a.shifrsta in (2,3,30)
                 and a.summa is not null
                 and abs(a.summa)>0.01
                 into :shifridadd,:summapr,:i,:shifridperson,:tabno,:shifrsta,:shifrgru
      do
        begin
             if (shifrsta=30) then
                begin
                     summanadb=summapr;
                     summapr=0;
                end
             else
                summanadb=0;
             shifrdol=null;
             select first 1 c.prim from fcn c
                    where c.shifridperson=:shifridperson
                           and c.shifrsta in (100,100+500)
                           and c.prim in (10,20,30,40,
                                          47,70,50,60,80,90,
                                          100,110,120,13,140,150,160,170,
                                          190,200,210,220,230,240
                                          )
                           into :shifrdol;
             if (shifrdol is null) then
                 select first 1 c.prim from fcn c
                        where c.tabno=:tabno
                        and c.year_vy=:y
                        and c.month_vy=:i
                        and c.w_r=1
                        and c.w_place<>82
                        and c.shifrsta in (100,100+500)
                        and c.prim in (10,20,30,40,
                                       47,70,50,60,80,90,
                                       100,110,120,13,140,150,160,170,
                                       190,200,210,220,230,240
                                          )
                           into :shifrdol;
             shifrdol=coalesce(shifrdol,0);
             if (shifrdol>0) then
                begin
                     if ((abs(summanadb)>0.01) or (abs(summapr)>0.01))  then
                         begin
                              if  (not exists (select * from tb_torop_pr where shifrdol=:shifrdol)) then
                                   begin
                                        select first 1 d.name from tb_dolg d where d.shifrdol=:shifrdol into :namedol;
                                        insert into tb_torop_pr values(:shifrdol,:namedol,0,0,0,0);
                                   end
                              if (Shifrgru=1) then
                                  update tb_torop_pr
                                         set summapre=summapre+:summapr,
                                             summanadb=summanadb+:summanadb
                                         where shifrdol=:shifrdol;
                              else
                                  update tb_torop_pr
                                         set summaprevne=summaprevne+:summapr,
                                             summanadbvne=summanadbvne+:summanadb
                                         where shifrdol=:shifrdol;
                          end
                  end
        end
   --

  /* Procedurue Text */
  --suspend;
end^


ALTER PROCEDURE PR_TOR_PREM_KWA (
    Y INTEGER,
    KW INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    SHIFRROW INTEGER,
    NMBOFWORKER INTEGER,
    SUMMANADBBUD DECIMAL(15,2),
    SUMMAPREMBUD DECIMAL(15,2),
    SUMMANADBVNE DECIMAL(15,2),
    SUMMAPREMVNE DECIMAL(15,2))
AS
declare variable m1 integer;
declare variable m2 integer;
declare variable m3 integer;
declare variable c1 integer;
declare variable c2 integer;
declare variable c3 integer;
begin
   m1=(kw-1)*3+1;
   m2=(kw-1)*3+2;
   m3=(kw-1)*3+3;
   delete from tb_plan_prem_person;
--   delete from tb_plan_prem_person where y=:y and m=:m2;
--   delete from tb_plan_prem_person where y=:y and m=:m3;
   execute procedure pr_tor_prem_swod(:y,:m1, :iskoledg);
   execute procedure pr_tor_prem_swod(:y,:m2, :iskoledg);
   execute procedure pr_tor_prem_swod(:y,:m3, :iskoledg);
   nmbofworker=1;
   for
      select shifrrow,sum(summanadbbud),sum(summaprembud),sum(summanadbvne),sum(summapremvne) from tb_plan_prem_person
             where y=:y and m in (:m1, :m2,:m3)
             group by 1
             into :shifrrow, :summanadbbud, :summaprembud, :summanadbvne,:summapremvne
   do
     begin
           select count(*) from tb_plan_prem_person where
                  y=:y and m=:m1 and shifrrow=:shifrrow
                  and iskoledg=:iskoledg
                  into c1;
           select count(*) from tb_plan_prem_person where
                  y=:y and m=:m2 and shifrrow=:shifrrow
                  and iskoledg=:iskoledg
                  into c2;
           select count(*) from tb_plan_prem_person where
                  y=:y and m=:m3 and shifrrow=:shifrrow
                  and iskoledg=:iskoledg
                  into c3;
           nmbofworker=(c1+c2+c3)/3;
           suspend;
     end
   select sum(summa) from fadd
          where shifrgru=1
          and year_vy=:y
          and month_vy in (:m1,:m2,:m3)
          and shifrsta not in (14,15)
          and (((:iskoledg=1) and (w_place between 151 and 168)) or
               ((:iskoledg=0) and (w_place not between 151 and 168))
              )

          into summanadbbud;
   select sum(summa) from fadd
          where shifrgru<>1
          and year_vy=:y
          and month_vy in (:m1,:m2,:m3)
          and shifrsta not in (14,15)
          and (((:iskoledg=1) and (w_place between 151 and 168)) or
               ((:iskoledg=0) and (w_place not between 151 and 168))
              )
          into summaprembud;
   summapremvne = 0;
   summanadbvne = 0;
   nmbofworker  = 0;
   shifrrow=999;
   suspend;

end^


ALTER PROCEDURE PR_TOR_PREM_MON (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
RETURNS (
    SHIFRROW INTEGER,
    NMBOFWORKER INTEGER,
    SUMMANADBBUD DECIMAL(15,2),
    SUMMAPREMBUD DECIMAL(15,2),
    SUMMANADBVNE DECIMAL(15,2),
    SUMMAPREMVNE DECIMAL(15,2))
AS
declare variable c integer;
begin
   delete from tb_plan_prem_person;
   execute procedure pr_tor_prem_swod(:y,:m, :iskoledg);
   nmbofworker=1;
   for
      select shifrrow,sum(summanadbbud),sum(summaprembud),sum(summanadbvne),sum(summapremvne) from tb_plan_prem_person
             where y=:y and m in (m)
             group by 1
             into :shifrrow, :summanadbbud, :summaprembud, :summanadbvne,:summapremvne
   do
     begin
           select count(*) from tb_plan_prem_person where
                  y=:y and m=:m and shifrrow=:shifrrow
                  and iskoledg=:iskoledg
                  into c;
           nmbofworker=c;
           suspend;
     end

   select sum(summa) from fadd
          where shifrgru=1
          and year_vy=:y
          and month_vy in (:m)
          and shifrsta not in (14,15)
          and (((:iskoledg=1) and (w_place between 151 and 168)) or
               ((:iskoledg=0) and (w_place not between 151 and 168))
              )

          into summanadbbud;
   select sum(summa) from fadd
          where shifrgru<>1
          and year_vy=:y
          and month_vy in (:m)
          and shifrsta not in (14,15)
          and (((:iskoledg=1) and (w_place between 151 and 168)) or
               ((:iskoledg=0) and (w_place not between 151 and 168))
              )
          into summaprembud;
   summapremvne = 0;
   summanadbvne = 0;
   nmbofworker  = 0;
   shifrrow=999;
   suspend;

end^


ALTER PROCEDURE PR_TOR_PREM_SWOD (
    Y INTEGER,
    M INTEGER,
    ISKOLEDG INTEGER)
AS
declare variable tabno integer;
declare variable i integer;
declare variable summaprbud decimal(15,2);
declare variable summanadbbud decimal(15,2);
declare variable shifridadd integer;
declare variable shifridperson integer;
declare variable shifrsta integer;
declare variable shifrgru integer;
declare variable summaprvne decimal(15,2);
declare variable summanadbvne decimal(15,2);
declare variable summapr decimal(15,2);
declare variable summanadb decimal(15,2);
declare variable shifrkat integer;
declare variable shifrrow integer;
declare variable fio varchar(100);
declare variable cnt integer;
begin
      delete from tb_plan_prem_person where y=:y and m=:m;
      for
          select a.shifrid,a.summa,a.month_vy,a.shifridperson,a.tabno,a.shifrsta,a.shifrgru,shifrkat from fadd a
                 where a.year_vy=:y
                 and a.month_vy=:m
                 and a.shifrsta in (2,3,30)
                 and a.summa is not null
                 and abs(a.summa)>0.01
                 and (((:iskoledg=1) and (a.w_place between 151 and 168)) or
                      ((:iskoledg=0) and (a.w_place not between 151 and 168))
                 )
                 into :shifridadd,:summapr,:i,:shifridperson,:tabno,:shifrsta,:shifrgru,:shifrkat
      do
        begin
             summanadbbud = 0;
             summanadbvne = 0;
             summaprbud   = 0;
             summaprvne   = 0;
             if (shifrsta=30) then
                begin
                     summanadb=summapr;
                     summapr=0;
                end
             else
                summanadb=0;
             if (shifrgru in (1)) then
                begin
                      if (abs(summanadb)>0.005) then
                         summanadbbud=summanadb;
                      else if (abs(summapr)>0.005) then
                         summaprbud=summapr;
                end
             else
                begin
                      if (abs(summanadb)>0.005) then
                         summanadbvne=summanadb;
                      else if (abs(summapr)>0.005) then
                         summaprvne=summapr;
                end

             shifrrow=null;
             select shifrrow,fio from tb_ruk_for_swod_prem where tabno=:tabno
                    into :shifrrow,:fio;
             shifrrow=coalesce(shifrrow,0);
             if (shifrrow=0) then
                begin
                     select first 1 person.shifrkat,person.fio from person
                                    where person.tabno=:tabno 
                                    and person.yearvy=:y
                                    and person.monthvy=:m
                                    and person.w_place <> 82
                                    order by person.w_r desc 
                                    into :shifrkat, :fio;
                     shifrkat=coalesce(shifrkat, 0);
                     shifrrow=case
                                  when shifrkat in (1,3) then 5
                                  when shifrkat in (2,4,6) then 6
                                  when shifrkat in (5,7) then 4
                                  else 6
                              end;
                end
             select count(*) from tb_plan_prem_person
                             where tabno=:tabno and y=:y and m=:m
                             into :cnt;
             if (cnt=0) then
                insert into tb_plan_prem_person (TABNO,FIO,SHIFRROW,SHIFRKAT,Y,M,
                                                 SUMMAPREMBUD,SUMMANADBBUD,
                                                 SUMMAPREMVNE,SUMMANADBVNE,ISKOLEDG)
                       values(:Tabno,:fio,:shifrrow,:shifrkat,:y,:m,0,0,0,0,:iskoledg);
             update tb_plan_prem_person
               set shifrrow=:shifrrow,
                   shifrkat=:shifrkat,
                   summaprembud=summaprembud+:summaprbud,
                   summapremvne=summapremvne+:summaprvne,
                   summanadbbud=summanadbbud+:summanadbbud,
                   summanadbvne=summanadbvne+:summanadbvne
               where tabno=:tabno and y=:y and m=:m;
        end

   --

  /* Procedurue Text */
  --suspend;
end^


ALTER PROCEDURE PR_UD_FOR_SWOD (
    DATEFR DATE,
    DATETO DATE,
    SHIFRGRU INTEGER,
    NEEDPERIOD INTEGER)
RETURNS (
    LINENO INTEGER,
    SHIFRSTA INTEGER,
    NAMESTA VARCHAR(52),
    SUMMA DECIMAL(15,2),
    PERIOD INTEGER)
AS
begin
  /* Procedure Text */
     lineno=0;
     for
        select a.shifrsta,trim(b.name)
              , case
                 when :needperiod=1 then a.month_za
                                    else 0
                end period
             ,sum(a.summa) from fud a
               join shifr b on a.shifrsta=b.shifr
               where cast((a.year_vy||'-'||a.month_vy||'-01')    as date) between :datefr and :dateto
                 and ((:shifrgru=0) or (:shifrgru=a.shifrgru))
               group by 1,2,3
               into :shifrsta,:namesta,:period,:summa
     do
     begin
          lineno=lineno+1;
          suspend;
     end
end^


ALTER PROCEDURE PR_WORK_CLOCK_LERA (
    SHIFRIDPERSON INTEGER)
RETURNS (
    RETVAL DECIMAL(15,2))
AS
declare variable DAYNO integer;
declare variable CODE integer;
declare variable SHIFRKAT integer;
declare variable WD timestamp;
declare variable Y integer;
declare variable M integer;
declare variable TABNO integer;
begin
  retval=0;
  select first 1 a.shifrkat,a.yearvy,a.monthvy,a.tabno from person a where shifrid=:shifridperson
         into :shifrkat,:y,:m,:tabno;
  shifrkat=coalesce(shifrkat,1);
  for
    select b.dayno,b.code from tabel b
     where b.shifrid=:shifridperson
       and b.dayno<=31
       order by b.dayno
        into :dayno,:code
  do
    begin
         if (:Code in (1,3)) then
            begin
                 wd=y||'-'||m||'-'||dayno;
                 if (not exists (select c.shifrid from boln c
                         where :wd between c.f_data and c.l_data and
                         c.mode_ill<>10 and   -- отпуска исключить
                         c.tabno=:tabno))  then
                 if (not exists (select d.shifrid from otpuska d
                    where :wd between d.f_data and d.l_data and
                     d.mode=0 and
                    d.tabno=:tabno))  then
                 RetVal=RetVal+1;
            end
      end
  if (shifrkat=1) then
      retval=retval*7.2;
  else
      retval=retval*8;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE PUTBOLN (
    SHIFRID INTEGER,
    TABNO INTEGER,
    NOMER_B CHAR(10),
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    PROCENT DECIMAL(15,2),
    SHIFRSTA INTEGER,
    B_DAY INTEGER,
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    MODE_V_Z INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    SWIDSS VARCHAR(15),
    CODEILL INTEGER,
    SHIFRBUH INTEGER)
AS
declare variable NAL_CODE char(10);
declare variable FIO char(51);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable OKLAD decimal(15,2);
declare variable SUMMA_BOL decimal(15,2);
declare variable SUMMA_BOL_B decimal(15,2);
declare variable SUMMA_BOL_V decimal(15,2);
declare variable SUMMA_BOL_G decimal(15,2);
declare variable SUMMA_BOL_N decimal(15,2);
declare variable MUSOR decimal(15,2);
declare variable DATA_P_BUD date;
declare variable DATA_P_VNE date;
declare variable DATA_P_GN date;
declare variable DATA_P_NIS date;
declare variable ID_CLAR integer;
begin
     DATA_P_BUD  = '1990-01-01';
     DATA_P_VNE  = '1990-01-01';
     DATA_P_GN   = '1990-01-01';
     DATA_P_NIS  = '1990-01-01';
--     MODE_V_Z    = 0;
--     MODE_ILL    = 0;
     ID_CLAR     = 0;
     if (ShifrId>0) then
        begin
             if (exists (select first 1 ShifrId from boln where ShifrId=:ShifrId)) then
             select DATA_P_BUD,DATA_P_VNE,DATA_P_GN,DATA_P_NIS,MODE_V_Z,ID_CLAR from boln
                    where ShifrId=:ShifrId
                    into :DATA_P_BUD,:DATA_P_VNE,:DATA_P_GN,:DATA_P_NIS,:MODE_V_Z,:ID_CLAR;
             Delete From Boln       where ShifrId=:ShifrId;
             delete from boln_res   where boln_res.shifridboln=:shifrid;
             delete from boln_summy where boln_summy.shifridboln=:shifrid;
             delete from bolna      where bolna.shifridboln=:shifrid;
        end
     else
        select First 1 ShifrId from GetNewIdBoln into :ShifrId;
     select first 1 kadry.nal_code,Kadry.fio,Kadry.shifr_pod from kadry where tabno=:Tabno into :Nal_Code,:Fio,:W_PLace;
     W_R=1;
     if (W_Place=0) then w_r=2;
     select first 1 person.w_place,Oklad from person
            where tabno=:Tabno and w_r=1
            order by person.yearvy desc, person.monthvy desc
            into :W_PLace,:Oklad;
     select first 1 shifrkat,shifrgru from getkatgru(:Tabno) into :ShifrKat,ShifrGru;
     select sum(tmp_boln_res.summa_b_bud),
            sum(tmp_boln_res.summa_b_vne),
            sum(tmp_boln_res.summa_b_gn),
            sum(tmp_boln_res.summa_b_nis) from tmp_boln_res
            where connid=CURRENT_CONNECTION
            into :SUMMA_BOL_B,:SUMMA_BOL_V,:SUMMA_BOL_G,:SUMMA_BOL_N;
     if (Summa_bol_b is null) then Summa_Bol_b=0;
     if (Summa_bol_n is null) then Summa_Bol_n=0;
     if (Summa_bol_v is null) then Summa_Bol_v=0;
     if (Summa_bol_g is null) then Summa_Bol_g=0;
     summa_bol=Summa_bol_b+Summa_bol_v+Summa_bol_g+Summa_bol_n;
  --   exception TESTPUTBOLN 'MEANDAY_VNE=' || :meanday_vne;
     insert into boln (SHIFRID,Tabno,Nal_Code,Nomer_B,Fio,W_Place,ShifrKat,ShifrGru,
                       F_Data,F_Month,F_Year,L_Data,L_Month,L_Year,WID_RAB,Data_Vy,Month_Vy,Year_Vy,
                       Oklad,Procent,Shifr_Sta,K_WO_DAY,
                       MEAN_DAY,MEAN_DAY_BUD,MEAN_DAY_VNE,MEAN_DAY_GN,MEAN_DAY_NIS,
                       SUMMA_BOL,SUMMA_BOL_B,SUMMA_BOL_V,SUMMA_BOL_G,SUMMA_BOL_N,
                       DATA_P_BUD,DATA_P_VNE,DATA_P_GN,DATA_P_NIS,MODE_V_Z,MODE_ILL,ID_CLAR,
                       ID_OWNER,MODE_DAY_CLOCK,SWIDSS,CODE_REASON_ILL,SHIFRBUH)
            values (:shifrid,:Tabno,:nal_code,:Nomer_B,:Fio,:W_Place,:ShifrKat,:ShifrGru,
                        :F_data, extract(Month from :F_Data), extract(Year from :F_Data),
                         :L_data, extract(Month from :L_Data), extract(Year from :L_Data),
                         :W_R,:DataVy,extract(Month from :DataVy), extract(Year from :DataVy),
                         :Oklad,:procent,:shifrsta,:B_DAY,
                         :MeanDAY,:meanday_bud, :meanday_vne, :meanday_gn, :meanday_nis,
                         :SUMMA_BOL,:SUMMA_BOL_B,:SUMMA_BOL_V,:SUMMA_BOL_G,:SUMMA_BOL_N,
                         :DATA_P_BUD,:DATA_P_VNE,:DATA_P_GN,:DATA_P_NIS,:MODE_V_Z,:MODE_ILL,:ID_CLAR,
                         0,:ModeDC,:SWIDSS,:CODEILL,:SHIFRBUH);

    DELETE FROM boln_res   WHERE shifridboln=:ShifrId;
    DELETE FROM boln_summy WHERE shifridboln=:ShifrId;
    DELETE FROM bolna      WHERE shifridboln=:ShifrId;

    INSERT INTO boln_res (SHIFRIDBOLN,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                          SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS)
           SELECT :ShifrId,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                   SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS
                   FROM TMP_BOLN_RES where connid=CURRENT_CONNECTION;

    INSERT INTO boln_summy (SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC)
            SELECT :SHIFRID,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC
                                 FROM TMP_BOLN_SUMMY where connid=CURRENT_CONNECTION;

    INSERT INTO bolna (SHIFRIDBOLN,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
            SELECT :SHIFRID,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR
                                 FROM TMP_BOLNA where connid=CURRENT_CONNECTION;
--                                 FROM BOLNA where SHIFRIDBOLN=:SHIFRID;
    -- if (ROW_COUNT=0) then
       -- exception TESTPUTBOLN 'Wrong inserting ID=' || :SHIFRID;

    update bolna a
       set SHIFRIDBOLNSUMMY=(select first 1 shifrid
                                    from boln_summy b
                                    where b.month_za=a.month_za and
                                          b.year_za=a.year_za   and
                                          b.ShifrIdBoln=:ShifrId)
       where ShifrIdBoln=:ShifrId;


    DELETE FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION;
    SELECT COUNT(*) FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
/*    exception testputboln; */

  /* Procedure Text */

end^


ALTER PROCEDURE PUTBOLN_10_05_2018 (
    SHIFRID INTEGER,
    TABNO INTEGER,
    NOMER_B CHAR(10),
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    PROCENT DECIMAL(15,2),
    SHIFRSTA INTEGER,
    B_DAY INTEGER,
    MEANDAY DECIMAL(15,3),
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    MODE_V_Z INTEGER,
    MODE_ILL INTEGER,
    MODEDC INTEGER,
    SWIDSS VARCHAR(15),
    CODEILL INTEGER,
    SHIFRBUH INTEGER,
    MODEWR INTEGER)
AS
declare variable NAL_CODE char(10);
declare variable FIO char(51);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_PLACE integer;
declare variable W_R integer;
declare variable OKLAD decimal(15,2);
declare variable SUMMA_BOL decimal(15,2);
declare variable SUMMA_BOL_B decimal(15,2);
declare variable SUMMA_BOL_V decimal(15,2);
declare variable SUMMA_BOL_G decimal(15,2);
declare variable SUMMA_BOL_N decimal(15,2);
declare variable MUSOR decimal(15,2);
declare variable DATA_P_BUD date;
declare variable DATA_P_VNE date;
declare variable DATA_P_GN date;
declare variable DATA_P_NIS date;
declare variable ID_CLAR integer;
begin
     DATA_P_BUD  = '1990-01-01';
     DATA_P_VNE  = '1990-01-01';
     DATA_P_GN   = '1990-01-01';
     DATA_P_NIS  = '1990-01-01';
--     MODE_V_Z    = 0;
--     MODE_ILL    = 0;
     ID_CLAR     = 0;
     if (ShifrId>0) then
        begin
             if (exists (select first 1 ShifrId from boln where ShifrId=:ShifrId)) then
             select DATA_P_BUD,DATA_P_VNE,DATA_P_GN,DATA_P_NIS,MODE_V_Z,ID_CLAR from boln
                    where ShifrId=:ShifrId
                    into :DATA_P_BUD,:DATA_P_VNE,:DATA_P_GN,:DATA_P_NIS,:MODE_V_Z,:ID_CLAR;
             Delete From Boln       where ShifrId=:ShifrId;
             delete from boln_res   where boln_res.shifridboln=:shifrid;
             delete from boln_summy where boln_summy.shifridboln=:shifrid;
             delete from bolna      where bolna.shifridboln=:shifrid;
        end
     else
        select First 1 ShifrId from GetNewIdBoln into :ShifrId;
     select first 1 kadry.nal_code,Kadry.fio,Kadry.shifr_pod from kadry where tabno=:Tabno into :Nal_Code,:Fio,:W_PLace;
     W_R=1;
     if (W_Place=0) then w_r=2;
     select first 1 person.w_place,Oklad from person
            where tabno=:Tabno and w_r=1
            order by person.yearvy desc, person.monthvy desc
            into :W_PLace,:Oklad;
     select first 1 shifrkat,shifrgru from getkatgru(:Tabno) into :ShifrKat,ShifrGru;
     select sum(tmp_boln_res.summa_b_bud),
            sum(tmp_boln_res.summa_b_vne),
            sum(tmp_boln_res.summa_b_gn),
            sum(tmp_boln_res.summa_b_nis) from tmp_boln_res
            where connid=CURRENT_CONNECTION
            into :SUMMA_BOL_B,:SUMMA_BOL_V,:SUMMA_BOL_G,:SUMMA_BOL_N;
     if (Summa_bol_b is null) then Summa_Bol_b=0;
     if (Summa_bol_n is null) then Summa_Bol_n=0;
     if (Summa_bol_v is null) then Summa_Bol_v=0;
     if (Summa_bol_g is null) then Summa_Bol_g=0;
     summa_bol=Summa_bol_b+Summa_bol_v+Summa_bol_g+Summa_bol_n;
  --   exception TESTPUTBOLN 'MEANDAY_VNE=' || :meanday_vne;
     insert into boln (SHIFRID,Tabno,Nal_Code,Nomer_B,Fio,W_Place,ShifrKat,ShifrGru,
                       F_Data,F_Month,F_Year,L_Data,L_Month,L_Year,WID_RAB,Data_Vy,Month_Vy,Year_Vy,
                       Oklad,Procent,Shifr_Sta,K_WO_DAY,
                       MEAN_DAY,MEAN_DAY_BUD,MEAN_DAY_VNE,MEAN_DAY_GN,MEAN_DAY_NIS,
                       SUMMA_BOL,SUMMA_BOL_B,SUMMA_BOL_V,SUMMA_BOL_G,SUMMA_BOL_N,
                       DATA_P_BUD,DATA_P_VNE,DATA_P_GN,DATA_P_NIS,MODE_V_Z,MODE_ILL,ID_CLAR,
                       ID_OWNER,MODE_DAY_CLOCK,SWIDSS,CODE_REASON_ILL,SHIFRBUH,MODEWR)
            values (:shifrid,:Tabno,:nal_code,:Nomer_B,:Fio,:W_Place,:ShifrKat,:ShifrGru,
                        :F_data, extract(Month from :F_Data), extract(Year from :F_Data),
                         :L_data, extract(Month from :L_Data), extract(Year from :L_Data),
                         :W_R,:DataVy,extract(Month from :DataVy), extract(Year from :DataVy),
                         :Oklad,:procent,:shifrsta,:B_DAY,
                         :MeanDAY,:meanday_bud, :meanday_vne, :meanday_gn, :meanday_nis,
                         :SUMMA_BOL,:SUMMA_BOL_B,:SUMMA_BOL_V,:SUMMA_BOL_G,:SUMMA_BOL_N,
                         :DATA_P_BUD,:DATA_P_VNE,:DATA_P_GN,:DATA_P_NIS,:MODE_V_Z,:MODE_ILL,:ID_CLAR,
                         0,:ModeDC,:SWIDSS,:CODEILL,:SHIFRBUH,:MODEWR);

    DELETE FROM boln_res   WHERE shifridboln=:ShifrId;
    DELETE FROM boln_summy WHERE shifridboln=:ShifrId;
    DELETE FROM bolna      WHERE shifridboln=:ShifrId;

    INSERT INTO boln_res (SHIFRIDBOLN,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                          SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS)
           SELECT :ShifrId,SHIFRSTA,B_DAY,MONTH_ZA,YEAR_ZA,
                   SUMMA_B_BUD,SUMMA_B_VNE,SUMMA_B_GN,SUMMA_B_NIS
                   FROM TMP_BOLN_RES where connid=CURRENT_CONNECTION;

    INSERT INTO boln_summy (SHIFRIDBOLN,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC)
            SELECT :SHIFRID,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAYS,GRAPHIC_DAY,KOEF,MANUAL_CALC
                                 FROM TMP_BOLN_SUMMY where connid=CURRENT_CONNECTION;

    INSERT INTO bolna (SHIFRIDBOLN,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR)
            SELECT :SHIFRID,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,MARKED,ID_CLAR
                                 FROM TMP_BOLNA where connid=CURRENT_CONNECTION;
--                                 FROM BOLNA where SHIFRIDBOLN=:SHIFRID;
    -- if (ROW_COUNT=0) then
       -- exception TESTPUTBOLN 'Wrong inserting ID=' || :SHIFRID;

    update bolna a
       set SHIFRIDBOLNSUMMY=(select first 1 shifrid
                                    from boln_summy b
                                    where b.month_za=a.month_za and
                                          b.year_za=a.year_za   and
                                          b.ShifrIdBoln=:ShifrId)
       where ShifrIdBoln=:ShifrId;


    DELETE FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION;
    SELECT COUNT(*) FROM tmp_boln_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_boln_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_bolna      WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
/*    exception testputboln; */

  /* Procedure Text */

end^


ALTER PROCEDURE PUTOTP (
    SHIFRID INTEGER,
    TABNO INTEGER,
    F_DATA DATE,
    L_DATA DATE,
    DATAVY DATE,
    SHIFRSTA INTEGER,
    O_DAY INTEGER,
    MEANDAY_BUD DECIMAL(15,3),
    MEANDAY_VNE DECIMAL(15,3),
    MEANDAY_GN DECIMAL(15,3),
    MEANDAY_NIS DECIMAL(15,3),
    RAZRIJAD INTEGER,
    MODE INTEGER,
    MODEDC INTEGER,
    KIND_OTP INTEGER,
    NOMER_PRI VARCHAR(10),
    DATA_PRI DATE,
    PERIOD_PRI VARCHAR(30),
    MODE_25_07_2016 INTEGER)
AS
declare variable FIO char(51);
declare variable SHIFRKAT integer;
declare variable SHIFRGRU integer;
declare variable W_PLACE integer;
declare variable OKLAD decimal(15,2);
declare variable SUMMA_OTP decimal(15,2);
declare variable SUMMA_OTP_B decimal(15,2);
declare variable SUMMA_OTP_V decimal(15,2);
declare variable SUMMA_OTP_G decimal(15,2);
declare variable SUMMA_OTP_N decimal(15,2);
declare variable MUSOR decimal(15,2);
declare variable DATA_PERE date;
declare variable ID_CLAR integer;
declare variable SUMMA_BUD decimal(15,2);
declare variable SUMMA_GN decimal(15,2);
declare variable SUMMA_NIS decimal(15,2);
declare variable SUMMA_VNE decimal(15,2);
declare variable ITOGO_DAY integer;
declare variable DOLG varchar(30);
declare variable SUMMA1 decimal(15,2);
declare variable SUMMA2 decimal(15,2);
declare variable DATA_PERE_BUD date;
declare variable DATA_PERE_VNE date;
declare variable DATA_PERE_GN date;
declare variable DATA_PERE_NIS date;
begin
     DATA_PERE      = '1990-01-01';
     DATA_PERE_BUD  = '1990-01-01';
     DATA_PERE_VNE  = '1990-01-01';
     DATA_PERE_GN   = '1990-01-01';
     DATA_PERE_NIS  = '1990-01-01';
     ID_CLAR     = 0;
     if (ShifrId>0) then
        begin
             if (exists (select first 1 ShifrId from otpuska where ShifrId=:ShifrId)) then
                select a.DATA_PERE,a.ID_CLAR,a.data_pere_bud,a.data_pere_vne,a.data_pere_gn,a.data_pere_nis from otpuska a
                       where ShifrId=:ShifrId
                       into :DATA_PERE,:ID_CLAR,:data_pere_bud,:data_pere_vne,:data_pere_gn,:data_pere_nis;
             Delete From otpuska   where otpuska.ShifrId      = :ShifrId;
             delete from otp_res   where otp_res.shifridotp   = :shifrid;
             delete from otp_summy where otp_summy.shifridotp = :shifrid;
             delete from otp_add   where otp_add.shifridotp   = :shifrid;
        end
     else
        select First 1 ShifrId from GetNewIdOtp into :ShifrId;
     DATA_PERE      = coalesce(data_pere    ,'1990-01-01');
     DATA_PERE_BUD  = coalesce(DATA_PERE_BUD,'1990-01-01');
     DATA_PERE_VNE  = coalesce(DATA_PERE_VNE,'1990-01-01');
     DATA_PERE_GN   = coalesce(DATA_PERE_GN ,'1990-01-01');
     DATA_PERE_NIS  = coalesce(DATA_PERE_NIS,'1990-01-01');
     kind_otp=coalesce(kind_otp,0);
     if (not exists (select * from tb_kindsotp where shifrkind=:kind_otp)) then
        kind_otp=0;


     select first 1 Kadry.fio,Kadry.shifr_pod from kadry where tabno=:Tabno into :Fio,:W_PLace;
     select first 1 person.w_place,Oklad from person
            where tabno=:Tabno and w_r=1
            order by person.yearvy desc, person.monthvy desc
            into :W_PLace,:Oklad;
     select first 1 shifrkat,shifrgru from getkatgru(:Tabno) into :ShifrKat,ShifrGru;
     select sum(tmp_otp_res.summa_o_bud),
            sum(tmp_otp_res.summa_o_vne),
            sum(tmp_otp_res.summa_o_gn),
            sum(tmp_otp_res.summa_o_nis) from tmp_otp_res
            where connid=CURRENT_CONNECTION
            into :Summa_Otp_B,:Summa_Otp_V,:Summa_Otp_G,:Summa_Otp_N;
     if (Summa_otp_b is null) then Summa_otp_b=0;
     if (Summa_otp_n is null) then Summa_otp_n=0;
     if (Summa_otp_v is null) then Summa_otp_v=0;
     if (Summa_otp_g is null) then Summa_otp_g=0;
     summa_otp=Summa_otp_b+Summa_otp_v+Summa_otp_g+Summa_otp_n;
     select sum(tmp_otp_summy.summa_bud),
            sum(tmp_otp_summy.summa_vne),
            sum(tmp_otp_summy.summa_gn),
            sum(tmp_otp_summy.summa_nis),
            sum(tmp_otp_summy.day_kalend) from tmp_otp_summy
            where connid=CURRENT_CONNECTION and tmp_otp_summy.sel>0
            into :Summa_Bud,:Summa_vne,:Summa_Gn,:Summa_vne,:itogo_day;
     if (Summa_bud is null)  then Summa_bud  = 0;
     if (Summa_nis is null)  then Summa_nis  = 0;
     if (Summa_vne is null)  then Summa_vne  = 0;
     if (Summa_gn is null)   then Summa_gn   = 0;
     if (itogo_day is null)  then Itogo_day  = 0;
     select first 1 person.dolg from person
            where person.tabno=:tabno and
                  person.monthvy = extract(month from :datavy) and
                  person.yearvy  = extract(year from :datavy)  and
                  person.w_r=1 into :dolg;
     if (dolg is null) then dolg='';
     insert into OTPUSKA (SHIFRID,Tabno,Fio,W_Place,ShifrKat,ShifrGru,
                       F_Data,F_Day,F_Month,F_Year,L_Data,L_Day,L_Month,L_Year,Data_Vy,Month_Vy,Year_Vy,
                       Oklad,ShifrSta,ITOGO_O_DAY,
                       MEAN_DAY_BUD,MEAN_DAY_VNE,MEAN_DAY_GN,MEAN_DAY_NIS,
                       ITOGO_O,ITOGO_O_BUD,ITOGO_O_VNE,ITOGO_O_GN,ITOGO_O_NIS,
                       DATA_PERE,ID_CLAR,RAZRIJAD,
                       itogo_bud,itogo_vne,itogo_gn,itogo_nis,
                       itogo,itogo_day,mark,dolg,mode,mode_day_clock,
                       data_pere_bud,data_pere_vne,data_pere_gn,data_pere_nis,kind_otp,
                       NOMER_PRI,DATA_PRI,PERIOD_PRI,mode_25_07_2016)
            values (:shifrid,:Tabno,:Fio,:W_Place,:ShifrKat,:ShifrGru,
                        :F_data, extract(Day from :F_Data),extract(Month from :F_Data), extract(Year from :F_Data),
                        :L_data, extract(Day from :L_Data),extract(Month from :L_Data), extract(Year from :L_Data),
                        :DataVy,extract(Month from :DataVy), extract(Year from :DataVy),
                        :Oklad,:ShifrSta,:O_Day,
                        :meanday_bud, :meanday_vne, :meanday_gn, :meanday_nis,
                        :SUMMA_OTP,:SUMMA_OTP_B,:SUMMA_OTP_V,:SUMMA_OTP_G,:SUMMA_OTP_N,
                        :DATA_PERE,:ID_CLAR,:RAZRIJAD,
                        :summa_bud, :summa_vne, :summa_gn, :summa_nis,
                        :summa_bud+:summa_vne+:summa_gn+:summa_nis,:itogo_day,0,:dolg,:mode,:modedc,
                        :data_pere_bud,:data_pere_vne,:data_pere_gn,:data_pere_nis,:kind_otp,
                        :nomer_pri,:DATA_PRI,:PERIOD_PRI,:mode_25_07_2016);

    DELETE FROM otp_res   WHERE shifridotp=:ShifrId;
    DELETE FROM otp_summy WHERE shifridotp=:ShifrId;
    DELETE FROM otp_add   WHERE shifridotp=:ShifrId;
  --  DELETE FROM otpuska   WHERE shifrid=:ShifrId;

    INSERT INTO otp_res (SHIFRIDotp,SHIFRSTA,o_DAY,MONTH_ZA,YEAR_ZA,
                         SUMMA_o_BUD,SUMMA_O_VNE,SUMMA_O_GN,SUMMA_O_NIS,
                         NEED_PERE_BUD,NEED_PERE_VNE,NEED_PERE_GN,NEED_PERE_NIS,
                         DATA_PERE_BUD,DATA_PERE_VNE,DATA_PERE_GN,DATA_PERE_NIS)
           SELECT :ShifrId,SHIFRSTA,O_DAY,MONTH_ZA,YEAR_ZA,
                   SUMMA_O_BUD,SUMMA_O_VNE,SUMMA_O_GN,SUMMA_O_NIS,
                   NEED_PERE_BUD,NEED_PERE_VNE,NEED_PERE_GN,NEED_PERE_NIS,
                   DATA_PERE_BUD,DATA_PERE_VNE,DATA_PERE_GN,DATA_PERE_NIS
                   FROM TMP_OTP_RES where connid=CURRENT_CONNECTION;

    INSERT INTO OTP_summy (SHIFRIDOTP,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAY_KALEND,DAY_WORK,KOEF,MANUAL_CALC,DAY_KALEND_WORK)
            SELECT :SHIFRID,SEL,MONTH_ZA,YEAR_ZA,
                                 SUMMA_BUD,SUMMA_VNE,SUMMA_GN,SUMMA_NIS,OKLAD_M,
                                 DAY_KALEND,DAY_WORK,KOEF,MANUAL_CALC,DAY_KALEND_WORK
                                 FROM TMP_OTP_SUMMY where connid=CURRENT_CONNECTION;

    INSERT INTO OTP_ADD (SHIFRIDOTP,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,SEL,ID_CLAR)
            SELECT :SHIFRID,
                            W_PLACE,W_R,SHIFRGRU,SHIFRKAT,SHIFRSTA,MONTH_ZA,YEAR_ZA,
                            MONTH_VY,YEAR_VY,SUMMA,VYPL,SEL,ID_CLAR
                                 FROM TMP_OTP_ADD where connid=CURRENT_CONNECTION;
--                                 FROM BOLNA where SHIFRIDBOLN=:SHIFRID;
    summa1=0;
    summa2=0;
    select sum(summa) from otp_add where shifridotp=:shifrid into :summa1;
    if (summa1 is null) then summa1=0;
    select sum(summa) from tmp_otp_add where connid=CURRENT_CONNECTION into :summa2;
    if (summa2 is null) then summa2=0;
    if (summa1<>summa2) then
--    if (ROW_COUNT=0) then
       exception TESTPUTBOLN 'Wrong inserting ID=' || :SHIFRID || ' CON_ID=' ||CURRENT_CONNECTION || ' summa1=' || summa1 || 'summa2=' || summa2;

    update OTP_ADD a
       set SHIFRIDOTPSUM=(select first 1 shifrid
                                    from OTP_summy b
                                    where b.month_za=a.month_za and
                                          b.year_za=a.year_za   and
                                          b.ShifrIdOtp=:ShifrId)
       where ShifrIdOtp=:ShifrId;

    EXECUTE PROCEDURE PR_DELETE_ALL_FROM_TMP_OTP;
/*
    DELETE FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION;
    DELETE FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION;
    SELECT COUNT(*) FROM tmp_otp_res   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_otp_summy WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
    SELECT COUNT(*) FROM tmp_otp_add   WHERE CONNID=CURRENT_CONNECTION INTO :MUSOR;
*/
/*    exception testputboln; */

  /* Procedure Text */

end^


ALTER PROCEDURE R_01_ALL_LIST
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(25),
    DOLG VARCHAR(10),
    SHIFRGRU INTEGER,
    SHIFRKAT INTEGER,
    SUMMA DECIMAL(15,2),
    NAMEGRU VARCHAR(15),
    NAMEKAT VARCHAR(30),
    W_PLACE INTEGER,
    KOEF DECIMAL(15,2),
    W_DAY INTEGER,
    I_DAY INTEGER,
    O_DAY INTEGER,
    NAMEPOD CHAR(80))
AS
declare variable shifrid integer;
declare variable i_row integer;
declare variable shifrsta integer;
declare variable yearza integer;
declare variable monthza integer;
declare variable namesta varchar(40);
declare variable summatotadd decimal(15,2);
declare variable summatotud decimal(15,2);
declare variable summatotbank decimal(15,2);
declare variable m integer;
declare variable dt date;
begin
      dt='2008-01-01';
      for
         select tabno from kadry order by 1 into :tabno
      do
         begin
      m=extract(month from dt);
      w_day=0;
      i_day=0;
      o_day=0;
      select first 1 work_day.retval from work_day(:tabno, :dt) into :w_day;
      if (w_day is null) then  w_day=0;
      select first 1 ill_day.retval from ill_day(:tabno, :dt) into :i_day;
      if (i_day is null) then  i_day=0;
      select first 1 otp_day.retval from otp_day(:tabno, :dt) into :o_day;
      if (o_day is null) then  o_day=0;
      I_ROW=0;
       for
         select a.shifrid,a.dolg,a.shifrgru,a.shifrkat,a.fio,a.w_place,
                (select first 1 name from gruppy where gruppy.shifr=a.shifrgru),
                (select first 1 name from kateg where kateg.shifr=a.shifrkat),
                (select first 1 name from podr where podr.shifrpod=a.w_place)
                 from person a
                 where a.tabno=:Tabno and
                       a.yearvy=extract(year from :dt) and
                       a.monthvy=extract(month from :dt)
                 order by a.w_r,a.w_place
                 into :ShifrId,:Dolg,:ShifrGru,:ShifrKat,:FIO,:W_PLACE,
                      :namegru,:namekat,:namepod
      do
        begin
              select first 1 summa from fcn
                     where fcn.shifridperson=:shifrid and
                           fcn.shifrsta=99+500  and
                           fcn.kod=100
                     into :koef;
              select sum(b.summa) from fadd b
                     where b.shifridperson=:ShifrId and b.shifrsta=1
                     into :Summa;
              if (summa is not null) then
                 suspend;
        end
   end
end^


ALTER PROCEDURE R_01_LIST (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    FIO VARCHAR(25),
    DOLG VARCHAR(10),
    SHIFRGRU INTEGER,
    SHIFRKAT INTEGER,
    SUMMA DECIMAL(15,2),
    NAMEGRU VARCHAR(15),
    NAMEKAT VARCHAR(30),
    W_PLACE INTEGER,
    KOEF DECIMAL(15,2),
    W_DAY INTEGER,
    I_DAY INTEGER,
    O_DAY INTEGER,
    NAMEPOD CHAR(80))
AS
declare variable shifrid integer;
declare variable i_row integer;
declare variable shifrsta integer;
declare variable yearza integer;
declare variable monthza integer;
declare variable namesta varchar(40);
declare variable summatotadd decimal(15,2);
declare variable summatotud decimal(15,2);
declare variable summatotbank decimal(15,2);
declare variable m integer;
begin
      m=extract(month from dt);
      w_day=0;
      i_day=0;
      o_day=0;
      select first 1 work_day.retval from work_day(:tabno, :dt) into :w_day;
      if (w_day is null) then  w_day=0;
      select first 1 ill_day.retval from ill_day(:tabno, :dt) into :i_day;
      if (i_day is null) then  i_day=0;
      select first 1 otp_day.retval from otp_day(:tabno, :dt) into :o_day;
      if (o_day is null) then  o_day=0;
      I_ROW=0;
       for
         select a.shifrid,a.dolg,a.shifrgru,a.shifrkat,a.fio,a.w_place,
                (select first 1 name from gruppy where gruppy.shifr=a.shifrgru),
                (select first 1 name from kateg where kateg.shifr=a.shifrkat),
                (select first 1 name from podr where podr.shifrpod=a.w_place)
                 from person a
                 where a.tabno=:Tabno and
                       a.yearvy=extract(year from :dt) and
                       a.monthvy=extract(month from :dt)
                 order by a.w_r,a.w_place
                 into :ShifrId,:Dolg,:ShifrGru,:ShifrKat,:FIO,:W_PLACE,
                      :namegru,:namekat,:namepod
      do
        begin
              select first 1 summa from fcn
                     where fcn.shifridperson=:shifrid and
                           fcn.shifrsta=99+500  and
                           fcn.kod=100
                     into :koef;
              select sum(b.summa) from fadd b
                     where b.shifridperson=:ShifrId and b.shifrsta=1
                     into :Summa;
              if (summa is not null) then
                 suspend;
        end
end^


ALTER PROCEDURE R_LIST (
    TABNO INTEGER,
    DT DATE,
    DOPPODRMODE INTEGER)
RETURNS (
    RETVAL VARCHAR(250))
AS
declare variable SHIFRID integer;
declare variable DOLG varchar(50);
declare variable SHIFRGRU integer;
declare variable SHIFRKAT integer;
declare variable SUMMA decimal(15,2);
declare variable I_ROW integer;
declare variable FIO varchar(50);
declare variable NAMEGRU varchar(15);
declare variable NAMEKAT varchar(30);
declare variable KOEF decimal(15,2);
declare variable W_PLACE integer;
declare variable NAMEPOD char(80);
declare variable SHIFRSTA integer;
declare variable YEARZA integer;
declare variable MONTHZA integer;
declare variable NAMESTA varchar(40);
declare variable SUMMATOTADD decimal(15,2);
declare variable SUMMATOTUD decimal(15,2);
declare variable SUMMATOTBANK decimal(15,2);
declare variable M integer;
declare variable W_DAY integer;
declare variable I_DAY integer;
declare variable O_DAY integer;
begin
      if (doppodrmode<>1) then
         doppodrmode=0;
      retval='';
      m=extract(month from dt);
      retval=case m
           when  1 then 'январь'
           when  2 then 'февраль'
           when  3 then 'март'
           when  4 then 'апрель'
           when  5 then 'май'
           when  6 then 'июнь'
           when  7 then 'июль'
           when  8 then 'август'
           when  9 then 'сентябрь'
           when 10 then 'октябрь'
           when 11 then 'ноябрь'
           when 12 then 'декабрь'
      end;
      retval=retval||' '||extract(year from dt)||' г.';
      suspend;
      w_day=0;
      i_day=0;
      o_day=0;
      select first 1 work_day.retval from work_day(:tabno, :dt) into :w_day;
      if (w_day is null) then  w_day=0;
      select first 1 ill_day.retval from ill_day(:tabno, :dt) into :i_day;
      if (i_day is null) then  i_day=0;
      select first 1 otp_day.retval from otp_day(:tabno, :dt) into :o_day;
      if (o_day is null) then  o_day=0;
      I_ROW=0;
      summatotadd=0;
      select sum(b.summa) from fadd b
             where b.tabno    = :Tabno
               and b.year_vy  = extract(year from :dt)
               and b.month_vy = extract(month from :dt)
               and (
                    ((:doppodrmode=1) and (b.w_place not in (76,102,140)))
                    or
                    (:dopPodrMode<>1)
               )
             into :SummaTotAdd;
      for
         select a.shifrid,a.dolg,a.shifrgru,a.shifrkat,a.fio,a.w_place from person a
                 where a.tabno=:Tabno
                   and a.yearvy=extract(year from :dt)
                   and a.monthvy=extract(month from :dt)
                   and (
                       ((:doppodrmode=1) and (a.w_place not in (76,102,140)))
                       or
                       (:dopPodrMode<>1)
                   )

                 order by a.w_r,a.w_place
                 into :ShifrId,:Dolg,:ShifrGru,:ShifrKat,:FIO,:W_PLACE
      do
        begin
              summa=0;
              select sum(b.summa) from fadd b
                     where b.shifridperson=:ShifrId
                     into :Summa;
              if (not ((Summa is null) or (Summa=0))) then
                 begin
                       I_ROW=I_ROW+1;
                       if (I_ROW=1) then
                          begin
                                RetVal=case
                                           when tabno<10   then '    '||cast(Tabno as char(1))
                                           when tabno<100  then '   ' ||cast(Tabno as char(2))
                                           when tabno<1000 then '  '  ||cast(Tabno as char(3))
                                           when tabno<10000 then ' '  ||cast(Tabno as char(4))
                                           else cast(Tabno as char(5))
                                       end;
                                RetVal=rtrim(RetVal)||' '||trim(fio);
                                suspend;
                                RetVal='Рб.'||w_day||' дн.';
                                if (i_day>0) then retval=retval||'Бл.'||I_Day||' дн.';
                                if (o_day>0) then retval=retval||'От.'||O_Day||' дн.';
                                Suspend;
                          end
                       select first 1 gruppy.name from gruppy
                              where gruppy.shifr=:ShifrGru
                              into :NameGru;
                       if (namegru is null) then NameGru='не изв';
                       select first 1 kateg.name from kateg
                              where kateg.shifr=:shifrkat
                              into :NameKat;
                       if (NameKat is null) then NameKat='не изв';
                       select first 1 fcn.summa from fcn
                                      where fcn.shifrsta=(99+500) and
                                            fcn.shifridperson=:ShifrId
                                      into :koef;
                       if (Koef is null) then Koef=1;
                       select first 1 podr.name from podr where podr.shifrpod=:w_place into :NamePod;
                       if (namepod is null) then NamePod='Нет';
                       retval=trim(cast(w_place as char(4)))||' '||trim(namepod);
                       suspend;
                       RetVal=trim(dolg)||' '||trim(cast(koef as char(6)))||' '||trim(namegru)||' '||trim(namekat);
                       suspend;
                       for
                           select fadd.shifrsta,fadd.year_za,fadd.month_za,fadd.summa
                                  from fadd
                                  where fadd.shifridperson=:shifrid
                                  order by fadd.shifrsta,fadd.year_za,fadd.month_za
                                  into :ShifrSta,:YearZa,:MonthZa,:Summa
                       do
                          begin
                               select first 1 shifr.shortname from shifr
                                      where shifr.shifr=:shifrsta
                                      into :NameSta;
                               if (namesta is null) then namesta='  ';
                               RetVal=case
                                          when shifrsta<10 then '  '||cast(shifrsta as char(1))
                                          when shifrsta<100 then ' '||cast(shifrsta as char(2))
                                          else cast(shifrsta as char(3))
                                      end
                                      ||' '||
                                      rpad(cast(namesta as char(20)),20,' ')||' '||
                                      cast(yearza as char(4))||' '||
                                      case
                                          when monthza<10 then '0'||cast(monthza as char(1))
                                          else cast(monthza as char(2))
                                      end
                                      ||' '||
                                      lpad(rtrim(cast(summa as char(9))),9,' ');
                               suspend;
                          end
                 end


        end
         --         

      --     
  RetVal='Удержания    ';
  suspend;
  summatotud=0;
  for
     select fud.shifrsta,sum(fud.summa) from fud
            where fud.tabno=:tabno
              and fud.year_vy=extract(year from :dt)
              and fud.month_vy=extract(month from :dt)
              and fud.ShifrSta not in (67,77,86,91,102,103,104,131,132,133,134,135,136)
              and (
                    ((:doppodrmode=1) and (fud.w_place not in (76,102,140)))
                    or
                    (:dopPodrMode<>1)
               )


            group by fud.shifrsta
            into :shifrsta, :Summa
  do
  begin
       if (abs(Summa)>0.005) then
           begin
                summatotud=summatotud+summa;
                select first 1 shifr.shortname from shifr
                       where shifr.shifr=:shifrsta
                       into :NameSta;
                if (namesta is null) then namesta=' ';

                RetVal='     '||
                             case
                                 when shifrsta<10 then '  '||cast(shifrsta as char(1))
                                 when shifrsta<100 then ' '||cast(shifrsta as char(2))
                                 else cast(shifrsta as char(3))
                             end
                       ||' '||
                       cast(namesta as char(28))||' '||
                       lpad(rtrim(cast(summa as char(9))),9,' ');
                Suspend;
           end
  end

  RetVal='Начислено       '||' '||
              cast(summatotadd as char(9))||' '||
              'удержано'||' '||
              cast(summatotud as char(9));
  suspend;
  --      
  RetVal=cast('К выдаче ' as char(35))||
              cast(summatotadd-summatotud as char(9));
  suspend;

 --
  RetVal='------------------------------';
  suspend;
  summatotbank=0;
  for
     select fud.shifrsta,sum(fud.summa) from fud
            where fud.tabno=:tabno
              and fud.year_vy=extract(year from :dt)
              and fud.month_vy=extract(month from :dt)
              and fud.ShifrSta in (67,77,86,91,102,103,104,131,132,133,134,135,136)
              and (
                    ((:doppodrmode=1) and (fud.w_place not in (76,102,140)))
                    or
                    (:dopPodrMode<>1)
               )

            group by fud.shifrsta
            into :shifrsta, :Summa
  do
  begin
       if (abs(Summa)>0.005) then
           begin
                summatotbank=summatotbank+summa;
                select first 1 shifr.shortname from shifr
                       where shifr.shifr=:shifrsta
                       into :NameSta;
                if (namesta is null) then namesta=' ';

                RetVal='     '||
                             case
                                 when shifrsta<10 then '  '||cast(shifrsta as char(1))
                                 when shifrsta<100 then ' '||cast(shifrsta as char(2))
                                 else cast(shifrsta as char(3))
                             end
                       ||' '||
                       cast(namesta as char(28))||' '||
                       lpad(rtrim(cast(summa as char(9))),9,' ');
                Suspend;
           end
  end

  --              

  RetVal=cast('Перечисл.на банк.' as char(35))||
              cast(summatotbank as char(9));
  suspend;

  /* Procedure Text */
end^


ALTER PROCEDURE RECALCECBYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMANADD DECIMAL(15,2),
    SUMMAADD DECIMAL(15,2),
    SUMMADPADD DECIMAL(15,2),
    SUMMAILLADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summanadd, :summaecbnud;
             select first 1 SummaECB from ECBN_common(:tabno, :YearZa,:MonthZa,:SummaNAdd) into :SummaEcbnRas;
             SummaECBnRazn=:SummaECBnRas-:SummaECBnUd;

             select first 1 summaadd,summaecb from getecbnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaadd, :summaecbud;
             select first 1 SummaECB from ECB_common(:tabno, :YearZa,:MonthZa,:SummaAdd,0,0) into :SummaEcbRas;
             SummaECBRazn=:SummaECBRas-:SummaECBUd;

             select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summadpadd, :summaecbdpud;
             select first 1 SummaECB from ECBDp_common(:tabno, :YearZa,:MonthZa,:SummaDPAdd) into :SummaEcbDPRas;
             SummaECBDPRazn=:SummaECBDpRas-:SummaECBDpUd;

             select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summailladd, :summaecbillud;
             select first 1 SummaECBill from ECBIll_common(:tabno, :YearZa,:MonthZa,:SummaIllAdd) into :SummaEcbIllRas;
             SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;

             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE RECALCFZYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAFZUD DECIMAL(15,2),
    SUMMAFZRAS DECIMAL(15,2),
    SUMMAFZRAZN DECIMAL(15,2))
AS
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             select first 1 summaadd,summafz from getfznachud(:tabno,:yearza,:monthza) into :summaadd, :summafzud;
             select first 1 SummaFz from fz(:SummaAdd,:yearza, :MonthZa,:tabno) into :SummaFzRas;
             SummaFzRazn=:SummaFZRas-:SummaFzUd;
             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE RECALCPENSYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMAPENSUD DECIMAL(15,2),
    SUMMAPENSRAS DECIMAL(15,2),
    SUMMAPENSRAZN DECIMAL(15,2))
AS
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             select first 1 summaadd,summapens from getpensnachud(:tabno,:yearza,:monthza) into :summaadd, :summapensud;
             select first 1 Summapens from pens(:tabno,:YearZa,:MonthZa, :SummaAdd) into :SummapensRas;
             SummaPensRazn=:SummaPensRas-:SummaPensUd;
             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE RECALCPODOHYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
declare variable D date;
declare variable SUMMALIMITFORECB decimal(15,2);
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             d=yearza||'-'||monthza||'-01';
             select first 1 limitmax  from sslimity
                                      where datefr<:d
                                      order by datefr desc
                                      into :summalimitforecb;
             summalimitforecb=coalesce(summalimitforecb, 14000);
             select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbnadd, :summaecbnud;
             select first 1 SummaECB from ECBN_common(:tabno, :YearZa,:MonthZa,:SummaECBNAdd) into :SummaEcbnRas;
             SummaECBnRazn=:SummaECBnRas-:SummaECBnUd;

             select first 1 summaadd,summaecb from getecbnAchud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbadd, :summaecbud;
             select first 1 SummaECB from ECB_common(:tabno, :YearZa,:MonthZa,:SummaecbAdd,0,0) into :SummaEcbRas;
             if (SummaECBNAdd>=summalimitforecb) then
                 summaecbras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd)>summalimitforecb) then
                   summaecbras=(summalimitforecb-SummaECBNAdd)*0.036;
             SummaECBRazn=:SummaECBRas-:SummaECBUd;

             select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbdpadd, :summaecbdpud;
             select first 1 SummaECB from ECBDp_common(:tabno, :YearZa,:MonthZa,:SummaECBDPAdd) into :SummaEcbDPRas;
             if ((SummaECBNAdd+SummaECBAdd)>=summalimitforecb) then
                 summaecbdpras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd+SummaECBDpAdd)>summalimitforecb) then
                   summaecbDpras=(summalimitforecb-SummaECBNAdd-SummaECBAdd)*0.026;
             SummaECBDPRazn=:SummaECBDpRas-:SummaECBDpUd;

             select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbilladd, :summaecbillud;
             select first 1 SummaECBill from ECBIll_common(:tabno, :YearZa,:MonthZa,:SummaECBIllAdd) into :SummaEcbIllRas;
             if ((SummaECBNAdd+SummaECBAdd+SummaECBDPAdd)>=summalimitforecb) then
                 summaecbillras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd+SummaECBDpAdd+SummaECBIllAdd)>summalimitforecb) then
                   summaecbIllras=(summalimitforecb-SummaECBNAdd-SummaECBAdd-SummaECBDPADD)*0.02;

             SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;
             select first 1 summaadd,summapod from getpodnachud(:tabno,:yearza,:monthza) into :summapodadd, :summapodud;
  --           select first 1 SummaPod from podoh(:tabno,:YearZa,:MonthZa,:summapodadd, :summaecbnras+:summaecbras+:summaecbdpras+:summaecbillras) into :SummaPodRas;
             select first 1 SummaPod from podoh(:tabno,:YearZa,:MonthZa,:summapodadd, :summaecbnras+:summaecbras+:summaecbillras) into :SummaPodRas;
             SummaPodRazn=:SummaPodRas-:SummaPodUd;
             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE RECALCPODOHYEAR_2010 (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAPODADD DECIMAL(15,2),
    SUMMAPODUD DECIMAL(15,2),
    SUMMAPODRAS DECIMAL(15,2),
    SUMMAPODRAZN DECIMAL(15,2),
    SUMMAECBNADD DECIMAL(15,2),
    SUMMAECBNUD DECIMAL(15,2),
    SUMMAECBNRAS DECIMAL(15,2),
    SUMMAECBNRAZN DECIMAL(15,2),
    SUMMAECBADD DECIMAL(15,2),
    SUMMAECBUD DECIMAL(15,2),
    SUMMAECBRAS DECIMAL(15,2),
    SUMMAECBRAZN DECIMAL(15,2),
    SUMMAECBDPADD DECIMAL(15,2),
    SUMMAECBDPUD DECIMAL(15,2),
    SUMMAECBDPRAS DECIMAL(15,2),
    SUMMAECBDPRAZN DECIMAL(15,2),
    SUMMAECBILLADD DECIMAL(15,2),
    SUMMAECBILLUD DECIMAL(15,2),
    SUMMAECBILLRAS DECIMAL(15,2),
    SUMMAECBILLRAZN DECIMAL(15,2))
AS
declare variable D date;
declare variable SUMMALIMITFORECB decimal(10,2);
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             d=yearza||'-'||monthza||'-01';
             select first 1 limitmax  from sslimity
                                      where datefr<:d
                                      order by datefr desc
                                      into :summalimitforecb;
             summalimitforecb=coalesce(summalimitforecb, 14000);
             select first 1 summaadd,summaecb from getecbnnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbnadd, :summaecbnud;
             select first 1 SummaECB from ECBN_common(:tabno, :YearZa,:MonthZa,:SummaECBNAdd) into :SummaEcbnRas;
             SummaECBnRazn=:SummaECBnRas-:SummaECBnUd;

             select first 1 summaadd,summaecb from getecbnAchud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbadd, :summaecbud;
             select first 1 SummaECB from ECB_common(:tabno, :YearZa,:MonthZa,:SummaecbAdd,0,0) into :SummaEcbRas;
             if (SummaECBNAdd>=summalimitforecb) then
                 summaecbras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd)>summalimitforecb) then
                   summaecbras=(summalimitforecb-SummaECBNAdd)*0.036;
             SummaECBRazn=:SummaECBRas-:SummaECBUd;

             select first 1 summaadd,summaecb from getecbdpnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbdpadd, :summaecbdpud;
             select first 1 SummaECB from ECBDp_common(:tabno, :YearZa,:MonthZa,:SummaECBDPAdd) into :SummaEcbDPRas;
             if ((SummaECBNAdd+SummaECBAdd)>=summalimitforecb) then
                 summaecbdpras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd+SummaECBDpAdd)>summalimitforecb) then
                   summaecbDpras=(summalimitforecb-SummaECBNAdd-SummaECBAdd)*0.026;
             SummaECBDPRazn=:SummaECBDpRas-:SummaECBDpUd;

             select first 1 summaadd,summaecbill from getecbillnachud_common(:tabno,:yearza,:monthza,0,0,0,0) into :summaecbilladd, :summaecbillud;
             select first 1 SummaECBill from ECBIll_common(:tabno, :YearZa,:MonthZa,:SummaECBIllAdd) into :SummaEcbIllRas;
             if ((SummaECBNAdd+SummaECBAdd+SummaECBDPAdd)>=summalimitforecb) then
                 summaecbillras=0;
             else
                if ((SummaECBNAdd+SummaECBAdd+SummaECBDpAdd+SummaECBIllAdd)>summalimitforecb) then
                   summaecbIllras=(summalimitforecb-SummaECBNAdd-SummaECBAdd-SummaECBDPADD)*0.02;

             SummaECBIllRazn=:SummaECBIllRas-:SummaECBIllUd;

             select first 1 summaadd,summapod from getpodnachud(:tabno,:yearza,:monthza) into :summapodadd, :summapodud;
             select first 1 SummaPod from podoh_2010(:tabno,:YearZa,:MonthZa, :SummaPodAdd,0,0) into :SummaPodRas;
             SummaPodRazn=:SummaPodRas-:SummaPodUd;
             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE RECALCSSYEAR (
    TABNO INTEGER,
    YEARZA INTEGER)
RETURNS (
    MONTHZA INTEGER,
    SUMMAADD DECIMAL(15,2),
    SUMMASSUD DECIMAL(15,2),
    SUMMASSRAS DECIMAL(15,2),
    SUMMASSRAZN DECIMAL(15,2))
AS
begin
      monthza=0;
      while (monthza<12) do
       begin
             monthza=Monthza+1;
             select first 1 summaadd,summass from getssnachud(:tabno,:yearza,:monthza) into :summaadd, :summassud;
             select first 1 SummaSS from SS(:SummaAdd,:YearZa,:MonthZa) into :SummaSsRas;
             SummaSSRazn=:SummaSSRas-:SummaSSUd;
             Suspend;
       end
  /* Procedure Text */
end^


ALTER PROCEDURE SETIDBOLNA
AS
declare variable id_clar integer;
declare variable shifridboln integer;
declare variable shifrid integer;
declare variable tabno integer;
begin
     for
         select boln.id_clar,ShifrId,Tabno from boln where id_clar>0 into :id_clar,:ShifrIdBoln,:Tabno
     do
        begin
              for
                  select shifrid from bolna where bolna.id_clar=:id_clar and bolna.tabno=:Tabno into :ShifrId
              do
                 begin
                       update bolna set shifridboln=:shifridboln where Bolna.ShifrId=:ShifrId;
                 end
        end  /* Procedure Text */
--  suspend;
end^


ALTER PROCEDURE SETIDBOLNASUMMY
AS
declare variable shifridboln integer;
declare variable shifrid integer;
declare variable tabno integer;
declare variable monthza integer;
declare variable yearza integer;
declare variable shifridbolna integer;
begin
     for
         select ShifrId,Tabno from boln where id_clar>0 into :ShifrIdBoln,:Tabno
     do
        for
           select shifrid,boln_summy.month_za,boln_summy.year_za from boln_summy
                  where boln_summy.shifridboln=:ShifrIdBoln into :ShifrId,:monthza,:yearza
       do
         for select ShifrId from bolna
                    where bolna.shifridboln=:ShifrIdBoln and
                          bolna.month_za=:Monthza and
                          bolna.Year_Za=:Yearza
                    into :ShifrIdBolna
         do
            update bolna set bolna.shifridbolnsummy =:shifrid
                   where Bolna.ShifrId=:ShifrIdBolna;
--  suspend;
end^


ALTER PROCEDURE SETIDOTPADD
AS
declare variable id_clar integer;
declare variable shifridotp integer;
declare variable shifrid integer;
declare variable tabno integer;
begin
     for
         select otpuska.id_clar,ShifrId,Tabno from otpuska where id_clar>0 into :id_clar,:ShifrIdOtp,:Tabno
     do
       for
          select shifrid from otp_add where otp_add.id_clar=:id_clar and otp_add.tabno=:Tabno into :ShifrId
       do
          update otp_add set shifridOtp=:shifridOtp where otp_add.ShifrId=:ShifrId;
 -- suspend;
end^


ALTER PROCEDURE SS (
    SUMMA DECIMAL(15,2),
    YEARZA INTEGER,
    MONTHZA INTEGER)
RETURNS (
    SUMMASS DECIMAL(15,2))
AS
declare variable D date;
declare variable LIMPROC decimal(15,2);
declare variable LIMITMAX decimal(15,2);
declare variable PROCSSDOLIM decimal(15,5);
declare variable PROCSSAFTERLIM decimal(15,5);
begin
     d=YearZa||'-'||MonthZa||'-10';
     select first 1 a.limproc,a.limitmax,a.procssdolim,a.procssafterlim from sslimity a
            WHERE :D>A.datefr
            ORDER by A.DATEFR desc
            into :limproc,:limitmax,:procssdolim,:procssafterlim;
     SUMMASS=0;
     if (LIMPROC IS NOT NULL) then
        BEGIN
              if (SUMMA>LIMITMAX) then SUMMA=LIMITMAX;
              if (SUMMA>=LIMPROC) then
                 SUMMASS=SUMMA*PROCssAFTERLIM;
              ELSE
                 SUMMASS=SUMMA*PROCSSDOLIM;
        END
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE TEST_MEM
RETURNS (
    TABNO INTEGER,
    SUMMA DECIMAL(15,2),
    SUMMA1 DECIMAL(15,2))
AS
declare variable t integer;
begin
   for
      select tabno,sum(summa) from test_addm a where shifrgru=11 and shifrcol in (1101,12,14) and shifrkat=1
         group by tabno
        into :tabno,:summa
   do
     begin
           select b.tabno, sum(b.summa) from test_add b
                  where b.shifrgru=11 and
                        b.shifrkat=1  and
                        b.tabno=:tabno
                  group by b.tabno
            into :t,:Summa1;
          if (Summa1 is Null) then
             suspend;
          if (Summa1<>Summa) then
             suspend;
     end
end^


ALTER PROCEDURE TESTF_Z (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA NUMERIC(15,2),
    FOND NUMERIC(15,2))
AS
BEGIN EXIT; END^


ALTER PROCEDURE TESTS_S (
    WYEAR INTEGER,
    WMONTH INTEGER)
RETURNS (
    TABNO INTEGER,
    FIO VARCHAR(50),
    SUMMA NUMERIC(15,2),
    F_S_S NUMERIC(15,2))
AS
BEGIN EXIT; END^


ALTER PROCEDURE TESTSUBBOTA (
    D DATE,
    SHIFRIDPERSON INTEGER)
RETURNS (
    SUBBOTA INTEGER)
AS
declare variable C integer;
declare variable KOW integer;
declare variable ISCOLLEDG integer;
declare variable SHIFRPOD integer;
declare variable RETVAL integer;
begin
  /* Procedure Text */
--  retval=sdow(d);
  iscolledg=0;
  shifridperson=coalesce(:shifridperson,0);
  if (shifridperson=-2) then
     iscolledg=1;
  else
  if (shifridperson=-1) then
     iscolledg=0;
  else
  if (shifridperson>0) then
     begin
          shifrpod=null;
          retval=0;
          select first 1 a.w_place from fadd a
                 where a.shifridperson=:shifridperson
                   and a.w_r=1
                 into shifrpod;
          shifrpod=coalesce(:shifrpod,0);
          select first 1 retval from pr_is_coledgpodr(:shifrpod)
                                into :retval;
          retval=coalesce(retval, 0);
          if (retval=1) then
             iscolledg=1;
          else
             iscolledg=0;
     end

  Subbota=0;
  C=D-cast('100-01-01'as date)+4;
  Kow=C-(C / 7)*7;
--  if (RetVal starting with 'Сб') then Subbota=1;
  if (Kow=5) then Subbota=1;
  if (d='2011-03-12') then Subbota=0;
  if (d='2011-05-14') then Subbota=0;
  if (d='2011-05-21') then Subbota=0;
  if (d='2011-05-28') then Subbota=0;
  if (d='2012-03-03') then Subbota=0;
  if (d='2012-06-29') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2012-07-07') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2012-12-29') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2012-12-31') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2013-12-07') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2013-12-21') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2013-12-30') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2013-12-31') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2014-01-02') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2014-01-03') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2014-01-06') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2014-01-11') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2014-01-18') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2014-01-25') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2014-12-13') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2014-12-20') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2015-01-02') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2015-01-05') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2015-01-06') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2015-01-08') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2015-01-09') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2015-01-17') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2015-01-24') then Subbota=0; -- а эта суббота стала рабочей
  if (d='2015-03-21') then Subbota=1; -- а эта суббота стала рабочей
  if (d='2017-05-08') then Subbota=1; -- Бывший раб день стал выходным
  if (d='2017-05-13') then Subbota=0; -- а эта суббота стала рабочей


  -- Переносы Нового 2013 года для университета
  -- для коледжа переноса не было
  if (iscolledg=0) then
     begin
           if (d='2013-01-02') then Subbota=1; -- Бывший раб день стал субботой
           if (d='2013-01-03') then Subbota=1; -- Бывший раб день стал субботой
           if (d='2013-01-04') then Subbota=1; -- Бывший раб день стал субботой
           if (d='2013-01-12') then Subbota=0; -- а эта суббота стала рабочей
           if (d='2013-01-19') then Subbota=0; -- а эта суббота стала рабочей
           if (d='2013-01-26') then Subbota=0; -- а эта суббота стала рабочей
           if (d='2013-04-29') then Subbota=0; -- а эта суббота стала рабочей на майские 2013
     end
  suspend;
end^


ALTER PROCEDURE TESTVOSKR (
    D DATE)
RETURNS (
    VOSKR INTEGER)
AS
declare variable retval char(2);
declare variable c integer;
declare variable kow integer;
begin
  /* Procedure Text */
--  retval=sdow(d);
  VOSKR=0;
  C=D-cast('100-01-01'as date)+4;
  Kow=C-(C / 7)*7;
--  if (RetVal starting with 'Сб') then Subbota=1;
  if (Kow=6) then Voskr=1;
  suspend;
end^


ALTER PROCEDURE TMP_CR_RAZR
AS
DECLARE VARIABLE SHIFRID INTEGER;
DECLARE VARIABLE TABNO INTEGER;
DECLARE VARIABLE YEARVY INTEGER;
DECLARE VARIABLE MONTHVY INTEGER;
DECLARE VARIABLE DOLG CHAR(25);
DECLARE VARIABLE SHIFRGRU INTEGER;
DECLARE VARIABLE SHIFRKAT FLOAT;
DECLARE VARIABLE W_PLACE INTEGER;
DECLARE VARIABLE PRIM INTEGER;
DECLARE VARIABLE W_R INTEGER;
begin
     FOR
        SELECT SHIFRID,TABNO,YEARVY,MONTHVY,P.dolg,P.w_r,P.shifrgru,P.shifrkat,P.w_place FROM PERSON P
        WHERE YEARVY=2006
        INTO :SHIFRID,:TABNO,:YEARVY,:MONTHVY,:DOLG,:W_R,:SHIFRGRU,:SHIFRKAT,:W_PLACE
     DO
        BEGIN
              if (not EXISTS (SELECT SHIFRID FROM fcn C
                              WHERE C.shifridperson=:SHIFRID AND
                                    C.SHIFRSTA=626 AND C.PRIM>0)) then
                 BEGIN
                      SELECT FIRST 1 F.PRIM FROM FCN f JOIN person e
                        ON F.SHIFRIDPERSON=E.SHIFRID
                        WHERE F.YEAR_VY=2005 AND
                              F.MONTH_VY=12  and
                              E.DOLG=:DOLG   AND
                              E.SHIFRGRU=:shifrgru and
                              E.SHIFRKAT=:SHIFRKAT AND
                              E.W_R=:W_R AND
                              E.TABNO=:tabno AND
                              E.W_PLACE=:w_place AND
                              F.SHIFRSTA=626
                        INTO :PRIM;
                      if (PRIM IS NOT null) then
                         INSERT INTO fcn  (SHIFRIDPERSON,tabno,W_PLACE,W_R,
                                           SHIFRGRU,SHIFRKAT,MONTH_VY,YEAR_VY,
                                           SHIFRSTA,KOD,SUMMA,PRIM,PRIM_1,
                                           DEJA_COUNTED,FLOW_SUMMA,LIMIT_SUMMA,
                                           SCH)
                                values (:shifrid, :TABNO,:W_PLACE,:W_R,
                                        :shifrgru, :SHIFRKAT,:monthvy,:yearvy,
                                        626,100,0,:PRIM,'',
                                        0,0,0,'');
                 END
        END
  /* Procedure Text */
end^


ALTER PROCEDURE WORK_DAY (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
declare variable DAYNO integer;
declare variable CODE integer;
declare variable WD date;
declare variable L integer;
begin
   RetVal=0;
   select first 1 l from lenmonth(:Dt) into :l;
   if (l is null) then l=31;
   select first 1 shifrid from person a
          where tabno=:tabno and
                a.monthvy=extract(month from :dt) and
                a.yearvy=extract(year from :dt) and
                (select shifrwr from pr_isosnwrbyid(a.shifrid))=1
          into :id;
   if (id is not null) then
      begin

           for
              select b.dayno,b.code from tabel b
                     where b.shifrid=:id and b.dayno<=:L
                     order by b.dayno
                     into :dayno,:code
           do
              begin
                   if (:Code in (1,3,19)) then
                      begin
                            wd=extract(year from dt)||'-'||extract(month from dt)||'-'||dayno;
                            if (not exists (select c.shifrid from boln c
                                           where :wd between c.f_data and c.l_data and
                                                 c.mode_ill<>10 and   -- отпуска исключить
                                                 c.tabno=:tabno))  then
                            if (not exists (select d.shifrid from otpuska d
                                           where :wd between d.f_data and d.l_data and
                                                 d.mode=0 and
                                                 d.tabno=:tabno))  then
                               RetVal=RetVal+1;

                      end
              end
      end
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE WORK_DAY_COMMON (
    TABNO INTEGER,
    DT DATE,
    MODE INTEGER)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
declare variable DAYNO smallint;
declare variable CODE smallint;
declare variable WD date;
declare variable L integer;
declare variable SQL varchar(2048);
declare variable RV integer;
begin
   RetVal=0;
   select first 1 l from lenmonth(:Dt) into :l;
   if (l is null) then l=31;
   if (mode=1) then
       select first 1 shifrid from tb_tmp_person a
              where tabno=:tabno and
                    a.monthvy=extract(month from :dt) and
                    a.yearvy=extract(year from :dt) and
                    a.w_r=1
              into :id;
   else
       select first 1 shifrid from person a
              where tabno=:tabno and
                    a.monthvy=extract(month from :dt) and
                    a.yearvy=extract(year from :dt) and
                    a.w_r=1
              into :id;
   if (id is not null) then
      begin
   --  exception wdayzero 'id='||id;

           sql='select dayno,code from';
           if (mode=1) then
              sql=sql||' tb_tmp_tabel';
           else
              sql=sql||' tabel';
           sql=sql||' where shifrid=';
           sql=sql||rtrim(ltrim(cast(id as char(10))))||' and dayno<=';
           sql=sql||rtrim(ltrim(cast(:L as char(2))));
   /*        if (mode=1) then
              sql=sql||' and conn_id=CURRENT_CONNECTION';
   */
           sql=sql||' order by dayno';
           rv=0;
           for
              execute statement sql into :dayno,:code
--              select b.dayno,b.code from tabel b
--                     where b.shifrid=:id and b.dayno<=:L
--                     order by b.dayno
--                     into :dayno,:code
           do
              begin
                   if (:Code=1) then
                      begin
                            rv=rv+1;
                            wd=extract(year from dt)||'-'||extract(month from dt)||'-'||dayno;
                            if (not exists (select c.shifrid from boln c
                                           where :wd between c.f_data and c.l_data and
                                                 c.mode_ill<>10 and            -- больничные
                                                 c.tabno=:tabno))  then
                            if (not exists (select c.shifrid from boln c
                                           where :wd between c.f_data and c.l_data and
                                                 c.mode_ill=10 and             -- командировки
                                  --               extract(year from c.data_p_bud)>2000 and
                                                 c.tabno=:tabno))  then
                            if (not exists (select d.shifrid from otpuska d
                                           where :wd between d.f_data and d.l_data and
                                                 d.tabno=:tabno))  then
                            RetVal=RetVal+1;

                      end
              end
      end
 --   exception wdayzero 'Rv='||RV;
  /* Procedure Text */
  suspend;
end^


ALTER PROCEDURE WORK_DAY_FOR_SOWM (
    TABNO INTEGER,
    DT DATE)
RETURNS (
    RETVAL INTEGER)
AS
declare variable ID integer;
declare variable DAYNO integer;
declare variable CODE integer;
declare variable WD date;
declare variable L integer;
begin
   RetVal=0;
   select first 1 l from lenmonth(:Dt) into :l;
   if (l is null) then l=31;
   select first 1 shifrid from person a
          where tabno=:tabno and
                a.monthvy=extract(month from :dt) and
                a.yearvy=extract(year from :dt) --and
         --       a.w_r=1
          into :id;
   if (id is not null) then
      begin

           for
              select b.dayno,b.code from tabel b
                     where b.shifrid=:id and b.dayno<=:L
                     order by b.dayno
                     into :dayno,:code
           do
              begin
                   if (:Code in (1,3,19)) then
                      begin
                            wd=extract(year from dt)||'-'||extract(month from dt)||'-'||dayno;
                            if (not exists (select c.shifrid from boln c
                                           where :wd between c.f_data and c.l_data and
                                                 c.tabno=:tabno))  then
                            if (not exists (select d.shifrid from otpuska d
                                           where :wd between d.f_data and d.l_data and
                                                 d.tabno=:tabno))  then
                               RetVal=RetVal+1;

                      end
              end
      end
  /* Procedure Text */
  suspend;
end^



SET TERM ; ^



/******************************************************************************/
/***                                 Roles                                  ***/
/******************************************************************************/

CREATE ROLE "ADMIN";
CREATE ROLE BUH;
CREATE ROLE NACH;


/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

DESCRIBE DOMAIN TSUMMAPERSON
'Суммы для работников';



/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

DESCRIBE TABLE BOLN
'Больничные';

DESCRIBE TABLE BOLN_SUMMY
'Отработал дней';

DESCRIBE TABLE BOL_KOE
'Коэффициенты для расчета больничных';

DESCRIBE TABLE I_GRUPPY
'Счета исключаемые из расчета больничных';

DESCRIBE TABLE PENSHEA
'ТАБЛИЦА ПЕНСИОННОГО НАЛОГА (ЗАГОЛОВОК)';

DESCRIBE TABLE PENSPR
'РАСШИФРОВКА СТРОК ПОДОХОДНОГО НАЛОГА';

DESCRIBE TABLE PODOHTBL
'Таблица подоходного налога';

DESCRIBE TABLE PRAZDNIKI
'1 - больничные 2 - отпускные';

DESCRIBE TABLE SHIFRY_IND
'Список статей, которые не входят в расчет индексации';

DESCRIBE TABLE SSLIMITY
'Лимиты для расчета соц.страха';

DESCRIBE TABLE TB_BK
'  Идентификационные номера сотрудников не имеющих кодов (верующих)';

DESCRIBE TABLE TB_CHANGE_RAZR_GRID
'Даты, когда изменялись соотношения между разрадами, т е коэффиценты
 нужно разные по разрядам коэффициенты';

DESCRIBE TABLE TB_DBL_FOR_INDEX
'Таблица для двойников по индексации
Это те у которых оклад разделен на 2 части (бюджет и вне бюджет)
Формируется из программы
Нужно формировать каждый раз перед расчетом инндексации';

DESCRIBE TABLE TB_DOGPOD
'Список подразделений договоров подряда';

DESCRIBE TABLE TB_INFPROC
'Проценты инфляции для расчета индексации';

DESCRIBE TABLE TB_KOMAND
'Командировочные';

DESCRIBE TABLE TB_KOMAND_SUMMY
'Исходные данные для расчета командировочныхй';

DESCRIBE TABLE TB_KREDIT_SPR
'      Справки для кредита';

DESCRIBE TABLE TB_KREDIT_SPR_PR
'Расшифровка к справке для получения кредита';

DESCRIBE TABLE TB_K_ORDERS
'Приказы для по отделу кадров';

DESCRIBE TABLE TB_K_USZ
'     ВИДЫ УЧЕНЫХ СТЕПЕНЕЙ И ЗВАНИЙ';

DESCRIBE TABLE TB_K_WIDNADBSTW
'       Ставки надбавок';

DESCRIBE TABLE TB_K_WIDORDERS
'ВИДЫ ПРИКАЗОВ';

DESCRIBE TABLE TB_MONTH
'КАЛЕНДАРЬ';

DESCRIBE TABLE TB_MONTHS_HEA
'       Заголовок таблицы календаря';

DESCRIBE TABLE TB_PAR_INDEX
'Таблица параметров индексации заработной платы';

DESCRIBE TABLE TB_PLAT_FAKT_87
'фактические платежки по 87 статье';

DESCRIBE TABLE TB_SBS_SAD_TABLE
'Начисления для справок по субсидиям';

DESCRIBE TABLE TB_SPR_ZARPL
' Справка о заработной плате';

DESCRIBE TABLE TB_TMP_PAR_SWOD
'Таблица временных параметров свода';

DESCRIBE TABLE TB_TMP_T07
'Временная таблица для формирования таблицы 7 приложения 4 при генерации
ежемесячной отчетности по персонофикации с января 2010';



/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/

DESCRIBE PROCEDURE MAKEIND
'Расчет индексации работника';

DESCRIBE PROCEDURE PR_GEN_RENEW_SBS_SPR
'      Перегенерация уже существующей справки';

DESCRIBE PROCEDURE PR_GEN_Y_SPR
'Генерация справки за указанный год';

DESCRIBE PROCEDURE PR_IS_SCIPED
'        НАУЧНЫЙ СТАЖ';



/******************************************************************************/
/***                              Descriptions                              ***/
/******************************************************************************/



/******************************************************************************/
/***                          Fields descriptions                           ***/
/******************************************************************************/

DESCRIBE FIELD MODE_ILL TABLE BOLN
'   0-обычный
   1--декретный
   2-по уходу
   10 - командировка';

DESCRIBE FIELD MODEWR TABLE BOLN
'1-основная
2-совмещение
любое др - все вместе';

DESCRIBE FIELD SUMMA_B_BUD TABLE BOLN_RES
'Суммы для работников';

DESCRIBE FIELD SUMMA_B_VNE TABLE BOLN_RES
'Суммы для работников';

DESCRIBE FIELD SUMMA_B_GN TABLE BOLN_RES
'Суммы для работников';

DESCRIBE FIELD SUMMA_B_NIS TABLE BOLN_RES
'Суммы для работников';

DESCRIBE FIELD DATEB TABLE BOL_KOE
'Дата с которой вводится действия коэффмцмента';

DESCRIBE FIELD DATEZA TABLE BOL_KOE
'Дата за которую коєффициент';

DESCRIBE FIELD MODE_DAY_CLOCK TABLE OTPUSKA
'0 - среднедневная
1 - среднечасовая';

DESCRIBE FIELD NOMER_PRI TABLE OTPUSKA
'Номер приказа о предоставлении отпуска';

DESCRIBE FIELD DATA_PRI TABLE OTPUSKA
'Дата приказа о предоставлении отпуска';

DESCRIBE FIELD PERIOD_PRI TABLE OTPUSKA
'Период, за который предоставляется отпуск';

DESCRIBE FIELD MODE_25_07_2016 TABLE OTPUSKA
'Режим расчета с 25 07 2016';

DESCRIBE FIELD SUMMA TABLE OTP_ADD
'Суммы для работников';

DESCRIBE FIELD DATEB TABLE OTP_KOE
'Дата расчета';

DESCRIBE FIELD DATEZA TABLE OTP_KOE
'Коэффициент за какой месяц';

DESCRIBE FIELD SUMMA_BUD TABLE OTP_SUMMY
'Суммы для работников';

DESCRIBE FIELD SUMMA_VNE TABLE OTP_SUMMY
'Суммы для работников';

DESCRIBE FIELD SUMMA_GN TABLE OTP_SUMMY
'Суммы для работников';

DESCRIBE FIELD SUMMA_NIS TABLE OTP_SUMMY
'Суммы для работников';

DESCRIBE FIELD OKLAD_M TABLE OTP_SUMMY
'Суммы для работников';

DESCRIBE FIELD MO_MP TABLE PODR
'Мемориальный ордер материальной помощи';

DESCRIBE FIELD ISKOMP_N_O TABLE RCLC0108
'БЫЛА ОПЛАТА ЗА НЕИСП ОТПУСК';

DESCRIBE FIELD ISKOMP_N_O TABLE RCLC0110
'БЫЛА ОПЛАТА ЗА НЕИСП ОТПУСК';

DESCRIBE FIELD ECB TABLE SHIFR
'ЕДИНЫЙ СОЦИАЛЬНЫЙ ВНЕСОК';

DESCRIBE FIELD SUMMAADD TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAPOD TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAADD1 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAADD2 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAADD3 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAPOD1 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAPOD2 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD SUMMAPOD3 TABLE TB_1DF
'Суммы для работников';

DESCRIBE FIELD KIND TABLE TB_DEKR_ECB
'4 от 3 до 6
5 в и п
6 до 3';

DESCRIBE FIELD KOEF TABLE TB_DVV_REP_RECORDS
'Суммы для работников';

DESCRIBE FIELD ECBPROC TABLE TB_ECB
'Суммы для работников';

DESCRIBE FIELD ECBNPROC TABLE TB_ECB
'Суммы для работников';

DESCRIBE FIELD ECBILLPROC TABLE TB_ECB
'Суммы для работников';

DESCRIBE FIELD ECBDPPROC TABLE TB_ECB
'Суммы для работников';

DESCRIBE FIELD ECBINVPROC TABLE TB_ECB
'Суммы для работников';

DESCRIBE FIELD DATABASEIND TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD PROCIND TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAB TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMABF TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAA TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAAF TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAINDBF TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAUW TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAINDCALC TABLE TB_IND_CALC_12_7
'Суммы для работников';

DESCRIBE FIELD SUMMAPOSTIND TABLE TB_IND_CALC_12_7
'Сумма постоянной индексации после повышения з п';

DESCRIBE FIELD ISPOVRAZR TABLE TB_IND_CALC_12_7
'1 -  в заданном месяце было повышение тарифной сетки';

DESCRIBE FIELD KOEFOSN TABLE TB_IND_CALC_12_7
'Доля ставки по основной работе';

DESCRIBE FIELD SUMMAFIXPREV TABLE TB_IND_CALC_12_7
'Предыдущая фикс сумма';

DESCRIBE FIELD PROCINF TABLE TB_INFPROC
'Суммы для работников';

DESCRIBE FIELD STATE TABLE TB_IO_PODR_MONITOR
'0-free
1-locked';

DESCRIBE FIELD SUMMATOT TABLE TB_KREDIT_SPR
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_KREDIT_SPR_PR
'Суммы для работников';

DESCRIBE FIELD CODEDOLG TABLE TB_K_DECANY
'1-декан
2-зам декан
3-директор
4-зам.директора';

DESCRIBE FIELD PIB_ROD_PAD TABLE TB_K_KADRY
'PIB в родительном падеже';

DESCRIBE FIELD PIB_DAT_PAD TABLE TB_K_KADRY
'Дательный падеж фио';

DESCRIBE FIELD IS_PED TABLE TB_K_KADRY
'1-пед работник';

DESCRIBE FIELD PEDSTAGISPRIBLISIT TABLE TB_K_KADRY
'Пед стаж - приблизительный';

DESCRIBE FIELD CODETYPE TABLE TB_K_KADRYPR
'1-уч. степень
2-уч.звание
3-зв засл
4-podr
5-зав каф
6-декан
7-зам.декана
8-должность - доцент для зарпалаты асс или ст.преп.';

DESCRIBE FIELD DATEPODTV TABLE TB_K_KADRYPR
'Дата получения подтверждения о присвоении';

DESCRIBE FIELD SHIFRPOD TABLE TB_K_ORDERREC
' Номер подразделения';

DESCRIBE FIELD SHIFRWR TABLE TB_K_ORDERREC
'1 - основной вид работы
2 - совмещение';

DESCRIBE FIELD KOEF TABLE TB_K_ORDERREC
'Коэфициент ставки';

DESCRIBE FIELD SHIFRKAT TABLE TB_K_ORDERREC
'Категория 1 - ППС';

DESCRIBE FIELD PSTAG TABLE TB_K_ORDERREC
'Педстаж в годах в виде 10.4 років';

DESCRIBE FIELD PROC_PSTAG TABLE TB_K_ORDERREC
'ПРОЦЕНТ ОПЛАТЫ ПЕДСТАЖА 5, 10 или 30%';

DESCRIBE FIELD SUMMA_P_STAG TABLE TB_K_ORDERREC
'СУММА ОПЛАТЫ ЗА СТАЖ';

DESCRIBE FIELD SUMMA TABLE TB_K_ORDERRECPR
'Суммы для работников';

DESCRIBE FIELD SUMMA_BUD TABLE TB_K_ORDERRECPR
'Суммы для работников';

DESCRIBE FIELD SUMMA_VNE TABLE TB_K_ORDERRECPR
'Суммы для работников';

DESCRIBE FIELD PROCENT TABLE TB_K_ORDERRECPR
'Суммы для работников';

DESCRIBE FIELD PEDSTAG TABLE TB_K_ORDERRECPR
'Суммы для работников';

DESCRIBE FIELD SHIFRISP TABLE TB_K_ORDERS
'Код исполнителя';

DESCRIBE FIELD NAMEISP TABLE TB_K_ORDERS
'ФИО исполнителя';

DESCRIBE FIELD MO_MP TABLE TB_K_PODR
'Мемориальный ордер материальной помощи';

DESCRIBE FIELD SHIFRWR TABLE TB_K_SHTRASPPEDREC
'1-основная
2-совмещение
3-почасовка';

DESCRIBE FIELD PRIORITY TABLE TB_K_SHTRASPPEDREC
'Приотретет для формирования приказа
10-проф
8-доц
6-ст пр
4-асс
5-стажер';

DESCRIBE FIELD SUMMAPOVFULL TABLE TB_K_SHTRASPPEDREC
'повішение из расчета на 1 ставку
те 183
или 732';

DESCRIBE FIELD ISZAWKAF TABLE TB_K_SHTRASPPEDREC
'1 если зав каф
0 в противном случае';

DESCRIBE FIELD ISDEKAN TABLE TB_K_SHTRASPPEDREC
'1 - декан
0 - нет';

DESCRIBE FIELD ISZAMDEKANA TABLE TB_K_SHTRASPPEDREC
'1 - замдекана
0 - 0';

DESCRIBE FIELD ISDOCONOTHERSTAWKA TABLE TB_K_SHTRASPPEDREC
'по должности доцент,
но со ставкой ст преп или асс';

DESCRIBE FIELD PROCNADBZAWKAF TABLE TB_K_SHTRASPPEDREC
'Процент надбавки зав кафедрам
дается доцентам а не проф
и с 01 04 2012 12% (была 20%)';

DESCRIBE FIELD NOTPRINT TABLE TB_K_SHTRASPPEDREC
'Признак - выводить в приказ - не надо';

DESCRIBE FIELD PRIORITY TABLE TB_K_WIDNADB
'Приоритет для печати 1- уч зв 2 уч ст 3 - засл 4 зам дек 5 зав каф';

DESCRIBE FIELD SUMMA TABLE TB_K_WIDNADBSTW
'Суммы для работников';

DESCRIBE FIELD KIND TABLE TB_K_WIDNADBSTW
'1-сумма в противном случае - процент';

DESCRIBE FIELD KOEF TABLE TB_K_ZAJAWLPEDSOWM
'Суммы для работников';

DESCRIBE FIELD SHIFRWRK TABLE TB_K_ZAJAWLPEDSOWM
'Дата подачи';

DESCRIBE FIELD SUMMAH2 TABLE TB_OTPHELPLIST2011
'Суммы для работников';

DESCRIBE FIELD SUMMAOTP1 TABLE TB_OTPHELPLIST2011
'Суммы для работников';

DESCRIBE FIELD SUMMAOTP2 TABLE TB_OTPHELPLIST2011
'Суммы для работников';

DESCRIBE FIELD SUMMAPRE1 TABLE TB_OTPHELPLIST2011
'Суммы для работников';

DESCRIBE FIELD SUMMAPRE2 TABLE TB_OTPHELPLIST2011
'Суммы для работников';

DESCRIBE FIELD YEARZA TABLE TB_PAR_INDEX
'Год за';

DESCRIBE FIELD MONTHZA TABLE TB_PAR_INDEX
'Месяц за';

DESCRIBE FIELD PROCIND TABLE TB_PAR_INDEX
'Процент индексации >0 и <1';

DESCRIBE FIELD LIMITSUMMA TABLE TB_PAR_INDEX
'Сумма подлежащая инлексации';

DESCRIBE FIELD SUMMAFR TABLE TB_PLAN_GRID
'Суммы для работников';

DESCRIBE FIELD SUMMATO TABLE TB_PLAN_GRID
'Суммы для работников';

DESCRIBE FIELD SUMMAPREMBUD TABLE TB_PLAN_PREM_PERSON
'Суммы для работников';

DESCRIBE FIELD SUMMANADBBUD TABLE TB_PLAN_PREM_PERSON
'Суммы для работников';

DESCRIBE FIELD SUMMAPREMVNE TABLE TB_PLAN_PREM_PERSON
'Суммы для работников';

DESCRIBE FIELD SUMMANADBVNE TABLE TB_PLAN_PREM_PERSON
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_PLAT_FAKT_87
'Суммы для работников';

DESCRIBE FIELD SUMMATOT TABLE TB_PLAT_HAT
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_PLAT_PR
'Суммы для работников';

DESCRIBE FIELD OKLAD TABLE TB_RAZR_SWOD
'Суммы для работников';

DESCRIBE FIELD FOP TABLE TB_RAZR_SWOD
'Суммы для работников';

DESCRIBE FIELD FOPOKLAD TABLE TB_RAZR_SWOD
'Суммы для работников';

DESCRIBE FIELD FOPDOPL TABLE TB_RAZR_SWOD
'Суммы для работников';

DESCRIBE FIELD SUMMAIND TABLE TB_RAZR_SWOD
'Суммы для работников';

DESCRIBE FIELD PROCENT TABLE TB_RCLC1301_PR
'Суммы для работников';

DESCRIBE FIELD DOPL_SUMMA TABLE TB_RCLC1301_PR
'Суммы для работников';

DESCRIBE FIELD SUMMAOLD TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD NMBOFCLOCK TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD STAWKAOLD TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD STAWKANEW TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD SUMMANEW TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD DOPL TABLE TB_RCLCPOCHAS1301_PR
'Суммы для работников';

DESCRIBE FIELD SUMMAADDTOT TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBN TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBNUD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBNRAS TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECB TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBUD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBRAS TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBDP TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBDPUD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBDPRAS TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBILL TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBILLUD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAECBILLRAS TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDPOD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAPODUD TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAPODRAS TABLE TB_RECALC_PODOH
'Суммы для работников';

DESCRIBE FIELD SUMMAADDPOD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAUDPOD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAPODNEED TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBN TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBNUD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBNNEED TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECB TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBUD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBNEED TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBDP TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBDPUD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBDPNEED TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAADDECBILL TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBILLUD TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAECBILLNEED TABLE TB_RECALC_PODOH_DET
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_REE_BOLN
'Суммы для работников';

DESCRIBE FIELD SUMMASS TABLE TB_REE_BOLN
'Суммы для работников';

DESCRIBE FIELD SUMMAPODSS TABLE TB_REE_BOLN
'Суммы для работников';

DESCRIBE FIELD SUMMAECBSS TABLE TB_REE_BOLN
'Суммы для работников';

DESCRIBE FIELD SUMMABANKSS TABLE TB_REE_BOLN
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_SPRSBSPRTABLE
'Суммы для работников';

DESCRIBE FIELD SUMMA_ZARPL TABLE TB_SPRSBSPRTABLE
'Суммы для работников';

DESCRIBE FIELD SUMMA_VNE TABLE TB_SPRSBSPRTABLE
'Суммы для работников';

DESCRIBE FIELD SUMMA_ALIM TABLE TB_SPRSBSPRTABLE
'Суммы для работников';

DESCRIBE FIELD SUMMATOT TABLE TB_SPR_ZARPL
'Суммы для работников';

DESCRIBE FIELD SUMMAPODOHTOT TABLE TB_SPR_ZARPL
'Суммы для работников';

DESCRIBE FIELD SUMMAADD TABLE TB_SPR_ZARPL_PR
'Суммы для работников';

DESCRIBE FIELD SUMMAPOD TABLE TB_SPR_ZARPL_PR
'Суммы для работников';

DESCRIBE FIELD SUMMA TABLE TB_SWODY_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAFZP TABLE TB_SWODY_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAFMP TABLE TB_SWODY_DET
'Суммы для работников';

DESCRIBE FIELD SUMMAOTH TABLE TB_SWODY_DET
'Суммы для работников';

DESCRIBE FIELD SOWM_SWOD TABLE TB_SWODY_HAT
'1 - если только совместители (для планового отдела)';

DESCRIBE FIELD SWOD_MODE TABLE TB_SWODY_HAT
'1 - только пенсионеры
2 - только инвалиды
любое другое  значение - все';

DESCRIBE FIELD NEEDDOGPOD TABLE TB_SWODY_HAT
'1 - включать договора подряда';

DESCRIBE FIELD TOTALMODE TABLE TB_SWODY_HAT
'1- включать все (свод для Аллы)';

DESCRIBE FIELD MODEILLSS TABLE TB_SWODY_HAT
'1 - больнгичные по соц.страху включать в свод
2 - свод только по больничным
любое др значение больничные по тсоц страху не включать в свод';

DESCRIBE FIELD MODECHERNOB TABLE TB_SWODY_HAT
'1 - Чернобыльский отпуск включать в свод';

DESCRIBE FIELD SELECT_KEY TABLE TB_SWODY_HAT
'0-1 - Общий
1-2 - по источникам финансирования
2-3 - по категориям работников
3-4 - по категориям и источникам финансирования
4-5 - сохраненные своды';

DESCRIBE FIELD SELECT_BAY_MODE TABLE TB_SWODY_HAT
'0-1 - по университету
1-2 - по участкам
2-3 - по подразделению';

DESCRIBE FIELD SELECTEDBAY TABLE TB_SWODY_HAT
'код выбранного участка';

DESCRIBE FIELD SWODSOWMMODE TABLE TB_SWODY_HAT
'0 - все и основные и совместители
1 - только основные
2 - совместители внутренние
3 - совместители внешние';



/******************************************************************************/
/***                        Parameters descriptions                         ***/
/******************************************************************************/

DESCRIBE PARAMETER MODEDC PROCEDURE CALCOTP
'ДНИ ИЛИ ЧАСЫ';

DESCRIBE PARAMETER MODE_PERSON PROCEDURE GETECBDPNACHUD_COMMON
'0 - если для все нач 1 - если для GUID';

DESCRIBE PARAMETER MODE_PERSON PROCEDURE GETECBNACHUD_COMMON
'0 - если для все нач 1 - если для GUID';

DESCRIBE PARAMETER MODE_PERSON PROCEDURE GETECBNNACHUD_COMMON
'0 - если для все нач 1 - если для GUID';

DESCRIBE PARAMETER MODEDC PROCEDURE MKTMPBOLNSUMMY
'ДНИ ИЛИ ЧАСІ';

DESCRIBE PARAMETER MODEDC PROCEDURE MKTMPOTPSUMMY
'Дни или часы';

DESCRIBE PARAMETER MODE PROCEDURE PR_GETGUID
'1 - tmp 0 - bd';

DESCRIBE PARAMETER CURRDATA PROCEDURE PR_GET_KOEF_RAZR
'Текущий месяц в SUMMY';

DESCRIBE PARAMETER DATAFR PROCEDURE PR_GET_KOEF_RAZR
'Отпускные с';

DESCRIBE PARAMETER MODE PROCEDURE PR_GET_KOEF_RAZR
'1-BOLN  2-OTPPUSKA';

DESCRIBE PARAMETER RAZR PROCEDURE PR_GET_KOEF_RAZR
'Разряд';

DESCRIBE PARAMETER MODEDC PROCEDURE PR_KOMAND_INIT
'ДНИ ИЛИ ЧАСІ';

DESCRIBE PARAMETER MODEFAC PROCEDURE PR_K_ADDPERSONTOSHTATRASP
'0-обычный 1 декан 2 замдекан';

DESCRIBE PARAMETER MODEFAC PROCEDURE PR_K_CREATEFULLTEXTORDER
'1-Кафедры 2-Деканы 3 - замдеканы';

DESCRIBE PARAMETER MODE PROCEDURE PR_K_CREATESHRASPALL
'1-кафедры 2 - факультеты';

DESCRIBE PARAMETER MODE PROCEDURE PR_PLAN_FOND_MK
'1-univ 2 - koledg';

DESCRIBE PARAMETER MODE PROCEDURE PR_PLAN_GRID_MK
'1-univ 2 - koledg';

DESCRIBE PARAMETER MODEDC PROCEDURE PUTOTP
'ДНИ ИЛИ ЧАСЫ';

